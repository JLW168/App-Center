<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JLW Task Tracker</title>
    
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- SortableJS for drag-and-drop functionality -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    
    <!-- Canvas-Confetti for the celebration animation -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>
    
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        /* Custom styles to complement Tailwind */
        body {
            font-family: 'Inter', sans-serif;
        }
        .sortable-ghost {
            background: #c0dcfc;
            border-radius: 0.5rem;
        }
        .sortable-drag {
            opacity: 1 !important;
        }
        .task-card {
            transition: background-color 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        .kanban-column-body::-webkit-scrollbar {
            width: 8px;
        }
        .kanban-column-body::-webkit-scrollbar-track {
            background: #f1f5f9;
            border-radius: 10px;
        }
        .kanban-column-body::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 10px;
        }
        .kanban-column-body::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }
    </style>
</head>
<body class="bg-slate-100 text-slate-800">

    <div class="container mx-auto p-4 sm:p-6 lg:p-8">
        
        <!-- Header -->
        <header class="text-center mb-8">
            <h1 class="text-4xl font-bold text-slate-900">JLW Task Tracker</h1>
            <p class="text-slate-500 mt-2">Organize your workflow, one task at a time.</p>
        </header>

        <!-- Add Task Button -->
        <div class="flex justify-center mb-8">
            <button id="addTaskBtn" class="bg-blue-600 text-white font-semibold py-3 px-6 rounded-lg shadow-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-75 transition-transform transform hover:scale-105">
                + Add New Task
            </button>
        </div>

        <!-- Kanban Board -->
        <div id="kanbanBoard" class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <!-- To Do, In Progress, Done columns -->
            <div class="bg-white rounded-xl shadow-md flex flex-col"><div class="p-4 border-b border-slate-200"><h2 class="text-lg font-semibold text-slate-700 flex items-center"><span class="w-3 h-3 rounded-full bg-red-400 mr-3"></span>To Do</h2></div><div id="todo" data-status="todo" class="kanban-column-body p-4 flex-grow min-h-[200px] overflow-y-auto"></div></div>
            <div class="bg-white rounded-xl shadow-md flex flex-col"><div class="p-4 border-b border-slate-200"><h2 class="text-lg font-semibold text-slate-700 flex items-center"><span class="w-3 h-3 rounded-full bg-yellow-400 mr-3"></span>In Progress</h2></div><div id="inprogress" data-status="inprogress" class="kanban-column-body p-4 flex-grow min-h-[200px] overflow-y-auto"></div></div>
            <div class="bg-white rounded-xl shadow-md flex flex-col"><div class="p-4 border-b border-slate-200"><h2 class="text-lg font-semibold text-slate-700 flex items-center"><span class="w-3 h-3 rounded-full bg-green-400 mr-3"></span>Done</h2></div><div id="done" data-status="done" class="kanban-column-body p-4 flex-grow min-h-[200px] overflow-y-auto"></div></div>
        </div>

        <!-- History Section -->
        <div id="historySection" class="mt-12">
            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4">
                 <h2 class="text-2xl font-bold text-slate-800 mb-4 sm:mb-0">Task History</h2>
                 <!-- Filter Controls -->
                <div id="historyFilters" class="flex flex-wrap items-center gap-4">
                    <select id="shopFilter" class="bg-white border border-slate-300 rounded-lg p-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"></select>
                    <select id="staffFilter" class="bg-white border border-slate-300 rounded-lg p-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"></select>
                    <input type="date" id="dateFilter" class="bg-white border border-slate-300 rounded-lg p-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <button id="clearFiltersBtn" class="bg-slate-200 text-slate-800 font-semibold py-2 px-4 rounded-lg hover:bg-slate-300 text-sm transition">Clear</button>
                </div>
            </div>
            <div class="bg-white rounded-xl shadow-md overflow-x-auto">
                <table class="w-full text-left">
                    <thead class="bg-slate-50 border-b border-slate-200">
                        <tr>
                            <th class="p-4 text-sm font-semibold text-slate-600">No</th>
                            <th class="p-4 text-sm font-semibold text-slate-600">Staff Name</th>
                            <th class="p-4 text-sm font-semibold text-slate-600">Shop Name</th>
                            <th class="p-4 text-sm font-semibold text-slate-600">Task</th>
                            <th class="p-4 text-sm font-semibold text-slate-600">Task Duration</th>
                            <th class="p-4 text-sm font-semibold text-slate-600">Completed Date</th>
                            <th class="p-4 text-sm font-semibold text-slate-600 text-center">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="historyTableBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Add/Edit Task Modal -->
    <div id="taskModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50 p-4">
        <div class="bg-white rounded-lg shadow-xl p-8 w-full max-w-md">
            <h2 id="modalTitle" class="text-2xl font-bold mb-6">Add a New Task</h2>
            <input type="hidden" id="editTaskId">
            <div class="space-y-4">
                <div><label for="taskInput" class="block text-sm font-medium text-slate-700 mb-1">Task Description</label><textarea id="taskInput" class="w-full border border-slate-300 rounded-lg p-3 focus:outline-none focus:ring-2 focus:ring-blue-500" rows="3" placeholder="Enter task description..."></textarea></div>
                <div><label for="taskDate" class="block text-sm font-medium text-slate-700 mb-1">Date</label><input type="date" id="taskDate" class="w-full border border-slate-300 rounded-lg p-3 focus:outline-none focus:ring-2 focus:ring-blue-500"></div>
                <div><label for="staffNameSelect" class="block text-sm font-medium text-slate-700 mb-1">Staff Name</label><select id="staffNameSelect" class="w-full border border-slate-300 rounded-lg p-3 focus:outline-none focus:ring-2 focus:ring-blue-500"></select></div>
                <div><label for="shopNameSelect" class="block text-sm font-medium text-slate-700 mb-1">Shop Name</label><select id="shopNameSelect" class="w-full border border-slate-300 rounded-lg p-3 focus:outline-none focus:ring-2 focus:ring-blue-500"></select></div>
            </div>
            <div class="mt-6 flex justify-end space-x-4">
                <button id="cancelBtn" class="bg-slate-200 text-slate-800 font-semibold py-2 px-4 rounded-lg hover:bg-slate-300 transition">Cancel</button>
                <button id="saveTaskBtn" class="bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-700 transition">Save Task</button>
            </div>
        </div>
    </div>
    
    <!-- Delete Confirmation Modal -->
    <div id="deleteConfirmModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50 p-4">
        <div class="bg-white rounded-lg shadow-xl p-8 w-full max-w-sm">
            <h2 class="text-xl font-bold mb-4">Confirm Deletion</h2>
            <p class="text-slate-600 mb-6">Are you sure you want to delete this task? This action cannot be undone.</p>
            <div class="flex justify-end space-x-4">
                <button id="cancelDeleteBtn" class="bg-slate-200 text-slate-800 font-semibold py-2 px-4 rounded-lg hover:bg-slate-300 transition">Cancel</button>
                <button id="confirmDeleteBtn" class="bg-red-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-red-700 transition">Delete</button>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, getDocs, addDoc, doc, getDoc, updateDoc, deleteDoc, onSnapshot, serverTimestamp, query, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBNb5ZI9XIWWSpxGD-FeV94K5FMc2a8udU",
            authDomain: "hr-manager-84ada.firebaseapp.com",
            projectId: "hr-manager-84ada",
            storageBucket: "hr-manager-84ada.firebasestorage.app",
            messagingSenderId: "365563456537",
            appId: "1:365563456537:web:9c5a6fbce7710b4c72ce88",
            measurementId: "G-51R9KT7LC1"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // DOM Elements
        const addTaskBtn = document.getElementById('addTaskBtn');
        const taskModal = document.getElementById('taskModal');
        const modalTitle = document.getElementById('modalTitle');
        const editTaskId = document.getElementById('editTaskId');
        const cancelBtn = document.getElementById('cancelBtn');
        const saveTaskBtn = document.getElementById('saveTaskBtn');
        const taskInput = document.getElementById('taskInput');
        const taskDate = document.getElementById('taskDate');
        const staffNameSelect = document.getElementById('staffNameSelect');
        const shopNameSelect = document.getElementById('shopNameSelect');
        const columns = document.querySelectorAll('.kanban-column-body');
        const historyTableBody = document.getElementById('historyTableBody');
        const shopFilter = document.getElementById('shopFilter');
        const staffFilter = document.getElementById('staffFilter');
        const dateFilter = document.getElementById('dateFilter');
        const clearFiltersBtn = document.getElementById('clearFiltersBtn');
        const deleteConfirmModal = document.getElementById('deleteConfirmModal');
        const cancelDeleteBtn = document.getElementById('cancelDeleteBtn');
        const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');

        let localHistory = []; // Local cache for history to enable filtering
        let taskIdToDelete = null;
        let historyCollection, tasksCollection;

        // --- HELPER FUNCTIONS ---
        const formatDuration = (ms) => {
            if (ms < 0) ms = 0;
            const seconds = Math.floor((ms / 1000) % 60);
            const minutes = Math.floor((ms / (1000 * 60)) % 60);
            const hours = Math.floor((ms / (1000 * 60 * 60)) % 24);
            const days = Math.floor(ms / (1000 * 60 * 60 * 24));
            const parts = [];
            if (days > 0) parts.push(`${days}d`);
            if (hours > 0) parts.push(`${hours}h`);
            if (minutes > 0) parts.push(`${minutes}m`);
            if (parts.length === 0 && seconds > 0) parts.push(`${seconds}s`);
            if (parts.length === 0) return "0s";
            return parts.slice(0, 2).join(' ');
        };
        const formatCompletedDate = (timestamp) => {
            if (!timestamp) return 'N/A';
            return new Date(timestamp.seconds * 1000).toLocaleString('en-US', { dateStyle: 'medium', timeStyle: 'short' });
        }

        // --- TASK RENDERING & FILTERING ---
        const createTaskCard = (task) => {
            const card = document.createElement('div');
            card.className = 'task-card bg-slate-50 border border-slate-200 p-4 rounded-lg shadow-sm mb-4 cursor-grab active:cursor-grabbing flex flex-col';
            card.dataset.id = task.id;
            const header = document.createElement('div');
            header.className = 'flex justify-between items-start';
            const text = document.createElement('p');
            text.className = 'text-slate-800 font-semibold flex-grow pr-2';
            text.textContent = task.text;
            const deleteBtn = document.createElement('button');
            deleteBtn.innerHTML = '&times;';
            deleteBtn.className = 'text-slate-400 hover:text-red-500 font-bold text-xl leading-none flex-shrink-0';
            deleteBtn.onclick = (e) => { e.stopPropagation(); deleteTaskFromBoard(task.id); };
            header.appendChild(text);
            header.appendChild(deleteBtn);
            const footer = document.createElement('div');
            footer.className = 'mt-3 pt-3 border-t border-slate-200 text-xs text-slate-500 space-y-1.5';
            const createInfoRow = (icon, label, value) => value ? `<div class="flex items-center"><span class="mr-2">${icon}</span><p><span class="font-medium text-slate-600">${label}:</span> ${value}</p></div>` : '';
            footer.innerHTML += createInfoRow('📅', 'Date', task.date);
            footer.innerHTML += createInfoRow('👤', 'Staff', task.staffName);
            footer.innerHTML += createInfoRow('🏢', 'Shop', task.shopName);
            card.appendChild(header);
            if (task.date || task.staffName || task.shopName) card.appendChild(footer);
            return card;
        };
        
        const renderHistory = () => {
            const selectedShop = shopFilter.value;
            const selectedStaff = staffFilter.value;
            const selectedDate = dateFilter.value;
            let filteredHistory = localHistory;
            if (selectedShop) filteredHistory = filteredHistory.filter(task => task.shopName === selectedShop);
            if (selectedStaff) filteredHistory = filteredHistory.filter(task => task.staffName === selectedStaff);
            if (selectedDate) filteredHistory = filteredHistory.filter(task => {
                if (!task.completedTimestamp) return false;
                return new Date(task.completedTimestamp.seconds * 1000).toISOString().split('T')[0] === selectedDate
            });
            
            historyTableBody.innerHTML = '';
            if (filteredHistory.length === 0) {
                historyTableBody.innerHTML = `<tr><td colspan="7" class="p-4 text-center text-slate-400">No matching completed tasks.</td></tr>`;
                return;
            }
            filteredHistory.forEach((task, index) => {
                const row = document.createElement('tr');
                row.className = 'border-b border-slate-200 hover:bg-slate-50';
                const duration = task.completedTimestamp && task.createdAt ? formatDuration((task.completedTimestamp.seconds - task.createdAt.seconds) * 1000) : 'N/A';
                row.innerHTML = `
                    <td class="p-4">${index + 1}</td>
                    <td class="p-4">${task.staffName || 'N/A'}</td>
                    <td class="p-4">${task.shopName || 'N/A'}</td>
                    <td class="p-4">${task.text}</td>
                    <td class="p-4 font-medium">${duration}</td>
                    <td class="p-4 text-sm text-slate-500">${formatCompletedDate(task.completedTimestamp)}</td>
                    <td class="p-4 text-center">
                        <button class="edit-history-btn text-blue-600 hover:text-blue-800 p-1 text-lg" data-id="${task.id}" title="Edit Task">✏️</button>
                        <button class="delete-history-btn text-red-600 hover:text-red-800 p-1 text-lg" data-id="${task.id}" title="Delete Task">🗑️</button>
                    </td>
                `;
                historyTableBody.appendChild(row);
            });
        };

        const populateFilters = () => {
            const shopNames = [...new Set(localHistory.map(task => task.shopName).filter(Boolean))];
            const staffNames = [...new Set(localHistory.map(task => task.staffName).filter(Boolean))];
            shopFilter.innerHTML = '<option value="">All Shops</option>';
            staffFilter.innerHTML = '<option value="">All Staff</option>';
            shopNames.forEach(name => shopFilter.innerHTML += `<option value="${name}">${name}</option>`);
            staffNames.forEach(name => staffFilter.innerHTML += `<option value="${name}">${name}</option>`);
        };

        // --- FETCH & POPULATE DROPDOWNS ---
        const populateSelectWithOptions = async (collectionName, selectElement, fieldName) => {
            try {
                const querySnapshot = await getDocs(collection(db, collectionName));
                selectElement.innerHTML = `<option value="">Select ${fieldName}</option>`;
                querySnapshot.forEach((doc) => {
                    // Assuming the document has a 'name' field
                    const name = doc.data().name;
                    if (name) {
                        const option = document.createElement('option');
                        option.value = name;
                        option.textContent = name;
                        selectElement.appendChild(option);
                    }
                });
            } catch (error) {
                console.error(`Error populating ${fieldName}s:`, error);
            }
        };

        // --- CRUD OPERATIONS ---
        const deleteTaskFromBoard = async (id) => {
            await deleteDoc(doc(tasksCollection, id));
        };
        
        const deleteTaskFromHistory = async () => {
             if (taskIdToDelete) {
                await deleteDoc(doc(historyCollection, taskIdToDelete));
                taskIdToDelete = null;
            }
            deleteConfirmModal.classList.add('hidden');
        };

        // --- MODAL HANDLING ---
        const openTaskModalForAdd = () => {
            modalTitle.textContent = 'Add a New Task';
            editTaskId.value = '';
            taskInput.value = '';
            taskDate.value = '';
            staffNameSelect.value = '';
            shopNameSelect.value = '';
            taskModal.classList.remove('hidden');
            taskInput.focus();
        };
        
        const openTaskModalForEdit = (task) => {
            modalTitle.textContent = 'Edit Task';
            editTaskId.value = task.id;
            taskInput.value = task.text;
            taskDate.value = task.date;
            staffNameSelect.value = task.staffName;
            shopNameSelect.value = task.shopName;
            taskModal.classList.remove('hidden');
            taskInput.focus();
        };

        const closeTaskModal = () => taskModal.classList.add('hidden');

        const saveTask = async () => {
            const id = editTaskId.value;
            const taskData = {
                text: taskInput.value.trim(),
                date: taskDate.value,
                staffName: staffNameSelect.value,
                shopName: shopNameSelect.value,
            };

            if (id) { // Editing a history task
                const taskRef = doc(historyCollection, id);
                await updateDoc(taskRef, taskData);
            } else { // Adding a new task
                if (!taskData.text) return;
                await addDoc(tasksCollection, {
                    ...taskData,
                    status: 'todo',
                    createdAt: serverTimestamp()
                });
            }
            closeTaskModal();
        };
        
        // --- EVENT LISTENERS ---
        addTaskBtn.addEventListener('click', openTaskModalForAdd);
        cancelBtn.addEventListener('click', closeTaskModal);
        saveTaskBtn.addEventListener('click', saveTask);
        window.addEventListener('keydown', (e) => e.key === 'Escape' && !taskModal.classList.contains('hidden') && closeTaskModal());
        
        [shopFilter, staffFilter, dateFilter].forEach(el => el.addEventListener('change', renderHistory));
        clearFiltersBtn.addEventListener('click', () => {
            shopFilter.value = ''; staffFilter.value = ''; dateFilter.value = '';
            renderHistory();
        });

        historyTableBody.addEventListener('click', (e) => {
            const editButton = e.target.closest('.edit-history-btn');
            const deleteButton = e.target.closest('.delete-history-btn');
            if (editButton) {
                const id = editButton.dataset.id;
                const task = localHistory.find(t => t.id === id);
                if (task) openTaskModalForEdit(task);
            }
            if (deleteButton) {
                taskIdToDelete = deleteButton.dataset.id;
                deleteConfirmModal.classList.remove('hidden');
            }
        });
        
        cancelDeleteBtn.addEventListener('click', () => deleteConfirmModal.classList.add('hidden'));
        confirmDeleteBtn.addEventListener('click', deleteTaskFromHistory);

        // --- FIREBASE AUTH & INIT ---
        onAuthStateChanged(auth, user => {
            if (user) {
                // User is signed in.
                const uid = user.uid;
                tasksCollection = collection(db, 'users', uid, 'tasks');
                historyCollection = collection(db, 'users', uid, 'history');
                
                // Populate dropdowns once user is authenticated
                // Using lowercase collection names to match Firestore screenshot
                populateSelectWithOptions('supervisors', staffNameSelect, 'Supervisor');
                populateSelectWithOptions('shops', shopNameSelect, 'Shop');

                setupRealtimeListeners();
                initializeDragAndDrop();
            } else {
                // User is signed out.
                signInAnonymously(auth).catch(error => {
                    console.error("Anonymous sign-in failed:", error);
                });
            }
        });

        function setupRealtimeListeners() {
            // Listener for tasks on the board
            onSnapshot(query(tasksCollection), (snapshot) => {
                const tasks = [];
                snapshot.forEach(doc => {
                    tasks.push({ id: doc.id, ...doc.data() });
                });
                
                // Clear all columns
                columns.forEach(col => col.innerHTML = '');
                
                // Render tasks into correct columns
                tasks.forEach(task => {
                    const card = createTaskCard(task);
                    const column = document.getElementById(task.status);
                    if (column) column.appendChild(card);
                });
            });

            // Listener for history
            onSnapshot(query(historyCollection, orderBy("completedTimestamp", "desc")), (snapshot) => {
                localHistory = [];
                snapshot.forEach(doc => {
                    localHistory.push({ id: doc.id, ...doc.data() });
                });
                renderHistory();
                populateFilters();
            });
        }

        function initializeDragAndDrop() {
            columns.forEach(column => {
                new Sortable(column, {
                    group: 'kanban', animation: 150, ghostClass: 'sortable-ghost',
                    onEnd: async (evt) => {
                        const itemEl = evt.item;
                        const toColumn = evt.to;
                        const taskId = itemEl.dataset.id;
                        const newStatus = toColumn.dataset.status;

                        if (newStatus === 'done') {
                            const taskRef = doc(tasksCollection, taskId);
                            const taskSnap = await getDoc(taskRef);
                            if (taskSnap.exists()) {
                                const taskData = taskSnap.data();
                                // Add to history
                                await addDoc(historyCollection, {
                                    ...taskData,
                                    status: 'done',
                                    completedTimestamp: serverTimestamp()
                                });
                                // Delete from tasks
                                await deleteDoc(taskRef);

                                const rect = itemEl.getBoundingClientRect();
                                confetti({ particleCount: 150, spread: 90, origin: { x: (rect.left + rect.right) / 2 / window.innerWidth, y: (rect.top + rect.bottom) / 2 / window.innerHeight }, gravity: 1.2 });
                            }
                        } else {
                            const taskRef = doc(tasksCollection, taskId);
                            await updateDoc(taskRef, { status: newStatus });
                        }
                    }
                });
            });
        }
    </script>
</body>
</html>
