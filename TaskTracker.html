<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>JLW Task Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        html, body { overflow-x: hidden; }
        body { 
            font-family: 'Inter', sans-serif; 
            -webkit-font-smoothing: antialiased; 
            -moz-osx-font-smoothing: grayscale;
        }
        .task-card { transition: background-color 0.2s ease-in-out, box-shadow 0.2s ease-in-out; }
        .kanban-column-body::-webkit-scrollbar, .checkbox-group::-webkit-scrollbar, .chat-messages::-webkit-scrollbar, .user-list::-webkit-scrollbar, .overflow-y-auto::-webkit-scrollbar { width: 8px; }
        .kanban-column-body::-webkit-scrollbar-track, .checkbox-group::-webkit-scrollbar-track, .chat-messages::-webkit-scrollbar-track, .user-list::-webkit-scrollbar-track, .overflow-y-auto::-webkit-scrollbar-track { background: #1e293b; border-radius: 10px; }
        .kanban-column-body::-webkit-scrollbar-thumb, .checkbox-group::-webkit-scrollbar-thumb, .chat-messages::-webkit-scrollbar-thumb, .user-list::-webkit-scrollbar-thumb, .overflow-y-auto::-webkit-scrollbar-thumb { background: #475569; border-radius: 10px; }
        .kanban-column-body::-webkit-scrollbar-thumb:hover, .checkbox-group::-webkit-scrollbar-thumb:hover, .chat-messages::-webkit-scrollbar-thumb:hover, .user-list::-webkit-scrollbar-thumb:hover, .overflow-y-auto::-webkit-scrollbar-thumb:hover { background: #64748b; }
        .modal-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex; justify-content: center; align-items: center;
            z-index: 50; padding: 1rem;
        }
        .modal-content {
            background-color: #1e293b; padding: 1.5rem; border-radius: 0.5rem;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1); width: 100%; max-width: 500px;
        }
        .input {
            margin-top: 0.25rem; display: block; width: 100%;
            padding: 0.75rem; border-width: 1px; border-color: #475569;
            border-radius: 0.375rem; box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            transition: border-color 0.2s, box-shadow 0.2s;
            background-color: #334155; color: #e2e8f0;
        }
        .input:focus {
            outline: 2px solid transparent; outline-offset: 2px;
            border-color: #3B82F6; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.3);
        }
        .input:disabled {
            background-color: #475569;
            cursor: not-allowed;
            opacity: 0.7;
        }
        .checkbox-group {
            max-height: 150px; overflow-y: auto; border: 1px solid #475569;
            border-radius: 0.375rem; padding: 0.75rem; margin-top: 0.25rem;
            background-color: #334155;
        }
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        .notification {
            animation: slideIn 0.5s ease-out forwards;
        }
    </style>
</head>
<body class="bg-slate-900 text-slate-300">
    <div id="root"></div>

    <script type="module">
        // --- React & Firebase Imports ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, setPersistence, browserSessionPersistence, browserLocalPersistence, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, getDocs, addDoc, doc, getDoc, updateDoc, deleteDoc, onSnapshot, serverTimestamp, query, where, collectionGroup, enableIndexedDbPersistence, setDoc, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-analytics.js";
        import React, { useState, useEffect, useRef, createContext, useContext, useMemo, useCallback } from "https://esm.sh/react@18.2.0";
        import ReactDOM from "https://esm.sh/react-dom@18.2.0/client";

        // --- Firebase Configuration ---
        const firebaseConfig = {
            apiKey: "AIzaSyBPiC3IdyJ5VE5h3XKXJNxr91XrB92m6x8",
            authDomain: "task-tracker-7c8dd.firebaseapp.com",
            projectId: "task-tracker-7c8dd",
            storageBucket: "task-tracker-7c8dd.firebasestorage.app",
            messagingSenderId: "85579699406",
            appId: "1:855796994906:web:ba0cee4e243685e9b45963",
            measurementId: "G-SY5JTKKFC5"
        };

        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        enableIndexedDbPersistence(db).catch((err) => {
            if (err.code == 'failed-precondition') console.warn('Firestore persistence failed: Multiple tabs open.');
            else if (err.code == 'unimplemented') console.warn('Firestore persistence failed: Browser not supported.');
        });

        // --- Constants & Icons ---
        const COLLECTIONS = {
            SHOPS: 'shops', EMPLOYEES: 'employees', USERS: 'users',
            TASKS: 'tasks', HISTORY: 'history', SETTINGS: 'settings',
            USER_SETTINGS: 'userSettings'
        };
        const ADMIN_EMAIL = 'jlw@jlw.com';
        const ROLES = { ADMIN: 'Admin', SHOP_MANAGER: 'Shop Manager', STAFF: 'Staff' };
        const KANBAN_STATUS = { TODO: 'todo', IN_PROGRESS: 'inprogress', AUDITING: 'auditing', DONE: 'done' };

        const ICONS = {
            DASHBOARD: (props) => React.createElement("svg", { ...props, xmlns: "http://www.w3.org/2000/svg", viewBox: "0 0 24 24", fill: "currentColor" }, React.createElement("path", { d: "M3 13h8V3H3v10zm0 8h8v-6H3v6zm10 0h8V11h-8v10zm0-18v6h8V3h-8z" })),
            BOARD: (props) => React.createElement("svg", { ...props, xmlns: "http://www.w3.org/2000/svg", viewBox: "0 0 24 24", fill: "currentColor" }, React.createElement("path", { d: "M10 3H4c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h6V3zm10 0h-6v18h6c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2z" })),
            SETTINGS: (props) => React.createElement("svg", { ...props, xmlns: "http://www.w3.org/2000/svg", viewBox: "0 0 24 24", fill: "currentColor" }, React.createElement("path", { d: "M19.4 12.98c.45-.63.45-1.4 0-2.03l-1.87-2.61c-.5-.7-1.39-1-2.25-1H8.72c-.86 0-1.75.3-2.25 1L4.6 10.95c-.45.63-.45 1.4 0 2.03l1.87 2.61c.5.7 1.39 1 2.25 1h6.56c.86 0 1.75-.3 2.25-1l1.87-2.61zM12 15.5c-1.93 0-3.5-1.57-3.5-3.5s1.57-3.5 3.5-3.5 3.5 1.57 3.5 3.5-1.57 3.5-3.5 3.5z" })),
            LOGO: (props) => React.createElement("svg", { ...props, xmlns: "http://www.w3.org/2000/svg", viewBox: "0 0 24 24", fill: "none", stroke: "currentColor", strokeWidth: "2" }, React.createElement("path", { d: "M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5" })),
            LOGOUT: (props) => React.createElement("svg", { ...props, xmlns: "http://www.w3.org/2000/svg", viewBox: "0 0 24 24", fill: "currentColor" }, React.createElement("path", { d: "M17 7l-1.41 1.41L18.17 11H8v2h10.17l-2.58 2.58L17 17l5-5zM4 5h8V3H4c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h8v-2H4V5z" })),
            MENU: (props) => React.createElement("svg", { ...props, xmlns: "http://www.w3.org/2000/svg", viewBox: "0 0 24 24", fill: "currentColor", className: "w-6 h-6" }, React.createElement("path", { d: "M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z" })),
            OFFLINE: (props) => React.createElement("svg", { ...props, xmlns: "http://www.w3.org/2000/svg", viewBox: "0 0 24 24", fill: "currentColor", className: "w-5 h-5" }, React.createElement("path", { d: "M19.35 10.04C18.67 6.59 15.64 4 12 4c-1.48 0-2.85.43-4.01 1.17l1.46 1.46C10.21 6.23 11.08 6 12 6c3.04 0 5.5 2.46 5.5 5.5v.5H19c1.66 0 3 1.34 3 3 0 1.13-.64 2.11-1.56 2.62l1.45 1.45C23.16 18.16 24 16.68 24 15c0-2.64-2.05-4.78-4.65-4.96zM3 5.27l2.75 2.74C2.56 8.15 0 10.77 0 14c0 3.31 2.69 6 6 6h11.73l2 2L21 20.73 4.27 4 3 5.27zM7.73 10l8 8H6c-2.21 0-4-1.79-4-4s1.79-4 4-4h1.73z" })),
            VIEW: () => React.createElement("svg", { xmlns: "http://www.w3.org/2000/svg", height: "18px", viewBox: "0 0 24 24", width: "18px", fill: "#38bdf8" }, React.createElement("path", { d: "M0 0h24v24H0V0z", fill: "none" }), React.createElement("path", { d: "M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z" })),
            SHOP: () => React.createElement("svg", { xmlns: "http://www.w3.org/2000/svg", width: "16", height: "16", viewBox: "0 0 24 24", fill: "none", stroke: "currentColor", strokeWidth: "2", strokeLinecap: "round", strokeLinejoin: "round" },
                React.createElement("rect", { x: "4", y: "4", width: "16", height: "16", rx: "2" }),
                React.createElement("path", { d: "M8 8h.01" }), React.createElement("path", { d: "M12 8h.01" }),
                React.createElement("path", { d: "M16 8h.01" }), React.createElement("path", { d: "M8 12h.01" }),
                React.createElement("path", { d: "M12 12h.01" }), React.createElement("path", { d: "M16 12h.01" }),
                React.createElement("path", { d: "M8 16h.01" }), React.createElement("path", { d: "M12 16h.01" }),
                React.createElement("path", { d: "M16 16h.01" })
            ),
            EYE: (props) => React.createElement("svg", { ...props, xmlns: "http://www.w3.org/2000/svg", fill: "none", viewBox: "0 0 24 24", strokeWidth: 1.5, stroke: "currentColor" }, React.createElement("path", { strokeLinecap: "round", strokeLinejoin: "round", d: "M2.036 12.322a1.012 1.012 0 010-.639C3.423 7.51 7.36 4.5 12 4.5c4.638 0 8.573 3.007 9.963 7.178.07.207.07.431 0 .639C20.577 16.49 16.64 19.5 12 19.5c-4.638 0-8.573-3.007-9.963-7.178z" }), React.createElement("path", { strokeLinecap: "round", strokeLinejoin: "round", d: "M15 12a3 3 0 11-6 0 3 3 0 016 0z" })),
            EYE_SLASHED: (props) => React.createElement("svg", { ...props, xmlns: "http://www.w3.org/2000/svg", fill: "none", viewBox: "0 0 24 24", strokeWidth: 1.5, stroke: "currentColor" }, React.createElement("path", { strokeLinecap: "round", strokeLinejoin: "round", d: "M3.98 8.223A10.477 10.477 0 001.934 12C3.226 16.338 7.244 19.5 12 19.5c.993 0 1.953-.138 2.863-.395M6.228 6.228A10.45 10.45 0 0112 4.5c4.756 0 8.773 3.162 10.065 7.498a10.523 10.523 0 01-4.293 5.774M6.228 6.228L3 3m3.228 3.228l3.65 3.65m7.894 7.894L21 21m-3.228-3.228l-3.65-3.65m0 0a3 3 0 10-4.243-4.243m4.243 4.243L6.228 6.228" }))
        };

        // --- Contexts & Providers ---
        const AuthContext = createContext();
        const DataContext = createContext();
        const useAuth = () => useContext(AuthContext);
        const useData = () => useContext(DataContext);

        const AuthProvider = ({ children }) => {
            const [user, setUser] = useState(null);
            const [isAuthReady, setIsAuthReady] = useState(false);
            const initialAuthData = useMemo(() => ({
                isAdmin: false, permissions: [], userName: '',
                userShop: '', userShopIds: [], userRole: '',
                settings: { retentionPeriod: 'never' }
            }), []);
            const [authData, setAuthData] = useState(initialAuthData);

            useEffect(() => {
                const unsubscribe = onAuthStateChanged(auth, (currentUser) => {
                    setUser(currentUser);
                    if (!currentUser) setAuthData(initialAuthData);
                    setIsAuthReady(true);
                });
                return () => unsubscribe();
            }, [initialAuthData]);

            useEffect(() => {
                if (!user) return;
                const fetchUserData = async () => {
                    let newAuthData = { ...initialAuthData };
                    try {
                        if (user.email === ADMIN_EMAIL) {
                            newAuthData = { isAdmin: true, permissions: ['dashboard', 'board', 'settings'], userName: 'Mr. Jelly Wang', userRole: ROLES.ADMIN };
                        } else {
                            const q = query(collection(db, COLLECTIONS.EMPLOYEES), where("email", "==", user.email));
                            const employeeSnapshot = await getDocs(q);
                            if (!employeeSnapshot.empty) {
                                const employeeDoc = employeeSnapshot.docs[0];
                                if (!employeeDoc.data().uid) {
                                    await updateDoc(doc(db, COLLECTIONS.EMPLOYEES, employeeDoc.id), { uid: user.uid });
                                }
                                const { role = ROLES.STAFF, name = '', pagePermissions = [], assignedShops = [] } = employeeDoc.data();
                                newAuthData = { ...newAuthData, userName: name, userRole: role, permissions: pagePermissions, userShopIds: assignedShops };
                            }
                        }
                    } catch (error) {
                        console.error("Permission fetch error:", error);
                    } finally {
                        setAuthData(newAuthData);
                    }
                };
                fetchUserData();
            }, [user, initialAuthData]);

            const value = useMemo(() => ({ user, isAuthReady, ...authData }), [user, isAuthReady, authData]);
            return React.createElement(AuthContext.Provider, { value }, children);
        };
        
        const DataProvider = ({ children }) => {
            const { user } = useAuth();
            const [data, setData] = useState({ tasks: [], history: [], shops: [], employees: [], memo: {} });

            const useCollectionSubscription = (collectionName, firestoreQuery) => {
                useEffect(() => {
                    if (!user) return;
                    const unsub = onSnapshot(firestoreQuery, (snapshot) => {
                        const items = snapshot.docs.map(d => ({ id: d.id, ...d.data(), ...((collectionName === 'tasks' || collectionName === 'history') && { uid: d.ref.path.split('/')[1], collection: collectionName }) }));
                        setData(prev => ({ ...prev, [collectionName]: items }));
                    }, err => console.error(`Error fetching ${collectionName}:`, err));
                    return () => unsub();
                }, [user, collectionName, firestoreQuery]);
            };

            useCollectionSubscription('tasks', query(collectionGroup(db, 'tasks')));
            useCollectionSubscription('history', query(collectionGroup(db, 'history')));
            useCollectionSubscription('shops', collection(db, 'shops'));
            useCollectionSubscription('employees', collection(db, 'employees'));
            
            useEffect(() => {
                if (!user) return;
                const unsub = onSnapshot(doc(db, COLLECTIONS.SETTINGS, 'memo'), (doc) => {
                    setData(prev => ({ ...prev, memo: doc.exists() ? doc.data() : { message: '', isActive: false } }));
                });
                return () => unsub();
            }, [user]);

            const value = useMemo(() => data, [data]);
            return React.createElement(DataContext.Provider, { value }, children);
        };

        // --- Custom Hooks ---
        const useFilteredData = (dataType) => {
            const data = useData()[dataType] || [];
            const { employees } = useData();
            const { user, isAdmin, userRole, userShopIds } = useAuth();

            return useMemo(() => {
                if (!user) return [];
                const activeEmails = new Set(employees.filter(e => e.status === 'Active').map(e => e.email));
                const activeData = data.filter(item => activeEmails.has(item.userEmail));

                if (isAdmin) return activeData;
                if (userRole === ROLES.SHOP_MANAGER) {
                    const managerEmails = new Set(employees.filter(e => e.assignedShops?.some(id => userShopIds.includes(id))).map(e => e.email));
                    managerEmails.add(user.email);
                    return activeData.filter(item => managerEmails.has(item.userEmail));
                }
                return activeData.filter(item => item.userEmail === user.email);
            }, [data, employees, user, isAdmin, userRole, userShopIds]);
        };

        const useFilteredTasks = () => useFilteredData('tasks');
        const useFilteredHistory = () => {
            const history = useFilteredData('history');
            return useMemo(() => [...history].sort((a, b) => (b.completedTimestamp?.seconds || 0) - (a.completedTimestamp?.seconds || 0)), [history]);
        };
        
        const useOnlineStatus = () => {
            const [isOnline, setIsOnline] = useState(navigator.onLine);
            useEffect(() => {
                const setOnline = () => setIsOnline(true);
                const setOffline = () => setIsOnline(false);
                window.addEventListener('online', setOnline);
                window.addEventListener('offline', setOffline);
                return () => {
                    window.removeEventListener('online', setOnline);
                    window.removeEventListener('offline', setOffline);
                };
            }, []);
            return isOnline;
        };
        
        const useTaskDuration = (task) => {
            return useMemo(() => {
                if (task.status === KANBAN_STATUS.AUDITING && task.progressTimestamp && task.workCompletedTimestamp) {
                    return formatFixedDuration(task.progressTimestamp.seconds, task.workCompletedTimestamp.seconds);
                }
                return null;
            }, [task.status, task.progressTimestamp, task.workCompletedTimestamp]);
        };

        const useLiveTaskDuration = (task) => {
            const [duration, setDuration] = useState(null);
            useEffect(() => {
                let intervalId;
                if (task.status === KANBAN_STATUS.IN_PROGRESS && task.progressTimestamp) {
                    const update = () => setDuration(formatLiveDuration(task.progressTimestamp));
                    update();
                    intervalId = setInterval(update, 1000);
                } else {
                    setDuration(null);
                }
                return () => clearInterval(intervalId);
            }, [task.status, task.progressTimestamp]);
            return duration;
        };

        const useAppFilters = (initialFilters = {}) => {
            const { user, isAdmin, userRole, userName, userShopIds } = useAuth();
            const { shops, employees } = useData();
            const [filters, setFilters] = useState({ shop: '', staff: '', ...initialFilters });

            const handleFilterChange = useCallback((e) => {
                const { name, value, type, checked } = e.target;
                const newValue = type === 'checkbox' ? checked : value;
                setFilters(prev => ({ ...prev, [name]: newValue, ...(name === 'shop' && { staff: '' }) }));
            }, []);

            const shopOptions = useMemo(() => {
                if (isAdmin) return shops.map(s => s.name);
                if (userRole === ROLES.SHOP_MANAGER) return shops.filter(s => userShopIds.includes(s.id)).map(s => s.name);
                return [];
            }, [isAdmin, shops, userShopIds, userRole]);

            const staffOptions = useMemo(() => {
                const activeEmployees = employees.filter(e => e.status === 'Active');
                if (userRole === ROLES.STAFF) return [userName];

                let viewableStaff = [];
                if (isAdmin) viewableStaff = activeEmployees;
                else if (userRole === ROLES.SHOP_MANAGER) {
                    viewableStaff = activeEmployees.filter(e => e.assignedShops?.some(sid => userShopIds.includes(sid)));
                }

                if (filters.shop) {
                    const shopId = shops.find(s => s.name === filters.shop)?.id;
                    return viewableStaff.filter(e => e.assignedShops?.includes(shopId)).map(e => e.name);
                }
                return [...new Set(viewableStaff.map(e => e.name))];
            }, [employees, userRole, userName, userShopIds, filters.shop, shops, isAdmin]);

            return { filters, handleFilterChange, shopOptions, staffOptions };
        };

        // --- Utility Functions ---
        const formatFixedDuration = (startSeconds, endSeconds) => {
            if (startSeconds == null || endSeconds == null) return 'N/A';
            const s = Math.max(0, endSeconds - startSeconds);
            const d = Math.floor(s / 86400), h = Math.floor(s % 86400 / 3600), m = Math.floor(s % 3600 / 60);
            return [d && `${d}d`, h && `${h}h`, m && `${m}m`, `${Math.floor(s%60)}s`].filter(Boolean).slice(0, 2).join(' ') || '0s';
        };
        const formatLiveDuration = (startTime) => {
            if (!startTime?.seconds) return '0h 0m 0s';
            const totalSeconds = Math.max(0, Math.floor((Date.now() / 1000) - startTime.seconds));
            
            const h = Math.floor(totalSeconds / 3600);
            const m = Math.floor((totalSeconds % 3600) / 60);
            const s = totalSeconds % 60;

            return `${h}h ${m}m ${s}s`;
        };
        const formatFullDateTime = (timestamp) => {
            if (!timestamp) return 'No Date';

            let date;
            // Handles Firestore Timestamp objects
            if (typeof timestamp.seconds === 'number') {
                date = new Date(timestamp.seconds * 1000);
            } 
            // Handles JS Date objects or date strings (for backward compatibility)
            else {
                date = new Date(timestamp);
            }

            // If the resulting date is invalid, don't display it
            if (isNaN(date.getTime())) {
                return 'No Date';
            }

            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const year = String(date.getFullYear()).slice(-2);
            
            let hours = date.getHours();
            const minutes = String(date.getMinutes()).padStart(2, '0');
            const ampm = hours >= 12 ? 'pm' : 'am';
            
            hours = hours % 12;
            hours = hours ? hours : 12; // the hour '0' should be '12'
            const paddedHours = String(hours).padStart(2, '0');

            return `${day}-${month}-${year} | ${paddedHours}:${minutes} ${ampm}`;
        };
        const getDateRange = (range) => {
            const now = new Date();
            let startDate = new Date(), endDate = new Date();
            switch (range) {
                case 'this_week': {
                    const today = new Date();
                    const day = today.getDay(); // 0 for Sunday, 1 for Monday, etc.
                    const diff = day === 0 ? 6 : day - 1; // Calculate days to subtract to get to the previous Monday
                    
                    startDate = new Date(today); // Create a copy
                    startDate.setDate(startDate.getDate() - diff);
                    startDate.setHours(0, 0, 0, 0);
                    break;
                }
                case 'this_month': startDate = new Date(now.getFullYear(), now.getMonth(), 1); break;
                case 'last_month': startDate = new Date(now.getFullYear(), now.getMonth() - 1, 1); endDate = new Date(now.getFullYear(), now.getMonth(), 0, 23, 59, 59); break;
                case 'last_6_months': startDate = new Date(now.getFullYear(), now.getMonth() - 5, 1); break;
                case 'this_year': startDate = new Date(now.getFullYear(), 0, 1); break;
                case 'last_year': startDate = new Date(now.getFullYear() - 1, 0, 1); endDate = new Date(now.getFullYear() - 1, 11, 31, 23, 59, 59); break;
                default: startDate = new Date(now.getFullYear(), now.getMonth(), 1);
            }
            return { startDate, endDate };
        };

        // --- Main App Structure ---
        const App = () => {
            const { user, isAuthReady } = useAuth();
            if (!isAuthReady) return React.createElement(LoadingSpinner, { text: "Authenticating..." });
            return user ? React.createElement(MainApp) : React.createElement(Login);
        };
        
        const MainApp = () => {
            const { permissions } = useAuth();
            const [page, setPage] = useState(permissions[0] || '');
            const [isModalOpen, setIsModalOpen] = useState(false);
            const [editingItem, setEditingItem] = useState(null);
            const [modalContext, setModalContext] = useState('task');
            const [isSidebarOpen, setIsSidebarOpen] = useState(false);
            
            useEffect(() => { if (permissions.length > 0 && !permissions.includes(page)) setPage(permissions[0]); }, [permissions, page]);

            const openModal = useCallback((item = null, context = 'task') => {
                setEditingItem(item); setModalContext(context); setIsModalOpen(true);
            }, []);
            const closeModal = useCallback(() => { setIsModalOpen(false); setEditingItem(null); }, []);
            
            return React.createElement(React.Fragment, null,
                React.createElement(MemoAlert, null),
                React.createElement(Sidebar, { currentPage: page, setPage, isOpen: isSidebarOpen, setIsOpen: setIsSidebarOpen }),
                React.createElement("div", { className: "flex flex-col min-h-screen lg:pl-64" },
                    React.createElement(TopHeader, { openModal, toggleSidebar: () => setIsSidebarOpen(o => !o) }),
                    React.createElement("main", { className: "flex-grow p-4 sm:p-6 lg:p-8" },
                        React.createElement(PageRenderer, { page, setPage, openModal })
                    )
                ),
                isModalOpen && React.createElement(TaskModal, { itemToEdit: editingItem, context: modalContext, onClose: closeModal })
            );
        };

        const PageRenderer = React.memo(({ page, setPage, openModal }) => {
            const { permissions } = useAuth();
            const pages = {
                dashboard: React.createElement(DashboardPage, { setPage }),
                board: React.createElement(BoardPage, { openModal }),
                settings: React.createElement(SettingsPage),
            };

            if (!permissions.length) return React.createElement("div", { className: "text-center p-8" }, React.createElement("h1", { className: "text-2xl font-bold text-yellow-500" }, "Awaiting Permissions..."));
            if (!page || !permissions.includes(page)) return React.createElement("div", { className: "text-center p-8" }, React.createElement("h1", { className: "text-2xl font-bold text-red-500" }, "Access Denied"));
            
            return pages[page] || null;
        });

        // --- Core UI Components ---
        const Sidebar = ({ currentPage, setPage, isOpen, setIsOpen }) => {
            const { user, permissions, userName, userRole } = useAuth();
            const handleSignOut = () => signOut(auth);
            const navItems = useMemo(() => [
                { id: 'dashboard', label: 'Dashboard', icon: ICONS.DASHBOARD },
                { id: 'board', label: 'Task Manager', icon: ICONS.BOARD },
                { id: 'settings', label: 'Settings', icon: ICONS.SETTINGS },
            ].filter(item => permissions.includes(item.id)), [permissions]);

            return React.createElement(React.Fragment, null,
                React.createElement("div", { className: `fixed inset-0 bg-black/60 z-30 lg:hidden transition-opacity ${isOpen ? 'opacity-100' : 'opacity-0 pointer-events-none'}`, onClick: () => setIsOpen(false) }),
                React.createElement("aside", { className: `fixed top-0 left-0 h-full w-64 bg-slate-800 border-r border-slate-700/50 flex flex-col p-4 z-40 transition-transform lg:translate-x-0 ${isOpen ? 'translate-x-0' : '-translate-x-full'}` },
                    React.createElement("div", { className: "flex items-center mb-8" }, React.createElement(ICONS.LOGO, { className: "w-10 h-10 text-blue-500 mr-3" }), React.createElement("h1", { className: "text-xl font-bold" }, "JLW Tracker")),
                    React.createElement("nav", { className: "flex-grow space-y-2" }, navItems.map(item => React.createElement(NavLink, { key: item.id, item, isActive: currentPage === item.id, onClick: () => { setPage(item.id); setIsOpen(false); } }))),
                    React.createElement("div", { className: "mt-auto" },
                        React.createElement("div", { className: "p-3 bg-slate-700/50 rounded-lg" }, React.createElement("p", { className: "text-sm font-medium truncate" }, userName || user.email), React.createElement("p", { className: "text-xs text-slate-400" }, userRole)),
                        React.createElement("button", { onClick: handleSignOut, className: "flex items-center w-full px-4 py-3 mt-2 text-sm rounded-lg hover:bg-slate-700" }, React.createElement(ICONS.LOGOUT, { className: "w-5 h-5 mr-3" }), "Sign Out")
                    )
                )
            );
        };
        
        const NavLink = React.memo(({ item, isActive, onClick }) => React.createElement("button", { onClick, className: `flex items-center w-full px-4 py-3 text-sm font-medium rounded-lg transition-colors ${isActive ? 'bg-blue-600 text-white' : 'hover:bg-slate-700'}` }, React.createElement(item.icon, { className: "w-5 h-5 mr-3" }), item.label));
        
        const TopHeader = React.memo(({ openModal, toggleSidebar }) => {
            const isOnline = useOnlineStatus();
            return React.createElement("header", { className: "flex-shrink-0 bg-slate-900/70 backdrop-blur-sm border-b border-slate-700/50 px-4 sm:px-6 lg:px-8 sticky top-0 z-10" },
                React.createElement("div", { className: "flex items-center justify-between h-16" },
                     React.createElement("button", { onClick: toggleSidebar, className: "lg:hidden p-2 -ml-2" }, React.createElement(ICONS.MENU)),
                     React.createElement("div", { className: "flex-1" }),
                     React.createElement("div", { className: "flex items-center gap-4" },
                        !isOnline && React.createElement("div", { className: "flex items-center gap-2 text-yellow-400 text-sm font-semibold bg-yellow-900/50 px-3 py-1.5 rounded-lg" }, React.createElement(ICONS.OFFLINE), React.createElement("span", null, "Offline")),
                        React.createElement("button", { onClick: () => openModal(), className: "bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-blue-700" }, "+ Add New Task")
                     )
                )
            );
        });
        
        // Dashboard Page
        const DashboardPage = React.memo(({ setPage }) => {
            const { user, userName, userRole } = useAuth();
            const tasks = useFilteredTasks();
            const history = useFilteredHistory();

            const stats = useMemo(() => {
                const isManager = userRole === ROLES.ADMIN || userRole === ROLES.SHOP_MANAGER;
                const userHistory = history.filter(h => h.userEmail === user.email);
                const monthlyHistory = userHistory.filter(h => h.completedTimestamp && new Date(h.completedTimestamp.seconds * 1000).getMonth() === new Date().getMonth());
                const scoredTasks = monthlyHistory.filter(task => task.auditScore);
                const avgScore = scoredTasks.length ? `${Math.round(scoredTasks.reduce((s, t) => s + parseInt(t.auditScore), 0) / scoredTasks.length)}%` : '0%';

                const createStat = (items) => isManager ? items.reduce((acc, i) => ({ ...acc, [i.shopName || 'N/A']: (acc[i.shopName || 'N/A'] || 0) + 1 }), {}) : items.length;

                return {
                    todo: createStat(tasks.filter(t => t.status === KANBAN_STATUS.TODO)),
                    inprogress: createStat(tasks.filter(t => t.status === KANBAN_STATUS.IN_PROGRESS)),
                    auditing: createStat(tasks.filter(t => t.status === KANBAN_STATUS.AUDITING)),
                    doneToday: createStat(history.filter(h => h.completedTimestamp && new Date(h.completedTimestamp.seconds * 1000).toDateString() === new Date().toDateString())),
                    averageScore: avgScore
                };
            }, [tasks, history, user.email, userRole]);

            return React.createElement("div", { className: "space-y-8" },
                React.createElement("div", null, React.createElement("h1", { className: "text-3xl font-bold" }, `Welcome back, ${userName}!`)),
                React.createElement("div", { className: "grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-6" },
                    React.createElement(StatCard, { title: "Tasks To Do", value: stats.todo, color: "border-red-500", onClick: () => setPage('board') }),
                    React.createElement(StatCard, { title: "In Progress", value: stats.inprogress, color: "border-yellow-500", onClick: () => setPage('board') }),
                    React.createElement(StatCard, { title: "Pending Audit", value: stats.auditing, color: "border-blue-500", onClick: () => setPage('board') }),
                    React.createElement(StatCard, { title: "Completed Today", value: stats.doneToday, color: "border-green-500" }),
                    React.createElement(StatCard, { title: "Your Monthly Score", value: stats.averageScore, color: "border-purple-500" })
                ),
                userRole === ROLES.SHOP_MANAGER && React.createElement(StaffScoreDashboard, null),
                React.createElement(ReportsSection)
            );
        });

        const StatCard = React.memo(({ title, value, color, onClick }) => {
            const renderValue = () => {
                if (typeof value !== 'object') return React.createElement("p", { className: "text-3xl font-bold mt-1" }, value);
                const entries = Object.entries(value).sort(([,a],[,b]) => b - a);
                if (!entries.length) return React.createElement("p", { className: "text-3xl font-bold mt-1" }, "0");
                
                const paired = entries.reduce((acc, v, i) => (i % 2 ? acc[acc.length - 1].push(v) : acc.push([v]), acc), []);

                return React.createElement("div", { className: "mt-1 flex-grow overflow-y-auto max-h-[72px]" },
                    paired.map((pair, i) => React.createElement("div", { key: i, className: "grid grid-cols-2 gap-x-4 text-base" },
                        pair.map(([name, count]) => React.createElement("div", { key: name, className: "flex items-center truncate" },
                            React.createElement(ICONS.SHOP),
                            React.createElement("span", { className: "font-medium truncate mx-2", title: name }, `${name}:`),
                            React.createElement("span", { className: "font-bold" }, count)
                        ))
                    ))
                );
            };
            return React.createElement("div", { onClick, className: `bg-slate-800 p-6 rounded-xl border-l-4 ${color} ${onClick ? 'cursor-pointer hover:bg-slate-700' : ''}` },
                React.createElement("p", { className: "text-sm font-medium text-slate-400" }, title),
                renderValue()
            );
        });
        
        const StaffScoreDashboard = React.memo(() => {
            const { employees } = useData();
            const { userShopIds } = useAuth();
            const history = useFilteredHistory();
            const [timeRange, setTimeRange] = useState('this_month');

            const staffScores = useMemo(() => {
                const { startDate, endDate } = getDateRange(timeRange);
                const shopStaff = employees.filter(e => e.status === 'Active' && e.assignedShops?.some(sid => userShopIds.includes(sid)));
                
                return shopStaff.map(staff => {
                    const staffHistory = history.filter(h => h.staffName === staff.name && new Date(h.completedTimestamp.seconds * 1000) >= startDate && new Date(h.completedTimestamp.seconds * 1000) <= endDate);
                    const scoredTasks = staffHistory.filter(t => t.auditScore);
                    const score = scoredTasks.length > 0 ? `${Math.round(scoredTasks.reduce((sum, t) => sum + parseInt(t.auditScore), 0) / scoredTasks.length)}%` : '0%';
                    return { id: staff.id, name: staff.name, score, tasksCompleted: staffHistory.length };
                }).sort((a,b) => parseInt(b.score) - parseInt(a.score));
            }, [history, employees, userShopIds, timeRange]);

            return React.createElement("div", { className: "bg-slate-800 p-6 rounded-xl" },
                React.createElement("div", { className: "flex flex-col sm:flex-row justify-between items-center mb-4 gap-4" },
                    React.createElement("h2", { className: "text-xl font-semibold" }, "Staff Scores"),
                    React.createElement("div", { className: "flex flex-wrap items-center gap-2" },
                        ['This Week', 'This Month', 'Last Month', '6 Months', 'This Year', 'Last Year'].map(label => {
                            const range = label.toLowerCase().replace(' ', '_');
                            return React.createElement(TimeRangeButton, { key: range, label, range, activeRange: timeRange, setTimeRange });
                        })
                    )
                ),
                React.createElement("div", { className: "grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4" },
                    staffScores.map(staff => React.createElement("div", { key: staff.id, className: "bg-slate-700 p-4 rounded-lg text-center" },
                        React.createElement("p", { className: "font-semibold truncate" }, staff.name),
                        React.createElement("p", { className: "text-2xl font-bold text-purple-400 mt-2" }, staff.score),
                        React.createElement("p", { className: "text-xs text-slate-400 mt-1" }, `${staff.tasksCompleted} tasks`)
                    ))
                )
            );
        });
        
        const TimeRangeButton = React.memo(({ label, range, activeRange, setTimeRange }) => React.createElement("button", { onClick: () => setTimeRange(range), className: `px-3 py-1 text-xs font-medium rounded-md ${range === activeRange ? 'bg-blue-600' : 'bg-slate-600 hover:bg-slate-500'}` }, label));

        const ReportsSection = React.memo(() => {
            const history = useFilteredHistory();
            const { filters, handleFilterChange, shopOptions, staffOptions } = useAppFilters({ dateRange: 'this_month' });

            const filteredReportHistory = useMemo(() => {
                const { startDate, endDate } = getDateRange(filters.dateRange);
                return history.filter(task => {
                    const completedDate = new Date(task.completedTimestamp.seconds * 1000);
                    return (!filters.shop || task.shopName === filters.shop) &&
                           (!filters.staff || task.staffName === filters.staff) &&
                           (completedDate >= startDate && completedDate <= endDate);
                });
            }, [history, filters]);
            
            const reportData = useMemo(() => {
                if (!filteredReportHistory.length) return { total: 0, score: '0%', duration: 'N/A', leaderboard: [], chartData: { labels: [], datasets: [] } };
                const scored = filteredReportHistory.filter(t => t.auditScore);
                const score = scored.length ? `${Math.round(scored.reduce((a, t) => a + parseInt(t.auditScore), 0) / scored.length)}%` : '0%';
                const durated = filteredReportHistory.filter(t => t.progressTimestamp && t.completedTimestamp);
                const duration = durated.length ? formatFixedDuration(0, durated.reduce((a, t) => a + (t.completedTimestamp.seconds - t.progressTimestamp.seconds), 0) / durated.length) : 'N/A';
                
                const staffData = filteredReportHistory.reduce((acc, task) => {
                    if (!task.staffName) return acc;
                    acc[task.staffName] = acc[task.staffName] || { count: 0, scores: [] };
                    acc[task.staffName].count++;
                    if (task.auditScore) acc[task.staffName].scores.push(parseInt(task.auditScore));
                    return acc;
                }, {});

                const leaderboard = Object.entries(staffData).map(([name, data]) => ({ name, tasksCompleted: data.count, averageScore: data.scores.length ? Math.round(data.scores.reduce((a,b)=>a+b,0)/data.scores.length) : 0})).sort((a, b) => b.averageScore - a.averageScore);
                const chartData = { labels: leaderboard.slice(0, 10).map(i => i.name), datasets: [{ data: leaderboard.slice(0, 10).map(i => i.averageScore), backgroundColor: '#a855f7' }] };
                return { total: filteredReportHistory.length, score, duration, leaderboard, chartData };
            }, [filteredReportHistory]);
            
            const handleLeaderboardExport = useCallback(() => {
                const data = reportData.leaderboard.map((item, i) => ({ Rank: i+1, 'Staff Name': item.name, 'Tasks Completed': item.tasksCompleted, 'Avg Score (%)': item.averageScore }));
                const ws = XLSX.utils.json_to_sheet(data);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Leaderboard");
                XLSX.writeFile(wb, `JLW_Leaderboard_${filters.dateRange}.xlsx`);
            }, [reportData.leaderboard, filters.dateRange]);
            
            return React.createElement("div", { className: "space-y-8 pt-8 mt-8 border-t border-slate-700/50" },
                React.createElement("h1", { className: "text-3xl font-bold" }, "Performance Reports"),
                React.createElement("div", { className: "p-4 bg-slate-800 rounded-lg flex flex-wrap items-center gap-4" },
                    React.createElement(FilterSelect, { name: "shop", value: filters.shop, onChange: handleFilterChange, options: shopOptions, simple: true }),
                    React.createElement(FilterSelect, { name: "staff", value: filters.staff, onChange: handleFilterChange, options: staffOptions, simple: true })
                ),
                React.createElement("div", { className: "grid grid-cols-1 sm:grid-cols-3 gap-6" },
                    React.createElement(ReportStatCard, { title: "Total Tasks Completed", value: reportData.total }),
                    React.createElement(ReportStatCard, { title: "Average Score", value: reportData.score }),
                    React.createElement(ReportStatCard, { title: "Avg. Completion Time", value: reportData.duration })
                ),
                React.createElement("div", { className: "grid grid-cols-1 lg:grid-cols-2 gap-8" },
                    React.createElement(ReportChart, { chartData: reportData.chartData }),
                    React.createElement(ReportLeaderboard, { data: reportData.leaderboard, onExport: handleLeaderboardExport })
                )
            );
        });

        const ReportStatCard = ({ title, value }) => React.createElement("div", { className: "bg-slate-800 p-6 rounded-xl" }, React.createElement("p", { className: "text-sm text-slate-400" }, title), React.createElement("p", { className: "text-3xl font-bold mt-1" }, value));

        const ReportChart = ({ chartData }) => {
            const chartRef = useRef(null);
            useEffect(() => {
                if (!chartRef.current) return;
                const chart = new Chart(chartRef.current, {
                    type: 'bar', data: chartData,
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } },
                        scales: { y: { beginAtZero: true, ticks: { color: '#94a3b8', callback: v => v + '%' }, grid: { color: '#334155' } }, x: { ticks: { color: '#94a3b8' }, grid: { display: false } } }
                    }
                });
                return () => chart.destroy();
            }, [chartData]);
            return React.createElement("div", { className: "bg-slate-800 p-6 rounded-xl" }, React.createElement("h2", { className: "text-xl font-semibold mb-4" }, "Top 10 Staff by Score"), React.createElement("div", { className: "relative h-80" }, React.createElement("canvas", { ref: chartRef })));
        };

        const ReportLeaderboard = ({ data, onExport }) => React.createElement("div", { className: "bg-slate-800 p-6 rounded-xl" },
            React.createElement("div", { className: "flex justify-between items-center mb-4" },
                React.createElement("h2", { className: "text-xl font-semibold" }, "Performance Leaderboard"),
                React.createElement("button", { onClick: onExport, className: "bg-green-600 font-semibold py-1 px-3 rounded-lg text-sm hover:bg-green-700" }, "Download Excel")
            ),
            React.createElement("div", { className: "overflow-y-auto h-80" }, 
                React.createElement("table", { className: "w-full text-left" },
                    React.createElement("thead", null, React.createElement("tr", { className: "border-b border-slate-700" },
                        React.createElement("th", { className: "py-2 text-sm text-slate-400" }, "Rank"),
                        React.createElement("th", { className: "py-2 text-sm text-slate-400" }, "Staff"),
                        React.createElement("th", { className: "py-2 text-sm text-slate-400 text-center" }, "Tasks"),
                        React.createElement("th", { className: "py-2 text-sm text-slate-400 text-center" }, "Avg Score")
                    )),
                    React.createElement("tbody", null, data.length ? data.map((item, i) => React.createElement("tr", { key: item.name, className: "border-b border-slate-700/50" },
                        React.createElement("td", { className: "py-3" }, i + 1),
                        React.createElement("td", { className: "py-3 font-medium" }, item.name),
                        React.createElement("td", { className: "py-3 text-center" }, item.tasksCompleted),
                        React.createElement("td", { className: "py-3 text-center font-semibold text-purple-400" }, `${item.averageScore}%`)
                    )) : React.createElement("tr", null, React.createElement("td", { colSpan: 4, className: "py-4 text-center text-slate-400" }, "No data.")))
                )
            )
        );
        
        // --- Board Page & Kanban Components ---
        const BoardPage = React.memo(({ openModal }) => {
            const tasks = useFilteredTasks();
            const { isAdmin } = useAuth();
            const [processingTaskIds, setProcessingTaskIds] = useState(new Set());
            const { filters, handleFilterChange, shopOptions, staffOptions } = useAppFilters({ shopManagerOnly: false });

            const filteredTasks = useMemo(() => tasks.filter(task => 
                (!filters.shop || task.shopName === filters.shop) &&
                (!filters.staff || task.staffName === filters.staff) &&
                (!filters.shopManagerOnly || task.creatorRole === ROLES.SHOP_MANAGER)
            ), [tasks, filters]);
            
            const handleTaskAction = useCallback(async (action, task, payload = {}) => {
                if (processingTaskIds.has(task.id)) return;
                setProcessingTaskIds(prev => new Set(prev).add(task.id));
                const taskRef = doc(db, COLLECTIONS.USERS, task.uid, COLLECTIONS.TASKS, task.id);
                try {
                    if (action === 'delete') await deleteDoc(taskRef);
                    else if (action === 'move') {
                        if (payload.newStatus === KANBAN_STATUS.DONE) {
                            await addDoc(collection(db, COLLECTIONS.USERS, task.uid, COLLECTIONS.HISTORY), { ...task, status: 'done', completedTimestamp: serverTimestamp() });
                            await deleteDoc(taskRef);
                        } else {
                            await updateDoc(taskRef, { 
                                status: payload.newStatus,
                                ...(payload.newStatus === KANBAN_STATUS.IN_PROGRESS && !task.progressTimestamp && { progressTimestamp: serverTimestamp() }),
                                ...(payload.newStatus === KANBAN_STATUS.AUDITING && { workCompletedTimestamp: serverTimestamp() }),
                                ...(payload.comment && { auditComment: payload.comment })
                            });
                        }
                    } else if (action === 'approve') {
                        await addDoc(collection(db, COLLECTIONS.USERS, task.uid, COLLECTIONS.HISTORY), { ...task, status: 'done', completedTimestamp: serverTimestamp(), auditScore: payload.score, auditComment: payload.comment });
                        await deleteDoc(taskRef);
                        if(window.confetti) confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 } });
                    }
                } catch (error) { console.error(`Error with task action '${action}':`, error); }
                finally {
                    setProcessingTaskIds(prev => { const s = new Set(prev); s.delete(task.id); return s; });
                }
            }, [processingTaskIds]);

            return React.createElement("div", { className: "space-y-8" },
                React.createElement("h1", { className: "text-3xl font-bold" }, "Task Manager"),
                React.createElement("div", { className: "flex flex-col sm:flex-row gap-4 p-4 bg-slate-800 rounded-lg items-center" },
                    React.createElement(FilterSelect, { label: "Shop", name: "shop", value: filters.shop, onChange: handleFilterChange, options: shopOptions }),
                    React.createElement(FilterSelect, { label: "Staff", name: "staff", value: filters.staff, onChange: handleFilterChange, options: staffOptions }),
                    isAdmin && React.createElement("div", { className: "flex items-center pt-6" },
                        React.createElement("input", { id: "shopManagerOnly", name: "shopManagerOnly", type: "checkbox", checked: filters.shopManagerOnly, onChange: handleFilterChange, className: "h-4 w-4" }),
                        React.createElement("label", { htmlFor: "shopManagerOnly", className: "ml-2 text-sm" }, "Managers Only")
                    )
                ),
                React.createElement(KanbanBoard, { tasks: filteredTasks, onTaskAction: handleTaskAction, onEdit: openModal, processingTaskIds }),
                React.createElement(HistorySection, { openModal: openModal })
            );
        });

        const FilterSelect = React.memo(({ label, name, value, onChange, options, disabled, simple = false }) => (
            React.createElement("div", { className: simple ? "" : "flex-1 w-full" },
                !simple && React.createElement("label", { htmlFor: `${name}-filter`, className: "block text-sm font-medium text-slate-400 mb-1" }, label),
                React.createElement("select", { id: `${name}-filter`, name, value, onChange, className: `input ${simple ? 'text-sm' : 'w-full'}`, disabled }, 
                    React.createElement("option", { value: "" }, `All ${label || name}s`),
                    options.map(opt => React.createElement("option", { key: opt, value: opt }, opt))
                )
            )
        ));

        const KanbanBoard = React.memo(({ tasks, ...props }) => {
            const sortedTasks = useMemo(() => [...tasks].sort((a,b) => (a.taskTimestamp?.seconds || 0) - (b.taskTimestamp?.seconds || 0)), [tasks]);
            const columns = useMemo(() => [
                { id: KANBAN_STATUS.TODO, title: 'To Do', color: 'red-400', tasks: sortedTasks.filter(t => t.status === KANBAN_STATUS.TODO) },
                { id: KANBAN_STATUS.IN_PROGRESS, title: 'In Progress', color: 'yellow-400', tasks: sortedTasks.filter(t => t.status === KANBAN_STATUS.IN_PROGRESS) },
                { id: KANBAN_STATUS.AUDITING, title: 'Task Auditing', color: 'blue-400', tasks: sortedTasks.filter(t => t.status === KANBAN_STATUS.AUDITING) },
            ], [sortedTasks]);
            return React.createElement("div", { className: "grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" },
                columns.map(col => React.createElement(KanbanColumn, { key: col.id, ...col, ...props }))
            );
        });

        const KanbanColumn = React.memo(({ title, color, tasks, ...props }) => (
            React.createElement("div", { className: "bg-slate-800 rounded-xl shadow-md flex flex-col" },
                React.createElement("div", { className: "p-4 border-b border-slate-700 flex justify-between" },
                    React.createElement("h2", { className: "text-lg font-semibold flex items-center" }, React.createElement("span", { className: `w-3 h-3 rounded-full bg-${color} mr-3` }), title),
                    React.createElement("span", { className: "text-sm bg-slate-700 px-2 py-0.5 rounded-full" }, tasks.length)
                ),
                React.createElement("div", { className: "kanban-column-body p-4 flex-grow min-h-[200px] overflow-y-auto" },
                    tasks.map(task => React.createElement(TaskCard, { key: task.id, task, ...props }))
                )
            )
        ));

        const TaskCard = React.memo(({ task, onEdit, onTaskAction, processingTaskIds }) => {
            const { userRole } = useAuth();
            const staticDuration = useTaskDuration(task);
            const liveDuration = useLiveTaskDuration(task);
            const isProcessing = processingTaskIds.has(task.id);

            const handleComplete = () => {
                // Staff tasks go to auditing, manager/admin tasks go straight to history
                const newStatus = userRole === ROLES.STAFF ? KANBAN_STATUS.AUDITING : KANBAN_STATUS.DONE;
                onTaskAction('move', task, { newStatus });
            };

            const MoveButton = ({ to, text }) => React.createElement("button", { onClick: () => onTaskAction('move', task, { newStatus: to }), className: `px-3 py-1 text-xs font-semibold rounded-lg ${to === KANBAN_STATUS.IN_PROGRESS ? 'bg-blue-600 hover:bg-blue-700' : 'bg-slate-600 hover:bg-slate-500'}` }, text);
            const CompleteButton = () => React.createElement("button", { onClick: handleComplete, className: `px-3 py-1 text-xs bg-green-600 font-semibold rounded-lg hover:bg-green-700 ${isProcessing && 'opacity-50'}`, disabled: isProcessing }, isProcessing ? '...' : 'Complete');
            
            return React.createElement("div", { className: "bg-slate-700 border border-slate-600 p-4 rounded-lg shadow-sm group mb-4" },
                React.createElement("div", { className: "flex justify-between" },
                    React.createElement("p", { onClick: () => onEdit(task), className: "font-semibold flex-grow pr-2 cursor-pointer" }, task.text),
                    React.createElement("button", { onClick: () => onTaskAction('delete', task), className: "text-slate-500 hover:text-red-500 font-bold opacity-0 group-hover:opacity-100" }, "×")
                ),
                React.createElement("div", { className: "mt-3 pt-3 border-t border-slate-600 text-xs text-slate-400 space-y-1.5" },
                    task.auditComment && React.createElement(InfoRow, { icon: '💬', label: 'Comment', value: React.createElement("span", { className: "text-yellow-400 italic" }, task.auditComment) }),
                    task.taskTimestamp && React.createElement(InfoRow, { icon: '📅', label: 'Date', value: formatFullDateTime(task.taskTimestamp) }),
                    staticDuration && React.createElement(InfoRow, { icon: '⏱️', label: 'Duration', value: staticDuration }),
                    liveDuration && React.createElement(InfoRow, { icon: '⏱️', label: 'Duration', value: React.createElement("span", { className: "font-bold text-yellow-400 animate-pulse" }, liveDuration) }),
                    task.creatorName && task.creatorName !== task.staffName && React.createElement(InfoRow, { icon: '🧑', label: 'By', value: React.createElement("span", { className: "text-red-500 font-semibold" }, task.creatorName) }),
                    task.staffName && React.createElement(InfoRow, { icon: '👤', label: 'Staff', value: task.staffName }),
                    task.shopName && React.createElement(InfoRow, { icon: '🏢', label: 'Shop', value: task.shopName })
                ),
                React.createElement("div", { className: "mt-3 pt-3 border-t border-slate-600" },
                    task.status === KANBAN_STATUS.AUDITING 
                    ? React.createElement(TaskAuditControls, { task, onTaskAction, isProcessing }) 
                    : React.createElement("div", { className: "flex justify-end space-x-2" },
                        task.status === KANBAN_STATUS.TODO && React.createElement(MoveButton, { to: KANBAN_STATUS.IN_PROGRESS, text: "In Progress" }),
                        task.status === KANBAN_STATUS.IN_PROGRESS && React.createElement(React.Fragment, null, React.createElement(MoveButton, { to: KANBAN_STATUS.TODO, text: "To Do" }), React.createElement(CompleteButton))
                    )
                )
            );
        });

        const TaskAuditControls = ({ task, onTaskAction, isProcessing }) => {
            const { isAdmin, userRole, userShopIds } = useAuth();
            const [score, setScore] = useState('');
            const [comment, setComment] = useState('');
            const canAudit = isAdmin || (userRole === ROLES.SHOP_MANAGER && userShopIds.includes(task.shopId));
            if (!canAudit) return null;
            
            return React.createElement("div", { className: "space-y-3" },
                React.createElement("textarea", { value: comment, onChange: (e) => setComment(e.target.value), className: "input text-sm p-2", rows: "2", placeholder: "Add comment..." }),
                React.createElement("select", { value: score, onChange: (e) => setScore(e.target.value), className: "input text-sm p-2" },
                    React.createElement("option", {value: ""}, "Select score..."),
                    ["30%", "50%", "70%", "90%", "100%"].map(s => React.createElement("option", { key: s, value: s }, s))
                ),
                React.createElement("div", { className: "flex justify-end gap-2" }, 
                    React.createElement("button", { onClick: () => onTaskAction('move', task, { newStatus: KANBAN_STATUS.IN_PROGRESS, comment }), className: `px-4 py-2 text-sm bg-yellow-600 font-semibold rounded-lg hover:bg-yellow-700 ${(!comment || isProcessing) && 'opacity-50'}`, disabled: !comment || isProcessing }, "Return"),
                    React.createElement("button", { onClick: () => onTaskAction('approve', task, { score, comment }), className: `px-4 py-2 text-sm bg-green-600 font-semibold rounded-lg hover:bg-green-700 ${(isProcessing || !score) && 'opacity-50'}`, disabled: isProcessing || !score }, isProcessing ? '...' : 'Approve')
                )
            );
        };
        
        const InfoRow = React.memo(({ icon, label, value }) => React.createElement("div", { className: "flex" }, React.createElement("span", { className: "mr-2" }, icon), React.createElement("p", null, React.createElement("span", { className: "font-medium text-slate-300" }, `${label}: `), value)));
        
        // --- History Section ---
        const HistorySection = React.memo(({ openModal }) => {
            const history = useFilteredHistory();
            const { isAdmin } = useAuth();
            const [commentModal, setCommentModal] = useState({ isOpen: false, content: '' });

            const handleEditHistoryItem = useCallback((item) => openModal(item, 'history'), [openModal]);
            
            const handleDeleteHistoryItem = useCallback(async (item) => {
                if (item?.uid && item?.id) {
                    await deleteDoc(doc(db, COLLECTIONS.USERS, item.uid, COLLECTIONS.HISTORY, item.id));
                }
            }, []);

            const handleViewComment = useCallback((comment) => {
                setCommentModal({ isOpen: true, content: comment });
            }, []);
        
            const closeCommentModal = useCallback(() => {
                setCommentModal({ isOpen: false, content: '' });
            }, []);

            return React.createElement("div", null,
                React.createElement("h2", { className: "text-2xl font-bold text-slate-100 my-4" }, "Completed Tasks History"),
                React.createElement(HistoryView, { history: history, onEdit: handleEditHistoryItem, onDelete: handleDeleteHistoryItem, isAdmin: isAdmin, onViewComment: handleViewComment }),
                commentModal.isOpen && React.createElement(CommentModal, { comment: commentModal.content, onClose: closeCommentModal })
            );
        });

        const HistoryView = React.memo(({ history, onEdit, onDelete, isAdmin, onViewComment }) => {
            const { userRole } = useAuth();
            const [currentPage, setCurrentPage] = useState(1);
            const { filters, setFilters, handleFilterChange, shopOptions, staffOptions } = useAppFilters({
                date: new Date().toISOString().slice(0, 7),
                shopManagerOnly: false
            });
            
            useEffect(() => { setCurrentPage(1); }, [filters]);

            const filteredHistory = useMemo(() => history.filter(task => {
                const shopMatch = !filters.shop || task.shopName === filters.shop;
                const staffMatch = !filters.staff || task.staffName === filters.staff;
                const dateMatch = !filters.date || (task.completedTimestamp && new Date(task.completedTimestamp.seconds * 1000).toISOString().slice(0, 7) === filters.date);
                const managerOnlyMatch = !filters.shopManagerOnly || task.creatorRole === ROLES.SHOP_MANAGER;
                return shopMatch && staffMatch && dateMatch && managerOnlyMatch;
            }), [history, filters]);
            
            const ITEMS_PER_PAGE = 10;
            const totalPages = Math.ceil(filteredHistory.length / ITEMS_PER_PAGE);
            const paginatedHistory = useMemo(() => 
                filteredHistory.slice((currentPage - 1) * ITEMS_PER_PAGE, currentPage * ITEMS_PER_PAGE),
                [filteredHistory, currentPage]
            );

            const handleExport = useCallback(() => {
                const dataToExport = filteredHistory.map((task, index) => ({
                    'No': index + 1,
                    'Staff': task.staffName || 'N/A',
                    'Shop': task.shopName || 'N/A',
                    'Task': task.text,
                    'Auditor': task.auditorName || 'Auto',
                    'Score': task.auditScore || '',
                    'Duration': formatFixedDuration(task.progressTimestamp?.seconds, (task.workCompletedTimestamp || task.completedTimestamp)?.seconds),
                    'Started': formatFullDateTime(task.progressTimestamp),
                    'Completed': formatFullDateTime(task.workCompletedTimestamp || task.completedTimestamp),
                }));
                const worksheet = XLSX.utils.json_to_sheet(dataToExport);
                const workbook = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(workbook, worksheet, "Completed Tasks");
                XLSX.writeFile(workbook, `JLW_Completed_Tasks_${filters.date}.xlsx`);
            }, [filteredHistory, filters.date]);

            return React.createElement("div", { className: "bg-slate-800 p-4 sm:p-6 rounded-lg" },
                React.createElement(HistoryFilters, { filters, onFilterChange: handleFilterChange, shopOptions, staffOptions, isAdmin, userRole }),
                React.createElement("div", {className: "flex justify-end mb-4"}, 
                    React.createElement("button", { onClick: handleExport, className: "bg-green-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-green-700" }, "Export to Excel")
                ),
                React.createElement("div", { className: "overflow-x-auto" },
                    React.createElement("table", { className: "w-full text-left text-xs sm:text-sm" },
                        React.createElement(HistoryTableHeader, { isAdmin }),
                        React.createElement("tbody", { className: "divide-y divide-slate-700" },
                            paginatedHistory.map((task, index) => React.createElement(HistoryTableRow, { key: task.id, task, index: (currentPage - 1) * ITEMS_PER_PAGE + index, isAdmin, onEdit, onDelete, onViewComment }))
                        )
                    )
                ),
                React.createElement(Pagination, { currentPage, totalPages, onPageChange: setCurrentPage, totalResults: filteredHistory.length, itemsPerPage: ITEMS_PER_PAGE })
            );
        });

        const HistoryFilters = React.memo(({ filters, onFilterChange, shopOptions, staffOptions, isAdmin, userRole }) => (
            React.createElement("div", { className: "flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4" },
                React.createElement("div", { className: "w-full sm:w-auto flex flex-col sm:flex-row flex-wrap items-center gap-2 sm:gap-4" },
                    React.createElement("select", { name: "shop", value: filters.shop, onChange: onFilterChange, className: "input w-full sm:w-auto text-sm", disabled: userRole === ROLES.STAFF }, React.createElement("option", { value: "" }, "All Shops"), shopOptions.map(name => React.createElement("option", { key: name, value: name }, name))),
                    React.createElement("select", { name: "staff", value: filters.staff, onChange: onFilterChange, className: "input w-full sm:w-auto text-sm", disabled: userRole === ROLES.STAFF }, React.createElement("option", { value: "" }, "All Staff"), staffOptions.map(name => React.createElement("option", { key: name, value: name }, name))),
                    React.createElement("input", { name: "date", type: "month", value: filters.date, onChange: onFilterChange, className: "input w-full sm:w-auto text-sm" }),
                    isAdmin && React.createElement("div", {className: "flex items-center"}, React.createElement("input", { id: "historyShopManagerOnly", name: "shopManagerOnly", type: "checkbox", checked: filters.shopManagerOnly, onChange: onFilterChange, className: "h-4 w-4" }), React.createElement("label", { htmlFor: "historyShopManagerOnly", className: "ml-2 text-sm" }, "Shop Managers Only"))
                )
            )
        ));
        
        const HistoryTableHeader = React.memo(({ isAdmin }) => (
            React.createElement("thead", { className: "bg-slate-700/50" }, React.createElement("tr", null,
                ["No", "Staff", "Shop", "Task", "Comment", "Auditor", "Score", "Duration", "Started", "Completed"].map(header => React.createElement("th", { key: header, className: `px-2 py-3 sm:p-4 text-sm font-semibold text-slate-400 ${header === 'Comment' ? 'text-center' : ''}` }, header)),
                isAdmin && React.createElement("th", { className: "px-2 py-3 sm:p-4 text-sm font-semibold text-slate-400 text-right" }, "Actions")
            ))
        ));

        const HistoryTableRow = React.memo(({ task, index, isAdmin, onEdit, onDelete, onViewComment }) => (
            React.createElement("tr", { className: "hover:bg-slate-700" },
                React.createElement("td", { className: "p-2 sm:p-4" }, index + 1),
                React.createElement("td", { className: "p-2 sm:p-4" }, task.staffName || 'N/A'),
                React.createElement("td", { className: "p-2 sm:p-4" }, task.shopName || 'N/A'),
                React.createElement("td", { className: "p-2 sm:p-4" }, task.text),
                React.createElement("td", { className: "p-2 sm:p-4 text-center" },
                    task.auditComment && React.createElement("button", { className: "inline-block cursor-pointer p-1 rounded-full hover:bg-slate-600 transition-colors", title: "View Comment", onClick: () => onViewComment(task.auditComment) }, React.createElement(ICONS.VIEW))
                ),
                React.createElement("td", { className: "p-2 sm:p-4" }, task.auditorName || 'Auto'),
                React.createElement("td", { className: "p-2 sm:p-4 font-bold text-emerald-400" }, task.auditScore || ''),
                React.createElement("td", { className: "p-2 sm:p-4 font-medium" }, formatFixedDuration(task.progressTimestamp?.seconds, (task.workCompletedTimestamp || task.completedTimestamp)?.seconds)),
                React.createElement("td", { className: "p-2 sm:p-4 text-sm" }, formatFullDateTime(task.progressTimestamp)),
                React.createElement("td", { className: "p-2 sm:p-4 text-sm" }, formatFullDateTime(task.workCompletedTimestamp || task.completedTimestamp)),
                isAdmin && React.createElement("td", { className: "p-2 sm:p-4 text-right" },
                    React.createElement("div", { className: "flex items-center justify-end space-x-4" },
                        React.createElement("button", { onClick: () => onEdit(task), className: "text-indigo-400 hover:text-indigo-300" }, React.createElement("svg", { xmlns: "http://www.w3.org/2000/svg", width: "16", height: "16", viewBox: "0 0 24 24", fill: "none", stroke: "currentColor", strokeWidth: "2" }, React.createElement("path", { d: "M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z" }))),
                        React.createElement("button", { onClick: () => onDelete(task), className: "text-red-500 hover:text-red-400" }, React.createElement("svg", { xmlns: "http://www.w3.org/2000/svg", width: "16", height: "16", viewBox: "0 0 24 24", fill: "none", stroke: "currentColor", strokeWidth: "2" }, React.createElement("polyline", { points: "3 6 5 6 21 6" }), React.createElement("path", { d: "M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2" })))
                    )
                )
            )
        ));
        
        // --- Settings Page ---
        const SettingsPage = React.memo(() => {
            const [activeTab, setActiveTab] = useState('shops');
            const { isAdmin } = useAuth();
            return React.createElement("div", { className: "space-y-6" },
                React.createElement("h1", { className: "text-3xl font-bold text-slate-100" }, "Application Settings"),
                 React.createElement("div", { className: "flex flex-wrap gap-2 bg-slate-900 p-1 rounded-lg" },
                     React.createElement(TabButton, { tabName: "shops", title: "Shops", activeTab, setActiveTab }),
                     React.createElement(TabButton, { tabName: "staff", title: "Staff List", activeTab, setActiveTab }),
                     isAdmin && React.createElement(TabButton, { tabName: "memo", title: "Memo Alert", activeTab, setActiveTab })
                 ),
                 React.createElement("div", null,
                    activeTab === 'shops' && React.createElement(ShopSettings),
                    activeTab === 'staff' && React.createElement(StaffSettings),
                    activeTab === 'memo' && isAdmin && React.createElement(MemoSettings)
                 )
            );
        });

        const TabButton = React.memo(({ tabName, title, activeTab, setActiveTab }) => (
            React.createElement("button", {
                onClick: () => setActiveTab(tabName),
                className: `px-3 py-2 text-sm font-medium rounded-md transition-colors duration-200 flex-grow text-center sm:flex-grow-0 ${ activeTab === tabName ? 'bg-blue-600 text-white shadow-md' : 'bg-slate-700 text-slate-300 hover:bg-slate-600' }`
            }, title)
        ));

        const ShopSettings = () => {
            const { shops } = useData();
            const shopConfig = useMemo(() => ({
                formFields: [ { name: 'name', label: 'Shop Name', required: true }, { name: 'contact', label: 'Contact' }, { name: 'address', label: 'Address', fullWidth: true } ],
                listColumns: [ { header: 'Shop Name', accessor: 'name' }, { header: 'Contact', accessor: 'contact' }, { header: 'Address', accessor: 'address' } ]
            }), []);

            return React.createElement(SettingsCRUD, { title: "Shop", collectionName: COLLECTIONS.SHOPS, items: shops, ...shopConfig });
        };
        
        const StaffSettings = () => {
            const { shops, employees } = useData();
            const { isAdmin } = useAuth();
            const [isImporting, setIsImporting] = useState(false);
            const [importStatus, setImportStatus] = useState('');
            const fileInputRef = useRef(null);

            const handleDownloadTemplate = useCallback(() => {
                const ws = XLSX.utils.json_to_sheet([
                    { name: "John Doe", email: "john.d@example.com", status: "Active", role: "Staff", assignedShop: "Main Street Store", pagePermissions: "dashboard,board" },
                    {}, { Note: "--- INSTRUCTIONS ---" }, { Note: "Status: Active, Terminated, Resigned." },
                    { Note: "Role: Staff, Shop Manager." }, { Note: "assignedShop: Comma-separated list of shop names." },
                    { Note: "pagePermissions: Comma-separated list (dashboard, board, reports, settings)." }
                ]);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Staff");
                XLSX.writeFile(wb, "JLW_Staff_Template.xlsx");
            }, []);

            const handleFileImport = useCallback(async (e) => {
                const file = e.target.files[0];
                if (!file) return;
                setIsImporting(true); setImportStatus('Reading file...');
                const reader = new FileReader();
                reader.onload = async (event) => {
                    try {
                        const workbook = XLSX.read(new Uint8Array(event.target.result), { type: 'array' });
                        const json = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);
                        if (json.length === 0) throw new Error('File is empty.');
                        
                        setImportStatus(`Processing ${json.length} records...`);
                        const batch = writeBatch(db);
                        let updates = 0, additions = 0;

                        for (const row of json) {
                            if (!row.name || !row.email) continue;
                            const shopIds = shops.filter(s => (row.assignedShop || '').split(',').map(n => n.trim()).includes(s.name)).map(s => s.id);
                            const q = query(collection(db, COLLECTIONS.EMPLOYEES), where("email", "==", row.email.toLowerCase()));
                            const existing = await getDocs(q);
                            
                            const employeeData = {
                                name: row.name, email: row.email.toLowerCase(), status: row.status || 'Active', role: row.role || 'Staff',
                                assignedShops: shopIds,
                                pagePermissions: (isAdmin && row.pagePermissions) ? row.pagePermissions.split(',').map(p => p.trim()) : []
                            };
                            
                            if (!existing.empty) {
                                batch.update(doc(db, COLLECTIONS.EMPLOYEES, existing.docs[0].id), employeeData);
                                updates++;
                            } else {
                                batch.set(doc(collection(db, COLLECTIONS.EMPLOYEES)), employeeData);
                                additions++;
                            }
                        }
                        await batch.commit();
                        setImportStatus(`Import complete! Added: ${additions}, Updated: ${updates}.`);
                    } catch (error) {
                        console.error("Import Error:", error);
                        setImportStatus('An error occurred during import.');
                    } finally {
                        setIsImporting(false);
                        if(fileInputRef.current) fileInputRef.current.value = "";
                        setTimeout(() => setImportStatus(''), 5000);
                    }
                };
                reader.readAsArrayBuffer(file);
            }, [shops, isAdmin]);

            const staffConfig = useMemo(() => {
                const roleOptions = [
                    {id: ROLES.SHOP_MANAGER, name: ROLES.SHOP_MANAGER},
                    {id: ROLES.STAFF, name: ROLES.STAFF}
                ];
                if (isAdmin) {
                    roleOptions.push({id: 'admin', name: ROLES.ADMIN});
                }

                const fields = [
                    { name: 'name', label: 'Staff Name', required: true }, { name: 'email', label: 'Staff Email (login)', type: 'email', required: true },
                    { name: 'status', label: 'Status', type: 'select', options: [{id: 'Active', name: 'Active'}, {id: 'Terminated', name: 'Terminated'}, {id: 'Resigned', name: 'Resigned'}], required: true, defaultValue: 'Active' },
                    { name: 'role', label: 'Role', type: 'select', options: roleOptions, required: true },
                    { name: 'assignedShops', label: 'Assigned Shop(s)', type: 'checkbox-group', options: shops },
                ];
                if (isAdmin) fields.push({ name: 'pagePermissions', label: 'Permissions', type: 'checkbox-group', options: [{ id: 'dashboard', name: 'Dashboard' }, { id: 'board', name: 'Task Manager' }, {id: 'reports', name: 'Reports'}, { id: 'settings', name: 'Settings' }], fullWidth: true });
                return {
                    formFields: fields,
                    listColumns: [
                        { header: 'Name', accessor: 'name' }, { header: 'Email', accessor: 'email' }, { header: 'Status', accessor: 'status' }, { header: 'Role', accessor: 'role' },
                        { header: 'Shop(s)', accessor: 'assignedShops', render: (item) => (item.assignedShops || []).map(id => shops.find(s => s.id === id)?.name).join(', ') || 'N/A' },
                        { header: 'Permissions', accessor: 'pagePermissions', render: (item) => (item.pagePermissions || []).join(', ') || 'None' }
                    ]
                }
            }, [shops, isAdmin]);
            
            const headerActions = React.createElement(React.Fragment, null,
                React.createElement("input", { type: "file", ref: fileInputRef, onChange: handleFileImport, className: "hidden", accept: ".xlsx,.xls" }),
                React.createElement("button", { onClick: () => fileInputRef.current?.click(), className: "bg-green-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-green-700 disabled:opacity-50", disabled: isImporting }, isImporting ? 'Importing...' : 'Import Excel'),
                React.createElement("button", { onClick: handleDownloadTemplate, className: "bg-slate-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-slate-500" }, "Download Template")
            );

            return React.createElement(React.Fragment, null,
                importStatus && React.createElement("div", { className: `mb-4 p-3 rounded-lg text-sm ${importStatus.startsWith('Error') ? 'bg-red-900/50 text-red-400' : 'bg-slate-700 text-slate-200'}` }, importStatus),
                React.createElement(SettingsCRUD, { title: "Staff", collectionName: COLLECTIONS.EMPLOYEES, items: employees, ...staffConfig, headerActions })
            );
        };

        const MemoSettings = () => {
            const { memo } = useData();
            const [message, setMessage] = useState('');
            const [targetRole, setTargetRole] = useState('none');
            const [status, setStatus] = useState('');

            useEffect(() => { if (memo) { setMessage(memo.message || ''); setTargetRole(memo.targetRole || 'none'); } }, [memo]);

            const handleSaveMemo = useCallback(async (e) => {
                e.preventDefault();
                setStatus('Saving...');
                try {
                    await setDoc(doc(db, COLLECTIONS.SETTINGS, 'memo'), { message, isActive: targetRole !== 'none', targetRole });
                    setStatus('Memo saved successfully!');
                } catch (error) { setStatus('Error saving memo.'); }
                setTimeout(() => setStatus(''), 3000);
            }, [message, targetRole]);

            return React.createElement("div", { className: "bg-slate-800 p-6 rounded-lg" },
                React.createElement("h2", { className: "text-2xl font-semibold mb-4 text-slate-100" }, "Memo Alert Management"),
                React.createElement("form", { onSubmit: handleSaveMemo, className: "space-y-4" },
                    React.createElement("textarea", { value: message, onChange: (e) => setMessage(e.target.value), className: "input", rows: "4", placeholder: "Enter the memo..." }),
                    React.createElement("fieldset", { className: "flex items-center space-x-6" },
                        React.createElement(RadioOption, { id: "memoAll", value: "all", label: "All", checked: targetRole === 'all', onChange: (e) => setTargetRole(e.target.value) }),
                        React.createElement(RadioOption, { id: "memoManager", value: "shopManager", label: "Shop Managers", checked: targetRole === 'shopManager', onChange: (e) => setTargetRole(e.target.value) }),
                        React.createElement(RadioOption, { id: "memoNone", value: "none", label: "Deactivate", checked: targetRole === 'none', onChange: (e) => setTargetRole(e.target.value) })
                    ),
                    React.createElement("div", { className: "flex items-center gap-4" },
                        React.createElement("button", { type: "submit", className: "bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-700" }, "Save Memo"),
                        status && React.createElement("p", { className: "text-sm text-green-400" }, status)
                    )
                )
            );
        };
        
        // --- Reusable & Generic Components ---
        const LoadingSpinner = ({ text }) => React.createElement("div", { className: "flex flex-col justify-center items-center h-screen" }, React.createElement("svg", { className: "animate-spin h-8 w-8 text-blue-500", fill: "none", viewBox: "0 0 24 24" }, React.createElement("circle", { cx: "12", cy: "12", r: "10", stroke: "currentColor", strokeWidth: "4", className:"opacity-25" }), React.createElement("path", { fill: "currentColor", d: "M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.96 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z", className:"opacity-75" })), React.createElement("p", { className: "text-lg font-semibold mt-4" }, text));

        const Login = () => {
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [error, setError] = useState('');
            const [showPassword, setShowPassword] = useState(false);

            const handleLogin = async (e) => {
                e.preventDefault(); setError('');
                try {
                    await setPersistence(auth, browserSessionPersistence);
                    await signInWithEmailAndPassword(auth, email, password);
                } catch (err) { setError('Invalid email or password.'); }
            };

            return React.createElement("div", { className: "flex items-center justify-center min-h-screen p-4" },
                React.createElement("div", { className: "w-full max-w-sm mx-auto" },
                    React.createElement("h2", { className: "text-3xl font-bold text-center" }, "JLW Task Tracker"),
                    React.createElement("form", { onSubmit: handleLogin, className: "mt-8 space-y-6" },
                        error && React.createElement("p", { className: "p-3 bg-red-900/50 text-red-400 rounded-md" }, error),
                        React.createElement("input", { type: "email", value: email, onChange: (e) => setEmail(e.target.value), placeholder: "Email", required: true, className: "input" }),
                        React.createElement("div", { className: "relative" },
                            React.createElement("input", { type: showPassword ? "text" : "password", value: password, onChange: (e) => setPassword(e.target.value), placeholder: "Password", required: true, className: "input pr-10" }),
                            React.createElement("button", { type: "button", onClick: () => setShowPassword(prev => !prev), className: "absolute inset-y-0 right-0 pr-3 flex items-center text-slate-400 hover:text-slate-200" },
                                showPassword ? React.createElement(ICONS.EYE_SLASHED, { className: "h-5 w-5" }) : React.createElement(ICONS.EYE, { className: "h-5 w-5" })
                            )
                        ),
                        React.createElement("button", { type: "submit", className: "w-full py-3 rounded-md bg-blue-600 hover:bg-blue-700" }, "Sign in")
                    )
                )
            );
        };

        const Pagination = React.memo(({ currentPage, totalPages, onPageChange, totalResults, itemsPerPage }) => {
            if (totalPages <= 1) return null;
            const startIndex = (currentPage - 1) * itemsPerPage + 1;
            const endIndex = Math.min(startIndex + itemsPerPage - 1, totalResults);
            
            const handlePageClick = (page) => {
                if (page >= 1 && page <= totalPages) {
                    onPageChange(page);
                }
            };
            
            return React.createElement("div", { className: "mt-4 flex flex-col sm:flex-row justify-between items-center text-sm text-slate-400" },
                React.createElement("p", null, `Showing ${startIndex} to ${endIndex} of ${totalResults} results`),
                React.createElement("div", { className: "flex items-center mt-2 sm:mt-0" },
                    React.createElement("button", { onClick: () => handlePageClick(currentPage - 1), disabled: currentPage === 1, className: "px-3 py-1 rounded-md hover:bg-slate-700 disabled:opacity-50 disabled:cursor-not-allowed" }, "Previous"),
                    React.createElement("span", { className: "px-4" }, `Page ${currentPage} of ${totalPages}`),
                    React.createElement("button", { onClick: () => handlePageClick(currentPage + 1), disabled: currentPage === totalPages, className: "px-3 py-1 rounded-md hover:bg-slate-700 disabled:opacity-50 disabled:cursor-not-allowed" }, "Next")
                )
            );
        });
        
        const CommentModal = ({ comment, onClose }) => {
            return React.createElement("div", { className: "modal-overlay", onClick: onClose },
                React.createElement("div", { className: "modal-content", onClick: e => e.stopPropagation() },
                    React.createElement("h2", { className: "text-xl font-bold mb-4 text-slate-100" }, "View Comment"),
                    React.createElement("p", { className: "text-slate-300 bg-slate-700 p-4 rounded-lg whitespace-pre-wrap max-h-[60vh] overflow-y-auto" }, comment),
                    React.createElement("div", { className: "mt-6 flex justify-end" },
                        React.createElement("button", { type: "button", onClick: onClose, className: "bg-slate-600 px-4 py-2 rounded-lg hover:bg-slate-500" }, "Close")
                    )
                )
            );
        };

        const TaskModal = ({ itemToEdit, context, onClose }) => {
            const { user, userName, userRole, userShopIds } = useAuth();
            const { shops, employees } = useData();
            const isEditing = !!itemToEdit;
            const canAssign = (userRole === ROLES.ADMIN || userRole === ROLES.SHOP_MANAGER) && !isEditing;
            const [isAssigningEnabled, setIsAssigningEnabled] = useState(false);

            const getInitialState = useCallback(() => {
                const d = itemToEdit?.taskTimestamp ? new Date(itemToEdit.taskTimestamp.seconds ? itemToEdit.taskTimestamp.seconds * 1000 : itemToEdit.taskTimestamp) : new Date();
                
                let initialStaffName = '';
                if (isEditing) initialStaffName = itemToEdit.staffName || '';
                else if (userRole === ROLES.STAFF) initialStaffName = userName;
                else if (canAssign && !isAssigningEnabled) initialStaffName = userName;

                return {
                    text: itemToEdit?.text || '', date: d.toISOString().split('T')[0], time: d.toTimeString().slice(0, 5),
                    staffName: initialStaffName,
                    shopName: itemToEdit?.shopName || (userRole !== ROLES.ADMIN && userShopIds.length === 1 ? shops.find(s => s.id === userShopIds[0])?.name : ''),
                };
            }, [itemToEdit, userName, userShopIds, userRole, canAssign, isAssigningEnabled, isEditing, shops]);

            const [taskData, setTaskData] = useState(getInitialState);

            useEffect(() => {
                if (canAssign) {
                    setTaskData(prev => ({ ...prev, staffName: isAssigningEnabled ? '' : userName }));
                }
            }, [isAssigningEnabled, canAssign, userName]);

            const shopOptions = useMemo(() => {
                if (userRole === ROLES.ADMIN) return shops;
                if (userRole === ROLES.SHOP_MANAGER) return shops.filter(s => userShopIds.includes(s.id));
                return [];
            }, [shops, userRole, userShopIds]);
            
            const staffOptions = useMemo(() => {
                if (!canAssign || !isAssigningEnabled || !taskData.shopName) return [];
                const selectedShopId = shops.find(s => s.name === taskData.shopName)?.id;
                if (!selectedShopId) return [];

                return employees.filter(e => e.status === 'Active' && e.assignedShops?.includes(selectedShopId));
            }, [employees, shops, taskData.shopName, canAssign, isAssigningEnabled]);

            const handleChange = useCallback((e) => { 
                const { name, value } = e.target;
                setTaskData(prev => {
                    const newState = {...prev, [name]: value};
                    if (name === 'shopName' && canAssign) newState.staffName = isAssigningEnabled ? '' : userName;
                    return newState;
                });
            }, [isAssigningEnabled, userName, canAssign]);

            const handleSubmit = useCallback(async (e) => {
                e.preventDefault();
                if (!taskData.text.trim()) return;

                const selectedShop = shops.find(s => s.name === taskData.shopName);
                const dataToSave = {
                    text: taskData.text, staffName: taskData.staffName, shopName: taskData.shopName,
                    taskTimestamp: new Date(`${taskData.date}T${taskData.time}`), shopId: selectedShop?.id || null,
                };
                
                try {
                    if (context === 'history' && isEditing) {
                        await updateDoc(doc(db, COLLECTIONS.USERS, itemToEdit.uid, COLLECTIONS.HISTORY, itemToEdit.id), dataToSave);
                    } else if (isEditing) {
                        await updateDoc(doc(db, COLLECTIONS.USERS, itemToEdit.uid, COLLECTIONS.TASKS, itemToEdit.id), dataToSave);
                    } else { // Adding a new task
                        let assigneeUid = user.uid;
                        let assigneeEmail = user.email;

                        if (canAssign && isAssigningEnabled) {
                            const assignee = employees.find(e => e.name === taskData.staffName);
                            if (!assignee?.uid) {
                                alert("Selected staff has not logged in yet and cannot be assigned tasks.");
                                return;
                            }
                            assigneeUid = assignee.uid;
                            assigneeEmail = assignee.email;
                        }
                        
                        await addDoc(collection(db, COLLECTIONS.USERS, assigneeUid, COLLECTIONS.TASKS), { 
                            ...dataToSave, status: KANBAN_STATUS.TODO, createdAt: serverTimestamp(), 
                            userEmail: assigneeEmail, creatorRole: userRole, creatorName: userName
                        });
                    }
                    onClose();
                } catch(error) { console.error("Error saving task: ", error); }
            }, [taskData, context, itemToEdit, user, userRole, userName, onClose, shops, employees, isEditing, canAssign, isAssigningEnabled]);

            const renderShopInput = () => {
                if ((userRole === ROLES.ADMIN || userRole === ROLES.SHOP_MANAGER)) {
                    return React.createElement("select", { name: "shopName", value: taskData.shopName, onChange: handleChange, className: "input", required: true },
                        React.createElement("option", { value: "" }, "Select Shop"),
                        shopOptions.map(s => React.createElement("option", { key: s.id, value: s.name }, s.name))
                    );
                }
                return React.createElement("input", { value: taskData.shopName, className: "input", disabled: true });
            };

            const renderStaffInput = () => {
                if (canAssign && isAssigningEnabled) {
                    return React.createElement("select", { name: "staffName", value: taskData.staffName, onChange: handleChange, className: "input", required: true, disabled: !taskData.shopName },
                        React.createElement("option", { value: "" }, staffOptions.length > 0 ? "Select Staff" : "No staff in this shop"),
                        staffOptions.map(e => React.createElement("option", { key: e.id, value: e.name, disabled: !e.uid }, `${e.name}${!e.uid ? ' (needs login)' : ''}`))
                    );
                }
                return React.createElement("input", { name:"staffName", value: taskData.staffName, className: "input", disabled: true });
            };

            return React.createElement("div", { className: "modal-overlay", onClick: onClose },
                React.createElement("div", { className: "modal-content", onClick: e => e.stopPropagation() },
                    React.createElement("h2", { className: "text-2xl font-bold mb-6" }, isEditing ? `Edit ${context}` : 'Add New Task'),
                    React.createElement("form", { onSubmit: handleSubmit, className: "space-y-4" },
                        React.createElement("div", { className: "grid grid-cols-2 gap-4"},
                            React.createElement("div", null, React.createElement("label", { className: "text-sm font-medium" }, "Date"), React.createElement("input", { name: "date", type: "date", value: taskData.date, onChange: handleChange, className: "input", required: true })),
                            React.createElement("div", null, React.createElement("label", { className: "text-sm font-medium" }, "Time"), React.createElement("input", { name: "time", type: "time", value: taskData.time, onChange: handleChange, className: "input", required: true }))
                        ),
                        canAssign && React.createElement("div", { className: "flex items-center pt-2" },
                            React.createElement("input", { type: "checkbox", id: "assign-task-checkbox", checked: isAssigningEnabled, onChange: e => setIsAssigningEnabled(e.target.checked), className: "h-4 w-4 rounded border-slate-500 bg-slate-600 text-blue-500 focus:ring-blue-600" }),
                            React.createElement("label", { htmlFor: "assign-task-checkbox", className: "ml-2 text-sm font-medium" }, "Assign Task to Staff")
                        ),
                        React.createElement("div", null, React.createElement("label", { className: "text-sm font-medium" }, "Shop"), renderShopInput()),
                        React.createElement("div", null, React.createElement("label", { className: "text-sm font-medium" }, "Staff"), renderStaffInput()),
                        React.createElement("textarea", { name: "text", value: taskData.text, onChange: handleChange, className: "input", rows: "3", placeholder: "Task Description...", required: true }),
                        React.createElement("div", { className: "mt-6 flex justify-end space-x-4" },
                            React.createElement("button", { type: "button", onClick: onClose, className: "bg-slate-600 px-4 py-2 rounded-lg" }, "Cancel"),
                            React.createElement("button", { type: "submit", className: "bg-blue-600 text-white px-4 py-2 rounded-lg" }, `Save ${isEditing ? 'Changes' : 'Task'}`)
                        )
                    )
                )
            );
        };
        
        const SettingsCRUD = ({ title, collectionName, items, formFields, listColumns, headerActions }) => {
            const [editingItem, setEditingItem] = useState(null);
            const [searchTerm, setSearchTerm] = useState('');
            const [formState, setFormState] = useState({});
            const [isModalOpen, setIsModalOpen] = useState(false);

            const openModal = useCallback((item = null) => {
                setEditingItem(item);
                const initialState = formFields.reduce((acc, field) => {
                    let value = item ? (field.accessor ? item[field.accessor] : item[field.name]) : (field.defaultValue || '');
                    if (field.type === 'checkbox-group' && !Array.isArray(value)) value = [];
                    acc[field.name] = value;
                    return acc;
                }, {});
                setFormState(initialState);
                setIsModalOpen(true);
            }, [formFields]);

            const closeModal = useCallback(() => setIsModalOpen(false), []);

            const handleChange = useCallback((e) => {
                const { name, value, type, checked } = e.target;
                setFormState(prev => {
                    if (type === 'checkbox') {
                        const currentValues = prev[name] || [];
                        if (checked) return { ...prev, [name]: [...currentValues, value] };
                        return { ...prev, [name]: currentValues.filter(v => v !== value) };
                    }
                    return { ...prev, [name]: value };
                });
            }, []);

            const handleSubmit = useCallback(async (e) => {
                e.preventDefault();
                try {
                    const dataToSave = { ...formState };
                    if (collectionName === COLLECTIONS.EMPLOYEES && dataToSave.email) {
                        dataToSave.email = dataToSave.email.toLowerCase();
                    }
                    if (editingItem) {
                        await updateDoc(doc(db, collectionName, editingItem.id), dataToSave);
                    } else {
                        await addDoc(collection(db, collectionName), dataToSave);
                    }
                    closeModal();
                } catch (error) { console.error(`Error saving ${title}:`, error); }
            }, [formState, editingItem, collectionName, title, closeModal]);

            const handleDelete = useCallback(async (id) => {
                if (window.confirm(`Are you sure you want to delete this ${title}?`)) {
                    try { await deleteDoc(doc(db, collectionName, id)); } catch(e) { console.error(e); }
                }
            }, [collectionName, title]);

            const filteredItems = useMemo(() => items.filter(item => 
                Object.values(item).some(val => String(val).toLowerCase().includes(searchTerm.toLowerCase()))
            ), [items, searchTerm]);
            
            return React.createElement("div", { className: "bg-slate-800 p-6 rounded-lg" },
                React.createElement("div", { className: "flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 gap-4" },
                    React.createElement("h2", { className: "text-2xl font-semibold text-slate-100" }, `${title} Management`),
                    React.createElement("div", { className: "flex items-center gap-2" }, headerActions),
                    React.createElement("button", { onClick: () => openModal(), className: "bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-700" }, `+ Add New ${title}`)
                ),
                React.createElement("input", { type: "text", placeholder: `Search ${title}s...`, value: searchTerm, onChange: e => setSearchTerm(e.target.value), className: "input mb-4" }),
                React.createElement("div", { className: "overflow-x-auto" },
                    React.createElement("table", { className: "w-full text-left" },
                        React.createElement("thead", { className: "bg-slate-700/50" }, React.createElement("tr", null,
                            listColumns.map(col => React.createElement("th", { key: col.header, className: "px-4 py-3 text-sm font-semibold text-slate-400" }, col.header)),
                            React.createElement("th", { className: "px-4 py-3 text-sm font-semibold text-slate-400 text-right" }, "Actions")
                        )),
                        React.createElement("tbody", { className: "divide-y divide-slate-700" },
                            filteredItems.map(item => React.createElement("tr", { key: item.id, className: "hover:bg-slate-700" },
                                listColumns.map(col => React.createElement("td", { key: col.accessor, className: "px-4 py-3 text-sm" }, col.render ? col.render(item) : item[col.accessor])),
                                React.createElement("td", { className: "px-4 py-3 text-sm text-right" },
                                    React.createElement("button", { onClick: () => openModal(item), className: "text-indigo-400 hover:text-indigo-300 mr-4" }, "Edit"),
                                    React.createElement("button", { onClick: () => handleDelete(item.id), className: "text-red-500 hover:text-red-400" }, "Delete")
                                )
                            ))
                        )
                    )
                ),
                isModalOpen && React.createElement("div", { className: "modal-overlay", onClick: closeModal },
                    React.createElement("div", { className: "modal-content", onClick: e => e.stopPropagation() },
                        React.createElement("h2", { className: "text-2xl font-bold mb-6" }, `${editingItem ? 'Edit' : 'Add'} ${title}`),
                        React.createElement("form", { onSubmit: handleSubmit, className: "space-y-4" },
                            React.createElement("div", { className: `grid grid-cols-1 ${formFields.some(f => !f.fullWidth) ? 'sm:grid-cols-2' : ''} gap-4` },
                                formFields.map(field => React.createElement(FormField, { key: field.name, field, value: formState[field.name], onChange: handleChange }))
                            ),
                            React.createElement("div", { className: "mt-6 flex justify-end space-x-4" },
                                React.createElement("button", { type: "button", onClick: closeModal, className: "bg-slate-600 px-4 py-2 rounded-lg" }, "Cancel"),
                                React.createElement("button", { type: "submit", className: "bg-blue-600 text-white px-4 py-2 rounded-lg" }, `Save ${title}`)
                            )
                        )
                    )
                )
            );
        };
        
        const FormField = ({ field, value, onChange }) => {
            const className = field.fullWidth ? "sm:col-span-2" : "";
            const commonProps = { name: field.name, onChange, required: field.required, className: "input" };
            return React.createElement("div", { className },
                React.createElement("label", { htmlFor: field.name, className: "text-sm font-medium" }, field.label),
                field.type === 'select' ?
                    React.createElement("select", { ...commonProps, id: field.name, value: value || field.defaultValue || '' },
                        React.createElement("option", { value: "" }, `Select a ${field.label}...`),
                        field.options.map(opt => React.createElement("option", { key: opt.id, value: opt.id }, opt.name))
                    ) : field.type === 'checkbox-group' ?
                    React.createElement("div", { className: "checkbox-group" },
                        field.options.map(opt => React.createElement("div", { key: opt.id, className: "flex items-center" },
                            React.createElement("input", { type: "checkbox", id: `${field.name}-${opt.id}`, name: field.name, value: opt.id, checked: (value || []).includes(opt.id), onChange, className: "h-4 w-4" }),
                            React.createElement("label", { htmlFor: `${field.name}-${opt.id}`, className: "ml-2 text-sm" }, opt.name)
                        ))
                    ) :
                    React.createElement("input", { ...commonProps, id: field.name, type: field.type || 'text', value: value || '' })
            );
        };
        
        const MemoAlert = () => {
            const { memo } = useData();
            const { userRole } = useAuth();
            const [isVisible, setIsVisible] = useState(false);
            useEffect(() => { setIsVisible(memo?.isActive && (memo.targetRole === 'all' || memo.targetRole === userRole)); }, [memo, userRole]);
            if (!isVisible) return null;
            return React.createElement("div", { className: "fixed bottom-4 right-4 z-50 max-w-sm p-4 bg-yellow-400 text-yellow-900 rounded-lg shadow-lg notification" }, React.createElement("p", null, memo.message), React.createElement("button", { onClick: () => setIsVisible(false), className: "absolute top-2 right-2 font-bold" }, "×"));
        };

        const RadioOption = ({ id, value, label, checked, onChange }) => React.createElement("div", { className: "flex items-center" }, React.createElement("input", { type: "radio", id, name: "memoTarget", value, checked, onChange }), React.createElement("label", { htmlFor: id, className: "ml-2" }, label));

        // --- Render Application ---
        const root = ReactDOM.createRoot(document.getElementById("root"));
        root.render(React.createElement(AuthProvider, null, React.createElement(DataProvider, null, React.createElement(App))));
    </script>
</body>
</html>



