<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>JLW Task Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        html, body { overflow-x: hidden; }
        body { 
            font-family: 'Inter', sans-serif; 
            -webkit-font-smoothing: antialiased; 
            -moz-osx-font-smoothing: grayscale;
        }
        .task-card { transition: background-color 0.2s ease-in-out, box-shadow 0.2s ease-in-out; }
        .kanban-column-body::-webkit-scrollbar, .checkbox-group::-webkit-scrollbar, .chat-messages::-webkit-scrollbar, .user-list::-webkit-scrollbar { width: 8px; }
        .kanban-column-body::-webkit-scrollbar-track, .checkbox-group::-webkit-scrollbar-track, .chat-messages::-webkit-scrollbar-track, .user-list::-webkit-scrollbar-track { background: #1e293b; border-radius: 10px; }
        .kanban-column-body::-webkit-scrollbar-thumb, .checkbox-group::-webkit-scrollbar-thumb, .chat-messages::-webkit-scrollbar-thumb, .user-list::-webkit-scrollbar-thumb { background: #475569; border-radius: 10px; }
        .kanban-column-body::-webkit-scrollbar-thumb:hover, .checkbox-group::-webkit-scrollbar-thumb:hover, .chat-messages::-webkit-scrollbar-thumb:hover, .user-list::-webkit-scrollbar-thumb:hover { background: #64748b; }
        .modal-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex; justify-content: center; align-items: center;
            z-index: 50; padding: 1rem;
        }
        .modal-content {
            background-color: #1e293b; padding: 1.5rem; border-radius: 0.5rem;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1); width: 100%; max-width: 500px;
        }
        .input {
            margin-top: 0.25rem; display: block; width: 100%;
            padding: 0.75rem; border-width: 1px; border-color: #475569;
            border-radius: 0.375rem; box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            transition: border-color 0.2s, box-shadow 0.2s;
            background-color: #334155; color: #e2e8f0;
        }
        .input:focus {
            outline: 2px solid transparent; outline-offset: 2px;
            border-color: #3B82F6; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.3);
        }
        .input:disabled {
            background-color: #475569;
            cursor: not-allowed;
            opacity: 0.7;
        }
        .checkbox-group {
            max-height: 150px; overflow-y: auto; border: 1px solid #475569;
            border-radius: 0.375rem; padding: 0.75rem; margin-top: 0.25rem;
            background-color: #334155;
        }
        @keyframes slideIn {
            from { { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        .notification {
            animation: slideIn 0.5s ease-out forwards;
        }
    </style>
</head>
<body class="bg-slate-900 text-slate-300">
    <div id="root"></div>

    <script type="module">
        // --- React & Firebase Imports ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, setPersistence, browserSessionPersistence, browserLocalPersistence, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, getDocs, addDoc, doc, getDoc, updateDoc, deleteDoc, onSnapshot, serverTimestamp, query, where, collectionGroup, enableIndexedDbPersistence, setDoc, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import React, { useState, useEffect, useRef, createContext, useContext, useMemo, useCallback } from "https://esm.sh/react@18.2.0";
        import ReactDOM from "https://esm.sh/react-dom@18.2.0/client";

        // --- Firebase Configuration ---
        const firebaseConfig = {
            apiKey: "AIzaSyB7_pnmwHj6aOeZRTykPvNusNFYReaTY6Q",
            authDomain: "hrsm-j.firebaseapp.com",
            projectId: "hrsm-j",
            storageBucket: "hrsm-j.firebasestorage.app",
            messagingSenderId: "45063715478",
            appId: "1:45063715478:web:cc2dd21b83dd195771e0b7",
            measurementId: "G-8HQDG2LTKP"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        // --- Offline Persistence & Caching --- 
        enableIndexedDbPersistence(db).catch((err) => {
            if (err.code == 'failed-precondition') {
              console.warn('Firestore persistence failed: Multiple tabs open.');
            } else if (err.code == 'unimplemented') {
              console.warn('Firestore persistence failed: Browser not supported.');
            }
        });

        // --- Constants ---
        const CONSTANTS = {
            COLLECTIONS: {
                SHOPS: 'shops',
                EMPLOYEES: 'employees',
                USERS: 'users',
                TASKS: 'tasks',
                HISTORY: 'history',
                SETTINGS: 'settings',
                USER_SETTINGS: 'userSettings'
            },
            ADMIN_EMAIL: 'jlw@jlw.com'
        };

        const ICONS = {
            DASHBOARD: React.createElement("svg", { "xmlns": "http://www.w3.org/2000/svg", "width": "24", "height": "24", "viewBox": "0 0 24 24", "fill": "none", "stroke": "currentColor", "strokeWidth": "2", "strokeLinecap": "round", "strokeLinejoin": "round" }, React.createElement("rect", { "x": "3", "y": "3", "width": "7", "height": "7" }), React.createElement("rect", { "x": "14", "y": "3", "width": "7", "height": "7" }), React.createElement("rect", { "x": "14", "y": "14", "width": "7", "height": "7" }), React.createElement("rect", { "x": "3", "y": "14", "width": "7", "height": "7" })),
            BOARD: React.createElement("svg", { "xmlns": "http://www.w3.org/2000/svg", "width": "24", "height": "24", "viewBox": "0 0 24 24", "fill": "none", "stroke": "currentColor", "strokeWidth": "2", "strokeLinecap": "round", "strokeLinejoin": "round" }, React.createElement("rect", { "x": "3", "y": "3", "width": "18", "height": "18", "rx": "2", "ry": "2" }), React.createElement("line", { "x1": "9", "y1": "3", "x2": "9", "y2": "21" }), React.createElement("line", { "x1": "15", "y1": "3", "x2": "15", "y2": "21" })),
            SETTINGS: React.createElement("svg", { "xmlns": "http://www.w3.org/2000/svg", "width": "24", "height": "24", "viewBox": "0 0 24 24", "fill": "none", "stroke": "currentColor", "strokeWidth": "2", "strokeLinecap": "round", "strokeLinejoin": "round" }, React.createElement("path", { "d": "M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 0 2l-.15.08a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l-.22-.38a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1 0-2l.15-.08a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z" }), React.createElement("circle", { "cx": "12", "cy": "12", "r": "3" })),
            LOGOUT: React.createElement("svg", { "xmlns": "http://www.w3.org/2000/svg", "width": "24", "height": "24", "viewBox": "0 0 24 24", "fill": "none", "stroke": "currentColor", "strokeWidth": "2", "strokeLinecap": "round", "strokeLinejoin": "round" }, React.createElement("path", { "d": "M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4" }), React.createElement("polyline", { "points": "16 17 21 12 16 7" }), React.createElement("line", { "x1": "21", "y1": "12", "x2": "9", "y2": "12" })),
            MENU: React.createElement("svg", { "xmlns": "http://www.w3.org/2000/svg", "width": "24", "height": "24", "viewBox": "0 0 24 24", "fill": "none", "stroke": "currentColor", "strokeWidth": "2", "strokeLinecap": "round", "strokeLinejoin": "round" }, React.createElement("line", { "x1": "3", "y1": "12", "x2": "21", "y2": "12" }), React.createElement("line", { "x1": "3", "y1": "6", "x2": "21", "y2": "6" }), React.createElement("line", { "x1": "3", "y1": "18", "x2": "21", "y2": "18" })),
            LOGO: React.createElement("svg", { className: "w-6 h-6 text-white", viewBox: "0 0 512 512", fill: "currentColor" }, React.createElement("path", { d: "M368 128H144C126.3 128 112 142.3 112 160V416C112 433.7 126.3 448 144 448H368C385.7 448 400 433.7 400 416V160C400 142.3 385.7 128 368 128ZM256 64C269.8 64 282.8 68.88 292.8 76.8L336.2 109.5C340.6 112.8 346.5 112.5 350.5 108.5L364.5 94.5C368.5 90.5 370.2 84.98 368.8 79.88C359.1 43.8 322.2 16 280 16C222.2 16 176 62.15 176 120V128H208V120C208 84.33 228.3 64 256 64Z" })),
            OFFLINE: React.createElement("svg", { "xmlns": "http://www.w3.org/2000/svg", "width": "16", "height": "16", "viewBox": "0 0 24 24", "fill": "none", "stroke": "currentColor", "strokeWidth": "2", "strokeLinecap": "round", "strokeLinejoin": "round" }, React.createElement("line", { "x1": "2", "x2": "22", "y1": "2", "y2": "22" }), React.createElement("path", { "d": "M8.5 16.5a5 5 0 0 1 7 0" }), React.createElement("path", { "d": "M2 8.82a15 15 0 0 1 4.17-2.65" }), React.createElement("path", { "d": "M10.66 5c4.01-.36 8.14.9 11.34 3.76" }), React.createElement("path", { "d": "M16.85 11.25a10 10 0 0 1 2.22 1.68" }), React.createElement("path", { "d": "M5.15 11.25a10 10 0 0 0 2.22-1.68" }), React.createElement("path", { "d": "M12.32 13.75a2.94 2.94 0 0 1 1.68 1.68" }))
        };

        // --- Contexts ---
        const AuthContext = createContext();
        const DataContext = createContext();

        const useAuth = () => useContext(AuthContext);
        const useData = () => useContext(DataContext);

        // --- Providers ---
        const AuthProvider = ({ children }) => {
            const [user, setUser] = useState(null);
            const [isAuthReady, setIsAuthReady] = useState(false);
            const [isLoadingPermissions, setIsLoadingPermissions] = useState(true);
            
            const initialAuthData = {
                isAdmin: false,
                permissions: [],
                userName: '',
                userShop: '',
                userShopId: '',
                userRole: '',
                settings: { retentionPeriod: 'never' }
            };

            const [authData, setAuthData] = useState(initialAuthData);

            useEffect(() => {
                const unsubscribe = onAuthStateChanged(auth, (currentUser) => {
                    setUser(currentUser);
                    if (!currentUser) {
                        setAuthData(initialAuthData); // Reset on logout
                        setIsLoadingPermissions(false);
                    }
                    setIsAuthReady(true);
                });
                return () => unsubscribe();
            }, []);

            useEffect(() => {
                if (!user) return;
                
                const cleanupOldHistory = async (settings) => {
                    if (!settings || !settings.retentionPeriod || settings.retentionPeriod === 'never') return;
                    
                    const monthsMap = { '3m': 3, '6m': 6, '12m': 12 };
                    const months = monthsMap[settings.retentionPeriod];
                    if (!months) return;

                    const cutoffDate = new Date();
                    cutoffDate.setMonth(cutoffDate.getMonth() - months);
                    
                    const historyRef = collection(db, CONSTANTS.COLLECTIONS.USERS, user.uid, CONSTANTS.COLLECTIONS.HISTORY);
                    const q = query(historyRef, where("completedTimestamp", "<", cutoffDate));
                    
                    try {
                        const snapshot = await getDocs(q);
                        if (snapshot.empty) return;

                        const batch = writeBatch(db);
                        snapshot.docs.forEach(doc => batch.delete(doc.ref));
                        await batch.commit();
                        console.log(`Cleaned up ${snapshot.size} old history records.`);
                    } catch (error) {
                        console.error("Error cleaning up old history:", error);
                    }
                };

                const fetchPermissionsAndSettings = async () => {
                    setIsLoadingPermissions(true);
                    let newAuthData = { ...initialAuthData };

                    try {
                        const settingsDocRef = doc(db, CONSTANTS.COLLECTIONS.USERS, user.uid, CONSTANTS.COLLECTIONS.USER_SETTINGS, 'main');
                        const settingsSnap = await getDoc(settingsDocRef);
                        if (settingsSnap.exists()) {
                            newAuthData.settings = settingsSnap.data();
                        }
                        cleanupOldHistory(newAuthData.settings);
                        
                        const isAdminUser = user.email === CONSTANTS.ADMIN_EMAIL;
                        if (isAdminUser) {
                            newAuthData = {
                                ...newAuthData,
                                isAdmin: true,
                                permissions: ['dashboard', 'board', 'settings'],
                                userName: 'Admin', 
                                userRole: 'Admin',
                            };
                        } else {
                            const q = query(collection(db, CONSTANTS.COLLECTIONS.EMPLOYEES), where("email", "==", user.email));
                            const querySnapshot = await getDocs(q);
                            
                            if (!querySnapshot.empty) {
                                const employeeData = querySnapshot.docs[0].data();
                                const { role = 'Staff', name = '', pagePermissions = [], assignedShop = '' } = employeeData;
                                
                                newAuthData.userName = name;
                                newAuthData.userRole = role;
                                newAuthData.permissions = pagePermissions;
                                newAuthData.userShopId = assignedShop;

                                if (assignedShop) {
                                    const shopDoc = await getDoc(doc(db, CONSTANTS.COLLECTIONS.SHOPS, assignedShop));
                                    if(shopDoc.exists()) newAuthData.userShop = shopDoc.data().name;
                                }
                            }
                        }
                    } catch (error) {
                        console.error("Permission/Settings fetch error:", error);
                        // State remains as initialAuthData on error
                    } finally {
                        setAuthData(newAuthData);
                        setIsLoadingPermissions(false);
                    }
                };

                fetchPermissionsAndSettings();
            }, [user]);

            const value = useMemo(() => ({ user, isAuthReady, isLoadingPermissions, ...authData }), 
                [user, isAuthReady, isLoadingPermissions, authData]);

            return React.createElement(AuthContext.Provider, { value }, children);
        };
        
        const DataProvider = ({ children }) => {
            const { user } = useAuth();
            const safelyParseJSON = useCallback((key, defaultValue) => {
                try {
                    const item = localStorage.getItem(key);
                    return item ? JSON.parse(item) : defaultValue;
                } catch (e) {
                    console.warn(`Error parsing JSON from localStorage key "${key}":`, e);
                    return defaultValue;
                }
            }, []);

            const [data, setData] = useState({
                tasks: safelyParseJSON('jlw-tasks', []),
                history: safelyParseJSON('jlw-history', []),
                shops: safelyParseJSON('jlw-shops', []),
                employees: safelyParseJSON('jlw-employees', []),
                memo: safelyParseJSON('jlw-memo', { message: '', isActive: false })
            });

            useEffect(() => {
                if (!user) return;

                const collectionsToSync = [
                    { name: 'tasks', query: query(collectionGroup(db, 'tasks')) },
                    { name: 'history', query: query(collectionGroup(db, 'history')) },
                    { name: 'shops', query: collection(db, 'shops') },
                    { name: 'employees', query: collection(db, 'employees') },
                ];

                const unsubscribers = collectionsToSync.map(({ name, query: q }) => 
                    onSnapshot(q, (snapshot) => {
                        const items = snapshot.docs.map(d => ({
                            id: d.id, 
                            ...d.data(),
                            ...( (name === 'tasks' || name === 'history') && { uid: d.ref.path.split('/')[1] } )
                        }));
                        setData(prev => ({ ...prev, [name]: items }));
                        localStorage.setItem(`jlw-${name}`, JSON.stringify(items));
                    }, err => console.error(`Error fetching ${name}:`, err))
                );
                
                const memoUnsub = onSnapshot(doc(db, CONSTANTS.COLLECTIONS.SETTINGS, 'memo'), (docSnap) => {
                    const memoData = docSnap.exists() ? docSnap.data() : { message: '', isActive: false };
                    setData(prev => ({...prev, memo: memoData}));
                    localStorage.setItem('jlw-memo', JSON.stringify(memoData));
                });

                unsubscribers.push(memoUnsub);
                return () => unsubscribers.forEach(unsub => unsub());
            }, [user]);

            const value = useMemo(() => data, [data]);
            return React.createElement(DataContext.Provider, { value }, children);
        };

        // --- Custom Hooks & Helpers ---
        const useFilteredTasks = () => {
            const { tasks: allTasks, employees } = useData();
            const { user, isAdmin, userRole, userShopId } = useAuth();

            return useMemo(() => {
                if (!user) return [];
                if (isAdmin) return allTasks;

                if (userRole === 'Shop Manager' && userShopId) {
                    const shopStaffEmails = new Set(employees
                        .filter(e => e.assignedShop === userShopId)
                        .map(e => e.email));
                    shopStaffEmails.add(user.email);
                    return allTasks.filter(task => shopStaffEmails.has(task.userEmail));
                }

                return allTasks.filter(task => task.userEmail === user.email);
            }, [allTasks, employees, user, isAdmin, userRole, userShopId]);
        };

        const useFilteredHistory = () => {
            const { history: allHistory, employees } = useData();
            const { user, isAdmin, userRole, userShopId } = useAuth();

            return useMemo(() => {
                if (!user) return [];
                let filteredHistory;

                if (isAdmin) {
                    filteredHistory = allHistory;
                } else if (userRole === 'Shop Manager' && userShopId) {
                    const shopStaffEmails = new Set(employees
                        .filter(e => e.assignedShop === userShopId)
                        .map(e => e.email));
                    shopStaffEmails.add(user.email);
                    filteredHistory = allHistory.filter(item => shopStaffEmails.has(item.userEmail));
                } else {
                    filteredHistory = allHistory.filter(item => item.userEmail === user.email);
                }
                
                return [...filteredHistory].sort((a, b) => (b.completedTimestamp?.seconds || 0) - (a.completedTimestamp?.seconds || 0));
            }, [allHistory, employees, user, isAdmin, userRole, userShopId]);
        };
        
        const useOnlineStatus = () => {
            const [isOnline, setIsOnline] = useState(navigator.onLine);
            useEffect(() => {
                const handleOnline = () => setIsOnline(true);
                const handleOffline = () => setIsOnline(false);
                window.addEventListener('online', handleOnline);
                window.addEventListener('offline', handleOffline);
                return () => {
                    window.removeEventListener('online', handleOnline);
                    window.removeEventListener('offline', handleOffline);
                };
            }, []);
            return isOnline;
        };

        const formatFixedDuration = (startSeconds, endSeconds) => {
            if (startSeconds === undefined || startSeconds === null || endSeconds === undefined || endSeconds === null) return 'N/A';
            const ms = (endSeconds - startSeconds) * 1000;

            if (ms < 0) return "0s";
            const totalSeconds = Math.floor(ms / 1000);
            const days = Math.floor(totalSeconds / 86400);
            const hours = Math.floor((totalSeconds % 86400) / 3600);
            const minutes = Math.floor((totalSeconds % 3600) / 60);
            const seconds = Math.floor(totalSeconds % 60);
            
            const parts = [];
            if (days > 0) parts.push(`${days}d`);
            if (hours > 0) parts.push(`${hours}h`);
            if (minutes > 0) parts.push(`${minutes}m`);
            if (seconds > 0) parts.push(`${seconds}s`);

            if (parts.length === 0) return "0s";
            
            if (totalSeconds < 3600) { // less than 1 hour, show more detail
                return parts.slice(0, 2).join(' '); // e.g., "5m 30s"
            }
            return parts.slice(0, 2).join(' '); // e.g., "1d 5h"
        };
        
        const formatLiveDuration = (startTime) => {
            if (!startTime?.seconds) return null;
            const startMs = startTime.seconds * 1000 + (startTime.nanoseconds || 0) / 1000000;
            const nowMs = Date.now();
            const ms = nowMs - startMs;

            if (ms < 0) return "0s";
            const seconds = Math.floor((ms / 1000) % 60);
            const minutes = Math.floor((ms / (1000 * 60)) % 60);
            const hours = Math.floor((ms / (1000 * 60 * 60)) % 24);
            const days = Math.floor(ms / (1000 * 60 * 60 * 24));
            
            const parts = [];
            if (days > 0) parts.push(`${days}d`);
            if (hours > 0) parts.push(`${hours}h`);
            if (minutes > 0) parts.push(`${minutes}m`);
            if (seconds >= 0) parts.push(`${seconds}s`);
            
            return parts.join(' ');
        };

        const useTaskDuration = (task) => {
            const [duration, setDuration] = useState(null);

            useEffect(() => {
                let intervalId = null;

                if (task.status === 'inprogress' && task.progressTimestamp) {
                    // Live duration for "In Progress" tasks
                    setDuration(formatLiveDuration(task.progressTimestamp));
                    intervalId = setInterval(() => {
                        setDuration(formatLiveDuration(task.progressTimestamp));
                    }, 1000);

                } else if (task.status === 'auditing' && task.progressTimestamp && task.workCompletedTimestamp) {
                    // Fixed duration for "Auditing" tasks based on start and completion time
                    const durationText = formatFixedDuration(
                        task.progressTimestamp.seconds,
                        task.workCompletedTimestamp.seconds
                    );
                    setDuration(durationText);

                } else {
                    // For all other cases, there is no duration to display
                    setDuration(null);
                }

                return () => {
                    if (intervalId) clearInterval(intervalId);
                };
            }, [task.status, task.progressTimestamp, task.workCompletedTimestamp]);

            return duration;
        };
        
        const formatFullDateTime = (timestamp) => {
            if (!timestamp) return 'No date specified';
            
            let date;
            if (typeof timestamp === 'string') {
                // Handle ISO string from date/time picker in modal
                date = new Date(timestamp.includes('T') ? timestamp : `${timestamp}T00:00:00Z`);
            } else if (timestamp.seconds) {
                // Handle Firestore timestamp object from server
                date = new Date(timestamp.seconds * 1000);
            } else {
                return 'Invalid Date Format';
            }

            if (isNaN(date)) return 'Invalid Date';
            return date.toLocaleString('en-AU', { dateStyle: 'short', timeStyle: 'short', hour12: true }).replace(',', '');
        };


        // --- Main App Structure ---
        const App = () => {
            const { user, isAuthReady, isLoadingPermissions } = useAuth();

            if (!isAuthReady) {
                return React.createElement(LoadingSpinner, { text: "Authenticating..." });
            }
            if (!user) {
                return React.createElement(Login);
            }
            if (isLoadingPermissions) {
                return React.createElement(LoadingSpinner, { text: "Loading User Data..." });
            }
            return React.createElement(MainApp);
        };
        
        const MainApp = () => {
            const { permissions } = useAuth();
            const [page, setPage] = useState('');
            const [isModalOpen, setIsModalOpen] = useState(false);
            const [editingItem, setEditingItem] = useState(null);
            const [modalContext, setModalContext] = useState('task');
            const [isSidebarOpen, setIsSidebarOpen] = useState(false);
            
            useEffect(() => {
                if (permissions.length > 0 && !page) {
                    setPage(permissions[0]);
                }
            }, [permissions, page]);

            const openModal = useCallback((item = null, context = 'task') => {
                setEditingItem(item);
                setModalContext(context);
                setIsModalOpen(true);
            }, []);
            
            const closeModal = useCallback(() => {
                setIsModalOpen(false);
                setEditingItem(null);
            }, []);

            const toggleSidebar = useCallback(() => setIsSidebarOpen(o => !o), []);

            return React.createElement(React.Fragment, null,
                React.createElement(MemoAlert, null),
                React.createElement(Sidebar, { currentPage: page, setPage, isOpen: isSidebarOpen, setIsOpen: setIsSidebarOpen }),
                React.createElement("div", { className: "flex flex-col min-h-screen lg:pl-64" },
                    React.createElement(TopHeader, { openModal, toggleSidebar }),
                    React.createElement("main", { className: "flex-grow p-4 sm:p-6 lg:p-8" },
                        React.createElement(PageRenderer, { page, permissions, openModal })
                    )
                ),
                isModalOpen && React.createElement(TaskModal, { itemToEdit: editingItem, context: modalContext, onClose: closeModal })
            );
        };

        const PageRenderer = React.memo(({ page, permissions, openModal }) => {
            if (permissions.length === 0) {
                 return React.createElement("div", { className: "text-center p-8" }, 
                    React.createElement("h1", { className: "text-2xl font-bold text-yellow-500" }, "No Permissions"),
                    React.createElement("p", { className: "text-slate-400 mt-2" }, "Your account does not have any pages assigned. Please contact an administrator.")
                );
            }
            if (!page) return React.createElement(LoadingSpinner, { text: "Loading Page..." });
            if (!permissions.includes(page)) {
                return React.createElement("div", { className: "text-center p-8" }, 
                    React.createElement("h1", { className: "text-2xl font-bold text-red-500" }, "Access Denied"),
                    React.createElement("p", { className: "text-slate-400 mt-2" }, "You do not have permission to view this page.")
                );
            }
            switch (page) {
                case 'dashboard': return React.createElement(DashboardPage);
                case 'board': return React.createElement(BoardPage, { openModal });
                case 'settings': return React.createElement(SettingsPage);
                default: return null;
            }
        });

        // --- Core UI Components ---
        const Sidebar = ({ currentPage, setPage, isOpen, setIsOpen }) => {
            const { user, permissions, userName, userRole } = useAuth();
            const navItems = useMemo(() => [
                { id: 'dashboard', label: 'Dashboard', icon: ICONS.DASHBOARD },
                { id: 'board', label: 'Task Manager', icon: ICONS.BOARD },
                { id: 'settings', label: 'Settings', icon: ICONS.SETTINGS },
            ], []);
            
            const handleSignOut = useCallback(() => {
                signOut(auth).catch(error => console.error("Sign out error", error));
            }, []);

            return React.createElement(React.Fragment, null,
                React.createElement("div", {
                    className: `fixed inset-0 bg-black/60 z-30 lg:hidden transition-opacity duration-300 ${isOpen ? 'opacity-100' : 'opacity-0 pointer-events-none'}`,
                    onClick: () => setIsOpen(false)
                }),
                React.createElement("aside", { 
                    className: `fixed top-0 left-0 h-full w-64 bg-slate-800 border-r border-slate-700/50 flex flex-col p-4 z-40 transition-transform duration-300 ease-in-out lg:translate-x-0 ${isOpen ? 'translate-x-0' : '-translate-x-full'}` 
                },
                    React.createElement("div", { className: "flex items-center mb-8" },
                        React.createElement("div", { className: "w-10 h-10 bg-blue-600 rounded-lg flex items-center justify-center mr-3" }, ICONS.LOGO),
                        React.createElement("h1", { className: "text-xl font-bold text-slate-100" }, "JLW Tracker")
                    ),
                    React.createElement("nav", { className: "flex-grow space-y-2" },
                        navItems
                            .filter(item => permissions.includes(item.id))
                            .map(item => React.createElement(NavLink, { key: item.id, item, currentPage, setPage, setIsOpen }))
                    ),
                    React.createElement("div", { className: "mt-auto" },
                        React.createElement("div", { className: "p-3 bg-slate-700/50 rounded-lg" },
                            React.createElement("p", { className: "text-sm font-medium text-slate-200 truncate" }, userName || user.email),
                            React.createElement("p", { className: "text-xs text-slate-400" }, userRole)
                        ),
                        React.createElement("button", { onClick: handleSignOut, className: "flex items-center w-full px-4 py-3 mt-2 text-sm font-medium rounded-lg text-slate-400 hover:bg-slate-700 hover:text-slate-200" },
                            React.cloneElement(ICONS.LOGOUT, { className: "w-5 h-5 mr-3" }), "Sign Out")
                    )
                )
            );
        };
        
        const NavLink = React.memo(({ item, currentPage, setPage, setIsOpen }) => {
            const isActive = currentPage === item.id;
            const handleClick = useCallback(() => {
                setPage(item.id);
                setIsOpen(false);
            }, [item.id, setPage, setIsOpen]);

            return React.createElement("button", {
                onClick: handleClick,
                className: `flex items-center w-full px-4 py-3 text-sm font-medium rounded-lg transition-colors ${isActive ? 'bg-blue-600 text-white' : 'text-slate-400 hover:bg-slate-700 hover:text-slate-200'}`
            }, React.cloneElement(item.icon, { className: "w-5 h-5 mr-3" }), item.label);
        });
        
        const TopHeader = React.memo(({ openModal, toggleSidebar }) => {
            const isOnline = useOnlineStatus();
            return React.createElement("header", { className: "flex-shrink-0 bg-slate-900/70 backdrop-blur-sm border-b border-slate-700/50 px-4 sm:px-6 lg:px-8 lg:sticky lg:top-0 lg:z-10" },
                React.createElement("div", { className: "flex items-center justify-between h-16" },
                     React.createElement("button", { onClick: toggleSidebar, className: "lg:hidden text-slate-400 hover:text-slate-200 p-2 -ml-2" }, ICONS.MENU),
                     React.createElement("div", { className: "flex-1" }),
                     React.createElement("div", { className: "flex items-center gap-4" },
                        !isOnline && React.createElement("div", { className: "flex items-center gap-2 text-yellow-400 text-sm font-semibold bg-yellow-900/50 px-3 py-1.5 rounded-lg" },
                            ICONS.OFFLINE,
                            React.createElement("span", null, "Offline Mode")
                        ),
                        React.createElement("button", { onClick: () => openModal(), className: "bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-75 transition-transform transform hover:scale-105" }, "+ Add New Task")
                     )
                )
            );
        });

        // --- Pages ---
        const DashboardPage = React.memo(() => {
            const { user, userName } = useAuth();
            const tasks = useFilteredTasks();
            const history = useFilteredHistory();

            const stats = useMemo(() => {
                const now = new Date().toISOString().slice(0, 10);
                const userHistory = history.filter(h => h.userEmail === user.email);
                return {
                    todo: tasks.filter(t => t.status === 'todo').length,
                    inprogress: tasks.filter(t => t.status === 'inprogress').length,
                    auditing: tasks.filter(t => t.status === 'auditing').length,
                    doneToday: userHistory.filter(h => h.completedTimestamp && new Date(h.completedTimestamp.seconds * 1000).toISOString().slice(0, 10) === now).length,
                };
            }, [tasks, history, user.email]);

            const priorityTasks = useMemo(() => tasks.filter(t => t.status === 'todo').slice(0, 5), [tasks]);
            const recentHistory = useMemo(() => history.slice(0, 5), [history]);
            
            return React.createElement("div", { className: "space-y-8" },
                React.createElement("div", null,
                    React.createElement("h1", { className: "text-3xl font-bold text-slate-100" }, `Welcome back, ${userName || user.email.split('@')[0]}!`),
                    React.createElement("p", { className: "text-slate-400 mt-1" }, "Here's a snapshot of your activity.")
                ),
                React.createElement("div", { className: "grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6" },
                    React.createElement(StatCard, { title: "Tasks To Do", value: stats.todo, color: "border-red-500" }),
                    React.createElement(StatCard, { title: "In Progress", value: stats.inprogress, color: "border-yellow-500" }),
                    React.createElement(StatCard, { title: "Pending Audit", value: stats.auditing, color: "border-blue-500" }),
                    React.createElement(StatCard, { title: "Completed Today", value: stats.doneToday, color: "border-green-500" })
                ),
                React.createElement("div", { className: "grid grid-cols-1 lg:grid-cols-2 gap-8" },
                    React.createElement(DashboardList, { title: "Priority Tasks", items: priorityTasks, emptyMessage: "No tasks in 'To Do'. Great job!", renderItem: task => React.createElement(React.Fragment, null, React.createElement("p", { className: "font-medium text-slate-200" }, task.text), React.createElement("p", { className: "text-xs text-slate-400" }, `${task.shopName || 'N/A'} - ${task.staffName || 'N/A'}`)) }),
                    React.createElement(DashboardList, { title: "Recent Activity", items: recentHistory, emptyMessage: "No recent completed tasks.", renderItem: task => React.createElement(React.Fragment, null, React.createElement("p", { className: "font-medium text-slate-200" }, task.text), React.createElement("p", { className: "text-xs text-slate-400" }, `Completed by ${task.staffName || 'N/A'}`)) })
                )
            );
        });

        const StatCard = React.memo(({ title, value, color }) => (
            React.createElement("div", { className: `bg-slate-800 p-6 rounded-xl border-l-4 ${color}` },
                React.createElement("p", { className: "text-sm font-medium text-slate-400" }, title),
                React.createElement("p", { className: "text-3xl font-bold text-slate-100 mt-1" }, value)
            )
        ));

        const DashboardList = React.memo(({ title, items, emptyMessage, renderItem }) => (
            React.createElement("div", { className: "bg-slate-800 p-6 rounded-xl" },
                React.createElement("h2", { className: "text-xl font-semibold text-slate-100 mb-4" }, title),
                React.createElement("div", { className: "space-y-3" },
                    items.length > 0
                        ? items.map(item => React.createElement("div", { key: item.id, className: "bg-slate-700 p-3 rounded-lg" }, renderItem(item)))
                        : React.createElement("p", { className: "text-slate-400" }, emptyMessage)
                )
            )
        ));

        const BoardPage = React.memo(({ openModal }) => {
            const tasks = useFilteredTasks();
            const history = useFilteredHistory();
            const { isAdmin, userRole, userName } = useAuth();
            const [processingTaskIds, setProcessingTaskIds] = useState(() => new Set());
            
            const handleMoveTask = useCallback(async (taskToMove, newStatus) => {
                if (!taskToMove?.uid || processingTaskIds.has(taskToMove.id)) return;

                setProcessingTaskIds(prev => new Set(prev).add(taskToMove.id));
                
                const taskRef = doc(db, CONSTANTS.COLLECTIONS.USERS, taskToMove.uid, CONSTANTS.COLLECTIONS.TASKS, taskToMove.id);
                
                try {
                    if (newStatus === 'done') {
                        if (isAdmin) {
                            const { id, ...taskData } = taskToMove;
                            await addDoc(collection(db, CONSTANTS.COLLECTIONS.USERS, taskToMove.uid, CONSTANTS.COLLECTIONS.HISTORY), { 
                                ...taskData, status: 'done', completedTimestamp: serverTimestamp() 
                            });
                            await deleteDoc(taskRef);
                            if (window.confetti) confetti({ particleCount: 150, spread: 90, origin: { x: 0.5, y: 0.5 }, gravity: 1.2 });
                        } else {
                            await updateDoc(taskRef, { 
                                status: 'auditing',
                                workCompletedTimestamp: serverTimestamp()
                            });
                        }
                    } else {
                        const updateData = { status: newStatus };
                        if (newStatus === 'inprogress' && !taskToMove.progressTimestamp) {
                            updateData.progressTimestamp = serverTimestamp();
                        }
                        await updateDoc(taskRef, updateData);
                    }
                } catch (error) {
                    console.error("Error moving task: ", error);
                } finally {
                    setProcessingTaskIds(prev => {
                        const newSet = new Set(prev);
                        newSet.delete(taskToMove.id);
                        return newSet;
                    });
                }
            }, [processingTaskIds, isAdmin]);
            
            const handleApproveTask = useCallback(async (taskToApprove) => {
                if (!taskToApprove?.uid || processingTaskIds.has(taskToApprove.id)) return;

                setProcessingTaskIds(prev => new Set(prev).add(taskToApprove.id));
                try {
                    const { id, ...taskData } = taskToApprove;
                    const historyRef = collection(db, CONSTANTS.COLLECTIONS.USERS, taskToApprove.uid, CONSTANTS.COLLECTIONS.HISTORY);
                    
                    await addDoc(historyRef, {
                        ...taskData,
                        status: 'done',
                        completedTimestamp: serverTimestamp(),
                        auditorName: userName,
                        auditorRole: userRole,
                    });
                    
                    const taskRef = doc(db, CONSTANTS.COLLECTIONS.USERS, taskToApprove.uid, CONSTANTS.COLLECTIONS.TASKS, taskToApprove.id);
                    await deleteDoc(taskRef);

                    if (window.confetti) confetti({ particleCount: 150, spread: 90, origin: { x: 0.5, y: 0.5 }, gravity: 1.2 });
                } catch (error) {
                    console.error("Error approving task: ", error);
                } finally {
                     setProcessingTaskIds(prev => {
                        const newSet = new Set(prev);
                        newSet.delete(taskToApprove.id);
                        return newSet;
                    });
                }
            }, [processingTaskIds, userName, userRole]);

            const handleDeleteTask = useCallback(async (task) => {
                if (task?.uid) {
                    await deleteDoc(doc(db, CONSTANTS.COLLECTIONS.USERS, task.uid, CONSTANTS.COLLECTIONS.TASKS, task.id));
                }
            }, []);

            const handleEditTask = useCallback((task) => openModal(task, 'task'), [openModal]);
            const handleEditHistoryItem = useCallback((item) => openModal(item, 'history'), [openModal]);

            const handleDeleteHistoryItem = useCallback(async (item) => {
                if(item?.uid && item?.id) {
                    await deleteDoc(doc(db, CONSTANTS.COLLECTIONS.USERS, item.uid, CONSTANTS.COLLECTIONS.HISTORY, item.id));
                }
            }, []);

            return React.createElement("div", { className: "space-y-8" },
                React.createElement("div", null,
                    React.createElement("h1", { className: "text-3xl font-bold text-slate-100 mb-6" }, "Task Manager"),
                    React.createElement(KanbanBoard, { tasks, onMove: handleMoveTask, onApprove: handleApproveTask, onEdit: handleEditTask, onDelete: handleDeleteTask, processingTaskIds })
                ),
                React.createElement("div", null,
                    React.createElement("h2", { className: "text-2xl font-bold text-slate-100 mb-4" }, "Completed Tasks History"),
                    React.createElement(HistoryView, { history, onEdit: handleEditHistoryItem, onDelete: handleDeleteHistoryItem })
                )
            );
        });
        
        const SettingsPage = React.memo(() => {
            const [activeTab, setActiveTab] = useState('shops');
            const { isAdmin } = useAuth();
            
            return React.createElement("div", { className: "space-y-6" },
                React.createElement("h1", { className: "text-3xl font-bold text-slate-100" }, "Application Settings"),
                 React.createElement("div", { className: "flex flex-wrap gap-2 bg-slate-900 p-1 rounded-lg" },
                     React.createElement(TabButton, { tabName: "shops", title: "Shops", activeTab, setActiveTab }),
                     React.createElement(TabButton, { tabName: "staff", title: "Staff List", activeTab, setActiveTab }),
                     isAdmin && React.createElement(TabButton, { tabName: "memo", title: "Memo Alert", activeTab, setActiveTab })
                 ),
                 React.createElement("div", null,
                    activeTab === 'shops' && React.createElement(ShopSettings),
                    activeTab === 'staff' && React.createElement(StaffSettings),
                    activeTab === 'memo' && isAdmin && React.createElement(MemoSettings)
                 )
            );
        });

        const TabButton = React.memo(({ tabName, title, activeTab, setActiveTab }) => (
            React.createElement("button", {
                onClick: () => setActiveTab(tabName),
                className: `px-3 py-2 text-sm font-medium rounded-md transition-colors duration-200 flex-grow text-center sm:flex-grow-0 ${ activeTab === tabName ? 'bg-blue-600 text-white shadow-md' : 'bg-slate-700 text-slate-300 hover:bg-slate-600' }`
            }, title)
        ));

        // --- Reusable & Core Components ---
        const LoadingSpinner = ({ text = "Loading..." }) => (
            React.createElement("div", { className: "flex flex-col justify-center items-center h-screen text-center p-8 bg-slate-900" },
                React.createElement("svg", { className: "animate-spin h-8 w-8 text-blue-500", xmlns: "http://www.w3.org/2000/svg", fill: "none", viewBox: "0 0 24 24" },
                    React.createElement("circle", { className: "opacity-25", cx: "12", cy: "12", r: "10", stroke: "currentColor", strokeWidth: "4" }),
                    React.createElement("path", { className: "opacity-75", fill: "currentColor", d: "M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z" })
                ),
                React.createElement("p", { className: "text-lg font-semibold text-slate-300 mt-4" }, text)
            )
        );

        const Login = React.memo(() => {
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [rememberMe, setRememberMe] = useState(false);
            const [error, setError] = useState('');
            const [showPassword, setShowPassword] = useState(false);

            const handleLogin = useCallback(async (e) => {
                e.preventDefault();
                setError('');
                try {
                    await setPersistence(auth, rememberMe ? browserLocalPersistence : browserSessionPersistence);
                    await signInWithEmailAndPassword(auth, email, password);
                } catch (err) {
                    const messages = {
                        'auth/invalid-email': 'Please enter a valid email address.',
                        'auth/user-not-found': 'Invalid email or password.',
                        'auth/wrong-password': 'Invalid email or password.',
                        'auth/invalid-credential': 'Invalid email or password.',
                        'auth/too-many-requests': 'Access to this account has been temporarily disabled.'
                    };
                    setError(messages[err.code] || 'An unknown error occurred.');
                }
            }, [email, password, rememberMe]);

            return React.createElement("div", { className: "flex items-center justify-center min-h-screen p-4" },
                React.createElement("div", { className: "w-full max-w-5xl bg-slate-800 rounded-2xl shadow-2xl flex flex-col md:flex-row overflow-hidden" },
                    React.createElement("div", { className: "w-full md:w-1/2 bg-slate-900 p-8 sm:p-12 flex-col justify-center items-center text-white hidden md:flex" },
                        React.createElement("div", { className: "max-w-xs" },
                            React.createElement("svg", { className: "w-full h-auto mb-6", viewBox: "0 0 512 512", fill: "none", xmlns: "http://www.w3.org/2000/svg" }, React.createElement("path", { d: "M368 128H144C126.3 128 112 142.3 112 160V416C112 433.7 126.3 448 144 448H368C385.7 448 400 433.7 400 416V160C400 142.3 385.7 128 368 128ZM256 64C269.8 64 282.8 68.88 292.8 76.8L336.2 109.5C340.6 112.8 346.5 112.5 350.5 108.5L364.5 94.5C368.5 90.5 370.2 84.98 368.8 79.88C359.1 43.8 322.2 16 280 16C222.2 16 176 62.15 176 120V128H208V120C208 84.33 228.3 64 256 64ZM240 248C240 243.6 243.6 240 248 240H328C332.4 240 336 243.6 336 248C336 252.4 332.4 256 328 256H248C243.6 256 240 252.4 240 248ZM248 320H328C332.4 320 336 323.6 336 328C336 332.4 332.4 336 328 336H248C243.6 336 240 332.4 240 328C240 323.6 243.6 320 248 320ZM184 256C193.9 256 201.6 248.4 201.6 238.4C201.6 228.5 193.9 220.8 184 220.8C174.1 220.8 166.4 228.5 166.4 238.4C166.4 248.4 174.1 256 184 256ZM184 336C193.9 336 201.6 328.4 201.6 318.4C201.6 308.5 193.9 300.8 184 300.8C174.1 300.8 166.4 308.5 166.4 318.4C166.4 328.4 174.1 336 184 336Z", fill: "#3b82f6" })),
                            React.createElement("h2", { className: "text-3xl font-bold leading-tight" }, "Streamline Your Workflow"),
                            React.createElement("p", { className: "mt-2 text-slate-300" }, "Manage tasks, track progress, and collaborate with your team efficiently.")
                        )
                    ),
                    React.createElement("div", { className: "w-full md:w-1/2 p-8 sm:p-12 flex flex-col justify-center" },
                        React.createElement("div", { className: "w-full max-w-sm mx-auto" },
                            React.createElement("h2", { className: "text-3xl font-bold text-slate-100" }, "JLW Task Tracker"),
                            React.createElement("p", { className: "mt-2 text-slate-400" }, "Welcome! Please sign in to your account."),
                            React.createElement("p", { className: "mt-4 text-sm font-semibold text-center text-red-400 bg-red-900/50 p-3 rounded-lg" }, "This application is for Internal USE ONLY!"),
                            React.createElement("form", { onSubmit: handleLogin, className: "mt-8 space-y-6" },
                                error && React.createElement("div", { className: "p-3 bg-red-900/50 text-red-400 rounded-md text-sm" }, error),
                                React.createElement("div", null,
                                    React.createElement("label", { htmlFor: "email", className: "block text-sm font-medium text-slate-400" }, "Email address"),
                                    React.createElement("input", { id: "email", name: "email", type: "email", value: email, onChange: (e) => setEmail(e.target.value), required: true, className: "input" })
                                ),
                                React.createElement("div", null,
                                    React.createElement("label", { htmlFor: "password", className: "block text-sm font-medium text-slate-400" }, "Password"),
                                    React.createElement("div", { className: "mt-1 relative" },
                                        React.createElement("input", { id: "password", name: "password", type: showPassword ? "text" : "password", value: password, onChange: (e) => setPassword(e.target.value), required: true, className: "input pr-10" }),
                                        React.createElement("button", { type: "button", onClick: () => setShowPassword(s => !s), className: "absolute inset-y-0 right-0 pr-3 flex items-center text-slate-400 hover:text-slate-200" },
                                            showPassword ? React.createElement("svg", { xmlns: "http://www.w3.org/2000/svg", className: "h-5 w-5", viewBox: "0 0 20 20", fill: "currentColor" }, React.createElement("path", { fillRule: "evenodd", d: "M3.707 2.293a1 1 0 00-1.414 1.414l14 14a1 1 0 001.414-1.414l-1.473-1.473A10.014 10.014 0 0019.542 10C18.268 5.943 14.478 3 10 3a9.958 9.958 0 00-4.512 1.074L3.707 2.293zM10 12a2 2 0 100-4 2 2 0 000 4z", clipRule: "evenodd" }), React.createElement("path", { d: "M2 10s.939-1.761 2.63-3.262A10.034 10.034 0 0110 5c1.29 0 2.522.342 3.638.95-1.595.68-2.89 1.93-3.638 3.462A9.948 9.948 0 012 10z" }))
                                                       : React.createElement("svg", { xmlns: "http://www.w3.org/2000/svg", className: "h-5 w-5", viewBox: "0 0 20 20", fill: "currentColor" }, React.createElement("path", { d: "M10 12a2 2 0 100-4 2 2 0 000 4z" }), React.createElement("path", { fillRule: "evenodd", d: "M.458 10C1.732 5.943 5.522 3 10 3s8.268 2.943 9.542 7c-1.274 4.057-5.022 7-9.542 7S1.732 14.057.458 10zM14 10a4 4 0 11-8 0 4 4 0 018 0z", clipRule: "evenodd" }))
                                        )
                                    )
                                ),
                                React.createElement("div", { className: "flex items-center" },
                                    React.createElement("input", { id: "remember-me", name: "remember-me", type: "checkbox", checked: rememberMe, onChange: (e) => setRememberMe(e.target.checked), className: "h-4 w-4 text-blue-600 focus:ring-blue-500 border-slate-600 rounded bg-slate-700" }),
                                    React.createElement("label", { htmlFor: "remember-me", className: "ml-2 block text-sm text-slate-300" }, "Remember me")
                                ),
                                React.createElement("button", { type: "submit", className: "w-full flex justify-center py-3 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500" }, "Sign in")
                            )
                        )
                    )
                )
            );
        });

        const KanbanBoard = React.memo(({ tasks, onMove, onApprove, onEdit, onDelete, processingTaskIds }) => {
            const columns = useMemo(() => [
                { id: 'todo', title: 'To Do', color: 'red-400', tasks: tasks.filter(t => t.status === 'todo') },
                { id: 'inprogress', title: 'In Progress', color: 'yellow-400', tasks: tasks.filter(t => t.status === 'inprogress') },
                { id: 'auditing', title: 'Task Auditing', color: 'blue-400', tasks: tasks.filter(t => t.status === 'auditing') },
            ], [tasks]);

            return React.createElement("div", { id: "kanbanBoard", className: "grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" },
                columns.map(col => React.createElement(KanbanColumn, { key: col.id, ...col, onMove, onApprove, onEdit, onDelete, processingTaskIds }))
            );
        });

        const KanbanColumn = React.memo(({ title, color, tasks, onMove, onApprove, onEdit, onDelete, processingTaskIds }) => (
            React.createElement("div", { className: "bg-slate-800 rounded-xl shadow-md flex flex-col" },
                React.createElement("div", { className: "p-4 border-b border-slate-700" },
                    React.createElement("h2", { className: "text-lg font-semibold text-slate-200 flex items-center" },
                        React.createElement("span", { className: `w-3 h-3 rounded-full bg-${color} mr-3` }),
                        title,
                        React.createElement("span", { className: "ml-2 text-sm font-normal bg-slate-700 text-slate-300 px-2 py-0.5 rounded-full" }, tasks.length)
                    )
                ),
                React.createElement("div", { className: "kanban-column-body p-4 flex-grow min-h-[200px] overflow-y-auto" },
                    tasks.map(task => React.createElement(TaskCard, { key: task.id, task, onEdit, onDelete, onMove, onApprove, processingTaskIds }))
                )
            )
        ));

        const TaskCard = React.memo(({ task, onEdit, onDelete, onMove, onApprove, processingTaskIds }) => {
            const { isAdmin, userRole, userShopId } = useAuth();
            const isProcessing = processingTaskIds.has(task.id);
            const duration = useTaskDuration(task);

            const canApprove = useMemo(() => {
                if (isAdmin && task.creatorRole === 'Shop Manager') return true;
                if (userRole === 'Shop Manager' && task.creatorRole === 'Staff' && userShopId === task.shopId) return true;
                return false;
            }, [isAdmin, userRole, userShopId, task.creatorRole, task.shopId]);

            const MoveButtons = useCallback(() => {
                switch (task.status) {
                    case 'todo':
                        return React.createElement("button", { onClick: () => onMove(task, 'inprogress'), className: "px-3 py-1 text-xs bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 transition-colors", title: "Move to In Progress" }, "In Progress");
                    case 'inprogress':
                        return React.createElement(React.Fragment, null,
                            React.createElement("button", { onClick: () => onMove(task, 'todo'), className: "px-3 py-1 text-xs bg-slate-600 text-slate-200 font-semibold rounded-lg hover:bg-slate-500 transition-colors", title: "Move back to To Do" }, "To Do"),
                            React.createElement("button", { 
                                onClick: () => onMove(task, 'done'), 
                                className: `px-3 py-1 text-xs bg-green-600 text-white font-semibold rounded-lg hover:bg-green-700 transition-colors ${isProcessing ? 'opacity-50 cursor-not-allowed' : ''}`,
                                title: "Complete Task",
                                disabled: isProcessing
                            }, isProcessing ? 'Completing...' : 'Complete')
                        );
                    case 'auditing':
                        return React.createElement(React.Fragment, null,
                            React.createElement("button", { onClick: () => onMove(task, 'inprogress'), className: "px-3 py-1 text-xs bg-yellow-600 text-white font-semibold rounded-lg hover:bg-yellow-700 transition-colors", title: "Send Back to In Progress" }, "Send Back"),
                            canApprove && React.createElement("button", {
                                onClick: () => onApprove(task),
                                className: `px-3 py-1 text-xs bg-green-600 text-white font-semibold rounded-lg hover:bg-green-700 transition-colors ${isProcessing ? 'opacity-50 cursor-not-allowed' : ''}`,
                                disabled: isProcessing
                            }, isProcessing ? 'Approving...' : 'Approve')
                        );
                    default: return null;
                }
            }, [task, onMove, onApprove, isProcessing, canApprove]);

            return React.createElement("div", { className: "task-card bg-slate-700 border border-slate-600 p-4 rounded-lg shadow-sm mb-4 flex flex-col group" },
                React.createElement("div", { className: "flex justify-between items-start" },
                    React.createElement("p", { onClick: () => onEdit(task), className: "text-slate-100 font-semibold flex-grow pr-2 cursor-pointer" }, task.text),
                    React.createElement("button", { onClick: () => onDelete(task), className: "text-slate-500 hover:text-red-500 font-bold text-xl leading-none flex-shrink-0 opacity-0 group-hover:opacity-100 transition-opacity" }, "")
                ),
                React.createElement("div", { className: "mt-3 pt-3 border-t border-slate-600 text-xs text-slate-400 space-y-1.5" },
                    task.taskTimestamp && React.createElement(InfoRow, { icon: '', label: 'Date', value: formatFullDateTime(task.taskTimestamp) }),
                    
                    (task.status === 'inprogress' && duration) && 
                        React.createElement(InfoRow, { icon: '', label: 'Duration', value: duration }),
                    
                    (task.status === 'auditing') && React.createElement(React.Fragment, null,
                        React.createElement(InfoRow, { 
                            icon: '', 
                            label: 'Time Taken', 
                            value: formatFixedDuration(task.progressTimestamp?.seconds, task.workCompletedTimestamp?.seconds)
                        }),
                        React.createElement(InfoRow, { 
                            icon: '', 
                            label: 'Completed At', 
                            value: formatFullDateTime(task.workCompletedTimestamp) 
                        })
                    ),

                    task.staffName && React.createElement(InfoRow, { icon: '', label: 'Staff', value: task.staffName }),
                    task.shopName && React.createElement(InfoRow, { icon: '', label: 'Shop', value: task.shopName })
                ),
                React.createElement("div", { className: "mt-3 pt-3 border-t border-slate-600 flex justify-end space-x-2" }, React.createElement(MoveButtons))
            );
        });
        
        const InfoRow = React.memo(({ icon, label, value }) => (
            React.createElement("div", { className: "flex items-center" },
                React.createElement("span", { className: "mr-2" }, icon),
                React.createElement("p", null, React.createElement("span", { className: "font-medium text-slate-300" }, `${label}: `), value)
            )
        ));

        const HistoryView = React.memo(({ history, onEdit, onDelete }) => {
            const { isAdmin, userRole, userShop, userName, userShopId } = useAuth();
            const [filters, setFilters] = useState({
                shop: (userRole === 'Shop Manager' || userRole === 'Staff') && userShop ? userShop : '',
                staff: userRole === 'Staff' && userName ? userName : '',
                date: '',
                shopManagerOnly: false
            });
            const [currentPage, setCurrentPage] = useState(1);
            
            const { shops, employees } = useData();
            
            const shopOptions = useMemo(() => {
                if (isAdmin) {
                    return [...new Set(shops.map(s => s.name).filter(Boolean))];
                }
                return userShop ? [userShop] : [];
            }, [isAdmin, shops, userShop]);

            const staffOptions = useMemo(() => {
                if (isAdmin) {
                    return [...new Set(employees.map(e => e.name).filter(Boolean))];
                }
                if (userRole === 'Shop Manager') {
                    return employees
                        .filter(e => e.assignedShop === userShopId)
                        .map(e => e.name)
                        .filter(Boolean);
                }
                return userName ? [userName] : [];
            }, [isAdmin, employees, userRole, userShopId, userName]);

            useEffect(() => { setCurrentPage(1); }, [filters]);

            const filteredHistory = useMemo(() => history.filter(task => {
                const shopMatch = !filters.shop || task.shopName === filters.shop;
                const staffMatch = !filters.staff || task.staffName === filters.staff;
                const dateMatch = !filters.date || (task.completedTimestamp && new Date(task.completedTimestamp.seconds * 1000).toISOString().split('T')[0] === filters.date);
                const roleMatch = !filters.shopManagerOnly || task.creatorRole === 'Shop Manager';
                return shopMatch && staffMatch && dateMatch && roleMatch;
            }), [history, filters]);

            const itemsPerPage = 20;
            const totalPages = Math.ceil(filteredHistory.length / itemsPerPage);
            const paginatedHistory = useMemo(() => {
                const startIndex = (currentPage - 1) * itemsPerPage;
                return filteredHistory.slice(startIndex, startIndex + itemsPerPage);
            }, [filteredHistory, currentPage, itemsPerPage]);

            return React.createElement("div", { id: "historySection" },
                React.createElement(HistoryFilters, { filters, setFilters, shopOptions, staffOptions, isAdmin, userRole }),
                React.createElement("div", { className: "bg-slate-800 rounded-xl shadow-md overflow-x-auto" },
                    React.createElement("table", { className: "w-full text-left" },
                        React.createElement(HistoryTableHeader, { isAdmin }),
                        React.createElement("tbody", { className: "divide-y divide-slate-700" },
                            paginatedHistory.length === 0 
                            ? React.createElement("tr", null, React.createElement("td", { colSpan: isAdmin ? "9" : "8", className: "p-4 text-center text-slate-400" }, "No matching completed tasks."))
                            : paginatedHistory.map((task, index) => React.createElement(HistoryTableRow, { key: task.id, task, index: (currentPage - 1) * itemsPerPage + index, isAdmin, onEdit, onDelete }))
                        )
                    )
                ),
                React.createElement(Pagination, { currentPage, totalPages, onPageChange: setCurrentPage, totalResults: filteredHistory.length, itemsPerPage })
            );
        });

        const HistoryFilters = React.memo(({ filters, setFilters, shopOptions, staffOptions, isAdmin, userRole }) => {
            const handleFilterChange = useCallback((e) => {
                const { name, value, type, checked } = e.target;
                setFilters(prev => ({ ...prev, [name]: type === 'checkbox' ? checked : value }));
            }, [setFilters]);
            
            const clearFilters = useCallback(() => {
                const defaultState = { shop: '', staff: '', date: '', shopManagerOnly: false };
                if (userRole === 'Shop Manager' || userRole === 'Staff') {
                    defaultState.shop = filters.shop; // Keep the locked-in shop filter
                }
                if (userRole === 'Staff') {
                    defaultState.staff = filters.staff; // Keep the locked-in staff filter
                }
                setFilters(defaultState);
            }, [setFilters, userRole, filters.shop, filters.staff]);

            const isShopFilterDisabled = userRole === 'Shop Manager' || userRole === 'Staff';
            const isStaffFilterDisabled = userRole === 'Staff';

            return React.createElement("div", { className: "flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4" },
                React.createElement("div", { id: "historyFilters", className: "w-full sm:w-auto flex flex-col sm:flex-row flex-wrap items-center gap-2 sm:gap-4" },
                    React.createElement("select", { name: "shop", value: filters.shop, onChange: handleFilterChange, className: "input w-full sm:w-auto text-sm", disabled: isShopFilterDisabled }, React.createElement("option", { value: "" }, "All Shops"), shopOptions.map(name => React.createElement("option", { key: name, value: name }, name))),
                    React.createElement("select", { name: "staff", value: filters.staff, onChange: handleFilterChange, className: "input w-full sm:w-auto text-sm", disabled: isStaffFilterDisabled }, React.createElement("option", { value: "" }, "All Staff"), staffOptions.map(name => React.createElement("option", { key: name, value: name }, name))),
                    React.createElement("input", { name: "date", type: "date", value: filters.date, onChange: handleFilterChange, className: "input w-full sm:w-auto text-sm" }),
                    isAdmin && React.createElement("div", {className: "flex items-center"}, 
                        React.createElement("input", { id: "shopManagerOnly", name: "shopManagerOnly", type: "checkbox", checked: filters.shopManagerOnly, onChange: handleFilterChange, className: "h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500 bg-slate-600" }),
                        React.createElement("label", { htmlFor: "shopManagerOnly", className: "ml-2 text-sm text-slate-200" }, "Shop Managers Only")
                    ),
                    React.createElement("button", { onClick: clearFilters, className: "w-full sm:w-auto bg-slate-600 text-slate-200 font-semibold py-2 px-4 rounded-lg hover:bg-slate-500 text-sm transition" }, "Clear")
                )
            );
        });
        
        const HistoryTableHeader = React.memo(({ isAdmin }) => (
            React.createElement("thead", { className: "bg-slate-700/50" },
                React.createElement("tr", null,
                    ["No", "Staff Name", "Shop Name", "Task", "Auditor", "Task Duration", "Progress Date", "Completed Date"].map(header => 
                        React.createElement("th", { key: header, scope: "col", className: "px-2 py-3 sm:p-4 text-sm font-semibold text-slate-400" }, header)
                    ),
                    isAdmin && React.createElement("th", { scope: "col", className: "px-2 py-3 sm:p-4 text-sm font-semibold text-slate-400 text-right" }, "Actions")
                )
            )
        ));

        const HistoryTableRow = React.memo(({ task, index, isAdmin, onEdit, onDelete }) => {
            const formatDate = useCallback((timestamp) => {
                if (!timestamp?.seconds) return 'N/A';
                const date = new Date(timestamp.seconds * 1000);
                return date.toLocaleString('en-AU', {
                    day: '2-digit', month: '2-digit', year: '2-digit',
                    hour: '2-digit', minute: '2-digit', hour12: true
                }).replace(',', '');
            }, []);

            return React.createElement("tr", { className: "hover:bg-slate-700" },
                React.createElement("td", { className: "px-2 py-3 sm:p-4" }, index + 1),
                React.createElement("td", { className: "px-2 py-3 sm:p-4" }, task.staffName || 'N/A'),
                React.createElement("td", { className: "px-2 py-3 sm:p-4" }, task.shopName || 'N/A'),
                React.createElement("td", { className: "px-2 py-3 sm:p-4" }, task.text),
                React.createElement("td", { className: "px-2 py-3 sm:p-4" }, task.auditorName || 'Auto-Approved'),
                React.createElement("td", { className: "px-2 py-3 sm:p-4 font-medium" }, formatFixedDuration(task.progressTimestamp?.seconds, task.workCompletedTimestamp?.seconds || task.completedTimestamp?.seconds)),
                React.createElement("td", { className: "px-2 py-3 sm:p-4 text-sm text-slate-400" }, formatDate(task.progressTimestamp)),
                React.createElement("td", { className: "px-2 py-3 sm:p-4 text-sm text-slate-400" }, formatDate(task.completedTimestamp)),
                isAdmin && React.createElement("td", { className: "px-2 py-3 sm:p-4 text-right" },
                    React.createElement("div", { className: "flex items-center justify-end space-x-4" },
                        React.createElement("button", { onClick: () => onEdit(task), className: "text-indigo-400 hover:text-indigo-300", title: "Edit" }, React.createElement("svg", { xmlns: "http://www.w3.org/2000/svg", width: "16", height: "16", viewBox: "0 0 24 24", fill: "none", stroke: "currentColor", strokeWidth: "2", strokeLinecap: "round", strokeLinejoin: "round" }, React.createElement("path", { d: "M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z" }))),
                        React.createElement("button", { onClick: () => onDelete(task), className: "text-red-500 hover:text-red-400", title: "Delete" }, React.createElement("svg", { xmlns: "http://www.w3.org/2000/svg", width: "16", height: "16", viewBox: "0 0 24 24", fill: "none", stroke: "currentColor", strokeWidth: "2", strokeLinecap: "round", strokeLinejoin: "round" }, React.createElement("polyline", { points: "3 6 5 6 21 6" }), React.createElement("path", { d: "M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2" }), React.createElement("line", { x1: "10", y1: "11", x2: "10", y2: "17" }), React.createElement("line", { x1: "14", y1: "11", x2: "14", y2: "17" })))
                    )
                )
            )
        });

        const Pagination = React.memo(({ currentPage, totalPages, onPageChange, totalResults, itemsPerPage }) => {
            if (totalResults === 0) return null;
            
            const startIndex = (currentPage - 1) * itemsPerPage + 1;
            const endIndex = Math.min(startIndex + itemsPerPage - 1, totalResults);

            return React.createElement("div", { className: "mt-4 flex items-center justify-between" },
                React.createElement("span", { className: "text-sm text-slate-400" }, `Showing ${startIndex}-${endIndex} of ${totalResults} results`),
                React.createElement("div", { className: "flex items-center space-x-2" },
                    React.createElement("button", { onClick: () => onPageChange(currentPage - 1), disabled: currentPage === 1, className: "px-4 py-2 text-sm font-medium text-slate-200 bg-slate-700 border border-slate-600 rounded-lg hover:bg-slate-600 disabled:opacity-50 disabled:cursor-not-allowed" }, "Previous"),
                    React.createElement("span", { className: "text-sm text-slate-300 px-2" }, `Page ${currentPage} of ${totalPages}`),
                    React.createElement("button", { onClick: () => onPageChange(currentPage + 1), disabled: currentPage === totalPages, className: "px-4 py-2 text-sm font-medium text-slate-200 bg-slate-700 border border-slate-600 rounded-lg hover:bg-slate-600 disabled:opacity-50 disabled:cursor-not-allowed" }, "Next")
                )
            );
        });
        
        const TaskModal = ({ itemToEdit, context, onClose }) => {
            const { user, userName, userShop, userRole } = useAuth();
            const { shops, employees } = useData();
            const isAdmin = userRole === 'Admin';

            const getInitialDateTime = (timestamp) => {
                const d = timestamp ? new Date(timestamp.seconds ? timestamp.seconds * 1000 : timestamp) : new Date();
                return {
                    date: d.toISOString().split('T')[0],
                    time: d.toTimeString().slice(0, 5)
                };
            };
            
            const getInitialState = useCallback(() => {
                const initialDateTime = getInitialDateTime(itemToEdit?.taskTimestamp);
                return {
                    text: itemToEdit?.text || '',
                    date: initialDateTime.date,
                    time: initialDateTime.time,
                    staffName: itemToEdit?.staffName || (!isAdmin ? userName : ''),
                    shopName: itemToEdit?.shopName || (!isAdmin ? userShop : ''),
                };
            }, [itemToEdit, isAdmin, userName, userShop]);

            const [taskData, setTaskData] = useState(getInitialState);

            const handleChange = useCallback((e) => {
                const { name, value } = e.target;
                setTaskData(prev => ({...prev, [name]: value}));
            }, []);

            const handleSubmit = useCallback(async (e) => {
                e.preventDefault();
                if (!taskData.text.trim()) return;

                const { date, time, ...restOfData } = taskData;
                
                const selectedShop = shops.find(s => s.name === taskData.shopName);

                const dataToSave = {
                    ...restOfData,
                    taskTimestamp: `${date}T${time}`,
                    shopId: selectedShop ? selectedShop.id : null,
                };
                
                try {
                    const isEdit = context === 'task' && itemToEdit?.uid;
                    const isHistoryEdit = context === 'history' && itemToEdit?.uid;

                    if (isHistoryEdit) {
                        await updateDoc(doc(db, CONSTANTS.COLLECTIONS.USERS, itemToEdit.uid, CONSTANTS.COLLECTIONS.HISTORY, itemToEdit.id), dataToSave);
                    } else if (isEdit) {
                        await updateDoc(doc(db, CONSTANTS.COLLECTIONS.USERS, itemToEdit.uid, CONSTANTS.COLLECTIONS.TASKS, itemToEdit.id), dataToSave);
                    } else {
                        await addDoc(collection(db, CONSTANTS.COLLECTIONS.USERS, user.uid, CONSTANTS.COLLECTIONS.TASKS), { 
                            ...dataToSave, status: 'todo', createdAt: serverTimestamp(), 
                            userEmail: user.email, creatorRole: userRole,
                        });
                    }
                    onClose();
                } catch(error) {
                    console.error("Error saving task: ", error);
                }
            }, [taskData, context, itemToEdit, user, userRole, onClose, shops]);

            return React.createElement("div", { className: "modal-overlay", onClick: onClose },
                React.createElement("div", { className: "modal-content", onClick: e => e.stopPropagation() },
                    React.createElement("h2", { className: "text-2xl font-bold mb-6 text-slate-100" }, itemToEdit ? `Edit ${context === 'task' ? 'Task' : 'History'}` : 'Add a New Task'),
                    React.createElement("form", { onSubmit: handleSubmit, className: "space-y-4" },
                        React.createElement("div", { className: "grid grid-cols-2 gap-4"},
                            React.createElement("div", null, React.createElement("label", { htmlFor: "date", className: "block text-sm font-medium text-slate-400 mb-1" }, "Date"), React.createElement("input", { name: "date", type: "date", id: "date", value: taskData.date, onChange: handleChange, className: "input", required: true })),
                            React.createElement("div", null, React.createElement("label", { htmlFor: "time", className: "block text-sm font-medium text-slate-400 mb-1" }, "Time"), React.createElement("input", { name: "time", type: "time", id: "time", value: taskData.time, onChange: handleChange, className: "input", required: true }))
                        ),
                        React.createElement("div", null,
                            React.createElement("label", { htmlFor: "shopName", className: "block text-sm font-medium text-slate-400 mb-1" }, "Shop Name"),
                            isAdmin ? React.createElement("select", { name: "shopName", id: "shopName", value: taskData.shopName, onChange: handleChange, className: "input" }, React.createElement("option", { value: "" }, "Select Shop"), shops.map(s => React.createElement("option", { key: s.id, value: s.name }, s.name)))
                                      : React.createElement("input", { name: "shopName", type: "text", id: "shopName", value: taskData.shopName, className: "input bg-slate-700 cursor-not-allowed", disabled: true })
                        ),
                         React.createElement("div", null,
                            React.createElement("label", { htmlFor: "staffName", className: "block text-sm font-medium text-slate-400 mb-1" }, "Staff Name"),
                            isAdmin ? React.createElement("select", { name: "staffName", id: "staffName", value: taskData.staffName, onChange: handleChange, className: "input" }, React.createElement("option", { value: "" }, "Select Staff"), employees.map(e => React.createElement("option", { key: e.id, value: e.name }, e.name)))
                                      : React.createElement("input", { name: "staffName", type: "text", id: "staffName", value: taskData.staffName, className: "input bg-slate-700 cursor-not-allowed", disabled: true })
                        ),
                        React.createElement("div", null,
                            React.createElement("label", { htmlFor: "text", className: "block text-sm font-medium text-slate-400 mb-1" }, "Task Description"),
                            React.createElement("textarea", { name: "text", id: "text", value: taskData.text, onChange: handleChange, className: "input", rows: "3", placeholder: "Enter task description...", required: true })
                        ),
                        React.createElement("div", { className: "mt-6 flex justify-end space-x-4" },
                            React.createElement("button", { type: "button", onClick: onClose, className: "bg-slate-600 text-slate-200 font-semibold py-2 px-4 rounded-lg hover:bg-slate-500 transition" }, "Cancel"),
                            React.createElement("button", { type: "submit", className: "bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-700 transition" }, "Save Task")
                        )
                    )
                )
            );
        };
        
        const SettingsCRUD = ({ title, collectionName, items, formFields, listColumns }) => {
            const [editingItem, setEditingItem] = useState(null);
            const [searchTerm, setSearchTerm] = useState('');
            
            const getInitialState = useCallback(() => formFields.reduce((acc, field) => ({ ...acc, [field.name]: (field.type === 'checkbox-group') ? [] : '' }), {}), [formFields]);
            const [newItem, setNewItem] = useState(getInitialState);
            
            const filteredItems = useMemo(() => {
                if (!searchTerm) return items;
                return items.filter(item =>
                    Object.values(item).some(val => String(val).toLowerCase().includes(searchTerm.toLowerCase()))
                );
            }, [items, searchTerm]);

            const handleSave = useCallback(async (item) => {
                try {
                    const { id, ...data } = item;
                    if (id) {
                        await updateDoc(doc(db, collectionName, id), data);
                    } else {
                        await addDoc(collection(db, collectionName), data);
                    }
                    setEditingItem(null);
                    setNewItem(getInitialState());
                } catch (e) { console.error(`Error saving ${title}:`, e); }
            }, [collectionName, getInitialState, title]);
            
            const handleDelete = useCallback(async (id) => {
                try {
                    await deleteDoc(doc(db, collectionName, id)); 
                } catch (e) { console.error(`Error deleting ${title}:`, e); }
            }, [collectionName, title]);
            
            return (
                React.createElement("div", { className: "bg-slate-800 p-4 sm:p-6 rounded-lg shadow-md" },
                    React.createElement("h2", { className: "text-2xl font-semibold mb-4 text-slate-100" }, `${title} Management`),
                    React.createElement(SettingsForm, { item: newItem, setItem: setNewItem, onSave: handleSave, formFields, title, isNew: true }),
                    React.createElement("div", { className: "mb-4" },
                        React.createElement("input", { type: "text", placeholder: `Search ${title}...`, value: searchTerm, onChange: (e) => setSearchTerm(e.target.value), className: "input w-full max-w-xs" })
                    ),
                    React.createElement("div", { className: "overflow-x-auto" },
                        React.createElement("table", { className: "min-w-full divide-y divide-slate-700" },
                            React.createElement("thead", { className: "bg-slate-700/50" }, React.createElement("tr", null, listColumns.map(col => React.createElement("th", { scope: "col", key: col.header, className: "px-6 py-3 text-left text-xs font-medium text-slate-400 uppercase tracking-wider" }, col.header)), React.createElement("th", { scope: "col", className: "px-6 py-3 text-right text-xs font-medium text-slate-400 uppercase tracking-wider" }, "Actions"))),
                            React.createElement("tbody", { className: "divide-y divide-slate-700" },
                                filteredItems.map(item => (
                                    editingItem?.id === item.id 
                                    ? React.createElement("tr", { key: item.id }, React.createElement("td", { colSpan: listColumns.length + 1, className: "p-0" }, React.createElement(SettingsForm, { item: editingItem, setItem: setEditingItem, onSave: handleSave, onCancel: () => setEditingItem(null), formFields, title, isNew: false })))
                                    : React.createElement(SettingsTableRow, { key: item.id, item, listColumns, onEdit: () => setEditingItem({ ...item }), onDelete: () => handleDelete(item.id) })
                                ))
                            )
                        )
                    )
                )
            );
        }

        const SettingsForm = React.memo(({ item, setItem, onSave, onCancel, formFields, title, isNew }) => {
            const handleInputChange = useCallback((e) => {
                const { name, type, value, checked } = e.target;
                setItem(prev => {
                    if (type === 'checkbox') {
                        const currentValues = prev[name] || [];
                        return { ...prev, [name]: checked ? [...currentValues, value] : currentValues.filter(val => val !== value) };
                    }
                    return { ...prev, [name]: value };
                });
            }, [setItem]);

            const handleSubmit = useCallback((e) => {
                e.preventDefault();
                onSave(item);
            }, [item, onSave]);

            return React.createElement("form", { onSubmit: handleSubmit, className: "grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 items-end p-4 bg-slate-700/50 rounded-lg mb-6" },
                formFields.map(field => React.createElement(FormField, { key: field.name, field, value: item[field.name], onChange: handleInputChange })),
                React.createElement("div", { className: "flex space-x-2" },
                    React.createElement("button", { type: "submit", className: "w-full bg-blue-600 text-white px-4 py-2 rounded-lg shadow hover:bg-blue-700 transition-colors" }, isNew ? `Add ${title}` : 'Save'),
                    !isNew && React.createElement("button", { type: "button", onClick: onCancel, className: "w-full bg-slate-600 text-slate-200 px-4 py-2 rounded-lg hover:bg-slate-500" }, "Cancel")
                )
            );
        });

        const FormField = React.memo(({ field, value, onChange }) => (
            React.createElement("div", { className: field.fullWidth ? 'md:col-span-2 lg:col-span-3' : '' },
                React.createElement("label", { className: "block text-sm font-medium text-slate-400", htmlFor: field.name }, field.label),
                field.type === 'select' ? (
                    React.createElement("select", { name: field.name, id: field.name, value: value || '', onChange: onChange, className: "input", required: field.required },
                        React.createElement("option", { value: "" }, field.placeholder),
                        field.options.map(opt => React.createElement("option", { key: opt.id, value: opt.id }, opt.name))
                    )
                ) : field.type === 'checkbox-group' ? (
                    React.createElement("div", { className: "checkbox-group" },
                        field.options.map(opt => (
                            React.createElement("div", { key: opt.id, className: "flex items-center" },
                                React.createElement("input", { id: `${field.name}-${opt.id}`, name: field.name, type: "checkbox", value: opt.id, checked: (value || []).includes(opt.id), onChange: onChange, className: "h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500 bg-slate-600" }),
                                React.createElement("label", { htmlFor: `${field.name}-${opt.id}`, className: "ml-2 block text-sm text-slate-200" }, opt.name)
                            )
                        ))
                    )
                ) : (
                    React.createElement("input", { type: field.type || 'text', name: field.name, id: field.name, value: value || '', onChange: onChange, className: "input", required: field.required })
                )
            )
        ));

        const SettingsTableRow = React.memo(({ item, listColumns, onEdit, onDelete }) => (
             React.createElement("tr", null,
                listColumns.map(col => React.createElement("td", { key: col.accessor, className: "px-6 py-4 whitespace-nowrap text-sm text-slate-300" }, col.render ? col.render(item) : item[col.accessor])),
                React.createElement("td", { className: "px-6 py-4 whitespace-nowrap text-right text-sm font-medium" },
                    React.createElement("button", { onClick: onEdit, className: "text-indigo-400 hover:text-indigo-300 mr-4" }, "Edit"),
                    React.createElement("button", { onClick: onDelete, className: "text-red-500 hover:text-red-400" }, "Delete")
                )
            )
        ));
        
        const ShopSettings = () => {
            const { shops } = useData();
            const shopConfig = useMemo(() => ({
                formFields: [ { name: 'name', label: 'Shop Name', required: true }, { name: 'contact', label: 'Contact' }, { name: 'address', label: 'Address', fullWidth: true } ],
                listColumns: [ { header: 'Shop Name', accessor: 'name' }, { header: 'Contact', accessor: 'contact' }, { header: 'Address', accessor: 'address' } ]
            }), []);
            return React.createElement(SettingsCRUD, { title: "Shop", collectionName: CONSTANTS.COLLECTIONS.SHOPS, items: shops, ...shopConfig });
        };
        
        const StaffSettings = () => {
            const { shops, employees } = useData();
            const { isAdmin } = useAuth();
            const staffConfig = useMemo(() => {
                const formFields = [
                    { name: 'name', label: 'Staff Name', required: true },
                    { name: 'email', label: 'Staff Email (for login)', type: 'email', required: true },
                    { name: 'role', label: 'Role', type: 'select', options: [{id: 'Shop Manager', name: 'Shop Manager'}, {id: 'Staff', name: 'Staff'}], placeholder: 'Select a Role', required: true },
                    { name: 'assignedShop', label: 'Assigned Shop', type: 'select', options: shops, placeholder: 'Select Shop' },
                ];

                if (isAdmin) {
                    formFields.push({ name: 'pagePermissions', label: 'Page Permissions', type: 'checkbox-group', options: [{ id: 'dashboard', name: 'Dashboard' }, { id: 'board', name: 'Task Manager' }, { id: 'settings', name: 'Settings' }], fullWidth: true });
                }

                return {
                    formFields,
                    listColumns: [
                        { header: 'Staff Name', accessor: 'name' }, { header: 'Email', accessor: 'email' }, { header: 'Role', accessor: 'role' },
                        { header: 'Assigned Shop', accessor: 'assignedShop', render: (item) => shops.find(s => s.id === item.assignedShop)?.name || 'N/A' },
                        { header: 'Page Permissions', accessor: 'pagePermissions', render: (item) => (item.pagePermissions || []).join(', ') || 'None' }
                    ]
                }
            }, [shops, isAdmin]);
            return React.createElement(SettingsCRUD, { title: "Staff", collectionName: CONSTANTS.COLLECTIONS.EMPLOYEES, items: employees, ...staffConfig });
        };

        const MemoSettings = () => {
            const { memo } = useData();
            const [message, setMessage] = useState('');
            const [targetRole, setTargetRole] = useState('none');
            const [status, setStatus] = useState('');

            useEffect(() => {
                if (memo) {
                    setMessage(memo.message || '');
                    setTargetRole(memo.targetRole || 'none');
                }
            }, [memo]);

            const handleSaveMemo = useCallback(async (e) => {
                e.preventDefault();
                setStatus('Saving...');
                try {
                    await setDoc(doc(db, CONSTANTS.COLLECTIONS.SETTINGS, 'memo'), { message, isActive: targetRole !== 'none', targetRole });
                    setStatus('Memo saved successfully!');
                } catch (error) {
                    console.error("Error saving memo:", error);
                    setStatus('Error saving memo.');
                }
                setTimeout(() => setStatus(''), 3000);
            }, [message, targetRole]);

            const handleRadioChange = useCallback((e) => setTargetRole(e.target.value), []);

            return (
                React.createElement("div", { className: "bg-slate-800 p-4 sm:p-6 rounded-lg shadow-md" },
                    React.createElement("h2", { className: "text-2xl font-semibold mb-4 text-slate-100" }, "Memo Alert Management"),
                    React.createElement("form", { onSubmit: handleSaveMemo, className: "space-y-4" },
                        React.createElement("div", null,
                            React.createElement("label", { htmlFor: "memoMessage", className: "block text-sm font-medium text-slate-400" }, "Memo Message"),
                            React.createElement("textarea", { id: "memoMessage", value: message, onChange: (e) => setMessage(e.target.value), className: "input", rows: "4", placeholder: "Enter the memo..." })
                        ),
                        React.createElement("fieldset", { className: "flex items-center space-x-6" },
                            React.createElement(RadioOption, { id: "memoTargetAll", name: "memoTarget", value: "all", label: "Activate for All", checked: targetRole === 'all', onChange: handleRadioChange }),
                            React.createElement(RadioOption, { id: "memoTargetShopManager", name: "memoTarget", value: "shopManager", label: "Shop Managers Only", checked: targetRole === 'shopManager', onChange: handleRadioChange }),
                            React.createElement(RadioOption, { id: "memoTargetNone", name: "memoTarget", value: "none", label: "Deactivate", checked: targetRole === 'none', onChange: handleRadioChange })
                        ),
                        React.createElement("div", { className: "flex items-center gap-4" },
                            React.createElement("button", { type: "submit", className: "bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-700 transition" }, "Save Memo"),
                            status && React.createElement("p", { className: "text-sm text-green-400" }, status)
                        )
                    )
                )
            );
        };
        
        const RadioOption = React.memo(({ id, name, value, label, checked, onChange }) => (
            React.createElement("div", { className: "flex items-center" }, 
                React.createElement("input", { id, type: "radio", name, value, checked, onChange, className: "h-4 w-4 text-blue-600 border-gray-300 focus:ring-blue-500 bg-slate-600" }),
                React.createElement("label", { htmlFor: id, className: "ml-2 block text-sm text-slate-200" }, label)
            )
        ));

        const MemoAlert = () => {
            const { memo } = useData();
            const { isAdmin, userRole } = useAuth();
            const [showMemoAlert, setShowMemoAlert] = useState(false);
            
            useEffect(() => {
                const memoDismissed = sessionStorage.getItem('memoDismissed');
                if (memo?.isActive && memo.message && !isAdmin && memoDismissed !== memo.message) {
                    const showToAll = memo.targetRole === 'all';
                    const showToShopManager = memo.targetRole === 'shopManager' && userRole === 'Shop Manager';
                    
                    if (showToAll || showToShopManager) setShowMemoAlert(true);
                }
            }, [memo, isAdmin, userRole]);

            const handleDismissMemo = useCallback(() => {
                sessionStorage.setItem('memoDismissed', memo.message);
                setShowMemoAlert(false);
            }, [memo?.message]);
            
            if(!showMemoAlert) return null;

            return (
                React.createElement("div", { className: "modal-overlay" },
                    React.createElement("div", { className: "modal-content" },
                        React.createElement("h2", { className: "text-2xl font-bold mb-4 text-slate-100" }, "Important Memo"),
                        React.createElement("p", { className: "text-slate-300 mb-6 whitespace-pre-wrap" }, memo.message),
                        React.createElement("div", { className: "flex justify-end" },
                            React.createElement("button", { onClick: handleDismissMemo, className: "bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-700 transition" }, "Dismiss")
                        )
                    )
                )
            );
        };

        // --- App Initialization ---
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(
            React.createElement(AuthProvider, null, 
                React.createElement(DataProvider, null,
                    React.createElement(App)
                )
            )
        );
    </script>
</body>
</html>






