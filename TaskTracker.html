<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>JLW Task Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        html, body { overflow-x: hidden; }
        body { 
            font-family: 'Inter', sans-serif; 
            -webkit-font-smoothing: antialiased; 
            -moz-osx-font-smoothing: grayscale;
        }
        .task-card { transition: background-color 0.2s ease-in-out, box-shadow 0.2s ease-in-out; }
        .kanban-column-body::-webkit-scrollbar, .checkbox-group::-webkit-scrollbar, .chat-messages::-webkit-scrollbar, .user-list::-webkit-scrollbar { width: 8px; }
        .kanban-column-body::-webkit-scrollbar-track, .checkbox-group::-webkit-scrollbar-track, .chat-messages::-webkit-scrollbar-track, .user-list::-webkit-scrollbar-track { background: #1e293b; border-radius: 10px; }
        .kanban-column-body::-webkit-scrollbar-thumb, .checkbox-group::-webkit-scrollbar-thumb, .chat-messages::-webkit-scrollbar-thumb, .user-list::-webkit-scrollbar-thumb { background: #475569; border-radius: 10px; }
        .kanban-column-body::-webkit-scrollbar-thumb:hover, .checkbox-group::-webkit-scrollbar-thumb:hover, .chat-messages::-webkit-scrollbar-thumb:hover, .user-list::-webkit-scrollbar-thumb:hover { background: #64748b; }
        .modal-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex; justify-content: center; align-items: center;
            z-index: 50; padding: 1rem;
        }
        .modal-content {
            background-color: #1e293b; padding: 1.5rem; border-radius: 0.5rem;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1); width: 100%; max-width: 500px;
        }
        .input {
            margin-top: 0.25rem; display: block; width: 100%;
            padding: 0.75rem; border-width: 1px; border-color: #475569;
            border-radius: 0.375rem; box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            transition: border-color 0.2s, box-shadow 0.2s;
            background-color: #334155; color: #e2e8f0;
        }
        .input:focus {
            outline: 2px solid transparent; outline-offset: 2px;
            border-color: #3B82F6; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.3);
        }
        .input:disabled {
            background-color: #475569;
            cursor: not-allowed;
            opacity: 0.7;
        }
        .checkbox-group {
            max-height: 150px; overflow-y: auto; border: 1px solid #475569;
            border-radius: 0.375rem; padding: 0.75rem; margin-top: 0.25rem;
            background-color: #334155;
        }
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        .notification {
            animation: slideIn 0.5s ease-out forwards;
        }
    </style>
</head>
<body class="bg-slate-900 text-slate-300">
    <div id="root"></div>

    <script type="module">
        // --- React & Firebase Imports ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, setPersistence, browserSessionPersistence, browserLocalPersistence, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, getDocs, addDoc, doc, getDoc, updateDoc, deleteDoc, onSnapshot, serverTimestamp, query, where, collectionGroup, enableIndexedDbPersistence, setDoc, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-analytics.js";
        import React, { useState, useEffect, useRef, createContext, useContext, useMemo, useCallback } from "https://esm.sh/react@18.2.0";
        import ReactDOM from "https://esm.sh/react-dom@18.2.0/client";

        // --- Firebase Configuration ---
        const firebaseConfig = {
            apiKey: "AIzaSyBPiC3IdyJ5VE5h3XKXJNxr91XrB92m6x8",
            authDomain: "task-tracker-7c8dd.firebaseapp.com",
            projectId: "task-tracker-7c8dd",
            storageBucket: "task-tracker-7c8dd.firebasestorage.app",
            messagingSenderId: "85579699406",
            appId: "1:855796994906:web:ba0cee4e243685e9b45963",
            measurementId: "G-SY5JTKKFC5"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        // --- Offline Persistence & Caching --- 
        enableIndexedDbPersistence(db).catch((err) => {
            if (err.code == 'failed-precondition') console.warn('Firestore persistence failed: Multiple tabs open.');
            else if (err.code == 'unimplemented') console.warn('Firestore persistence failed: Browser not supported.');
        });

        // --- Constants ---
        const COLLECTIONS = {
            SHOPS: 'shops', EMPLOYEES: 'employees', USERS: 'users',
            TASKS: 'tasks', HISTORY: 'history', SETTINGS: 'settings',
            USER_SETTINGS: 'userSettings'
        };
        const ADMIN_EMAIL = 'jlw@jlw.com';
        const ROLES = { ADMIN: 'Admin', SHOP_MANAGER: 'Shop Manager', STAFF: 'Staff' };
        const KANBAN_STATUS = { TODO: 'todo', IN_PROGRESS: 'inprogress', AUDITING: 'auditing', DONE: 'done' };

        const ICONS = {
            DASHBOARD: React.createElement("svg", { "xmlns": "http://www.w3.org/2000/svg", "width": "24", "height": "24", "viewBox": "0 0 24 24", "fill": "none", "stroke": "currentColor", "strokeWidth": "2", "strokeLinecap": "round", "strokeLinejoin": "round" }, React.createElement("rect", { "x": "3", "y": "3", "width": "7", "height": "7" }), React.createElement("rect", { "x": "14", "y": "3", "width": "7", "height": "7" }), React.createElement("rect", { "x": "14", "y": "14", "width": "7", "height": "7" }), React.createElement("rect", { "x": "3", "y": "14", "width": "7", "height": "7" })),
            BOARD: React.createElement("svg", { "xmlns": "http://www.w3.org/2000/svg", "width": "24", "height": "24", "viewBox": "0 0 24 24", "fill": "none", "stroke": "currentColor", "strokeWidth": "2", "strokeLinecap": "round", "strokeLinejoin": "round" }, React.createElement("rect", { "x": "3", "y": "3", "width": "18", "height": "18", "rx": "2", "ry": "2" }), React.createElement("line", { "x1": "9", "y1": "3", "x2": "9", "y2": "21" }), React.createElement("line", { "x1": "15", "y1": "3", "x2": "15", "y2": "21" })),
            REPORTS: React.createElement("svg", { "xmlns": "http://www.w3.org/2000/svg", "width": "24", "height": "24", "viewBox": "0 0 24 24", "fill": "none", "stroke": "currentColor", "strokeWidth": "2", "strokeLinecap": "round", "strokeLinejoin": "round" }, React.createElement("path", { "d": "M12 20V10" }), React.createElement("path", { "d": "M18 20V4" }), React.createElement("path", { "d": "M6 20V16" })),
            SETTINGS: React.createElement("svg", { "xmlns": "http://www.w3.org/2000/svg", "width": "24", "height": "24", "viewBox": "0 0 24 24", "fill": "none", "stroke": "currentColor", "strokeWidth": "2", "strokeLinecap": "round", "strokeLinejoin": "round" }, React.createElement("path", { "d": "M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 0 2l-.15.08a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l-.22-.38a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1 0-2l.15-.08a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z" }), React.createElement("circle", { "cx": "12", "cy": "12", "r": "3" })),
            LOGOUT: React.createElement("svg", { "xmlns": "http://www.w3.org/2000/svg", "width": "24", "height": "24", "viewBox": "0 0 24 24", "fill": "none", "stroke": "currentColor", "strokeWidth": "2", "strokeLinecap": "round", "strokeLinejoin": "round" }, React.createElement("path", { "d": "M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4" }), React.createElement("polyline", { "points": "16 17 21 12 16 7" }), React.createElement("line", { "x1": "21", "y1": "12", "x2": "9", "y2": "12" })),
            MENU: React.createElement("svg", { "xmlns": "http://www.w3.org/2000/svg", "width": "24", "height": "24", "viewBox": "0 0 24 24", "fill": "none", "stroke": "currentColor", "strokeWidth": "2", "strokeLinecap": "round", "strokeLinejoin": "round" }, React.createElement("line", { "x1": "3", "y1": "12", "x2": "21", "y2": "12" }), React.createElement("line", { "x1": "3", "y1": "6", "x2": "21", "y2": "6" }), React.createElement("line", { "x1": "3", "y1": "18", "x2": "21", "y2": "18" })),
            LOGO: React.createElement("svg", { className: "w-6 h-6 text-white", viewBox: "0 0 512 512", fill: "currentColor" }, React.createElement("path", { d: "M368 128H144C126.3 128 112 142.3 112 160V416C112 433.7 126.3 448 144 448H368C385.7 448 400 433.7 400 416V160C400 142.3 385.7 128 368 128ZM256 64C269.8 64 282.8 68.88 292.8 76.8L336.2 109.5C340.6 112.8 346.5 112.5 350.5 108.5L364.5 94.5C368.5 90.5 370.2 84.98 368.8 79.88C359.1 43.8 322.2 16 280 16C222.2 16 176 62.15 176 120V128H208V120C208 84.33 228.3 64 256 64Z" })),
            OFFLINE: React.createElement("svg", { "xmlns": "http://www.w3.org/2000/svg", "width": "16", "height": "16", "viewBox": "0 0 24 24", "fill": "none", "stroke": "currentColor", "strokeWidth": "2", "strokeLinecap": "round", "strokeLinejoin": "round" }, React.createElement("line", { "x1": "2", "x2": "22", "y1": "2", "y2": "22" }), React.createElement("path", { "d": "M8.5 16.5a5 5 0 0 1 7 0" }), React.createElement("path", { "d": "M2 8.82a15 15 0 0 1 4.17-2.65" }), React.createElement("path", { "d": "M10.66 5c4.01-.36 8.14.9 11.34 3.76" }), React.createElement("path", { "d": "M16.85 11.25a10 10 0 0 1 2.22 1.68" }), React.createElement("path", { "d": "M5.15 11.25a10 10 0 0 0 2.22-1.68" }), React.createElement("path", { "d": "M12.32 13.75a2.94 2.94 0 0 1 1.68 1.68" })),
            VIEW: React.createElement("svg", { xmlns: "http://www.w3.org/2000/svg", height: "18px", viewBox: "0 0 24 24", width: "18px", fill: "#38bdf8" }, React.createElement("path", { d: "M0 0h24v24H0V0z", fill: "none" }), React.createElement("path", { d: "M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z" }))
        };

        // --- Contexts & Providers ---
        const AuthContext = createContext();
        const DataContext = createContext();

        const useAuth = () => useContext(AuthContext);
        const useData = () => useContext(DataContext);

        const AuthProvider = ({ children }) => {
            const [user, setUser] = useState(null);
            const [isAuthReady, setIsAuthReady] = useState(false);
            const initialAuthData = useMemo(() => ({
                isAdmin: false, permissions: [], userName: '',
                userShop: '', userShopIds: [], userRole: '',
                settings: { retentionPeriod: 'never' }
            }), []);

            const [authData, setAuthData] = useState(initialAuthData);

            useEffect(() => {
                const unsubscribe = onAuthStateChanged(auth, (currentUser) => {
                    setUser(currentUser);
                    if (!currentUser) setAuthData(initialAuthData);
                    setIsAuthReady(true);
                });
                return () => unsubscribe();
            }, [initialAuthData]);

            useEffect(() => {
                if (!user) return;

                const fetchUserData = async () => {
                    let newAuthData = { ...initialAuthData };
                    try {
                        const settingsSnap = await getDoc(doc(db, COLLECTIONS.USERS, user.uid, COLLECTIONS.USER_SETTINGS, 'main'));
                        if (settingsSnap.exists()) newAuthData.settings = settingsSnap.data();

                        if (user.email === ADMIN_EMAIL) {
                            newAuthData = {
                                ...newAuthData, isAdmin: true, permissions: ['dashboard', 'board', 'reports', 'settings'],
                                userName: 'Admin', userRole: ROLES.ADMIN
                            };
                        } else {
                            const q = query(collection(db, COLLECTIONS.EMPLOYEES), where("email", "==", user.email));
                            const employeeSnapshot = await getDocs(q);
                            if (!employeeSnapshot.empty) {
                                const employeeDoc = employeeSnapshot.docs[0];
                                if (!employeeDoc.data().uid) {
                                    await updateDoc(doc(db, COLLECTIONS.EMPLOYEES, employeeDoc.id), { uid: user.uid });
                                }
                                const { role = ROLES.STAFF, name = '', pagePermissions = [], assignedShops = [] } = employeeDoc.data();
                                
                                newAuthData = { ...newAuthData, userName: name, userRole: role, permissions: pagePermissions, userShopIds: assignedShops };
                                if (assignedShops?.length > 0) {
                                    const shopDocs = await Promise.all(assignedShops.map(id => getDoc(doc(db, COLLECTIONS.SHOPS, id))));
                                    newAuthData.userShop = shopDocs.filter(d => d.exists()).map(d => d.data().name).join(', ');
                                }
                            }
                        }
                    } catch (error) {
                        console.error("Permission/Settings fetch error:", error);
                    } finally {
                        setAuthData(newAuthData);
                    }
                };

                fetchUserData();
            }, [user, initialAuthData]);

            const value = useMemo(() => ({ user, isAuthReady, ...authData }), [user, isAuthReady, authData]);
            return React.createElement(AuthContext.Provider, { value }, children);
        };
        
        const DataProvider = ({ children }) => {
            const { user } = useAuth();
            const safelyParseJSON = useCallback((key, defaultValue) => {
                try {
                    const item = localStorage.getItem(key);
                    return item ? JSON.parse(item) : defaultValue;
                } catch (e) {
                    console.warn(`Error parsing JSON from localStorage key "${key}":`, e);
                    return defaultValue;
                }
            }, []);

            const [data, setData] = useState({
                tasks: safelyParseJSON('jlw-tasks', []),
                history: safelyParseJSON('jlw-history', []),
                shops: safelyParseJSON('jlw-shops', []),
                employees: safelyParseJSON('jlw-employees', []),
                memo: safelyParseJSON('jlw-memo', { message: '', isActive: false })
            });

            useEffect(() => {
                if (!user) return;

                const collectionsToSync = [
                    { name: 'tasks', query: query(collectionGroup(db, 'tasks')) },
                    { name: 'history', query: query(collectionGroup(db, 'history')) },
                    { name: 'shops', query: collection(db, 'shops') },
                    { name: 'employees', query: collection(db, 'employees') },
                    { name: 'memo', query: doc(db, COLLECTIONS.SETTINGS, 'memo') }
                ];

                const unsubscribers = collectionsToSync.map(({ name, query: q }) => 
                    onSnapshot(q, (snapshot) => {
                        let items;
                        if(name === 'memo') {
                            items = snapshot.exists() ? snapshot.data() : { message: '', isActive: false };
                        } else {
                            items = snapshot.docs.map(d => ({
                                id: d.id, ...d.data(),
                                ...((name === 'tasks' || name === 'history') && { uid: d.ref.path.split('/')[1] })
                            }));
                        }
                        setData(prev => ({ ...prev, [name]: items }));
                        try {
                            localStorage.setItem(`jlw-${name}`, JSON.stringify(items));
                        } catch (e) {
                            console.error("Error writing to localStorage", e);
                        }
                    }, err => console.error(`Error fetching ${name}:`, err))
                );
                
                return () => unsubscribers.forEach(unsub => unsub());
            }, [user]);

            const value = useMemo(() => data, [data]);
            return React.createElement(DataContext.Provider, { value }, children);
        };

        // --- Custom Hooks ---
        const useFilteredData = (dataType) => {
            const { tasks: allTasks, history: allHistory, employees } = useData();
            const { user, isAdmin, userRole, userShopIds } = useAuth();

            return useMemo(() => {
                if (!user) return [];
                const data = dataType === 'tasks' ? allTasks : allHistory;
                
                const activeEmployeeEmails = new Set(employees.filter(e => e.status === 'Active').map(e => e.email));
                const dataOfActiveStaff = data.filter(item => activeEmployeeEmails.has(item.userEmail));

                if (isAdmin) return dataOfActiveStaff;

                if (userRole === ROLES.SHOP_MANAGER && userShopIds?.length > 0) {
                    const shopStaffEmails = new Set(employees
                        .filter(e => e.status === 'Active' && e.assignedShops?.some(id => userShopIds.includes(id)))
                        .map(e => e.email)
                    );
                    shopStaffEmails.add(user.email);
                    return dataOfActiveStaff.filter(item => shopStaffEmails.has(item.userEmail));
                }

                return dataOfActiveStaff.filter(item => item.userEmail === user.email);
            }, [dataType, allTasks, allHistory, employees, user, isAdmin, userRole, userShopIds]);
        };

        const useFilteredTasks = () => useFilteredData('tasks');
        const useFilteredHistory = () => {
            const history = useFilteredData('history');
            return useMemo(() => [...history].sort((a, b) => (b.completedTimestamp?.seconds || 0) - (a.completedTimestamp?.seconds || 0)), [history]);
        };
        
        const useOnlineStatus = () => {
            const [isOnline, setIsOnline] = useState(navigator.onLine);
            useEffect(() => {
                const handleOnline = () => setIsOnline(true);
                const handleOffline = () => setIsOnline(false);
                window.addEventListener('online', handleOnline);
                window.addEventListener('offline', handleOffline);
                return () => {
                    window.removeEventListener('online', handleOnline);
                    window.removeEventListener('offline', handleOffline);
                };
            }, []);
            return isOnline;
        };
        
        const useTaskDuration = (task) => {
            const [duration, setDuration] = useState(null);
            useEffect(() => {
                let intervalId = null;
                if (task.status === KANBAN_STATUS.IN_PROGRESS && task.progressTimestamp) {
                    const updateDuration = () => setDuration(formatLiveDuration(task.progressTimestamp));
                    updateDuration();
                    intervalId = setInterval(updateDuration, 1000);
                } else if (task.status === KANBAN_STATUS.AUDITING && task.progressTimestamp && task.workCompletedTimestamp) {
                    setDuration(formatFixedDuration(task.progressTimestamp.seconds, task.workCompletedTimestamp.seconds));
                } else {
                    setDuration(null);
                }
                return () => clearInterval(intervalId);
            }, [task.status, task.progressTimestamp, task.workCompletedTimestamp]);
            return duration;
        };

        const useAppFilters = (initialFilters = {}) => {
            const { user, isAdmin, userRole, userName, userShop, userShopIds } = useAuth();
            const { shops, employees } = useData();
            const [filters, setFilters] = useState({ shop: '', staff: '', ...initialFilters });
            const defaultsApplied = useRef(false);

            // Effect to set the default filter state once when data is first loaded.
            useEffect(() => {
                if (defaultsApplied.current || !userRole) return;
                
                // For roles that need shop data, wait for it to be loaded.
                if (userRole === ROLES.SHOP_MANAGER && shops.length === 0 && userShopIds.length > 0) {
                    return;
                }

                const newDefaults = {};
                if (userRole === ROLES.STAFF) {
                    newDefaults.shop = userShop;
                    newDefaults.staff = userName;
                } else if (userRole === ROLES.SHOP_MANAGER && userShopIds.length === 1) {
                    const singleShop = shops.find(s => s.id === userShopIds[0]);
                    newDefaults.shop = singleShop ? singleShop.name : '';
                }
                
                setFilters(prev => ({...prev, ...newDefaults}));
                defaultsApplied.current = true;
                
            }, [userRole, userName, userShop, userShopIds, shops]);

            // Reset the flag if the user logs in or out.
            useEffect(() => {
                defaultsApplied.current = false;
            }, [user]);

            const handleFilterChange = useCallback((e) => {
                const { name, value, type, checked } = e.target;
                const newValue = type === 'checkbox' ? checked : value;

                setFilters(prev => {
                    const newState = { ...prev, [name]: newValue };
                    if (name === 'shop') newState.staff = '';
                    return newState;
                });
            }, []);

            const shopOptions = useMemo(() => {
                if (isAdmin) return [...new Set(shops.map(s => s.name).filter(Boolean))];
                if (userRole === ROLES.SHOP_MANAGER) return shops.filter(s => userShopIds.includes(s.id)).map(s => s.name);
                return userShop ? [userShop] : [];
            }, [isAdmin, shops, userShop, userShopIds, userRole]);

            const staffOptions = useMemo(() => {
                const activeEmployees = employees.filter(e => e.status === 'Active');
                
                // For Staff, the list is just their own name.
                if (userRole === ROLES.STAFF) {
                    return userName ? [userName] : [];
                }

                // Determine the base pool of staff the user can view.
                // Admin sees everyone; Shop Manager sees staff from all their assigned shops.
                const viewableStaffPool = (() => {
                    if (isAdmin) {
                        return activeEmployees;
                    }
                    if (userRole === ROLES.SHOP_MANAGER) {
                        return activeEmployees.filter(e => e.assignedShops?.some(sid => userShopIds.includes(sid)));
                    }
                    return []; // Should not be reached for Admin/Manager
                })();

                // If a specific shop is selected in the filter, filter the pool down.
                if (filters.shop) {
                    const selectedShopId = shops.find(s => s.name === filters.shop)?.id;
                    if (selectedShopId) {
                        const staffInSelectedShop = viewableStaffPool.filter(e => e.assignedShops?.includes(selectedShopId));
                        return [...new Set(staffInSelectedShop.map(e => e.name).filter(Boolean))];
                    }
                }
                
                // If "All Shops" is selected, return the entire viewable pool.
                return [...new Set(viewableStaffPool.map(e => e.name).filter(Boolean))];
            }, [employees, userRole, userShopIds, userName, filters.shop, shops, isAdmin]);

            return { filters, setFilters, handleFilterChange, shopOptions, staffOptions };
        };

        // --- Utility Functions ---
        const formatFixedDuration = (startSeconds, endSeconds) => {
            if (startSeconds == null || endSeconds == null) return 'N/A';
            const totalSeconds = Math.max(0, endSeconds - startSeconds);
            const d = Math.floor(totalSeconds / 86400);
            const h = Math.floor((totalSeconds % 86400) / 3600);
            const m = Math.floor((totalSeconds % 3600) / 60);
            const s = Math.floor(totalSeconds % 60);
            
            const parts = [
                d > 0 && `${d}d`,
                h > 0 && `${h}h`,
                m > 0 && `${m}m`,
                (s > 0 || totalSeconds === 0) && `${s}s`,
            ].filter(Boolean);

            return parts.length > 0 ? parts.slice(0, 2).join(' ') : '0s';
        };
        
        const formatLiveDuration = (startTime) => {
            if (!startTime?.seconds) return "0s";
            const startMs = startTime.seconds * 1000 + (startTime.nanoseconds || 0) / 1000000;
            return formatFixedDuration(startMs / 1000, Date.now() / 1000);
        };
        
        const formatFullDateTime = (timestamp) => {
            if (!timestamp) return 'No date specified';
            const date = timestamp.seconds ? new Date(timestamp.seconds * 1000) : new Date(timestamp);
            if (isNaN(date)) return 'Invalid Date';

            return new Intl.DateTimeFormat('en-GB', { 
                day: '2-digit', month: '2-digit', year: '2-digit',
                hour: '2-digit', minute: '2-digit', hour12: true 
            }).format(date).replace(',', ' |');
        };

        // --- Main App Structure ---
        const App = () => {
            const { user, isAuthReady } = useAuth();
            if (!isAuthReady) return React.createElement(LoadingSpinner, { text: "Authenticating..." });
            return user ? React.createElement(MainApp) : React.createElement(Login);
        };
        
        const MainApp = () => {
            const { permissions } = useAuth();
            const [page, setPage] = useState('');
            const [isModalOpen, setIsModalOpen] = useState(false);
            const [editingItem, setEditingItem] = useState(null);
            const [modalContext, setModalContext] = useState('task');
            const [isSidebarOpen, setIsSidebarOpen] = useState(false);
            
            useEffect(() => {
                if (permissions.length > 0 && !page) setPage(permissions[0]);
            }, [permissions, page]);

            const openModal = useCallback((item = null, context = 'task') => {
                setEditingItem(item); setModalContext(context); setIsModalOpen(true);
            }, []);
            const closeModal = useCallback(() => { setIsModalOpen(false); setEditingItem(null); }, []);
            const toggleSidebar = useCallback(() => setIsSidebarOpen(o => !o), []);

            return React.createElement(React.Fragment, null,
                React.createElement(MemoAlert, null),
                React.createElement(Sidebar, { currentPage: page, setPage, isOpen: isSidebarOpen, setIsOpen: setIsSidebarOpen }),
                React.createElement("div", { className: "flex flex-col min-h-screen lg:pl-64" },
                    React.createElement(TopHeader, { openModal, toggleSidebar }),
                    React.createElement("main", { className: "flex-grow p-4 sm:p-6 lg:p-8" },
                        React.createElement(PageRenderer, { page, permissions, openModal, setPage })
                    )
                ),
                isModalOpen && React.createElement(TaskModal, { itemToEdit: editingItem, context: modalContext, onClose: closeModal })
            );
        };

        const PageRenderer = React.memo(({ page, permissions, openModal, setPage }) => {
            if (permissions.length === 0) {
                 return React.createElement("div", { className: "text-center p-8" }, 
                    React.createElement("h1", { className: "text-2xl font-bold text-yellow-500" }, "តើអ្នកសុខសប្បាយទេថ្ងៃនេះ?"),
                    React.createElement("p", { className: "text-slate-400 mt-2" }, "សូមរង់ចាំបន្តិចណា​ ខ្ញុំកំពុងបើករកទិន្នន័យអ្នក....")
                );
            }
            if (!page) return React.createElement(LoadingSpinner, { text: "Loading Page..." });
            if (!permissions.includes(page)) {
                return React.createElement("div", { className: "text-center p-8" }, 
                    React.createElement("h1", { className: "text-2xl font-bold text-red-500" }, "Access Denied"),
                    React.createElement("p", { className: "text-slate-400 mt-2" }, "You do not have permission to view this page.")
                );
            }
            switch (page) {
                case 'dashboard': return React.createElement(DashboardPage, { setPage });
                case 'board': return React.createElement(BoardPage, { openModal });
                case 'settings': return React.createElement(SettingsPage);
                default: return null;
            }
        });

        // --- Core UI Components ---
        const Sidebar = ({ currentPage, setPage, isOpen, setIsOpen }) => {
            const { user, permissions, userName, userRole } = useAuth();
            const navItems = useMemo(() => [
                { id: 'dashboard', label: 'Dashboard', icon: ICONS.DASHBOARD },
                { id: 'board', label: 'Task Manager', icon: ICONS.BOARD },
                { id: 'settings', label: 'Settings', icon: ICONS.SETTINGS },
            ], []);
            const handleSignOut = useCallback(() => signOut(auth).catch(error => console.error("Sign out error", error)), []);

            return React.createElement(React.Fragment, null,
                React.createElement("div", {
                    className: `fixed inset-0 bg-black/60 z-30 lg:hidden transition-opacity duration-300 ${isOpen ? 'opacity-100' : 'opacity-0 pointer-events-none'}`,
                    onClick: () => setIsOpen(false)
                }),
                React.createElement("aside", { className: `fixed top-0 left-0 h-full w-64 bg-slate-800 border-r border-slate-700/50 flex flex-col p-4 z-40 transition-transform duration-300 ease-in-out lg:translate-x-0 ${isOpen ? 'translate-x-0' : '-translate-x-full'}` },
                    React.createElement("div", { className: "flex items-center mb-8" },
                        React.createElement("div", { className: "w-10 h-10 bg-blue-600 rounded-lg flex items-center justify-center mr-3" }, ICONS.LOGO),
                        React.createElement("h1", { className: "text-xl font-bold text-slate-100" }, "JLW Tracker")
                    ),
                    React.createElement("nav", { className: "flex-grow space-y-2" },
                        navItems.filter(item => permissions.includes(item.id))
                                .map(item => React.createElement(NavLink, { key: item.id, item, currentPage, setPage, setIsOpen }))
                    ),
                    React.createElement("div", { className: "mt-auto" },
                        React.createElement("div", { className: "p-3 bg-slate-700/50 rounded-lg" },
                            React.createElement("p", { className: "text-sm font-medium text-slate-200 truncate" }, userName || user.email),
                            React.createElement("p", { className: "text-xs text-slate-400" }, userRole)
                        ),
                        React.createElement("button", { onClick: handleSignOut, className: "flex items-center w-full px-4 py-3 mt-2 text-sm font-medium rounded-lg text-slate-400 hover:bg-slate-700 hover:text-slate-200" },
                            React.cloneElement(ICONS.LOGOUT, { className: "w-5 h-5 mr-3" }), "Sign Out")
                    )
                )
            );
        };
        
        const NavLink = React.memo(({ item, currentPage, setPage, setIsOpen }) => {
            const isActive = currentPage === item.id;
            const handleClick = useCallback(() => { setPage(item.id); setIsOpen(false); }, [item.id, setPage, setIsOpen]);
            return React.createElement("button", {
                onClick: handleClick,
                className: `flex items-center w-full px-4 py-3 text-sm font-medium rounded-lg transition-colors ${isActive ? 'bg-blue-600 text-white' : 'text-slate-400 hover:bg-slate-700 hover:text-slate-200'}`
            }, React.cloneElement(item.icon, { className: "w-5 h-5 mr-3" }), item.label);
        });
        
        const TopHeader = React.memo(({ openModal, toggleSidebar }) => {
            const isOnline = useOnlineStatus();
            return React.createElement("header", { className: "flex-shrink-0 bg-slate-900/70 backdrop-blur-sm border-b border-slate-700/50 px-4 sm:px-6 lg:px-8 lg:sticky lg:top-0 lg:z-10" },
                React.createElement("div", { className: "flex items-center justify-between h-16" },
                     React.createElement("button", { onClick: toggleSidebar, className: "lg:hidden text-slate-400 hover:text-slate-200 p-2 -ml-2" }, ICONS.MENU),
                     React.createElement("div", { className: "flex-1" }),
                     React.createElement("div", { className: "flex items-center gap-4" },
                        !isOnline && React.createElement("div", { className: "flex items-center gap-2 text-yellow-400 text-sm font-semibold bg-yellow-900/50 px-3 py-1.5 rounded-lg" }, ICONS.OFFLINE, React.createElement("span", null, "Offline Mode")),
                        React.createElement("button", { onClick: () => openModal(), className: "bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-75 transition-transform transform hover:scale-105" }, "+ Add New Task")
                     )
                )
            );
        });
        
        // --- Pages & Page-Specific Components ---
        
        // Dashboard Page
        const DashboardPage = React.memo(({ setPage }) => {
            const { user, userName, userRole, userShopIds, permissions } = useAuth();
            const tasks = useFilteredTasks();
            const history = useFilteredHistory();

            const stats = useMemo(() => {
                const now = new Date();
                const currentMonthISO = now.toISOString().slice(0, 7);
                const userHistory = history.filter(h => h.userEmail === user.email);
                const monthlyHistory = userHistory.filter(h => h.completedTimestamp && new Date(h.completedTimestamp.seconds * 1000).toISOString().slice(0, 7) === currentMonthISO);
                const scoredTasks = monthlyHistory.filter(task => task.auditScore);
                
                let averageScore = '0%';
                if (scoredTasks.length > 0) {
                    const totalScore = scoredTasks.reduce((sum, task) => sum + parseInt(task.auditScore, 10), 0);
                    averageScore = `${Math.round(totalScore / scoredTasks.length)}%`;
                }

                return {
                    todo: tasks.filter(t => t.status === KANBAN_STATUS.TODO).length,
                    inprogress: tasks.filter(t => t.status === KANBAN_STATUS.IN_PROGRESS).length,
                    auditing: tasks.filter(t => t.status === KANBAN_STATUS.AUDITING).length,
                    doneToday: userHistory.filter(h => h.completedTimestamp && new Date(h.completedTimestamp.seconds * 1000).toDateString() === now.toDateString()).length,
                    averageScore
                };
            }, [tasks, history, user.email]);

            const priorityTasks = useMemo(() => tasks.filter(t => t.status === KANBAN_STATUS.TODO).slice(0, 5), [tasks]);
            const recentHistory = useMemo(() => history.slice(0, 5), [history]);

            return React.createElement("div", { className: "space-y-8" },
                React.createElement("div", null,
                    React.createElement("h1", { className: "text-3xl font-bold text-slate-100" }, `Welcome back, ${userName || user.email.split('@')[0]}!`),
                    React.createElement("p", { className: "text-slate-400 mt-1" }, "Here's a snapshot of your activity.")
                ),
                React.createElement("div", { className: "grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-6" },
                    React.createElement(StatCard, { title: "Tasks To Do", value: stats.todo, color: "border-red-500", onClick: () => setPage('board') }),
                    React.createElement(StatCard, { title: "In Progress", value: stats.inprogress, color: "border-yellow-500", onClick: () => setPage('board') }),
                    React.createElement(StatCard, { title: "Pending Audit", value: stats.auditing, color: "border-blue-500", onClick: () => setPage('board') }),
                    React.createElement(StatCard, { title: "Completed Today", value: stats.doneToday, color: "border-green-500" }),
                    React.createElement(StatCard, { title: "Your Monthly Score", value: stats.averageScore, color: "border-purple-500" })
                ),
                userRole === ROLES.SHOP_MANAGER && React.createElement(StaffScoreDashboard, null),
                React.createElement("div", { className: "grid grid-cols-1 lg:grid-cols-2 gap-8" },
                    React.createElement(DashboardList, { title: "Priority Tasks", items: priorityTasks, emptyMessage: "No tasks in 'To Do'. Great job!", renderItem: task => React.createElement(React.Fragment, null, React.createElement("p", { className: "font-medium text-slate-200" }, task.text), React.createElement("p", { className: "text-xs text-slate-400" }, `${task.shopName || 'N/A'} - ${task.staffName || 'N/A'}`)) }),
                    React.createElement(DashboardList, { title: "Recent Activity", items: recentHistory, emptyMessage: "No recent completed tasks.", renderItem: task => React.createElement(React.Fragment, null, React.createElement("p", { className: "font-medium text-slate-200" }, task.text), React.createElement("p", { className: "text-xs text-slate-400" }, `Completed by ${task.staffName || 'N/A'}`)) })
                ),
                permissions.includes('reports') && React.createElement(ReportsSection)
            );
        });

        const StatCard = React.memo(({ title, value, color, onClick }) => {
            const cardClasses = `bg-slate-800 p-6 rounded-xl border-l-4 ${color} transition-colors ${onClick ? 'cursor-pointer hover:bg-slate-700' : ''}`;
            return React.createElement("div", { className: cardClasses, onClick: onClick },
                React.createElement("p", { className: "text-sm font-medium text-slate-400" }, title),
                React.createElement("p", { className: "text-3xl font-bold text-slate-100 mt-1" }, value)
            );
        });

        const DashboardList = React.memo(({ title, items, emptyMessage, renderItem }) => (
            React.createElement("div", { className: "bg-slate-800 p-6 rounded-xl" },
                React.createElement("h2", { className: "text-xl font-semibold text-slate-100 mb-4" }, title),
                React.createElement("div", { className: "space-y-3" },
                    items.length > 0
                        ? items.map(item => React.createElement("div", { key: item.id, className: "bg-slate-700 p-3 rounded-lg" }, renderItem(item)))
                        : React.createElement("p", { className: "text-slate-400" }, emptyMessage)
                )
            )
        ));
        
        const StaffScoreDashboard = React.memo(() => {
            const { employees } = useData();
            const { userShopIds } = useAuth();
            const history = useFilteredHistory();
            const [timeRange, setTimeRange] = useState('current');

            const staffScores = useMemo(() => {
                if (!userShopIds?.length) return [];

                const shopStaff = employees.filter(e => e.status === 'Active' && e.assignedShops?.some(sid => userShopIds.includes(sid)));
                const now = new Date();
                let startDate;

                switch (timeRange) {
                    case 'this_week': startDate = new Date(now.setDate(now.getDate() - now.getDay())); break;
                    case 'last1': startDate = new Date(now.getFullYear(), now.getMonth() - 1, 1); break;
                    case 'last3': startDate = new Date(now.getFullYear(), now.getMonth() - 3, 1); break;
                    case 'last6': startDate = new Date(now.getFullYear(), now.getMonth() - 6, 1); break;
                    case 'last_year': startDate = new Date(new Date().setFullYear(new Date().getFullYear() - 1)); break;
                    default: startDate = new Date(now.getFullYear(), now.getMonth(), 1);
                }
                if (timeRange !== 'this_week') startDate.setHours(0, 0, 0, 0);

                return shopStaff.map(staff => {
                    const staffHistory = history.filter(h => h.userEmail === staff.email && h.completedTimestamp && new Date(h.completedTimestamp.seconds * 1000) >= startDate);
                    const scoredTasks = staffHistory.filter(task => task.auditScore);
                    let averageScore = '0%';
                    if (scoredTasks.length > 0) {
                        const totalScore = scoredTasks.reduce((sum, task) => sum + parseInt(task.auditScore, 10), 0);
                        averageScore = `${Math.round(totalScore / scoredTasks.length)}%`;
                    }
                    return { id: staff.id, name: staff.name, score: averageScore, tasksCompleted: staffHistory.length };
                });
            }, [history, employees, userShopIds, timeRange]);

            if (staffScores.length === 0) return null;

            return React.createElement("div", { className: "bg-slate-800 p-6 rounded-xl" },
                React.createElement("div", { className: "flex flex-col sm:flex-row justify-between sm:items-center mb-4 gap-4" },
                    React.createElement("h2", { className: "text-xl font-semibold text-slate-100" }, "Staff Scores"),
                    React.createElement("div", { className: "flex flex-wrap items-center justify-start sm:justify-end gap-2" },
                        React.createElement(TimeRangeButton, { label: "This Week", range: "this_week", activeRange: timeRange, setTimeRange }),
                        React.createElement(TimeRangeButton, { label: "This Month", range: "current", activeRange: timeRange, setTimeRange }),
                        React.createElement(TimeRangeButton, { label: "Last Month", range: "last1", activeRange: timeRange, setTimeRange }),
                        React.createElement(TimeRangeButton, { label: "3 Months", range: "last3", activeRange: timeRange, setTimeRange }),
                        React.createElement(TimeRangeButton, { label: "6 Months", range: "last6", activeRange: timeRange, setTimeRange }),
                        React.createElement(TimeRangeButton, { label: "1 Year", range: "last_year", activeRange: timeRange, setTimeRange })
                    )
                ),
                React.createElement("div", { className: "grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4" },
                    staffScores.map(staff =>
                        React.createElement("div", { key: staff.id, className: "bg-slate-700 p-4 rounded-lg text-center" },
                            React.createElement("p", { className: "font-semibold text-slate-200 truncate" }, staff.name),
                            React.createElement("p", { className: "text-2xl font-bold text-purple-400 mt-2" }, staff.score),
                            React.createElement("p", { className: "text-xs text-slate-400 mt-1" }, `${staff.tasksCompleted} tasks completed`)
                        )
                    )
                )
            );
        });
        
        const TimeRangeButton = React.memo(({ label, range, activeRange, setTimeRange }) => {
            const isActive = range === activeRange;
            return React.createElement("button", {
                onClick: () => setTimeRange(range),
                className: `px-3 py-1 text-xs font-medium rounded-md transition-colors ${isActive ? 'bg-blue-600 text-white' : 'bg-slate-600 text-slate-300 hover:bg-slate-500'}`
            }, label);
        });

        // Reports Section (for Dashboard)
        const ReportsSection = React.memo(() => {
            const { isAdmin, userRole, userShopIds } = useAuth();
            const { employees, shops } = useData();
            const history = useFilteredHistory();

            const { filters, handleFilterChange, shopOptions, staffOptions } = useAppFilters();

            const filteredReportHistory = useMemo(() => {
                const now = new Date();
                let startDate;
                switch (filters.dateRange) {
                    case 'last_month': startDate = new Date(now.getFullYear(), now.getMonth() - 1, 1); break;
                    case 'last_3_months': startDate = new Date(now.getFullYear(), now.getMonth() - 3, 1); break;
                    default: startDate = new Date(now.getFullYear(), now.getMonth(), 1);
                }
                return history.filter(task => 
                    (!filters.shop || task.shopName === filters.shop) &&
                    (!filters.staff || task.staffName === filters.staff) &&
                    (task.completedTimestamp && new Date(task.completedTimestamp.seconds * 1000) >= startDate)
                );
            }, [history, filters]);
            
            const reportData = useMemo(() => {
                if (filteredReportHistory.length === 0) {
                    return { totalTasks: 0, avgScore: '0%', avgDuration: 'N/A', leaderboard: [], chartData: { labels: [], datasets: [{ data: [] }] } };
                }

                const scoredTasks = filteredReportHistory.filter(t => t.auditScore);
                const totalScore = scoredTasks.reduce((acc, t) => acc + parseInt(t.auditScore, 10), 0);
                const avgScore = scoredTasks.length > 0 ? `${Math.round(totalScore / scoredTasks.length)}%` : '0%';
                
                const durationTasks = filteredReportHistory.filter(t => t.progressTimestamp && (t.workCompletedTimestamp || t.completedTimestamp));
                const totalDurationSeconds = durationTasks.reduce((acc, t) => acc + ((t.workCompletedTimestamp || t.completedTimestamp).seconds - t.progressTimestamp.seconds), 0);
                const avgDuration = durationTasks.length > 0 ? formatFixedDuration(0, totalDurationSeconds / durationTasks.length) : 'N/A';
                
                const groupedByStaff = filteredReportHistory.reduce((acc, task) => {
                    if (!task.staffName) return acc;
                    if (!acc[task.staffName]) acc[task.staffName] = { count: 0, totalScore: 0, scoredCount: 0 };
                    acc[task.staffName].count++;
                    if (task.auditScore) {
                        acc[task.staffName].totalScore += parseInt(task.auditScore, 10);
                        acc[task.staffName].scoredCount++;
                    }
                    return acc;
                }, {});

                const leaderboard = Object.entries(groupedByStaff).map(([name, data]) => ({
                    name, tasksCompleted: data.count,
                    averageScore: data.scoredCount > 0 ? Math.round(data.totalScore / data.scoredCount) : 0,
                })).sort((a, b) => b.averageScore - a.averageScore || b.tasksCompleted - a.tasksCompleted);

                const top10 = leaderboard.slice(0, 10);
                const chartData = {
                    labels: top10.map(item => item.name),
                    datasets: [{ label: 'Tasks Completed', data: top10.map(item => item.tasksCompleted), backgroundColor: '#3b82f6' }]
                };

                return { totalTasks: filteredReportHistory.length, avgScore, avgDuration, leaderboard, chartData };
            }, [filteredReportHistory]);
            
            return React.createElement("div", { className: "space-y-8" },
                React.createElement("div", { className: "pt-8 mt-8 border-t border-slate-700/50" },
                    React.createElement("h1", { className: "text-3xl font-bold text-slate-100" }, "Performance Reports"),
                    React.createElement("p", { className: "text-slate-400 mt-1" }, "Analyze team and individual performance.")
                ),
                React.createElement("div", { className: "grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 p-4 bg-slate-800 rounded-lg" },
                    React.createElement("select", { name: "dateRange", value: filters.dateRange || 'current_month', onChange: handleFilterChange, className: "input" },
                        React.createElement("option", { value: "current_month" }, "This Month"), React.createElement("option", { value: "last_month" }, "Last Month"), React.createElement("option", { value: "last_3_months" }, "Last 3 Months")
                    ),
                    React.createElement(FilterSelect, { label: "Filter by Shop", name: "shop", value: filters.shop, onChange: handleFilterChange, options: shopOptions.map(s => s.name || s), disabled: userRole === ROLES.STAFF, simple: true }),
                    React.createElement(FilterSelect, { label: "Filter by Staff", name: "staff", value: filters.staff, onChange: handleFilterChange, options: staffOptions.map(s => s.name), disabled: false, simple: true })
                ),
                React.createElement("div", { className: "grid grid-cols-1 sm:grid-cols-3 gap-6" },
                    React.createElement(ReportStatCard, { title: "Total Tasks Completed", value: reportData.totalTasks }),
                    React.createElement(ReportStatCard, { title: "Average Score", value: reportData.avgScore }),
                    React.createElement(ReportStatCard, { title: "Avg. Completion Time", value: reportData.avgDuration })
                ),
                React.createElement("div", { className: "grid grid-cols-1 lg:grid-cols-2 gap-8" },
                    React.createElement(ReportChart, { chartData: reportData.chartData }),
                    React.createElement(ReportLeaderboard, { leaderboardData: reportData.leaderboard })
                )
            );
        });

        const ReportStatCard = ({ title, value }) => React.createElement("div", { className: "bg-slate-800 p-6 rounded-xl" }, React.createElement("p", { className: "text-sm font-medium text-slate-400" }, title), React.createElement("p", { className: "text-3xl font-bold text-slate-100 mt-1" }, value));

        const ReportChart = ({ chartData }) => {
            const chartRef = useRef(null);
            useEffect(() => {
                if (!chartRef.current) return;
                const ctx = chartRef.current.getContext('2d');
                const chartInstance = new Chart(ctx, {
                    type: 'bar', data: chartData,
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } },
                        scales: { y: { beginAtZero: true, ticks: { color: '#94a3b8' }, grid: { color: '#334155' } }, x: { ticks: { color: '#94a3b8' }, grid: { display: false } } }
                    }
                });
                return () => chartInstance.destroy();
            }, [chartData]);
            return React.createElement("div", { className: "bg-slate-800 p-6 rounded-xl" }, React.createElement("h2", { className: "text-xl font-semibold text-slate-100 mb-4" }, "Top 10 Staff by Tasks Completed"), React.createElement("div", { className: "relative h-80" }, React.createElement("canvas", { ref: chartRef })));
        };

        const ReportLeaderboard = ({ leaderboardData }) => React.createElement("div", { className: "bg-slate-800 p-6 rounded-xl" }, React.createElement("h2", { className: "text-xl font-semibold text-slate-100 mb-4" }, "Performance Leaderboard"), React.createElement("div", { className: "overflow-y-auto h-80" }, React.createElement("table", { className: "w-full text-left" }, React.createElement("thead", null, React.createElement("tr", {className: "border-b border-slate-700"}, React.createElement("th", { className: "py-2 text-sm font-semibold text-slate-400" }, "Rank"), React.createElement("th", { className: "py-2 text-sm font-semibold text-slate-400" }, "Staff Name"), React.createElement("th", { className: "py-2 text-sm font-semibold text-slate-400 text-center" }, "Tasks"), React.createElement("th", { className: "py-2 text-sm font-semibold text-slate-400 text-center" }, "Avg Score"))), React.createElement("tbody", null, leaderboardData.length > 0 ? leaderboardData.map((item, index) => React.createElement("tr", { key: item.name, className: "border-b border-slate-700/50" }, React.createElement("td", { className: "py-3" }, index + 1), React.createElement("td", { className: "py-3 font-medium text-slate-200" }, item.name), React.createElement("td", { className: "py-3 text-center" }, item.tasksCompleted), React.createElement("td", { className: "py-3 text-center font-semibold text-purple-400" }, `${item.averageScore}%`))) : React.createElement("tr", null, React.createElement("td", {colSpan: 4, className: "py-4 text-center text-slate-400"}, "No data for this period."))))));
        
        // Board Page
        const BoardPage = React.memo(({ openModal }) => {
            const tasks = useFilteredTasks();
            const { isAdmin, userRole, userName } = useAuth();
            const [processingTaskIds, setProcessingTaskIds] = useState(() => new Set());
            
            const { filters, handleFilterChange, shopOptions, staffOptions } = useAppFilters({ shopManagerOnly: false });

            const filteredTasks = useMemo(() => tasks.filter(task => {
                const shopMatch = !filters.shop || task.shopName === filters.shop;
                const staffMatch = !filters.staff || task.staffName === filters.staff;
                const managerOnlyMatch = !filters.shopManagerOnly || task.creatorRole === ROLES.SHOP_MANAGER;
                return shopMatch && staffMatch && managerOnlyMatch;
            }), [tasks, filters]);

            const handleTaskAction = useCallback(async (action, task, payload = {}) => {
                if (!task?.uid || processingTaskIds.has(task.id)) return;
                setProcessingTaskIds(prev => new Set(prev).add(task.id));

                const taskRef = doc(db, COLLECTIONS.USERS, task.uid, COLLECTIONS.TASKS, task.id);
                try {
                    switch(action) {
                        case 'move':
                            if (payload.newStatus === KANBAN_STATUS.DONE) {
                                if (isAdmin) { // Admins can auto-approve their own tasks to history
                                    const { id, ...taskData } = task;
                                    await addDoc(collection(db, COLLECTIONS.USERS, task.uid, COLLECTIONS.HISTORY), { ...taskData, status: 'done', completedTimestamp: serverTimestamp() });
                                    await deleteDoc(taskRef);
                                } else { // Staff members send tasks to audit
                                    await updateDoc(taskRef, { status: KANBAN_STATUS.AUDITING, workCompletedTimestamp: serverTimestamp() });
                                }
                            } else {
                                const updateData = { status: payload.newStatus };
                                if (payload.newStatus === KANBAN_STATUS.IN_PROGRESS && !task.progressTimestamp) {
                                    updateData.progressTimestamp = serverTimestamp();
                                }
                                if (payload.comment) updateData.auditComment = payload.comment;
                                await updateDoc(taskRef, updateData);
                            }
                            break;
                        case 'approve':
                            const { id, ...taskData } = task;
                            const dataForHistory = {
                                ...taskData, status: KANBAN_STATUS.DONE, completedTimestamp: serverTimestamp(),
                                auditorName: userName, auditorRole: userRole, auditScore: payload.score,
                            };
                            if (payload.comment) dataForHistory.auditComment = payload.comment;
                            await addDoc(collection(db, COLLECTIONS.USERS, task.uid, COLLECTIONS.HISTORY), dataForHistory);
                            await deleteDoc(taskRef);
                            if (window.confetti) confetti({ particleCount: 150, spread: 90, origin: { x: 0.5, y: 0.5 } });
                            break;
                        case 'delete':
                            await deleteDoc(taskRef);
                            break;
                    }
                } catch (error) {
                    console.error(`Error performing ${action} on task:`, error);
                } finally {
                    setProcessingTaskIds(prev => {
                        const newSet = new Set(prev); newSet.delete(task.id); return newSet;
                    });
                }
            }, [processingTaskIds, isAdmin, userName, userRole]);

            const handleEditTask = useCallback((task) => openModal(task, 'task'), [openModal]);
            
            return React.createElement("div", { className: "space-y-8" },
                React.createElement("div", null,
                    React.createElement("h1", { className: "text-3xl font-bold text-slate-100 mb-2" }, "Task Manager"),
                    React.createElement("div", { className: "flex flex-col sm:flex-row gap-4 mb-6 p-4 bg-slate-800 rounded-lg items-center" },
                        React.createElement(FilterSelect, { label: "Filter by Shop", name: "shop", value: filters.shop, onChange: handleFilterChange, options: shopOptions, disabled: userRole === ROLES.STAFF }),
                        React.createElement(FilterSelect, { label: "Filter by Staff", name: "staff", value: filters.staff, onChange: handleFilterChange, options: staffOptions, disabled: userRole === ROLES.STAFF }),
                        isAdmin && React.createElement("div", { className: "flex items-center pt-6" },
                            React.createElement("input", { id: "shopManagerOnly", name: "shopManagerOnly", type: "checkbox", checked: filters.shopManagerOnly, onChange: handleFilterChange, className: "h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500 bg-slate-600" }),
                            React.createElement("label", { htmlFor: "shopManagerOnly", className: "ml-2 text-sm text-slate-200 whitespace-nowrap" }, "Shop Managers Only")
                        )
                    ),
                    React.createElement(KanbanBoard, { tasks: filteredTasks, onTaskAction: handleTaskAction, onEdit: handleEditTask, processingTaskIds })
                ),
                React.createElement(HistorySection, { openModal: openModal })
            );
        });

        const FilterSelect = React.memo(({ label, name, value, onChange, options, disabled, simple = false }) => {
            const wrapperClass = simple ? "" : "flex-1 w-full";
            const selectClass = simple ? "input text-sm" : "input w-full";
            const labelEl = simple ? null : React.createElement("label", { htmlFor: `${name}-filter`, className: "block text-sm font-medium text-slate-400 mb-1" }, label);

            return React.createElement("div", { className: wrapperClass },
                labelEl,
                React.createElement("select", { id: `${name}-filter`, name, value, onChange, className: selectClass, disabled }, 
                    React.createElement("option", { value: "" }, `All ${name.charAt(0).toUpperCase() + name.slice(1)}s`),
                    options.map(opt => React.createElement("option", { key: opt, value: opt }, opt))
                )
            );
        });

        const KanbanBoard = React.memo(({ tasks, onTaskAction, onEdit, processingTaskIds }) => {
            const columns = useMemo(() => [
                { id: KANBAN_STATUS.TODO, title: 'To Do', color: 'red-400', tasks: tasks.filter(t => t.status === KANBAN_STATUS.TODO) },
                { id: KANBAN_STATUS.IN_PROGRESS, title: 'In Progress', color: 'yellow-400', tasks: tasks.filter(t => t.status === KANBAN_STATUS.IN_PROGRESS) },
                { id: KANBAN_STATUS.AUDITING, title: 'Task Auditing', color: 'blue-400', tasks: tasks.filter(t => t.status === KANBAN_STATUS.AUDITING) },
            ], [tasks]);
            return React.createElement("div", { className: "grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" },
                columns.map(col => React.createElement(KanbanColumn, { key: col.id, ...col, onTaskAction, onEdit, processingTaskIds }))
            );
        });

        const KanbanColumn = React.memo(({ title, color, tasks, onTaskAction, onEdit, processingTaskIds }) => (
            React.createElement("div", { className: "bg-slate-800 rounded-xl shadow-md flex flex-col" },
                React.createElement("div", { className: "p-4 border-b border-slate-700 flex justify-between items-center" },
                    React.createElement("h2", { className: "text-lg font-semibold text-slate-200 flex items-center" },
                        React.createElement("span", { className: `w-3 h-3 rounded-full bg-${color} mr-3` }), title
                    ),
                    React.createElement("span", { className: "text-sm font-normal bg-slate-700 text-slate-300 px-2 py-0.5 rounded-full" }, tasks.length)
                ),
                React.createElement("div", { className: "kanban-column-body p-4 flex-grow min-h-[200px] overflow-y-auto" },
                    tasks.map(task => React.createElement(TaskCard, { key: task.id, task, onEdit, onTaskAction, processingTaskIds }))
                )
            )
        ));

        const TaskCard = React.memo(({ task, onEdit, onTaskAction, processingTaskIds }) => {
            const duration = useTaskDuration(task);
            
            const getMoveButtons = () => {
                const isProcessing = processingTaskIds.has(task.id);
                switch (task.status) {
                    case KANBAN_STATUS.TODO: return React.createElement("button", { onClick: () => onTaskAction('move', task, { newStatus: KANBAN_STATUS.IN_PROGRESS }), className: "px-3 py-1 text-xs bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700" }, "In Progress");
                    case KANBAN_STATUS.IN_PROGRESS: return React.createElement(React.Fragment, null,
                        React.createElement("button", { onClick: () => onTaskAction('move', task, { newStatus: KANBAN_STATUS.TODO }), className: "px-3 py-1 text-xs bg-slate-600 text-slate-200 font-semibold rounded-lg hover:bg-slate-500" }, "To Do"),
                        React.createElement("button", { onClick: () => onTaskAction('move', task, { newStatus: KANBAN_STATUS.DONE }), className: `px-3 py-1 text-xs bg-green-600 text-white font-semibold rounded-lg hover:bg-green-700 ${isProcessing && 'opacity-50'}`, disabled: isProcessing }, isProcessing ? 'Completing...' : 'Complete')
                    );
                    default: return null;
                }
            };

            return React.createElement("div", { className: "bg-slate-700 border border-slate-600 p-4 rounded-lg shadow-sm flex flex-col group mb-4" },
                React.createElement("div", { className: "flex justify-between items-start" },
                    React.createElement("p", { onClick: () => onEdit(task), className: "text-slate-100 font-semibold flex-grow pr-2 cursor-pointer" }, task.text),
                    React.createElement("button", { onClick: () => onTaskAction('delete', task), className: "text-slate-500 hover:text-red-500 font-bold text-xl leading-none flex-shrink-0 opacity-0 group-hover:opacity-100" }, "×")
                ),
                React.createElement("div", { className: "mt-3 pt-3 border-t border-slate-600 text-xs text-slate-400 space-y-1.5" },
                    task.auditComment && React.createElement(InfoRow, { icon: '💬', label: 'Comment', value: React.createElement("span", { className: "text-yellow-400 font-semibold italic" }, task.auditComment) }),
                    task.taskTimestamp && React.createElement(InfoRow, { icon: '📅', label: 'Date', value: formatFullDateTime(task.taskTimestamp) }),
                    duration && React.createElement(InfoRow, { icon: '⏱️', label: task.status === KANBAN_STATUS.AUDITING ? 'Time Taken' : 'Duration', value: duration }),
                    task.status === KANBAN_STATUS.AUDITING && React.createElement(InfoRow, { icon: '✅', label: 'Completed', value: formatFullDateTime(task.workCompletedTimestamp) }),
                    task.creatorName && task.creatorName !== task.staffName && React.createElement(InfoRow, { icon: '🧑', label: 'Assigned by', value: React.createElement("span", { className: "text-red-500 font-semibold" }, task.creatorName) }),
                    task.staffName && React.createElement(InfoRow, { icon: '👤', label: 'Staff', value: task.staffName }),
                    task.shopName && React.createElement(InfoRow, { icon: '🏢', label: 'Shop', value: task.shopName })
                ),
                React.createElement("div", { className: "mt-3 pt-3 border-t border-slate-600" },
                    task.status === KANBAN_STATUS.AUDITING 
                    ? React.createElement(TaskAuditControls, { task, onTaskAction, isProcessing: processingTaskIds.has(task.id) }) 
                    : React.createElement("div", { className: "flex justify-end space-x-2" }, getMoveButtons())
                )
            );
        });

        const TaskAuditControls = ({ task, onTaskAction, isProcessing }) => {
            const { isAdmin, userRole, userShopIds } = useAuth();
            const [selectedScore, setSelectedScore] = useState('');
            const [returnComment, setReturnComment] = useState('');

            const canApprove = useMemo(() => 
                isAdmin || (userRole === ROLES.SHOP_MANAGER && task.creatorRole === ROLES.STAFF && userShopIds.includes(task.shopId)),
                [isAdmin, userRole, userShopIds, task.creatorRole, task.shopId]
            );

            const canReturn = useMemo(() => 
                isAdmin || (userRole === ROLES.SHOP_MANAGER && userShopIds.includes(task.shopId)),
                [isAdmin, userRole, userShopIds, task.shopId]
            );

            if (!canReturn) return null;

            return React.createElement("div", { className: "space-y-3" },
                React.createElement("textarea", { 
                    value: returnComment, onChange: (e) => setReturnComment(e.target.value), 
                    className: "input w-full text-sm p-2", rows: "2",
                    placeholder: "Add a comment before returning or approving..." 
                }),
                canApprove && React.createElement("select", { value: selectedScore, onChange: (e) => setSelectedScore(e.target.value), className: "input w-full text-sm p-2" },
                    React.createElement("option", {value: ""}, "Select a score..."),
                    ["30%", "50%", "70%", "90%", "100%"].map(s => React.createElement("option", { key: s, value: s }, s))
                ),
                React.createElement("div", { className: "flex justify-end items-center gap-2" }, 
                    React.createElement("button", { onClick: () => onTaskAction('move', task, { newStatus: KANBAN_STATUS.IN_PROGRESS, comment: returnComment }), className: `px-4 py-2 text-sm bg-yellow-600 text-white font-semibold rounded-lg hover:bg-yellow-700 ${(!returnComment || isProcessing) && 'opacity-50'}`, disabled: !returnComment || isProcessing }, "Return"),
                    canApprove && React.createElement("button", { onClick: () => onTaskAction('approve', task, { score: selectedScore, comment: returnComment }), className: `px-4 py-2 text-sm bg-green-600 text-white font-semibold rounded-lg hover:bg-green-700 ${(isProcessing || !selectedScore) && 'opacity-50'}`, disabled: isProcessing || !selectedScore }, isProcessing ? 'Approving...' : 'Approve')
                )
            );
        };
        
        const InfoRow = React.memo(({ icon, label, value }) => React.createElement("div", { className: "flex items-center" }, React.createElement("span", { className: "mr-2" }, icon), React.createElement("p", null, React.createElement("span", { className: "font-medium text-slate-300" }, `${label}: `), value)));
        
        // History Section
        const HistorySection = React.memo(({ openModal }) => {
            const history = useFilteredHistory();
            const { isAdmin } = useAuth();
            const [commentModal, setCommentModal] = useState({ isOpen: false, content: '' });

            const handleEditHistoryItem = useCallback((item) => openModal(item, 'history'), [openModal]);
            
            const handleDeleteHistoryItem = useCallback(async (item) => {
                if (item?.uid && item?.id) {
                    await deleteDoc(doc(db, COLLECTIONS.USERS, item.uid, COLLECTIONS.HISTORY, item.id));
                }
            }, []);

            const handleViewComment = useCallback((comment) => {
                setCommentModal({ isOpen: true, content: comment });
            }, []);
        
            const closeCommentModal = useCallback(() => {
                setCommentModal({ isOpen: false, content: '' });
            }, []);

            return React.createElement("div", null,
                React.createElement("h2", { className: "text-2xl font-bold text-slate-100 my-4" }, "Completed Tasks History"),
                React.createElement(HistoryView, { history: history, onEdit: handleEditHistoryItem, onDelete: handleDeleteHistoryItem, isAdmin: isAdmin, onViewComment: handleViewComment }),
                commentModal.isOpen && React.createElement(CommentModal, { comment: commentModal.content, onClose: closeCommentModal })
            );
        });

        const HistoryView = React.memo(({ history, onEdit, onDelete, isAdmin, onViewComment }) => {
            const { userRole } = useAuth();
            const [currentPage, setCurrentPage] = useState(1);
            const { filters, setFilters, handleFilterChange, shopOptions, staffOptions } = useAppFilters({
                date: new Date().toISOString().slice(0, 7),
                shopManagerOnly: false
            });
            
            useEffect(() => { setCurrentPage(1); }, [filters]);

            const filteredHistory = useMemo(() => history.filter(task => {
                const shopMatch = !filters.shop || task.shopName === filters.shop;
                const staffMatch = !filters.staff || task.staffName === filters.staff;
                const dateMatch = !filters.date || (task.completedTimestamp && new Date(task.completedTimestamp.seconds * 1000).toISOString().slice(0, 7) === filters.date);
                const managerOnlyMatch = !filters.shopManagerOnly || task.creatorRole === ROLES.SHOP_MANAGER;
                return shopMatch && staffMatch && dateMatch && managerOnlyMatch;
            }), [history, filters]);
            
            const ITEMS_PER_PAGE = 10;
            const totalPages = Math.ceil(filteredHistory.length / ITEMS_PER_PAGE);
            const paginatedHistory = useMemo(() => 
                filteredHistory.slice((currentPage - 1) * ITEMS_PER_PAGE, currentPage * ITEMS_PER_PAGE),
                [filteredHistory, currentPage]
            );

            const handleExport = useCallback(() => {
                const dataToExport = filteredHistory.map((task, index) => ({
                    'No': index + 1,
                    'Staff': task.staffName || 'N/A',
                    'Shop': task.shopName || 'N/A',
                    'Task': task.text,
                    'Auditor': task.auditorName || 'Auto',
                    'Score': task.auditScore || '',
                    'Duration': formatFixedDuration(task.progressTimestamp?.seconds, (task.workCompletedTimestamp || task.completedTimestamp)?.seconds),
                    'Started': formatFullDateTime(task.progressTimestamp),
                    'Completed': formatFullDateTime(task.workCompletedTimestamp || task.completedTimestamp),
                }));
                const worksheet = XLSX.utils.json_to_sheet(dataToExport);
                const workbook = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(workbook, worksheet, "Completed Tasks");
                XLSX.writeFile(workbook, `JLW_Completed_Tasks_${filters.date}.xlsx`);
            }, [filteredHistory, filters.date]);

            return React.createElement("div", { className: "bg-slate-800 p-4 sm:p-6 rounded-lg" },
                React.createElement(HistoryFilters, { filters, onFilterChange: handleFilterChange, shopOptions, staffOptions, isAdmin, userRole }),
                React.createElement("div", {className: "flex justify-end mb-4"}, 
                    React.createElement("button", { onClick: handleExport, className: "bg-green-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-green-700" }, "Export to Excel")
                ),
                React.createElement("div", { className: "overflow-x-auto" },
                    React.createElement("table", { className: "w-full text-left text-xs sm:text-sm" },
                        React.createElement(HistoryTableHeader, { isAdmin }),
                        React.createElement("tbody", { className: "divide-y divide-slate-700" },
                            paginatedHistory.map((task, index) => React.createElement(HistoryTableRow, { key: task.id, task, index: (currentPage - 1) * ITEMS_PER_PAGE + index, isAdmin, onEdit, onDelete, onViewComment }))
                        )
                    )
                ),
                React.createElement(Pagination, { currentPage, totalPages, onPageChange: setCurrentPage, totalResults: filteredHistory.length, itemsPerPage: ITEMS_PER_PAGE })
            );
        });

        const HistoryFilters = React.memo(({ filters, onFilterChange, shopOptions, staffOptions, isAdmin, userRole }) => (
            React.createElement("div", { className: "flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4" },
                React.createElement("div", { className: "w-full sm:w-auto flex flex-col sm:flex-row flex-wrap items-center gap-2 sm:gap-4" },
                    React.createElement("select", { name: "shop", value: filters.shop, onChange: onFilterChange, className: "input w-full sm:w-auto text-sm", disabled: userRole === ROLES.STAFF }, React.createElement("option", { value: "" }, "All Shops"), shopOptions.map(name => React.createElement("option", { key: name, value: name }, name))),
                    React.createElement("select", { name: "staff", value: filters.staff, onChange: onFilterChange, className: "input w-full sm:w-auto text-sm", disabled: userRole === ROLES.STAFF }, React.createElement("option", { value: "" }, "All Staff"), staffOptions.map(name => React.createElement("option", { key: name, value: name }, name))),
                    React.createElement("input", { name: "date", type: "month", value: filters.date, onChange: onFilterChange, className: "input w-full sm:w-auto text-sm" }),
                    isAdmin && React.createElement("div", {className: "flex items-center"}, React.createElement("input", { id: "historyShopManagerOnly", name: "shopManagerOnly", type: "checkbox", checked: filters.shopManagerOnly, onChange: onFilterChange, className: "h-4 w-4" }), React.createElement("label", { htmlFor: "historyShopManagerOnly", className: "ml-2 text-sm" }, "Shop Managers Only"))
                )
            )
        ));
        
        const HistoryTableHeader = React.memo(({ isAdmin }) => (
            React.createElement("thead", { className: "bg-slate-700/50" }, React.createElement("tr", null,
                ["No", "Staff", "Shop", "Task", "Comment", "Auditor", "Score", "Duration", "Started", "Completed"].map(header => React.createElement("th", { key: header, className: `px-2 py-3 sm:p-4 text-sm font-semibold text-slate-400 ${header === 'Comment' ? 'text-center' : ''}` }, header)),
                isAdmin && React.createElement("th", { className: "px-2 py-3 sm:p-4 text-sm font-semibold text-slate-400 text-right" }, "Actions")
            ))
        ));

        const HistoryTableRow = React.memo(({ task, index, isAdmin, onEdit, onDelete, onViewComment }) => (
            React.createElement("tr", { className: "hover:bg-slate-700" },
                React.createElement("td", { className: "p-2 sm:p-4" }, index + 1),
                React.createElement("td", { className: "p-2 sm:p-4" }, task.staffName || 'N/A'),
                React.createElement("td", { className: "p-2 sm:p-4" }, task.shopName || 'N/A'),
                React.createElement("td", { className: "p-2 sm:p-4" }, task.text),
                React.createElement("td", { className: "p-2 sm:p-4 text-center" },
                    task.auditComment && React.createElement("button", { className: "inline-block cursor-pointer p-1 rounded-full hover:bg-slate-600 transition-colors", title: "View Comment", onClick: () => onViewComment(task.auditComment) }, ICONS.VIEW)
                ),
                React.createElement("td", { className: "p-2 sm:p-4" }, task.auditorName || 'Auto'),
                React.createElement("td", { className: "p-2 sm:p-4 font-bold text-emerald-400" }, task.auditScore || ''),
                React.createElement("td", { className: "p-2 sm:p-4 font-medium" }, formatFixedDuration(task.progressTimestamp?.seconds, (task.workCompletedTimestamp || task.completedTimestamp)?.seconds)),
                React.createElement("td", { className: "p-2 sm:p-4 text-sm" }, formatFullDateTime(task.progressTimestamp)),
                React.createElement("td", { className: "p-2 sm:p-4 text-sm" }, formatFullDateTime(task.workCompletedTimestamp || task.completedTimestamp)),
                isAdmin && React.createElement("td", { className: "p-2 sm:p-4 text-right" },
                    React.createElement("div", { className: "flex items-center justify-end space-x-4" },
                        React.createElement("button", { onClick: () => onEdit(task), className: "text-indigo-400 hover:text-indigo-300" }, React.createElement("svg", { xmlns: "http://www.w3.org/2000/svg", width: "16", height: "16", viewBox: "0 0 24 24", fill: "none", stroke: "currentColor", strokeWidth: "2" }, React.createElement("path", { d: "M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z" }))),
                        React.createElement("button", { onClick: () => onDelete(task), className: "text-red-500 hover:text-red-400" }, React.createElement("svg", { xmlns: "http://www.w3.org/2000/svg", width: "16", height: "16", viewBox: "0 0 24 24", fill: "none", stroke: "currentColor", strokeWidth: "2" }, React.createElement("polyline", { points: "3 6 5 6 21 6" }), React.createElement("path", { d: "M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2" })))
                    )
                )
            )
        ));
        
        // Settings Page
        const SettingsPage = React.memo(() => {
            const [activeTab, setActiveTab] = useState('shops');
            const { isAdmin } = useAuth();
            return React.createElement("div", { className: "space-y-6" },
                React.createElement("h1", { className: "text-3xl font-bold text-slate-100" }, "Application Settings"),
                 React.createElement("div", { className: "flex flex-wrap gap-2 bg-slate-900 p-1 rounded-lg" },
                     React.createElement(TabButton, { tabName: "shops", title: "Shops", activeTab, setActiveTab }),
                     React.createElement(TabButton, { tabName: "staff", title: "Staff List", activeTab, setActiveTab }),
                     isAdmin && React.createElement(TabButton, { tabName: "memo", title: "Memo Alert", activeTab, setActiveTab })
                 ),
                 React.createElement("div", null,
                    activeTab === 'shops' && React.createElement(ShopSettings),
                    activeTab === 'staff' && React.createElement(StaffSettings),
                    activeTab === 'memo' && isAdmin && React.createElement(MemoSettings)
                 )
            );
        });

        const TabButton = React.memo(({ tabName, title, activeTab, setActiveTab }) => (
            React.createElement("button", {
                onClick: () => setActiveTab(tabName),
                className: `px-3 py-2 text-sm font-medium rounded-md transition-colors duration-200 flex-grow text-center sm:flex-grow-0 ${ activeTab === tabName ? 'bg-blue-600 text-white shadow-md' : 'bg-slate-700 text-slate-300 hover:bg-slate-600' }`
            }, title)
        ));

        const ShopSettings = () => {
            const { shops } = useData();
            const shopConfig = useMemo(() => ({
                formFields: [ { name: 'name', label: 'Shop Name', required: true }, { name: 'contact', label: 'Contact' }, { name: 'address', label: 'Address', fullWidth: true } ],
                listColumns: [ { header: 'Shop Name', accessor: 'name' }, { header: 'Contact', accessor: 'contact' }, { header: 'Address', accessor: 'address' } ]
            }), []);
            return React.createElement(SettingsCRUD, { title: "Shop", collectionName: COLLECTIONS.SHOPS, items: shops, ...shopConfig });
        };
        
        const StaffSettings = () => {
            const { shops, employees } = useData();
            const { isAdmin } = useAuth();
            const [isImporting, setIsImporting] = useState(false);
            const [importStatus, setImportStatus] = useState('');
            const fileInputRef = useRef(null);

            const handleDownloadTemplate = useCallback(() => {
                const ws = XLSX.utils.json_to_sheet([
                    { name: "John Doe", email: "john.d@example.com", status: "Active", role: "Staff", assignedShop: "Main Street Store", pagePermissions: "dashboard,board" },
                    {}, { Note: "--- INSTRUCTIONS ---" }, { Note: "Status: Active, Terminated, Resigned." },
                    { Note: "Role: Staff, Shop Manager." }, { Note: "assignedShop: Comma-separated list of shop names." },
                    { Note: "pagePermissions: Comma-separated list (dashboard, board, reports, settings)." }
                ]);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Staff");
                XLSX.writeFile(wb, "JLW_Staff_Template.xlsx");
            }, []);

            const handleFileImport = useCallback(async (e) => {
                const file = e.target.files[0];
                if (!file) return;
                setIsImporting(true); setImportStatus('Reading file...');
                const reader = new FileReader();
                reader.onload = async (event) => {
                    try {
                        const workbook = XLSX.read(new Uint8Array(event.target.result), { type: 'array' });
                        const json = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);
                        if (json.length === 0) throw new Error('File is empty.');
                        
                        setImportStatus(`Processing ${json.length} records...`);
                        const batch = writeBatch(db);
                        let updates = 0, additions = 0;

                        for (const row of json) {
                            if (!row.name || !row.email) continue;
                            const shopIds = shops.filter(s => (row.assignedShop || '').split(',').map(n => n.trim()).includes(s.name)).map(s => s.id);
                            const q = query(collection(db, COLLECTIONS.EMPLOYEES), where("email", "==", row.email.toLowerCase()));
                            const existing = await getDocs(q);
                            
                            const employeeData = {
                                name: row.name, email: row.email.toLowerCase(), status: row.status || 'Active', role: row.role || 'Staff',
                                assignedShops: shopIds,
                                pagePermissions: (isAdmin && row.pagePermissions) ? row.pagePermissions.split(',').map(p => p.trim()) : []
                            };
                            
                            if (!existing.empty) {
                                batch.update(doc(db, COLLECTIONS.EMPLOYEES, existing.docs[0].id), employeeData);
                                updates++;
                            } else {
                                batch.set(doc(collection(db, COLLECTIONS.EMPLOYEES)), employeeData);
                                additions++;
                            }
                        }
                        await batch.commit();
                        setImportStatus(`Import complete! Added: ${additions}, Updated: ${updates}.`);
                    } catch (error) {
                        console.error("Import Error:", error);
                        setImportStatus('An error occurred during import.');
                    } finally {
                        setIsImporting(false);
                        if(fileInputRef.current) fileInputRef.current.value = "";
                        setTimeout(() => setImportStatus(''), 5000);
                    }
                };
                reader.readAsArrayBuffer(file);
            }, [shops, isAdmin]);

            const staffConfig = useMemo(() => {
                const roleOptions = [
                    {id: ROLES.SHOP_MANAGER, name: ROLES.SHOP_MANAGER},
                    {id: ROLES.STAFF, name: ROLES.STAFF}
                ];
                if (isAdmin) {
                    roleOptions.push({id: 'admin', name: ROLES.ADMIN});
                }

                const fields = [
                    { name: 'name', label: 'Staff Name', required: true }, { name: 'email', label: 'Staff Email (login)', type: 'email', required: true },
                    { name: 'status', label: 'Status', type: 'select', options: [{id: 'Active', name: 'Active'}, {id: 'Terminated', name: 'Terminated'}, {id: 'Resigned', name: 'Resigned'}], required: true, defaultValue: 'Active' },
                    { name: 'role', label: 'Role', type: 'select', options: roleOptions, required: true },
                    { name: 'assignedShops', label: 'Assigned Shop(s)', type: 'checkbox-group', options: shops },
                ];
                if (isAdmin) fields.push({ name: 'pagePermissions', label: 'Permissions', type: 'checkbox-group', options: [{ id: 'dashboard', name: 'Dashboard' }, { id: 'board', name: 'Task Manager' }, {id: 'reports', name: 'Reports'}, { id: 'settings', name: 'Settings' }], fullWidth: true });
                return {
                    formFields: fields,
                    listColumns: [
                        { header: 'Name', accessor: 'name' }, { header: 'Email', accessor: 'email' }, { header: 'Status', accessor: 'status' }, { header: 'Role', accessor: 'role' },
                        { header: 'Shop(s)', accessor: 'assignedShops', render: (item) => (item.assignedShops || []).map(id => shops.find(s => s.id === id)?.name).join(', ') || 'N/A' },
                        { header: 'Permissions', accessor: 'pagePermissions', render: (item) => (item.pagePermissions || []).join(', ') || 'None' }
                    ]
                }
            }, [shops, isAdmin]);
            
            const headerActions = React.createElement(React.Fragment, null,
                React.createElement("input", { type: "file", ref: fileInputRef, onChange: handleFileImport, className: "hidden", accept: ".xlsx,.xls" }),
                React.createElement("button", { onClick: () => fileInputRef.current?.click(), className: "bg-green-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-green-700 disabled:opacity-50", disabled: isImporting }, isImporting ? 'Importing...' : 'Import Excel'),
                React.createElement("button", { onClick: handleDownloadTemplate, className: "bg-slate-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-slate-500" }, "Download Template")
            );

            return React.createElement(React.Fragment, null,
                importStatus && React.createElement("div", { className: `mb-4 p-3 rounded-lg text-sm ${importStatus.startsWith('Error') ? 'bg-red-900/50 text-red-400' : 'bg-slate-700 text-slate-200'}` }, importStatus),
                React.createElement(SettingsCRUD, { title: "Staff", collectionName: COLLECTIONS.EMPLOYEES, items: employees, ...staffConfig, headerActions })
            );
        };

        const MemoSettings = () => {
            const { memo } = useData();
            const [message, setMessage] = useState('');
            const [targetRole, setTargetRole] = useState('none');
            const [status, setStatus] = useState('');

            useEffect(() => { if (memo) { setMessage(memo.message || ''); setTargetRole(memo.targetRole || 'none'); } }, [memo]);

            const handleSaveMemo = useCallback(async (e) => {
                e.preventDefault();
                setStatus('Saving...');
                try {
                    await setDoc(doc(db, COLLECTIONS.SETTINGS, 'memo'), { message, isActive: targetRole !== 'none', targetRole });
                    setStatus('Memo saved successfully!');
                } catch (error) { setStatus('Error saving memo.'); }
                setTimeout(() => setStatus(''), 3000);
            }, [message, targetRole]);

            return React.createElement("div", { className: "bg-slate-800 p-6 rounded-lg" },
                React.createElement("h2", { className: "text-2xl font-semibold mb-4 text-slate-100" }, "Memo Alert Management"),
                React.createElement("form", { onSubmit: handleSaveMemo, className: "space-y-4" },
                    React.createElement("textarea", { value: message, onChange: (e) => setMessage(e.target.value), className: "input", rows: "4", placeholder: "Enter the memo..." }),
                    React.createElement("fieldset", { className: "flex items-center space-x-6" },
                        React.createElement(RadioOption, { id: "memoAll", value: "all", label: "All", checked: targetRole === 'all', onChange: (e) => setTargetRole(e.target.value) }),
                        React.createElement(RadioOption, { id: "memoManager", value: "shopManager", label: "Shop Managers", checked: targetRole === 'shopManager', onChange: (e) => setTargetRole(e.target.value) }),
                        React.createElement(RadioOption, { id: "memoNone", value: "none", label: "Deactivate", checked: targetRole === 'none', onChange: (e) => setTargetRole(e.target.value) })
                    ),
                    React.createElement("div", { className: "flex items-center gap-4" },
                        React.createElement("button", { type: "submit", className: "bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-700" }, "Save Memo"),
                        status && React.createElement("p", { className: "text-sm text-green-400" }, status)
                    )
                )
            );
        };
        
        // --- Reusable & Generic Components ---
        const LoadingSpinner = ({ text = "Loading..." }) => React.createElement("div", { className: "flex flex-col justify-center items-center h-screen" }, React.createElement("svg", { className: "animate-spin h-8 w-8 text-blue-500", fill: "none", viewBox: "0 0 24 24" }, React.createElement("circle", { className: "opacity-25", cx: "12", cy: "12", r: "10", stroke: "currentColor", strokeWidth: "4" }), React.createElement("path", { className: "opacity-75", fill: "currentColor", d: "M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z" })), React.createElement("p", { className: "text-lg font-semibold text-slate-300 mt-4" }, text));

        const Login = React.memo(() => {
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [rememberMe, setRememberMe] = useState(false);
            const [error, setError] = useState('');
            const [showPassword, setShowPassword] = useState(false);

            const handleLogin = useCallback(async (e) => {
                e.preventDefault(); setError('');
                try {
                    await setPersistence(auth, rememberMe ? browserLocalPersistence : browserSessionPersistence);
                    await signInWithEmailAndPassword(auth, email, password);
                } catch (err) {
                    const messages = { 'auth/invalid-email': 'Please enter a valid email.', 'auth/invalid-credential': 'Invalid email or password.', 'auth/too-many-requests': 'Access temporarily disabled.' };
                    setError(messages[err.code] || 'An unknown error occurred.');
                }
            }, [email, password, rememberMe]);

            return React.createElement("div", { className: "flex items-center justify-center min-h-screen p-4" },
                React.createElement("div", { className: "w-full max-w-5xl bg-slate-800 rounded-2xl shadow-2xl flex flex-col md:flex-row overflow-hidden" },
                    React.createElement("div", { className: "w-full md:w-1/2 bg-slate-900 p-8 sm:p-12 flex-col justify-center items-center text-white hidden md:flex" },
                        React.createElement("div", { className: "max-w-xs text-center" },
                            React.createElement("svg", { className: "w-32 h-32 mx-auto mb-6 text-blue-500", viewBox: "0 0 512 512", fill: "currentColor" }, React.createElement("path", { d: "M368 128H144c-17.7 0-32 14.3-32 32v256c0 17.7 14.3 32 32 32h224c17.7 0 32-14.3 32-32V160c0-17.7-14.3-32-32-32zM256 64c13.3 0 26.3 4.8 36.8 12.8l43.4 32.7c4.6 3.4 10.5 3.1 14.5-0.9l14-14c4-4 5.7-9.6 4.3-14.7C359.1 43.8 322.2 16 280 16 222.2 16 176 62.2 176 120v8h32v-8c0-35.7 20.3-56 48-56z" })),
                            React.createElement("h2", { className: "text-3xl font-bold leading-tight" }, "Streamline Your Workflow"),
                            React.createElement("p", { className: "mt-2 text-slate-300" }, "Manage tasks, track progress, and collaborate efficiently.")
                        )
                    ),
                    React.createElement("div", { className: "w-full md:w-1/2 p-8 sm:p-12 flex flex-col justify-center" },
                        React.createElement("div", { className: "w-full max-w-sm mx-auto" },
                            React.createElement("h2", { className: "text-3xl font-bold text-slate-100" }, "JLW Task Tracker"),
                            React.createElement("p", { className: "mt-2 text-slate-400" }, "Internal Use Only. Sign in to continue."),
                            React.createElement("form", { onSubmit: handleLogin, className: "mt-8 space-y-6" },
                                error && React.createElement("div", { className: "p-3 bg-red-900/50 text-red-400 rounded-md text-sm" }, error),
                                React.createElement("input", { type: "email", value: email, onChange: (e) => setEmail(e.target.value), placeholder: "Email Address", required: true, className: "input" }),
                                React.createElement("div", { className: "relative" },
                                    React.createElement("input", { type: showPassword ? "text" : "password", value: password, onChange: (e) => setPassword(e.target.value), placeholder: "Password", required: true, className: "input pr-10" }),
                                    React.createElement("button", { type: "button", onClick: () => setShowPassword(s => !s), className: "absolute inset-y-0 right-0 pr-3 flex items-center text-slate-400 hover:text-slate-200" }, React.createElement("svg", { className:"h-5 w-5", fill:"currentColor", viewBox:"0 0 20 20" }, showPassword ? React.createElement("path", { d:"M10 12a2 2 0 100-4 2 2 0 000 4z" }) : React.createElement("path", { d:"M13.875 1.125l-1.47-1.47a.75.75 0 00-1.06 0L.93 11.07a.75.75 0 000 1.06l1.47 1.47a.75.75 0 001.06 0L13.875 2.185a.75.75 0 000-1.06zM9 13a4 4 0 110-8 4 4 0 010 8z" })))
                                ),
                                React.createElement("div", { className: "flex items-center" },
                                    React.createElement("input", { id: "remember-me", type: "checkbox", checked: rememberMe, onChange: (e) => setRememberMe(e.target.checked), className: "h-4 w-4" }),
                                    React.createElement("label", { htmlFor: "remember-me", className: "ml-2 block text-sm text-slate-300" }, "Remember me")
                                ),
                                React.createElement("button", { type: "submit", className: "w-full py-3 px-4 rounded-md font-medium text-white bg-blue-600 hover:bg-blue-700" }, "Sign in")
                            )
                        )
                    )
                )
            );
        });

        const Pagination = React.memo(({ currentPage, totalPages, onPageChange, totalResults, itemsPerPage }) => {
            if (totalPages <= 1) return null;
            const startIndex = (currentPage - 1) * itemsPerPage + 1;
            const endIndex = Math.min(startIndex + itemsPerPage - 1, totalResults);
            
            const handlePageClick = (page) => {
                if (page >= 1 && page <= totalPages) {
                    onPageChange(page);
                }
            };
            
            return React.createElement("div", { className: "mt-4 flex flex-col sm:flex-row justify-between items-center text-sm text-slate-400" },
                React.createElement("p", null, `Showing ${startIndex} to ${endIndex} of ${totalResults} results`),
                React.createElement("div", { className: "flex items-center mt-2 sm:mt-0" },
                    React.createElement("button", { onClick: () => handlePageClick(currentPage - 1), disabled: currentPage === 1, className: "px-3 py-1 rounded-md hover:bg-slate-700 disabled:opacity-50 disabled:cursor-not-allowed" }, "Previous"),
                    React.createElement("span", { className: "px-4" }, `Page ${currentPage} of ${totalPages}`),
                    React.createElement("button", { onClick: () => handlePageClick(currentPage + 1), disabled: currentPage === totalPages, className: "px-3 py-1 rounded-md hover:bg-slate-700 disabled:opacity-50 disabled:cursor-not-allowed" }, "Next")
                )
            );
        });
        
        const CommentModal = ({ comment, onClose }) => {
            return React.createElement("div", { className: "modal-overlay", onClick: onClose },
                React.createElement("div", { className: "modal-content", onClick: e => e.stopPropagation() },
                    React.createElement("h2", { className: "text-xl font-bold mb-4 text-slate-100" }, "View Comment"),
                    React.createElement("p", { className: "text-slate-300 bg-slate-700 p-4 rounded-lg whitespace-pre-wrap max-h-[60vh] overflow-y-auto" }, comment),
                    React.createElement("div", { className: "mt-6 flex justify-end" },
                        React.createElement("button", { type: "button", onClick: onClose, className: "bg-slate-600 px-4 py-2 rounded-lg hover:bg-slate-500" }, "Close")
                    )
                )
            );
        };

        const TaskModal = ({ itemToEdit, context, onClose }) => {
            const { user, userName, userShop, userRole, userShopIds } = useAuth();
            const { shops, employees } = useData();
            const isEditing = !!itemToEdit;
            const canAssign = (userRole === ROLES.ADMIN || userRole === ROLES.SHOP_MANAGER) && !isEditing;
            const [isAssigningEnabled, setIsAssigningEnabled] = useState(canAssign);

            const getInitialState = useCallback(() => {
                const d = itemToEdit?.taskTimestamp ? new Date(itemToEdit.taskTimestamp.seconds ? itemToEdit.taskTimestamp.seconds * 1000 : itemToEdit.taskTimestamp) : new Date();
                
                let initialStaffName = '';
                if (isEditing) initialStaffName = itemToEdit.staffName || '';
                else if (userRole === ROLES.STAFF) initialStaffName = userName;
                else if (canAssign && !isAssigningEnabled) initialStaffName = userName;

                return {
                    text: itemToEdit?.text || '', date: d.toISOString().split('T')[0], time: d.toTimeString().slice(0, 5),
                    staffName: initialStaffName,
                    shopName: itemToEdit?.shopName || (userRole === ROLES.STAFF ? userShop : ''),
                };
            }, [itemToEdit, userName, userShop, userRole, canAssign, isAssigningEnabled, isEditing]);

            const [taskData, setTaskData] = useState(getInitialState);

            useEffect(() => {
                if (canAssign) {
                    setTaskData(prev => ({ ...prev, staffName: isAssigningEnabled ? '' : userName }));
                }
            }, [isAssigningEnabled, canAssign, userName]);

            const shopOptions = useMemo(() => {
                if (userRole === ROLES.ADMIN) return shops;
                if (userRole === ROLES.SHOP_MANAGER) return shops.filter(s => userShopIds.includes(s.id));
                return [];
            }, [shops, userRole, userShopIds]);
            
            const staffOptions = useMemo(() => {
                if (!canAssign || !isAssigningEnabled || !taskData.shopName) return [];
                const selectedShopId = shops.find(s => s.name === taskData.shopName)?.id;
                if (!selectedShopId) return [];

                return employees.filter(e => e.status === 'Active' && e.assignedShops?.includes(selectedShopId));
            }, [employees, shops, taskData.shopName, canAssign, isAssigningEnabled]);

            const handleChange = useCallback((e) => { 
                const { name, value } = e.target;
                setTaskData(prev => {
                    const newState = {...prev, [name]: value};
                    if (name === 'shopName' && canAssign) newState.staffName = isAssigningEnabled ? '' : userName;
                    return newState;
                });
            }, [isAssigningEnabled, userName, canAssign]);

            const handleSubmit = useCallback(async (e) => {
                e.preventDefault();
                if (!taskData.text.trim()) return;

                const selectedShop = shops.find(s => s.name === taskData.shopName);
                const dataToSave = {
                    text: taskData.text, staffName: taskData.staffName, shopName: taskData.shopName,
                    taskTimestamp: `${taskData.date}T${taskData.time}`, shopId: selectedShop?.id || null,
                };
                
                try {
                    if (context === 'history' && isEditing) {
                        await updateDoc(doc(db, COLLECTIONS.USERS, itemToEdit.uid, COLLECTIONS.HISTORY, itemToEdit.id), dataToSave);
                    } else if (isEditing) {
                        await updateDoc(doc(db, COLLECTIONS.USERS, itemToEdit.uid, COLLECTIONS.TASKS, itemToEdit.id), dataToSave);
                    } else { // Adding a new task
                        let assigneeUid = user.uid;
                        let assigneeEmail = user.email;

                        if (canAssign && isAssigningEnabled) {
                            const assignee = employees.find(e => e.name === taskData.staffName);
                            if (!assignee?.uid) {
                                alert("Selected staff has not logged in yet and cannot be assigned tasks.");
                                return;
                            }
                            assigneeUid = assignee.uid;
                            assigneeEmail = assignee.email;
                        }
                        
                        await addDoc(collection(db, COLLECTIONS.USERS, assigneeUid, COLLECTIONS.TASKS), { 
                            ...dataToSave, status: KANBAN_STATUS.TODO, createdAt: serverTimestamp(), 
                            userEmail: assigneeEmail, creatorRole: userRole, creatorName: userName
                        });
                    }
                    onClose();
                } catch(error) { console.error("Error saving task: ", error); }
            }, [taskData, context, itemToEdit, user, userRole, userName, onClose, shops, employees, isEditing, canAssign, isAssigningEnabled]);

            const renderShopInput = () => {
                if ((userRole === ROLES.ADMIN || userRole === ROLES.SHOP_MANAGER) && !isEditing) {
                    return React.createElement("select", { name: "shopName", value: taskData.shopName, onChange: handleChange, className: "input", required: true },
                        React.createElement("option", { value: "" }, "Select Shop"),
                        shopOptions.map(s => React.createElement("option", { key: s.id, value: s.name }, s.name))
                    );
                }
                return React.createElement("input", { value: taskData.shopName, className: "input", disabled: true });
            };

            const renderStaffInput = () => {
                if (canAssign && isAssigningEnabled) {
                    return React.createElement("select", { name: "staffName", value: taskData.staffName, onChange: handleChange, className: "input", required: true, disabled: !taskData.shopName },
                        React.createElement("option", { value: "" }, staffOptions.length > 0 ? "Select Staff" : "No staff in this shop"),
                        staffOptions.map(e => React.createElement("option", { key: e.id, value: e.name, disabled: !e.uid }, `${e.name}${!e.uid ? ' (needs login)' : ''}`))
                    );
                }
                return React.createElement("input", { value: taskData.staffName, className: "input", disabled: true });
            };

            return React.createElement("div", { className: "modal-overlay", onClick: onClose },
                React.createElement("div", { className: "modal-content", onClick: e => e.stopPropagation() },
                    React.createElement("h2", { className: "text-2xl font-bold mb-6" }, isEditing ? `Edit ${context}` : 'Add New Task'),
                    React.createElement("form", { onSubmit: handleSubmit, className: "space-y-4" },
                        React.createElement("div", { className: "grid grid-cols-2 gap-4"},
                            React.createElement("div", null, React.createElement("label", { className: "text-sm font-medium" }, "Date"), React.createElement("input", { name: "date", type: "date", value: taskData.date, onChange: handleChange, className: "input", required: true })),
                            React.createElement("div", null, React.createElement("label", { className: "text-sm font-medium" }, "Time"), React.createElement("input", { name: "time", type: "time", value: taskData.time, onChange: handleChange, className: "input", required: true }))
                        ),
                        canAssign && React.createElement("div", { className: "flex items-center pt-2" },
                            React.createElement("input", { type: "checkbox", id: "assign-task-checkbox", checked: isAssigningEnabled, onChange: e => setIsAssigningEnabled(e.target.checked), className: "h-4 w-4 rounded border-slate-500 bg-slate-600 text-blue-500 focus:ring-blue-600" }),
                            React.createElement("label", { htmlFor: "assign-task-checkbox", className: "ml-2 text-sm font-medium" }, "Assign Task to Staff")
                        ),
                        React.createElement("div", null, React.createElement("label", { className: "text-sm font-medium" }, "Shop"), renderShopInput()),
                        React.createElement("div", null, React.createElement("label", { className: "text-sm font-medium" }, "Staff"), renderStaffInput()),
                        React.createElement("textarea", { name: "text", value: taskData.text, onChange: handleChange, className: "input", rows: "3", placeholder: "Task Description...", required: true }),
                        React.createElement("div", { className: "mt-6 flex justify-end space-x-4" },
                            React.createElement("button", { type: "button", onClick: onClose, className: "bg-slate-600 px-4 py-2 rounded-lg" }, "Cancel"),
                            React.createElement("button", { type: "submit", className: "bg-blue-600 text-white px-4 py-2 rounded-lg" }, "Save Task")
                        )
                    )
                )
            );
        };
        
        const SettingsCRUD = ({ title, collectionName, items, formFields, listColumns, headerActions }) => {
            const [editingItem, setEditingItem] = useState(null);
            const [searchTerm, setSearchTerm] = useState('');
            const [formState, setFormState] = useState({});
            const [isModalOpen, setIsModalOpen] = useState(false);

            const openModal = useCallback((item = null) => {
                setEditingItem(item);
                const initialState = formFields.reduce((acc, field) => {
                    let value = item ? (field.accessor ? item[field.accessor] : item[field.name]) : (field.defaultValue || '');
                    if (field.type === 'checkbox-group' && !Array.isArray(value)) value = [];
                    acc[field.name] = value;
                    return acc;
                }, {});
                setFormState(initialState);
                setIsModalOpen(true);
            }, [formFields]);

            const closeModal = useCallback(() => setIsModalOpen(false), []);

            const handleChange = useCallback((e) => {
                const { name, value, type, checked } = e.target;
                setFormState(prev => {
                    if (type === 'checkbox') {
                        const currentValues = prev[name] || [];
                        if (checked) return { ...prev, [name]: [...currentValues, value] };
                        return { ...prev, [name]: currentValues.filter(v => v !== value) };
                    }
                    return { ...prev, [name]: value };
                });
            }, []);

            const handleSubmit = useCallback(async (e) => {
                e.preventDefault();
                try {
                    const dataToSave = { ...formState };
                    if (collectionName === COLLECTIONS.EMPLOYEES && dataToSave.email) {
                        dataToSave.email = dataToSave.email.toLowerCase();
                    }
                    if (editingItem) {
                        await updateDoc(doc(db, collectionName, editingItem.id), dataToSave);
                    } else {
                        await addDoc(collection(db, collectionName), dataToSave);
                    }
                    closeModal();
                } catch (error) { console.error(`Error saving ${title}:`, error); }
            }, [formState, editingItem, collectionName, title, closeModal]);

            const handleDelete = useCallback(async (id) => {
                if (window.confirm(`Are you sure you want to delete this ${title}?`)) {
                    try { await deleteDoc(doc(db, collectionName, id)); } catch(e) { console.error(e); }
                }
            }, [collectionName, title]);

            const filteredItems = useMemo(() => items.filter(item => 
                Object.values(item).some(val => String(val).toLowerCase().includes(searchTerm.toLowerCase()))
            ), [items, searchTerm]);
            
            return React.createElement("div", { className: "bg-slate-800 p-6 rounded-lg" },
                React.createElement("div", { className: "flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 gap-4" },
                    React.createElement("h2", { className: "text-2xl font-semibold text-slate-100" }, `${title} Management`),
                    React.createElement("div", { className: "flex items-center gap-2" }, headerActions),
                    React.createElement("button", { onClick: () => openModal(), className: "bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-700" }, `+ Add New ${title}`)
                ),
                React.createElement("input", { type: "text", placeholder: `Search ${title}s...`, value: searchTerm, onChange: e => setSearchTerm(e.target.value), className: "input mb-4" }),
                React.createElement("div", { className: "overflow-x-auto" },
                    React.createElement("table", { className: "w-full text-left" },
                        React.createElement("thead", { className: "bg-slate-700/50" }, React.createElement("tr", null,
                            listColumns.map(col => React.createElement("th", { key: col.header, className: "px-4 py-3 text-sm font-semibold text-slate-400" }, col.header)),
                            React.createElement("th", { className: "px-4 py-3 text-sm font-semibold text-slate-400 text-right" }, "Actions")
                        )),
                        React.createElement("tbody", { className: "divide-y divide-slate-700" },
                            filteredItems.map(item => React.createElement("tr", { key: item.id, className: "hover:bg-slate-700" },
                                listColumns.map(col => React.createElement("td", { key: col.accessor, className: "px-4 py-3 text-sm" }, col.render ? col.render(item) : item[col.accessor])),
                                React.createElement("td", { className: "px-4 py-3 text-sm text-right" },
                                    React.createElement("button", { onClick: () => openModal(item), className: "text-indigo-400 hover:text-indigo-300 mr-4" }, "Edit"),
                                    React.createElement("button", { onClick: () => handleDelete(item.id), className: "text-red-500 hover:text-red-400" }, "Delete")
                                )
                            ))
                        )
                    )
                ),
                isModalOpen && React.createElement("div", { className: "modal-overlay", onClick: closeModal },
                    React.createElement("div", { className: "modal-content", onClick: e => e.stopPropagation() },
                        React.createElement("h2", { className: "text-2xl font-bold mb-6" }, `${editingItem ? 'Edit' : 'Add'} ${title}`),
                        React.createElement("form", { onSubmit: handleSubmit, className: "space-y-4" },
                            React.createElement("div", { className: `grid grid-cols-1 ${formFields.some(f => !f.fullWidth) ? 'sm:grid-cols-2' : ''} gap-4` },
                                formFields.map(field => React.createElement(FormField, { key: field.name, field, value: formState[field.name], onChange: handleChange }))
                            ),
                            React.createElement("div", { className: "mt-6 flex justify-end space-x-4" },
                                React.createElement("button", { type: "button", onClick: closeModal, className: "bg-slate-600 px-4 py-2 rounded-lg" }, "Cancel"),
                                React.createElement("button", { type: "submit", className: "bg-blue-600 text-white px-4 py-2 rounded-lg" }, `Save ${title}`)
                            )
                        )
                    )
                )
            );
        };
        
        const FormField = ({ field, value, onChange }) => {
            const className = field.fullWidth ? "sm:col-span-2" : "";
            const commonProps = { name: field.name, onChange, required: field.required, className: "input" };
            return React.createElement("div", { className },
                React.createElement("label", { htmlFor: field.name, className: "text-sm font-medium" }, field.label),
                field.type === 'select' ?
                    React.createElement("select", { ...commonProps, id: field.name, value: value || field.defaultValue || '' },
                        React.createElement("option", { value: "" }, `Select a ${field.label}...`),
                        field.options.map(opt => React.createElement("option", { key: opt.id, value: opt.id }, opt.name))
                    ) : field.type === 'checkbox-group' ?
                    React.createElement("div", { className: "checkbox-group" },
                        field.options.map(opt => React.createElement("div", { key: opt.id, className: "flex items-center" },
                            React.createElement("input", { type: "checkbox", id: `${field.name}-${opt.id}`, name: field.name, value: opt.id, checked: (value || []).includes(opt.id), onChange, className: "h-4 w-4" }),
                            React.createElement("label", { htmlFor: `${field.name}-${opt.id}`, className: "ml-2 text-sm" }, opt.name)
                        ))
                    ) :
                    React.createElement("input", { ...commonProps, id: field.name, type: field.type || 'text', value: value || '' })
            );
        };
        
        const MemoAlert = () => {
            const { memo } = useData();
            const { userRole } = useAuth();
            const [isVisible, setIsVisible] = useState(false);

            useEffect(() => {
                const shouldShow = memo?.isActive && (memo.targetRole === 'all' || (memo.targetRole === 'shopManager' && userRole === ROLES.SHOP_MANAGER));
                setIsVisible(shouldShow);
            }, [memo, userRole]);

            if (!isVisible) return null;

            return React.createElement("div", { className: "fixed bottom-4 right-4 z-50 w-full max-w-sm p-4 bg-yellow-400 text-yellow-900 rounded-lg shadow-lg notification" },
                React.createElement("div", { className: "flex justify-between items-center" },
                    React.createElement("p", { className: "font-semibold" }, memo.message),
                    React.createElement("button", { onClick: () => setIsVisible(false), className: "ml-4 font-bold text-xl" }, "×")
                )
            );
        };

        const RadioOption = React.memo(({ id, value, label, checked, onChange }) => React.createElement("div", { className: "flex items-center" },
            React.createElement("input", { type: "radio", id, name: "memoTarget", value, checked, onChange, className: "h-4 w-4" }),
            React.createElement("label", { htmlFor: id, className: "ml-2 text-sm" }, label)
        ));

        // --- Render Application ---
        const root = ReactDOM.createRoot(document.getElementById("root"));
        root.render(
            React.createElement(AuthProvider, null,
                React.createElement(DataProvider, null,
                    React.createElement(App)
                )
            )
        );
    </script>
</body>
</html>



