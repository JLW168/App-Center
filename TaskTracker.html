<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JLW Task Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; }
        .sortable-ghost { background: #334155; border-radius: 0.5rem; }
        .sortable-drag { opacity: 1 !important; }
        .task-card { transition: background-color 0.2s ease-in-out, box-shadow 0.2s ease-in-out; }
        .kanban-column-body::-webkit-scrollbar, .checkbox-group::-webkit-scrollbar { width: 8px; }
        .kanban-column-body::-webkit-scrollbar-track, .checkbox-group::-webkit-scrollbar-track { background: #1e293b; border-radius: 10px; }
        .kanban-column-body::-webkit-scrollbar-thumb, .checkbox-group::-webkit-scrollbar-thumb { background: #475569; border-radius: 10px; }
        .kanban-column-body::-webkit-scrollbar-thumb:hover, .checkbox-group::-webkit-scrollbar-thumb:hover { background: #64748b; }
        .modal-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex; justify-content: center; align-items: center;
            z-index: 50; padding: 1rem;
        }
        .modal-content {
            background-color: #1e293b; padding: 1.5rem; border-radius: 0.5rem;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1); width: 100%; max-width: 500px;
        }
        .input {
            margin-top: 0.25rem; display: block; width: 100%;
            padding: 0.75rem; border-width: 1px; border-color: #475569;
            border-radius: 0.375rem; box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            transition: border-color 0.2s, box-shadow 0.2s;
            background-color: #334155; color: #e2e8f0;
        }
        .input:focus {
            outline: 2px solid transparent; outline-offset: 2px;
            border-color: #3B82F6; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.3);
        }
        .checkbox-group {
            max-height: 150px; overflow-y: auto; border: 1px solid #475569;
            border-radius: 0.375rem; padding: 0.75rem; margin-top: 0.25rem;
            background-color: #334155;
        }
    </style>
</head>
<body class="bg-slate-900 text-slate-300">
    <div id="root"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, setPersistence, browserSessionPersistence, browserLocalPersistence, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, getDocs, addDoc, doc, getDoc, updateDoc, deleteDoc, onSnapshot, serverTimestamp, query, where, orderBy, collectionGroup, limit } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import React, { useState, useEffect, useRef, createContext, useContext, useMemo, useCallback } from "https://esm.sh/react@18.2.0";
        import ReactDOM from "https://esm.sh/react-dom@18.2.0/client";

        const firebaseConfig = {
            apiKey: "AIzaSyBNb5ZI9XIWWSpxGD-FeV94K5FMc2a8udU",
            authDomain: "hr-manager-84ada.firebaseapp.com",
            projectId: "hr-manager-84ada",
            storageBucket: "hr-manager-84ada.firebasestorage.app",
            messagingSenderId: "365563456537",
            appId: "1:365563456537:web:9c5a6fbce7710b4c72ce88",
            measurementId: "G-51R9KT7LC1"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        // --- ICONS ---
        const icons = {
            dashboard: React.createElement("svg", { xmlns: "http://www.w3.org/2000/svg", width: "24", height: "24", viewBox: "0 0 24 24", fill: "none", stroke: "currentColor", strokeWidth: "2", strokeLinecap: "round", strokeLinejoin: "round" }, React.createElement("rect", { x: "3", y: "3", width: "7", height: "7" }), React.createElement("rect", { x: "14", y: "3", width: "7", height: "7" }), React.createElement("rect", { x: "14", y: "14", width: "7", height: "7" }), React.createElement("rect", { x: "3", y: "14", width: "7", height: "7" })),
            board: React.createElement("svg", { xmlns: "http://www.w3.org/2000/svg", width: "24", height: "24", viewBox: "0 0 24 24", fill: "none", stroke: "currentColor", strokeWidth: "2", strokeLinecap: "round", strokeLinejoin: "round" }, React.createElement("rect", { x: "3", y: "3", width: "18", height: "18", rx: "2", ry: "2" }), React.createElement("line", { x1: "9", y1: "3", x2: "9", y2: "21" }), React.createElement("line", { x1: "15", y1: "3", x2: "15", y2: "21" })),
            history: React.createElement("svg", { xmlns: "http://www.w3.org/2000/svg", width: "24", height: "24", viewBox: "0 0 24 24", fill: "none", stroke: "currentColor", strokeWidth: "2", strokeLinecap: "round", strokeLinejoin: "round" }, React.createElement("path", { d: "M1 4v6h6" }), React.createElement("path", { d: "M3.51 15a9 9 0 1 0 2.13-9.36L1 10" })),
            settings: React.createElement("svg", { xmlns: "http://www.w3.org/2000/svg", width: "24", height: "24", viewBox: "0 0 24 24", fill: "none", stroke: "currentColor", strokeWidth: "2", strokeLinecap: "round", strokeLinejoin: "round" }, React.createElement("path", { d: "M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 0 2l-.15.08a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.38a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1 0-2l.15-.08a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z" }), React.createElement("circle", { cx: "12", cy: "12", r: "3" })),
            logout: React.createElement("svg", { xmlns: "http://www.w3.org/2000/svg", width: "24", height: "24", viewBox: "0 0 24 24", fill: "none", stroke: "currentColor", strokeWidth: "2", strokeLinecap: "round", strokeLinejoin: "round" }, React.createElement("path", { d: "M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4" }), React.createElement("polyline", { points: "16 17 21 12 16 7" }), React.createElement("line", { x1: "21", y1: "12", x2: "9", y2: "12" })),
            menu: React.createElement("svg", { xmlns: "http://www.w3.org/2000/svg", width: "24", height: "24", viewBox: "0 0 24 24", fill: "none", stroke: "currentColor", strokeWidth: "2", strokeLinecap: "round", strokeLinejoin: "round" }, React.createElement("line", { x1: "3", y1: "12", x2: "21", y2: "12" }), React.createElement("line", { x1: "3", y1: "6", x2: "21", y2: "6" }), React.createElement("line", { x1: "3", y1: "18", x2: "21", y2: "18" }))
        };

        // --- AUTHENTICATION ---
        const AuthContext = createContext();
        const AuthProvider = ({ children }) => {
            const [user, setUser] = useState(null);
            const [loading, setLoading] = useState(true);
            const [isAdmin, setIsAdmin] = useState(false);
            const [permissions, setPermissions] = useState([]);

            useEffect(() => {
                const unsubscribe = onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        const isAdminUser = user.email === 'jlw@jlw.com';
                        setUser(user);
                        setIsAdmin(isAdminUser);

                        if (isAdminUser) {
                            setPermissions(['dashboard', 'board', 'history', 'settings']);
                        } else {
                            const supervisorsRef = collection(db, "supervisors");
                            const q = query(supervisorsRef, where("email", "==", user.email));
                            const querySnapshot = await getDocs(q);
                            
                            if (!querySnapshot.empty) {
                                const supervisorData = querySnapshot.docs[0].data();
                                const basePermissions = ['dashboard']; 
                                const userPermissions = supervisorData.pagePermissions || [];
                                setPermissions([...new Set([...basePermissions, ...userPermissions])]);
                            } else {
                                setPermissions(['dashboard', 'board', 'history']);
                            }
                        }
                    } else {
                        setUser(null);
                        setIsAdmin(false);
                        setPermissions([]);
                    }
                    setLoading(false);
                });
                return () => unsubscribe();
            }, []);

            const authValue = { user, isAdmin, loading, permissions };

            return React.createElement(AuthContext.Provider, { value: authValue }, children);
        };
        const useAuth = () => useContext(AuthContext);

        // --- HOOKS for data fetching ---
        const useTasks = () => {
            const { user, isAdmin } = useAuth();
            const [tasks, setTasks] = useState([]);
            useEffect(() => {
                if (!user) return;
                const q = isAdmin ? query(collectionGroup(db, 'tasks')) : query(collection(db, 'users', user.uid, 'tasks'));
                const unsubscribe = onSnapshot(q, (snapshot) => {
                    const tasksData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data(), uid: doc.ref.path.split('/')[1] }));
                    setTasks(tasksData);
                });
                return () => unsubscribe();
            }, [user, isAdmin]);
            return tasks;
        };

        const useHistory = () => {
            const { user, isAdmin } = useAuth();
            const [history, setHistory] = useState([]);
            useEffect(() => {
                if (!user) return;
                // For admin, query without ordering to avoid needing a composite index.
                // We will sort the data on the client side.
                const q = isAdmin
                    ? query(collectionGroup(db, 'history'))
                    : query(collection(db, 'users', user.uid, 'history'), orderBy('completedTimestamp', 'desc'));
                
                const unsubscribe = onSnapshot(q, (snapshot) => {
                    let historyData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data(), uid: doc.ref.path.split('/')[1] }));
                    
                    // If admin, sort the data manually after fetching
                    if (isAdmin) {
                        historyData.sort((a, b) => {
                            const timeA = a.completedTimestamp?.seconds || 0;
                            const timeB = b.completedTimestamp?.seconds || 0;
                            return timeB - timeA; // Descending order
                        });
                    }
                    
                    setHistory(historyData);
                });
                return () => unsubscribe();
            }, [user, isAdmin]);
            return history;
        };
        
        // --- MAIN APP STRUCTURE ---
        const App = () => {
            const { user, loading } = useAuth();
            if (loading) return React.createElement("div", { className: "flex justify-center items-center min-h-screen bg-slate-900" }, React.createElement("div", { className: "text-xl font-semibold text-slate-300" }, "Loading Application..."));
            return user ? React.createElement(MainApp) : React.createElement(Login);
        };
        
        const MainApp = () => {
            const [page, setPage] = useState('dashboard');
            const { permissions } = useAuth();
            const [isModalOpen, setIsModalOpen] = useState(false);
            const [editingTask, setEditingTask] = useState(null);
            const [isSidebarOpen, setIsSidebarOpen] = useState(false);
            
            useEffect(() => {
                if (permissions.length > 0 && !permissions.includes(page)) {
                    setPage(permissions[0] || 'dashboard');
                }
            }, [page, permissions]);

            const openModal = (task = null) => {
                setEditingTask(task);
                setIsModalOpen(true);
            };
            const closeModal = () => {
                setIsModalOpen(false);
                setEditingTask(null);
            };

            const renderPage = () => {
                if (!permissions.includes(page)) {
                    return React.createElement("div", { className: "text-center p-8" }, 
                        React.createElement("h1", { className: "text-2xl font-bold text-red-500" }, "Access Denied"),
                        React.createElement("p", { className: "text-slate-400 mt-2" }, "You do not have permission to view this page.")
                    );
                }
                switch (page) {
                    case 'dashboard': return React.createElement(DashboardPage, { setPage });
                    case 'board': return React.createElement(BoardPage, { openModal });
                    case 'history': return React.createElement(HistoryPage);
                    case 'settings': return React.createElement(SettingsPage);
                    default: return React.createElement(DashboardPage, { setPage });
                }
            };

            return React.createElement(React.Fragment, null,
                React.createElement(Sidebar, { currentPage: page, setPage, onSignOut: () => signOut(auth), isOpen: isSidebarOpen, setIsOpen: setIsSidebarOpen }),
                React.createElement("div", { className: "lg:pl-64" },
                    React.createElement(TopHeader, { openModal, toggleSidebar: () => setIsSidebarOpen(!isSidebarOpen) }),
                    React.createElement("main", { className: "p-4 sm:p-6 lg:p-8" },
                        renderPage()
                    )
                ),
                isModalOpen && React.createElement(TaskModal, { task: editingTask, onClose: closeModal })
            );
        };

        const Sidebar = ({ currentPage, setPage, onSignOut, isOpen, setIsOpen }) => {
            const { user, permissions } = useAuth();
            const navItems = [
                { id: 'dashboard', label: 'Dashboard', icon: icons.dashboard },
                { id: 'board', label: 'Board', icon: icons.board },
                { id: 'history', label: 'History', icon: icons.history },
                { id: 'settings', label: 'Settings', icon: icons.settings },
            ];

            const NavLink = ({ id, label, icon }) => {
                const isActive = currentPage === id;
                return React.createElement("button", {
                    onClick: () => { setPage(id); setIsOpen(false); },
                    className: `flex items-center w-full px-4 py-3 text-sm font-medium rounded-lg transition-colors ${isActive ? 'bg-blue-600 text-white' : 'text-slate-400 hover:bg-slate-700 hover:text-slate-200'}`
                }, React.cloneElement(icon, { className: "w-5 h-5 mr-3" }), label);
            };

            return React.createElement(React.Fragment, null,
                React.createElement("div", {
                    className: `fixed inset-0 bg-black/60 z-30 lg:hidden transition-opacity duration-300 ${isOpen ? 'opacity-100' : 'opacity-0 pointer-events-none'}`,
                    onClick: () => setIsOpen(false)
                }),
                React.createElement("aside", { 
                    className: `fixed top-0 left-0 h-full w-64 bg-slate-800 border-r border-slate-700/50 flex flex-col p-4 z-40 transition-transform duration-300 ease-in-out lg:translate-x-0 ${isOpen ? 'translate-x-0' : '-translate-x-full'}` 
                },
                    React.createElement("div", { className: "flex items-center mb-8" },
                        React.createElement("div", { className: "w-10 h-10 bg-blue-600 rounded-lg flex items-center justify-center mr-3" },
                            React.createElement("svg", { className: "w-6 h-6 text-white", viewBox: "0 0 512 512", fill: "currentColor" }, React.createElement("path", { d: "M368 128H144C126.3 128 112 142.3 112 160V416C112 433.7 126.3 448 144 448H368C385.7 448 400 433.7 400 416V160C400 142.3 385.7 128 368 128ZM256 64C269.8 64 282.8 68.88 292.8 76.8L336.2 109.5C340.6 112.8 346.5 112.5 350.5 108.5L364.5 94.5C368.5 90.5 370.2 84.98 368.8 79.88C359.1 43.8 322.2 16 280 16C222.2 16 176 62.15 176 120V128H208V120C208 84.33 228.3 64 256 64Z" }))
                        ),
                        React.createElement("h1", { className: "text-xl font-bold text-slate-100" }, "JLW Tracker")
                    ),
                    React.createElement("nav", { className: "flex-grow space-y-2" },
                        navItems.filter(item => permissions.includes(item.id)).map(item => React.createElement(NavLink, { key: item.id, ...item }))
                    ),
                    React.createElement("div", { className: "mt-auto" },
                        React.createElement("div", { className: "p-3 bg-slate-700/50 rounded-lg" },
                            React.createElement("p", { className: "text-sm font-medium text-slate-200 truncate" }, user.email),
                            React.createElement("p", { className: "text-xs text-slate-400" }, permissions.includes('settings') ? 'Administrator' : 'User')
                        ),
                        React.createElement("button", { onClick: onSignOut, className: "flex items-center w-full px-4 py-3 mt-2 text-sm font-medium rounded-lg text-slate-400 hover:bg-slate-700 hover:text-slate-200" },
                            React.cloneElement(icons.logout, { className: "w-5 h-5 mr-3" }), "Sign Out")
                    )
                )
            );
        };
        
        const TopHeader = ({ openModal, toggleSidebar }) => {
            return React.createElement("header", { className: "sticky top-0 z-10 flex-shrink-0 bg-slate-900/70 backdrop-blur-sm border-b border-slate-700/50 px-4 sm:px-6 lg:px-8" },
                React.createElement("div", { className: "flex items-center justify-between h-16" },
                     React.createElement("button", { onClick: toggleSidebar, className: "lg:hidden text-slate-400 hover:text-slate-200 p-2 -ml-2" }, icons.menu),
                     React.createElement("div", { className: "flex-1" }), // Spacer
                     React.createElement("button", { onClick: () => openModal(), className: "bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-75 transition-transform transform hover:scale-105" }, "+ Add New Task")
                )
            );
        };

        // --- PAGES ---
        const DashboardPage = ({ setPage }) => {
            const { user } = useAuth();
            const tasks = useTasks();
            const history = useHistory();

            const stats = useMemo(() => {
                const todo = tasks.filter(t => t.status === 'todo').length;
                const inprogress = tasks.filter(t => t.status === 'inprogress').length;
                const today = new Date().toISOString().slice(0, 10);
                const doneToday = history.filter(h => h.completedTimestamp && new Date(h.completedTimestamp.seconds * 1000).toISOString().slice(0, 10) === today).length;
                return { todo, inprogress, doneToday };
            }, [tasks, history]);

            const priorityTasks = useMemo(() => tasks.filter(t => t.status === 'todo').slice(0, 5), [tasks]);
            const recentHistory = useMemo(() => history.slice(0, 5), [history]);
            
            const StatCard = ({ title, value, color }) => (
                React.createElement("div", { className: `bg-slate-800 p-6 rounded-xl border-l-4 ${color}` },
                    React.createElement("p", { className: "text-sm font-medium text-slate-400" }, title),
                    React.createElement("p", { className: "text-3xl font-bold text-slate-100 mt-1" }, value)
                )
            );

            return React.createElement("div", { className: "space-y-8" },
                React.createElement("div", null,
                    React.createElement("h1", { className: "text-3xl font-bold text-slate-100" }, `Welcome back, ${user.email.split('@')[0]}!`),
                    React.createElement("p", { className: "text-slate-400 mt-1" }, "Here's a snapshot of your team's activity.")
                ),
                React.createElement("div", { className: "grid grid-cols-1 md:grid-cols-3 gap-6" },
                    React.createElement(StatCard, { title: "Tasks To Do", value: stats.todo, color: "border-red-500" }),
                    React.createElement(StatCard, { title: "In Progress", value: stats.inprogress, color: "border-yellow-500" }),
                    React.createElement(StatCard, { title: "Completed Today", value: stats.doneToday, color: "border-green-500" })
                ),
                React.createElement("div", { className: "grid grid-cols-1 lg:grid-cols-2 gap-8" },
                    React.createElement("div", { className: "bg-slate-800 p-6 rounded-xl" },
                        React.createElement("h2", { className: "text-xl font-semibold text-slate-100 mb-4" }, "Priority Tasks"),
                        React.createElement("div", { className: "space-y-3" },
                            priorityTasks.length > 0
                                ? priorityTasks.map(task => React.createElement("div", { key: task.id, className: "bg-slate-700 p-3 rounded-lg" },
                                    React.createElement("p", { className: "font-medium text-slate-200" }, task.text),
                                    React.createElement("p", { className: "text-xs text-slate-400" }, `${task.shopName || ''} - ${task.staffName || ''}`)
                                ))
                                : React.createElement("p", { className: "text-slate-400" }, "No tasks in 'To Do'. Great job!")
                        )
                    ),
                    React.createElement("div", { className: "bg-slate-800 p-6 rounded-xl" },
                        React.createElement("h2", { className: "text-xl font-semibold text-slate-100 mb-4" }, "Recent Activity"),
                        React.createElement("div", { className: "space-y-3" },
                            recentHistory.length > 0
                                ? recentHistory.map(task => React.createElement("div", { key: task.id, className: "bg-slate-700 p-3 rounded-lg" },
                                    React.createElement("p", { className: "font-medium text-slate-200" }, task.text),
                                    React.createElement("p", { className: "text-xs text-slate-400" }, `Completed by ${task.staffName || 'N/A'}`)
                                ))
                                : React.createElement("p", { className: "text-slate-400" }, "No recent completed tasks.")
                        )
                    )
                )
            );
        };

        const BoardPage = ({ openModal }) => {
            const tasks = useTasks();
            const { user, isAdmin } = useAuth();

            const handleDrop = async (item, newStatus) => {
                const taskToMove = tasks.find(t => t.id === item.id);
                if (!taskToMove || !taskToMove.uid) return;
                
                const taskRef = doc(db, 'users', taskToMove.uid, 'tasks', taskToMove.id);
                let updateData = { status: newStatus };

                if (newStatus === 'inprogress' && !taskToMove.progressTimestamp) {
                    updateData.progressTimestamp = serverTimestamp();
                }

                if (newStatus === 'done') {
                    const { id, ...taskData } = taskToMove;
                    await addDoc(collection(db, 'users', taskToMove.uid, 'history'), { 
                        ...taskData, ...updateData, completedTimestamp: serverTimestamp() 
                    });
                    await deleteDoc(taskRef);
                    confetti({ particleCount: 150, spread: 90, origin: { x: 0.5, y: 0.5 }, gravity: 1.2 });
                } else {
                    await updateDoc(taskRef, updateData);
                }
            };
            
            const handleDeleteTask = async (task) => {
                if (!task.uid) return;
                await deleteDoc(doc(db, 'users', task.uid, 'tasks', task.id));
            };

            return React.createElement("div", null,
                React.createElement("h1", { className: "text-3xl font-bold text-slate-100 mb-6" }, "Kanban Board"),
                React.createElement(KanbanBoard, { tasks, onDrop: handleDrop, onEdit: openModal, onDelete: handleDeleteTask, isAdmin })
            );
        };
        
        const HistoryPage = () => {
            const history = useHistory();
            const { isAdmin } = useAuth();
            const [filters, setFilters] = useState({ shop: '', staff: '', date: '' });
            const [currentPage, setCurrentPage] = useState(1);
            
            const shopOptions = useMemo(() => [...new Set(history.map(t => t.shopName).filter(Boolean))], [history]);
            const staffOptions = useMemo(() => [...new Set(history.map(t => t.staffName).filter(Boolean))], [history]);

            useEffect(() => { setCurrentPage(1); }, [filters]);

            const filteredHistory = useMemo(() => history.filter(task => {
                const shopMatch = filters.shop ? task.shopName === filters.shop : true;
                const staffMatch = filters.staff ? task.staffName === filters.staff : true;
                const dateMatch = filters.date ? new Date(task.completedTimestamp?.seconds * 1000).toISOString().split('T')[0] === filters.date : true;
                return shopMatch && staffMatch && dateMatch;
            }), [history, filters]);

            return React.createElement("div", null,
                React.createElement("h1", { className: "text-3xl font-bold text-slate-100 mb-6" }, "Task History"),
                React.createElement(HistoryTable, { 
                    history: filteredHistory, 
                    filters, 
                    setFilters, 
                    shopOptions,
                    staffOptions,
                    isAdmin,
                    currentPage,
                    setCurrentPage
                })
            );
        };

        // --- REUSABLE & CORE COMPONENTS ---
        const Login = () => {
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [rememberMe, setRememberMe] = useState(false);
            const [error, setError] = useState('');
            const [showPassword, setShowPassword] = useState(false);

            const handleLogin = async (e) => {
                e.preventDefault();
                setError('');
                try {
                    const persistence = rememberMe ? browserLocalPersistence : browserSessionPersistence;
                    await setPersistence(auth, persistence);
                    await signInWithEmailAndPassword(auth, email, password);
                } catch (err) {
                    let message = 'An unknown error occurred.';
                    switch (err.code) {
                        case 'auth/invalid-email': message = 'Please enter a valid email address.'; break;
                        case 'auth/user-not-found':
                        case 'auth/wrong-password':
                        case 'auth/invalid-credential': message = 'Invalid email or password.'; break;
                        case 'auth/too-many-requests': message = 'Access to this account has been temporarily disabled.'; break;
                    }
                    setError(message);
                }
            };

            return React.createElement("div", { className: "flex items-center justify-center min-h-screen p-4" },
                React.createElement("div", { className: "w-full max-w-5xl bg-slate-800 rounded-2xl shadow-2xl flex flex-col md:flex-row overflow-hidden" },
                    React.createElement("div", { className: "w-full md:w-1/2 bg-slate-900 p-8 sm:p-12 flex-col justify-center items-center text-white hidden md:flex" },
                        React.createElement("div", { className: "max-w-xs" },
                            React.createElement("svg", { className: "w-full h-auto mb-6", viewBox: "0 0 512 512", fill: "none", xmlns: "http://www.w3.org/2000/svg" }, React.createElement("path", { d: "M368 128H144C126.3 128 112 142.3 112 160V416C112 433.7 126.3 448 144 448H368C385.7 448 400 433.7 400 416V160C400 142.3 385.7 128 368 128ZM256 64C269.8 64 282.8 68.88 292.8 76.8L336.2 109.5C340.6 112.8 346.5 112.5 350.5 108.5L364.5 94.5C368.5 90.5 370.2 84.98 368.8 79.88C359.1 43.8 322.2 16 280 16C222.2 16 176 62.15 176 120V128H208V120C208 84.33 228.3 64 256 64ZM240 248C240 243.6 243.6 240 248 240H328C332.4 240 336 243.6 336 248C336 252.4 332.4 256 328 256H248C243.6 256 240 252.4 240 248ZM248 320H328C332.4 320 336 323.6 336 328C336 332.4 332.4 336 328 336H248C243.6 336 240 332.4 240 328C240 323.6 243.6 320 248 320ZM184 256C193.9 256 201.6 248.4 201.6 238.4C201.6 228.5 193.9 220.8 184 220.8C174.1 220.8 166.4 228.5 166.4 238.4C166.4 248.4 174.1 256 184 256ZM184 336C193.9 336 201.6 328.4 201.6 318.4C201.6 308.5 193.9 300.8 184 300.8C174.1 300.8 166.4 308.5 166.4 318.4C166.4 328.4 174.1 336 184 336Z", fill: "#3b82f6" })),
                            React.createElement("h2", { className: "text-3xl font-bold leading-tight" }, "Streamline Your Workflow"),
                            React.createElement("p", { className: "mt-2 text-slate-300" }, "Manage tasks, track progress, and collaborate with your team efficiently.")
                        )
                    ),
                    React.createElement("div", { className: "w-full md:w-1/2 p-8 sm:p-12 flex flex-col justify-center" },
                        React.createElement("div", { className: "w-full max-w-sm mx-auto" },
                            React.createElement("h2", { className: "text-3xl font-bold text-slate-100" }, "JLW Task Tracker"),
                            React.createElement("p", { className: "mt-2 text-slate-400" }, "Welcome! Please sign in to your account."),
                            React.createElement("p", { className: "mt-4 text-sm font-semibold text-center text-red-400 bg-red-900/50 p-3 rounded-lg" }, "This application is used for Internal USE ONLY!"),
                            React.createElement("form", { onSubmit: handleLogin, className: "mt-8 space-y-6" },
                                error && React.createElement("div", { className: "p-3 bg-red-900/50 text-red-400 rounded-md text-sm" }, error),
                                React.createElement("div", null,
                                    React.createElement("label", { htmlFor: "email", className: "block text-sm font-medium text-slate-400" }, "Email address"),
                                    React.createElement("div", { className: "mt-1" }, React.createElement("input", { id: "email", name: "email", type: "email", value: email, onChange: (e) => setEmail(e.target.value), required: true, className: "w-full px-3 py-2 border border-slate-600 rounded-md shadow-sm placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-slate-700 text-slate-100" }))
                                ),
                                React.createElement("div", null,
                                    React.createElement("label", { htmlFor: "password", className: "block text-sm font-medium text-slate-400" }, "Password"),
                                    React.createElement("div", { className: "mt-1 relative" },
                                        React.createElement("input", { id: "password", name: "password", type: showPassword ? "text" : "password", value: password, onChange: (e) => setPassword(e.target.value), required: true, className: "w-full px-3 py-2 border border-slate-600 rounded-md shadow-sm placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-slate-700 text-slate-100 pr-10" }),
                                        React.createElement("button", { type: "button", onClick: () => setShowPassword(!showPassword), className: "absolute inset-y-0 right-0 pr-3 flex items-center text-slate-400 hover:text-slate-200" },
                                            showPassword ? React.createElement("svg", { xmlns: "http://www.w3.org/2000/svg", className: "h-5 w-5", viewBox: "0 0 20 20", fill: "currentColor" }, React.createElement("path", { fillRule: "evenodd", d: "M3.707 2.293a1 1 0 00-1.414 1.414l14 14a1 1 0 001.414-1.414l-1.473-1.473A10.014 10.014 0 0019.542 10C18.268 5.943 14.478 3 10 3a9.958 9.958 0 00-4.512 1.074L3.707 2.293zM10 12a2 2 0 100-4 2 2 0 000 4z", clipRule: "evenodd" }), React.createElement("path", { d: "M2 10s.939-1.761 2.63-3.262A10.034 10.034 0 0110 5c1.29 0 2.522.342 3.638.95-1.595.68-2.89 1.93-3.638 3.462A9.948 9.948 0 012 10z" }))
                                                       : React.createElement("svg", { xmlns: "http://www.w3.org/2000/svg", className: "h-5 w-5", viewBox: "0 0 20 20", fill: "currentColor" }, React.createElement("path", { d: "M10 12a2 2 0 100-4 2 2 0 000 4z" }), React.createElement("path", { fillRule: "evenodd", d: "M.458 10C1.732 5.943 5.522 3 10 3s8.268 2.943 9.542 7c-1.274 4.057-5.022 7-9.542 7S1.732 14.057.458 10zM14 10a4 4 0 11-8 0 4 4 0 018 0z", clipRule: "evenodd" }))
                                        )
                                    )
                                ),
                                React.createElement("div", { className: "flex items-center" },
                                    React.createElement("input", { id: "remember-me", name: "remember-me", type: "checkbox", checked: rememberMe, onChange: (e) => setRememberMe(e.target.checked), className: "h-4 w-4 text-blue-600 focus:ring-blue-500 border-slate-600 rounded bg-slate-700" }),
                                    React.createElement("label", { htmlFor: "remember-me", className: "ml-2 block text-sm text-slate-300" }, "Remember me")
                                ),
                                React.createElement("div", null, React.createElement("button", { type: "submit", className: "w-full flex justify-center py-3 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500" }, "Sign in"))
                            )
                        )
                    )
                )
            );
        };

        const KanbanBoard = ({ tasks, onDrop, onEdit, onDelete, isAdmin }) => {
            const columns = [
                { id: 'todo', title: 'To Do', color: 'red-400' },
                { id: 'inprogress', title: 'In Progress', color: 'yellow-400' },
                { id: 'done', title: 'Done', color: 'green-400' },
            ];

            return React.createElement("div", { id: "kanbanBoard", className: "grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6" },
                columns.map(col => React.createElement(KanbanColumn, {
                    key: col.id,
                    status: col.id,
                    title: col.title,
                    color: col.color,
                    tasks: tasks.filter(t => t.status === col.id),
                    onDrop,
                    onEdit,
                    onDelete,
                    isAdmin
                }))
            );
        };

        const KanbanColumn = ({ status, title, color, tasks, onDrop, onEdit, onDelete, isAdmin }) => {
            const columnRef = useRef(null);
            
            useEffect(() => {
                if (!columnRef.current) return;
                const sortable = new Sortable(columnRef.current, {
                    group: 'kanban', animation: 150, ghostClass: 'sortable-ghost',
                    onEnd: (evt) => {
                        const { item, from, to } = evt;
                        if (from !== to) {
                            const taskId = item.dataset.id;
                            const newStatus = to.dataset.status;
                            onDrop({ id: taskId }, newStatus);
                            from.insertBefore(item, from.children[evt.oldIndex] || null);
                        }
                    }
                });
                return () => sortable.destroy();
            }, [onDrop, status]);

            return React.createElement("div", { className: "bg-slate-800 rounded-xl shadow-md flex flex-col" },
                React.createElement("div", { className: "p-4 border-b border-slate-700" },
                    React.createElement("h2", { className: "text-lg font-semibold text-slate-200 flex items-center" },
                        React.createElement("span", { className: `w-3 h-3 rounded-full bg-${color} mr-3` }),
                        title,
                        React.createElement("span", { className: "ml-2 text-sm font-normal bg-slate-700 text-slate-300 px-2 py-0.5 rounded-full" }, tasks.length)
                    )
                ),
                React.createElement("div", { ref: columnRef, "data-status": status, className: "kanban-column-body p-4 flex-grow min-h-[200px] overflow-y-auto" },
                    tasks.map(task => React.createElement(TaskCard, { key: task.id, task, onEdit, onDelete, isAdmin }))
                )
            );
        };

        const TaskCard = ({ task, onEdit, onDelete, isAdmin }) => {
            return React.createElement("div", { "data-id": task.id, className: "task-card bg-slate-700 border border-slate-600 p-4 rounded-lg shadow-sm mb-4 cursor-grab active:cursor-grabbing flex flex-col group" },
                React.createElement("div", { className: "flex justify-between items-start" },
                    React.createElement("p", { onClick: () => onEdit(task), className: "text-slate-100 font-semibold flex-grow pr-2 cursor-pointer" }, task.text),
                    React.createElement("button", { onClick: () => onDelete(task), className: "text-slate-500 hover:text-red-500 font-bold text-xl leading-none flex-shrink-0 opacity-0 group-hover:opacity-100 transition-opacity" }, "×")
                ),
                React.createElement("div", { className: "mt-3 pt-3 border-t border-slate-600 text-xs text-slate-400 space-y-1.5" },
                    task.date && React.createElement(InfoRow, { icon: '📅', label: 'Date', value: task.date }),
                    task.staffName && React.createElement(InfoRow, { icon: '👤', label: 'Staff', value: task.staffName }),
                    task.shopName && React.createElement(InfoRow, { icon: '🏢', label: 'Shop', value: task.shopName })
                )
            );
        };
        
        const InfoRow = ({ icon, label, value }) => (
            React.createElement("div", { className: "flex items-center" },
                React.createElement("span", { className: "mr-2" }, icon),
                React.createElement("p", null, 
                    React.createElement("span", { className: "font-medium text-slate-300" }, `${label}: `),
                    value
                )
            )
        );

        const HistoryTable = ({ history, filters, setFilters, shopOptions, staffOptions, isAdmin, currentPage, setCurrentPage }) => {
            const itemsPerPage = 20;
            const totalPages = Math.ceil(history.length / itemsPerPage);
            const startIndex = (currentPage - 1) * itemsPerPage;
            const paginatedHistory = history.slice(startIndex, startIndex + itemsPerPage);

            const handlePrevPage = () => setCurrentPage(prev => Math.max(prev - 1, 1));
            const handleNextPage = () => setCurrentPage(prev => Math.min(prev + 1, totalPages));

            const formatDuration = (ms) => {
                if (!ms || ms < 0) return "0s";
                const seconds = Math.floor((ms / 1000) % 60);
                const minutes = Math.floor((ms / (1000 * 60)) % 60);
                const hours = Math.floor((ms / (1000 * 60 * 60)) % 24);
                const days = Math.floor(ms / (1000 * 60 * 60 * 24));
                const parts = [];
                if (days > 0) parts.push(`${days}d`);
                if (hours > 0) parts.push(`${hours}h`);
                if (minutes > 0) parts.push(`${minutes}m`);
                if (parts.length === 0 && seconds >= 0) parts.push(`${seconds}s`);
                return parts.slice(0, 2).join(' ');
            };
            
            const formatDate = (timestamp) => {
                if (!timestamp) return 'N/A';
                const date = new Date(timestamp.seconds * 1000);
                const day = String(date.getDate()).padStart(2, '0');
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const year = String(date.getFullYear()).slice(-2);
                let hours = date.getHours();
                const minutes = String(date.getMinutes()).padStart(2, '0');
                const ampm = hours >= 12 ? 'PM' : 'AM';
                hours = hours % 12;
                hours = hours ? hours : 12;
                const strHours = String(hours).padStart(2, '0');
                return `${day}-${month}-${year}. ${strHours}:${minutes} ${ampm}`;
            };

            return React.createElement("div", { id: "historySection" },
                React.createElement("div", { className: "flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4" },
                    React.createElement("div", { id: "historyFilters", className: "w-full sm:w-auto flex flex-col sm:flex-row items-center gap-2 sm:gap-4" },
                        React.createElement("select", { value: filters.shop, onChange: e => setFilters({...filters, shop: e.target.value}), className: "input w-full sm:w-auto text-sm" },
                            React.createElement("option", { value: "" }, "All Shops"),
                            shopOptions.map(name => React.createElement("option", { key: name, value: name }, name))
                        ),
                        React.createElement("select", { value: filters.staff, onChange: e => setFilters({...filters, staff: e.target.value}), className: "input w-full sm:w-auto text-sm" },
                             React.createElement("option", { value: "" }, "All Staff"),
                            staffOptions.map(name => React.createElement("option", { key: name, value: name }, name))
                        ),
                        React.createElement("input", { type: "date", value: filters.date, onChange: e => setFilters({...filters, date: e.target.value}), className: "input w-full sm:w-auto text-sm" }),
                        React.createElement("button", { onClick: () => setFilters({ shop: '', staff: '', date: '' }), className: "w-full sm:w-auto bg-slate-600 text-slate-200 font-semibold py-2 px-4 rounded-lg hover:bg-slate-500 text-sm transition" }, "Clear")
                    )
                ),
                React.createElement("div", { className: "bg-slate-800 rounded-xl shadow-md overflow-x-auto" },
                    React.createElement("table", { className: "w-full text-left" },
                        React.createElement("thead", { className: "bg-slate-700/50" },
                            React.createElement("tr", null,
                                React.createElement("th", { className: "px-2 py-3 sm:p-4 text-sm font-semibold text-slate-400" }, "No"),
                                React.createElement("th", { className: "px-2 py-3 sm:p-4 text-sm font-semibold text-slate-400" }, "Staff Name"),
                                React.createElement("th", { className: "px-2 py-3 sm:p-4 text-sm font-semibold text-slate-400" }, "Shop Name"),
                                React.createElement("th", { className: "px-2 py-3 sm:p-4 text-sm font-semibold text-slate-400" }, "Task"),
                                React.createElement("th", { className: "px-2 py-3 sm:p-4 text-sm font-semibold text-slate-400" }, "Task Duration"),
                                React.createElement("th", { className: "px-2 py-3 sm:p-4 text-sm font-semibold text-slate-400" }, "Progress Date"),
                                React.createElement("th", { className: "px-2 py-3 sm:p-4 text-sm font-semibold text-slate-400" }, "Completed Date")
                            )
                        ),
                        React.createElement("tbody", { className: "divide-y divide-slate-700" },
                            paginatedHistory.length === 0 ? React.createElement("tr", null, React.createElement("td", { colSpan: "7", className: "p-4 text-center text-slate-400" }, "No matching completed tasks."))
                            : paginatedHistory.map((task, index) => React.createElement("tr", { key: task.id, className: "hover:bg-slate-700" },
                                React.createElement("td", { className: "px-2 py-3 sm:p-4" }, startIndex + index + 1),
                                React.createElement("td", { className: "px-2 py-3 sm:p-4" }, task.staffName || 'N/A'),
                                React.createElement("td", { className: "px-2 py-3 sm:p-4" }, task.shopName || 'N/A'),
                                React.createElement("td", { className: "px-2 py-3 sm:p-4" }, task.text),
                                React.createElement("td", { className: "px-2 py-3 sm:p-4 font-medium" }, formatDuration(task.completedTimestamp && task.progressTimestamp ? (task.completedTimestamp.seconds - task.progressTimestamp.seconds) * 1000 : null)),
                                React.createElement("td", { className: "px-2 py-3 sm:p-4 text-sm text-slate-400" }, formatDate(task.progressTimestamp)),
                                React.createElement("td", { className: "px-2 py-3 sm:p-4 text-sm text-slate-400" }, formatDate(task.completedTimestamp))
                            ))
                        )
                    )
                ),
                React.createElement("div", { className: "mt-4 flex items-center justify-between" },
                    React.createElement("span", { className: "text-sm text-slate-400" }, `Showing ${history.length > 0 ? startIndex + 1 : 0}-${Math.min(startIndex + itemsPerPage, history.length)} of ${history.length} results`),
                    React.createElement("div", { className: "flex items-center space-x-2" },
                        React.createElement("button", { onClick: handlePrevPage, disabled: currentPage === 1, className: "px-4 py-2 text-sm font-medium text-slate-200 bg-slate-700 border border-slate-600 rounded-lg hover:bg-slate-600 disabled:opacity-50 disabled:cursor-not-allowed" }, "Previous"),
                        React.createElement("span", { className: "text-sm text-slate-300 px-2" }, `Page ${currentPage} of ${totalPages > 0 ? totalPages : 1}`),
                        React.createElement("button", { onClick: handleNextPage, disabled: currentPage === totalPages || totalPages === 0, className: "px-4 py-2 text-sm font-medium text-slate-200 bg-slate-700 border border-slate-600 rounded-lg hover:bg-slate-600 disabled:opacity-50 disabled:cursor-not-allowed" }, "Next")
                    )
                )
            );
        };

        const TaskModal = ({ task, onClose }) => {
            const { user } = useAuth();
            const [text, setText] = useState(task ? task.text : '');
            const [date, setDate] = useState(task ? task.date : '');
            const [staffName, setStaffName] = useState(task ? task.staffName : '');
            const [shopName, setShopName] = useState(task ? task.shopName : '');
            
            const [shopOptions, setShopOptions] = useState([]);
            const [staffOptions, setStaffOptions] = useState([]);

            useEffect(() => {
                const populateOptions = async (collectionName, setter) => {
                    const querySnapshot = await getDocs(collection(db, collectionName));
                    const options = querySnapshot.docs.map(doc => doc.data().name).filter(Boolean);
                    setter(options);
                };
                populateOptions('shops', setShopOptions);
                populateOptions('supervisors', setStaffOptions);
            }, []);

            const handleSaveTask = async (taskData) => {
                const taskOwnerUid = task ? task.uid : user.uid;
                if (task) {
                    if (task.status !== 'done') {
                         const taskRef = doc(db, 'users', taskOwnerUid, 'tasks', task.id);
                         await updateDoc(taskRef, taskData);
                    }
                } else {
                    await addDoc(collection(db, 'users', user.uid, 'tasks'), { 
                        ...taskData, status: 'todo', createdAt: serverTimestamp(), uid: user.uid, userEmail: user.email
                    });
                }
                onClose();
            };

            const handleSubmit = (e) => {
                e.preventDefault();
                if (!text.trim()) return;
                handleSaveTask({ text, date, staffName, shopName });
            };

            return React.createElement("div", { className: "fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 p-4" },
                React.createElement("div", { className: "bg-slate-800 rounded-lg shadow-xl p-8 w-full max-w-md" },
                    React.createElement("h2", { className: "text-2xl font-bold mb-6 text-slate-100" }, task ? 'Edit Task' : 'Add a New Task'),
                    React.createElement("form", { onSubmit: handleSubmit },
                        React.createElement("div", { className: "space-y-4" },
                            React.createElement("div", null,
                                React.createElement("label", { htmlFor: "taskDate", className: "block text-sm font-medium text-slate-400 mb-1" }, "Date"),
                                React.createElement("input", { type: "date", id: "taskDate", value: date, onChange: (e) => setDate(e.target.value), className: "input" })
                            ),
                            React.createElement("div", null,
                                React.createElement("label", { htmlFor: "shopNameSelect", className: "block text-sm font-medium text-slate-400 mb-1" }, "Shop Name"),
                                React.createElement("select", { id: "shopNameSelect", value: shopName, onChange: (e) => setShopName(e.target.value), className: "input" },
                                    React.createElement("option", { value: "" }, "Select Shop"),
                                    shopOptions.map(name => React.createElement("option", { key: name, value: name }, name))
                                )
                            ),
                            React.createElement("div", null,
                                React.createElement("label", { htmlFor: "staffNameSelect", className: "block text-sm font-medium text-slate-400 mb-1" }, "Staff Name"),
                                React.createElement("select", { id: "staffNameSelect", value: staffName, onChange: (e) => setStaffName(e.target.value), className: "input" },
                                    React.createElement("option", { value: "" }, "Select Staff"),
                                    staffOptions.map(name => React.createElement("option", { key: name, value: name }, name))
                                )
                            ),
                            React.createElement("div", null,
                                React.createElement("label", { htmlFor: "taskInput", className: "block text-sm font-medium text-slate-400 mb-1" }, "Task Description"),
                                React.createElement("textarea", { id: "taskInput", value: text, onChange: (e) => setText(e.target.value), className: "input", rows: "3", placeholder: "Enter task description...", required: true })
                            )
                        ),
                        React.createElement("div", { className: "mt-6 flex justify-end space-x-4" },
                            React.createElement("button", { type: "button", onClick: onClose, className: "bg-slate-600 text-slate-200 font-semibold py-2 px-4 rounded-lg hover:bg-slate-500 transition" }, "Cancel"),
                            React.createElement("button", { type: "submit", className: "bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-700 transition" }, "Save Task")
                        )
                    )
                )
            );
        };
        
        // --- SETTINGS PAGE & COMPONENTS ---
        function showConfirmation(message) {
            return new Promise((resolve) => {
                const confirmationBox = document.createElement('div');
                confirmationBox.className = 'modal-overlay';
                confirmationBox.innerHTML = `
                    <div class="modal-content text-center">
                        <p class="mb-4 text-lg text-slate-100">${message}</p>
                        <div class="flex justify-center space-x-4">
                            <button id="confirm-yes" class="bg-red-600 text-white px-6 py-2 rounded-lg shadow hover:bg-red-700">Yes, delete</button>
                            <button id="confirm-no" class="bg-slate-600 text-slate-200 px-6 py-2 rounded-lg shadow-sm hover:bg-slate-500">Cancel</button>
                        </div>
                    </div>
                `;
                document.body.appendChild(confirmationBox);
                document.getElementById('confirm-yes').onclick = () => { document.body.removeChild(confirmationBox); resolve(true); };
                document.getElementById('confirm-no').onclick = () => { document.body.removeChild(confirmationBox); resolve(false); };
            });
        }

        const useCollection = (collectionName) => {
            const [data, setData] = useState([]);
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState(null);

            useEffect(() => {
                if (!collectionName) { setLoading(false); return; };
                const unsubscribe = onSnapshot(collection(db, collectionName), 
                (querySnapshot) => {
                    const items = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    setData(items);
                    setError(null);
                    setLoading(false);
                }, 
                (err) => {
                    console.error(`Error fetching ${collectionName}:`, err);
                    setError(err);
                    setData([]);
                    setLoading(false);
                });
                return () => unsubscribe();
            }, [collectionName]);
            return { data, loading, error };
        };

        function SettingsCRUD({ title, collectionName, items, formFields, listColumns }) {
            const [editingItem, setEditingItem] = useState(null);
            const [newItem, setNewItem] = useState({});

            const getInitialState = useCallback(() => formFields.reduce((acc, field) => ({ ...acc, [field.name]: (field.type === 'checkbox-group') ? [] : '' }), {}), [formFields]);
            useEffect(() => { setNewItem(getInitialState()); }, [getInitialState]);

            const handleSave = async (item) => {
                try {
                    if (item.id) {
                        const { id, ...data } = item;
                        await updateDoc(doc(db, collectionName, id), data);
                    } else {
                        await addDoc(collection(db, collectionName), item);
                    }
                    setEditingItem(null);
                    setNewItem(getInitialState());
                } catch (e) { console.error(`Error saving ${collectionName}:`, e); }
            };
            
            const handleDelete = async (id) => {
                if (await showConfirmation(`Are you sure you want to delete this item?`)) {
                    try { await deleteDoc(doc(db, collectionName, id)); } catch (e) { console.error(`Error deleting ${collectionName}:`, e); }
                }
            };

            const handleInputChange = (e, item, setItem) => {
                const { name, type, value, checked } = e.target;
                if (type === 'checkbox') {
                    const currentValues = item[name] || [];
                    setItem({ ...item, [name]: checked ? [...currentValues, value] : currentValues.filter(val => val !== value) });
                } else {
                    setItem({ ...item, [name]: value });
                }
            };

            const renderForm = (item, setItem, isNew = false) => (
               React.createElement("form", { onSubmit: (e) => { e.preventDefault(); handleSave(item); }, className: "grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 items-end p-4 bg-slate-700/50 rounded-lg mb-6" },
                    formFields.map(field => (
                        React.createElement("div", { key: field.name, className: field.fullWidth ? 'md:col-span-2 lg:col-span-3' : '' },
                            React.createElement("label", { className: "block text-sm font-medium text-slate-400" }, field.label),
                            field.type === 'select' ? (
                                React.createElement("select", { name: field.name, value: item[field.name] || '', onChange: (e) => handleInputChange(e, item, setItem), className: "input", required: field.required },
                                    React.createElement("option", { value: "" }, field.placeholder),
                                    field.options.map(opt => React.createElement("option", { key: opt.id, value: opt.id }, opt.name))
                                )
                            ) : field.type === 'checkbox-group' ? (
                                React.createElement("div", { className: "checkbox-group" },
                                    field.options.map(opt => (
                                        React.createElement("div", { key: opt.id, className: "flex items-center" },
                                            React.createElement("input", { id: `${field.name}-${opt.id}`, name: field.name, type: "checkbox", value: opt.id, checked: (item[field.name] || []).includes(opt.id), onChange: (e) => handleInputChange(e, item, setItem), className: "h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500 bg-slate-600" }),
                                            React.createElement("label", { htmlFor: `${field.name}-${opt.id}`, className: "ml-2 block text-sm text-slate-200" }, opt.name)
                                        )
                                    ))
                                )
                            ) : (
                                React.createElement("input", { type: field.type || 'text', name: field.name, value: item[field.name] || '', onChange: (e) => handleInputChange(e, item, setItem), className: "input", required: field.required })
                            )
                        )
                    )),
                    React.createElement("div", { className: "flex space-x-2" },
                        React.createElement("button", { type: "submit", className: "w-full bg-blue-600 text-white px-4 py-2 rounded-lg shadow hover:bg-blue-700 transition-colors" }, isNew ? `Add ${title}` : 'Save'),
                        !isNew && React.createElement("button", { type: "button", onClick: () => setEditingItem(null), className: "w-full bg-slate-600 text-slate-200 px-4 py-2 rounded-lg hover:bg-slate-500" }, "Cancel")
                    )
                )
            );

            return (
                React.createElement("div", { className: "bg-slate-800 p-4 sm:p-6 rounded-lg shadow-md" },
                    React.createElement("h2", { className: "text-2xl font-semibold mb-4 text-slate-100" }, title, " Management"),
                    renderForm(newItem, setNewItem, true),
                    React.createElement("div", { className: "overflow-x-auto" },
                        React.createElement("table", { className: "min-w-full divide-y divide-slate-700" },
                            React.createElement("thead", { className: "bg-slate-700/50" },
                                React.createElement("tr", null,
                                    listColumns.map(col => React.createElement("th", { key: col.header, className: "px-6 py-3 text-left text-xs font-medium text-slate-400 uppercase tracking-wider" }, col.header)),
                                    React.createElement("th", { className: "px-6 py-3 text-right text-xs font-medium text-slate-400 uppercase tracking-wider" }, "Actions")
                                )
                            ),
                            React.createElement("tbody", { className: "divide-y divide-slate-700" },
                                items.map(item => (
                                    React.createElement("tr", { key: item.id },
                                        editingItem?.id === item.id ? (
                                            React.createElement("td", { colSpan: listColumns.length + 1, className: "p-0" }, renderForm(editingItem, setEditingItem))
                                        ) : (
                                            React.createElement(React.Fragment, null,
                                                listColumns.map(col => (
                                                    React.createElement("td", { key: col.header, className: "px-6 py-4 whitespace-nowrap text-sm text-slate-300" }, col.render ? col.render(item) : item[col.accessor])
                                                )),
                                                React.createElement("td", { className: "px-6 py-4 whitespace-nowrap text-right text-sm font-medium" },
                                                    React.createElement("button", { onClick: () => setEditingItem({ ...item }), className: "text-indigo-400 hover:text-indigo-300 mr-4" }, "Edit"),
                                                    React.createElement("button", { onClick: () => handleDelete(item.id), className: "text-red-500 hover:text-red-400" }, "Delete")
                                                )
                                            )
                                        )
                                    )
                                ))
                            )
                        )
                    )
                )
            );
        }

        function SettingsPage() {
            const [activeTab, setActiveTab] = useState('shops');
            const { data: shops, loading: shopsLoading, error: shopsError } = useCollection('shops');
            const { data: supervisors, loading: supervisorsLoading, error: supervisorsError } = useCollection('supervisors');
            const isLoading = shopsLoading || supervisorsLoading;
            
            const TabButton = ({ tabName, title, error }) => (
                React.createElement("button", {
                    onClick: () => !error && setActiveTab(tabName), disabled: !!error, title: error ? `Could not load ${title}: Insufficient permissions.` : title,
                    className: `px-3 py-2 text-sm font-medium rounded-md transition-colors duration-200 flex-grow text-center sm:flex-grow-0 ${ activeTab === tabName ? 'bg-blue-600 text-white shadow-md' : 'bg-slate-700 text-slate-300 hover:bg-slate-600' } ${ error ? 'bg-red-900/50 text-red-400 cursor-not-allowed opacity-75' : '' }`
                }, title)
            );
            const shopConfig = {
                formFields: [ { name: 'name', label: 'Shop Name', required: true }, { name: 'contact', label: 'Contact' }, { name: 'address', label: 'Address', fullWidth: true } ],
                listColumns: [ { header: 'Shop Name', accessor: 'name' }, { header: 'Contact', accessor: 'contact' }, { header: 'Address', accessor: 'address' } ]
            };
            const supervisorConfig = {
                formFields: [
                    { name: 'name', label: 'Supervisor Name', required: true },
                    { name: 'email', label: 'Supervisor Email (for login)', type: 'email', required: true },
                    { name: 'assignedShop', label: 'Assigned Shop', type: 'select', options: shops, placeholder: 'Select Shop' },
                    { 
                        name: 'pagePermissions', 
                        label: 'Page Permissions', 
                        type: 'checkbox-group', 
                        options: [ 
                            { id: 'board', name: 'Kanban Board' }, 
                            { id: 'history', name: 'Task History' },
                            { id: 'settings', name: 'Settings' } 
                        ], 
                        fullWidth: true 
                    }
                ],
                listColumns: [
                    { header: 'Supervisor Name', accessor: 'name' },
                    { header: 'Email', accessor: 'email' },
                    { header: 'Assigned Shop', accessor: 'assignedShop', render: (item) => shops.find(s => s.id === item.assignedShop)?.name || 'N/A' },
                    { header: 'Page Permissions', accessor: 'pagePermissions', render: (item) => (item.pagePermissions || []).join(', ') || 'None' }
                ]
            };
            const ErrorDisplay = ({ name }) => (
                React.createElement("div", {className: "bg-red-900/50 border-l-4 border-red-700 text-red-400 p-4 rounded-md"}, 
                    React.createElement("p", {className: "font-bold"}, "Permission Error"),
                    React.createElement("p", null, `Could not load ${name}. Please check your Firestore security rules to allow read access.`)
                )
            );

            return (
                React.createElement("div", { className: "space-y-6" },
                    React.createElement("h1", { className: "text-3xl font-bold text-slate-100" }, "Application Settings"),
                     React.createElement("div", { className: "flex flex-wrap gap-2 bg-slate-900 p-1 rounded-lg" },
                         React.createElement(TabButton, { tabName: "shops", title: "Shops", error: shopsError }),
                         React.createElement(TabButton, { tabName: "supervisors", title: "Supervisor", error: supervisorsError })
                     ),
                     React.createElement("div", null,
                         isLoading ? React.createElement("p", null, "Loading data...") : (
                             React.createElement(React.Fragment, null,
                                 activeTab === 'shops' && (shopsError ? React.createElement(ErrorDisplay, { name: "Shops" }) : React.createElement(SettingsCRUD, { title: "Shop", collectionName: "shops", items: shops, ...shopConfig })),
                                 activeTab === 'supervisors' && (supervisorsError ? React.createElement(ErrorDisplay, { name: "Supervisors" }) : React.createElement(SettingsCRUD, { title: "Supervisor", collectionName: "supervisors", items: supervisors, ...supervisorConfig }))
                             )
                         )
                     )
                )
            )
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(React.createElement(AuthProvider, null, React.createElement(App)));
    </script>
</body>
</html>
