<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JLW Task Tracker</title>
    
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- SortableJS for drag-and-drop functionality -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    
    <!-- Canvas-Confetti for the celebration animation -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>
    
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Inter', sans-serif; }
        .sortable-ghost { background: #c0dcfc; border-radius: 0.5rem; }
        .sortable-drag { opacity: 1 !important; }
        .task-card { transition: background-color 0.2s ease-in-out, box-shadow 0.2s ease-in-out; }
        .kanban-column-body::-webkit-scrollbar { width: 8px; }
        .kanban-column-body::-webkit-scrollbar-track { background: #f1f5f9; border-radius: 10px; }
        .kanban-column-body::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .kanban-column-body::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
    </style>
</head>
<body class="bg-slate-100">

    <!-- Login Page Container -->
    <div id="login-container">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="w-full max-w-5xl bg-white rounded-2xl shadow-2xl flex flex-col md:flex-row overflow-hidden">
                <div class="w-full md:w-1/2 bg-slate-800 p-8 sm:p-12 flex-col justify-center items-center text-white hidden md:flex">
                    <div class="max-w-xs">
                        <svg class="w-full h-auto mb-6" viewBox="0 0 512 512" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M368 128H144C126.3 128 112 142.3 112 160V416C112 433.7 126.3 448 144 448H368C385.7 448 400 433.7 400 416V160C400 142.3 385.7 128 368 128ZM256 64C269.8 64 282.8 68.88 292.8 76.8L336.2 109.5C340.6 112.8 346.5 112.5 350.5 108.5L364.5 94.5C368.5 90.5 370.2 84.98 368.8 79.88C359.1 43.8 322.2 16 280 16C222.2 16 176 62.15 176 120V128H208V120C208 84.33 228.3 64 256 64ZM240 248C240 243.6 243.6 240 248 240H328C332.4 240 336 243.6 336 248C336 252.4 332.4 256 328 256H248C243.6 256 240 252.4 240 248ZM248 320H328C332.4 320 336 323.6 336 328C336 332.4 332.4 336 328 336H248C243.6 336 240 332.4 240 328C240 323.6 243.6 320 248 320ZM184 256C193.9 256 201.6 248.4 201.6 238.4C201.6 228.5 193.9 220.8 184 220.8C174.1 220.8 166.4 228.5 166.4 238.4C166.4 248.4 174.1 256 184 256ZM184 336C193.9 336 201.6 328.4 201.6 318.4C201.6 308.5 193.9 300.8 184 300.8C174.1 300.8 166.4 308.5 166.4 318.4C166.4 328.4 174.1 336 184 336Z" fill="#38bdf8"/></svg>
                        <h2 class="text-3xl font-bold leading-tight">Streamline Your Workflow</h2>
                        <p class="mt-2 text-slate-300">Manage tasks, track progress, and collaborate with your team efficiently.</p>
                    </div>
                </div>
                <div class="w-full md:w-1/2 p-8 sm:p-12 flex flex-col justify-center">
                    <div class="w-full max-w-sm mx-auto">
                        <h2 class="text-3xl font-bold text-slate-900">JLW Task Tracker</h2>
                        <p class="mt-2 text-slate-600">Welcome! Please sign in to your account.</p>
                        <p class="mt-4 text-sm font-semibold text-center text-red-600 bg-red-100 p-3 rounded-lg">This application is used for Internal USE ONLY!</p>
                        <form id="loginForm" class="mt-8 space-y-6">
                            <div id="errorMessage" class="hidden p-3 bg-red-100 text-red-700 rounded-md text-sm"></div>
                            <div>
                                <label for="email" class="block text-sm font-medium text-slate-700">Email address</label>
                                <div class="mt-1"><input id="email" name="email" type="email" autocomplete="email" required class="w-full px-3 py-2 border border-slate-300 rounded-md shadow-sm placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"></div>
                            </div>
                            <div>
                                <label for="password" class="block text-sm font-medium text-slate-700">Password</label>
                                <div class="mt-1 relative">
                                    <input id="password" name="password" type="password" autocomplete="current-password" required class="w-full px-3 py-2 border border-slate-300 rounded-md shadow-sm placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 pr-10">
                                    <button type="button" id="togglePassword" class="absolute inset-y-0 right-0 pr-3 flex items-center text-slate-400 hover:text-slate-600">
                                        <svg id="eye-open" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M10 12a2 2 0 100-4 2 2 0 000 4z" /><path fill-rule="evenodd" d="M.458 10C1.732 5.943 5.522 3 10 3s8.268 2.943 9.542 7c-1.274 4.057-5.022 7-9.542 7S1.732 14.057.458 10zM14 10a4 4 0 11-8 0 4 4 0 018 0z" clip-rule="evenodd" /></svg>
                                        <svg id="eye-closed" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 hidden" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3.707 2.293a1 1 0 00-1.414 1.414l14 14a1 1 0 001.414-1.414l-1.473-1.473A10.014 10.014 0 0019.542 10C18.268 5.943 14.478 3 10 3a9.958 9.958 0 00-4.512 1.074L3.707 2.293zM10 12a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd" /><path d="M2 10s.939-1.761 2.63-3.262A10.034 10.034 0 0110 5c1.29 0 2.522.342 3.638.95-1.595.68-2.89 1.93-3.638 3.462A9.948 9.948 0 012 10z" /></svg>
                                    </button>
                                </div>
                            </div>
                            <div class="flex items-center justify-between">
                                <div class="flex items-center"><input id="remember-me" name="remember-me" type="checkbox" class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-slate-300 rounded"><label for="remember-me" class="ml-2 block text-sm text-slate-900">Remember me</label></div>
                                <div class="text-sm"><a href="#" class="font-medium text-blue-600 hover:text-blue-500">Forgot your password?</a></div>
                            </div>
                            <div><button type="submit" class="w-full flex justify-center py-3 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">Sign in</button></div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Task Tracker Application Container -->
    <div id="tracker-container" class="hidden">
        <div class="container mx-auto p-4 sm:p-6 lg:p-8">
            <header class="flex flex-col sm:flex-row sm:items-center sm:justify-between mb-8">
                <div class="text-center sm:text-left">
                    <h1 class="text-3xl sm:text-4xl font-bold text-slate-900">JLW Task Tracker</h1>
                    <p class="text-slate-500 mt-2">Organize your workflow, one task at a time.</p>
                </div>
                <button id="signOutBtn" class="mt-4 sm:mt-0 bg-red-500 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-red-600 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-opacity-75 transition w-full sm:w-auto">Sign Out</button>
            </header>
            <div class="flex justify-center mb-8"><button id="addTaskBtn" class="bg-blue-600 text-white font-semibold py-3 px-6 rounded-lg shadow-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-75 transition-transform transform hover:scale-105">+ Add New Task</button></div>
            <div id="kanbanBoard" class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="bg-white rounded-xl shadow-md flex flex-col"><div class="p-4 border-b border-slate-200"><h2 class="text-lg font-semibold text-slate-700 flex items-center"><span class="w-3 h-3 rounded-full bg-red-400 mr-3"></span>To Do</h2></div><div id="todo" data-status="todo" class="kanban-column-body p-4 flex-grow min-h-[200px] overflow-y-auto"></div></div>
                <div class="bg-white rounded-xl shadow-md flex flex-col"><div class="p-4 border-b border-slate-200"><h2 class="text-lg font-semibold text-slate-700 flex items-center"><span class="w-3 h-3 rounded-full bg-yellow-400 mr-3"></span>In Progress</h2></div><div id="inprogress" data-status="inprogress" class="kanban-column-body p-4 flex-grow min-h-[200px] overflow-y-auto"></div></div>
                <div class="bg-white rounded-xl shadow-md flex flex-col"><div class="p-4 border-b border-slate-200"><h2 class="text-lg font-semibold text-slate-700 flex items-center"><span class="w-3 h-3 rounded-full bg-green-400 mr-3"></span>Done</h2></div><div id="done" data-status="done" class="kanban-column-body p-4 flex-grow min-h-[200px] overflow-y-auto"></div></div>
            </div>
            <div id="historySection" class="mt-12">
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4">
                     <h2 class="text-2xl font-bold text-slate-800 mb-4 sm:mb-0">Task History</h2>
                    <div id="historyFilters" class="w-full sm:w-auto flex flex-col sm:flex-row items-center gap-2 sm:gap-4">
                        <select id="shopFilter" class="w-full sm:w-auto bg-white border border-slate-300 rounded-lg p-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"></select>
                        <select id="staffFilter" class="w-full sm:w-auto bg-white border border-slate-300 rounded-lg p-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"></select>
                        <input type="date" id="dateFilter" class="w-full sm:w-auto bg-white border border-slate-300 rounded-lg p-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <button id="clearFiltersBtn" class="w-full sm:w-auto bg-slate-200 text-slate-800 font-semibold py-2 px-4 rounded-lg hover:bg-slate-300 text-sm transition">Clear</button>
                    </div>
                </div>
                <div class="bg-white rounded-xl shadow-md overflow-x-auto">
                    <table class="w-full text-left">
                        <thead class="bg-slate-50 border-b border-slate-200">
                            <tr>
                                <th class="px-2 py-3 sm:p-4 text-sm font-semibold text-slate-600">No</th>
                                <th class="px-2 py-3 sm:p-4 text-sm font-semibold text-slate-600">Staff Name</th>
                                <th class="px-2 py-3 sm:p-4 text-sm font-semibold text-slate-600">Shop Name</th>
                                <th class="px-2 py-3 sm:p-4 text-sm font-semibold text-slate-600">Task</th>
                                <th class="px-2 py-3 sm:p-4 text-sm font-semibold text-slate-600">Task Duration</th>
                                <th class="px-2 py-3 sm:p-4 text-sm font-semibold text-slate-600">Completed Date</th>
                                <th class="px-2 py-3 sm:p-4 text-sm font-semibold text-slate-600 text-center">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="historyTableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
        <div id="taskModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50 p-4">
            <div class="bg-white rounded-lg shadow-xl p-8 w-full max-w-md">
                <h2 id="modalTitle" class="text-2xl font-bold mb-6">Add a New Task</h2>
                <input type="hidden" id="editTaskId">
                <div class="space-y-4">
                    <div><label for="taskInput" class="block text-sm font-medium text-slate-700 mb-1">Task Description</label><textarea id="taskInput" class="w-full border border-slate-300 rounded-lg p-3 focus:outline-none focus:ring-2 focus:ring-blue-500" rows="3" placeholder="Enter task description..."></textarea></div>
                    <div><label for="taskDate" class="block text-sm font-medium text-slate-700 mb-1">Date</label><input type="date" id="taskDate" class="w-full border border-slate-300 rounded-lg p-3 focus:outline-none focus:ring-2 focus:ring-blue-500"></div>
                    <div><label for="staffNameSelect" class="block text-sm font-medium text-slate-700 mb-1">Staff Name</label><select id="staffNameSelect" class="w-full border border-slate-300 rounded-lg p-3 focus:outline-none focus:ring-2 focus:ring-blue-500"></select></div>
                    <div><label for="shopNameSelect" class="block text-sm font-medium text-slate-700 mb-1">Shop Name</label><select id="shopNameSelect" class="w-full border border-slate-300 rounded-lg p-3 focus:outline-none focus:ring-2 focus:ring-blue-500"></select></div>
                </div>
                <div class="mt-6 flex justify-end space-x-4">
                    <button id="cancelBtn" class="bg-slate-200 text-slate-800 font-semibold py-2 px-4 rounded-lg hover:bg-slate-300 transition">Cancel</button>
                    <button id="saveTaskBtn" class="bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-700 transition">Save Task</button>
                </div>
            </div>
        </div>
        <div id="deleteConfirmModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50 p-4">
            <div class="bg-white rounded-lg shadow-xl p-8 w-full max-w-sm">
                <h2 class="text-xl font-bold mb-4">Confirm Deletion</h2>
                <p class="text-slate-600 mb-6">Are you sure you want to delete this task? This action cannot be undone.</p>
                <div class="flex justify-end space-x-4">
                    <button id="cancelDeleteBtn" class="bg-slate-200 text-slate-800 font-semibold py-2 px-4 rounded-lg hover:bg-slate-300 transition">Cancel</button>
                    <button id="confirmDeleteBtn" class="bg-red-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-red-700 transition">Delete</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, setPersistence, browserSessionPersistence, browserLocalPersistence, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, getDocs, addDoc, doc, getDoc, updateDoc, deleteDoc, onSnapshot, serverTimestamp, query, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBNb5ZI9XIWWSpxGD-FeV94K5FMc2a8udU",
            authDomain: "hr-manager-84ada.firebaseapp.com",
            projectId: "hr-manager-84ada",
            storageBucket: "hr-manager-84ada.firebasestorage.app",
            messagingSenderId: "365563456537",
            appId: "1:365563456537:web:9c5a6fbce7710b4c72ce88",
            measurementId: "G-51R9KT7LC1"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- DOM Elements ---
        // Login Page
        const loginContainer = document.getElementById('login-container');
        const loginForm = document.getElementById('loginForm');
        const emailInput = document.getElementById('email');
        const passwordInput = document.getElementById('password');
        const rememberMeCheckbox = document.getElementById('remember-me');
        const errorMessageDiv = document.getElementById('errorMessage');
        const togglePasswordBtn = document.getElementById('togglePassword');
        const eyeOpenIcon = document.getElementById('eye-open');
        const eyeClosedIcon = document.getElementById('eye-closed');

        // Task Tracker App
        const trackerContainer = document.getElementById('tracker-container');
        const signOutBtn = document.getElementById('signOutBtn');
        const addTaskBtn = document.getElementById('addTaskBtn');
        const taskModal = document.getElementById('taskModal');
        const modalTitle = document.getElementById('modalTitle');
        const editTaskId = document.getElementById('editTaskId');
        const cancelBtn = document.getElementById('cancelBtn');
        const saveTaskBtn = document.getElementById('saveTaskBtn');
        const taskInput = document.getElementById('taskInput');
        const taskDate = document.getElementById('taskDate');
        const staffNameSelect = document.getElementById('staffNameSelect');
        const shopNameSelect = document.getElementById('shopNameSelect');
        const columns = document.querySelectorAll('.kanban-column-body');
        const historyTableBody = document.getElementById('historyTableBody');
        const shopFilter = document.getElementById('shopFilter');
        const staffFilter = document.getElementById('staffFilter');
        const dateFilter = document.getElementById('dateFilter');
        const clearFiltersBtn = document.getElementById('clearFiltersBtn');
        const deleteConfirmModal = document.getElementById('deleteConfirmModal');
        const cancelDeleteBtn = document.getElementById('cancelDeleteBtn');
        const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');

        // --- App State ---
        let localHistory = [];
        let taskIdToDelete = null;
        let historyCollection, tasksCollection;
        let sortableInstances = [];
        let unsubscribeTasks = null;
        let unsubscribeHistory = null;


        // --- HELPER FUNCTIONS ---
        const formatDuration = (ms) => {
            if (ms < 0) ms = 0;
            const seconds = Math.floor((ms / 1000) % 60);
            const minutes = Math.floor((ms / (1000 * 60)) % 60);
            const hours = Math.floor((ms / (1000 * 60 * 60)) % 24);
            const days = Math.floor(ms / (1000 * 60 * 60 * 24));
            const parts = [];
            if (days > 0) parts.push(`${days}d`);
            if (hours > 0) parts.push(`${hours}h`);
            if (minutes > 0) parts.push(`${minutes}m`);
            if (parts.length === 0 && seconds > 0) parts.push(`${seconds}s`);
            if (parts.length === 0) return "0s";
            return parts.slice(0, 2).join(' ');
        };
        const formatCompletedDate = (timestamp) => {
            if (!timestamp) return 'N/A';
            return new Date(timestamp.seconds * 1000).toLocaleString('en-US', { dateStyle: 'medium', timeStyle: 'short' });
        }

        // --- LOGIN PAGE LOGIC ---
        togglePasswordBtn.addEventListener('click', () => {
            const isPassword = passwordInput.type === 'password';
            passwordInput.type = isPassword ? 'text' : 'password';
            eyeOpenIcon.classList.toggle('hidden', isPassword);
            eyeClosedIcon.classList.toggle('hidden', !isPassword);
        });

        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = emailInput.value;
            const password = passwordInput.value;
            const rememberMe = rememberMeCheckbox.checked;
            errorMessageDiv.classList.add('hidden');
            errorMessageDiv.textContent = '';
            try {
                const persistence = rememberMe ? browserLocalPersistence : browserSessionPersistence;
                await setPersistence(auth, persistence);
                await signInWithEmailAndPassword(auth, email, password);
            } catch (error) {
                let message = 'An unknown error occurred.';
                switch (error.code) {
                    case 'auth/invalid-email': message = 'Please enter a valid email address.'; break;
                    case 'auth/user-not-found':
                    case 'auth/wrong-password':
                    case 'auth/invalid-credential': message = 'Invalid email or password.'; break;
                    case 'auth/too-many-requests': message = 'Access to this account has been temporarily disabled.'; break;
                }
                errorMessageDiv.textContent = message;
                errorMessageDiv.classList.remove('hidden');
            }
        });
        
        // --- TASK TRACKER LOGIC ---
        function initializeTaskTracker(user) {
            const uid = user.uid;
            tasksCollection = collection(db, 'users', uid, 'tasks');
            historyCollection = collection(db, 'users', uid, 'history');
            
            populateSelectWithOptions('supervisors', staffNameSelect, 'Supervisor');
            populateSelectWithOptions('shops', shopNameSelect, 'Shop');

            setupRealtimeListeners();
            initializeDragAndDrop();
            setupTaskTrackerEventListeners();
        }

        function setupTaskTrackerEventListeners() {
            signOutBtn.onclick = () => signOut(auth);
            addTaskBtn.onclick = openTaskModalForAdd;
            cancelBtn.onclick = closeTaskModal;
            saveTaskBtn.onclick = saveTask;
            window.onkeydown = (e) => e.key === 'Escape' && !taskModal.classList.contains('hidden') && closeTaskModal();
            [shopFilter, staffFilter, dateFilter].forEach(el => el.onchange = renderHistory);
            clearFiltersBtn.onclick = () => {
                shopFilter.value = ''; staffFilter.value = ''; dateFilter.value = '';
                renderHistory();
            };
            historyTableBody.onclick = (e) => {
                const editButton = e.target.closest('.edit-history-btn');
                const deleteButton = e.target.closest('.delete-history-btn');
                if (editButton) {
                    const id = editButton.dataset.id;
                    const task = localHistory.find(t => t.id === id);
                    if (task) openTaskModalForEdit(task);
                }
                if (deleteButton) {
                    taskIdToDelete = deleteButton.dataset.id;
                    deleteConfirmModal.classList.remove('hidden');
                }
            };
            cancelDeleteBtn.onclick = () => deleteConfirmModal.classList.add('hidden');
            confirmDeleteBtn.onclick = deleteTaskFromHistory;
        }
        
        function createTaskCard(task) {
            const card = document.createElement('div');
            card.className = 'task-card bg-slate-50 border border-slate-200 p-4 rounded-lg shadow-sm mb-4 cursor-grab active:cursor-grabbing flex flex-col';
            card.dataset.id = task.id;
            const header = document.createElement('div');
            header.className = 'flex justify-between items-start';
            const text = document.createElement('p');
            text.className = 'text-slate-800 font-semibold flex-grow pr-2';
            text.textContent = task.text;
            const deleteBtn = document.createElement('button');
            deleteBtn.innerHTML = '&times;';
            deleteBtn.className = 'text-slate-400 hover:text-red-500 font-bold text-xl leading-none flex-shrink-0';
            deleteBtn.onclick = (e) => { e.stopPropagation(); deleteTaskFromBoard(task.id); };
            header.appendChild(text);
            header.appendChild(deleteBtn);
            const footer = document.createElement('div');
            footer.className = 'mt-3 pt-3 border-t border-slate-200 text-xs text-slate-500 space-y-1.5';
            const createInfoRow = (icon, label, value) => value ? `<div class="flex items-center"><span class="mr-2">${icon}</span><p><span class="font-medium text-slate-600">${label}:</span> ${value}</p></div>` : '';
            footer.innerHTML += createInfoRow('📅', 'Date', task.date);
            footer.innerHTML += createInfoRow('👤', 'Staff', task.staffName);
            footer.innerHTML += createInfoRow('🏢', 'Shop', task.shopName);
            card.appendChild(header);
            if (task.date || task.staffName || task.shopName) card.appendChild(footer);
            return card;
        };
        
        function renderHistory() {
            const selectedShop = shopFilter.value;
            const selectedStaff = staffFilter.value;
            const selectedDate = dateFilter.value;
            let filteredHistory = localHistory;
            if (selectedShop) filteredHistory = filteredHistory.filter(task => task.shopName === selectedShop);
            if (selectedStaff) filteredHistory = filteredHistory.filter(task => task.staffName === selectedStaff);
            if (selectedDate) filteredHistory = filteredHistory.filter(task => {
                if (!task.completedTimestamp) return false;
                return new Date(task.completedTimestamp.seconds * 1000).toISOString().split('T')[0] === selectedDate
            });
            
            historyTableBody.innerHTML = '';
            if (filteredHistory.length === 0) {
                historyTableBody.innerHTML = `<tr><td colspan="7" class="p-4 text-center text-slate-400">No matching completed tasks.</td></tr>`;
                return;
            }
            filteredHistory.forEach((task, index) => {
                const row = document.createElement('tr');
                row.className = 'border-b border-slate-200 hover:bg-slate-50';
                const duration = task.completedTimestamp && task.createdAt ? formatDuration((task.completedTimestamp.seconds - task.createdAt.seconds) * 1000) : 'N/A';
                row.innerHTML = `
                    <td class="px-2 py-3 sm:p-4">${index + 1}</td>
                    <td class="px-2 py-3 sm:p-4">${task.staffName || 'N/A'}</td>
                    <td class="px-2 py-3 sm:p-4">${task.shopName || 'N/A'}</td>
                    <td class="px-2 py-3 sm:p-4">${task.text}</td>
                    <td class="px-2 py-3 sm:p-4 font-medium">${duration}</td>
                    <td class="px-2 py-3 sm:p-4 text-sm text-slate-500">${formatCompletedDate(task.completedTimestamp)}</td>
                    <td class="px-2 py-3 sm:p-4 text-center">
                        <button class="edit-history-btn text-blue-600 hover:text-blue-800 p-1 text-lg" data-id="${task.id}" title="Edit Task">✏️</button>
                        <button class="delete-history-btn text-red-600 hover:text-red-800 p-1 text-lg" data-id="${task.id}" title="Delete Task">🗑️</button>
                    </td>
                `;
                historyTableBody.appendChild(row);
            });
        };

        function populateFilters() {
            const shopNames = [...new Set(localHistory.map(task => task.shopName).filter(Boolean))];
            const staffNames = [...new Set(localHistory.map(task => task.staffName).filter(Boolean))];
            shopFilter.innerHTML = '<option value="">All Shops</option>';
            staffFilter.innerHTML = '<option value="">All Staff</option>';
            shopNames.forEach(name => shopFilter.innerHTML += `<option value="${name}">${name}</option>`);
            staffNames.forEach(name => staffFilter.innerHTML += `<option value="${name}">${name}</option>`);
        };

        async function populateSelectWithOptions(collectionName, selectElement, fieldName) {
            try {
                const querySnapshot = await getDocs(collection(db, collectionName));
                selectElement.innerHTML = `<option value="">Select ${fieldName}</option>`;
                querySnapshot.forEach((doc) => {
                    const name = doc.data().name;
                    if (name) {
                        const option = document.createElement('option');
                        option.value = name;
                        option.textContent = name;
                        selectElement.appendChild(option);
                    }
                });
            } catch (error) {
                console.error(`Error populating ${fieldName}s:`, error);
            }
        };

        async function deleteTaskFromBoard(id) { await deleteDoc(doc(tasksCollection, id)); };
        async function deleteTaskFromHistory() {
             if (taskIdToDelete) {
                await deleteDoc(doc(historyCollection, taskIdToDelete));
                taskIdToDelete = null;
            }
            deleteConfirmModal.classList.add('hidden');
        };

        function openTaskModalForAdd() {
            modalTitle.textContent = 'Add a New Task';
            editTaskId.value = '';
            taskInput.value = '';
            taskDate.value = '';
            staffNameSelect.value = '';
            shopNameSelect.value = '';
            taskModal.classList.remove('hidden');
            taskInput.focus();
        };
        
        function openTaskModalForEdit(task) {
            modalTitle.textContent = 'Edit Task';
            editTaskId.value = task.id;
            taskInput.value = task.text;
            taskDate.value = task.date;
            staffNameSelect.value = task.staffName;
            shopNameSelect.value = task.shopName;
            taskModal.classList.remove('hidden');
            taskInput.focus();
        };

        function closeTaskModal() { taskModal.classList.add('hidden'); };

        async function saveTask() {
            const id = editTaskId.value;
            const taskData = {
                text: taskInput.value.trim(),
                date: taskDate.value,
                staffName: staffNameSelect.value,
                shopName: shopNameSelect.value,
            };

            if (id) {
                const taskRef = doc(historyCollection, id);
                await updateDoc(taskRef, taskData);
            } else {
                if (!taskData.text) return;
                await addDoc(tasksCollection, {
                    ...taskData,
                    status: 'todo',
                    createdAt: serverTimestamp()
                });
            }
            closeTaskModal();
        };
        
        function setupRealtimeListeners() {
            // Detach any existing listeners
            if (unsubscribeTasks) unsubscribeTasks();
            if (unsubscribeHistory) unsubscribeHistory();

            unsubscribeTasks = onSnapshot(query(tasksCollection), (snapshot) => {
                const tasks = [];
                snapshot.forEach(doc => tasks.push({ id: doc.id, ...doc.data() }));
                columns.forEach(col => col.innerHTML = '');
                tasks.forEach(task => {
                    const card = createTaskCard(task);
                    const column = document.getElementById(task.status);
                    if (column) column.appendChild(card);
                });
            });

            unsubscribeHistory = onSnapshot(query(historyCollection), (snapshot) => {
                localHistory = [];
                snapshot.forEach(doc => localHistory.push({ id: doc.id, ...doc.data() }));
                // Sort client-side to avoid needing a composite index
                localHistory.sort((a, b) => {
                    const timeA = a.completedTimestamp ? a.completedTimestamp.seconds : 0;
                    const timeB = b.completedTimestamp ? b.completedTimestamp.seconds : 0;
                    return timeB - timeA;
                });
                renderHistory();
                populateFilters();
            });
        }

        function initializeDragAndDrop() {
            // Destroy existing instances if they exist
            sortableInstances.forEach(s => s.destroy());
            sortableInstances = [];

            columns.forEach(column => {
                const sortable = new Sortable(column, {
                    group: 'kanban', animation: 150, ghostClass: 'sortable-ghost',
                    onEnd: async (evt) => {
                        const itemEl = evt.item;
                        const toColumn = evt.to;
                        const taskId = itemEl.dataset.id;
                        const newStatus = toColumn.dataset.status;

                        if (newStatus === 'done') {
                            const taskRef = doc(tasksCollection, taskId);
                            const taskSnap = await getDoc(taskRef);
                            if (taskSnap.exists()) {
                                const taskData = taskSnap.data();
                                await addDoc(historyCollection, { ...taskData, status: 'done', completedTimestamp: serverTimestamp() });
                                await deleteDoc(taskRef);
                                const rect = itemEl.getBoundingClientRect();
                                confetti({ particleCount: 150, spread: 90, origin: { x: (rect.left + rect.right) / 2 / window.innerWidth, y: (rect.top + rect.bottom) / 2 / window.innerHeight }, gravity: 1.2 });
                            }
                        } else {
                            const taskRef = doc(tasksCollection, taskId);
                            await updateDoc(taskRef, { status: newStatus });
                        }
                    }
                });
                sortableInstances.push(sortable);
            });
        }

        // --- MAIN AUTHENTICATION FLOW ---
        onAuthStateChanged(auth, (user) => {
            if (user) {
                // User is logged in, show the task tracker
                loginContainer.classList.add('hidden');
                trackerContainer.classList.remove('hidden');
                initializeTaskTracker(user);
            } else {
                // User is logged out, show the login page
                loginContainer.classList.remove('hidden');
                trackerContainer.classList.add('hidden');
                // Clean up listeners from the previous user
                if (unsubscribeTasks) unsubscribeTasks();
                if (unsubscribeHistory) unsubscribeHistory();
                // Destroy sortable instances
                sortableInstances.forEach(s => s.destroy());
                sortableInstances = [];
            }
        });

    </script>
</body>
</html>
