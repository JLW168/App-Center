<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cash Drop Report</title>
    
    <!-- PWA and Mobile App Manifest -->
    <meta name="theme-color" content="#1d4ed8">
    <link rel="apple-touch-icon" href="https://placehold.co/192x192/1d4ed8/ffffff?text=CDR">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="CashDrop">
    <link rel="manifest" href="data:application/manifest+json;base64,ewogICJuYW1lIjogIkNhc2ggRHJvcCBSZXBvcnQiLAogICJzaG9ydF9uYW1lIjogIkNhc2hEcm9wIiwKICAiaWQiOiAiLz9zb3VyY2U9cHdhIiwKICAiZGVzY3JpcHRpb24iOiAiQSBzaW1wbGUgYXBwIGZvciByZXBvcnRpbmcgZGFpbHkgY2FzaCBkcm9wcy4iLAogICJzdGFydF91cmwiOiAiLiIsCiAgImRpc3BsYXkiOiAic3RhbmRhbG9uZSIsCiAgImJhY2tncm91bmRfY29sb3IiOiAiI2YxZjVmOSIsCiAgInRoZW1lX2NvbG9yIjogIiMxZDRlZDgiLAogICJpY29ucyI6IFsKICAgIHsKICAgICAgInNyYyI6ICJodHRwczovL3BsYWNlaG9sZC5jby8xOTJ4MTkyLzFkNGVkOC9mZmZmZmY/dGV4dD1DRFIiLAogICAgICAidHlwZSI6ICJpbWFnZS9wbmciLAogICAgICAic2l6ZXMiOiAiMTkyeDE5MiIsCiAgICAgICJwdXJwb3NlIjogImFueSBtYXNrYWJsZSIKICAgIH0sCiAgICB7CiAgICAgICJzcmMiOiAiaHR0cHM6Ly9wbGFjZWhvbGQuY28vNTEyeDUxMi8xZDRlZDgvZmZmZmZmP3RleHQ9Q0RSIiwKICAgICAidHlwZSI6ICJpbWFnZS9wbmciLAogICAgICAic2l6ZXMiOiAiNTEyeDUxMiIsCiAgICAgICJwdXJwb3NlIjogImFueSBtYXNrYWJsZSIKICAgIH0KICBdCn0=">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React and Babel -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Firebase SDKs -->
    <script type="module">
        // Import SDKs for the firebaseService
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut, setPersistence, browserSessionPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, addDoc, onSnapshot, deleteDoc, getDoc, Timestamp, setDoc, updateDoc, query, orderBy, where } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // Make SDKs available to the global firebaseService object
        window.firebaseSDK = {
            initializeApp,
            getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut, setPersistence, browserSessionPersistence, browserLocalPersistence,
            getFirestore, collection, doc, addDoc, onSnapshot, deleteDoc, getDoc, Timestamp, setDoc, updateDoc, query, orderBy, where
        };
    </script>
    
    <!-- SheetJS (for Excel export) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <!-- Theme initialization script (prevents flash) -->
    <script>
        (function() {
            function getInitialTheme() {
                const persistedTheme = window.localStorage.getItem('theme');
                if (persistedTheme) {
                    return persistedTheme;
                }
                // 'dark' is our app's default (slate-blue)
                return 'dark'; // Always default to 'dark' (Slate Blue)
            }
            const theme = getInitialTheme();
            // Use 'dark' for the default :root styles, not 'root'
            const themeClass = theme === 'dark' ? 'dark' : theme;
            // Apply the class directly to the <html> tag
            document.documentElement.classList.add(themeClass);
        })();
    </script>

    <!-- 
      START: THEME CSS VARIABLES
      All theme definitions are here.
    -->
    <style>
        :root {
            /* Default Dark Theme (Matches original app's Slate Blue) */
            --background-primary: #0f172a;      /* slate-900 */
            --background-secondary: #1e293b;    /* slate-800 */
            --background-input: #334155;     /* slate-700 */
            --text-primary: #f1f5f9;          /* slate-100/200 */
            --text-secondary: #94a3b8;        /* slate-400 */
            --border-color: #334155;          /* slate-700/600 */
            --accent-color: #3b82f6;          /* blue-500 */
            --accent-color-hover: #2563eb;    /* blue-600 */
            
            /* Semantic colors (unchanged by theme) */
            --semantic-red: #ef4444;    /* red-500 */
            --semantic-red-hover: #dc2626; /* red-600 */
            --semantic-green: #22c55e;  /* green-500 */
            --semantic-green-hover: #16a34a; /* green-600 */
            --semantic-yellow: #eab308; /* yellow-500 */
        }

        .light {
            /* Light Theme */
            --background-primary: #ffffff;
            --background-secondary: #f1f5f9;
            --background-input: #ffffff;
            --text-primary: #0f172a;
            --text-secondary: #475569;
            --border-color: #cbd5e1;
            --accent-color: #0284c7;
            --accent-color-hover: #0369a1;
        }
       
        .charcoal {
            /* Charcoal & Orange Theme */
            --background-primary: #171717;
            --background-secondary: #262626;
            --background-input: #404040;
            --text-primary: #f5f5f5;
            --text-secondary: #a3a3a3;
            --border-color: #404040;
            --accent-color: #fb923c;
            --accent-color-hover: #f97316;
        }

        .nord {
            /* Nord Theme */
            --background-primary: #2E3440;
            --background-secondary: #3B4252;
            --background-input: #4C566A;
            --text-primary: #ECEFF4;
            --text-secondary: #D8DEE9;
            --border-color: #4C566A;
            --accent-color: #88C0D0;
            --accent-color-hover: #81A1C1;
        }

        .forest {
            /* Forest Theme */
            --background-primary: #1a2e2c;
            --background-secondary: #2a4a46;
            --background-input: #3a6b63;
            --text-primary: #e6f1f0;
            --text-secondary: #a0c0bd;
            --border-color: #3a6b63;
            --accent-color: #34d399; /* emerald-400 */
            --accent-color-hover: #10b981; /* emerald-500 */
        }
        .rose {
            /* Rosé Theme */
            --background-primary: #3d1c2b;
            --background-secondary: #5c2a41;
            --background-input: #7b3d58;
            --text-primary: #fce7f3;
            --text-secondary: #f4abc4;
            --border-color: #7b3d58;
            --accent-color: #f472b6; /* pink-400 */
            --accent-color-hover: #ec4899; /* pink-500 */
        }
        .ocean {
            /* Ocean Theme */
            --background-primary: #0e2a47;
            --background-secondary: #1c3d66;
            --background-input: #294f85;
            --text-primary: #e0f2fe;
            --text-secondary: #a5cff7;
            --border-color: #294f85;
            --accent-color: #38bdf8; /* sky-400 */
            --accent-color-hover: #0ea5e9; /* sky-500 */
        }
        .sunset {
            /* Sunset Theme */
            --background-primary: #451a03;
            --background-secondary: #6e2905;
            --background-input: #923706;
            --text-primary: #fff7ed;
            --text-secondary: #fdbf8e;
            --border-color: #923706;
            --accent-color: #f97316; /* orange-500 */
            --accent-color-hover: #ea580c; /* orange-600 */
        }
        .lavender {
            /* Lavender Theme */
            --background-primary: #2b234a;
            --background-secondary: #3f356b;
            --background-input: #53488f;
            --text-primary: #e9e7f8;
            --text-secondary: #b6b0d4;
            --border-color: #53488f;
            --accent-color: #a78bfa; /* violet-400 */
            --accent-color-hover: #8b5cf6; /* violet-500 */
        }
        .grayscale {
            /* Grayscale Theme */
            --background-primary: #171717;
            --background-secondary: #262626;
            --background-input: #404040;
            --text-primary: #f5f5f5;
            --text-secondary: #a3a3a3;
            --border-color: #404040;
            --accent-color: #a3a3a3; /* neutral-400 */
            --accent-color-hover: #d4d4d4; /* neutral-300 */
        }
        /* END: THEME CSS VARIABLES */

        /* Base body styles */
        body {
            background-color: var(--background-primary);
            font-family: 'Inter', sans-serif;
            color: var(--text-primary);
            transition: background-color 0.3s, color 0.3s;
        }
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');
    </style>
</head>
<body class="bg-[var(--background-primary)] text-[var(--text-primary)]">
    <div id="root"></div>

    <script type="text/babel">
        // De-structure React hooks for cleaner use
        const { useState, useEffect, useMemo, useCallback, createContext, useContext, useRef } = React;
        // Get imported Firebase SDKs from the global window object
        const { firebaseSDK } = window;

        /******************************************************************************
         * 1. CONFIGURATION
         * App-wide constants and configuration objects.
         *****************************************************************************/
        
        const firebaseConfig = {
            apiKey: "AIzaSyA4upjtl0UFToWSfRZEiEQvwz9ieFLfqhI",
            authDomain: "cashflow-mgr.firebaseapp.com",
            projectId: "cashflow-mgr",
            storageBucket: "cashflow-mgr.appspot.com",
            messagingSenderId: "873891130920",
            appId: "1:873891130920:web:b6b8f0432943c33a930f1d",
            measurementId: "G-LVLMJ8ZY0B"
        };
        
        const DEFAULT_EXCHANGE_RATE = 4000;
        
        const ROLES = {
            ADMIN: 'Admin',
            MANAGEMENT: 'Management',
            SHOP_MANAGER: 'Shop Manager',
            CASHIER: 'Cashier',
            STAFF: 'Staff'
        };
        
        const translations = {
            en: {
                loginTitle: 'JLW Cash Drop', loginSubtitle1: 'Internal Use Only.', loginSubtitle2: 'Please log in to your account.', emailPlaceholder: 'Email address', passwordPlaceholder: 'Password',
                rememberMe: 'Remember me', loginButton: 'Log In', loginError: 'Failed to log in. Please check your email and password.', employeeProfileError: 'Your employee profile was not found. Please contact an administrator.',
                headerTitle: 'Cash Drop Report', welcomeMessage: 'Welcome, {{name}} ({{role}})', installAppButton: 'Install App', logoutButton: 'Logout',
                newFormTitle: 'New Cash Drop Form', dateLabel: 'Date', shopLabel: 'Shop', staffLabel: 'Staff', shiftLabel: 'Shift', byCashTitle: 'By Cash', byBankTitle: 'By Bank',
                cashExchangeTitle: 'Cash Exchange', khrLabel: 'KHR (៛)', usdLabel: 'USD ($)', noteLabel: 'Note', notePlaceholder: 'Add an optional note...', submitReportButton: 'Submit Report',
                summaryTitle: 'Summary', grandTotalLabel: 'Grand Total', cashKhrLabel: 'Cash KHR', cashUsdLabel: 'Cash USD', bankKhrLabel: 'Bank KHR', bankUsdLabel: 'Bank USD',
                cashExchangeKhrLabel: 'Cash Exchange KHR', cashExchangeUsdLabel: 'Cash Exchange USD',
                confirmSubmissionTitle: 'Confirm Report Submission', confirmSubmissionMessage: 'Please review the details before submitting. Is everything correct?',
                confirmDeletionTitle: 'Confirm Deletion', confirmDeletionMessage: 'Are you sure you want to delete this report? This action cannot be undone.',
                cancelButton: 'Cancel', confirmButton: 'Yes, Confirm', deleteButton: 'Delete',
                customDateTitle: 'Select Custom Date Range', startDateLabel: 'Start Date', endDateLabel: 'End Date', applyButton: 'Apply',
                editReportTitle: 'Edit Report', saveChangesButton: 'Save Changes', reportNoteTitle: 'Report Note', closeButton: 'Close',
                submissionSuccessTitle: 'Report Submitted Successfully', submissionSuccessMessage: 'You can now take a screenshot of this summary for your records.',
                historyTitle: 'Daily Cash Drop History', exportButton: 'Export to Excel', allShops: 'All Shops', dueTimeLabel: 'Timeframe',
                timeFilters: { today: 'Today', yesterday: 'Yesterday', thisMonth: 'This Month', lastMonth: 'Last Month', thisYear: 'This Year', lastYear: 'Last Year', custom: 'Custom' },
                noReportsFound: 'No reports found for the selected filters.', dateHeader: 'Date', dateTimeHeader: 'Date & Time', shopHeader: 'Shop', staffHeader: 'Staff', shiftHeader: 'Shift',
                netSaleHeader: 'Net Sale (៛)', cashUsdHeader: 'Cash USD', cashKhrHeader: 'Cash KHR', bankUsdHeader: 'Bank USD', bankKhrHeader: 'Bank KHR', cashExchUsdHeader: 'Cash Exch. USD',
                cashExchKhrHeader: 'Cash Exch. KHR', actionsHeader: 'Actions', subTotal: 'Sub-Total',
            },
            km: {
                loginTitle: 'JLW បញ្ចូលសាច់ប្រាក់', loginSubtitle1: 'សម្រាប់ប្រើប្រាស់តែក្នុងក្រុមហ៊ុនប៉ុណ្ណោះ!', loginSubtitle2: 'សូមចូលទៅកាន់គណនីរបស់អ្នក!', emailPlaceholder: 'អាសយដ្ឋានអ៊ីមែល', passwordPlaceholder: 'ពាក្យសម្ងាត់',
                rememberMe: 'ចងចាំខ្ញុំ', loginButton: 'ចូលគណនី', loginError: 'ការចូលគណនីបានបរាជ័យ។ សូមពិនិត្យអ៊ីមែល និងពាក្យសម្ងាត់របស់អ្នក។', employeeProfileError: 'រកមិនឃើញប្រវត្តិរូបបុគ្គលិករបស់អ្នកទេ។ សូមទាក់ទងអ្នកគ្រប់គ្រង។',
                headerTitle: 'របាយការណ៍បញ្ចូលសាច់ប្រាក់', welcomeMessage: 'សូមស្វាគមន៍, {{name}} ({{role}})', installAppButton: 'ដំឡើងកម្មវិធី', logoutButton: 'ចាកចេញ',
                newFormTitle: 'ទម្រង់បញ្ចូលសាច់ប្រាក់ថ្មី', dateLabel: 'កាលបរិច្ឆេទ', shopLabel: 'ហាង', staffLabel: 'បុគ្គលិក', shiftLabel: 'វេន', byCashTitle: 'តាមសាច់ប្រាក់', byBankTitle: 'តាមធនាគារ',
                cashExchangeTitle: 'សាច់ប្រាក់សម្រាប់ដូរ', khrLabel: 'រៀល (៛)', usdLabel: 'ដុល្លារ ($)', noteLabel: 'កំណត់ចំណាំ', notePlaceholder: 'បន្ថែមចំណាំ (បើមាន)...', submitReportButton: 'បញ្ជូនរបាយការណ៍',
                summaryTitle: 'សេចក្តីសង្ខេប', grandTotalLabel: 'សរុប​រួម', cashKhrLabel: 'សាច់ប្រាក់ រៀល', cashUsdLabel: 'សាច់ប្រាក់ ដុល្លារ', bankKhrLabel: 'ធនាគារ រៀល', bankUsdLabel: 'ធនាគារ ដុល្លារ',
                cashExchangeKhrLabel: 'សាច់ប្រាក់ដូរ រៀល', cashExchangeUsdLabel: 'សាច់ប្រាក់ដូរ ដុល្លារ',
                confirmSubmissionTitle: 'បញ្ជាក់ការបញ្ជូនរបាយការណ៍', confirmSubmissionMessage: 'សូមពិនិត្យមើលព័ត៌មានលម្អិតមុនពេលបញ្ជូន។ ត្រឹមត្រូវហើយឬនៅ?',
                confirmDeletionTitle: 'បញ្ជាក់ការលុប', confirmDeletionMessage: 'តើអ្នកប្រាកដថាចង់លុបរូបាយការណ៍នេះមែនទេ? សកម្មភាពនេះមិនអាចមិនធ្វើវិញបានទេ។',
                cancelButton: 'បោះបង់', confirmButton: 'បាទ/ចាស៎', deleteButton: 'លុប',
                customDateTitle: 'ជ្រើសរើសចន្លោះកាលបរិច្ឆេទ', startDateLabel: 'ថ្ងៃចាប់ផ្តើម', endDateLabel: 'ថ្ងៃបញ្ចប់', applyButton: 'អនុវត្ត',
                editReportTitle: 'កែសម្រួលរបាយការណ៍', saveChangesButton: 'រក្សាទុកការផ្លាស់ប្តូរ', reportNoteTitle: 'កំណត់ចំណាំរបាយការណ៍', closeButton: 'បិទ',
                submissionSuccessTitle: 'របាយការណ៍លក់ត្រូវបានបញ្ចូលជោគជ័យ', submissionSuccessMessage: 'សូមអ្នកធ្វើការថតរបាយការណ៍នេះដើម្បីរាយការណ៍ជូនថ្នាក់លើ!',
                historyTitle: 'ប្រវត្តិរបាយការណ៍បញ្ចូលសាច់ប្រាក់', exportButton: 'នាំចេញជា Excel', allShops: 'គ្រប់ហាងទាំងអស់', dueTimeLabel: 'ពេលវេលា',
                timeFilters: { today: 'ថ្ងៃនេះ', yesterday: 'ម្សិលមិញ', thisMonth: 'ខែនេះ', lastMonth: 'ខែមុន', thisYear: 'ឆ្នាំនេះ', lastYear: 'ឆ្នាំមុន', custom: 'ផ្ទាល់ខ្លួន' },
                noReportsFound: 'រកមិនឃើញរបាយការណ៍សម្រាប់តម្រងដែលបានជ្រើសរើសទេ។', dateHeader: 'កាលបរិច្ឆេទ', dateTimeHeader: 'កាលបរិច្ឆេទ & ម៉ោង', shopHeader: 'ហាង', staffHeader: 'បុគ្គលិក', shiftHeader: 'វេន',
                netSaleHeader: 'លក់សរុប (៛)', cashUsdHeader: 'សាច់ប្រាក់ USD', cashKhrHeader: 'សាច់ប្រាក់ KHR', bankUsdHeader: 'ធនាគារ USD', bankKhrHeader: 'ធនាគារ KHR', cashExchUsdHeader: 'សាច់ប្រាក់ដូរ USD',
                cashExchKhrHeader: 'សាច់ប្រាក់ដូរ KHR', actionsHeader: 'សកម្មភាព', subTotal: 'សរុបរង',
            }
        };

        /******************************************************************************
         * 2. FIREBASE SERVICE
         * Centralized module for all Firebase interactions, created as an IIFE.
         *****************************************************************************/
        
        const firebaseService = (() => {
            // Initialize Firebase app and services ONCE
            let app, auth, db;
            try {
                app = firebaseSDK.initializeApp(firebaseConfig);
                auth = firebaseSDK.getAuth(app);
                db = firebaseSDK.getFirestore(app);
            } catch (e) {
                console.error("Failed to initialize Firebase", e);
                return {}; // Return empty object on failure
            }

            return {
                // --- Getters ---
                getAuth: () => auth,
                getDb: () => db,
                getTimestamp: () => firebaseSDK.Timestamp,

                // --- Auth Methods ---
                onAuthChange: (callback) => {
                    return firebaseSDK.onAuthStateChanged(auth, callback);
                },

                login: async (email, password, rememberMe) => {
                    const persistence = rememberMe 
                        ? firebaseSDK.browserLocalPersistence 
                        : firebaseSDK.browserSessionPersistence;
                    await firebaseSDK.setPersistence(auth, persistence);
                    return firebaseSDK.signInWithEmailAndPassword(auth, email, password);
                },

                logout: () => {
                    return firebaseSDK.signOut(auth);
                },

                fetchEmployeeProfile: async (uid) => {
                    const userDocRef = firebaseSDK.doc(db, 'employees', uid);
                    const userDoc = await firebaseSDK.getDoc(userDocRef);
                    return userDoc.exists() ? { uid, ...userDoc.data() } : null;
                },

                // --- Firestore Methods ---
                streamShops: (callback) => {
                    const q = firebaseSDK.collection(db, "shops");
                    return firebaseSDK.onSnapshot(q, (snapshot) => {
                        const shops = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        callback(shops);
                    }, (err) => console.error("Error fetching shops:", err));
                },

                streamReports: (callback) => {
                    const q = firebaseSDK.query(
                        firebaseSDK.collection(db, "cashDrops"), 
                        firebaseSDK.orderBy("createdAt", "desc")
                    );
                    return firebaseSDK.onSnapshot(q, (snapshot) => {
                        const reports = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        callback(reports);
                    }, (err) => console.error("Error fetching reports:", err));
                },

                addReport: (reportData) => {
                    return firebaseSDK.addDoc(firebaseSDK.collection(db, "cashDrops"), reportData);
                },

                updateReport: (reportId, reportData) => {
                    const reportRef = firebaseSDK.doc(db, "cashDrops", reportId);
                    return firebaseSDK.updateDoc(reportRef, reportData);
                },

                deleteReport: (reportId) => {
                    const reportRef = firebaseSDK.doc(db, "cashDrops", reportId);
                    return firebaseSDK.deleteDoc(reportRef);
                }
            };
        })();

        /******************************************************************************
         * 3. UTILITY FUNCTIONS
         * General-purpose helper functions.
         *****************************************************************************/
        
        /**
         * Parses a formatted currency string (e.g., "1,000.00") into a float.
         */
        const parseCurrency = (val) => parseFloat(String(val).replace(/,/g, '')) || 0;

        /**
         * Formats a number string (e.g., "1000.5") into a formatted currency string (e.g., "1,000.50").
         */
        const formatInputAsCurrency = (val) => val.replace(/[^0-9.]/g, '').replace(/\B(?=(\d{3})+(?!\d))/g, ',');
        
        /**
         * Formats a number into a locale-string with currency symbols.
         */
        const formatCurrency = (value, currency) => {
            const number = parseFloat(String(value).replace(/,/g, '')) || 0;
            const formatted = number.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            return currency === 'KHR' ? `${formatted} ៛` : (currency === 'USD' ? `${formatted} $` : formatted);
        };
        
        /**
         * Formats a Date or Timestamp object to "DD-MM-YYYY".
         */
        const formatDateDDMMYYYY = (date) => {
            if (!date) return 'N/A';
            const d = date.toDate ? date.toDate() : new Date(date);
            const day = String(d.getDate()).padStart(2, '0');
            const month = String(d.getMonth() + 1).padStart(2, '0');
            const year = d.getFullYear();
            return `${day}-${month}-${year}`;
        };

        /**
         * Formats a Date or Timestamp object to "DD-MM-YYYY | HH:MM:SS".
         */
        const formatFullDateTime = (date) => {
            if (!date) return 'N/A';
            const d = date.toDate ? date.toDate() : new Date(date);
            const datePart = formatDateDDMMYYYY(d);
            const timePart = d.toLocaleTimeString('en-GB', { timeZone: 'Asia/Phnom_Penh', hour: '2-digit', minute: '2-digit', second: '2-digit' });
            return `${datePart} | ${timePart}`;
        };

        /******************************************************************************
         * 4. I18N (Internationalization)
         * Context and provider for handling translations.
         *****************************************************************************/

        const LanguageContext = createContext();

        const LanguageProvider = ({ children }) => {
            const [locale, setLocale] = useState('km');

            const t = useCallback((key, params = {}) => {
                const keys = key.split('.');
                let result = translations[locale];
                for (const k of keys) {
                    result = result?.[k];
                    if (result === undefined) {
                        console.warn(`Translation key "${key}" not found for locale "${locale}"`);
                        return key;
                    }
                }
                if (typeof result === 'string' && params) {
                    Object.entries(params).forEach(([paramKey, paramValue]) => {
                        result = result.replace(new RegExp(`{{${paramKey}}}`, 'g'), paramValue);
                    });
                }
                return result;
            }, [locale]);

            const value = { locale, setLocale, t };
            return <LanguageContext.Provider value={value}>{children}</LanguageContext.Provider>;
        };

        /******************************************************************************
         * 5. THEME MANAGEMENT
         * Context and provider for handling light/dark/custom themes.
         *****************************************************************************/
        const ThemeContext = createContext();

        function ThemeProvider({ children }) {
            const [theme, setTheme] = useState(() => {
                // Read from localStorage or default to 'dark'
                const persistedTheme = localStorage.getItem('theme');
                if (persistedTheme) {
                    return persistedTheme;
                }
                // 'dark' is our app's default dark theme (slate-blue)
                return 'dark'; // Always default to 'dark' (Slate Blue)
            });
           
            useEffect(() => {
                const root = window.document.documentElement;
                // Update theme class on the <html> element
                root.classList.remove('dark', 'light', 'charcoal', 'nord', 'forest', 'rose', 'ocean', 'sunset', 'lavender', 'grayscale');
                // Use 'dark' for the default :root styles
                const themeClass = theme === 'dark' ? 'dark' : theme;
                root.classList.add(themeClass);
                localStorage.setItem('theme', theme);
            }, [theme]);

            return (
                <ThemeContext.Provider value={{ theme, setTheme }}>
                    {children}
                </ThemeContext.Provider>
            );
        }

        /******************************************************************************
         * 6. APPLICATION CONTEXTS & PROVIDERS
         * AuthContext: Manages user session and profile.
         * AppContext: Manages global app data (shops, reports).
         *****************************************************************************/
        const AuthContext = createContext();
        const AppContext = createContext();

        const AuthProvider = ({ children }) => {
            const [user, setUser] = useState(null);
            const [userData, setUserData] = useState(null);
            const [loading, setLoading] = useState(true);
            const [authError, setAuthError] = useState(null);

            useEffect(() => {
                if (!firebaseService.onAuthChange) {
                    console.error("Firebase not initialized correctly.");
                    setLoading(false);
                    return;
                }
                
                const unsubscribe = firebaseService.onAuthChange(async (firebaseUser) => {
                    if (firebaseUser) {
                        const profile = await firebaseService.fetchEmployeeProfile(firebaseUser.uid);
                        if (profile) {
                            setUser(firebaseUser);
                            setUserData(profile);
                        } else {
                            await firebaseService.logout();
                            setAuthError({ message: 'employeeProfileError' });
                        }
                    } else {
                        setUser(null);
                        setUserData(null);
                    }
                    setLoading(false);
                });
                return () => unsubscribe();
            }, []);

            const login = useCallback(async (email, password, rememberMe) => {
                return firebaseService.login(email, password, rememberMe);
            }, []);

            const logout = useCallback(() => {
                return firebaseService.logout();
            }, []);

            const value = { user, userData, login, logout, loading, authError, setAuthError };
            return <AuthContext.Provider value={value}>{children}</AuthContext.Provider>;
        };

        const AppProvider = ({ children }) => {
            const { userData } = useContext(AuthContext); // Use useContext directly
            const [shops, setShops] = useState([]);
            const [reports, setReports] = useState([]);
            const [isLoading, setIsLoading] = useState(true);

            useEffect(() => {
                if (!userData || !firebaseService.streamShops) return;

                const canViewDashboard = userData.role !== ROLES.CASHIER && userData.role !== ROLES.STAFF;

                let unsubReports = () => {};
                if (canViewDashboard) {
                    unsubReports = firebaseService.streamReports(setReports);
                }
                
                const unsubShops = firebaseService.streamShops((allShops) => {
                    setShops(allShops);
                    setIsLoading(false);
                });

                return () => {
                    unsubReports();
                    unsubShops();
                };
            }, [userData]);

            const value = { shops, reports, isLoading, appSettings: { exchangeRate: DEFAULT_EXCHANGE_RATE } };
            return <AppContext.Provider value={value}>{children}</AppContext.Provider>;
        };
        
        /******************************************************************************
         * 7. CUSTOM HOOKS
         * Reusable logic hooks for accessing contexts and deriving state.
         *****************************************************************************/
        const useTranslation = () => useContext(LanguageContext);
        const useTheme = () => useContext(ThemeContext);
        const useAuth = () => useContext(AuthContext);
        const useAppContext = () => useContext(AppContext);

        /**
         * Returns a memoized list of shops available to the current user.
         */
        const useAvailableShops = () => {
            const { shops } = useAppContext();
            const { userData } = useAuth();
            
            return useMemo(() => {
                if (!userData || !shops) return [];
                const { role, shopIds } = userData;
                if (role === ROLES.ADMIN || role === ROLES.MANAGEMENT) {
                    return shops;
                }
                return shops.filter(s => shopIds?.includes(s.id));
            }, [shops, userData]);
        };

        /**
         * REFACTOR: New hook to provide themed colors for shop rows.
         */
        const useShopColorMap = () => {
            const { shops } = useAppContext();
            return useMemo(() => {
                const colors = ['blue', 'green', 'yellow', 'pink', 'indigo', 'teal'];
                return shops.reduce((map, shop, index) => {
                    const color = colors[index % colors.length];
                    // These are Tailwind JIT classes, which won't work perfectly in a
                    // single-file build. This logic is preserved from the original.
                    map[shop.name] = { base: `bg-${color}-900/20`, hover: `hover:bg-${color}-800/30` };
                    return map;
                }, {});
            }, [shops]);
        };

        /**
         * Memoized hook to filter and aggregate reports based on user filters.
         * REFACTOR: Now uses helper functions defined *inside* for cleaner encapsulation.
         */
        const useFilteredReports = (reports, filters, userData, availableShops) => {
            return useMemo(() => {
                
                // --- Helper Functions (Encapsulated) ---
                
                const getFilterDateRange = (dueTime, startDate, endDate) => {
                    const now = new Date();
                    let startFilterDate, endFilterDate;
                    
                    switch (dueTime) {
                        case 'Today':
                            startFilterDate = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                            break;
                        case 'Yesterday':
                            startFilterDate = new Date(now.getFullYear(), now.getMonth(), now.getDate() - 1);
                            endFilterDate = new Date(now.getFullYear(), now.getMonth(), now.getDate() - 1, 23, 59, 59, 999);
                            break;
                        case 'This Month':
                            startFilterDate = new Date(now.getFullYear(), now.getMonth(), 1);
                            break;
                        case 'Last Month':
                            startFilterDate = new Date(now.getFullYear(), now.getMonth() - 1, 1);
                            endFilterDate = new Date(now.getFullYear(), now.getMonth(), 0, 23, 59, 59, 999);
                            break;
                        case 'This Year':
                            startFilterDate = new Date(now.getFullYear(), 0, 1);
                            break;
                        case 'Last Year':
                            startFilterDate = new Date(now.getFullYear() - 1, 0, 1);
                            endFilterDate = new Date(now.getFullYear() - 1, 11, 31, 23, 59, 59, 999);
                            break;
                        case 'Custom':
                            if (startDate && endDate) {
                                startFilterDate = new Date(startDate);
                                endFilterDate = new Date(endDate);
                                endFilterDate.setHours(23, 59, 59, 999);
                            }
                            break;
                    }
                    return { startFilterDate, endFilterDate };
                };

                const aggregateReportData = (reports, dueTime) => {
                    const aggregated = reports.reduce((acc, report) => {
                        const date = report.createdAt.toDate();
                        const period = ['This Month', 'Last Month'].includes(dueTime)
                            ? date.toLocaleString('en-US', { month: 'short', year: 'numeric' })
                            : date.getFullYear().toString();
                        const key = `${period}|${report.shop}`;
                        if (!acc[key]) {
                            acc[key] = { period, shop: report.shop, cashUsd: 0, cashKhr: 0, bankUsd: 0, bankKhr: 0, grandTotalKhr: 0, cashExchangeKhr: 0, cashExchangeUsd: 0 };
                        }
                        acc[key].cashUsd += report.cashUsd || 0;
                        acc[key].cashKhr += report.cashKhr || 0;
                        acc[key].bankUsd += report.bankUsd || 0;
                        acc[key].bankKhr += report.bankKhr || 0;
                        acc[key].cashExchangeKhr += report.cashExchangeKhr || 0;
                        acc[key].cashExchangeUsd += report.cashExchangeUsd || 0;
                        acc[key].grandTotalKhr += report.grandTotalKhr || 0;
                        return acc;
                    }, {});
                    return Object.values(aggregated);
                };
                
                const calculateReportTotals = (reports) => {
                     return reports.reduce((acc, r) => {
                        acc.cashUsd += r.cashUsd || 0;
                        acc.cashKhr += r.cashKhr || 0;
                        acc.bankUsd += r.bankUsd || 0;
                        acc.bankKhr += r.bankKhr || 0;
                        acc.cashExchangeKhr += r.cashExchangeKhr || 0;
                        acc.cashExchangeUsd += r.cashExchangeUsd || 0;
                        acc.netSale += r.grandTotalKhr || 0;
                        return acc;
                    }, { cashUsd: 0, cashKhr: 0, bankUsd: 0, bankKhr: 0, cashExchangeKhr: 0, cashExchangeUsd: 0, netSale: 0 });
                };

                // --- Main Hook Logic ---
                
                if (!reports || !userData) return { filteredAndAggregatedData: null, totals: {} };

                // 1. Filter reports based on user's permissions (Admin/Mgmt vs. Shop Manager)
                const userFilteredReports = (userData.role === ROLES.ADMIN || userData.role === ROLES.MANAGEMENT)
                    ? reports
                    : reports.filter(report => availableShops.map(s => s.name).includes(report.shop));

                // 2. Apply dashboard filters (Date range, Shop)
                let filtered = userFilteredReports;
                const { dueTime, startDate, endDate, shop } = filters;
                
                // Use helper to get date range
                const { startFilterDate, endFilterDate } = getFilterDateRange(dueTime, startDate, endDate);

                if (startFilterDate) {
                    filtered = filtered.filter(r => {
                        const reportDate = r.createdAt?.toDate();
                        if (!reportDate) return false;
                        const isAfterStart = reportDate >= startFilterDate;
                        const isBeforeEnd = endFilterDate ? reportDate <= endFilterDate : true;
                        return isAfterStart && isBeforeEnd;
                    });
                }
                
                if (shop) filtered = filtered.filter(r => r.shop === shop);
                
                // 3. Aggregate data if necessary (e.g., for "This Month", "This Year")
                let type = 'detailed';
                let data = filtered;

                if (!['Today', 'Yesterday', 'Custom'].includes(dueTime)) {
                    type = 'aggregated';
                    // Use helper to aggregate data
                    data = aggregateReportData(filtered, dueTime);
                }

                // 4. Calculate totals for the footer
                // Use helper to calculate totals
                const totals = calculateReportTotals(data);

                return { filteredAndAggregatedData: { type, data }, totals };

            }, [reports, filters, userData, availableShops]);
        };
        
        /******************************************************************************
         * 8. SHARED UI COMPONENTS
         * Small, reusable components used throughout the application.
         *****************************************************************************/
        
        /**
         * Icon library component.
         */
        const Icon = React.memo(({ name, className = "w-5 h-5" }) => {
            // Icon definitions remain unchanged
            const icons = {
                loader: <svg className={`${className} animate-spin`} xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle><path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>,
                note: <svg className={className} xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.5L15.232 5.232z" /></svg>,
                trash: <svg className={className} xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>,
                logout: <svg className={className} xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" d="M15.75 9V5.25A2.25 2.25 0 0013.5 3h-6a2.25 2.25 0 00-2.25 2.25v13.5A2.25 2.25 0 007.5 21h6a2.25 2.25 0 002.25-2.25V15m3 0l-3-3m0 0l-3 3m3-3V9" /></svg>,
                eye: <svg className={className} xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" d="M2.036 12.322a1.012 1.012 0 010-.639C3.423 7.51 7.36 4.5 12 4.5c4.638 0 8.573 3.007 9.963 7.178.07.207.07.431 0 .639C20.577 16.49 16.64 19.5 12 19.5c-4.638 0-8.573-3.007-9.963-7.178z" /><path strokeLinecap="round" strokeLinejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>,
                'eye-off': <svg className={className} xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" d="M3.98 8.223A10.477 10.477 0 001.934 12C3.226 16.338 7.244 19.5 12 19.5c.993 0 1.953-.138 2.863-.395M6.228 6.228A10.45 10.45 0 0112 4.5c4.756 0 8.773 3.162 10.065 7.498a10.523 10.523 0 01-4.293 5.774M6.228 6.228L3 3m3.228 3.228l3.65 3.65m7.894 7.894L21 21m-3.228-3.228l-3.65-3.65m0 0a3 3 0 10-4.243-4.243m4.243 4.243L6.228 6.228" /></svg>,
                install: <svg className={className} xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5M16.5 12L12 16.5m0 0L7.5 12m4.5 4.5V3" /></svg>,
                export: <svg className={className} xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" d="M12 9.75v6.75m0 0l-3-3m3 3l3-3m-8.25 6a4.5 4.5 0 01-1.41-8.775 5.25 5.25 0 0110.233-2.33 3 3 0 013.758 3.848A3.752 3.752 0 0118 19.5H6.75z" /></svg>,
                'document-text': <svg className={className} xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m0 12.75h7.5m-7.5 3H12M10.5 2.25H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 00-9-9z" /></svg>,
                'palette': <svg className={className} xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" d="M4.098 19.902a3.75 3.75 0 005.304 0l6.401-6.402M6.75 21A3.75 3.75 0 013 17.25V4.125C3 3.504 3.504 3 4.125 3h5.25c.621 0 1.125.504 1.125 1.125v4.072M6.75 21a3.75 3.75 0 003.75-3.75V8.197M6.75 21h13.125c.621 0 1.125-.504 1.125-1.125V4.125C21 3.504 20.496 3 19.875 3H17.25z" /></svg>
            };
            return icons[name] || null;
        });

        /**
         * Full-screen loading spinner.
         */
        const LoadingSpinner = () => (
            <div className="flex justify-center items-center h-screen">
                <Icon name="loader" className="w-12 h-12 text-[var(--accent-color)]" />
            </div>
        );

        /**
         * Generic Modal component shell.
         */
        const Modal = ({ children, onClose, isOpen }) => {
            if (!isOpen) return null;
            return (
                // Modal container with backdrop
                <div className="fixed inset-0 bg-black bg-opacity-70 z-50 flex justify-center items-center p-4" onClick={onClose}>
                    {/* Modal content box */}
                    <div className="bg-[var(--background-secondary)] border border-[var(--border-color)] rounded-lg shadow-xl w-full max-w-md flex flex-col max-h-[90vh]" onClick={e => e.stopPropagation()}>
                        {children}
                    </div>
                </div>
            );
        };
        
        /**
         * Standardized Modal Header
         */
        const ModalHeader = ({ children, onClose }) => (
            <div className="p-6 border-b border-[var(--border-color)]">
                <h3 className="text-lg font-bold text-[var(--text-primary)]">{children}</h3>
            </div>
        );

        /**
         * Standardized Modal Body (scrollable)
         */
        const ModalBody = ({ children, className = "" }) => (
            <div className={`p-6 flex-grow overflow-y-auto ${className}`}>
                {children}
            </div>
        );
        
        /**
         * Standardized Modal Footer
         */
        const ModalFooter = ({ children }) => (
            <div className="bg-[var(--background-primary)]/50 px-6 py-3 flex justify-end items-center gap-3 border-t border-[var(--border-color)] sticky bottom-0 rounded-b-lg">
                {children}
            </div>
        );
        
        /**
         * Reusable, memoized FormInput component.
         */
        const FormInput = React.memo(({ label, name, ...props }) => (
            <div>
                <label htmlFor={name} className="block text-sm font-medium text-[var(--text-secondary)] mb-1">{label}</label>
                <input id={name} name={name} {...props} className="block w-full px-3 py-2 bg-[var(--background-input)] border border-[var(--border-color)] rounded-lg shadow-sm placeholder-[var(--text-secondary)] focus:outline-none focus:ring-2 focus:ring-[var(--accent-color)] text-[var(--text-primary)] disabled:bg-[var(--background-secondary)] disabled:text-[var(--text-secondary)]" />
            </div>
        ));

        /**
         * Reusable, memoized FormSelect component.
         */
        const FormSelect = React.memo(({ label, name, options, ...props }) => (
            <div>
                <label htmlFor={name} className="block text-sm font-medium text-[var(--text-secondary)] mb-1">{label}</label>
                <select id={name} name={name} {...props} className="block w-full px-3 py-2 bg-[var(--background-input)] border border-[var(--border-color)] rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-[var(--accent-color)] text-[var(--text-primary)]">
                    {options.map(o => <option key={o.value} value={o.value}>{o.label}</option>)}
                </select>
            </div>
        ));
        
        /**
         * Reusable, memoized CurrencyInputGroup component.
         */
        const CurrencyInputGroup = React.memo(({ title, khrName, usdName, khrValue, usdValue, onChange }) => {
            const { t } = useTranslation();
            return (
                <div>
                    <h3 className="text-md font-semibold text-[var(--text-secondary)]">{title}</h3>
                    <div className="grid grid-cols-1 sm:grid-cols-2 gap-4 mt-2">
                        <FormInput label={t('khrLabel')} name={khrName} value={khrValue} onChange={onChange} placeholder="0.00" />
                        <FormInput label={t('usdLabel')} name={usdName} value={usdValue} onChange={onChange} placeholder="0.00" />
                    </div>
                </div>
            )
        });

        /**
         * Theme switcher component with popover grid.
         */
        const ThemeSwitcher = () => {
            const { theme, setTheme } = useTheme();
            const [isOpen, setIsOpen] = useState(false);
            const popoverRef = useRef(null);
            
            // Theme definitions for the switcher UI
            const themes = [
                { name: 'dark', color: '#0f172a', label: 'Slate Blue' },
                { name: 'light', color: '#ffffff', label: 'Light' },
                { name: 'charcoal', color: '#171717', label: 'Charcoal' },
                { name: 'nord', color: '#2E3440', label: 'Nord' },
                { name: 'sunset', color: '#451a03', label: 'Sunset' },
                { name: 'forest', color: '#1a2e2c', label: 'Forest' },
                { name: 'ocean', color: '#0e2a47', label: 'Ocean' },
                { name: 'lavender', color: '#2b234a', label: 'Lavender' },
                { name: 'rose', color: '#3d1c2b', label: 'Rosé' },
                { name: 'grayscale', color: '#171717', label: 'Grayscale' }
            ];

            // Effect to handle clicks outside the popover
            useEffect(() => {
                const handleClickOutside = (event) => {
                    if (popoverRef.current && !popoverRef.current.contains(event.target)) {
                        setIsOpen(false);
                    }
                };
                if (isOpen) {
                    document.addEventListener('mousedown', handleClickOutside);
                }
                return () => {
                    document.removeEventListener('mousedown', handleClickOutside);
                };
            }, [isOpen]);

            const handleThemeChange = (themeName) => {
                setTheme(themeName);
                setIsOpen(false);
            };

            return (
                <div className="relative">
                    <button
                        onClick={() => setIsOpen(!isOpen)}
                        className="bg-[var(--background-input)]/50 p-2 rounded-lg text-[var(--text-secondary)] hover:text-[var(--text-primary)] hover:bg-[var(--background-input)] focus:outline-none"
                        title="Change theme"
                    >
                        <Icon name="palette" className="w-5 h-5" />
                        <span className="sr-only">Change theme</span>
                    </button>
                    
                    {isOpen && (
                        <div
                            ref={popoverRef}
                            className="absolute right-0 top-12 z-50 w-64 p-4 bg-[var(--background-secondary)] border border-[var(--border-color)] rounded-lg shadow-2xl"
                        >
                            <span className="text-sm font-medium text-[var(--text-secondary)] mb-3 block">Select Theme</span>
                            <div className="grid grid-cols-5 gap-3">
                                {themes.map((themeOption) => (
                                    <button
                                        key={themeOption.name}
                                        title={themeOption.label}
                                        onClick={() => handleThemeChange(themeOption.name)}
                                        className={`w-8 h-8 rounded-full focus:outline-none transition-all ${
                                            theme === themeOption.name 
                                                ? 'ring-2 ring-offset-2 ring-[var(--accent-color)] ring-offset-[var(--background-secondary)]' 
                                                : 'ring-1 ring-gray-500/50 hover:ring-2 hover:ring-[var(--accent-color)]/70'
                                        } ${themeOption.name === 'light' ? 'border border-[var(--border-color)]' : ''}`}
                                        style={{ backgroundColor: themeOption.color }}
                                    >
                                        <span className="sr-only">{themeOption.label}</span>
                                    </button>
                                ))}
                            </div>
                        </div>
                    )}
                </div>
            );
        }
        
        /******************************************************************************
         * 9. MODAL COMPONENTS
         * Reusable and specific modal dialogs.
         *****************************************************************************/
        
        /**
         * Generic confirmation modal.
         */
        const ConfirmationModal = ({ isOpen, onClose, onConfirm, isSubmitting, title, message, confirmText, confirmColor = 'accent' }) => {
            const { t } = useTranslation();
            const colorClasses = {
                accent: "bg-[var(--accent-color)] hover:bg-[var(--accent-color-hover)] text-white",
                red: "bg-[var(--semantic-red)] hover:bg-[var(--semantic-red-hover)] text-white"
            };

            return (
                <Modal isOpen={isOpen} onClose={onClose}>
                    <ModalHeader>{title}</ModalHeader>
                    <ModalBody>
                        <p className="text-sm text-[var(--text-secondary)]">{message}</p>
                    </ModalBody>
                    <ModalFooter>
                        <button onClick={onClose} disabled={isSubmitting} className="px-4 py-2 text-sm font-medium text-[var(--text-primary)] bg-[var(--background-input)] border border-[var(--border-color)] rounded-md hover:brightness-110 disabled:opacity-50">
                            {t('cancelButton')}
                        </button>
                        <button onClick={onConfirm} disabled={isSubmitting} className={`px-4 py-2 text-sm font-medium rounded-md disabled:opacity-50 flex items-center gap-2 ${colorClasses[confirmColor]}`}>
                            {isSubmitting && <Icon name="loader" className="w-4 h-4" />}
                            {confirmText}
                        </button>
                    </ModalFooter>
                </Modal>
            );
        };
        
        /**
         * Modal for selecting a custom date range.
         */
        const CustomDateRangeModal = ({ isOpen, onClose, onApply }) => {
            const { t } = useTranslation();
            const [dates, setDates] = useState({ startDate: '', endDate: '' });
            const handleApply = () => { onApply(dates); onClose(); };
            
            return (
                <Modal isOpen={isOpen} onClose={onClose}>
                    <ModalHeader>{t('customDateTitle')}</ModalHeader>
                    <ModalBody>
                        <div className="space-y-4">
                            <FormInput label={t('startDateLabel')} type="date" value={dates.startDate} onChange={e => setDates(d => ({...d, startDate: e.target.value}))} />
                            <FormInput label={t('endDateLabel')} type="date" value={dates.endDate} onChange={e => setDates(d => ({...d, endDate: e.target.value}))} />
                        </div>
                    </ModalBody>
                    <ModalFooter>
                        <button onClick={onClose} className="px-4 py-2 text-sm font-medium text-[var(--text-primary)] bg-[var(--background-input)] border border-[var(--border-color)] rounded-md hover:brightness-110">{t('cancelButton')}</button>
                        <button onClick={handleApply} className="px-4 py-2 text-sm font-medium text-white bg-[var(--accent-color)] rounded-md hover:bg-[var(--accent-color-hover)]">{t('applyButton')}</button>
                    </ModalFooter>
                </Modal>
            );
        };

        /**
         * Modal for editing an existing report.
         */
        const EditReportModal = ({ isOpen, onClose, onSave, report, isSubmitting, shops }) => {
            const { t } = useTranslation();
            const [formData, setFormData] = useState({});
            
            useEffect(() => {
                if (report) {
                    setFormData({ ...report,
                        date: report.createdAt?.toDate().toISOString().split('T')[0] || '',
                        cashUsd: String(report.cashUsd || ''), cashKhr: String(report.cashKhr || ''),
                        bankUsd: String(report.bankUsd || ''), bankKhr: String(report.bankKhr || ''),
                        cashExchangeKhr: String(report.cashExchangeKhr || ''),
                        cashExchangeUsd: String(report.cashExchangeUsd || ''),
                        note: report.note || '',
                    });
                } else {
                    setFormData({});
                }
            }, [report]);

            const handleFormChange = useCallback((e) => {
                const { name, value } = e.target;
                if (['cashUsd', 'cashKhr', 'bankUsd', 'bankKhr', 'cashExchangeKhr', 'cashExchangeUsd'].includes(name)) {
                    setFormData(prev => ({ ...prev, [name]: formatInputAsCurrency(value) }));
                } else {
                    setFormData(prev => ({ ...prev, [name]: value }));
                }
            }, []);

            const handleSave = (e) => { e.preventDefault(); onSave(formData); };
            
            return (
                <Modal isOpen={isOpen} onClose={onClose}>
                    <ModalHeader>{t('editReportTitle')}</ModalHeader>
                    {/* Form tag wraps body and footer for proper submission */}
                    <form onSubmit={handleSave}>
                        <ModalBody className="space-y-4">
                            <FormInput label={t('dateLabel')} type="date" name="date" value={formData.date || ''} onChange={handleFormChange} required />
                            <FormSelect label={t('shopLabel')} name="shop" value={formData.shop || ''} onChange={handleFormChange} options={shops.map(s => ({value: s.name, label: s.name}))} required />
                            <FormInput label={t('staffLabel')} name="staff" value={formData.staff || ''} disabled />
                            <FormSelect label={t('shiftLabel')} name="shift" value={formData.shift || 'AM'} onChange={handleFormChange} options={[{value:'AM', label:'AM'}, {value:'PM', label:'PM'}]} />
                            <CurrencyInputGroup title={t('byCashTitle')} khrName="cashKhr" usdName="cashUsd" khrValue={formData.cashKhr || ''} usdValue={formData.cashUsd || ''} onChange={handleFormChange} />
                            <CurrencyInputGroup title={t('byBankTitle')} khrName="bankKhr" usdName="bankUsd" khrValue={formData.bankKhr || ''} usdValue={formData.bankUsd || ''} onChange={handleFormChange} />
                            <CurrencyInputGroup title={t('cashExchangeTitle')} khrName="cashExchangeKhr" usdName="cashExchangeUsd" khrValue={formData.cashExchangeKhr || ''} usdValue={formData.cashExchangeUsd || ''} onChange={handleFormChange} />
                            <FormInput label={t('noteLabel')} name="note" value={formData.note || ''} onChange={handleFormChange} placeholder={t('notePlaceholder')}/>
                        </ModalBody>
                        <ModalFooter>
                            <button type="button" onClick={onClose} disabled={isSubmitting} className="px-4 py-2 text-sm font-medium text-[var(--text-primary)] bg-[var(--background-input)] border border-[var(--border-color)] rounded-md hover:brightness-110">{t('cancelButton')}</button>
                            <button type="submit" disabled={isSubmitting} className="px-4 py-2 text-sm font-medium text-white bg-[var(--accent-color)] rounded-md hover:bg-[var(--accent-color-hover)] disabled:opacity-50 flex items-center gap-2">
                                {isSubmitting && <Icon name="loader" className="w-4 h-4" />} {t('saveChangesButton')}
                            </button>
                        </ModalFooter>
                    </form>
                </Modal>
            );
        };

        /**
         * Modal for viewing a report's note.
         */
        const NoteViewModal = ({ isOpen, onClose, note }) => {
            const { t } = useTranslation();
            return (
                <Modal isOpen={isOpen} onClose={onClose}>
                    <ModalHeader>{t('reportNoteTitle')}</ModalHeader>
                    <ModalBody>
                        <p className="text-[var(--text-secondary)] whitespace-pre-wrap">{note}</p>
                    </ModalBody>
                    <ModalFooter>
                        <button type="button" onClick={onClose} className="px-4 py-2 text-sm font-medium text-[var(--text-primary)] bg-[var(--background-input)] border border-[var(--border-color)] rounded-md hover:brightness-110">{t('closeButton')}</button>
                    </ModalFooter>
                </Modal>
            );
        };

        /**
         * Reusable Summary content for preview and success modal.
         */
        const SummaryContent = React.memo(({ formData, grandTotal }) => {
            const { t } = useTranslation();
            const [currentTime, setCurrentTime] = useState(new Date());

            useEffect(() => {
                const timerId = setInterval(() => setCurrentTime(new Date()), 1000);
                return () => clearInterval(timerId);
            }, []);

            const formattedDate = useMemo(() => {
                if (!formData.date) return 'N/A';
                const [year, month, day] = formData.date.split('-');
                return `${day}-${month}-${year}`;
            }, [formData.date]);
            
            return (
                 <div className="bg-[var(--background-secondary)]/50 border border-[var(--border-color)] p-6 rounded-lg shadow-lg space-y-4">
                    {/* Header */}
                    <div className="border-b border-[var(--border-color)] pb-4">
                        <h3 className="text-xl font-semibold text-[var(--text-primary)] text-center">{t('summaryTitle')}</h3>
                        <div className="text-center text-sm mt-2">
                             <p className="font-semibold text-[var(--text-secondary)]">
                                <span className="font-sans">{formattedDate}</span>
                                <span className="mx-2 text-[var(--text-secondary)]/50">|</span>
                                <span className="font-mono">{currentTime.toLocaleTimeString('en-GB', { timeZone: 'Asia/Phnom_Penh', hour: '2-digit', minute: '2-digit', second: '2-digit' })}</span>
                            </p>
                        </div>
                    </div>
                    {/* Info */}
                    <div className="space-y-2 text-sm pt-2">
                        <div className="flex justify-between items-center"><span className="text-[var(--text-secondary)]">{t('shopLabel')}:</span><span className="font-semibold text-[var(--text-primary)]">{formData.shop}</span></div>
                        <div className="flex justify-between items-center"><span className="text-[var(--text-secondary)]">{t('staffLabel')}:</span><span className="font-semibold text-[var(--text-primary)]">{formData.staff}</span></div>
                        <div className="flex justify-between items-center"><span className="text-[var(--text-secondary)]">{t('shiftLabel')}:</span><span className="font-semibold text-[var(--text-primary)]">{formData.shift}</span></div>
                    </div>
                    {/* Totals */}
                    <div className="border-t border-[var(--border-color)] !my-4"></div>
                    <div className="space-y-3 text-md">
                        <div className="flex justify-between items-center"><span className="text-[var(--text-secondary)]">{t('cashKhrLabel')} :</span><span className="font-mono font-semibold text-[var(--text-primary)]">{formatCurrency(formData.cashKhr, 'KHR')}</span></div>
                        <div className="flex justify-between items-center"><span className="text-[var(--text-secondary)]">{t('cashUsdLabel')} :</span><span className="font-mono font-semibold text-[var(--text-primary)]">{formatCurrency(formData.cashUsd, 'USD')}</span></div>
                        <div className="flex justify-between items-center"><span className="text-[var(--text-secondary)]">{t('bankKhrLabel')} :</span><span className="font-mono font-semibold text-[var(--text-primary)]">{formatCurrency(formData.bankKhr, 'KHR')}</span></div>
                        <div className="flex justify-between items-center"><span className="text-[var(--text-secondary)]">{t('bankUsdLabel')} :</span><span className="font-mono font-semibold text-[var(--text-primary)]">{formatCurrency(formData.bankUsd, 'USD')}</span></div>
                    </div>
                    {/* Grand Total */}
                    <div className="border-t border-[var(--border-color)] !my-4"></div>
                    <div className="flex justify-between items-center"><span className="font-bold text-[var(--text-primary)] text-lg">{t('grandTotalLabel')} :</span><span className="font-extrabold text-[var(--semantic-red)] text-2xl">{formatCurrency(grandTotal, 'KHR')}</span></div>
                    {/* Cash Exchange */}
                    <div className="border-t border-[var(--border-color)] !my-4"></div>
                    <div className="space-y-3 text-md">
                        <div className="flex justify-between items-center"><span className="text-[var(--text-secondary)]">{t('cashExchangeKhrLabel')} :</span><span className="font-mono font-semibold text-[var(--text-primary)]">{formatCurrency(formData.cashExchangeKhr, 'KHR')}</span></div>
                        <div className="flex justify-between items-center"><span className="text-[var(--text-secondary)]">{t('cashExchangeUsdLabel')} :</span><span className="font-mono font-semibold text-[var(--text-primary)]">{formatCurrency(formData.cashExchangeUsd, 'USD')}</span></div>
                    </div>
                    {/* Note */}
                    {formData.note && (
                        <>
                            <div className="border-t border-[var(--border-color)] !my-4"></div>
                            <div>
                                <h4 className="font-semibold text-[var(--text-secondary)] mb-1">{t('noteLabel')}:</h4>
                                <p className="text-sm text-[var(--text-secondary)] bg-[var(--background-primary)]/50 p-3 rounded-md whitespace-pre-wrap">{formData.note}</p>
                            </div>
                        </>
                    )}
                </div>
            );
        });

        /**
         * Modal to show after successful submission.
         */
        const SummaryPreviewModal = ({ isOpen, onClose, formData, grandTotal }) => {
            const { t } = useTranslation();
            return (
                <Modal isOpen={isOpen} onClose={onClose}>
                    <ModalHeader>
                        <div className="text-center">
                            <h3 className="text-lg font-bold text-[var(--text-primary)]">{t('submissionSuccessTitle')}</h3>
                            <p className="mt-2 text-sm text-[var(--text-secondary)]">{t('submissionSuccessMessage')}</p>
                        </div>
                    </ModalHeader>
                    <ModalBody className="bg-[var(--background-primary)]">
                        {/* Use the reusable SummaryContent component */}
                        <SummaryContent formData={formData} grandTotal={grandTotal} />
                    </ModalBody>
                    <ModalFooter>
                        <button type="button" onClick={onClose} className="w-full justify-center px-4 py-2 text-sm font-medium text-white bg-[var(--accent-color)] rounded-md hover:bg-[var(--accent-color-hover)]">
                            {t('closeButton')}
                        </button>
                    </ModalFooter>
                </Modal>
            );
        };

        /******************************************************************************
         * 10. MAIN APPLICATION COMPONENTS
         * The core building blocks of the logged-in experience.
         *****************************************************************************/

        /**
         * Main Application Header
         */
        const AppHeader = () => {
            const { userData, logout } = useAuth();
            const { t, locale, setLocale } = useTranslation();
            const [installPrompt, setInstallPrompt] = useState(null);

            // Effect to capture the PWA install prompt
            useEffect(() => {
                const handler = e => { e.preventDefault(); setInstallPrompt(e); };
                window.addEventListener('beforeinstallprompt', handler);
                return () => window.removeEventListener('beforeinstallprompt', handler);
            }, []);

            const handleInstallClick = () => {
                if (!installPrompt) return;
                installPrompt.prompt();
                installPrompt.userChoice.then(() => setInstallPrompt(null));
            };

            return (
                <header className="bg-[var(--background-secondary)]/50 border border-[var(--border-color)] p-4 rounded-lg shadow-lg mb-6 flex flex-col sm:flex-row justify-between items-center gap-4">
                    <div className="text-center sm:text-left">
                        <h1 className="text-2xl font-semibold text-[var(--text-primary)]">{t('headerTitle')}</h1>
                        <p className="mt-1 text-sm text-[var(--text-secondary)]">{t('welcomeMessage', { name: userData.name, role: userData.role })}</p>
                    </div>
                    <div className="flex items-center gap-2 w-full sm:w-auto">
                        {/* Language Switcher */}
                        <div className="flex items-center gap-1 bg-[var(--background-input)]/50 p-1 rounded-lg">
                            <button onClick={() => setLocale('en')} className={`px-2 py-1 text-xl rounded-md ${locale === 'en' ? 'bg-[var(--accent-color)] text-white' : 'text-opacity-70 hover:text-opacity-100 hover:bg-[var(--background-input)]'}`}>🇺🇸</button>
                            <button onClick={() => setLocale('km')} className={`px-2 py-1 text-xl rounded-md ${locale === 'km' ? 'bg-[var(--accent-color)] text-white' : 'text-opacity-70 hover:text-opacity-100 hover:bg-[var(--background-input)]'}`}>🇰🇭</button>
                        </div>
                        {/* Theme Switcher */}
                        <ThemeSwitcher />
                        {/* Install Button */}
                        {installPrompt && <button onClick={handleInstallClick} className="bg-[var(--semantic-green)] hover:bg-[var(--semantic-green-hover)] text-white font-semibold px-4 py-2 rounded-lg flex items-center gap-2 text-sm grow justify-center"><Icon name="install" /> {t('installAppButton')}</button>}
                        {/* Logout Button */}
                        <button onClick={logout} className="bg-[var(--semantic-red)] hover:bg-[var(--semantic-red-hover)] text-white font-semibold px-4 py-2 rounded-lg flex items-center gap-2 text-sm grow justify-center"><Icon name="logout" /> {t('logoutButton')}</button>
                    </div>
                </header>
            );
        };
        
        /**
         * Live Summary Card for the NewCashDropForm.
         */
        const SummaryCard = React.memo(({ formData, grandTotal, isSubmitting }) => {
            const { t } = useTranslation();
            
            return (
                 <div className="lg:col-span-1 lg:sticky top-24">
                    {/* Use the reusable SummaryContent for the main display */}
                    <SummaryContent formData={formData} grandTotal={grandTotal} />
                    
                    {/* Add the submit button, which is unique to the live card */}
                    <button type="submit" disabled={isSubmitting} className="w-full bg-[var(--accent-color)] hover:bg-[var(--accent-color-hover)] text-white font-bold py-3 px-4 rounded-lg flex items-center justify-center !mt-6 disabled:opacity-50 transition-all shadow-lg hover:shadow-[var(--accent-color)]/50">
                        {isSubmitting ? <Icon name="loader" /> : t('submitReportButton')}
                    </button>
                </div>
            );
        });

        /**
         * Form for creating a new cash drop report.
         */
        const NewCashDropForm = () => {
            const { appSettings } = useAppContext();
            const { userData } = useAuth();
            const { t } = useTranslation();
            const availableShops = useAvailableShops();
            
            // Memoized function to get the initial form state
            const getInitialState = useCallback(() => ({
                date: new Date().toISOString().split('T')[0],
                shop: availableShops[0]?.name || '',
                staff: userData?.name || '', 
                shift: 'AM',
                cashUsd: '', cashKhr: '', bankUsd: '', bankKhr: '',
                cashExchangeKhr: '', cashExchangeUsd: '',
                note: '',
            }), [availableShops, userData]);

            const [formData, setFormData] = useState(getInitialState);
            const [isSubmitting, setIsSubmitting] = useState(false);
            const [isConfirming, setIsConfirming] = useState(false);
            const [isPreviewing, setIsPreviewing] = useState(false);
            const [lastSubmittedData, setLastSubmittedData] = useState(null);

            // Effect to reset form if available shops list changes (e.g., on first load)
            useEffect(() => { setFormData(getInitialState()) }, [getInitialState]);
            
            // Memoized form change handler
            const handleFormChange = useCallback((e) => {
                const { name, value } = e.target;
                if (['cashUsd', 'cashKhr', 'bankUsd', 'bankKhr', 'cashExchangeKhr', 'cashExchangeUsd'].includes(name)) {
                    setFormData(prev => ({ ...prev, [name]: formatInputAsCurrency(value) }));
                } else {
                    setFormData(prev => ({ ...prev, [name]: value }));
                }
            }, []);

            // Memoized calculation for the grand total
            const grandTotal = useMemo(() => {
                return (parseCurrency(formData.cashUsd) + parseCurrency(formData.bankUsd)) * appSettings.exchangeRate 
                       + parseCurrency(formData.cashKhr) + parseCurrency(formData.bankKhr);
            }, [formData, appSettings.exchangeRate]);
            
            // Memoized submission handler
            const handleConfirmSubmit = useCallback(async () => {
                setIsConfirming(false);
                setIsSubmitting(true);
                try {
                    const submissionData = {
                        ...formData,
                        cashUsd: parseCurrency(formData.cashUsd), cashKhr: parseCurrency(formData.cashKhr),
                        bankUsd: parseCurrency(formData.bankUsd), bankKhr: parseCurrency(formData.bankKhr),
                        cashExchangeKhr: parseCurrency(formData.cashExchangeKhr), 
                        cashExchangeUsd: parseCurrency(formData.cashExchangeUsd),
                        grandTotalKhr: grandTotal,
                        createdAt: firebaseService.getTimestamp().fromDate(new Date(`${formData.date}T${new Date().toTimeString().split(' ')[0]}`)),
                        submittedBy: userData.uid
                    };
                    await firebaseService.addReport(submissionData);
                    setLastSubmittedData({ formData, grandTotal }); // Save for preview
                    setIsPreviewing(true); // Show success modal
                } catch (error) { 
                    console.error("Error submitting report:", error); 
                } finally {
                    setIsSubmitting(false);
                }
            }, [formData, grandTotal, userData]);

            // Memoized handler for closing the preview modal and resetting the form
            const handleClosePreviewAndReset = useCallback(() => {
                setIsPreviewing(false);
                setFormData(getInitialState()); // Reset form
                setLastSubmittedData(null);
            }, [getInitialState]);

            return (
                <>
                    <form onSubmit={(e) => { e.preventDefault(); setIsConfirming(true); }} className="grid grid-cols-1 lg:grid-cols-3 gap-8 items-start">
                        {/* Form Inputs */}
                        <div className="lg:col-span-2 bg-[var(--background-secondary)]/50 border border-[var(--border-color)] p-6 rounded-lg shadow-lg">
                            <h2 className="text-xl font-semibold text-[var(--text-primary)] border-b border-[var(--border-color)] pb-4 mb-6">{t('newFormTitle')}</h2>
                            {/* Top row: Date, Shop, Staff, Shift */}
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <FormInput label={t('dateLabel')} type="date" name="date" value={formData.date} onChange={handleFormChange} required />
                                <FormSelect label={t('shopLabel')} name="shop" value={formData.shop} onChange={handleFormChange} options={availableShops.map(s => ({value: s.name, label: s.name}))} required />
                                <FormInput label={t('staffLabel')} name="staff" value={formData.staff} disabled />
                                <FormSelect label={t('shiftLabel')} name="shift" value={formData.shift} onChange={handleFormChange} options={[{value:'AM', label:'AM'}, {value:'PM', label:'PM'}]} />
                            </div>
                            {/* Currency sections */}
                            <div className="space-y-4 pt-6 mt-6 border-t border-[var(--border-color)]">
                                <CurrencyInputGroup title={t('byCashTitle')} khrName="cashKhr" usdName="cashUsd" khrValue={formData.cashKhr} usdValue={formData.cashUsd} onChange={handleFormChange} />
                                <CurrencyInputGroup title={t('byBankTitle')} khrName="bankKhr" usdName="bankUsd" khrValue={formData.bankKhr} usdValue={formData.bankUsd} onChange={handleFormChange} />
                            </div>
                            <div className="space-y-4 pt-6 mt-6 border-t border-[var(--border-color)]">
                                <CurrencyInputGroup title={t('cashExchangeTitle')} khrName="cashExchangeKhr" usdName="cashExchangeUsd" khrValue={formData.cashExchangeKhr} usdValue={formData.cashExchangeUsd} onChange={handleFormChange} />
                            </div>
                            {/* Note section */}
                            <div className="pt-6 mt-6 border-t border-[var(--border-color)]"><FormInput label={t('noteLabel')} name="note" value={formData.note} onChange={handleFormChange} placeholder={t('notePlaceholder')}/></div>
                        </div>
                        
                        {/* Live Summary Card */}
                        <SummaryCard formData={formData} grandTotal={grandTotal} isSubmitting={isSubmitting} />
                    </form>
                    
                    {/* Modals */}
                    {isConfirming && (
                        <ConfirmationModal
                            isOpen={isConfirming}
                            onClose={() => setIsConfirming(false)}
                            onConfirm={handleConfirmSubmit}
                            isSubmitting={isSubmitting}
                            title={t('confirmSubmissionTitle')}
                            message={t('confirmSubmissionMessage')}
                            confirmText={t('confirmButton')}
                            confirmColor="accent"
                        />
                    )}
                    {isPreviewing && lastSubmittedData && (
                        <SummaryPreviewModal 
                            isOpen={isPreviewing} 
                            onClose={handleClosePreviewAndReset} 
                            formData={lastSubmittedData.formData}
                            grandTotal={lastSubmittedData.grandTotal}
                        />
                    )}
                </>
            );
        };
        
        /**
         * Filtering component for the reports dashboard.
         */
        const ReportFilters = React.memo(({ filters, setFilters, shops, onCustomClick }) => {
            const { t } = useTranslation();
            const timeFilterOptions = useMemo(() => [
                { value: 'Today', label: t('timeFilters.today') },
                { value: 'Yesterday', label: t('timeFilters.yesterday') },
                { value: 'This Month', label: t('timeFilters.thisMonth') },
                { value: 'Last Month', label: t('timeFilters.lastMonth') },
                { value: 'This Year', label: t('timeFilters.thisYear') },
                { value: 'Last Year', label: t('timeFilters.lastYear') },
                { value: 'Custom', label: t('timeFilters.custom') }
            ], [t]);
            
            const handleFilterChange = (e) => {
                const { name, value } = e.target;
                if (name === 'dueTime' && value === 'Custom') {
                    onCustomClick();
                } else {
                    setFilters(prev => ({...prev, [name]: value, startDate: '', endDate: ''}));
                }
            };
            return (
                 <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4 p-4 bg-[var(--background-primary)]/50 rounded-lg items-center">
                    <FormSelect label={t('shopLabel')} name="shop" value={filters.shop} onChange={handleFilterChange} options={[{value:'',label: t('allShops')}, ...shops.map(s=>({value:s.name, label:s.name}))]} />
                    <FormSelect label={t('dueTimeLabel')} name="dueTime" value={filters.dueTime} onChange={handleFilterChange} options={timeFilterOptions} />
                </div>
            );
        });
        
        /**
         * Table component for detailed, row-by-row reports.
         */
        const ReportTable = React.memo(({ reports, totals, onEdit, onDelete, onViewNote, viewType }) => {
            const { userData } = useAuth();
            const { t } = useTranslation();
            const canModify = [ROLES.ADMIN, ROLES.MANAGEMENT, ROLES.SHOP_MANAGER].includes(userData?.role);
            const hasShiftColumn = ['Today', 'Yesterday'].includes(viewType);
            const colSpan = 3 + (hasShiftColumn ? 1 : 0);
            
            // REFACTOR: Use the new custom hook
            const shopColorMap = useShopColorMap();

            return (
                <div className="overflow-x-auto">
                    {reports.length === 0 ? <div className="text-center py-16 text-[var(--text-secondary)]"><p>{t('noReportsFound')}</p></div> :
                        <table className="w-full text-sm text-left">
                            <thead className="bg-[var(--background-primary)]/50 text-xs text-[var(--text-secondary)] uppercase">
                                <tr>
                                    <th className="p-3">{viewType === 'Custom' ? t('dateHeader') : t('dateTimeHeader')}</th><th className="p-3">{t('shopHeader')}</th>
                                    <th className="p-3">{t('staffHeader')}</th>
                                    {hasShiftColumn && <th className="p-3">{t('shiftHeader')}</th>}
                                    <th className="p-3 text-right">{t('netSaleHeader')}</th><th className="p-3 text-right">{t('cashUsdHeader')}</th><th className="p-3 text-right">{t('cashKhrHeader')}</th>
                                    <th className="p-3 text-right">{t('bankUsdHeader')}</th><th className="p-3 text-right">{t('bankKhrHeader')}</th>
                                    <th className="p-3 text-right">{t('cashExchUsdHeader')}</th>
                                    <th className="p-3 text-right">{t('cashExchKhrHeader')}</th>
                                    <th className="p-3 text-center">{t('actionsHeader')}</th>
                                </tr>
                            </thead>
                            <tbody className="divide-y divide-[var(--border-color)]">
                                {reports.map(r => (
                                    <tr key={r.id} className={`${shopColorMap[r.shop]?.base || 'bg-transparent'} ${shopColorMap[r.shop]?.hover || 'hover:bg-[var(--border-color)]/50'}`}>
                                        <td className="p-3 whitespace-nowrap text-[var(--text-secondary)] font-mono">{viewType === 'Custom' ? formatDateDDMMYYYY(r.createdAt) : formatFullDateTime(r.createdAt)}</td>
                                        <td className="p-3 text-[var(--text-primary)]">{r.shop}</td>
                                        <td className="p-3 text-[var(--text-primary)]">{r.staff}</td>
                                        {hasShiftColumn && <td className="p-3 text-[var(--text-primary)]">{r.shift}</td>}
                                        <td className="p-3 text-right font-bold text-[var(--accent-color)]">{formatCurrency(r.grandTotalKhr, 'KHR')}</td>
                                        <td className="p-3 text-right font-mono text-[var(--text-primary)]">{formatCurrency(r.cashUsd, 'USD')}</td><td className="p-3 text-right font-mono text-[var(--text-primary)]">{formatCurrency(r.cashKhr, 'KHR')}</td>
                                        <td className="p-3 text-right font-mono text-[var(--text-primary)]">{formatCurrency(r.bankUsd, 'USD')}</td><td className="p-3 text-right font-mono text-[var(--text-primary)]">{formatCurrency(r.bankKhr, 'KHR')}</td>
                                        <td className="p-3 text-right font-mono text-[var(--text-primary)]">{formatCurrency(r.cashExchangeUsd, 'USD')}</td>
                                        <td className="p-3 text-right font-mono text-[var(--text-primary)]">{formatCurrency(r.cashExchangeKhr, 'KHR')}</td>
                                        <td className="p-3 flex gap-2 justify-center">
                                            {r.note && <button onClick={() => onViewNote(r.note)} className="p-1 text-[var(--semantic-yellow)] hover:opacity-80"><Icon name="document-text"/></button>}
                                            <button onClick={() => onEdit(r)} disabled={!canModify} className="p-1 text-[var(--accent-color)] hover:text-[var(--accent-color-hover)] disabled:text-slate-600 disabled:cursor-not-allowed"><Icon name="note"/></button>
                                            <button onClick={() => onDelete(r)} disabled={!canModify} className="p-1 text-[var(--semantic-red)] hover:text-[var(--semantic-red-hover)] disabled:text-slate-600 disabled:cursor-not-allowed"><Icon name="trash"/></button>
                                        </td>
                                    </tr>
                                ))}
                            </tbody>
                            <tfoot className="bg-[var(--background-secondary)] font-bold"><tr>
                                <td colSpan={colSpan} className="p-3 text-right text-[var(--text-primary)]">{t('subTotal')}</td>
                                <td className="p-3 text-right font-mono text-[var(--accent-color)]">{formatCurrency(totals.netSale, 'KHR')}</td>
                                <td className="p-3 text-right font-mono text-[var(--text-primary)]">{formatCurrency(totals.cashUsd, 'USD')}</td><td className="p-3 text-right font-mono text-[var(--text-primary)]">{formatCurrency(totals.cashKhr, 'KHR')}</td>
                                <td className="p-3 text-right font-mono text-[var(--text-primary)]">{formatCurrency(totals.bankUsd, 'USD')}</td><td className="p-3 text-right font-mono text-[var(--text-primary)]">{formatCurrency(totals.bankKhr, 'KHR')}</td>
                                <td className="p-3 text-right font-mono text-[var(--text-primary)]">{formatCurrency(totals.cashExchangeUsd, 'USD')}</td>
                                <td className="p-3 text-right font-mono text-[var(--text-primary)]">{formatCurrency(totals.cashExchangeKhr, 'KHR')}</td>
                                <td />
                            </tr></tfoot>
                        </table>
                    }
                </div>
            )
        });

        /**
         * Table component for aggregated (monthly/yearly) reports.
         */
        const AggregatedReportTable = React.memo(({ reports, totals, periodType }) => {
            const { t } = useTranslation();
            
            // REFACTOR: Use the new custom hook
            const shopColorMap = useShopColorMap();

            return (
                <div className="overflow-x-auto">
                    {reports.length === 0 ? <div className="text-center py-16 text-[var(--text-secondary)]"><p>{t('noReportsFound')}</p></div> :
                        <table className="w-full text-sm text-left">
                            <thead className="bg-[var(--background-primary)]/50 text-xs text-[var(--text-secondary)] uppercase">
                                <tr>
                                    <th className="p-3">{periodType}</th><th className="p-3">{t('shopHeader')}</th><th className="p-3 text-right">{t('netSaleHeader')}</th>
                                    <th className="p-3 text-right">{t('cashUsdHeader')}</th><th className="p-3 text-right">{t('cashKhrHeader')}</th>
                                    <th className="p-3 text-right">{t('bankUsdHeader')}</th><th className="p-3 text-right">{t('bankKhrHeader')}</th>
                                    <th className="p-3 text-right">{t('cashExchUsdHeader')}</th>
                                    <th className="p-3 text-right">{t('cashExchKhrHeader')}</th>
                                </tr>
                            </thead>
                            <tbody className="divide-y divide-[var(--border-color)]">
                                {reports.map(r => (
                                    <tr key={`${r.period}-${r.shop}`} className={`${shopColorMap[r.shop]?.base || 'bg-transparent'} ${shopColorMap[r.shop]?.hover || 'hover:bg-[var(--border-color)]/50'}`}>
                                        <td className="p-3 whitespace-nowrap text-[var(--text-secondary)]">{r.period}</td>
                                        <td className="p-3 text-[var(--text-primary)]">{r.shop}</td>
                                        <td className="p-3 text-right font-bold text-[var(--accent-color)]">{formatCurrency(r.grandTotalKhr, 'KHR')}</td>
                                    <td className="p-3 text-right font-mono text-[var(--text-primary)]">{formatCurrency(r.cashUsd, 'USD')}</td><td className="p-3 text-right font-mono text-[var(--text-primary)]">{formatCurrency(r.cashKhr, 'KHR')}</td>
                                    <td className="p-3 text-right font-mono text-[var(--text-primary)]">{formatCurrency(r.bankUsd, 'USD')}</td><td className="p-3 text-right font-mono text-[var(--text-primary)]">{formatCurrency(r.bankKhr, 'KHR')}</td>
                                    <td className="p-3 text-right font-mono text-[var(--text-primary)]">{formatCurrency(r.cashExchangeUsd, 'USD')}</td>
                                    <td className="p-3 text-right font-mono text-[var(--text-primary)]">{formatCurrency(r.cashExchangeKhr, 'KHR')}</td>
                                </tr>
                            ))}
                            </tbody>
                            <tfoot className="bg-[var(--background-secondary)] font-bold">
                                <tr>
                                    <td colSpan={2} className="p-3 text-right text-[var(--text-primary)]">{t('subTotal')}</td>
                                    <td className="p-3 text-right font-mono text-[var(--accent-color)]">{formatCurrency(totals.netSale, 'KHR')}</td>
                                    <td className="p-3 text-right font-mono text-[var(--text-primary)]">{formatCurrency(totals.cashUsd, 'USD')}</td><td className="p-auto text-right font-mono text-[var(--text-primary)]">{formatCurrency(totals.cashKhr, 'KHR')}</td>
                                    <td className="p-3 text-right font-mono text-[var(--text-primary)]">{formatCurrency(totals.bankUsd, 'USD')}</td><td className="p-3 text-right font-mono text-[var(--text-primary)]">{formatCurrency(totals.bankKhr, 'KHR')}</td>
                                    <td className="p-3 text-right font-mono text-[var(--text-primary)]">{formatCurrency(totals.cashExchangeUsd, 'USD')}</td>
                                    <td className="p-3 text-right font-mono text-[var(--text-primary)]">{formatCurrency(totals.cashExchangeKhr, 'KHR')}</td>
                                </tr>
                            </tfoot>
                        </table>
                    }
                </div>
            );
        });

        /**
         * Main reports dashboard component.
         * REFACTOR: Consolidated modal state and memoized handlers.
         */
        const ReportsDashboard = () => {
            const { reports, appSettings } = useAppContext();
            const { userData } = useAuth();
            const { t } = useTranslation();
            const availableShops = useAvailableShops();
            
            const [filters, setFilters] = useState({ shop: '', dueTime: 'Today', startDate: '', endDate: '' });
            const [isSubmitting, setIsSubmitting] = useState(false);
            
            // REFACTOR: Use a single state object for all modal visibility
            const [modalState, setModalState] = useState({
                edit: null,     // Holds the report object to edit
                delete: null,   // Holds the report object to delete
                note: null,     // Holds the note string to view
                customDate: false // Boolean for custom date modal
            });

            // REFACTOR: Memoized callbacks for opening and closing modals
            const handleModalOpen = useCallback((type, data) => {
                setModalState(prev => ({ ...prev, [type]: data }));
            }, []);

            const handleModalClose = useCallback((type) => {
                setModalState(prev => ({ ...prev, [type]: null }));
            }, []);
            
            // Get filtered data
            const { filteredAndAggregatedData, totals } = useFilteredReports(reports, filters, userData, availableShops);

            // REFACTOR: Memoized delete handler
            const handleConfirmDelete = useCallback(async () => {
                if (!modalState.delete) return;
                setIsSubmitting(true);
                try {
                    await firebaseService.deleteReport(modalState.delete.id);
                    handleModalClose('delete');
                } catch (error) { console.error("Error deleting report:", error); } 
                finally { setIsSubmitting(false); }
            }, [modalState.delete, handleModalClose]);

            // REFACTOR: Memoized edit handler
            const handleSaveEdit = useCallback(async (editedData) => {
                if (!modalState.edit) return;
                setIsSubmitting(true);
                try {
                    const grandTotal = (parseCurrency(editedData.cashUsd) + parseCurrency(editedData.bankUsd)) * appSettings.exchangeRate 
                                     + parseCurrency(editedData.cashKhr) + parseCurrency(editedData.bankKhr);
                    
                    const reportData = {
                        ...editedData,
                        // Ensure createdAt is a Firestore Timestamp
                        createdAt: firebaseService.getTimestamp().fromDate(new Date(`${editedData.date}T${editedData.createdAt.toDate().toTimeString().split(' ')[0]}`)),
                        cashUsd: parseCurrency(editedData.cashUsd), cashKhr: parseCurrency(editedData.cashKhr),
                        bankUsd: parseCurrency(editedData.bankUsd), bankKhr: parseCurrency(editedData.bankKhr),
                        cashExchangeKhr: parseCurrency(editedData.cashExchangeKhr),
                        cashExchangeUsd: parseCurrency(editedData.cashExchangeUsd),
                        grandTotalKhr: grandTotal,
                    };

                    await firebaseService.updateReport(modalState.edit.id, reportData);
                    handleModalClose('edit');
                } catch (error) { console.error("Error updating report:", error); } 
                finally { setIsSubmitting(false); }
            }, [modalState.edit, appSettings.exchangeRate, handleModalClose]);

            // REFACTOR: Memoized export handler
            const handleExport = useCallback(() => {
                if (!filteredAndAggregatedData?.data) return;
                
                const dataToExport = filteredAndAggregatedData.data.map(row => 
                    (filteredAndAggregatedData.type === 'detailed') ? {
                        [t('dateHeader')]: formatDateDDMMYYYY(row.createdAt), [t('shopHeader')]: row.shop, [t('staffHeader')]: row.staff,
                        [t('netSaleHeader')]: row.grandTotalKhr, [t('cashUsdHeader')]: row.cashUsd, [t('cashKhrHeader')]: row.cashKhr,
                        [t('bankUsdHeader')]: row.bankUsd, [t('bankKhrHeader')]: row.bankKhr, 
                        [t('cashExchUsdHeader')]: row.cashExchangeUsd, [t('cashExchKhrHeader')]: row.cashExchangeKhr,
                        [t('shiftHeader')]: row.shift
                    } : {
                        [filters.dueTime]: row.period, [t('shopHeader')]: row.shop, [t('netSaleHeader')]: row.grandTotalKhr,
                        [t('cashUsdHeader')]: row.cashUsd, [t('cashKhrHeader')]: row.cashKhr, [t('bankUsdHeader')]: row.bankUsd, [t('bankKhrHeader')]: row.bankKhr,
                        [t('cashExchUsdHeader')]: row.cashExchangeUsd, [t('cashExchKhrHeader')]: row.cashExchangeKhr
                    }
                );
                
                const worksheet = XLSX.utils.json_to_sheet(dataToExport);
                const workbook = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(workbook, worksheet, "Cash Drop Report");
                XLSX.writeFile(workbook, `Cash_Drop_Report_${new Date().toISOString().split('T')[0]}.xlsx`);
            }, [filteredAndAggregatedData, filters.dueTime, t]);

            return (
                <div className="bg-[var(--background-secondary)]/50 border border-[var(--border-color)] p-4 sm:p-6 rounded-lg shadow-lg mt-8">
                    <div className="flex flex-col sm:flex-row justify-between items-center mb-4 gap-4">
                        <h2 className="text-xl font-semibold text-[var(--text-primary)]">{t('historyTitle')}</h2>
                        <button onClick={handleExport} className="bg-[var(--semantic-green)] hover:bg-[var(--semantic-green-hover)] text-white font-semibold px-4 py-2 rounded-lg flex items-center gap-2 text-sm w-full sm:w-auto justify-center">
                            <Icon name="export" /> {t('exportButton')}
                        </button>
                    </div>
                    
                    <ReportFilters filters={filters} setFilters={setFilters} shops={availableShops} onCustomClick={() => handleModalOpen('customDate', true)} />
                    
                    {/* Render loading spinner or the correct table */}
                    {!filteredAndAggregatedData ? <div className="py-16 flex justify-center items-center"><Icon name="loader" className="w-8 h-8 text-[var(--text-secondary)]" /></div> :
                        (filteredAndAggregatedData.type === 'detailed') ? 
                            <ReportTable reports={filteredAndAggregatedData.data} totals={totals} onEdit={(r) => handleModalOpen('edit', r)} onDelete={(r) => handleModalOpen('delete', r)} onViewNote={(n) => handleModalOpen('note', n)} viewType={filters.dueTime} /> : 
                            <AggregatedReportTable reports={filteredAndAggregatedData.data} totals={totals} periodType={filters.dueTime} />
                    }
                    
                    {/* Modals */}
                    <EditReportModal isOpen={!!modalState.edit} onClose={() => handleModalClose('edit')} onSave={handleSaveEdit} report={modalState.edit} isSubmitting={isSubmitting} shops={availableShops}/>
                    {modalState.delete && (
                        <ConfirmationModal
                            isOpen={!!modalState.delete}
                            onClose={() => handleModalClose('delete')}
                            onConfirm={handleConfirmDelete}
                            isSubmitting={isSubmitting}
                            title={t('confirmDeletionTitle')}
                            message={t('confirmDeletionMessage')}
                            confirmText={t('deleteButton')}
                            confirmColor="red"
                        />
                    )}
                    <CustomDateRangeModal isOpen={modalState.customDate} onClose={() => handleModalClose('customDate')} onApply={(dates) => setFilters(prev => ({...prev, ...dates, dueTime: 'Custom'}))}/>
                    <NoteViewModal isOpen={!!modalState.note} onClose={() => handleModalClose('note')} note={modalState.note}/>
                </div>
            );
        };
        
        /**
         * Main page component, renders Form + Dashboard
         */
        const CashDropPage = () => {
            const { userData } = useAuth();
            const { isLoading } = useAppContext();
            if (isLoading || !userData) return <LoadingSpinner />;

            const canViewDashboard = userData?.role !== ROLES.CASHIER && userData?.role !== ROLES.STAFF;
            
            return (
                <div className="space-y-8">
                    <NewCashDropForm />
                    {canViewDashboard && <ReportsDashboard />}
                </div>
            );
        };

        /**
         * Login page component
         */
        const LoginPage = () => {
            const { login, authError, setAuthError } = useAuth();
            const { t, setLocale, locale } = useTranslation();
            const [credentials, setCredentials] = useState({ email: '', password: '' });
            const [error, setError] = useState(null);
            const [loading, setLoading] = useState(false);
            const [showPassword, setShowPassword] = useState(false);
            const [rememberMe, setRememberMe] = useState(true);

            // Effect to watch for global auth errors and translate them
            useEffect(() => {
                if (authError) { 
                    setError({ message: t(authError.message) }); 
                    setAuthError(null); // Clear the global error
                }
            }, [authError, setAuthError, t]);
            
            const handleChange = (e) => setCredentials(prev => ({...prev, [e.target.name]: e.target.value}));

            const handleSubmit = async (e) => {
                e.preventDefault();
                setError(null);
                setLoading(true);
                try {
                    await login(credentials.email, credentials.password, rememberMe);
                } catch (err) {
                    setError({ message: t('loginError') });
                } finally {
                    setLoading(false);
                }
            };

            return (
                <div className="min-h-screen bg-[var(--background-primary)] flex flex-col justify-center items-center p-4">
                    <div className="w-full max-w-md">
                        {/* Header controls for Login page */}
                        <div className="absolute top-4 right-4 flex items-center gap-2">
                            <div className="flex items-center gap-1 bg-[var(--background-input)]/50 p-1 rounded-lg">
                                <button onClick={() => setLocale('en')} className={`px-2 py-1 text-xl rounded-md ${locale === 'en' ? 'bg-[var(--accent-color)] text-white' : 'text-opacity-70 hover:text-opacity-100'}`}>🇺🇸</button>
                                <button onClick={() => setLocale('km')} className={`px-2 py-1 text-xl rounded-md ${locale === 'km' ? 'bg-[var(--accent-color)] text-white' : 'text-opacity-70 hover:text-opacity-100'}`}>🇰🇭</button>
                            </div>
                            <ThemeSwitcher />
                        </div>
                        {/* Login Form Card */}
                        <div className="bg-[var(--background-secondary)]/80 p-8 md:p-10 rounded-2xl shadow-lg border border-[var(--border-color)]">
                            <div className="text-center mb-8">
                                <h1 className="text-3xl font-bold text-[var(--text-primary)]">{t('loginTitle')}</h1>
                                <div className="mt-2 text-sm text-[var(--text-secondary)]">
                                    <p>{t('loginSubtitle1')}</p>
                                    <p>{t('loginSubtitle2')}</p>
                                </div>
                            </div>
                            <form onSubmit={handleSubmit} className="space-y-6">
                                <div className="relative"><input id="email" name="email" type="email" value={credentials.email} onChange={handleChange} required placeholder={t('emailPlaceholder')} className="block w-full pl-4 pr-3 py-2.5 bg-[var(--background-input)] border border-[var(--border-color)] rounded-lg placeholder-[var(--text-secondary)] focus:outline-none focus:ring-2 focus:ring-[var(--accent-color)] text-[var(--text-primary)]"/></div>
                                <div className="relative">
                                    <input id="password" name="password" type={showPassword ? 'text' : 'password'} value={credentials.password} onChange={handleChange} required placeholder={t('passwordPlaceholder')} className="block w-full pl-4 pr-10 py-2.5 bg-[var(--background-input)] border border-[var(--border-color)] rounded-lg placeholder-[var(--text-secondary)] focus:outline-none focus:ring-2 focus:ring-[var(--accent-color)] text-[var(--text-primary)]"/>
                                    <button type="button" onClick={() => setShowPassword(!showPassword)} className="absolute inset-y-0 right-0 pr-3 flex items-center text-[var(--text-secondary)] hover:text-[var(--text-primary)]">{showPassword ? <Icon name="eye-off" /> : <Icon name="eye" />}</button>
                                </div>
                                <div className="flex items-center"><input id="remember-me" type="checkbox" checked={rememberMe} onChange={(e) => setRememberMe(e.target.checked)} className="h-4 w-4 text-[var(--accent-color)] focus:ring-[var(--accent-color)] border-[var(--border-color)] rounded bg-[var(--background-input)]"/><label htmlFor="remember-me" className="ml-2 block text-sm text-[var(--text-secondary)]">{t('rememberMe')}</label></div>
                                {error && <p className="text-[var(--semantic-red)] text-sm text-center">{error.message}</p>}
                                <button type="submit" disabled={loading} className="w-full bg-[var(--accent-color)] hover:bg-[var(--accent-color-hover)] text-white font-bold py-3 px-4 rounded-lg flex items-center justify-center disabled:opacity-50 transition-all shadow-lg hover:shadow-[var(--accent-color)]/50">
                                    {loading ? <Icon name="loader" /> : t('loginButton')}
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
            );
        };
        
        /******************************************************************************
         * 11. ROOT COMPONENT
         * The entry point of the application.
         *****************************************************************************/
        
        /**
         * Main App component, handles routing between Login and CashDropPage.
         */
        const App = () => {
            const { user, loading } = useAuth();
            if (loading) return <LoadingSpinner />;
            
            return !user ? <LoginPage /> : (
                // AppProvider wraps the main app to provide shops/reports
                <AppProvider>
                    <div className="container mx-auto p-4 md:p-8">
                        <div className="max-w-7xl mx-auto">
                            <AppHeader />
                            <main>
                                <CashDropPage />
                            </main>
                        </div>
                    </div>
                </AppProvider>
            );
        };

        /**
         * Root component to wrap all providers.
         */
        const Root = () => (
            <LanguageProvider>
                <AuthProvider>
                    <ThemeProvider>
                        <App />
                    </ThemeProvider>
                </AuthProvider>
            </LanguageProvider>
        );

        // Render the application
        ReactDOM.createRoot(document.getElementById('root')).render(<Root />);
    </script>
</body>
</html>
