<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cash Drop & Expenses</title>
    
    <!-- PWA and Mobile App Manifest -->
    <meta name="theme-color" content="#1d4ed8">
    <link rel="apple-touch-icon" href="https://placehold.co/192x192/1d4ed8/ffffff?text=CDR">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="CashDrop">
    <link rel="manifest" href="data:application/manifest+json;base64,ewogICJuYW1lIjogIkNhc2ggRHJvcCBSZXBvcnQiLAogICJzaG9ydF9uYW1lIjogIkNhc2hEcm9wIiwKICAiaWQiOiAiLz9zb3VyY2U9cHdhIiwKICAiZGVzY3JpcHRpb24iOiAiQSBzaW1wbGUgYXBwIGZvciByZXBvcnRpbmcgZGFpbHkgY2FzaCBkcm9wcy4iLAogICJzdGFydF91cmwiOiAiLiIsCiAgImRpc3BsYXkiOiAic3RhbmRhbG9uZSIsCiAgImJhY2tncm91bmRfY29sb3IiOiAiI2YxZjVmOSIsCiAgInRoZW1lX2NvbG9yIjogIiMxZDRlZDgiLAogICJpY29ucyI6IFsKICAgIHsKICAgICAgInNyYyI6ICJodHRwczovL3BsYWNlaG9sZC5jby8xOTJ4MTkyLzFkNGVkOC9mZmZmZmY/dGV4dD1DRFIiLAogICAgICAidHlwZSI6ICJpbWFnZS9wbmciLAogICAgICAic2l6ZXMiOiAiMTkyeDE5MiIsCiAgICAgICJwdXJwb3NlIjogImFueSBtYXNrYWJsZSIKICAgIH0KICAgICh7CiAgICAgICJzcmMiOiAiaHR0cHM6Ly9wbGFjZWhvbGQuY28vNTEyeDUxMi8xZDRlZDgvZmZmZmZmP3RleHQ9Q0RSIiwKICAgICAidHlwZSI6ICJpbWFnZS9wbmciLAogICAgICAic2l6ZXMiOiAiNTEyeDUxMiIsCiAgICAgICJwdXJwb3NlIjogImFueSBtYXNrYWJsZSIKICAgIH0KICBdCn0=">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React and Babel -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut, setPersistence, browserSessionPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, addDoc, onSnapshot, deleteDoc, getDoc, getDocs, Timestamp, setDoc, updateDoc, query, orderBy, where, limit } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        window.firebaseSDK = {
            initializeApp,
            getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut, setPersistence, browserSessionPersistence, browserLocalPersistence,
            getFirestore, collection, doc, addDoc, onSnapshot, deleteDoc, getDoc, getDocs, Timestamp, setDoc, updateDoc, query, orderBy, where, limit
        };
    </script>
    
    <!-- SheetJS (for Excel export) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <!-- Theme initialization -->
    <script>
        (function() {
            function getInitialTheme() {
                const persistedTheme = window.localStorage.getItem('theme');
                if (persistedTheme) return persistedTheme;
                return 'dark';
            }
            const theme = getInitialTheme();
            const themeClass = theme === 'dark' ? 'dark' : theme;
            document.documentElement.classList.add(themeClass);
        })();
    </script>

    <style>
        :root {
            /* Default Dark Theme (Slate Blue) */
            --background-primary: #0f172a;
            --background-secondary: #1e293b;
            --background-input: #334155;
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --border-color: #334155;
            --accent-color: #3b82f6;
            --accent-color-hover: #2563eb;
            
            --semantic-red: #ef4444;
            --semantic-red-hover: #dc2626;
            --semantic-green: #22c55e;
            --semantic-green-hover: #16a34a;
            --semantic-yellow: #eab308;
        }
        .light {
            --background-primary: #ffffff;
            --background-secondary: #f1f5f9;
            --background-input: #ffffff;
            --text-primary: #0f172a;
            --text-secondary: #475569;
            --border-color: #cbd5e1;
            --accent-color: #0284c7;
            --accent-color-hover: #0369a1;
        }
        .charcoal { --background-primary: #171717; --background-secondary: #262626; --background-input: #404040; --text-primary: #f5f5f5; --text-secondary: #a3a3a3; --border-color: #404040; --accent-color: #fb923c; --accent-color-hover: #f97316; }
        .nord { --background-primary: #2E3440; --background-secondary: #3B4252; --background-input: #4C566A; --text-primary: #ECEFF4; --text-secondary: #D8DEE9; --border-color: #4C566A; --accent-color: #88C0D0; --accent-color-hover: #81A1C1; }
        .forest { --background-primary: #1a2e2c; --background-secondary: #2a4a46; --background-input: #3a6b63; --text-primary: #e6f1f0; --text-secondary: #a0c0bd; --border-color: #3a6b63; --accent-color: #34d399; --accent-color-hover: #10b981; }
        .rose { --background-primary: #3d1c2b; --background-secondary: #5c2a41; --background-input: #7b3d58; --text-primary: #fce7f3; --text-secondary: #f4abc4; --border-color: #7b3d58; --accent-color: #f472b6; --accent-color-hover: #ec4899; }
        .ocean { --background-primary: #0e2a47; --background-secondary: #1c3d66; --background-input: #294f85; --text-primary: #e0f2fe; --text-secondary: #a5cff7; --border-color: #294f85; --accent-color: #38bdf8; --accent-color-hover: #0ea5e9; }
        .sunset { --background-primary: #451a03; --background-secondary: #6e2905; --background-input: #923706; --text-primary: #fff7ed; --text-secondary: #fdbf8e; --border-color: #923706; --accent-color: #f97316; --accent-color-hover: #ea580c; }
        .lavender { --background-primary: #2b234a; --background-secondary: #3f356b; --background-input: #53488f; --text-primary: #e9e7f8; --text-secondary: #b6b0d4; --border-color: #53488f; --accent-color: #a78bfa; --accent-color-hover: #8b5cf6; }
        .grayscale { --background-primary: #171717; --background-secondary: #262626; --background-input: #404040; --text-primary: #f5f5f5; --text-secondary: #a3a3a3; --border-color: #404040; --accent-color: #a3a3a3; --accent-color-hover: #d4d4d4; }

        body {
            background-color: var(--background-primary);
            font-family: 'Inter', sans-serif;
            color: var(--text-primary);
            transition: background-color 0.3s, color 0.3s;
        }
        
        /* NEW: Fix for Browser Autofill Background "White Flash" */
        /* This forces the browser to use the theme's background color instead of white */
        input:-webkit-autofill,
        input:-webkit-autofill:hover, 
        input:-webkit-autofill:focus, 
        input:-webkit-autofill:active {
            /* UPDATED: Set to Dark Blue (#1e293b) to match the dark theme and prevent white flash */
            -webkit-box-shadow: 0 0 0 30px #1e293b inset !important;
            -webkit-text-fill-color: var(--text-primary) !important;
            transition: background-color 5000s ease-in-out 0s;
            caret-color: var(--text-primary);
        }

        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');
    </style>
</head>
<body class="bg-[var(--background-primary)] text-[var(--text-primary)]">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useCallback, createContext, useContext, useRef } = React;
        const { firebaseSDK } = window;

        // --- CONSTANTS ---
        const firebaseConfig = {
            apiKey: "AIzaSyA4upjtl0UFToWSfRZEiEQvwz9ieFLfqhI",
            authDomain: "cashflow-mgr.firebaseapp.com",
            projectId: "cashflow-mgr",
            storageBucket: "cashflow-mgr.appspot.com",
            messagingSenderId: "873891130920",
            appId: "1:873891130920:web:b6b8f0432943c33a930f1d",
            measurementId: "G-LVLMJ8ZY0B"
        };
        const DEFAULT_EXCHANGE_RATE = 4000;
        // UPDATED: Removed 'MANAGEMENT' role based on clarification.
        const ROLES = { ADMIN: 'Admin', SHOP_MANAGER: 'Shop Manager', CASHIER: 'Cashier', STAFF: 'Staff' };
        // NEW: Auto Logout Settings (In Milliseconds)
        const INACTIVITY_TIMEOUT = 15 * 60 * 1000; // 15 Minutes
        const TIMEOUT_WARNING = 60 * 1000; // Warning shown 60 seconds before timeout
        
        const translations = {
            en: {
                loginTitle: 'Cashier Manager Application', loginSubtitle1: 'Internal Use Only.', loginSubtitle2: 'Please log in to your account.', emailPlaceholder: 'Email address', passwordPlaceholder: 'Password',
                rememberMe: 'Remember me', loginButton: 'Log In', loginError: 'Failed to log in. Please check your email and password.', employeeProfileError: 'Your employee profile was not found.',
                headerTitle: 'Cashier Manager Application', welcomeMessage: 'Welcome, {{name}} ({{role}})', installAppButton: 'Install App', logoutButton: 'Logout',
                newFormTitle: 'New Cash Drop Form', dateLabel: 'Date', shopLabel: 'Shop', staffLabel: 'Staff', shiftLabel: 'Shift', byCashTitle: 'By Cash', byBankTitle: 'By Bank',
                cashExchangeTitle: 'Cash Exchange', khrLabel: 'KHR (៛)', usdLabel: 'USD ($)', noteLabel: 'Note', notePlaceholder: 'Add an optional note...', submitReportButton: 'Submit Report',
                summaryTitle: 'Summary', grandTotalLabel: 'Grand Total', cashKhrLabel: 'Cash KHR', cashUsdLabel: 'Cash USD', bankKhrLabel: 'Bank KHR', bankUsdLabel: 'Bank USD',
                cashExchangeKhrLabel: 'Cash Exchange KHR', cashExchangeUsdLabel: 'Cash Exchange USD',
                confirmSubmissionTitle: 'Confirm Report Submission', confirmSubmissionMessage: 'Please review the details before submitting. Is everything correct?',
                confirmDeletionTitle: 'Confirm Deletion', confirmDeletionMessage: 'Are you sure you want to delete this report?',
                cancelButton: 'Cancel', confirmButton: 'Yes, Confirm', deleteButton: 'Delete',
                customDateTitle: 'Select Custom Date Range', startDateLabel: 'Start Date', endDateLabel: 'End Date', applyButton: 'Apply',
                editReportTitle: 'Edit Report', saveChangesButton: 'Save Changes', reportNoteTitle: 'Report Note', closeButton: 'Close',
                // UPDATED: Specific instruction for staff
                submissionSuccessTitle: 'Report Submitted Successfully', submissionSuccessMessage: 'Please screenshot this summary card and submit it to your Shop Manager.',
                historyTitle: 'Daily Cash Drop History', exportButton: 'Export to Excel', allShops: 'All Shops', dueTimeLabel: 'Timeframe',
                timeFilters: { today: 'Today', yesterday: 'Yesterday', thisMonth: 'This Month', lastMonth: 'Last Month', thisYear: 'This Year', lastYear: 'Last Year', custom: 'Custom' },
                noReportsFound: 'No reports found for the selected filters.', dateHeader: 'Date', dateTimeHeader: 'Date & Time', shopHeader: 'Shop', staffHeader: 'Staff', shiftHeader: 'Shift',
                netSaleHeader: 'Net Sale (៛)', cashUsdHeader: 'Cash USD', cashKhrHeader: 'Cash KHR', bankUsdHeader: 'Bank USD', bankKhrHeader: 'Bank KHR', cashExchUsdHeader: 'Cash Exch. USD',
                cashExchKhrHeader: 'Cash Exch. KHR', actionsHeader: 'Actions', subTotal: 'Sub-Total',
                tabs: { cashDrop: 'Daily Cash Drop', expenses: 'Daily Expenses' },
                expenseHeader: 'Daily Operation Expenses', addExpenseButton: 'Add Expense', editExpenseButton: 'Edit Expense',
                itemNameLabel: 'Description', categoryLabel: 'Category', quantityLabel: 'QTY', priceLabel: 'Price', totalLabel: 'Total',
                recordedByHeader: 'Recorded By', expenseSuccess: 'Daily expense added successfully.', expenseUpdateSuccess: 'Daily expense updated successfully.', expenseDeleteSuccess: 'Expense deleted successfully.',
                confirmExpenseDelete: 'Are you sure you want to delete this expense?', totalExpenseLabel: 'Total Expense',
                sessionExpiringTitle: 'Session Expiring', sessionExpiringMessage: 'Your session will expire in {{seconds}} seconds due to inactivity. Do you want to stay logged in?', stayLoggedInButton: 'Stay Logged In'
            },
            km: {
                loginTitle: 'JLW បញ្ចូលសាច់ប្រាក់', loginSubtitle1: 'សម្រាប់ប្រើប្រាស់តែក្នុងក្រុមហ៊ុនប៉ុណ្ណោះ!', loginSubtitle2: 'សូមចូលទៅកាន់គណនីរបស់អ្នក!', emailPlaceholder: 'អាសយដ្ឋានអ៊ីមែល', passwordPlaceholder: 'ពាក្យសម្ងាត់',
                rememberMe: 'ចងចាំខ្ញុំ', loginButton: 'ចូលគណនី', loginError: 'ការចូលគណនីបានបរាជ័យ។', employeeProfileError: 'រកមិនឃើញប្រវត្តិរូបបុគ្គលិករបស់អ្នកទេ។',
                headerTitle: 'របាយការណ៍បញ្ចូលសាច់ប្រាក់', welcomeMessage: 'សូមស្វាគមន៍, {{name}} ({{role}})', installAppButton: 'ដំឡើងកម្មវិធី', logoutButton: 'ចាកចេញ',
                newFormTitle: 'ទម្រង់បញ្ចូលសាច់ប្រាក់ថ្មី', dateLabel: 'កាលបរិច្ឆេទ', shopLabel: 'ហាង', staffLabel: 'បុគ្គលិក', shiftLabel: 'វេន', byCashTitle: 'តាមសាច់ប្រាក់', byBankTitle: 'តាមធនាគារ',
                cashExchangeTitle: 'សាច់ប្រាក់សម្រាប់ដូរ', khrLabel: 'រៀល (៛)', usdLabel: 'ដុល្លារ ($)', noteLabel: 'កំណត់ចំណាំ', notePlaceholder: 'បន្ថែមចំណាំ (បើមាន)...', submitReportButton: 'បញ្ជូនរបាយការណ៍',
                summaryTitle: 'សេចក្តីសង្ខេប', grandTotalLabel: 'សរុប​រួម', cashKhrLabel: 'សាច់ប្រាក់ រៀល', cashUsdLabel: 'សាច់ប្រាក់ ដុល្លារ', bankKhrLabel: 'ធនាគារ រៀល', bankUsdLabel: 'ធនាគារ ដុល្លារ',
                cashExchangeKhrLabel: 'សាច់ប្រាក់ដូរ រៀល', cashExchangeUsdLabel: 'សាច់ប្រាក់ដូរ ដុល្លារ',
                confirmSubmissionTitle: 'បញ្ជាក់ការបញ្ជូនរបាយការណ៍', confirmSubmissionMessage: 'សូមពិនិត្យមើលព័ត៌មានលម្អិតមុនពេលបញ្ជូន។',
                confirmDeletionTitle: 'បញ្ជាក់ការលុប', confirmDeletionMessage: 'តើអ្នកប្រាកដថាចង់លុបរូបាយការណ៍នេះមែនទេ?',
                cancelButton: 'បោះបង់', confirmButton: 'បាទ/ចាស៎', deleteButton: 'លុប',
                customDateTitle: 'ជ្រើសរើសចន្លោះកាលបរិច្ឆេទ', startDateLabel: 'ថ្ងៃចាប់ផ្តើម', endDateLabel: 'ថ្ងៃបញ្ចប់', applyButton: 'អនុវត្ត',
                editReportTitle: 'កែសម្រួលរបាយការណ៍', saveChangesButton: 'រក្សាទុកការផ្លាស់ប្តូរ', reportNoteTitle: 'កំណត់ចំណាំរបាយការណ៍', closeButton: 'បិទ',
                // UPDATED: Specific instruction for staff
                submissionSuccessTitle: 'របាយការណ៍លក់ត្រូវបានបញ្ចូលជោគជ័យ', submissionSuccessMessage: 'សូមថតរូបអេក្រង់ (Screenshot) នៃសេចក្តីសង្ខេបនេះ រួចផ្ញើជូនអ្នកគ្រប់គ្រងហាងរបស់អ្នក។',
                historyTitle: 'ប្រវត្តិរបាយការណ៍បញ្ចូលសាច់ប្រាក់', exportButton: 'នាំចេញជា Excel', allShops: 'គ្រប់ហាងទាំងអស់', dueTimeLabel: 'ពេលវេលា',
                timeFilters: { today: 'ថ្ងៃនេះ', yesterday: 'ម្សិលមិញ', thisMonth: 'ខែនេះ', lastMonth: 'ខែមុន', thisYear: 'ឆ្នាំនេះ', lastYear: 'ឆ្នាំមុន', custom: 'ផ្ទាល់ខ្លួន' },
                noReportsFound: 'រកមិនឃើញរបាយការណ៍សម្រាប់តម្រងដែលបានជ្រើសរើសទេ។', dateHeader: 'កាលបរិច្ឆេទ', dateTimeHeader: 'កាលបរិច្ឆេទ & ម៉ោង', shopHeader: 'ហាង', staffHeader: 'បុគ្គលិក', shiftHeader: 'វេន',
                netSaleHeader: 'លក់សរុប (៛)', cashUsdHeader: 'សាច់ប្រាក់ USD', cashKhrHeader: 'សាច់ប្រាក់ KHR', bankUsdHeader: 'ធនាគារ USD', bankKhrHeader: 'ធនាគារ KHR', cashExchUsdHeader: 'សាច់ប្រាក់ដូរ USD',
                cashExchKhrHeader: 'សាច់ប្រាក់ដូរ KHR', actionsHeader: 'សកម្មភាព', subTotal: 'សរុបរង',
                tabs: { cashDrop: 'បញ្ចូលសាច់ប្រាក់', expenses: 'ចំណាយប្រចាំថ្ងៃ' },
                expenseHeader: 'ចំណាយប្រតិបត្តិការប្រចាំថ្ងៃ', addExpenseButton: 'បន្ថែមចំណាយ', editExpenseButton: 'កែសម្រួលចំណាយ',
                itemNameLabel: 'ការពិពណ៌នា', categoryLabel: 'ប្រភេទ', quantityLabel: 'បរិមាណ', priceLabel: 'តម្លៃ', totalLabel: 'សរុប',
                recordedByHeader: 'កត់ត្រាដោយ', expenseSuccess: 'ចំណាយប្រចាំថ្ងៃត្រូវបានបន្ថែមដោយជោគជ័យ។', expenseUpdateSuccess: 'ចំណាយត្រូវបានកែសម្រួលដោយជោគជ័យ។', expenseDeleteSuccess: 'ចំណាយត្រូវបានលុបដោយជោគជ័យ។',
                confirmExpenseDelete: 'តើអ្នកប្រាកដថាចង់លុបការចំណាយនេះមែនទេ?', totalExpenseLabel: 'ចំណាយសរុប',
                sessionExpiringTitle: 'សម័យការងារជិតផុតកំណត់', sessionExpiringMessage: 'សម័យការងាររបស់អ្នកនឹងផុតកំណត់ក្នុងរយៈពេល {{seconds}} វិនាទី ដោយសារគ្មានសកម្មភាព។ តើអ្នកចង់បន្តការចូលប្រើទេ?', stayLoggedInButton: 'បន្តការចូលប្រើ'
            }
        };

        // --- FIREBASE SERVICE ---
        const firebaseService = (() => {
            let app, auth, db;
            try {
                app = firebaseSDK.initializeApp(firebaseConfig);
                auth = firebaseSDK.getAuth(app);
                db = firebaseSDK.getFirestore(app);
            } catch (e) { console.error("Firebase Init Error", e); return {}; }

            const normalizeDoc = (doc) => {
                const data = doc.data();
                return {
                    id: doc.id,
                    ...data,
                    createdAt: data.createdAt?.toDate ? data.createdAt.toDate() : (data.createdAt ? new Date(data.createdAt) : null),
                    date: data.date?.toDate ? data.date.toDate() : (data.date ? new Date(data.date) : null)
                };
            };

            return {
                getAuth: () => auth, getDb: () => db, getTimestamp: () => firebaseSDK.Timestamp,
                onAuthChange: (cb) => firebaseSDK.onAuthStateChanged(auth, cb),
                login: async (e, p, r) => {
                    await firebaseSDK.setPersistence(auth, r ? firebaseSDK.browserLocalPersistence : firebaseSDK.browserSessionPersistence);
                    return firebaseSDK.signInWithEmailAndPassword(auth, e, p);
                },
                logout: () => firebaseSDK.signOut(auth),
                fetchEmployeeProfile: async (uid) => {
                    const docSnap = await firebaseSDK.getDoc(firebaseSDK.doc(db, 'employees', uid));
                    return docSnap.exists() ? { uid, ...docSnap.data() } : null;
                },
                streamShops: (cb) => firebaseSDK.onSnapshot(firebaseSDK.collection(db, "shops"), (snap) => cb(snap.docs.map(d => ({ id: d.id, ...d.data() })))),
                streamReports: (cb, range) => {
                    let constraints = [firebaseSDK.orderBy("createdAt", "desc")];
                    if (range && range.start) {
                        constraints.push(firebaseSDK.where("createdAt", ">=", firebaseSDK.Timestamp.fromDate(range.start)));
                        if (range.end) constraints.push(firebaseSDK.where("createdAt", "<=", firebaseSDK.Timestamp.fromDate(range.end)));
                    } else constraints.push(firebaseSDK.limit(500));
                    return firebaseSDK.onSnapshot(firebaseSDK.query(firebaseSDK.collection(db, "cashDrops"), ...constraints), (snap) => cb(snap.docs.map(normalizeDoc)));
                },
                addReport: (data) => firebaseSDK.addDoc(firebaseSDK.collection(db, "cashDrops"), data),
                updateReport: (id, data) => firebaseSDK.updateDoc(firebaseSDK.doc(db, "cashDrops", id), data),
                deleteReport: (id) => firebaseSDK.deleteDoc(firebaseSDK.doc(db, "cashDrops", id)),
                getHistoricalComparison: async (shopName) => {
                    const now = new Date();
                    const yStart = new Date(now.getFullYear(), now.getMonth(), now.getDate() - 1);
                    const yEnd = new Date(now.getFullYear(), now.getMonth(), now.getDate() - 1, 23, 59, 59, 999);
                    const lmStart = new Date(now.getFullYear(), now.getMonth() - 1, 1);
                    const lmEnd = new Date(now.getFullYear(), now.getMonth(), 0, 23, 59, 59, 999);
                    try {
                        const [snapY, snapLM] = await Promise.all([
                            firebaseSDK.getDocs(firebaseSDK.query(firebaseSDK.collection(db, "cashDrops"), firebaseSDK.where("createdAt", ">=", firebaseSDK.Timestamp.fromDate(yStart)), firebaseSDK.where("createdAt", "<=", firebaseSDK.Timestamp.fromDate(yEnd)))),
                            firebaseSDK.getDocs(firebaseSDK.query(firebaseSDK.collection(db, "cashDrops"), firebaseSDK.where("createdAt", ">=", firebaseSDK.Timestamp.fromDate(lmStart)), firebaseSDK.where("createdAt", "<=", firebaseSDK.Timestamp.fromDate(lmEnd))))
                        ]);
                        const calc = (snap) => snap.docs.reduce((acc, d) => {
                            const data = d.data();
                            if (shopName && data.shop !== shopName) return acc;
                            const cash = (data.cashUsd||0)*DEFAULT_EXCHANGE_RATE + (data.cashKhr||0);
                            const bank = (data.bankUsd||0)*DEFAULT_EXCHANGE_RATE + (data.bankKhr||0);
                            return { netSale: acc.netSale + (data.grandTotalKhr||0), cash: acc.cash + cash, bank: acc.bank + bank };
                        }, { netSale: 0, cash: 0, bank: 0 });
                        return { yesterday: calc(snapY), lastMonth: calc(snapLM) };
                    } catch (e) { return { yesterday: {netSale:0,cash:0,bank:0}, lastMonth: {netSale:0,cash:0,bank:0} }; }
                },
                streamBusinessCategories: (cb) => firebaseSDK.onSnapshot(firebaseSDK.query(firebaseSDK.collection(db, "businessExpenseCategories"), firebaseSDK.orderBy("name", "asc")), (snap) => cb(snap.docs.map(d => ({id:d.id, ...d.data()})))),
                streamExpenses: (cb, range) => {
                    let constraints = [firebaseSDK.orderBy("date", "desc")];
                    if (range && range.start) {
                        constraints.push(firebaseSDK.where("date", ">=", firebaseSDK.Timestamp.fromDate(range.start)));
                        if (range.end) constraints.push(firebaseSDK.where("date", "<=", firebaseSDK.Timestamp.fromDate(range.end)));
                    } else constraints.push(firebaseSDK.limit(500));
                    return firebaseSDK.onSnapshot(firebaseSDK.query(firebaseSDK.collection(db, "businessExpenses"), ...constraints), (snap) => cb(snap.docs.map(normalizeDoc)));
                },
                addExpense: (d) => firebaseSDK.addDoc(firebaseSDK.collection(db, "businessExpenses"), d),
                updateExpense: (id, d) => firebaseSDK.updateDoc(firebaseSDK.doc(db, "businessExpenses", id), d),
                deleteExpense: (id) => firebaseSDK.deleteDoc(firebaseSDK.doc(db, "businessExpenses", id))
            };
        })();

        // --- UTILS ---
        const parseCurrency = (val) => parseFloat(String(val).replace(/,/g, '')) || 0;
        const formatInputAsCurrency = (val) => val.replace(/[^0-9.]/g, '').replace(/\B(?=(\d{3})+(?!\d))/g, ',');
        const formatCurrency = (val, curr) => {
            const num = parseFloat(String(val).replace(/,/g, '')) || 0;
            const fmt = num.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            // UPDATED: Use non-breaking space (\u00A0) to prevent line breaks between number and symbol
            return curr === 'KHR' ? `${fmt}\u00A0៛` : (curr === 'USD' ? `${fmt}\u00A0$` : fmt);
        };
        const formatDateDDMMYYYY = (d) => d ? `${String(d.getDate()).padStart(2,'0')}-${String(d.getMonth()+1).padStart(2,'0')}-${d.getFullYear()}` : 'N/A';
        const formatFullDateTime = (d) => d ? `${formatDateDDMMYYYY(d)} | ${d.toLocaleTimeString('en-GB',{timeZone:'Asia/Phnom_Penh',hour:'2-digit',minute:'2-digit'})}` : 'N/A';
        const formatExpenseDateTime = (d) => {
            if(!d) return 'N/A';
            const h = d.getHours();
            return `${String(d.getDate()).padStart(2,'0')}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getFullYear()).slice(-2)} | ${h%12||12}:${String(d.getMinutes()).padStart(2,'0')} ${h>=12?'PM':'AM'}`;
        };
        const createTimestampFromDateAndCurrentTime = (dateStr) => {
            const now = new Date();
            const d = new Date(dateStr);
            d.setHours(now.getHours(), now.getMinutes(), now.getSeconds(), now.getMilliseconds());
            return firebaseService.getTimestamp().fromDate(d);
        };

        // --- CONTEXTS ---
        const LanguageContext = createContext();
        const LanguageProvider = ({ children }) => {
            const [locale, setLocale] = useState('en');
            const t = useCallback((key, params) => {
                let res = key.split('.').reduce((o,i)=>o?.[i], translations[locale]) || key;
                if(params) Object.entries(params).forEach(([k,v]) => res = res.replace(`{{${k}}}`, v));
                return res;
            }, [locale]);
            return <LanguageContext.Provider value={{ locale, setLocale, t }}>{children}</LanguageContext.Provider>;
        };

        const ThemeContext = createContext();
        function ThemeProvider({ children }) {
            const [theme, setTheme] = useState(() => localStorage.getItem('theme') || 'dark');
            useEffect(() => {
                document.documentElement.classList.remove('dark','light','charcoal','nord','forest','rose','ocean','sunset','lavender','grayscale');
                document.documentElement.classList.add(theme==='dark'?'dark':theme);
                localStorage.setItem('theme', theme);
            }, [theme]);
            return <ThemeContext.Provider value={{ theme, setTheme }}>{children}</ThemeContext.Provider>;
        }

        const ToastContext = createContext();
        const ToastProvider = ({ children }) => {
            const [toast, setToast] = useState(null);
            const showToast = useCallback((msg, type='success') => { setToast({msg, type}); setTimeout(()=>setToast(null),3000); }, []);
            return (
                <ToastContext.Provider value={{ showToast }}>
                    {children}
                    {toast && <div className={`fixed bottom-4 right-4 z-[9999] px-6 py-3 rounded-lg shadow-lg border text-white animate-bounce ${toast.type==='error'?'bg-red-500 border-red-700':'bg-green-500 border-green-700'}`}>{toast.msg}</div>}
                </ToastContext.Provider>
            );
        };

        const AuthContext = createContext();
        const AppContext = createContext();

        const AuthProvider = ({ children }) => {
            const [user, setUser] = useState(null);
            const [userData, setUserData] = useState(null);
            const [loading, setLoading] = useState(true);
            const [authError, setAuthError] = useState(null);
            useEffect(() => {
                return firebaseService.onAuthChange(async (u) => {
                    if (u) {
                        const profile = await firebaseService.fetchEmployeeProfile(u.uid);
                        if (profile) { setUser(u); setUserData(profile); }
                        else { await firebaseService.logout(); setAuthError({ message: 'employeeProfileError' }); }
                    } else { setUser(null); setUserData(null); }
                    setLoading(false);
                });
            }, []);
            return <AuthContext.Provider value={{ user, userData, login: firebaseService.login, logout: firebaseService.logout, loading, authError, setAuthError }}>{children}</AuthContext.Provider>;
        };

        const AppProvider = ({ children }) => {
            const { userData } = useContext(AuthContext);
            const [shops, setShops] = useState([]);
            const [reports, setReports] = useState([]);
            const [businessExpenses, setBusinessExpenses] = useState([]);
            const [businessCategories, setBusinessCategories] = useState([]);
            const [isLoading, setIsLoading] = useState(true);
            const [reportDateRange, setReportDateRange] = useState(null);
            const [expenseDateRange, setExpenseDateRange] = useState(null);

            useEffect(() => {
                if (!userData) return;
                // UPDATED: Removed ROLES.MANAGEMENT, kept ROLES.SHOP_MANAGER
                const canView = [ROLES.ADMIN, ROLES.SHOP_MANAGER].includes(userData.role);
                
                let unsubR = () => {}, unsubE = () => {};
                if (canView) unsubR = firebaseService.streamReports(setReports, reportDateRange);
                unsubE = firebaseService.streamExpenses(setBusinessExpenses, expenseDateRange);
                const unsubC = firebaseService.streamBusinessCategories(setBusinessCategories);
                const unsubS = firebaseService.streamShops((s) => { setShops(s); setIsLoading(false); });
                return () => { unsubR(); unsubS(); unsubE(); unsubC(); };
            }, [userData, reportDateRange, expenseDateRange]);

            const value = useMemo(() => ({
                shops, reports, businessExpenses, businessCategories, isLoading,
                appSettings: { exchangeRate: DEFAULT_EXCHANGE_RATE },
                fetchReportsInRange: (start, end) => setReportDateRange({ start, end }),
                fetchExpensesInRange: (start, end) => setExpenseDateRange({ start, end }),
                resetReportsFetch: () => setReportDateRange(null),
                resetExpensesFetch: () => setExpenseDateRange(null)
            }), [shops, reports, businessExpenses, businessCategories, isLoading, reportDateRange, expenseDateRange]);
            return <AppContext.Provider value={value}>{children}</AppContext.Provider>;
        };

        const useTranslation = () => useContext(LanguageContext);
        const useTheme = () => useContext(ThemeContext);
        const useAuth = () => useContext(AuthContext);
        const useAppContext = () => useContext(AppContext);
        const useToast = () => useContext(ToastContext);

        // --- NEW COMPONENT: Auto Logout Handler ---
        const SessionTimeoutManager = ({ children }) => {
            const { user, logout } = useAuth();
            const { t } = useTranslation();
            const [showWarning, setShowWarning] = useState(false);
            const [timeLeft, setTimeLeft] = useState(60); // Seconds left during warning
            const lastActivity = useRef(Date.now());
            const warningTimer = useRef(null);

            useEffect(() => {
                if (!user) return;

                const checkInactivity = () => {
                    const now = Date.now();
                    const inactiveTime = now - lastActivity.current;
                    const timeUntilWarning = INACTIVITY_TIMEOUT - TIMEOUT_WARNING;

                    if (inactiveTime >= INACTIVITY_TIMEOUT) {
                        setShowWarning(false);
                        logout();
                    } else if (inactiveTime >= timeUntilWarning) {
                        if (!showWarning) {
                            setShowWarning(true);
                            setTimeLeft(Math.ceil((INACTIVITY_TIMEOUT - inactiveTime) / 1000));
                        } else {
                            setTimeLeft(Math.ceil((INACTIVITY_TIMEOUT - inactiveTime) / 1000));
                        }
                    } else {
                        if (showWarning) setShowWarning(false);
                    }
                };

                const resetActivity = () => {
                    lastActivity.current = Date.now();
                    if (showWarning) setShowWarning(false);
                };

                // Events to track
                const events = ['mousedown', 'mousemove', 'keydown', 'scroll', 'touchstart'];
                events.forEach(e => window.addEventListener(e, resetActivity));
                
                // Check timer every second
                const intervalId = setInterval(checkInactivity, 1000);

                return () => {
                    events.forEach(e => window.removeEventListener(e, resetActivity));
                    clearInterval(intervalId);
                };
            }, [user, logout, showWarning]);

            return (
                <>
                    {children}
                    {showWarning && (
                        <Modal isOpen={true} onClose={() => {}}>
                            <ModalHeader>{t('sessionExpiringTitle')}</ModalHeader>
                            <ModalBody>
                                <div className="text-center space-y-4">
                                    <div className="mx-auto w-16 h-16 bg-amber-500/20 text-amber-500 rounded-full flex items-center justify-center animate-pulse">
                                        <Icon name="clock" className="w-8 h-8" />
                                    </div>
                                    <p className="text-[var(--text-secondary)]">{t('sessionExpiringMessage', { seconds: timeLeft })}</p>
                                </div>
                            </ModalBody>
                            <ModalFooter>
                                <button 
                                    onClick={() => { lastActivity.current = Date.now(); setShowWarning(false); }} 
                                    className="w-full bg-[var(--accent-color)] text-white py-2.5 rounded-lg font-bold hover:bg-[var(--accent-color-hover)] transition-colors"
                                >
                                    {t('stayLoggedInButton')}
                                </button>
                            </ModalFooter>
                        </Modal>
                    )}
                </>
            );
        };

        const useAvailableShops = () => {
            const { shops } = useAppContext();
            const { userData } = useAuth();
            return useMemo(() => {
                if (!userData || !shops) return [];
                // UPDATED: Restricted SHOP_MANAGER to see only assigned shops (removed from Admin check)
                if ([ROLES.ADMIN].includes(userData.role)) return shops;
                return shops.filter(s => userData.shopIds?.includes(s.id));
            }, [shops, userData]);
        };
        
        const useShopColorMap = () => {
            const { shops } = useAppContext();
            return useMemo(() => shops.reduce((map, s, i) => {
                const c = ['blue','green','yellow','pink','indigo','teal'][i % 6];
                map[s.name] = { base: `bg-${c}-900/20`, hover: `hover:bg-${c}-800/30` };
                return map;
            }, {}), [shops]);
        };

        const useFilteredReports = (reports, filters, userData, availableShops) => {
            return useMemo(() => {
                if (!reports || !userData) return { filteredAndAggregatedData: null, totals: {} };
                
                // UPDATED: Restricted SHOP_MANAGER. Only ADMIN sees all reports globally.
                let filtered = [ROLES.ADMIN].includes(userData.role) 
                    ? reports 
                    : reports.filter(r => availableShops.some(s => s.name === r.shop));
                
                const { dueTime, startDate, endDate, shop } = filters;
                const now = new Date();
                let start, end;

                switch(dueTime) {
                    case 'Today': start = new Date(now.getFullYear(), now.getMonth(), now.getDate()); break;
                    case 'Yesterday': start = new Date(now.getFullYear(), now.getMonth(), now.getDate()-1); end = new Date(now.getFullYear(), now.getMonth(), now.getDate()-1, 23, 59, 59, 999); break;
                    case 'This Month': start = new Date(now.getFullYear(), now.getMonth(), 1); break;
                    case 'Last Month': start = new Date(now.getFullYear(), now.getMonth()-1, 1); end = new Date(now.getFullYear(), now.getMonth(), 0, 23, 59, 59, 999); break;
                    case 'This Year': start = new Date(now.getFullYear(), 0, 1); break;
                    case 'Last Year': start = new Date(now.getFullYear()-1, 0, 1); end = new Date(now.getFullYear()-1, 11, 31, 23, 59, 59, 999); break;
                    case 'Custom': if(startDate && endDate) { start = new Date(startDate+'T00:00:00'); end = new Date(endDate+'T23:59:59.999'); } break;
                }
                if(start) filtered = filtered.filter(r => r.createdAt >= start && (!end || r.createdAt <= end));
                if(shop) filtered = filtered.filter(r => r.shop === shop);

                let type = 'detailed', data = filtered;
                if(!['Today','Yesterday','Custom'].includes(dueTime)) {
                    type = 'aggregated';
                    const agg = filtered.reduce((acc, r) => {
                        const p = ['This Month','Last Month'].includes(dueTime) ? r.createdAt.toLocaleString('en-US',{month:'short',year:'numeric'}) : r.createdAt.getFullYear().toString();
                        const k = `${p}|${r.shop}`;
                        if(!acc[k]) acc[k] = { period: p, shop: r.shop, cashUsd:0, cashKhr:0, bankUsd:0, bankKhr:0, grandTotalKhr:0, cashExchangeKhr:0, cashExchangeUsd:0 };
                        acc[k].cashUsd+=r.cashUsd||0; acc[k].cashKhr+=r.cashKhr||0; acc[k].bankUsd+=r.bankUsd||0; acc[k].bankKhr+=r.bankKhr||0;
                        acc[k].cashExchangeKhr+=r.cashExchangeKhr||0; acc[k].cashExchangeUsd+=r.cashExchangeUsd||0; acc[k].grandTotalKhr+=r.grandTotalKhr||0;
                        return acc;
                    }, {});
                    data = Object.values(agg);
                }
                const totals = data.reduce((acc, r) => {
                    acc.cashUsd+=r.cashUsd||0; acc.cashKhr+=r.cashKhr||0; acc.bankUsd+=r.bankUsd||0; acc.bankKhr+=r.bankKhr||0;
                    acc.cashExchangeKhr+=r.cashExchangeKhr||0; acc.cashExchangeUsd+=r.cashExchangeUsd||0; acc.netSale+=r.grandTotalKhr||0;
                    return acc;
                }, { cashUsd:0, cashKhr:0, bankUsd:0, bankKhr:0, cashExchangeKhr:0, cashExchangeUsd:0, netSale:0 });
                return { filteredAndAggregatedData: { type, data }, totals };
            }, [reports, filters, userData, availableShops]);
        };

        // --- COMPONENTS ---
        const Icon = React.memo(({ name, className = "w-5 h-5" }) => {
            const icons = {
                loader: <svg className={`${className} animate-spin`} viewBox="0 0 24 24" fill="none"><circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle><path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>,
                note: <svg className={className} fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.5L15.232 5.232z" /></svg>,
                trash: <svg className={className} fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>,
                logout: <svg className={className} fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" d="M15.75 9V5.25A2.25 2.25 0 0013.5 3h-6a2.25 2.25 0 00-2.25 2.25v13.5A2.25 2.25 0 007.5 21h6a2.25 2.25 0 002.25-2.25V15m3 0l-3-3m0 0l-3 3m3-3V9" /></svg>,
                eye: <svg className={className} fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" d="M2.036 12.322a1.012 1.012 0 010-.639C3.423 7.51 7.36 4.5 12 4.5c4.638 0 8.573 3.007 9.963 7.178.07.207.07.431 0 .639C20.577 16.49 16.64 19.5 12 19.5c-4.638 0-8.573-3.007-9.963-7.178z" /><path strokeLinecap="round" strokeLinejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>,
                'eye-off': <svg className={className} fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" d="M3.98 8.223A10.477 10.477 0 001.934 12C3.226 16.338 7.244 19.5 12 19.5c.993 0 1.953-.138 2.863-.395M6.228 6.228A10.45 10.45 0 0112 4.5c4.756 0 8.773 3.162 10.065 7.498a10.523 10.523 0 01-4.293 5.774M6.228 6.228L3 3m3.228 3.228l3.65 3.65m7.894 7.894L21 21m-3.228-3.228l-3.65-3.65m0 0a3 3 0 10-4.243-4.243m4.243 4.243L6.228 6.228" /></svg>,
                install: <svg className={className} fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5M16.5 12L12 16.5m0 0L7.5 12m4.5 4.5V3" /></svg>,
                export: <svg className={className} fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" d="M12 9.75v6.75m0 0l-3-3m3 3l3-3m-8.25 6a4.5 4.5 0 01-1.41-8.775 5.25 5.25 0 0110.233-2.33 3 3 0 013.758 3.848A3.752 3.752 0 0118 19.5H6.75z" /></svg>,
                'document-text': <svg className={className} fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m0 12.75h7.5m-7.5 3H12M10.5 2.25H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 00-9-9z" /></svg>,
                palette: <svg className={className} fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" d="M4.098 19.902a3.75 3.75 0 005.304 0l6.401-6.402M6.75 21A3.75 3.75 0 013 17.25V4.125C3 3.504 3.504 3 4.125 3h5.25c.621 0 1.125.504 1.125 1.125v4.072M6.75 21a3.75 3.75 0 003.75-3.75V8.197M6.75 21h13.125c.621 0 1.125-.504 1.125-1.125V4.125C21 3.504 20.496 3 19.875 3H17.25z" /></svg>,
                plus: <svg className={className} fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" d="M12 4.5v15m7.5-7.5h-15" /></svg>,
                landmark: <svg className={className} fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" d="M12 21v-8.25M15.75 21v-8.25M8.25 21v-8.25M3 9l9-6 9 6m-1.5 12V10.332A48.36 48.36 0 0012 9.75c-2.551 0-5.056.2-7.5.582V21M3 21h18M12 6.75h.008v.008H12V6.75z" /></svg>,
                calendar: <svg className={className} fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" d="M6.75 3v2.25M17.25 3v2.25M3 18.75V7.5a2.25 2.25 0 012.25-2.25h13.5A2.25 2.25 0 0121 7.5v11.25m-18 0A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75m-18 0v-7.5A2.25 2.25 0 015.25 9h13.5A2.25 2.25 0 0121 11.25v7.5" /></svg>,
                store: <svg className={className} fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" d="M13.5 21v-7.5a.75.75 0 01.75-.75h3a.75.75 0 01.75.75V21m-4.5 0H2.36m11.14 0H18m0 0h3.64m-1.39 0V9.349m-16.5 11.65V9.35m0 0a3.001 3.001 0 003.75-.615A2.993 2.993 0 009.75 9.75c.896 0 1.7-.393 2.25-1.016a2.993 2.993 0 002.25 1.016c.896 0 1.7-.393 2.25-1.016a3.001 3.001 0 003.75.614m-16.5 0a3.004 3.004 0 01-.621-4.72l1.189-1.19A1.5 1.5 0 015.378 3h13.243a1.5 1.5 0 011.06.44l1.19 1.189a3 3 0 01-.621 4.72m-13.5 8.65h3.75a.75.75 0 00.75-.75V13.5a.75.75 0 00-.75-.75H6.75a.75.75 0 00-.75.75v3.75c0 .415.336.75.75.75z" /></svg>,
                user: <svg className={className} fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" d="M15.75 6a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0zM4.501 20.118a7.5 7.5 0 0114.998 0A17.933 17.933 0 0112 21.75c-2.676 0-5.216-.584-7.499-1.632z" /></svg>,
                clock: <svg className={className} fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" d="M12 6v6h4.5m4.5 0a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>,
                banknotes: <svg className={className} fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" d="M2.25 18.75a60.07 60.07 0 0115.797 2.101c.727.198 1.453-.342 1.453-1.096V18.75M3.75 4.5v.75A.75.75 0 013 6h-.75m0 0v-.375c0-.621.504-1.125 1.125-1.125H20.25M2.25 6v9m18-10.5v.75c0 .414.336.75.75.75h.75m-1.5-1.5h.375c.621 0 1.125.504 1.125 1.125v9.75c0 .621-.504 1.125-1.125 1.125h-.375m1.5-1.5H21a.75.75 0 00-.75.75v.75m0 0H3.75m0 0h-.375a1.125 1.125 0 01-1.125-1.125V15m1.5 1.5v-.75A.75.75 0 003 15h-.75M15 10.5a3 3 0 11-6 0 3 3 0 016 0zm3 0h.008v.008H18V10.5zm-12 0h.008v.008H6V10.5z" /></svg>,
                'credit-card': <svg className={className} fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" d="M2.25 8.25h19.5M2.25 9h19.5m-16.5 5.25h6m-6 2.25h3m-3.75 3h15a2.25 2.25 0 002.25-2.25V6.75A2.25 2.25 0 0019.5 4.5h-15a2.25 2.25 0 00-2.25 2.25v10.5A2.25 2.25 0 004.5 19.5z" /></svg>,
                refresh: <svg className={className} fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0l3.181 3.183a8.25 8.25 0 0013.803-3.7M4.031 9.865a8.25 8.25 0 0113.803-3.7l3.181 3.182m0-4.991v4.99" /></svg>
            };
            return icons[name] || null;
        });

        const LoadingSpinner = () => <div className="flex justify-center items-center h-screen"><Icon name="loader" className="w-12 h-12 text-[var(--accent-color)]" /></div>;
        
        const SkeletonCard = () => (
            <div className="p-4 rounded-lg border border-[var(--border-color)] bg-[var(--background-secondary)] animate-pulse mb-4">
                <div className="flex justify-between items-start mb-2 border-b border-[var(--border-color)]/30 pb-2">
                    <div className="space-y-2"><div className="h-4 w-24 bg-[var(--background-input)] rounded"></div><div className="h-3 w-32 bg-[var(--background-input)] rounded"></div></div>
                    <div className="h-6 w-20 bg-[var(--background-input)] rounded"></div>
                </div>
                <div className="grid grid-cols-2 gap-4 mb-3"><div className="h-3 w-full bg-[var(--background-input)] rounded"></div><div className="h-3 w-full bg-[var(--background-input)] rounded"></div><div className="h-3 w-full bg-[var(--background-input)] rounded"></div><div className="h-3 w-full bg-[var(--background-input)] rounded"></div></div>
                <div className="flex justify-between pt-2 border-t border-[var(--border-color)]/30"><div className="h-4 w-12 bg-[var(--background-input)] rounded"></div><div className="flex gap-2"><div className="h-5 w-5 bg-[var(--background-input)] rounded"></div><div className="h-5 w-5 bg-[var(--background-input)] rounded"></div></div></div>
            </div>
        );

        const SkeletonRow = () => (
            <tr className="animate-pulse">
                {[1,2,3,4,5,6,7,8].map(i => <td key={i} className="p-4"><div className="h-4 w-12 bg-[var(--background-input)] rounded"></div></td>)}
            </tr>
        );

        const Modal = ({ children, onClose, isOpen }) => !isOpen ? null : (
            <div className="fixed inset-0 bg-black bg-opacity-70 z-50 flex justify-center items-center p-4" onClick={onClose}>
                <div className="bg-[var(--background-secondary)] border border-[var(--border-color)] rounded-lg shadow-xl w-full max-w-md flex flex-col max-h-[90vh] overflow-hidden" onClick={e => e.stopPropagation()}>
                    {children}
                </div>
            </div>
        );
        const ModalHeader = ({ children }) => <div className="p-6 border-b border-[var(--border-color)] shrink-0"><h3 className="text-lg font-bold text-[var(--text-primary)]">{children}</h3></div>;
        const ModalBody = ({ children, className = "" }) => <div className={`p-6 flex-grow overflow-y-auto ${className}`}>{children}</div>;
        const ModalFooter = ({ children }) => <div className="bg-[var(--background-primary)]/50 px-6 py-3 flex justify-end items-center gap-3 border-t border-[var(--border-color)] shrink-0">{children}</div>;

        const FormInput = React.memo(({ label, name, icon, ...props }) => (
            <div>
                <label htmlFor={name} className="flex items-center gap-1.5 md:gap-2 text-xs md:text-sm font-semibold text-[var(--text-secondary)] mb-1">
                    {icon && <span className="text-[var(--accent-color)] bg-[var(--accent-color)]/10 p-0.5 md:p-1 rounded"><Icon name={icon} className="w-3 h-3 md:w-3.5 md:h-3.5" /></span>}
                    {label}
                </label>
                <input id={name} name={name} {...props} className="block w-full px-2 py-1.5 md:px-3 md:py-2 bg-[var(--background-input)] border border-[var(--border-color)] rounded-lg shadow-sm placeholder-[var(--text-secondary)] focus:outline-none focus:ring-2 focus:ring-[var(--accent-color)] text-[var(--text-primary)] text-sm disabled:bg-[var(--background-secondary)] disabled:text-[var(--text-secondary)] transition-all" />
            </div>
        ));

        const FormTextarea = React.memo(({ label, name, icon, ...props }) => (
            <div>
                <label htmlFor={name} className="flex items-center gap-1.5 md:gap-2 text-xs md:text-sm font-semibold text-[var(--text-secondary)] mb-1">
                    {icon && <span className="text-[var(--accent-color)] bg-[var(--accent-color)]/10 p-0.5 md:p-1 rounded"><Icon name={icon} className="w-3 h-3 md:w-3.5 md:h-3.5" /></span>}
                    {label}
                </label>
                <textarea id={name} name={name} {...props} className="block w-full px-2 py-1.5 md:px-3 md:py-2 bg-[var(--background-input)] border border-[var(--border-color)] rounded-lg shadow-sm placeholder-[var(--text-secondary)] focus:outline-none focus:ring-2 focus:ring-[var(--accent-color)] text-[var(--text-primary)] text-sm disabled:bg-[var(--background-secondary)] disabled:text-[var(--text-secondary)] min-h-[80px]" />
            </div>
        ));

        const FormSelect = React.memo(({ label, name, options, icon, ...props }) => (
            <div>
                <label htmlFor={name} className="flex items-center gap-1.5 md:gap-2 text-xs md:text-sm font-semibold text-[var(--text-secondary)] mb-1">
                    {icon && <span className="text-[var(--accent-color)] bg-[var(--accent-color)]/10 p-0.5 md:p-1 rounded"><Icon name={icon} className="w-3 h-3 md:w-3.5 md:h-3.5" /></span>}
                    {label}
                </label>
                <select id={name} name={name} {...props} className="block w-full px-2 py-1.5 md:px-3 md:py-2 bg-[var(--background-input)] border border-[var(--border-color)] rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-[var(--accent-color)] text-[var(--text-primary)] text-sm">
                    {options.map(o => <option key={o.value} value={o.value}>{o.label}</option>)}
                </select>
            </div>
        ));

        const SmartCurrencyInput = ({ value, onChange, ...props }) => {
            const handleChange = (e) => {
                const raw = e.target.value;
                if (/[+\-*/]/.test(raw)) onChange({ target: { name: props.name, value: raw } });
                else onChange({ target: { name: props.name, value: formatInputAsCurrency(raw) } });
            };
            const handleBlur = (e) => {
                const raw = e.target.value;
                if (/[+\-*/]/.test(raw)) {
                    try {
                        const safeMath = raw.replace(/,/g, '').replace(/[^0-9+\-*/().]/g, '');
                        if (safeMath) {
                            // eslint-disable-next-line
                            const res = Function('"use strict";return (' + safeMath + ')')();
                            if (isFinite(res)) onChange({ target: { name: props.name, value: formatInputAsCurrency(String(res)) } });
                        }
                    } catch (err) { onChange({ target: { name: props.name, value: formatInputAsCurrency(raw) } }); }
                } else onChange({ target: { name: props.name, value: formatInputAsCurrency(raw) } });
                if (props.onBlur) props.onBlur(e);
            };
            return <FormInput {...props} value={value} onChange={handleChange} onBlur={handleBlur} placeholder="0" />;
        };

        // REDESIGNED: CategoryCard now supports color themes and compact padding
        const CategoryCard = ({ title, icon, children, className="", theme="default" }) => {
            const themes = {
                default: { border: 'border-[var(--border-color)]', bg: 'bg-[var(--background-secondary)]', iconBg: 'bg-[var(--accent-color)]/10', iconText: 'text-[var(--accent-color)]', title: 'text-[var(--text-primary)]' },
                blue: { border: 'border-blue-500/30', bg: 'bg-blue-500/5', iconBg: 'bg-blue-500/20', iconText: 'text-blue-500', title: 'text-blue-500' },
                emerald: { border: 'border-emerald-500/30', bg: 'bg-emerald-500/5', iconBg: 'bg-emerald-500/20', iconText: 'text-emerald-500', title: 'text-emerald-500' },
                cyan: { border: 'border-cyan-500/30', bg: 'bg-cyan-500/5', iconBg: 'bg-cyan-500/20', iconText: 'text-cyan-500', title: 'text-cyan-500' },
                amber: { border: 'border-amber-500/30', bg: 'bg-amber-500/5', iconBg: 'bg-amber-500/20', iconText: 'text-amber-500', title: 'text-amber-500' },
                violet: { border: 'border-violet-500/30', bg: 'bg-violet-500/5', iconBg: 'bg-violet-500/20', iconText: 'text-violet-500', title: 'text-violet-500' },
            };
            const s = themes[theme] || themes.default;
            return (
                <div className={`${s.bg} border ${s.border} rounded-xl shadow-sm overflow-hidden flex flex-col ${className} transition-all duration-300 hover:shadow-md`}>
                    <div className={`px-3 py-2 md:px-4 md:py-3 border-b ${s.border} flex items-center gap-2 bg-[var(--background-primary)]/20`}>
                        <div className={`p-1 md:p-1.5 ${s.iconBg} ${s.iconText} rounded-lg`}><Icon name={icon} className="w-3.5 h-3.5 md:w-5 md:h-5" /></div>
                        <h3 className={`font-bold text-xs md:text-sm uppercase tracking-wide ${s.title}`}>{title}</h3>
                    </div>
                    <div className="p-3 md:p-5 flex-grow">{children}</div>
                </div>
            );
        };

        const CurrencyInputs = React.memo(({ khrName, usdName, khrValue, usdValue, onChange }) => {
            const { t } = useTranslation();
            return (
                <div className="grid grid-cols-1 gap-2 md:gap-4">
                    <SmartCurrencyInput label={t('khrLabel')} name={khrName} value={khrValue} onChange={onChange} icon="banknotes" />
                    <SmartCurrencyInput label={t('usdLabel')} name={usdName} value={usdValue} onChange={onChange} icon="banknotes" />
                </div>
            )
        });

        const ThemeSwitcher = () => {
            const { theme, setTheme } = useTheme();
            const [isOpen, setIsOpen] = useState(false);
            const popoverRef = useRef(null);
            const themes = [{ name: 'dark', color: '#0f172a' }, { name: 'light', color: '#ffffff' }, { name: 'charcoal', color: '#171717' }, { name: 'nord', color: '#2E3440' }, { name: 'sunset', color: '#451a03' }, { name: 'forest', color: '#1a2e2c' }, { name: 'ocean', color: '#0e2a47' }, { name: 'lavender', color: '#2b234a' }, { name: 'rose', color: '#3d1c2b' }, { name: 'grayscale', color: '#171717' }];
            useEffect(() => {
                const handleClickOutside = (e) => { if (popoverRef.current && !popoverRef.current.contains(e.target)) setIsOpen(false); };
                if (isOpen) document.addEventListener('mousedown', handleClickOutside);
                return () => document.removeEventListener('mousedown', handleClickOutside);
            }, [isOpen]);
            return (
                <div className="relative">
                    <button onClick={() => setIsOpen(!isOpen)} className="bg-[var(--background-input)]/50 p-2 rounded-lg text-[var(--text-secondary)] hover:text-[var(--text-primary)]"><Icon name="palette" className="w-5 h-5" /></button>
                    {isOpen && <div ref={popoverRef} className="absolute right-0 top-12 z-50 w-64 p-4 bg-[var(--background-secondary)] border border-[var(--border-color)] rounded-lg shadow-2xl"><div className="grid grid-cols-5 gap-3">{themes.map(t => <button key={t.name} onClick={()=>{setTheme(t.name);setIsOpen(false);}} className={`w-8 h-8 rounded-full ${theme===t.name?'ring-2 ring-[var(--accent-color)]':''} ${t.name==='light'?'border border-gray-400':''}`} style={{backgroundColor:t.color}}></button>)}</div></div>}
                </div>
            );
        };
        
        const ConfirmationModal = ({ isOpen, onClose, onConfirm, isSubmitting, title, message, confirmText, confirmColor = 'accent' }) => {
            const { t } = useTranslation();
            return <Modal isOpen={isOpen} onClose={onClose}><ModalHeader>{title}</ModalHeader><ModalBody><p className="text-sm text-[var(--text-secondary)]">{message}</p></ModalBody><ModalFooter><button onClick={onClose} disabled={isSubmitting} className="px-4 py-2 text-sm font-medium text-[var(--text-primary)] bg-[var(--background-input)] border border-[var(--border-color)] rounded-md">{t('cancelButton')}</button><button onClick={onConfirm} disabled={isSubmitting} className={`px-4 py-2 text-sm font-medium rounded-md flex items-center gap-2 ${confirmColor==='red'?'bg-red-500 hover:bg-red-600 text-white':'bg-[var(--accent-color)] hover:bg-[var(--accent-color-hover)] text-white'}`}>{isSubmitting && <Icon name="loader" className="w-4 h-4" />}{confirmText}</button></ModalFooter></Modal>;
        };

        const FloatingActionButton = ({ onClick, icon = "plus" }) => {
            const [isVisible, setIsVisible] = useState(true);
            const lastScrollY = useRef(0);
            useEffect(() => {
                const handleScroll = () => {
                    const currentScrollY = window.scrollY;
                    setIsVisible(!(currentScrollY > lastScrollY.current && currentScrollY > 100));
                    lastScrollY.current = currentScrollY;
                };
                window.addEventListener('scroll', handleScroll, { passive: true });
                return () => window.removeEventListener('scroll', handleScroll);
            }, []);
            return <button onClick={onClick} className={`fixed bottom-6 right-6 z-40 p-4 bg-[var(--accent-color)] text-white rounded-full shadow-2xl transition-all duration-300 transform md:hidden ${isVisible ? 'translate-y-0 opacity-100' : 'translate-y-24 opacity-0'}`}><Icon name={icon} className="w-7 h-7" /></button>;
        };

        const CollapsibleFilterSection = ({ children, summary }) => {
            const [isOpen, setIsOpen] = useState(false);
            return (
                <div className="mb-4">
                    <div className="md:hidden"><button onClick={() => setIsOpen(!isOpen)} className="w-full bg-[var(--background-secondary)] border border-[var(--border-color)] p-3 rounded-lg flex justify-between items-center shadow-sm"><div className="flex items-center gap-2 text-sm font-medium text-[var(--text-primary)]"><span className="bg-[var(--accent-color)]/10 text-[var(--accent-color)] p-1.5 rounded-md"><Icon name="palette" className="w-4 h-4" /></span><span>{isOpen ? 'Hide Filters' : 'Filter & Search'}</span></div><div className="text-xs text-[var(--text-secondary)] font-mono flex items-center gap-2">{!isOpen && summary}<svg className={`w-4 h-4 transition-transform ${isOpen ? 'rotate-180' : ''}`} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M19 9l-7 7-7-7"></path></svg></div></button></div>
                    <div className={`${isOpen ? 'block mt-3' : 'hidden'} md:block md:mt-0`}>{children}</div>
                </div>
            );
        };

        // --- DASHBOARD COMPONENTS ---
        const ReportFilters = React.memo(({ filters, setFilters, shops, onCustomClick }) => {
            const { t } = useTranslation();
            const timeFilterOptions = useMemo(() => [{ value: 'Today', label: t('timeFilters.today') }, { value: 'Yesterday', label: t('timeFilters.yesterday') }, { value: 'This Month', label: t('timeFilters.thisMonth') }, { value: 'Last Month', label: t('timeFilters.lastMonth') }, { value: 'This Year', label: t('timeFilters.thisYear') }, { value: 'Last Year', label: t('timeFilters.lastYear') }, { value: 'Custom', label: t('timeFilters.custom') }], [t]);
            const handleFilterChange = (e) => { const { name, value } = e.target; if (name === 'dueTime' && value === 'Custom') onCustomClick(); else setFilters(prev => ({...prev, [name]: value, startDate: '', endDate: ''})); };
            const filterSummary = `${filters.dueTime} • ${filters.shop || t('allShops')}`;
            return (
                <CollapsibleFilterSection summary={filterSummary}>
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4 p-4 bg-[var(--background-primary)]/50 rounded-lg items-center">
                        <FormSelect label={t('shopLabel')} name="shop" value={filters.shop} onChange={handleFilterChange} options={[{value:'',label: t('allShops')}, ...shops.map(s=>({value:s.name, label:s.name}))]} />
                        <FormSelect label={t('dueTimeLabel')} name="dueTime" value={filters.dueTime} onChange={handleFilterChange} options={timeFilterOptions} />
                    </div>
                </CollapsibleFilterSection>
            );
        });

        const StatsCards = ({ totals, historical }) => {
            const { t } = useTranslation();
            return (
                // UPDATED: grid-cols-2 on mobile allows Cash & Bank to sit side-by-side
                <div className="grid grid-cols-2 md:grid-cols-3 gap-3 md:gap-4 mb-6">
                    
                    {/* Card 1: Net Sale - Spans 2 columns on mobile (Full Width), 1 on desktop */}
                    <div className="col-span-2 md:col-span-1 relative overflow-hidden rounded-xl bg-gradient-to-br from-[var(--background-secondary)] to-[var(--background-primary)] border border-[var(--border-color)] shadow-lg p-4 md:p-5 group">
                        <div className="absolute -top-4 -right-4 text-[var(--accent-color)] opacity-5 group-hover:opacity-10 transition-opacity duration-500">
                            <Icon name="landmark" className="w-24 h-24 transform rotate-12" />
                        </div>
                        <div className="relative z-10">
                            <div className="flex items-center gap-2 mb-1">
                                <div className="w-1 h-3 bg-[var(--accent-color)] rounded-full"></div>
                                <p className="text-[10px] font-bold text-[var(--text-secondary)] uppercase tracking-widest">{t('netSaleHeader')}</p>
                            </div>
                            <h3 className="text-2xl xl:text-3xl font-black text-[var(--text-primary)] mt-2 font-mono tracking-tight drop-shadow-sm truncate">
                                {formatCurrency(totals.netSale, 'KHR')}
                            </h3>
                            
                            <div className="mt-4 flex gap-2">
                                <div className="flex-1 min-w-0 px-2 py-1.5 rounded-lg bg-[var(--background-input)]/30 border border-[var(--border-color)]/50 backdrop-blur-sm">
                                    <span className="text-[var(--text-secondary)] block text-[9px] uppercase font-semibold mb-0.5 truncate">Yesterday</span>
                                    <span className="font-mono text-xs xl:text-sm font-medium text-[var(--text-primary)] truncate block">{formatCurrency(historical?.yesterday?.netSale||0, 'KHR')}</span>
                                </div>
                                <div className="flex-1 min-w-0 px-2 py-1.5 rounded-lg bg-[var(--background-input)]/30 border border-[var(--border-color)]/50 backdrop-blur-sm">
                                    <span className="text-[var(--text-secondary)] block text-[9px] uppercase font-semibold mb-0.5 truncate">Last Month</span>
                                    <span className="font-mono text-xs xl:text-sm font-medium text-[var(--text-primary)] truncate block">{formatCurrency(historical?.lastMonth?.netSale||0, 'KHR')}</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    {/* Card 2: Cash Collected - Compact Mobile Layout */}
                    <div className="col-span-1 relative overflow-hidden rounded-xl bg-[var(--background-secondary)] border border-[var(--border-color)] shadow hover:shadow-emerald-900/10 transition-all duration-300">
                        <div className="absolute top-0 right-0 w-20 h-20 bg-emerald-500/5 rounded-full blur-2xl -translate-y-1/2 translate-x-1/2"></div>
                        <div className="p-3 md:p-5 h-full flex flex-col justify-between">
                            <div className="flex items-center gap-2 md:gap-3 mb-3 md:mb-4">
                                <div className="p-1.5 md:p-2 rounded-lg bg-emerald-500/10 text-emerald-500 ring-1 ring-emerald-500/20 shadow-sm">
                                    <Icon name="banknotes" className="w-4 h-4 md:w-5 md:h-5" />
                                </div>
                                <p className="text-[10px] md:text-xs font-bold text-[var(--text-secondary)] uppercase tracking-wide leading-tight">Cash Collected</p>
                            </div>
                            
                            <div className="space-y-2 md:space-y-3">
                                <div className="flex flex-col md:flex-row md:justify-between md:items-baseline border-b border-[var(--border-color)]/40 pb-2">
                                    <span className="text-[9px] md:text-[10px] font-semibold text-[var(--text-secondary)] bg-[var(--background-input)] px-1.5 py-0.5 rounded w-fit mb-1 md:mb-0">USD</span>
                                    <span className="text-base md:text-lg xl:text-xl font-bold font-mono text-[var(--text-primary)] truncate">{formatCurrency(totals.cashUsd, 'USD')}</span>
                                </div>
                                <div className="flex flex-col md:flex-row md:justify-between md:items-baseline pt-0.5">
                                    <span className="text-[9px] md:text-[10px] font-semibold text-[var(--text-secondary)] bg-[var(--background-input)] px-1.5 py-0.5 rounded w-fit mb-1 md:mb-0">KHR</span>
                                    <span className="text-base md:text-lg xl:text-xl font-bold font-mono text-emerald-500 truncate">{formatCurrency(totals.cashKhr, 'KHR')}</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    {/* Card 3: Bank Transfer - Compact Mobile Layout */}
                    <div className="col-span-1 relative overflow-hidden rounded-xl bg-[var(--background-secondary)] border border-[var(--border-color)] shadow hover:shadow-blue-900/10 transition-all duration-300">
                        <div className="absolute top-0 right-0 w-20 h-20 bg-blue-500/5 rounded-full blur-2xl -translate-y-1/2 translate-x-1/2"></div>
                        <div className="p-3 md:p-5 h-full flex flex-col justify-between">
                            <div className="flex items-center gap-2 md:gap-3 mb-3 md:mb-4">
                                <div className="p-1.5 md:p-2 rounded-lg bg-blue-500/10 text-blue-500 ring-1 ring-blue-500/20 shadow-sm">
                                    <Icon name="credit-card" className="w-4 h-4 md:w-5 md:h-5" />
                                </div>
                                <p className="text-[10px] md:text-xs font-bold text-[var(--text-secondary)] uppercase tracking-wide leading-tight">Bank Transfer</p>
                            </div>
                            
                            <div className="space-y-2 md:space-y-3">
                                <div className="flex flex-col md:flex-row md:justify-between md:items-baseline border-b border-[var(--border-color)]/40 pb-2">
                                    <span className="text-[9px] md:text-[10px] font-semibold text-[var(--text-secondary)] bg-[var(--background-input)] px-1.5 py-0.5 rounded w-fit mb-1 md:mb-0">USD</span>
                                    <span className="text-base md:text-lg xl:text-xl font-bold font-mono text-[var(--text-primary)] truncate">{formatCurrency(totals.bankUsd, 'USD')}</span>
                                </div>
                                <div className="flex flex-col md:flex-row md:justify-between md:items-baseline pt-0.5">
                                    <span className="text-[9px] md:text-[10px] font-semibold text-[var(--text-secondary)] bg-[var(--background-input)] px-1.5 py-0.5 rounded w-fit mb-1 md:mb-0">KHR</span>
                                    <span className="text-base md:text-lg xl:text-xl font-bold font-mono text-blue-500 truncate">{formatCurrency(totals.bankKhr, 'KHR')}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // NEW: Extracted SummaryContent to handle state independently
        const SummaryContent = ({ formData, grandTotal, children, submittedAt }) => {
            const { t } = useTranslation();
            const [time, setTime] = useState(submittedAt || new Date());
            
            useEffect(() => {
                if (submittedAt) {
                    setTime(submittedAt);
                    return;
                }
                const timer = setInterval(() => setTime(new Date()), 1000);
                return () => clearInterval(timer);
            }, [submittedAt]);

            return (
                <div className="bg-[var(--background-secondary)] border border-[var(--border-color)] rounded-2xl shadow-xl overflow-hidden sticky top-24 transition-all duration-300 hover:shadow-2xl">
                    {/* Header Section */}
                    <div className="bg-[var(--background-primary)]/50 p-5 border-b border-[var(--border-color)] relative overflow-hidden">
                        <div className="absolute top-0 right-0 p-4 opacity-5 pointer-events-none">
                            <Icon name="document-text" className="w-24 h-24 transform rotate-12" />
                        </div>
                        <div className="relative z-10 flex justify-between items-start">
                            <div>
                                <h3 className="text-sm font-bold text-[var(--text-primary)] uppercase tracking-wider mb-1">{t('summaryTitle')}</h3>
                                <div className="flex items-center gap-2">
                                     <span className="px-2 py-0.5 rounded text-[10px] font-bold bg-[var(--accent-color)]/10 text-[var(--accent-color)] border border-[var(--accent-color)]/20 uppercase tracking-wide">{formData.shift}</span>
                                     {/* NEW: Date + Live Clock */}
                                     <span className="text-xs text-[var(--text-secondary)] font-mono flex items-center gap-1.5">
                                         <Icon name="clock" className="w-3 h-3" />
                                         {formatDateDDMMYYYY(new Date(formData.date))} | {time.toLocaleTimeString('en-US', { hour12: true, hour: '2-digit', minute: '2-digit' })}
                                     </span>
                                </div>
                            </div>
                            <div className="text-right max-w-[50%]">
                                <p className="text-[10px] text-[var(--text-secondary)] font-bold uppercase mb-0.5">{t('shopLabel')}</p>
                                <p className="font-bold text-[var(--text-primary)] leading-tight truncate">{formData.shop || 'Select Shop'}</p>
                                {/* NEW: Staff Name displayed below Shop Name */}
                                <p className="text-xs text-[var(--text-secondary)] font-medium mt-1 truncate flex items-center justify-end gap-1">
                                    <Icon name="user" className="w-3 h-3" />
                                    {formData.staff}
                                </p>
                            </div>
                        </div>
                    </div>

                    {/* Grand Total Hero */}
                    <div className="p-6 bg-gradient-to-b from-[var(--background-secondary)] to-[var(--background-input)]/10 text-center border-b border-[var(--border-color)]">
                        <p className="text-[10px] font-bold text-[var(--text-secondary)] uppercase tracking-[0.2em] mb-3">{t('grandTotalLabel')}</p>
                        <div className="inline-block px-5 py-3 bg-[var(--background-primary)] rounded-xl border border-[var(--border-color)] shadow-inner transform transition-transform hover:scale-105 duration-300">
                            <span className="text-3xl sm:text-4xl font-black font-mono text-[var(--semantic-red)] tracking-tight whitespace-nowrap">
                                {formatCurrency(grandTotal, 'KHR')}
                            </span>
                        </div>
                    </div>

                    {/* Breakdown Section */}
                    <div className="p-5 space-y-4 bg-[var(--background-secondary)]/30">
                        {/* Cash Row */}
                        <div className="flex items-start gap-3">
                            <div className="p-2 rounded-lg bg-emerald-500/10 text-emerald-500 ring-1 ring-emerald-500/20 shrink-0 mt-1">
                                <Icon name="banknotes" className="w-4 h-4" />
                            </div>
                            <div className="flex-1 min-w-0 grid grid-cols-2 gap-2">
                                {/* SWAPPED: KHR first */}
                                <div className="bg-[var(--background-input)]/50 px-3 py-2 rounded-lg border border-[var(--border-color)]/50 hover:bg-[var(--background-input)] transition-colors">
                                    <p className="text-[10px] uppercase text-[var(--text-secondary)] font-bold mb-0.5">KHR</p>
                                    <p className="font-mono text-sm font-bold text-emerald-500">{formatCurrency(formData.cashKhr, 'KHR')}</p>
                                </div>
                                {/* SWAPPED: USD second */}
                                <div className="bg-[var(--background-input)]/50 px-3 py-2 rounded-lg border border-[var(--border-color)]/50 hover:bg-[var(--background-input)] transition-colors">
                                    <p className="text-[10px] uppercase text-[var(--text-secondary)] font-bold mb-0.5">USD</p>
                                    <p className="font-mono text-sm font-bold text-[var(--text-primary)]">{formatCurrency(formData.cashUsd, 'USD')}</p>
                                </div>
                            </div>
                        </div>

                        {/* Bank Row */}
                        <div className="flex items-start gap-3">
                            <div className="p-2 rounded-lg bg-blue-500/10 text-blue-500 ring-1 ring-blue-500/20 shrink-0 mt-1">
                                <Icon name="credit-card" className="w-4 h-4" />
                            </div>
                            <div className="flex-1 min-w-0 grid grid-cols-2 gap-2">
                                {/* SWAPPED: KHR first */}
                                <div className="bg-[var(--background-input)]/50 px-3 py-2 rounded-lg border border-[var(--border-color)]/50 hover:bg-[var(--background-input)] transition-colors">
                                    <p className="text-[10px] uppercase text-[var(--text-secondary)] font-bold mb-0.5">KHR</p>
                                    <p className="font-mono text-sm font-bold text-blue-500">{formatCurrency(formData.bankKhr, 'KHR')}</p>
                                </div>
                                {/* SWAPPED: USD second */}
                                <div className="bg-[var(--background-input)]/50 px-3 py-2 rounded-lg border border-[var(--border-color)]/50 hover:bg-[var(--background-input)] transition-colors">
                                    <p className="text-[10px] uppercase text-[var(--text-secondary)] font-bold mb-0.5">USD</p>
                                    <p className="font-mono text-sm font-bold text-[var(--text-primary)]">{formatCurrency(formData.bankUsd, 'USD')}</p>
                                </div>
                            </div>
                        </div>

                        {/* Exchange (Conditional) */}
                        {(parseCurrency(formData.cashExchangeUsd) > 0 || parseCurrency(formData.cashExchangeKhr) > 0) && (
                             <div className="flex items-center gap-3 pt-3 border-t border-[var(--border-color)] border-dashed">
                                <div className="p-1.5 rounded-md bg-amber-500/10 text-amber-500 ring-1 ring-amber-500/20 shrink-0">
                                    <Icon name="refresh" className="w-3 h-3" />
                                </div>
                                <div className="flex-1 text-xs text-[var(--text-secondary)] flex justify-between items-center">
                                    <span className="font-medium uppercase tracking-wide">Exchanged</span>
                                    <div className="flex gap-2 font-mono text-[var(--text-primary)]">
                                        <span>{formatCurrency(formData.cashExchangeUsd, 'USD')}</span>
                                        <span className="text-[var(--text-secondary)]">/</span>
                                        <span>{formatCurrency(formData.cashExchangeKhr, 'KHR')}</span>
                                    </div>
                                </div>
                             </div>
                        )}
                    </div>

                    {/* Footer/Action */}
                    {children && <div className="p-4 bg-[var(--background-primary)] border-t border-[var(--border-color)]">{children}</div>}
                </div>
            );
        };

        const ReportTable = React.memo(({ reports, totals, onEdit, onDelete, onViewNote, viewType, isLoading }) => {
            const { t } = useTranslation();
            const shopColorMap = useShopColorMap();
            if (isLoading) return <div className="hidden md:block"><table className="w-full"><tbody className="divide-y divide-[var(--border-color)]">{[1,2,3].map(i=><SkeletonRow key={i}/>)}</tbody></table></div>;
            if (reports.length === 0) return <div className="text-center py-16 text-[var(--text-secondary)]"><p>{t('noReportsFound')}</p></div>;
            return (
                <div>
                     {/* Mobile */}
                    <div className="md:hidden space-y-4">
                        {reports.map(r => (
                            <div key={r.id} className={`p-4 rounded-lg border border-[var(--border-color)] shadow-sm ${shopColorMap[r.shop]?.base || 'bg-[var(--background-secondary)]'}`}>
                                <div className="flex justify-between items-start mb-2 border-b border-[var(--border-color)]/30 pb-2"><div><div className="font-bold">{r.shop}</div><div className="text-xs text-[var(--text-secondary)] font-mono">{formatFullDateTime(r.createdAt)}</div></div><div className="text-right"><div className="font-bold text-[var(--accent-color)]">{formatCurrency(r.grandTotalKhr, 'KHR')}</div></div></div>
                                {/* SWAPPED: KHR first, USD second in Mobile View as well */}
                                <div className="grid grid-cols-2 gap-x-4 gap-y-1 text-sm text-[var(--text-secondary)] mb-3"><div className="col-span-2">Staff: <span className="text-[var(--text-primary)]">{r.staff}</span></div><span>Cash ៛: <span className="font-mono text-[var(--text-primary)]">{formatCurrency(r.cashKhr, 'KHR')}</span></span><span className="text-right">Cash $: <span className="font-mono text-[var(--text-primary)]">{formatCurrency(r.cashUsd, 'USD')}</span></span><span>Bank ៛: <span className="font-mono text-[var(--text-primary)]">{formatCurrency(r.bankKhr, 'KHR')}</span></span><span className="text-right">Bank $: <span className="font-mono text-[var(--text-primary)]">{formatCurrency(r.bankUsd, 'USD')}</span></span></div>
                                <div className="flex justify-between items-center pt-2 border-t border-[var(--border-color)]/30"><div>{r.note && <button onClick={() => onViewNote(r.note)} className="text-[var(--semantic-yellow)] text-xs flex items-center gap-1"><Icon name="document-text" className="w-4 h-4"/> Note</button>}</div><div className="flex gap-3"><button onClick={() => onEdit(r)} className="text-[var(--accent-color)]"><Icon name="note" className="w-5 h-5"/></button><button onClick={() => onDelete(r)} className="text-[var(--semantic-red)]"><Icon name="trash" className="w-5 h-5"/></button></div></div>
                            </div>
                        ))}
                    </div>
                    {/* Desktop */}
                    <div className="hidden md:block overflow-x-auto">
                        <table className="w-full text-sm text-left">
                            <thead className="bg-[var(--background-primary)]/50 text-xs text-[var(--text-secondary)] uppercase">
                                <tr>
                                    <th className="p-3">{t('dateTimeHeader')}</th>
                                    <th className="p-3">{t('shopHeader')}</th>
                                    <th className="p-3">{t('staffHeader')}</th>
                                    <th className="p-3 text-right">{t('netSaleHeader')}</th>
                                    {/* SWAPPED: Cash KHR first, Cash USD second */}
                                    <th className="p-3 text-right">{t('cashKhrHeader')}</th>
                                    <th className="p-3 text-right">{t('cashUsdHeader')}</th>
                                    {/* SWAPPED: Bank KHR first, Bank USD second */}
                                    <th className="p-3 text-right">{t('bankKhrHeader')}</th>
                                    <th className="p-3 text-right">{t('bankUsdHeader')}</th>
                                    <th className="p-3 text-center">{t('actionsHeader')}</th>
                                </tr>
                            </thead>
                            <tbody className="divide-y divide-[var(--border-color)]">
                                {reports.map(r => (
                                    <tr key={r.id} className={`${shopColorMap[r.shop]?.base} hover:bg-[var(--border-color)]/50`}>
                                        <td className="p-3 font-mono text-[var(--text-secondary)]">{formatFullDateTime(r.createdAt)}</td>
                                        <td className="p-3">{r.shop}</td>
                                        <td className="p-3">{r.staff}</td>
                                        <td className="p-3 text-right font-bold text-[var(--accent-color)]">{formatCurrency(r.grandTotalKhr, 'KHR')}</td>
                                        {/* SWAPPED Data Cells */}
                                        <td className="p-3 text-right font-mono">{formatCurrency(r.cashKhr, 'KHR')}</td>
                                        <td className="p-3 text-right font-mono">{formatCurrency(r.cashUsd, 'USD')}</td>
                                        <td className="p-3 text-right font-mono">{formatCurrency(r.bankKhr, 'KHR')}</td>
                                        <td className="p-3 text-right font-mono">{formatCurrency(r.bankUsd, 'USD')}</td>
                                        <td className="p-3 flex gap-2 justify-center">{r.note && <button onClick={() => onViewNote(r.note)} className="text-[var(--semantic-yellow)]"><Icon name="document-text"/></button>}<button onClick={() => onEdit(r)} className="text-[var(--accent-color)]"><Icon name="note"/></button><button onClick={() => onDelete(r)} className="text-[var(--semantic-red)]"><Icon name="trash"/></button></td>
                                    </tr>
                                ))}
                            </tbody>
                            <tfoot className="bg-[var(--background-secondary)] font-bold">
                                <tr>
                                    <td colSpan={3} className="p-3 text-right">{t('subTotal')}</td>
                                    <td className="p-3 text-right text-[var(--accent-color)]">{formatCurrency(totals.netSale, 'KHR')}</td>
                                    {/* SWAPPED Footer Cells */}
                                    <td className="p-3 text-right">{formatCurrency(totals.cashKhr, 'KHR')}</td>
                                    <td className="p-3 text-right">{formatCurrency(totals.cashUsd, 'USD')}</td>
                                    <td className="p-3 text-right">{formatCurrency(totals.bankKhr, 'KHR')}</td>
                                    <td className="p-3 text-right">{formatCurrency(totals.bankUsd, 'USD')}</td>
                                    <td/>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
            );
        });

        const AggregatedReportTable = React.memo(({ reports, totals, periodType, isLoading }) => {
            const { t } = useTranslation();
            const shopColorMap = useShopColorMap();
            if (isLoading) return <div className="hidden md:block"><table className="w-full"><tbody className="divide-y divide-[var(--border-color)]">{[1,2].map(i=><SkeletonRow key={i}/>)}</tbody></table></div>;
            if (reports.length === 0) return <div className="text-center py-16 text-[var(--text-secondary)]"><p>{t('noReportsFound')}</p></div>;
            return (
                <div className="overflow-x-auto">
                    <table className="w-full text-sm text-left"><thead className="bg-[var(--background-primary)]/50 text-xs text-[var(--text-secondary)] uppercase"><tr><th className="p-3">{periodType}</th><th className="p-3">{t('shopHeader')}</th><th className="p-3 text-right">{t('netSaleHeader')}</th><th className="p-3 text-right">{t('cashUsdHeader')}</th><th className="p-3 text-right">{t('cashKhrHeader')}</th><th className="p-3 text-right">{t('bankUsdHeader')}</th><th className="p-3 text-right">{t('bankKhrHeader')}</th></tr></thead><tbody className="divide-y divide-[var(--border-color)]">{reports.map(r => (<tr key={`${r.period}-${r.shop}`} className={shopColorMap[r.shop]?.base}><td className="p-3 text-[var(--text-secondary)]">{r.period}</td><td className="p-3">{r.shop}</td><td className="p-3 text-right font-bold text-[var(--accent-color)]">{formatCurrency(r.grandTotalKhr, 'KHR')}</td><td className="p-3 text-right font-mono">{formatCurrency(r.cashUsd, 'USD')}</td><td className="p-3 text-right font-mono">{formatCurrency(r.cashKhr, 'KHR')}</td><td className="p-3 text-right font-mono">{formatCurrency(r.bankUsd, 'USD')}</td><td className="p-3 text-right font-mono">{formatCurrency(r.bankKhr, 'KHR')}</td></tr>))}</tbody><tfoot className="bg-[var(--background-secondary)] font-bold"><tr><td colSpan={2} className="p-3 text-right">{t('subTotal')}</td><td className="p-3 text-right text-[var(--accent-color)]">{formatCurrency(totals.netSale, 'KHR')}</td><td className="p-3 text-right">{formatCurrency(totals.cashUsd, 'USD')}</td><td className="p-3 text-right">{formatCurrency(totals.cashKhr, 'KHR')}</td><td className="p-3 text-right">{formatCurrency(totals.bankUsd, 'USD')}</td><td className="p-3 text-right">{formatCurrency(totals.bankKhr, 'KHR')}</td></tr></tfoot></table>
                </div>
            );
        });

        // --- DASHBOARD CONTAINER ---
        const ReportsDashboard = () => {
            const { reports, appSettings, fetchReportsInRange, resetReportsFetch } = useAppContext();
            const { userData } = useAuth();
            const { t } = useTranslation();
            const availableShops = useAvailableShops();
            const [filters, setFilters] = useState({ shop: '', dueTime: 'Today', startDate: '', endDate: '' });
            const [isSubmitting, setIsSubmitting] = useState(false);
            const [modalState, setModalState] = useState({ edit: null, delete: null, note: null, customDate: false });
            const [historicalData, setHistoricalData] = useState({ yesterday: { netSale: 0, cash: 0, bank: 0 }, lastMonth: { netSale: 0, cash: 0, bank: 0 } });
            const [isDashboardLoading, setIsDashboardLoading] = useState(false);

            useEffect(() => {
                let isActive = true;
                firebaseService.getHistoricalComparison(filters.shop).then(data => { if (isActive) setHistoricalData(data); });
                return () => { isActive = false; };
            }, [filters.shop]);

            useEffect(() => {
                const now = new Date();
                let start, end;
                setIsDashboardLoading(true);
                switch (filters.dueTime) {
                    case 'Today': start = new Date(now.getFullYear(), now.getMonth(), now.getDate()); end = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 23, 59, 59, 999); break;
                    case 'Yesterday': start = new Date(now.getFullYear(), now.getMonth(), now.getDate()-1); end = new Date(now.getFullYear(), now.getMonth(), now.getDate()-1, 23, 59, 59, 999); break;
                    case 'This Month': start = new Date(now.getFullYear(), now.getMonth(), 1); break;
                    case 'Last Month': start = new Date(now.getFullYear(), now.getMonth()-1, 1); end = new Date(now.getFullYear(), now.getMonth(), 0, 23, 59, 59, 999); break;
                    case 'This Year': start = new Date(now.getFullYear(), 0, 1); break;
                    case 'Last Year': start = new Date(now.getFullYear()-1, 0, 1); end = new Date(now.getFullYear()-1, 11, 31, 23, 59, 59, 999); break;
                    case 'Custom': if (filters.startDate && filters.endDate) { start = new Date(filters.startDate + 'T00:00:00'); end = new Date(filters.endDate + 'T23:59:59.999'); } break;
                }
                
                if (start) fetchReportsInRange(start, end || new Date('9999-12-31'));
                else if (filters.dueTime !== 'Custom') resetReportsFetch();
                
                // Simulate loading delay for better UX
                setTimeout(() => setIsDashboardLoading(false), 500);
            }, [filters.dueTime, filters.startDate, filters.endDate]);

            const { filteredAndAggregatedData, totals } = useFilteredReports(reports, filters, userData, availableShops);

            const handleDelete = async () => {
                setIsSubmitting(true);
                await firebaseService.deleteReport(modalState.delete.id);
                setIsSubmitting(false); setModalState(p=>({...p, delete:null}));
            };

            const handleEditSave = async (data) => {
                setIsSubmitting(true);
                const grand = (parseCurrency(data.cashUsd)+parseCurrency(data.bankUsd))*appSettings.exchangeRate + parseCurrency(data.cashKhr)+parseCurrency(data.bankKhr);
                await firebaseService.updateReport(data.id, {...data, grandTotalKhr: grand, cashUsd: parseCurrency(data.cashUsd), cashKhr: parseCurrency(data.cashKhr), bankUsd: parseCurrency(data.bankUsd), bankKhr: parseCurrency(data.bankKhr)});
                setIsSubmitting(false); setModalState(p=>({...p, edit:null}));
            };

            const handleExport = () => {
                if (!filteredAndAggregatedData?.data) return;
                const dataToExport = filteredAndAggregatedData.data.map(row => (filteredAndAggregatedData.type === 'detailed') ? { [t('dateHeader')]: formatDateDDMMYYYY(row.createdAt), [t('shopHeader')]: row.shop, [t('staffHeader')]: row.staff, [t('netSaleHeader')]: row.grandTotalKhr, [t('cashUsdHeader')]: row.cashUsd, [t('cashKhrHeader')]: row.cashKhr, [t('bankUsdHeader')]: row.bankUsd, [t('bankKhrHeader')]: row.bankKhr, [t('cashExchUsdHeader')]: row.cashExchangeUsd, [t('cashExchKhrHeader')]: row.cashExchangeKhr, [t('shiftHeader')]: row.shift } : { [filters.dueTime]: row.period, [t('shopHeader')]: row.shop, [t('netSaleHeader')]: row.grandTotalKhr, [t('cashUsdHeader')]: row.cashUsd, [t('cashKhrHeader')]: row.cashKhr, [t('bankUsdHeader')]: row.bankUsd, [t('bankKhrHeader')]: row.bankKhr, [t('cashExchUsdHeader')]: row.cashExchangeUsd, [t('cashExchKhrHeader')]: row.cashExchangeKhr });
                const worksheet = XLSX.utils.json_to_sheet(dataToExport);
                const workbook = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(workbook, worksheet, "Cash Drop Report");
                XLSX.writeFile(workbook, `Cash_Drop_Report_${new Date().toISOString().split('T')[0]}.xlsx`);
            };

            // Simplified Inner Edit Modal Component
            const EditReportModalInner = ({ isOpen, onClose, onSave, report }) => {
                const [d, setD] = useState({});
                useEffect(() => { if(report) setD({...report, date: report.createdAt.toISOString().split('T')[0], cashUsd:String(report.cashUsd), cashKhr:String(report.cashKhr), bankUsd:String(report.bankUsd), bankKhr:String(report.bankKhr)}); }, [report]);
                return (
                    <Modal isOpen={isOpen} onClose={onClose}>
                        <ModalHeader>{t('editReportTitle')}</ModalHeader>
                        <form onSubmit={e=>{e.preventDefault(); onSave(d);}} className="flex flex-col min-h-0">
                            <ModalBody className="space-y-4">
                                <FormInput label={t('dateLabel')} type="date" value={d.date} onChange={e=>setD({...d, date:e.target.value})} />
                                <CurrencyInputs khrName="cashKhr" usdName="cashUsd" khrValue={d.cashKhr} usdValue={d.cashUsd} onChange={e=>setD({...d, [e.target.name]:e.target.value})} />
                                <CurrencyInputs khrName="bankKhr" usdName="bankUsd" khrValue={d.bankKhr} usdValue={d.bankUsd} onChange={e=>setD({...d, [e.target.name]:e.target.value})} />
                            </ModalBody>
                            <ModalFooter><button type="submit" disabled={isSubmitting} className="px-4 py-2 bg-[var(--accent-color)] text-white rounded">{t('saveChangesButton')}</button></ModalFooter>
                        </form>
                    </Modal>
                );
            };

            return (
                <div className="bg-[var(--background-secondary)]/50 border border-[var(--border-color)] p-4 sm:p-6 rounded-lg shadow-lg mt-8">
                    <div className="flex flex-col sm:flex-row justify-between items-center mb-4 gap-4">
                        <h2 className="text-xl font-semibold text-[var(--text-primary)]">{t('historyTitle')}</h2>
                        <button onClick={handleExport} className="p-2 bg-[var(--semantic-green)] hover:bg-[var(--semantic-green-hover)] text-white rounded-lg transition-colors shadow-sm" title={t('exportButton')}>
                            <Icon name="export" className="w-5 h-5" />
                        </button>
                    </div>
                    
                    <StatsCards totals={totals} historical={historicalData} />
                    <ReportFilters filters={filters} setFilters={setFilters} shops={availableShops} onCustomClick={() => setModalState(p => ({ ...p, customDate: true }))} />
                    
                    {filteredAndAggregatedData?.type === 'detailed' ? 
                        <ReportTable reports={filteredAndAggregatedData.data} totals={totals} onEdit={(r)=>setModalState(p=>({...p,edit:r}))} onDelete={(r)=>setModalState(p=>({...p,delete:r}))} onViewNote={(n)=>setModalState(p=>({...p,note:n}))} viewType={filters.dueTime} isLoading={isDashboardLoading} /> : 
                        <AggregatedReportTable reports={filteredAndAggregatedData?.data || []} totals={totals} periodType={filters.dueTime} isLoading={isDashboardLoading} />
                    }

                    <ConfirmationModal isOpen={!!modalState.delete} onClose={()=>setModalState(p=>({...p, delete:null}))} onConfirm={handleDelete} title={t('confirmDeletionTitle')} message={t('confirmDeletionMessage')} confirmText={t('deleteButton')} confirmColor="red" isSubmitting={isSubmitting} />
                    <EditReportModalInner isOpen={!!modalState.edit} onClose={()=>setModalState(p=>({...p, edit:null}))} onSave={handleEditSave} report={modalState.edit} />
                    {modalState.note && <Modal isOpen={true} onClose={()=>setModalState(p=>({...p, note:null}))}><ModalHeader>{t('reportNoteTitle')}</ModalHeader><ModalBody><p>{modalState.note}</p></ModalBody><ModalFooter><button onClick={()=>setModalState(p=>({...p, note:null}))} className="px-4 py-2 bg-[var(--accent-color)] text-white rounded">{t('closeButton')}</button></ModalFooter></Modal>}
                    {modalState.customDate && <Modal isOpen={true} onClose={()=>setModalState(p=>({...p, customDate:false}))}><ModalHeader>{t('customDateTitle')}</ModalHeader><ModalBody className="space-y-4"><FormInput label={t('startDateLabel')} type="date" value={filters.startDate} onChange={e=>setFilters(p=>({...p, startDate:e.target.value}))}/><FormInput label={t('endDateLabel')} type="date" value={filters.endDate} onChange={e=>setFilters(p=>({...p, endDate:e.target.value}))}/></ModalBody><ModalFooter><button onClick={()=>setModalState(p=>({...p, customDate:false}))} className="px-4 py-2 bg-[var(--accent-color)] text-white rounded">{t('applyButton')}</button></ModalFooter></Modal>}
                </div>
            );
        };

        const DailyOperationExpenseTab = () => {
                const { businessExpenses, shops, businessCategories, fetchExpensesInRange, resetExpensesFetch, isLoading: isAppLoading } = useAppContext();
                const { userData } = useAuth();
                const { t } = useTranslation();
                const { showToast } = useToast();
                const [isModalOpen, setIsModalOpen] = useState(false);
                const [expenseToEdit, setExpenseToEdit] = useState(null);
                const [expenseToDelete, setExpenseToDelete] = useState(null);
                const [filters, setFilters] = useState({ month: new Date().toISOString().slice(0, 7), shop: '', search: '' });
                const [isFilterLoading, setIsFilterLoading] = useState(false);

                useEffect(() => {
                    setIsFilterLoading(true);
                    if (filters.month) {
                        const [y, m] = filters.month.split('-');
                        fetchExpensesInRange(new Date(y, m-1, 1), new Date(y, m, 0, 23, 59, 59, 999));
                    } else resetExpensesFetch();
                    setTimeout(() => setIsFilterLoading(false), 800);
                }, [filters.month]);

                const availableShops = useMemo(() => {
                    if (!userData) return [];
                    // UPDATED: Restricted SHOP_MANAGER to see only assigned shops
                    if ([ROLES.ADMIN].includes(userData.role)) return shops;
                    return shops.filter(s => userData.shopIds?.includes(s.id));
                }, [shops, userData]);

                const expenseList = useMemo(() => {
                    if (!userData) return [];
                    // UPDATED: Restricted SHOP_MANAGER to see only expenses from assigned shops
                    const userShops = [ROLES.ADMIN].includes(userData.role) ? null : availableShops.map(s => s.name);
                    return businessExpenses.filter(e => {
                        if (e.type !== 'Business') return false;
                        if (filters.month && e.date.toISOString().slice(0, 7) !== filters.month) return false;
                        if (filters.shop && e.shop !== filters.shop) return false;
                        if (userShops && !userShops.includes(e.shop)) return false;
                        if (filters.search) { const term = filters.search.toLowerCase(); if (!e.itemName?.toLowerCase().includes(term) && !e.note?.toLowerCase().includes(term)) return false; }
                        return true;
                    }).sort((a,b) => b.date - a.date);
                }, [businessExpenses, userData, shops, filters, availableShops]);

                const shopExpenseTotals = useMemo(() => {
                    return expenseList.reduce((acc, item) => {
                        acc[item.shop] = (acc[item.shop] || 0) + (item.amountKhr || item.totalAmountKhr || 0);
                        return acc;
                    }, {});
                }, [expenseList]);

                // NEW: Helper to get color styles based on index
                const getShopStyle = (index) => {
                    const styles = [
                        { border: 'border-blue-500/30', bg: 'bg-blue-500/5 hover:bg-blue-500/10', iconBg: 'bg-blue-500/20', iconText: 'text-blue-500', title: 'text-blue-400' },
                        { border: 'border-emerald-500/30', bg: 'bg-emerald-500/5 hover:bg-emerald-500/10', iconBg: 'bg-emerald-500/20', iconText: 'text-emerald-500', title: 'text-emerald-400' },
                        { border: 'border-amber-500/30', bg: 'bg-amber-500/5 hover:bg-amber-500/10', iconBg: 'bg-amber-500/20', iconText: 'text-amber-500', title: 'text-amber-400' },
                        { border: 'border-rose-500/30', bg: 'bg-rose-500/5 hover:bg-rose-500/10', iconBg: 'bg-rose-500/20', iconText: 'text-rose-500', title: 'text-rose-400' },
                        { border: 'border-violet-500/30', bg: 'bg-violet-500/5 hover:bg-violet-500/10', iconBg: 'bg-violet-500/20', iconText: 'text-violet-500', title: 'text-violet-400' },
                        { border: 'border-cyan-500/30', bg: 'bg-cyan-500/5 hover:bg-cyan-500/10', iconBg: 'bg-cyan-500/20', iconText: 'text-cyan-500', title: 'text-cyan-400' },
                    ];
                    return styles[index % styles.length];
                };

                const handleSubmit = async (e, formData) => {
                    e.preventDefault();
                    try {
                        const qty = parseFloat(formData.qty)||1;
                        const price = parseFloat(formData.price.replace(/,/g, ''))||0;
                        const total = qty * price;
                        const data = { date: createTimestampFromDateAndCurrentTime(formData.date), shop: formData.shop, itemName: formData.itemName, category: formData.category, qty, price, amountKhr: total, totalAmountKhr: total, amountUsd: 0, note: formData.note, type: 'Business' };
                        if (expenseToEdit) { await firebaseService.updateExpense(expenseToEdit.id, data); showToast(t('expenseUpdateSuccess')); }
                        else { await firebaseService.addExpense({ ...data, submittedBy: userData.uid, recordedBy: userData.name, createdAt: firebaseService.getTimestamp().now() }); showToast(t('expenseSuccess')); }
                        setIsModalOpen(false);
                    } catch(err) { console.error(err); showToast('Error', 'error'); }
                };

                const DailyExpenseModal = ({ isOpen, onClose, expenseToEdit }) => {
                    const [formData, setFormData] = useState({ date: new Date().toISOString().split('T')[0], shop: availableShops[0]?.name||'', itemName: '', category: 'Shop Monthly', qty: '1', price: '', note: '' });
                    useEffect(() => { if (expenseToEdit) setFormData({ ...expenseToEdit, date: expenseToEdit.date?new Date(expenseToEdit.date).toISOString().split('T')[0]:'', qty: String(expenseToEdit.qty||1), price: formatInputAsCurrency(String(expenseToEdit.price||'')) }); }, [expenseToEdit]);
                    const handleChange = (e) => setFormData(prev => ({ ...prev, [e.target.name]: e.target.value }));
                    return (
                        <Modal isOpen={isOpen} onClose={onClose}>
                            <ModalHeader>{expenseToEdit ? t('editExpenseButton') : t('addExpenseButton')}</ModalHeader>
                            <form onSubmit={(e) => handleSubmit(e, formData)} className="flex flex-col min-h-0">
                                <ModalBody className="space-y-4">
                                    <div className="grid grid-cols-2 gap-4"><FormInput label={t('dateLabel')} type="date" name="date" value={formData.date} onChange={handleChange} required /><FormSelect label={t('shopLabel')} name="shop" value={formData.shop} onChange={handleChange} options={availableShops.map(s => ({value: s.name, label: s.name}))} required /></div>
                                    <div className="grid grid-cols-2 gap-4"><FormInput label={t('itemNameLabel')} name="itemName" value={formData.itemName} onChange={handleChange} required /><FormSelect label={t('categoryLabel')} name="category" value={formData.category} onChange={handleChange} options={businessCategories.map(c => ({value: c.name, label: c.name}))} required /></div>
                                    <div className="grid grid-cols-3 gap-4 bg-[var(--background-primary)] p-3 rounded-lg"><FormInput label={t('quantityLabel')} type="number" name="qty" value={formData.qty} onChange={handleChange} required /><SmartCurrencyInput label={`${t('priceLabel')} (៛)`} name="price" value={formData.price} onChange={handleChange} required /><div className="flex flex-col justify-end"><span className="text-sm mb-1">{t('totalLabel')}</span><div className="h-[42px] flex items-center px-3 font-bold font-mono text-[var(--semantic-green)] bg-[var(--background-input)] rounded border border-[var(--border-color)]">{formatCurrency((parseFloat(formData.qty)||0)*(parseFloat(formData.price.replace(/,/g,''))||0), 'KHR')}</div></div></div>
                                    <FormTextarea label={t('noteLabel')} name="note" value={formData.note} onChange={handleChange} />
                                </ModalBody>
                                <ModalFooter><button type="button" onClick={onClose} className="px-4 py-2 text-sm bg-[var(--background-input)] rounded-md">{t('cancelButton')}</button><button type="submit" className="px-4 py-2 text-sm text-white bg-[var(--accent-color)] rounded-md">{expenseToEdit?t('saveChangesButton'):t('addExpenseButton')}</button></ModalFooter>
                            </form>
                        </Modal>
                    );
                };

                if (isAppLoading || isFilterLoading) return (
                    <div className="space-y-6">
                        <div className="h-16 w-full bg-[var(--background-secondary)] rounded-lg animate-pulse"></div>
                        <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                             {[1,2,3,4].map(i => <div key={i} className="h-32 bg-[var(--background-secondary)] rounded-lg animate-pulse"></div>)}
                        </div>
                        <div className="bg-[var(--background-secondary)]/50 border border-[var(--border-color)] rounded-lg overflow-hidden">
                            <table className="w-full">
                                <tbody className="divide-y divide-[var(--border-color)]">{[1, 2, 3, 4, 5].map(i => <SkeletonRow key={i} />)}</tbody>
                            </table>
                        </div>
                    </div>
                );

                return (
                    <div className="space-y-6">
                        {/* REDESIGNED HEADER: Title with Logo + Total Expense Card */}
                        <div className="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-6 border-b border-[var(--border-color)] pb-4">
                            
                            {/* NEW: Title Section with Gradient Logo */}
                            <div className="flex items-center gap-4">
                                <div className="bg-gradient-to-br from-rose-500 to-orange-400 p-3 rounded-2xl shadow-lg shadow-rose-500/20 text-white transform hover:rotate-6 transition-transform duration-300">
                                    <Icon name="document-text" className="w-6 h-6" />
                                </div>
                                <div>
                                    <h3 className="text-xl font-bold text-[var(--text-primary)] tracking-tight leading-tight">{t('expenseHeader')}</h3>
                                    <p className="text-xs text-[var(--text-secondary)] font-medium mt-0.5">Track & Manage Costs</p>
                                </div>
                            </div>
                            
                            {/* Total Expense Card (Aligned Right on Desktop, Full Width on Mobile) */}
                            <div className="w-full md:w-auto bg-[var(--background-secondary)] border border-rose-500/30 bg-rose-500/5 px-5 py-3 rounded-xl flex items-center justify-between gap-6 shadow-sm hover:shadow-rose-900/10 transition-all duration-300 group">
                                <div className="flex items-center gap-3">
                                    <div className="p-2 rounded-lg bg-rose-500/10 text-rose-500 ring-1 ring-rose-500/20 group-hover:scale-110 transition-transform">
                                         <Icon name="banknotes" className="w-5 h-5" />
                                    </div>
                                    <p className="text-[10px] font-bold text-rose-500 uppercase tracking-widest leading-none">{t('totalExpenseLabel')}</p>
                                </div>
                                <p className="text-xl sm:text-2xl font-black font-mono text-[var(--text-primary)] leading-none whitespace-nowrap">
                                    {formatCurrency(expenseList.reduce((s,i)=>s+(i.amountKhr||i.totalAmountKhr||0),0), 'KHR')}
                                </p>
                            </div>
                        </div>

                        {/* Shop Expense Cards */}
                        <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                            {availableShops.map((shop, index) => {
                                if (filters.shop && filters.shop !== shop.name) return null;
                                const total = shopExpenseTotals[shop.name] || 0;
                                
                                // UPDATED: Hide shop card if total amount is 0
                                if (total === 0) return null;

                                const style = getShopStyle(index);
                                return (
                                    <div key={shop.id} className={`p-4 rounded-xl border ${style.border} ${style.bg} relative overflow-hidden group transition-all duration-300 hover:shadow-lg flex flex-col justify-between`}>
                                        <div className="flex items-center gap-4 relative z-10">
                                            <div className={`p-3 rounded-full ${style.iconBg} ${style.iconText} shadow-sm group-hover:scale-110 transition-transform shrink-0`}>
                                                <Icon name="store" className="w-6 h-6" />
                                            </div>
                                            <div className="flex-1 min-w-0">
                                                <h4 className={`text-sm font-bold uppercase tracking-wide mb-1 truncate ${style.title}`}>{shop.name}</h4>
                                                {/* UPDATED: Added whitespace-nowrap to prevent currency wrapping */}
                                                <p className="text-lg md:text-xl font-black font-mono text-[var(--text-primary)] whitespace-nowrap">{formatCurrency(total, 'KHR')}</p>
                                            </div>
                                        </div>
                                        <div className={`absolute -right-6 -bottom-6 opacity-5 ${style.iconText} transform rotate-12 group-hover:rotate-0 group-hover:scale-110 transition-all duration-500 pointer-events-none`}>
                                            <Icon name="store" className="w-24 h-24" />
                                        </div>
                                    </div>
                                );
                            })}
                        </div>

                        <CollapsibleFilterSection summary={`${filters.month} • ${filters.shop||t('allShops')}`}>
                            <div className="grid grid-cols-1 md:grid-cols-12 gap-4 items-end bg-[var(--background-secondary)]/30 p-4 rounded-lg">
                                <div className="md:col-span-3"><FormInput label={t('dueTimeLabel')} type="month" value={filters.month} onChange={e=>setFilters(p=>({...p,month:e.target.value}))}/></div>
                                <div className="md:col-span-3"><FormSelect label={t('shopLabel')} value={filters.shop} onChange={e=>setFilters(p=>({...p,shop:e.target.value}))} options={[{value:'',label:t('allShops')},...availableShops.map(s=>({value:s.name,label:s.name}))]}/></div>
                                <div className="md:col-span-4"><FormInput label="Search" placeholder="Search..." value={filters.search} onChange={e=>setFilters(p=>({...p,search:e.target.value}))}/></div>
                                <div className="md:col-span-2 hidden md:block"><button onClick={()=>{setExpenseToEdit(null);setIsModalOpen(true);}} className="w-full bg-[var(--accent-color)] text-white font-bold py-2.5 px-4 rounded-lg flex items-center justify-center gap-2"><Icon name="plus"/>{t('addExpenseButton')}</button></div>
                            </div>
                        </CollapsibleFilterSection>
                        
                        {/* UPDATED: Mobile Card View for Expenses */}
                        <div className="md:hidden space-y-4">
                            {expenseList.map(item => (
                                <div key={item.id} className="p-4 rounded-lg border border-[var(--border-color)] bg-[var(--background-secondary)] shadow-sm">
                                    <div className="flex justify-between items-start mb-2 border-b border-[var(--border-color)]/30 pb-2">
                                        <div>
                                            <div className="font-bold text-[var(--text-primary)]">{item.shop}</div>
                                            <div className="text-xs text-[var(--text-secondary)] font-mono">{formatExpenseDateTime(item.date)}</div>
                                        </div>
                                        <div className="text-right">
                                            <div className="font-bold text-[var(--semantic-red)] font-mono whitespace-nowrap">{formatCurrency(item.amountKhr, 'KHR')}</div>
                                        </div>
                                    </div>
                                    <div className="mb-3 space-y-2">
                                        <div className="flex justify-between items-start gap-2">
                                            <span className="font-medium text-sm text-[var(--text-primary)]">{item.itemName}</span>
                                            <span className="text-[10px] bg-[var(--background-input)] px-2 py-0.5 rounded text-[var(--text-secondary)] whitespace-nowrap border border-[var(--border-color)]">{item.category}</span>
                                        </div>
                                        <div className="grid grid-cols-2 gap-2 text-xs text-[var(--text-secondary)] bg-[var(--background-input)]/20 p-2 rounded">
                                            <div>{t('quantityLabel')}: <span className="font-mono text-[var(--text-primary)]">{item.qty || 1}</span></div>
                                            <div className="text-right">{t('priceLabel')}: <span className="font-mono text-[var(--text-primary)] whitespace-nowrap">{formatCurrency(item.price || 0, 'KHR')}</span></div>
                                        </div>
                                        {item.note && <div className="text-xs text-[var(--text-secondary)] italic flex items-start gap-1"><Icon name="document-text" className="w-3 h-3 mt-0.5" /> {item.note}</div>}
                                    </div>
                                    <div className="flex justify-end gap-4 pt-2 border-t border-[var(--border-color)]/30">
                                        <button onClick={()=>{setExpenseToEdit(item);setIsModalOpen(true);}} className="text-[var(--accent-color)]"><Icon name="note" className="w-5 h-5"/></button>
                                        <button onClick={()=>setExpenseToDelete(item)} className="text-[var(--semantic-red)]"><Icon name="trash" className="w-5 h-5"/></button>
                                    </div>
                                </div>
                            ))}
                        </div>

                        {/* Desktop Table View */}
                        <div className="hidden md:block bg-[var(--background-secondary)]/50 border border-[var(--border-color)] rounded-lg overflow-x-auto">
                            <table className="w-full text-sm text-left">
                                <thead className="bg-[var(--background-primary)]/50 text-xs uppercase">
                                    <tr>
                                        <th className="p-3">{t('dateTimeHeader')}</th>
                                        <th className="p-3">{t('shopLabel')}</th>
                                        <th className="p-3">{t('itemNameLabel')}</th>
                                        <th className="p-3">{t('categoryLabel')}</th>
                                        <th className="p-3 text-right">{t('quantityLabel')}</th>
                                        <th className="p-3 text-right">{t('priceLabel')} (៛)</th>
                                        <th className="p-3 text-right">{t('totalLabel')} (៛)</th>
                                        <th className="p-3 text-center">{t('actionsHeader')}</th>
                                    </tr>
                                </thead>
                                <tbody className="divide-y divide-[var(--border-color)]">
                                    {expenseList.map(item=>(
                                        <tr key={item.id} className="hover:bg-[var(--border-color)]/30">
                                            <td className="p-3 font-mono text-[var(--text-secondary)] whitespace-nowrap">{formatExpenseDateTime(item.date)}</td>
                                            <td className="p-3">{item.shop}</td>
                                            <td className="p-3 font-medium">{item.itemName}</td>
                                            <td className="p-3"><span className="bg-[var(--background-input)] px-2 py-1 rounded text-xs">{item.category}</span></td>
                                            <td className="p-3 text-right font-mono">{item.qty || 1}</td>
                                            <td className="p-3 text-right font-mono whitespace-nowrap">{formatCurrency(item.price || 0, 'KHR')}</td>
                                            <td className="p-3 text-right font-bold text-[var(--semantic-red)] font-mono whitespace-nowrap">{formatCurrency(item.amountKhr, 'KHR')}</td>
                                            <td className="p-3 flex justify-center gap-2">
                                                <button onClick={()=>{setExpenseToEdit(item);setIsModalOpen(true);}} className="text-[var(--accent-color)]"><Icon name="note"/></button>
                                                <button onClick={()=>setExpenseToDelete(item)} className="text-[var(--semantic-red)]"><Icon name="trash"/></button>
                                            </td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                        <DailyExpenseModal isOpen={isModalOpen} onClose={()=>setIsModalOpen(false)} expenseToEdit={expenseToEdit} />
                        {expenseToDelete && <ConfirmationModal isOpen={!!expenseToDelete} onClose={()=>setExpenseToDelete(null)} onConfirm={async()=>{try{await firebaseService.deleteExpense(expenseToDelete.id);showToast(t('expenseDeleteSuccess'));setExpenseToDelete(null);}catch(e){showToast('Error','error');}}} isSubmitting={false} title={t('confirmDeletionTitle')} message={t('confirmExpenseDelete')} confirmText={t('deleteButton')} confirmColor="red"/>}
                        <FloatingActionButton onClick={()=>{setExpenseToEdit(null);setIsModalOpen(true);}}/>
                    </div>
                );
            };

        const NewCashDropForm = () => {
            const { appSettings } = useAppContext();
            const { userData } = useAuth();
            const { t } = useTranslation();
            const availableShops = useAvailableShops();
            const getInitialState = useCallback(() => ({ date: new Date().toISOString().split('T')[0], shop: availableShops[0]?.name||'', staff: userData?.name||'', shift: 'AM', cashUsd: '', cashKhr: '', bankUsd: '', bankKhr: '', cashExchangeKhr: '', cashExchangeUsd: '', note: '' }), [availableShops, userData]);
            const [formData, setFormData] = useState(getInitialState);
            const [isSubmitting, setIsSubmitting] = useState(false);
            const [isConfirming, setIsConfirming] = useState(false);
            const [lastSubmitted, setLastSubmitted] = useState(null);
            
            useEffect(() => { setFormData(getInitialState()) }, [getInitialState]);
            const handleFormChange = (e) => { const { name, value } = e.target; setFormData(prev => ({ ...prev, [name]: value })); };
            const grandTotal = useMemo(() => (parseCurrency(formData.cashUsd) + parseCurrency(formData.bankUsd)) * appSettings.exchangeRate + parseCurrency(formData.cashKhr) + parseCurrency(formData.bankKhr), [formData, appSettings.exchangeRate]);
            
            const handleConfirmSubmit = async () => {
                setIsConfirming(false); setIsSubmitting(true);
                try {
                    const submissionTimestamp = createTimestampFromDateAndCurrentTime(formData.date);
                    await firebaseService.addReport({ ...formData, cashUsd: parseCurrency(formData.cashUsd), cashKhr: parseCurrency(formData.cashKhr), bankUsd: parseCurrency(formData.bankUsd), bankKhr: parseCurrency(formData.bankKhr), cashExchangeKhr: parseCurrency(formData.cashExchangeKhr), cashExchangeUsd: parseCurrency(formData.cashExchangeUsd), grandTotalKhr: grandTotal, createdAt: submissionTimestamp, submittedBy: userData.uid });
                    setLastSubmitted({ formData, grandTotal, submittedAt: submissionTimestamp.toDate() });
                } catch (error) { console.error(error); } finally { setIsSubmitting(false); }
            };

            // REMOVED: Duplicate SummaryContent definition here to fix the shadowing issue.
            // The form now uses the correct global SummaryContent defined above.

            return (
                <>
                    <form onSubmit={(e) => { e.preventDefault(); setIsConfirming(true); }} className="grid grid-cols-1 lg:grid-cols-3 gap-6 items-start">
                        <div className="lg:col-span-2 space-y-4 md:space-y-6">
                            {/* UPDATED: Applied Color Themes to CategoryCards */}
                            <CategoryCard title={t('newFormTitle')} icon="document-text" theme="blue">
                                {/* UPDATED: Changed grid-cols-1 to grid-cols-2 for mobile view */}
                                <div className="grid grid-cols-2 md:grid-cols-2 gap-2 md:gap-6">
                                    <FormSelect label={t('shopLabel')} name="shop" value={formData.shop} onChange={handleFormChange} options={availableShops.map(s => ({value: s.name, label: s.name}))} required icon="store" />
                                    <FormInput label={t('dateLabel')} type="date" name="date" value={formData.date} onChange={handleFormChange} required icon="calendar" />
                                    {/* Swapped Shift and Staff positions */}
                                    <FormSelect label={t('shiftLabel')} name="shift" value={formData.shift} onChange={handleFormChange} options={[{value:'AM', label:'AM'}, {value:'PM', label:'PM'}]} icon="clock" />
                                    <FormInput label={t('staffLabel')} name="staff" value={formData.staff} disabled icon="user" />
                                </div>
                            </CategoryCard>
                            
                            {/* UPDATED: grid-cols-2 to force side-by-side display on mobile, reduced gap */}
                            <div className="grid grid-cols-2 gap-2 md:gap-6">
                                <CategoryCard title={t('byCashTitle')} icon="banknotes" theme="emerald">
                                    <CurrencyInputs khrName="cashKhr" usdName="cashUsd" khrValue={formData.cashKhr} usdValue={formData.cashUsd} onChange={handleFormChange} />
                                </CategoryCard>
                                <CategoryCard title={t('byBankTitle')} icon="credit-card" theme="cyan">
                                    <CurrencyInputs khrName="bankKhr" usdName="bankUsd" khrValue={formData.bankKhr} usdValue={formData.bankUsd} onChange={handleFormChange} />
                                </CategoryCard>
                            </div>
                            
                            {/* UPDATED: Now also grid-cols-2 on mobile for Cash Exchange and Note */}
                            <div className="grid grid-cols-2 gap-2 md:gap-6">
                                <CategoryCard title={t('cashExchangeTitle')} icon="refresh" theme="amber">
                                    <CurrencyInputs khrName="cashExchangeKhr" usdName="cashExchangeUsd" khrValue={formData.cashExchangeKhr} usdValue={formData.cashExchangeUsd} onChange={handleFormChange} />
                                </CategoryCard>
                                <CategoryCard title={t('noteLabel')} icon="note" className="h-full" theme="violet">
                                    <FormTextarea label="Note" name="note" value={formData.note} onChange={handleFormChange} placeholder="..." icon="document-text" className="h-full resize-none" rows={3} />
                                </CategoryCard>
                            </div>
                        </div>
                        
                        <div className="lg:col-span-1">
                            {/* UPDATED: Pass formData, grandTotal, and Button as children */}
                            <SummaryContent formData={formData} grandTotal={grandTotal}>
                                <button type="submit" disabled={isSubmitting} className="w-full bg-[var(--accent-color)] hover:bg-[var(--accent-color-hover)] text-white font-bold py-3 px-4 rounded-lg flex items-center justify-center shadow-lg transition-transform active:scale-95">
                                    {isSubmitting ? <Icon name="loader" /> : t('submitReportButton')}
                                </button>
                            </SummaryContent>
                        </div>
                    </form>
                    {isConfirming && <ConfirmationModal isOpen={isConfirming} onClose={() => setIsConfirming(false)} onConfirm={handleConfirmSubmit} isSubmitting={isSubmitting} title={t('confirmSubmissionTitle')} message={t('confirmSubmissionMessage')} confirmText={t('confirmButton')} />}
                    
                    {/* UPDATED: Success Modal - Removed instruction text */}
                    {lastSubmitted && (
                        <Modal isOpen={!!lastSubmitted} onClose={()=>{setLastSubmitted(null);setFormData(getInitialState());}}>
                            <ModalHeader>{t('submissionSuccessTitle')}</ModalHeader>
                            <ModalBody>
                                <SummaryContent formData={lastSubmitted.formData} grandTotal={lastSubmitted.grandTotal} submittedAt={lastSubmitted.submittedAt} />
                            </ModalBody>
                            <ModalFooter>
                                <button onClick={()=>{setLastSubmitted(null);setFormData(getInitialState());}} className="w-full bg-[var(--accent-color)] text-white py-2 rounded-md">{t('closeButton')}</button>
                            </ModalFooter>
                        </Modal>
                    )}
                </>
            );
        };

        const CashDropPage = () => {
            const { userData } = useAuth();
            const { isLoading } = useAppContext();
            const { t } = useTranslation();
            const [activeTab, setActiveTab] = useState('cashDrop');
            if (isLoading || !userData) return <LoadingSpinner />;
            
            // UPDATED: Removed ROLES.MANAGEMENT, kept ROLES.SHOP_MANAGER
            const canViewDashboard = [ROLES.ADMIN, ROLES.SHOP_MANAGER].includes(userData.role);

            return (
                <div className="space-y-6">
                    <div className="flex gap-4 p-1 bg-[var(--background-secondary)]/50 rounded-xl border border-[var(--border-color)] w-fit mx-auto sm:mx-0">
                        <button onClick={()=>setActiveTab('cashDrop')} className={`px-6 py-2.5 text-sm font-bold rounded-lg transition-all ${activeTab==='cashDrop' ? 'bg-[var(--accent-color)] text-white shadow-lg' : 'text-[var(--text-secondary)] hover:text-[var(--text-primary)]'}`}>{t('tabs.cashDrop')}</button>
                        <button onClick={()=>setActiveTab('expenses')} className={`px-6 py-2.5 text-sm font-bold rounded-lg transition-all ${activeTab==='expenses' ? 'bg-[var(--accent-color)] text-white shadow-lg' : 'text-[var(--text-secondary)] hover:text-[var(--text-primary)]'}`}>{t('tabs.expenses')}</button>
                    </div>
                    {activeTab === 'cashDrop' ? <div className="space-y-8 animate-in fade-in slide-in-from-bottom-4 duration-500"><NewCashDropForm />{canViewDashboard && <ReportsDashboard />}</div> : <div className="animate-in fade-in slide-in-from-bottom-4 duration-500"><DailyOperationExpenseTab /></div>}
                </div>
            );
        };

        const AppHeader = () => {
            const { userData, logout } = useAuth();
            const { t, locale, setLocale } = useTranslation();

            // NEW: Live Clock Component
            const LiveClock = ({ mobile = false }) => {
                const [time, setTime] = useState(new Date());
                useEffect(() => {
                    const timer = setInterval(() => setTime(new Date()), 1000);
                    return () => clearInterval(timer);
                }, []);
                
                if (mobile) {
                    return (
                        <div className="text-[10px] font-mono font-bold text-[var(--text-secondary)] bg-[var(--background-input)]/30 px-2 py-1 rounded border border-[var(--border-color)]/30 flex items-center gap-1">
                            <Icon name="clock" className="w-3 h-3" />
                            {time.toLocaleTimeString('en-US', { hour12: true, hour: 'numeric', minute:'2-digit' })}
                        </div>
                    );
                }

                return (
                    <div className="flex flex-col items-end mr-6 px-6 py-0.5 border-r border-[var(--border-color)]/50 min-w-[140px]">
                        <span className="text-lg font-black font-mono leading-none tracking-wider text-[var(--text-primary)]">
                            {time.toLocaleTimeString('en-US', { hour12: false, hour: '2-digit', minute:'2-digit' })}
                            <span className="text-xs text-[var(--accent-color)] ml-0.5">{time.getSeconds().toString().padStart(2,'0')}</span>
                        </span>
                        <span className="text-[10px] text-[var(--text-secondary)] font-bold uppercase tracking-widest mt-0.5">
                            {time.toLocaleDateString('en-GB', { weekday: 'short', day: 'numeric', month: 'short' })}
                        </span>
                    </div>
                );
            };
            
            return (
                <header className="bg-[var(--background-secondary)] border border-[var(--border-color)] p-4 md:p-5 rounded-2xl shadow-sm mb-6 transition-all duration-300">
                    {/* --- DESKTOP VIEW (Hidden on Mobile) --- */}
                    <div className="hidden md:flex justify-between items-center">
                        <div className="flex items-center gap-4">
                            {/* Logo Box */}
                            <div className="bg-gradient-to-br from-[var(--accent-color)] to-blue-600 p-3 rounded-xl shadow-lg shadow-blue-500/20 text-white transform hover:scale-105 transition-transform duration-300">
                                <Icon name="landmark" className="w-6 h-6" />
                            </div>
                            <div>
                                <h1 className="text-xl font-bold leading-none tracking-tight">{t('headerTitle')}</h1>
                                <div className="flex items-center gap-2 mt-1.5">
                                    <span className="relative flex h-2 w-2">
                                      <span className="animate-ping absolute inline-flex h-full w-full rounded-full bg-emerald-400 opacity-75"></span>
                                      <span className="relative inline-flex rounded-full h-2 w-2 bg-emerald-500"></span>
                                    </span>
                                    <p className="text-xs text-[var(--text-secondary)] font-medium">{t('welcomeMessage', { name: userData.name, role: userData.role })}</p>
                                </div>
                            </div>
                        </div>
                        
                        <div className="flex items-center">
                             {/* NEW: Desktop Live Clock */}
                             <div className="hidden lg:block">
                                <LiveClock />
                             </div>

                             <div className="flex items-center gap-3">
                                <div className="flex bg-[var(--background-input)]/50 p-1 rounded-xl border border-[var(--border-color)]/50">
                                    <button onClick={() => setLocale('en')} className={`px-3 py-1.5 rounded-lg text-sm transition-all ${locale === 'en' ? 'bg-[var(--background-secondary)] shadow-sm text-[var(--text-primary)] font-semibold' : 'text-[var(--text-secondary)] hover:text-[var(--text-primary)]'}`}>🇺🇸</button>
                                    <button onClick={() => setLocale('km')} className={`px-3 py-1.5 rounded-lg text-sm transition-all ${locale === 'km' ? 'bg-[var(--background-secondary)] shadow-sm text-[var(--text-primary)] font-semibold' : 'text-[var(--text-secondary)] hover:text-[var(--text-primary)]'}`}>🇰🇭</button>
                                </div>
                                <div className="w-px h-6 bg-[var(--border-color)] mx-1"></div>
                                <ThemeSwitcher />
                                <button onClick={logout} className="p-2 bg-red-500/10 text-red-500 rounded-lg hover:bg-red-500 hover:text-white transition-colors" title={t('logoutButton')}><Icon name="logout" /></button>
                             </div>
                        </div>
                    </div>

                    {/* --- MOBILE VIEW (Visible only on Mobile) --- */}
                    <div className="md:hidden flex flex-col gap-4">
                        {/* Top Row: Brand & Actions */}
                        <div className="flex justify-between items-start">
                            <div className="flex items-center gap-3">
                                <div className="bg-gradient-to-br from-[var(--accent-color)] to-blue-600 p-2.5 rounded-xl shadow-lg shadow-blue-500/20 text-white shrink-0">
                                    <Icon name="landmark" className="w-5 h-5" />
                                </div>
                                <div>
                                    <h1 className="text-lg font-bold leading-tight tracking-tight">{t('headerTitle')}</h1>
                                    <p className="text-xs text-[var(--text-secondary)] font-medium flex items-center gap-1.5 mt-0.5">
                                        <span className="w-1.5 h-1.5 rounded-full bg-emerald-500 animate-pulse"></span>
                                        {userData.name}
                                    </p>
                                </div>
                            </div>
                            <div className="flex items-center gap-2">
                                <ThemeSwitcher />
                                <button onClick={logout} className="p-2 bg-[var(--background-input)] text-[var(--semantic-red)] rounded-lg border border-[var(--border-color)] hover:bg-[var(--semantic-red)] hover:text-white transition-colors">
                                    <Icon name="logout" className="w-5 h-5"/>
                                </button>
                            </div>
                        </div>
                        
                        {/* Bottom Row: Context & Language */}
                        <div className="flex justify-between items-center pt-3 border-t border-[var(--border-color)]/50">
                            <div className="flex items-center gap-2">
                                <span className="text-[10px] uppercase tracking-wider font-bold text-[var(--text-secondary)] bg-[var(--background-input)]/30 px-2 py-1 rounded border border-[var(--border-color)]/30">
                                    {userData.role}
                                </span>
                                {/* NEW: Mobile Live Clock */}
                                <LiveClock mobile />
                            </div>

                            <div className="flex bg-[var(--background-input)]/50 p-1 rounded-lg border border-[var(--border-color)]/50">
                                <button onClick={() => setLocale('en')} className={`px-3 py-1 rounded-md text-xs font-medium transition-all ${locale === 'en' ? 'bg-[var(--background-secondary)] shadow-sm text-[var(--text-primary)]' : 'text-[var(--text-secondary)]'}`}>🇺🇸 English</button>
                                <button onClick={() => setLocale('km')} className={`px-3 py-1 rounded-md text-xs font-medium transition-all ${locale === 'km' ? 'bg-[var(--background-secondary)] shadow-sm text-[var(--text-primary)]' : 'text-[var(--text-secondary)]'}`}>🇰🇭 Khmer</button>
                            </div>
                        </div>
                    </div>
                </header>
            );
        };

        const LoginPage = () => {
            const { login, authError, setAuthError } = useAuth();
            const { t } = useTranslation();
            const [c, setC] = useState({ email: '', password: '' });
            const [err, setErr] = useState(null);
            const [loading, setLoading] = useState(false);
            const [showPw, setShowPw] = useState(false);
            const [remember, setRemember] = useState(true);
            
            useEffect(() => { if (authError) { setErr({ message: t(authError.message) }); setAuthError(null); } }, [authError, setAuthError, t]);
            
            const handleSubmit = async (e) => { e.preventDefault(); setErr(null); setLoading(true); try { await login(c.email, c.password, remember); } catch (e) { setErr({ message: t('loginError') }); } finally { setLoading(false); } };
            
            return (
                <div className="min-h-screen flex items-center justify-center p-4 relative overflow-hidden">
                    {/* Background Decoration */}
                    <div className="absolute inset-0 overflow-hidden pointer-events-none">
                        <div className="absolute -top-1/2 -left-1/2 w-full h-full bg-gradient-to-br from-blue-500/10 to-transparent rounded-full blur-3xl transform scale-150 animate-pulse"></div>
                        <div className="absolute -bottom-1/2 -right-1/2 w-full h-full bg-gradient-to-tl from-emerald-500/10 to-transparent rounded-full blur-3xl transform scale-150 animate-pulse"></div>
                    </div>

                    <div className="w-full max-w-md bg-[var(--background-secondary)]/80 backdrop-blur-xl p-8 rounded-3xl shadow-2xl border border-[var(--border-color)] relative z-10 transition-all duration-500 hover:shadow-[var(--accent-color)]/10">
                        
                        {/* Header Section */}
                        <div className="flex flex-col items-center mb-8">
                            <div className="bg-gradient-to-br from-blue-600 to-emerald-500 p-4 rounded-2xl shadow-lg shadow-blue-500/20 text-white mb-5 transform hover:scale-110 transition-transform duration-300">
                                <Icon name="landmark" className="w-10 h-10" />
                            </div>
                            <h1 className="text-2xl font-bold text-center text-[var(--text-primary)] tracking-tight">{t('loginTitle')}</h1>
                            <div className="h-1 w-12 bg-gradient-to-r from-blue-500 to-emerald-500 rounded-full mt-3 mb-2"></div>
                            <p className="text-sm text-[var(--text-secondary)] font-medium">{t('loginSubtitle1')}</p>
                        </div>

                        {/* Form Section */}
                        <form onSubmit={handleSubmit} className="space-y-5">
                            <div className="space-y-1.5">
                                <label className="text-xs font-bold text-[var(--text-secondary)] uppercase tracking-wider ml-1">{t('emailPlaceholder')}</label>
                                <div className="relative group">
                                    <div className="absolute left-3 top-1/2 -translate-y-1/2 text-[var(--text-secondary)] group-focus-within:text-[var(--accent-color)] transition-colors">
                                        <Icon name="user" className="w-5 h-5" />
                                    </div>
                                    <input 
                                        type="email" 
                                        value={c.email} 
                                        onChange={e=>setC({...c,email:e.target.value})} 
                                        required 
                                        className="block w-full pl-10 pr-4 py-3 bg-[var(--background-input)]/50 border border-[var(--border-color)] rounded-xl outline-none focus:ring-2 focus:ring-[var(--accent-color)] focus:bg-[var(--background-input)] transition-all text-[var(--text-primary)] placeholder-[var(--text-secondary)]/50" 
                                        placeholder="name@company.com" 
                                    />
                                </div>
                            </div>

                            <div className="space-y-1.5">
                                <label className="text-xs font-bold text-[var(--text-secondary)] uppercase tracking-wider ml-1">{t('passwordPlaceholder')}</label>
                                <div className="relative group">
                                    <div className="absolute left-3 top-1/2 -translate-y-1/2 text-[var(--text-secondary)] group-focus-within:text-[var(--accent-color)] transition-colors">
                                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="w-5 h-5"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg>
                                    </div>
                                    <input 
                                        type={showPw?'text':'password'} 
                                        value={c.password} 
                                        onChange={e=>setC({...c,password:e.target.value})} 
                                        required 
                                        className="block w-full pl-10 pr-10 py-3 bg-[var(--background-input)]/50 border border-[var(--border-color)] rounded-xl outline-none focus:ring-2 focus:ring-[var(--accent-color)] focus:bg-[var(--background-input)] transition-all text-[var(--text-primary)] placeholder-[var(--text-secondary)]/50" 
                                        placeholder="••••••••" 
                                    />
                                    <button type="button" onClick={()=>setShowPw(!showPw)} className="absolute right-3 top-1/2 -translate-y-1/2 text-[var(--text-secondary)] hover:text-[var(--text-primary)] transition-colors p-1">
                                        <Icon name={showPw?'eye-off':'eye'} className="w-5 h-5" />
                                    </button>
                                </div>
                            </div>

                            <div className="flex items-center pt-1">
                                <label className="flex items-center cursor-pointer group select-none">
                                    <div className="relative">
                                        <input type="checkbox" checked={remember} onChange={e=>setRemember(e.target.checked)} className="sr-only" />
                                        <div className={`w-5 h-5 border rounded-md transition-all duration-200 flex items-center justify-center ${remember ? 'bg-[var(--accent-color)] border-[var(--accent-color)] shadow-sm' : 'border-[var(--text-secondary)] bg-transparent group-hover:border-[var(--text-primary)]'}`}>
                                            {remember && <svg className="w-3.5 h-3.5 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="3" d="M5 13l4 4L19 7" /></svg>}
                                        </div>
                                    </div>
                                    <span className="ml-2.5 text-sm font-medium text-[var(--text-secondary)] group-hover:text-[var(--text-primary)] transition-colors">{t('rememberMe')}</span>
                                </label>
                            </div>

                            {err && (
                                <div className="p-3 bg-red-500/10 border border-red-500/20 rounded-xl flex items-center gap-3 text-red-500 text-sm animate-pulse">
                                    <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5 shrink-0" viewBox="0 0 20 20" fill="currentColor"><path fillRule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clipRule="evenodd" /></svg>
                                    <span>{err.message}</span>
                                </div>
                            )}

                            <button type="submit" disabled={loading} className="w-full bg-gradient-to-r from-blue-600 to-blue-500 hover:from-blue-500 hover:to-blue-400 text-white font-bold py-3.5 rounded-xl shadow-lg shadow-blue-500/30 transition-all transform active:scale-[0.98] disabled:opacity-70 disabled:cursor-not-allowed flex justify-center items-center gap-2 mt-2">
                                {loading ? <Icon name="loader" className="w-5 h-5" /> : t('loginButton')}
                            </button>
                        </form>
                        
                        <div className="mt-8 text-center border-t border-[var(--border-color)]/50 pt-6">
                            <p className="text-xs text-[var(--text-secondary)] opacity-60 font-mono tracking-wide">
                                &copy; {new Date().getFullYear()} Cashier Manager System
                            </p>
                        </div>
                    </div>
                </div>
            );
        };

        const App = () => {
            const { user, loading } = useAuth();
            if (loading) return <LoadingSpinner />;
            return !user ? <LoginPage /> : (
                <AppProvider>
                    <div className="container mx-auto p-4 md:p-8 min-h-screen flex flex-col">
                        <div className="max-w-7xl mx-auto w-full flex-grow">
                            {/* UPDATED: Wrapped content in SessionTimeoutManager */}
                            <SessionTimeoutManager>
                                <AppHeader />
                                <main><CashDropPage /></main>
                                <footer className="mt-12 mb-6 text-center text-xs text-[var(--text-secondary)] opacity-60 font-mono border-t border-[var(--border-color)]/30 pt-6">&copy; {new Date().getFullYear()} Jelly Wang</footer>
                            </SessionTimeoutManager>
                        </div>
                    </div>
                </AppProvider>
            );
        };

        const Root = () => <LanguageProvider><ToastProvider><AuthProvider><ThemeProvider><App /></ThemeProvider></AuthProvider></ToastProvider></LanguageProvider>;
        ReactDOM.createRoot(document.getElementById('root')).render(<Root />);
    </script>
</body>
</html>
