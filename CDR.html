<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cash Drop & Expenses</title>
    
    <!-- PWA and Mobile App Manifest -->
    <meta name="theme-color" content="#1d4ed8">
    <link rel="apple-touch-icon" href="https://placehold.co/192x192/1d4ed8/ffffff?text=CDR">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="CashDrop">
    <link rel="manifest" href="data:application/manifest+json;base64,ewogICJuYW1lIjogIkNhc2ggRHJvcCBSZXBvcnQiLAogICJzaG9ydF9uYW1lIjogIkNhc2hEcm9wIiwKICAiaWQiOiAiLz9zb3VyY2U9cHdhIiwKICAiZGVzY3JpcHRpb24iOiAiQSBzaW1wbGUgYXBwIGZvciByZXBvcnRpbmcgZGFpbHkgY2FzaCBkcm9wcy4iLAogICJzdGFydF91cmwiOiAiLiIsCiAgImRpc3BsYXkiOiAic3RhbmRhbG9uZSIsCiAgImJhY2tncm91bmRfY29sb3IiOiAiI2YxZjVmOSIsCiAgInRoZW1lX2NvbG9yIjogIiMxZDRlZDgiLAogICJpY29ucyI6IFsKICAgIHsKICAgICAgInNyYyI6ICJodHRwczovL3BsYWNlaG9sZC5jby8xOTJ4MTkyLzFkNGVkOC9mZmZmZmY/dGV4dD1DRFIiLAogICAgICAidHlwZSI6ICJpbWFnZS9wbmciLAogICAgICAic2l6ZXMiOiAiMTkyeDE5MiIsCiAgICAgICJwdXJwb3NlIjogImFueSBtYXNrYWJsZSIKICAgIH0KICAgICh7CiAgICAgICJzcmMiOiAiaHR0cHM6Ly9wbGFjZWhvbGQuY28vNTEyeDUxMi8xZDRlZDgvZmZmZmZmP3RleHQ9Q0RSIiwKICAgICAidHlwZSI6ICJpbWFnZS9wbmciLAogICAgICAic2l6ZXMiOiAiNTEyeDUxMiIsCiAgICAgICJwdXJwb3NlIjogImFueSBtYXNrYWJsZSIKICAgIH0KICBdCn0=">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React and Babel -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Firebase SDKs -->
    <script type="module">
        // Import SDKs for the firebaseService
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut, setPersistence, browserSessionPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        // Added 'limit' to imports for optimization
        import { getFirestore, collection, doc, addDoc, onSnapshot, deleteDoc, getDoc, Timestamp, setDoc, updateDoc, query, orderBy, where, limit } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // Make SDKs available to the global firebaseService object
        window.firebaseSDK = {
            initializeApp,
            getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut, setPersistence, browserSessionPersistence, browserLocalPersistence,
            getFirestore, collection, doc, addDoc, onSnapshot, deleteDoc, getDoc, Timestamp, setDoc, updateDoc, query, orderBy, where, limit
        };
    </script>
    
    <!-- SheetJS (for Excel export) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <!-- Theme initialization script (prevents flash) -->
    <script>
        (function() {
            function getInitialTheme() {
                const persistedTheme = window.localStorage.getItem('theme');
                if (persistedTheme) {
                    return persistedTheme;
                }
                return 'dark'; // Always default to 'dark' (Slate Blue)
            }
            const theme = getInitialTheme();
            const themeClass = theme === 'dark' ? 'dark' : theme;
            document.documentElement.classList.add(themeClass);
        })();
    </script>

    <!-- 
      START: THEME CSS VARIABLES
      All theme definitions are here.
    -->
    <style>
        :root {
            /* Default Dark Theme (Matches original app's Slate Blue) */
            --background-primary: #0f172a;      /* slate-900 */
            --background-secondary: #1e293b;    /* slate-800 */
            --background-input: #334155;     /* slate-700 */
            --text-primary: #f1f5f9;          /* slate-100/200 */
            --text-secondary: #94a3b8;        /* slate-400 */
            --border-color: #334155;          /* slate-700/600 */
            --accent-color: #3b82f6;          /* blue-500 */
            --accent-color-hover: #2563eb;    /* blue-600 */
            
            /* Semantic colors (unchanged by theme) */
            --semantic-red: #ef4444;    /* red-500 */
            --semantic-red-hover: #dc2626; /* red-600 */
            --semantic-green: #22c55e;  /* green-500 */
            --semantic-green-hover: #16a34a; /* green-600 */
            --semantic-yellow: #eab308; /* yellow-500 */
        }

        .light {
            /* Light Theme */
            --background-primary: #ffffff;
            --background-secondary: #f1f5f9;
            --background-input: #ffffff;
            --text-primary: #0f172a;
            --text-secondary: #475569;
            --border-color: #cbd5e1;
            --accent-color: #0284c7;
            --accent-color-hover: #0369a1;
        }
       
        .charcoal {
            /* Charcoal & Orange Theme */
            --background-primary: #171717;
            --background-secondary: #262626;
            --background-input: #404040;
            --text-primary: #f5f5f5;
            --text-secondary: #a3a3a3;
            --border-color: #404040;
            --accent-color: #fb923c;
            --accent-color-hover: #f97316;
        }

        .nord {
            /* Nord Theme */
            --background-primary: #2E3440;
            --background-secondary: #3B4252;
            --background-input: #4C566A;
            --text-primary: #ECEFF4;
            --text-secondary: #D8DEE9;
            --border-color: #4C566A;
            --accent-color: #88C0D0;
            --accent-color-hover: #81A1C1;
        }

        .forest {
            /* Forest Theme */
            --background-primary: #1a2e2c;
            --background-secondary: #2a4a46;
            --background-input: #3a6b63;
            --text-primary: #e6f1f0;
            --text-secondary: #a0c0bd;
            --border-color: #3a6b63;
            --accent-color: #34d399; /* emerald-400 */
            --accent-color-hover: #10b981; /* emerald-500 */
        }
        .rose {
            /* Rosé Theme */
            --background-primary: #3d1c2b;
            --background-secondary: #5c2a41;
            --background-input: #7b3d58;
            --text-primary: #fce7f3;
            --text-secondary: #f4abc4;
            --border-color: #7b3d58;
            --accent-color: #f472b6; /* pink-400 */
            --accent-color-hover: #ec4899; /* pink-500 */
        }
        .ocean {
            /* Ocean Theme */
            --background-primary: #0e2a47;
            --background-secondary: #1c3d66;
            --background-input: #294f85;
            --text-primary: #e0f2fe;
            --text-secondary: #a5cff7;
            --border-color: #294f85;
            --accent-color: #38bdf8; /* sky-400 */
            --accent-color-hover: #0ea5e9; /* sky-500 */
        }
        .sunset {
            /* Sunset Theme */
            --background-primary: #451a03;
            --background-secondary: #6e2905;
            --background-input: #923706;
            --text-primary: #fff7ed;
            --text-secondary: #fdbf8e;
            --border-color: #923706;
            --accent-color: #f97316; /* orange-500 */
            --accent-color-hover: #ea580c; /* orange-600 */
        }
        .lavender {
            /* Lavender Theme */
            --background-primary: #2b234a;
            --background-secondary: #3f356b;
            --background-input: #53488f;
            --text-primary: #e9e7f8;
            --text-secondary: #b6b0d4;
            --border-color: #53488f;
            --accent-color: #a78bfa; /* violet-400 */
            --accent-color-hover: #8b5cf6; /* violet-500 */
        }
        .grayscale {
            /* Grayscale Theme */
            --background-primary: #171717;
            --background-secondary: #262626;
            --background-input: #404040;
            --text-primary: #f5f5f5;
            --text-secondary: #a3a3a3;
            --border-color: #404040;
            --accent-color: #a3a3a3; /* neutral-400 */
            --accent-color-hover: #d4d4d4; /* neutral-300 */
        }
        /* END: THEME CSS VARIABLES */

        /* Base body styles */
        body {
            background-color: var(--background-primary);
            font-family: 'Inter', sans-serif;
            color: var(--text-primary);
            transition: background-color 0.3s, color 0.3s;
        }
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');
    </style>
</head>
<body class="bg-[var(--background-primary)] text-[var(--text-primary)]">
    <div id="root"></div>

    <script type="text/babel">
        // De-structure React hooks for cleaner use
        const { useState, useEffect, useMemo, useCallback, createContext, useContext, useRef } = React;
        // Get imported Firebase SDKs from the global window object
        const { firebaseSDK } = window;

        /******************************************************************************
         * 1. CONFIGURATION
         * App-wide constants and configuration objects.
         *****************************************************************************/
        
        const firebaseConfig = {
            apiKey: "AIzaSyA4upjtl0UFToWSfRZEiEQvwz9ieFLfqhI",
            authDomain: "cashflow-mgr.firebaseapp.com",
            projectId: "cashflow-mgr",
            storageBucket: "cashflow-mgr.appspot.com",
            messagingSenderId: "873891130920",
            appId: "1:873891130920:web:b6b8f0432943c33a930f1d",
            measurementId: "G-LVLMJ8ZY0B"
        };
        
        const DEFAULT_EXCHANGE_RATE = 4000;
        // REMOVED STATIC QUERY_LIMIT to allow dynamic fetching
        
        const ROLES = {
            ADMIN: 'Admin',
            MANAGEMENT: 'Management',
            SHOP_MANAGER: 'Shop Manager',
            CASHIER: 'Cashier',
            STAFF: 'Staff'
        };

        const translations = {
            en: {
                // Updated Login Title
                loginTitle: 'Cashier Manager Application', 
                loginSubtitle1: 'Internal Use Only.', loginSubtitle2: 'Please log in to your account.', emailPlaceholder: 'Email address', passwordPlaceholder: 'Password',
                rememberMe: 'Remember me', loginButton: 'Log In', loginError: 'Failed to log in. Please check your email and password.', employeeProfileError: 'Your employee profile was not found. Please contact an administrator.',
                headerTitle: 'Cashier Manager Application', welcomeMessage: 'Welcome, {{name}} ({{role}})', installAppButton: 'Install App', logoutButton: 'Logout',
                newFormTitle: 'New Cash Drop Form', dateLabel: 'Date', shopLabel: 'Shop', staffLabel: 'Staff', shiftLabel: 'Shift', byCashTitle: 'By Cash', byBankTitle: 'By Bank',
                cashExchangeTitle: 'Cash Exchange', khrLabel: 'KHR (៛)', usdLabel: 'USD ($)', noteLabel: 'Note', notePlaceholder: 'Add an optional note...', submitReportButton: 'Submit Report',
                summaryTitle: 'Summary', grandTotalLabel: 'Grand Total', cashKhrLabel: 'Cash KHR', cashUsdLabel: 'Cash USD', bankKhrLabel: 'Bank KHR', bankUsdLabel: 'Bank USD',
                cashExchangeKhrLabel: 'Cash Exchange KHR', cashExchangeUsdLabel: 'Cash Exchange USD',
                confirmSubmissionTitle: 'Confirm Report Submission', confirmSubmissionMessage: 'Please review the details before submitting. Is everything correct?',
                confirmDeletionTitle: 'Confirm Deletion', confirmDeletionMessage: 'Are you sure you want to delete this report? This action cannot be undone.',
                cancelButton: 'Cancel', confirmButton: 'Yes, Confirm', deleteButton: 'Delete',
                customDateTitle: 'Select Custom Date Range', startDateLabel: 'Start Date', endDateLabel: 'End Date', applyButton: 'Apply',
                editReportTitle: 'Edit Report', saveChangesButton: 'Save Changes', reportNoteTitle: 'Report Note', closeButton: 'Close',
                submissionSuccessTitle: 'Report Submitted Successfully', submissionSuccessMessage: 'You can now take a screenshot of this summary for your records.',
                historyTitle: 'Daily Cash Drop History', exportButton: 'Export to Excel', allShops: 'All Shops', dueTimeLabel: 'Timeframe',
                timeFilters: { today: 'Today', yesterday: 'Yesterday', thisMonth: 'This Month', lastMonth: 'Last Month', thisYear: 'This Year', lastYear: 'Last Year', custom: 'Custom' },
                noReportsFound: 'No reports found for the selected filters.', dateHeader: 'Date', dateTimeHeader: 'Date & Time', shopHeader: 'Shop', staffHeader: 'Staff', shiftHeader: 'Shift',
                netSaleHeader: 'Net Sale (៛)', cashUsdHeader: 'Cash USD', cashKhrHeader: 'Cash KHR', bankUsdHeader: 'Bank USD', bankKhrHeader: 'Bank KHR', cashExchUsdHeader: 'Cash Exch. USD',
                cashExchKhrHeader: 'Cash Exch. KHR', actionsHeader: 'Actions', subTotal: 'Sub-Total',
                // Expenses
                tabs: { cashDrop: 'Daily Cash Drop', expenses: 'Daily Expenses' },
                expenseHeader: 'Daily Operation Expenses', addExpenseButton: 'Add Expense', editExpenseButton: 'Edit Expense',
                itemNameLabel: 'Item Name / Description', categoryLabel: 'Category', quantityLabel: 'Quantity', priceLabel: 'Price', totalLabel: 'Total',
                recordedByHeader: 'Recorded By', expenseSuccess: 'Daily expense added successfully.', expenseUpdateSuccess: 'Daily expense updated successfully.', expenseDeleteSuccess: 'Expense deleted successfully.',
                confirmExpenseDelete: 'Are you sure you want to delete this expense?'
            },
            km: {
                loginTitle: 'JLW បញ្ចូលសាច់ប្រាក់', loginSubtitle1: 'សម្រាប់ប្រើប្រាស់តែក្នុងក្រុមហ៊ុនប៉ុណ្ណោះ!', loginSubtitle2: 'សូមចូលទៅកាន់គណនីរបស់អ្នក!', emailPlaceholder: 'អាសយដ្ឋានអ៊ីមែល', passwordPlaceholder: 'ពាក្យសម្ងាត់',
                rememberMe: 'ចងចាំខ្ញុំ', loginButton: 'ចូលគណនី', loginError: 'ការចូលគណនីបានបរាជ័យ។ សូមពិនិត្យអ៊ីមែល និងពាក្យសម្ងាត់របស់អ្នក។', employeeProfileError: 'រកមិនឃើញប្រវត្តិរូបបុគ្គលិករបស់អ្នកទេ។ សូមទាក់ទងអ្នកគ្រប់គ្រង។',
                headerTitle: 'របាយការណ៍បញ្ចូលសាច់ប្រាក់', welcomeMessage: 'សូមស្វាគមន៍, {{name}} ({{role}})', installAppButton: 'ដំឡើងកម្មវិធី', logoutButton: 'ចាកចេញ',
                newFormTitle: 'ទម្រង់បញ្ចូលសាច់ប្រាក់ថ្មី', dateLabel: 'កាលបរិច្ឆេទ', shopLabel: 'ហាង', staffLabel: 'បុគ្គលិក', shiftLabel: 'វេន', byCashTitle: 'តាមសាច់ប្រាក់', byBankTitle: 'តាមធនាគារ',
                cashExchangeTitle: 'សាច់ប្រាក់សម្រាប់ដូរ', khrLabel: 'រៀល (៛)', usdLabel: 'ដុល្លារ ($)', noteLabel: 'កំណត់ចំណាំ', notePlaceholder: 'បន្ថែមចំណាំ (បើមាន)...', submitReportButton: 'បញ្ជូនរបាយការណ៍',
                summaryTitle: 'សេចក្តីសង្ខេប', grandTotalLabel: 'សរុប​រួម', cashKhrLabel: 'សាច់ប្រាក់ រៀល', cashUsdLabel: 'សាច់ប្រាក់ ដុល្លារ', bankKhrLabel: 'ធនាគារ រៀល', bankUsdLabel: 'ធនាគារ ដុល្លារ',
                cashExchangeKhrLabel: 'សាច់ប្រាក់ដូរ រៀល', cashExchangeUsdLabel: 'សាច់ប្រាក់ដូរ ដុល្លារ',
                confirmSubmissionTitle: 'បញ្ជាក់ការបញ្ជូនរបាយការណ៍', confirmSubmissionMessage: 'សូមពិនិត្យមើលព័ត៌មានលម្អិតមុនពេលបញ្ជូន។ ត្រឹមត្រូវហើយឬនៅ?',
                confirmDeletionTitle: 'បញ្ជាក់ការលុប', confirmDeletionMessage: 'តើអ្នកប្រាកដថាចង់លុបរូបាយការណ៍នេះមែនទេ? សកម្មភាពនេះមិនអាចមិនធ្វើវិញបានទេ។',
                cancelButton: 'បោះបង់', confirmButton: 'បាទ/ចាស៎', deleteButton: 'លុប',
                customDateTitle: 'ជ្រើសរើសចន្លោះកាលបរិច្ឆេទ', startDateLabel: 'ថ្ងៃចាប់ផ្តើម', endDateLabel: 'ថ្ងៃបញ្ចប់', applyButton: 'អនុវត្ត',
                editReportTitle: 'កែសម្រួលរបាយការណ៍', saveChangesButton: 'រក្សាទុកការផ្លាស់ប្តូរ', reportNoteTitle: 'កំណត់ចំណាំរបាយការណ៍', closeButton: 'បិទ',
                submissionSuccessTitle: 'របាយការណ៍លក់ត្រូវបានបញ្ចូលជោគជ័យ', submissionSuccessMessage: 'សូមអ្នកធ្វើការថតរបាយការណ៍នេះដើម្បីរាយការណ៍ជូនថ្នាក់លើ!',
                historyTitle: 'ប្រវត្តិរបាយការណ៍បញ្ចូលសាច់ប្រាក់', exportButton: 'នាំចេញជា Excel', allShops: 'គ្រប់ហាងទាំងអស់', dueTimeLabel: 'ពេលវេលា',
                timeFilters: { today: 'ថ្ងៃនេះ', yesterday: 'ម្សិលមិញ', thisMonth: 'ខែនេះ', lastMonth: 'ខែមុន', thisYear: 'ឆ្នាំនេះ', lastYear: 'ឆ្នាំមុន', custom: 'ផ្ទាល់ខ្លួន' },
                noReportsFound: 'រកមិនឃើញរបាយការណ៍សម្រាប់តម្រងដែលបានជ្រើសរើសទេ។', dateHeader: 'កាលបរិច្ឆេទ', dateTimeHeader: 'កាលបរិច្ឆេទ & ម៉ោង', shopHeader: 'ហាង', staffHeader: 'បុគ្គលិក', shiftHeader: 'វេន',
                netSaleHeader: 'លក់សរុប (៛)', cashUsdHeader: 'សាច់ប្រាក់ USD', cashKhrHeader: 'សាច់ប្រាក់ KHR', bankUsdHeader: 'ធនាគារ USD', bankKhrHeader: 'ធនាគារ KHR', cashExchUsdHeader: 'សាច់ប្រាក់ដូរ USD',
                cashExchKhrHeader: 'សាច់ប្រាក់ដូរ KHR', actionsHeader: 'សកម្មភាព', subTotal: 'សរុបរង',
                // Expenses
                tabs: { cashDrop: 'បញ្ចូលសាច់ប្រាក់', expenses: 'ចំណាយប្រចាំថ្ងៃ' },
                expenseHeader: 'ចំណាយប្រតិបត្តិការប្រចាំថ្ងៃ', addExpenseButton: 'បន្ថែមចំណាយ', editExpenseButton: 'កែសម្រួលចំណាយ',
                itemNameLabel: 'ឈ្មោះទំនិញ / ការពិពណ៌នា', categoryLabel: 'ប្រភេទ', quantityLabel: 'បរិមាណ', priceLabel: 'តម្លៃ', totalLabel: 'សរុប',
                recordedByHeader: 'កត់ត្រាដោយ', expenseSuccess: 'ចំណាយប្រចាំថ្ងៃត្រូវបានបន្ថែមដោយជោគជ័យ។', expenseUpdateSuccess: 'ចំណាយត្រូវបានកែសម្រួលដោយជោគជ័យ។', expenseDeleteSuccess: 'ចំណាយត្រូវបានលុបដោយជោគជ័យ។',
                confirmExpenseDelete: 'តើអ្នកប្រាកដថាចង់លុបការចំណាយនេះមែនទេ?'
            }
        };

        /******************************************************************************
         * 2. FIREBASE SERVICE
         * Centralized module for all Firebase interactions, created as an IIFE.
         *****************************************************************************/
        
        const firebaseService = (() => {
            // Initialize Firebase app and services ONCE
            let app, auth, db;
            try {
                app = firebaseSDK.initializeApp(firebaseConfig);
                auth = firebaseSDK.getAuth(app);
                db = firebaseSDK.getFirestore(app);
            } catch (e) {
                console.error("Failed to initialize Firebase", e);
                return {}; // Return empty object on failure
            }

            // OPTIMIZATION: Helper to normalize docs once
            const normalizeDoc = (doc) => {
                const data = doc.data();
                // Convert timestamps immediately to ensure stable Date objects
                return {
                    id: doc.id,
                    ...data,
                    createdAt: data.createdAt?.toDate ? data.createdAt.toDate() : (data.createdAt ? new Date(data.createdAt) : null),
                    date: data.date?.toDate ? data.date.toDate() : (data.date ? new Date(data.date) : null)
                };
            };

            return {
                // --- Getters ---
                getAuth: () => auth,
                getDb: () => db,
                getTimestamp: () => firebaseSDK.Timestamp,

                // --- Auth Methods ---
                onAuthChange: (callback) => {
                    return firebaseSDK.onAuthStateChanged(auth, callback);
                },

                login: async (email, password, rememberMe) => {
                    const persistence = rememberMe 
                        ? firebaseSDK.browserLocalPersistence 
                        : firebaseSDK.browserSessionPersistence;
                    await firebaseSDK.setPersistence(auth, persistence);
                    return firebaseSDK.signInWithEmailAndPassword(auth, email, password);
                },

                logout: () => {
                    return firebaseSDK.signOut(auth);
                },

                fetchEmployeeProfile: async (uid) => {
                    const userDocRef = firebaseSDK.doc(db, 'employees', uid);
                    const userDoc = await firebaseSDK.getDoc(userDocRef);
                    return userDoc.exists() ? { uid, ...userDoc.data() } : null;
                },

                // --- Firestore Methods (Reports) ---
                streamShops: (callback) => {
                    const q = firebaseSDK.collection(db, "shops");
                    return firebaseSDK.onSnapshot(q, (snapshot) => {
                        const shops = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        callback(shops);
                    }, (err) => console.error("Error fetching shops:", err));
                },

                streamReports: (callback, dateRange = null) => {
                    let constraints = [firebaseSDK.orderBy("createdAt", "desc")];
                    
                    // If date range is provided, query specific range. Otherwise default to recent 500.
                    if (dateRange && dateRange.start && dateRange.end) {
                        constraints.push(firebaseSDK.where("createdAt", ">=", firebaseSDK.Timestamp.fromDate(dateRange.start)));
                        constraints.push(firebaseSDK.where("createdAt", "<=", firebaseSDK.Timestamp.fromDate(dateRange.end)));
                    } else {
                        constraints.push(firebaseSDK.limit(500));
                    }

                    const q = firebaseSDK.query(firebaseSDK.collection(db, "cashDrops"), ...constraints);
                    
                    return firebaseSDK.onSnapshot(q, (snapshot) => {
                        const reports = snapshot.docs.map(normalizeDoc);
                        callback(reports);
                    }, (err) => console.error("Error fetching reports:", err));
                },

                addReport: (reportData) => {
                    return firebaseSDK.addDoc(firebaseSDK.collection(db, "cashDrops"), reportData);
                },

                updateReport: (reportId, reportData) => {
                    const reportRef = firebaseSDK.doc(db, "cashDrops", reportId);
                    return firebaseSDK.updateDoc(reportRef, reportData);
                },

                deleteReport: (reportId) => {
                    const reportRef = firebaseSDK.doc(db, "cashDrops", reportId);
                    return firebaseSDK.deleteDoc(reportRef);
                },

                // --- Firestore Methods (Expenses) ---
                streamBusinessCategories: (callback) => {
                    const q = firebaseSDK.query(
                        firebaseSDK.collection(db, "businessExpenseCategories"),
                        firebaseSDK.orderBy("name", "asc")
                    );
                    return firebaseSDK.onSnapshot(q, (snapshot) => {
                        const categories = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        callback(categories);
                    }, (err) => console.error("Error fetching categories:", err));
                },

                streamExpenses: (callback, dateRange = null) => {
                    let constraints = [firebaseSDK.orderBy("date", "desc")]; // Changed to order by 'date' (transaction date)

                    // If date range is provided, query specific range. Otherwise default to recent 500.
                    if (dateRange && dateRange.start && dateRange.end) {
                        constraints.push(firebaseSDK.where("date", ">=", firebaseSDK.Timestamp.fromDate(dateRange.start)));
                        constraints.push(firebaseSDK.where("date", "<=", firebaseSDK.Timestamp.fromDate(dateRange.end)));
                    } else {
                        constraints.push(firebaseSDK.limit(500));
                    }

                    const q = firebaseSDK.query(firebaseSDK.collection(db, "businessExpenses"), ...constraints);
                    
                    return firebaseSDK.onSnapshot(q, (snapshot) => {
                        const expenses = snapshot.docs.map(normalizeDoc);
                        callback(expenses);
                    }, (err) => console.error("Error fetching expenses:", err));
                },

                addExpense: (expenseData) => {
                    return firebaseSDK.addDoc(firebaseSDK.collection(db, "businessExpenses"), expenseData);
                },

                updateExpense: (id, expenseData) => {
                    const docRef = firebaseSDK.doc(db, "businessExpenses", id);
                    return firebaseSDK.updateDoc(docRef, expenseData);
                },

                deleteExpense: (id) => {
                    return firebaseSDK.deleteDoc(firebaseSDK.doc(db, "businessExpenses", id));
                }
            };
        })();

        /******************************************************************************
         * 3. UTILITY FUNCTIONS
         * General-purpose helper functions.
         *****************************************************************************/
        
        const parseCurrency = (val) => parseFloat(String(val).replace(/,/g, '')) || 0;
        const formatInputAsCurrency = (val) => val.replace(/[^0-9.]/g, '').replace(/\B(?=(\d{3})+(?!\d))/g, ',');
        
        const formatCurrency = (value, currency) => {
            const number = parseFloat(String(value).replace(/,/g, '')) || 0;
            const formatted = number.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            return currency === 'KHR' ? `${formatted} ៛` : (currency === 'USD' ? `${formatted} $` : formatted);
        };
        
        // Simplified utilities now that data is normalized
        const formatDateDDMMYYYY = (date) => {
            if (!date) return 'N/A';
            const d = date; // Already a Date object due to normalization
            const day = String(d.getDate()).padStart(2, '0');
            const month = String(d.getMonth() + 1).padStart(2, '0');
            const year = d.getFullYear();
            return `${day}-${month}-${year}`;
        };

        const formatFullDateTime = (date) => {
            if (!date) return 'N/A';
            const d = date; // Already a Date object
            const datePart = formatDateDDMMYYYY(d);
            const timePart = d.toLocaleTimeString('en-GB', { timeZone: 'Asia/Phnom_Penh', hour: '2-digit', minute: '2-digit', second: '2-digit' });
            return `${datePart} | ${timePart}`;
        };

        // NEW UTILITY: Specific format for Expenses (DD-MM-YY | HH:MM AM/PM)
        const formatExpenseDateTime = (date) => {
            if (!date) return 'N/A';
            const d = date;
            const day = String(d.getDate()).padStart(2, '0');
            const month = String(d.getMonth() + 1).padStart(2, '0');
            const year = String(d.getFullYear()).slice(-2); // YY
            
            let hours = d.getHours();
            const minutes = String(d.getMinutes()).padStart(2, '0');
            const ampm = hours >= 12 ? 'PM' : 'AM';
            hours = hours % 12;
            hours = hours ? hours : 12; // the hour '0' should be '12'
            
            return `${day}-${month}-${year} | ${hours}:${minutes} ${ampm}`;
        };

        const createTimestampFromDateAndCurrentTime = (dateStr) => {
            const now = new Date();
            const d = new Date(dateStr);
            d.setHours(now.getHours(), now.getMinutes(), now.getSeconds(), now.getMilliseconds());
            return firebaseService.getTimestamp().fromDate(d);
        };

        /******************************************************************************
         * 4. I18N & CONTEXTS
         *****************************************************************************/

        const LanguageContext = createContext();
        const LanguageProvider = ({ children }) => {
            // Updated default language to English ('en')
            const [locale, setLocale] = useState('en');
            const t = useCallback((key, params = {}) => {
                const keys = key.split('.');
                let result = translations[locale];
                for (const k of keys) {
                    result = result?.[k];
                    if (result === undefined) return key;
                }
                if (typeof result === 'string' && params) {
                    Object.entries(params).forEach(([paramKey, paramValue]) => {
                        result = result.replace(new RegExp(`{{${paramKey}}}`, 'g'), paramValue);
                    });
                }
                return result;
            }, [locale]);
            // OPTIMIZATION: Memoize context value
            const value = useMemo(() => ({ locale, setLocale, t }), [locale, t]);
            return <LanguageContext.Provider value={value}>{children}</LanguageContext.Provider>;
        };

        const ThemeContext = createContext();
        function ThemeProvider({ children }) {
            const [theme, setTheme] = useState(() => {
                const persistedTheme = localStorage.getItem('theme');
                return persistedTheme || 'dark';
            });
            useEffect(() => {
                const root = window.document.documentElement;
                root.classList.remove('dark', 'light', 'charcoal', 'nord', 'forest', 'rose', 'ocean', 'sunset', 'lavender', 'grayscale');
                const themeClass = theme === 'dark' ? 'dark' : theme;
                root.classList.add(themeClass);
                localStorage.setItem('theme', theme);
            }, [theme]);
            // OPTIMIZATION: Memoize context value
            const value = useMemo(() => ({ theme, setTheme }), [theme]);
            return <ThemeContext.Provider value={value}>{children}</ThemeContext.Provider>;
        }

        const ToastContext = createContext();
        const ToastProvider = ({ children }) => {
            const [toast, setToast] = useState(null);
            
            const showToast = useCallback((message, type = 'success') => {
                setToast({ message, type });
                setTimeout(() => setToast(null), 3000);
            }, []);

            // OPTIMIZATION: Memoize context value
            const value = useMemo(() => ({ showToast }), [showToast]);

            return (
                <ToastContext.Provider value={value}>
                    {children}
                    {toast && (
                        <div className={`fixed bottom-4 right-4 z-[9999] px-6 py-3 rounded-lg shadow-lg border text-white transition-all transform animate-bounce ${
                            toast.type === 'error' ? 'bg-[var(--semantic-red)] border-red-700' : 'bg-[var(--semantic-green)] border-green-700'
                        }`}>
                            <div className="flex items-center gap-2">
                                <span className="font-semibold">{toast.message}</span>
                            </div>
                        </div>
                    )}
                </ToastContext.Provider>
            );
        };

        const AuthContext = createContext();
        const AppContext = createContext();

        const AuthProvider = ({ children }) => {
            const [user, setUser] = useState(null);
            const [userData, setUserData] = useState(null);
            const [loading, setLoading] = useState(true);
            const [authError, setAuthError] = useState(null);

            useEffect(() => {
                if (!firebaseService.onAuthChange) { setLoading(false); return; }
                const unsubscribe = firebaseService.onAuthChange(async (firebaseUser) => {
                    if (firebaseUser) {
                        const profile = await firebaseService.fetchEmployeeProfile(firebaseUser.uid);
                        if (profile) {
                            setUser(firebaseUser);
                            setUserData(profile);
                        } else {
                            await firebaseService.logout();
                            setAuthError({ message: 'employeeProfileError' });
                        }
                    } else {
                        setUser(null);
                        setUserData(null);
                    }
                    setLoading(false);
                });
                return () => unsubscribe();
            }, []);

            const login = useCallback(async (email, password, rememberMe) => {
                return firebaseService.login(email, password, rememberMe);
            }, []);
            const logout = useCallback(() => firebaseService.logout(), []);

            // OPTIMIZATION: Memoize context value
            const value = useMemo(() => ({ user, userData, login, logout, loading, authError, setAuthError }), [user, userData, login, logout, loading, authError]);
            return <AuthContext.Provider value={value}>{children}</AuthContext.Provider>;
        };

        const AppProvider = ({ children }) => {
            const { userData } = useContext(AuthContext);
            const [shops, setShops] = useState([]);
            const [reports, setReports] = useState([]);
            const [businessExpenses, setBusinessExpenses] = useState([]);
            const [businessCategories, setBusinessCategories] = useState([]);
            const [isLoading, setIsLoading] = useState(true);
            
            // State for dynamic date filtering
            const [reportDateRange, setReportDateRange] = useState(null); // null = default recent
            const [expenseDateRange, setExpenseDateRange] = useState(null); // null = default recent

            useEffect(() => {
                if (!userData || !firebaseService.streamShops) return;
                
                const canViewDashboard = userData.role !== ROLES.CASHIER && userData.role !== ROLES.STAFF;
                let unsubReports = () => {};
                let unsubExpenses = () => {};
                let unsubCategories = () => {};

                if (canViewDashboard) {
                    // Pass current date range state to streams
                    unsubReports = firebaseService.streamReports(setReports, reportDateRange);
                    unsubExpenses = firebaseService.streamExpenses(setBusinessExpenses, expenseDateRange);
                } else {
                    unsubExpenses = firebaseService.streamExpenses(setBusinessExpenses, expenseDateRange);
                }

                unsubCategories = firebaseService.streamBusinessCategories(setBusinessCategories);
                
                const unsubShops = firebaseService.streamShops((allShops) => {
                    setShops(allShops);
                    setIsLoading(false);
                });

                return () => { unsubReports(); unsubShops(); unsubExpenses(); unsubCategories(); };
            }, [userData, reportDateRange, expenseDateRange]); // Re-run when date ranges change

            // Helpers to update ranges
            const fetchReportsInRange = useCallback((start, end) => setReportDateRange({ start, end }), []);
            const fetchExpensesInRange = useCallback((start, end) => setExpenseDateRange({ start, end }), []);
            const resetReportsFetch = useCallback(() => setReportDateRange(null), []);
            const resetExpensesFetch = useCallback(() => setExpenseDateRange(null), []);

            const value = useMemo(() => ({ 
                shops, 
                reports, 
                businessExpenses, 
                businessCategories, 
                isLoading, 
                appSettings: { exchangeRate: DEFAULT_EXCHANGE_RATE },
                fetchReportsInRange,
                fetchExpensesInRange,
                resetReportsFetch,
                resetExpensesFetch
            }), [shops, reports, businessExpenses, businessCategories, isLoading, fetchReportsInRange, fetchExpensesInRange, resetReportsFetch, resetExpensesFetch]);

            return <AppContext.Provider value={value}>{children}</AppContext.Provider>;
        };
        
        const useTranslation = () => useContext(LanguageContext);
        const useTheme = () => useContext(ThemeContext);
        const useAuth = () => useContext(AuthContext);
        const useAppContext = () => useContext(AppContext);
        const useToast = () => useContext(ToastContext);

        const useAvailableShops = () => {
            const { shops } = useAppContext();
            const { userData } = useAuth();
            return useMemo(() => {
                if (!userData || !shops) return [];
                const { role, shopIds } = userData;
                if (role === ROLES.ADMIN || role === ROLES.MANAGEMENT) return shops;
                return shops.filter(s => shopIds?.includes(s.id));
            }, [shops, userData]);
        };

        const useShopColorMap = () => {
            const { shops } = useAppContext();
            return useMemo(() => {
                const colors = ['blue', 'green', 'yellow', 'pink', 'indigo', 'teal'];
                return shops.reduce((map, shop, index) => {
                    const color = colors[index % colors.length];
                    map[shop.name] = { base: `bg-${color}-900/20`, hover: `hover:bg-${color}-800/30` };
                    return map;
                }, {});
            }, [shops]);
        };

        const useFilteredReports = (reports, filters, userData, availableShops) => {
            return useMemo(() => {
                if (!reports || !userData) return { filteredAndAggregatedData: null, totals: {} };
                
                const userFilteredReports = (userData.role === ROLES.ADMIN || userData.role === ROLES.MANAGEMENT)
                    ? reports : reports.filter(report => availableShops.map(s => s.name).includes(report.shop));

                let filtered = userFilteredReports;
                const { dueTime, startDate, endDate, shop } = filters;
                const now = new Date();
                let startFilterDate, endFilterDate;
                
                switch (dueTime) {
                    case 'Today': startFilterDate = new Date(now.getFullYear(), now.getMonth(), now.getDate()); break;
                    case 'Yesterday': startFilterDate = new Date(now.getFullYear(), now.getMonth(), now.getDate() - 1); endFilterDate = new Date(now.getFullYear(), now.getMonth(), now.getDate() - 1, 23, 59, 59, 999); break;
                    case 'This Month': startFilterDate = new Date(now.getFullYear(), now.getMonth(), 1); break;
                    case 'Last Month': startFilterDate = new Date(now.getFullYear(), now.getMonth() - 1, 1); endFilterDate = new Date(now.getFullYear(), now.getMonth(), 0, 23, 59, 59, 999); break;
                    case 'This Year': startFilterDate = new Date(now.getFullYear(), 0, 1); break;
                    case 'Last Year': startFilterDate = new Date(now.getFullYear() - 1, 0, 1); endFilterDate = new Date(now.getFullYear() - 1, 11, 31, 23, 59, 59, 999); break;
                    case 'Custom': if (startDate && endDate) { startFilterDate = new Date(startDate + 'T00:00:00'); endFilterDate = new Date(endDate + 'T23:59:59.999'); } break;
                }

                if (startFilterDate) {
                    filtered = filtered.filter(r => {
                        const reportDate = r.createdAt; // Normalized already
                        if (!reportDate) return false;
                        return reportDate >= startFilterDate && (endFilterDate ? reportDate <= endFilterDate : true);
                    });
                }
                if (shop) filtered = filtered.filter(r => r.shop === shop);
                
                let type = 'detailed';
                let data = filtered;

                if (!['Today', 'Yesterday', 'Custom'].includes(dueTime)) {
                    type = 'aggregated';
                    const aggregated = filtered.reduce((acc, report) => {
                        const date = report.createdAt; // Normalized
                        const period = ['This Month', 'Last Month'].includes(dueTime) ? date.toLocaleString('en-US', { month: 'short', year: 'numeric' }) : date.getFullYear().toString();
                        const key = `${period}|${report.shop}`;
                        if (!acc[key]) acc[key] = { period, shop: report.shop, cashUsd: 0, cashKhr: 0, bankUsd: 0, bankKhr: 0, grandTotalKhr: 0, cashExchangeKhr: 0, cashExchangeUsd: 0 };
                        acc[key].cashUsd += report.cashUsd || 0; acc[key].cashKhr += report.cashKhr || 0;
                        acc[key].bankUsd += report.bankUsd || 0; acc[key].bankKhr += report.bankKhr || 0;
                        acc[key].cashExchangeKhr += report.cashExchangeKhr || 0; acc[key].cashExchangeUsd += report.cashExchangeUsd || 0;
                        acc[key].grandTotalKhr += report.grandTotalKhr || 0;
                        return acc;
                    }, {});
                    data = Object.values(aggregated);
                }

                const totals = data.reduce((acc, r) => {
                    acc.cashUsd += r.cashUsd || 0; acc.cashKhr += r.cashKhr || 0;
                    acc.bankUsd += r.bankUsd || 0; acc.bankKhr += r.bankKhr || 0;
                    acc.cashExchangeKhr += r.cashExchangeKhr || 0; acc.cashExchangeUsd += r.cashExchangeUsd || 0;
                    acc.netSale += r.grandTotalKhr || 0;
                    return acc;
                }, { cashUsd: 0, cashKhr: 0, bankUsd: 0, bankKhr: 0, cashExchangeKhr: 0, cashExchangeUsd: 0, netSale: 0 });

                return { filteredAndAggregatedData: { type, data }, totals };
            }, [reports, filters, userData, availableShops]);
        };
        
        /******************************************************************************
         * 5. UI COMPONENTS
         *****************************************************************************/
        
        const Icon = React.memo(({ name, className = "w-5 h-5" }) => {
            const icons = {
                loader: <svg className={`${className} animate-spin`} xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle><path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>,
                note: <svg className={className} xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.5L15.232 5.232z" /></svg>,
                trash: <svg className={className} xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>,
                logout: <svg className={className} xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" d="M15.75 9V5.25A2.25 2.25 0 0013.5 3h-6a2.25 2.25 0 00-2.25 2.25v13.5A2.25 2.25 0 007.5 21h6a2.25 2.25 0 002.25-2.25V15m3 0l-3-3m0 0l-3 3m3-3V9" /></svg>,
                eye: <svg className={className} xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" d="M2.036 12.322a1.012 1.012 0 010-.639C3.423 7.51 7.36 4.5 12 4.5c4.638 0 8.573 3.007 9.963 7.178.07.207.07.431 0 .639C20.577 16.49 16.64 19.5 12 19.5c-4.638 0-8.573-3.007-9.963-7.178z" /><path strokeLinecap="round" strokeLinejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>,
                'eye-off': <svg className={className} xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" d="M3.98 8.223A10.477 10.477 0 001.934 12C3.226 16.338 7.244 19.5 12 19.5c.993 0 1.953-.138 2.863-.395M6.228 6.228A10.45 10.45 0 0112 4.5c4.756 0 8.773 3.162 10.065 7.498a10.523 10.523 0 01-4.293 5.774M6.228 6.228L3 3m3.228 3.228l3.65 3.65m7.894 7.894L21 21m-3.228-3.228l-3.65-3.65m0 0a3 3 0 10-4.243-4.243m4.243 4.243L6.228 6.228" /></svg>,
                install: <svg className={className} xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5M16.5 12L12 16.5m0 0L7.5 12m4.5 4.5V3" /></svg>,
                export: <svg className={className} xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" d="M12 9.75v6.75m0 0l-3-3m3 3l3-3m-8.25 6a4.5 4.5 0 01-1.41-8.775 5.25 5.25 0 0110.233-2.33 3 3 0 013.758 3.848A3.752 3.752 0 0118 19.5H6.75z" /></svg>,
                'document-text': <svg className={className} xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m0 12.75h7.5m-7.5 3H12M10.5 2.25H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 00-9-9z" /></svg>,
                palette: <svg className={className} xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" d="M4.098 19.902a3.75 3.75 0 005.304 0l6.401-6.402M6.75 21A3.75 3.75 0 013 17.25V4.125C3 3.504 3.504 3 4.125 3h5.25c.621 0 1.125.504 1.125 1.125v4.072M6.75 21a3.75 3.75 0 003.75-3.75V8.197M6.75 21h13.125c.621 0 1.125-.504 1.125-1.125V4.125C21 3.504 20.496 3 19.875 3H17.25z" /></svg>,
                plus: <svg className={className} xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" d="M12 4.5v15m7.5-7.5h-15" /></svg>,
                landmark: <svg className={className} xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" d="M12 21v-8.25M15.75 21v-8.25M8.25 21v-8.25M3 9l9-6 9 6m-1.5 12V10.332A48.36 48.36 0 0012 9.75c-2.551 0-5.056.2-7.5.582V21M3 21h18M12 6.75h.008v.008H12V6.75z" /></svg>
            };
            return icons[name] || null;
        });

        const LoadingSpinner = () => <div className="flex justify-center items-center h-screen"><Icon name="loader" className="w-12 h-12 text-[var(--accent-color)]" /></div>;
        
        const Modal = ({ children, onClose, isOpen, title }) => {
            if (!isOpen) return null;
            return <div className="fixed inset-0 bg-black bg-opacity-70 z-50 flex justify-center items-center p-4" onClick={onClose}><div className="bg-[var(--background-secondary)] border border-[var(--border-color)] rounded-lg shadow-xl w-full max-w-md flex flex-col max-h-[90vh]" onClick={e => e.stopPropagation()}>{children}</div></div>;
        };
        const ModalHeader = ({ children }) => <div className="p-6 border-b border-[var(--border-color)]"><h3 className="text-lg font-bold text-[var(--text-primary)]">{children}</h3></div>;
        const ModalBody = ({ children, className = "" }) => <div className={`p-6 flex-grow overflow-y-auto ${className}`}>{children}</div>;
        const ModalFooter = ({ children }) => <div className="bg-[var(--background-primary)]/50 px-6 py-3 flex justify-end items-center gap-3 border-t border-[var(--border-color)] sticky bottom-0 rounded-b-lg">{children}</div>;
        
        const FormInput = React.memo(({ label, name, ...props }) => <div><label htmlFor={name} className="block text-sm font-medium text-[var(--text-secondary)] mb-1">{label}</label><input id={name} name={name} {...props} className="block w-full px-3 py-2 bg-[var(--background-input)] border border-[var(--border-color)] rounded-lg shadow-sm placeholder-[var(--text-secondary)] focus:outline-none focus:ring-2 focus:ring-[var(--accent-color)] text-[var(--text-primary)] disabled:bg-[var(--background-secondary)] disabled:text-[var(--text-secondary)]" /></div>);
        const FormTextarea = React.memo(({ label, name, ...props }) => <div><label htmlFor={name} className="block text-sm font-medium text-[var(--text-secondary)] mb-1">{label}</label><textarea id={name} name={name} {...props} className="block w-full px-3 py-2 bg-[var(--background-input)] border border-[var(--border-color)] rounded-lg shadow-sm placeholder-[var(--text-secondary)] focus:outline-none focus:ring-2 focus:ring-[var(--accent-color)] text-[var(--text-primary)] disabled:bg-[var(--background-secondary)] disabled:text-[var(--text-secondary)] min-h-[80px]" /></div>);
        const FormSelect = React.memo(({ label, name, options, ...props }) => <div><label htmlFor={name} className="block text-sm font-medium text-[var(--text-secondary)] mb-1">{label}</label><select id={name} name={name} {...props} className="block w-full px-3 py-2 bg-[var(--background-input)] border border-[var(--border-color)] rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-[var(--accent-color)] text-[var(--text-primary)]">{options.map(o => <option key={o.value} value={o.value}>{o.label}</option>)}</select></div>);
        
        // NEW COMPONENT: Smart Currency Input (Handles Formatting + Math)
        const SmartCurrencyInput = ({ value, onChange, ...props }) => {
            const handleChange = (e) => {
                const raw = e.target.value;
                // If input contains math operators, don't format yet (allow user to type equation)
                if (/[+\-*/]/.test(raw)) {
                    onChange({ target: { name: props.name, value: raw } });
                } else {
                    // Otherwise, apply standard currency formatting immediately
                    const formatted = formatInputAsCurrency(raw);
                    onChange({ target: { name: props.name, value: formatted } });
                }
            };

            const handleBlur = (e) => {
                const raw = e.target.value;
                // Check if it looks like a math expression
                if (/[+\-*/]/.test(raw)) {
                    try {
                        // 1. Sanitize: Remove commas (they break math) and allow only numbers/operators
                        const safeMath = raw.replace(/,/g, '').replace(/[^0-9+\-*/().]/g, '');
                        if (!safeMath) return;

                        // 2. Calculate
                        // eslint-disable-next-line no-new-func
                        const result = Function('"use strict";return (' + safeMath + ')')();
                        
                        if (isFinite(result)) {
                            // 3. Format Result
                            onChange({ target: { name: props.name, value: formatInputAsCurrency(String(result)) } });
                        }
                    } catch (err) {
                        // On error, just format what we have as best as possible
                        onChange({ target: { name: props.name, value: formatInputAsCurrency(raw) } });
                    }
                } else {
                    // Ensure crisp formatting on blur
                    onChange({ target: { name: props.name, value: formatInputAsCurrency(raw) } });
                }
                if (props.onBlur) props.onBlur(e);
            };

            return (
                <FormInput 
                    {...props} 
                    value={value} 
                    onChange={handleChange} 
                    onBlur={handleBlur} 
                    placeholder="0" // Default placeholder
                />
            );
        };

        const CurrencyInputGroup = React.memo(({ title, khrName, usdName, khrValue, usdValue, onChange }) => {
            const { t } = useTranslation();
            return (
                <div>
                    <h3 className="text-md font-semibold text-[var(--text-secondary)]">{title}</h3>
                    <div className="grid grid-cols-1 sm:grid-cols-2 gap-4 mt-2">
                        <SmartCurrencyInput label={t('khrLabel')} name={khrName} value={khrValue} onChange={onChange} />
                        <SmartCurrencyInput label={t('usdLabel')} name={usdName} value={usdValue} onChange={onChange} />
                    </div>
                </div>
            )
        });

        const ThemeSwitcher = () => {
            const { theme, setTheme } = useTheme();
            const [isOpen, setIsOpen] = useState(false);
            const popoverRef = useRef(null);
            const themes = [{ name: 'dark', color: '#0f172a', label: 'Slate Blue' }, { name: 'light', color: '#ffffff', label: 'Light' }, { name: 'charcoal', color: '#171717', label: 'Charcoal' }, { name: 'nord', color: '#2E3440', label: 'Nord' }, { name: 'sunset', color: '#451a03', label: 'Sunset' }, { name: 'forest', color: '#1a2e2c', label: 'Forest' }, { name: 'ocean', color: '#0e2a47', label: 'Ocean' }, { name: 'lavender', color: '#2b234a', label: 'Lavender' }, { name: 'rose', color: '#3d1c2b', label: 'Rosé' }, { name: 'grayscale', color: '#171717', label: 'Grayscale' }];
            useEffect(() => {
                const handleClickOutside = (event) => { if (popoverRef.current && !popoverRef.current.contains(event.target)) setIsOpen(false); };
                if (isOpen) document.addEventListener('mousedown', handleClickOutside);
                return () => document.removeEventListener('mousedown', handleClickOutside);
            }, [isOpen]);
            return (
                <div className="relative">
                    <button onClick={() => setIsOpen(!isOpen)} className="bg-[var(--background-input)]/50 p-2 rounded-lg text-[var(--text-secondary)] hover:text-[var(--text-primary)] hover:bg-[var(--background-input)] focus:outline-none" title="Change theme"><Icon name="palette" className="w-5 h-5" /><span className="sr-only">Change theme</span></button>
                    {isOpen && (<div ref={popoverRef} className="absolute right-0 top-12 z-50 w-64 p-4 bg-[var(--background-secondary)] border border-[var(--border-color)] rounded-lg shadow-2xl"><span className="text-sm font-medium text-[var(--text-secondary)] mb-3 block">Select Theme</span><div className="grid grid-cols-5 gap-3">{themes.map((themeOption) => (<button key={themeOption.name} title={themeOption.label} onClick={() => {setTheme(themeOption.name); setIsOpen(false);}} className={`w-8 h-8 rounded-full focus:outline-none transition-all ${theme === themeOption.name ? 'ring-2 ring-offset-2 ring-[var(--accent-color)] ring-offset-[var(--background-secondary)]' : 'ring-1 ring-gray-500/50 hover:ring-2 hover:ring-[var(--accent-color)]/70'} ${themeOption.name === 'light' ? 'border border-[var(--border-color)]' : ''}`} style={{ backgroundColor: themeOption.color }}><span className="sr-only">{themeOption.label}</span></button>))}</div></div>)}
                </div>
            );
        }
        
        const ConfirmationModal = ({ isOpen, onClose, onConfirm, isSubmitting, title, message, confirmText, confirmColor = 'accent' }) => {
            const { t } = useTranslation();
            const colorClasses = { accent: "bg-[var(--accent-color)] hover:bg-[var(--accent-color-hover)] text-white", red: "bg-[var(--semantic-red)] hover:bg-[var(--semantic-red-hover)] text-white" };
            return (<Modal isOpen={isOpen} onClose={onClose}><ModalHeader>{title}</ModalHeader><ModalBody><p className="text-sm text-[var(--text-secondary)]">{message}</p></ModalBody><ModalFooter><button onClick={onClose} disabled={isSubmitting} className="px-4 py-2 text-sm font-medium text-[var(--text-primary)] bg-[var(--background-input)] border border-[var(--border-color)] rounded-md hover:brightness-110 disabled:opacity-50">{t('cancelButton')}</button><button onClick={onConfirm} disabled={isSubmitting} className={`px-4 py-2 text-sm font-medium rounded-md disabled:opacity-50 flex items-center gap-2 ${colorClasses[confirmColor]}`}>{isSubmitting && <Icon name="loader" className="w-4 h-4" />}{confirmText}</button></ModalFooter></Modal>);
        };
        
        /******************************************************************************
         * UPDATED: Daily Expense Modal (From File Integration)
         *****************************************************************************/
        const DailyExpenseModal = ({ onClose, isOpen, expenseToEdit }) => {
            const { shops, businessCategories } = useAppContext();
            const { userData } = useAuth();
            const { t } = useTranslation();
            const { showToast } = useToast();
            const [isSubmitting, setIsSubmitting] = useState(false);
            const isMounted = useRef(true);

            // NEW: Quick Add Presets (Updated: All categories set to 'Shop Monthly')
            const EXPENSE_PRESETS = [
                { label: '🍪 Snack', name: 'Snack', category: 'Shop Monthly' },
                { label: '🥣 Monk\'s Bowl', name: 'Monk\'s Bowl', category: 'Shop Monthly' },
                { label: '📎 Office Stuff', name: 'Office Stuff', category: 'Shop Monthly' },
                { label: '🍱 Staff Meal', name: 'Staff Meal', category: 'Shop Monthly' },
                { label: '🛺 TukTuk', name: 'Transportation', category: 'Shop Monthly' },
                // Updated Cleaning to Staff Entertainment
                { label: '🎉 Staff Entertainment', name: 'Staff Entertainment', category: 'Shop Monthly' }
            ];

            useEffect(() => {
                isMounted.current = true;
                return () => { isMounted.current = false; };
            }, []);

            const availableShops = useMemo(() => {
                if (!userData) return [];
                if (userData.role === ROLES.ADMIN || userData.role === ROLES.MANAGEMENT) return shops;
                return shops.filter(s => userData.shopIds?.includes(s.id));
            }, [shops, userData]);

            const [formData, setFormData] = useState({
                date: new Date().toISOString().split('T')[0],
                shop: availableShops[0]?.name || '',
                itemName: '', category: 'Shop Monthly', qty: '1', price: '', note: ''
            });

            // Effect to populate form data when editing
            useEffect(() => {
                if (isOpen && expenseToEdit) {
                    setFormData({
                        date: expenseToEdit.date ? new Date(expenseToEdit.date).toISOString().split('T')[0] : new Date().toISOString().split('T')[0],
                        shop: expenseToEdit.shop || availableShops[0]?.name || '',
                        itemName: expenseToEdit.itemName || '',
                        category: expenseToEdit.category || 'Shop Monthly',
                        qty: String(expenseToEdit.qty || '1'),
                        price: formatInputAsCurrency(String(expenseToEdit.price || '')),
                        note: expenseToEdit.note || ''
                    });
                } else if (isOpen) {
                    // Reset to default for new entry
                    setFormData({
                        date: new Date().toISOString().split('T')[0],
                        shop: availableShops[0]?.name || '',
                        itemName: '', category: 'Shop Monthly', qty: '1', price: '', note: ''
                    });
                }
            }, [isOpen, expenseToEdit, availableShops]);

            const handleChange = (e) => {
                const { name, value } = e.target;
                // Simplified: SmartCurrencyInput handles formatting, we just store value
                setFormData(prev => ({ ...prev, [name]: value }));
            };

            const handlePresetClick = (preset) => {
                setFormData(prev => ({
                    ...prev,
                    itemName: preset.name,
                    category: preset.category
                }));
            };

            const handleSubmit = async (e) => {
                e.preventDefault();
                if (!formData.shop || !formData.category || !formData.price) {
                    showToast("Please fill in required fields.", "error");
                    return;
                }

                setIsSubmitting(true);
                try {
                    const qty = parseFloat(formData.qty) || 1;
                    const price = parseFloat(formData.price.replace(/,/g, '')) || 0;
                    const total = qty * price;

                    const expenseData = {
                        date: createTimestampFromDateAndCurrentTime(formData.date),
                        shop: formData.shop,
                        itemName: formData.itemName,
                        category: formData.category,
                        qty: qty,
                        price: price,
                        amountKhr: total, totalAmountKhr: total, amountUsd: 0,
                        note: formData.note,
                        type: 'Business',
                        // Only set submittedBy on creation, not update
                        ...(!expenseToEdit && { submittedBy: userData.uid, recordedBy: userData.name, createdAt: firebaseService.getTimestamp().now() })
                    };

                    if (expenseToEdit) {
                        await firebaseService.updateExpense(expenseToEdit.id, expenseData);
                        showToast(t('expenseUpdateSuccess'), 'success');
                    } else {
                        await firebaseService.addExpense(expenseData);
                        showToast(t('expenseSuccess'), 'success');
                    }
                    if (isMounted.current) onClose();
                } catch (error) {
                    console.error(error);
                    showToast('Failed to save expense', 'error');
                } finally {
                    if (isMounted.current) setIsSubmitting(false);
                }
            };

            const totalPreview = (parseFloat(formData.qty) || 0) * (parseFloat(formData.price.replace(/,/g, '')) || 0);

            return (
                <Modal isOpen={isOpen} onClose={onClose}>
                    <ModalHeader>{expenseToEdit ? t('editExpenseButton') : t('addExpenseButton')}</ModalHeader>
                    <form onSubmit={handleSubmit}>
                        <ModalBody className="space-y-4">
                            {/* NEW: Quick Add Presets Section */}
                            {!expenseToEdit && (
                                <div className="mb-4">
                                    <label className="block text-xs font-semibold text-[var(--text-secondary)] uppercase tracking-wider mb-2">Quick Add</label>
                                    <div className="flex flex-wrap gap-2">
                                        {EXPENSE_PRESETS.map((preset) => (
                                            <button
                                                key={preset.label}
                                                type="button"
                                                onClick={() => handlePresetClick(preset)}
                                                className="px-3 py-1.5 bg-[var(--background-input)] hover:bg-[var(--accent-color)] hover:text-white border border-[var(--border-color)] rounded-full text-xs font-medium transition-colors duration-200 flex items-center gap-1 text-[var(--text-primary)]"
                                            >
                                                {preset.label}
                                            </button>
                                        ))}
                                    </div>
                                </div>
                            )}

                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <FormInput label={t('dateLabel')} type="date" name="date" value={formData.date} onChange={handleChange} required />
                                <FormSelect label={t('shopLabel')} name="shop" value={formData.shop} onChange={handleChange} options={availableShops.map(s => ({value: s.name, label: s.name}))} required />
                            </div>
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <FormInput label={t('itemNameLabel')} name="itemName" value={formData.itemName} onChange={handleChange} required />
                                <FormSelect label={t('categoryLabel')} name="category" value={formData.category} onChange={handleChange} options={[{value:'', label: t('categoryLabel')}, ...businessCategories.map(c => ({value: c.name, label: c.name}))]} required />
                            </div>
                            <div className="bg-[var(--background-primary)] p-3 rounded-lg border border-[var(--border-color)] grid grid-cols-1 md:grid-cols-3 gap-4">
                                <FormInput label={t('quantityLabel')} type="number" name="qty" value={formData.qty} onChange={handleChange} required />
                                {/* Updated to SmartCurrencyInput */}
                                <SmartCurrencyInput label={`${t('priceLabel')} (៛)`} name="price" value={formData.price} onChange={handleChange} required />
                                <div className="flex flex-col justify-end">
                                    <span className="text-sm text-[var(--text-secondary)] mb-1">{t('totalLabel')}</span>
                                    <div className="h-[42px] flex items-center px-3 font-bold text-lg font-mono text-[var(--semantic-green)] bg-[var(--background-input)] rounded border border-[var(--border-color)]">
                                        {formatCurrency(totalPreview, 'KHR')}
                                    </div>
                                </div>
                            </div>
                            <FormTextarea label={t('noteLabel')} name="note" value={formData.note} onChange={handleChange} placeholder={t('notePlaceholder')} />
                        </ModalBody>
                        <ModalFooter>
                            <button type="button" onClick={onClose} disabled={isSubmitting} className="px-4 py-2 text-sm font-medium text-[var(--text-primary)] bg-[var(--background-input)] border border-[var(--border-color)] rounded-md hover:brightness-110">{t('cancelButton')}</button>
                            <button type="submit" disabled={isSubmitting} className="px-4 py-2 text-sm font-medium text-white bg-[var(--accent-color)] rounded-md hover:bg-[var(--accent-color-hover)] disabled:opacity-50 flex items-center gap-2">
                                {isSubmitting && <Icon name="loader" className="w-4 h-4" />}{expenseToEdit ? t('saveChangesButton') : t('addExpenseButton')}
                            </button>
                        </ModalFooter>
                    </form>
                </Modal>
            );
        };

        /******************************************************************************
         * UPDATED: Daily Operation Expense Tab (From File Integration)
         *****************************************************************************/
        const DailyOperationExpenseTab = () => {
            const { businessExpenses, shops, fetchExpensesInRange, resetExpensesFetch } = useAppContext();
            const { userData } = useAuth();
            const { t } = useTranslation();
            const { showToast } = useToast();
            const [isModalOpen, setIsModalOpen] = useState(false);
            const [expenseToEdit, setExpenseToEdit] = useState(null);
            const [expenseToDelete, setExpenseToDelete] = useState(null);
            const [noteToView, setNoteToView] = useState(null); // Added state for viewing notes
            const [isDeleting, setIsDeleting] = useState(false);
            
            // Initial filter state
            const [filters, setFilters] = useState({ 
                month: new Date().toISOString().slice(0, 7), 
                shop: '', 
                search: '' 
            });
            const availableShops = useAvailableShops();

            // Permissions: Updated to allow ALL users to modify expenses
            const canModify = !!userData; 

            // Effect: When Month filter changes, fetch data from server
            useEffect(() => {
                if (filters.month) {
                    const [year, month] = filters.month.split('-');
                    const start = new Date(year, month - 1, 1);
                    const end = new Date(year, month, 0, 23, 59, 59, 999);
                    fetchExpensesInRange(start, end);
                } else {
                    resetExpensesFetch();
                }
            }, [filters.month, fetchExpensesInRange, resetExpensesFetch]);

            // Filter expenses locally (Search & Shop)
            const expenseList = useMemo(() => {
                if (!userData) return [];
                const userShopNames = (userData.role === ROLES.ADMIN || userData.role === ROLES.MANAGEMENT) ? null : availableShops.map(s => s.name);
                
                return businessExpenses.filter(e => {
                    if (e.type !== 'Business') return false;
                    
                    const dateObj = e.date; 
                    if (!dateObj) return false;

                    // Note: Month filter is handled by server fetch now, but keeping double check doesn't hurt
                    const monthStr = dateObj.toISOString().slice(0, 7);
                    if (filters.month && monthStr !== filters.month) return false;
                    
                    if (filters.shop && e.shop !== filters.shop) return false;
                    if (userShopNames && !userShopNames.includes(e.shop)) return false;
                    
                    if (filters.search) {
                        const term = filters.search.toLowerCase();
                        if (!e.itemName?.toLowerCase().includes(term) && !e.note?.toLowerCase().includes(term) && !e.category?.toLowerCase().includes(term)) return false;
                    }
                    return true;
                }).sort((a,b) => (b.date?.getTime() || 0) - (a.date?.getTime() || 0));
            }, [businessExpenses, userData, shops, filters, availableShops]);

            const totalAmount = useMemo(() => expenseList.reduce((sum, item) => sum + (item.amountKhr || item.totalAmountKhr || 0), 0), [expenseList]);
            
            const shopTotals = useMemo(() => expenseList.reduce((acc, item) => {
                const shopName = item.shop || 'Unknown';
                acc[shopName] = (acc[shopName] || 0) + (item.amountKhr || item.totalAmountKhr || 0);
                return acc;
            }, {}), [expenseList]);

            const getShopColor = (index) => {
                // Using semantic colors with opacity to match app theme
                const colors = [
                    'bg-blue-500/10 border-blue-500/30 text-blue-400',
                    'bg-emerald-500/10 border-emerald-500/30 text-emerald-400',
                    'bg-purple-500/10 border-purple-500/30 text-purple-400',
                    'bg-amber-500/10 border-amber-500/30 text-amber-400',
                    'bg-pink-500/10 border-pink-500/30 text-pink-400',
                    'bg-cyan-500/10 border-cyan-500/30 text-cyan-400',
                ];
                return colors[index % colors.length];
            };

            const handleConfirmDelete = async () => {
                if(!expenseToDelete) return;
                setIsDeleting(true);
                try {
                    await firebaseService.deleteExpense(expenseToDelete.id);
                    showToast(t('expenseDeleteSuccess'), 'success');
                    setExpenseToDelete(null);
                } catch (e) { 
                    console.error(e);
                    showToast('Failed to delete', 'error'); 
                } finally {
                    setIsDeleting(false);
                }
            };

            const openEditModal = (expense) => {
                setExpenseToEdit(expense);
                setIsModalOpen(true);
            };

            const openAddModal = () => {
                setExpenseToEdit(null);
                setIsModalOpen(true);
            }

            return (
                <div className="space-y-6">
                    {/* Header: Title & Total */}
                    <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-6 border-b border-[var(--border-color)] pb-4">
                        <h3 className="text-lg font-bold text-[var(--text-primary)]">{t('expenseHeader')}</h3>
                        {userData?.role !== ROLES.STAFF && (
                            <div className="bg-[var(--background-secondary)] border border-[var(--border-color)] px-4 py-2 rounded-lg flex items-center gap-3">
                                <span className="text-[var(--text-secondary)] text-sm uppercase tracking-wider font-semibold">{t('grandTotalLabel')}:</span>
                                <span className="text-xl font-bold font-mono text-[var(--text-primary)]">{formatCurrency(totalAmount, 'KHR')}</span>
                            </div>
                        )}
                    </div>

                    {/* Shop Sub-Total Cards */}
                    {Object.keys(shopTotals).length > 0 && (
                        <div className="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-5 gap-4">
                            {Object.entries(shopTotals).map(([shopName, total], index) => (
                                <div key={shopName} className={`p-4 rounded-lg border flex flex-col justify-between ${getShopColor(index)}`}>
                                    <div className="flex items-center gap-2 mb-2">
                                        <Icon name="landmark" className="opacity-70 w-4 h-4" />
                                        <p className="text-xs font-bold uppercase opacity-90 truncate" title={shopName}>{shopName}</p>
                                    </div>
                                    <p className="text-lg font-bold font-mono">{formatCurrency(total, 'KHR')}</p>
                                </div>
                            ))}
                        </div>
                    )}

                    {/* Filters & Actions */}
                    <div className="grid grid-cols-1 md:grid-cols-12 gap-4 items-end bg-[var(--background-secondary)]/30 p-4 rounded-lg border border-[var(--border-color)]">
                        <div className="md:col-span-3"><FormInput label={t('dueTimeLabel')} type="month" value={filters.month} onChange={e => setFilters(p => ({...p, month: e.target.value}))} /></div>
                        <div className="md:col-span-3"><FormSelect label={t('shopLabel')} value={filters.shop} onChange={e => setFilters(p => ({...p, shop: e.target.value}))} options={[{value: '', label: t('allShops')}, ...availableShops.map(s => ({value: s.name, label: s.name}))]} /></div>
                        <div className="md:col-span-4"><FormInput label="Search" placeholder="Search..." value={filters.search} onChange={e => setFilters(p => ({...p, search: e.target.value}))} /></div>
                        <div className="md:col-span-2"><button onClick={openAddModal} className="w-full bg-[var(--accent-color)] hover:bg-[var(--accent-color-hover)] text-white font-bold py-2.5 px-4 rounded-lg flex items-center justify-center gap-2"><Icon name="plus" /> {t('addExpenseButton')}</button></div>
                    </div>

                    {/* Table */}
                    <div className="bg-[var(--background-secondary)]/50 border border-[var(--border-color)] rounded-lg overflow-hidden">
                        <div className="overflow-x-auto">
                            <table className="w-full text-sm text-left">
                                <thead className="bg-[var(--background-primary)]/50 text-xs text-[var(--text-secondary)] uppercase">
                                    <tr>
                                        {/* Changed header from dateLabel to dateTimeHeader */}
                                        <th className="p-3">{t('dateTimeHeader')}</th>
                                        <th className="p-3">{t('shopLabel')}</th><th className="p-3">{t('itemNameLabel')}</th><th className="p-3">{t('categoryLabel')}</th>
                                        <th className="p-3 text-right">{t('quantityLabel')}</th><th className="p-3 text-right">{t('priceLabel')} (៛)</th><th className="p-3 text-right">{t('totalLabel')} (៛)</th>
                                        <th className="p-3">{t('recordedByHeader')}</th><th className="p-3 text-center">{t('actionsHeader')}</th>
                                    </tr>
                                </thead>
                                <tbody className="divide-y divide-[var(--border-color)]">
                                    {expenseList.length === 0 ? <tr><td colSpan="9" className="p-8 text-center text-[var(--text-secondary)]">{t('noReportsFound')}</td></tr> : expenseList.map(item => (
                                        <tr key={item.id} className="hover:bg-[var(--border-color)]/30">
                                            {/* Updated date cell formatting */}
                                            <td className="p-3 whitespace-nowrap text-[var(--text-secondary)] font-mono">{formatExpenseDateTime(item.date)}</td>
                                            <td className="p-3 text-[var(--text-primary)]">{item.shop}</td>
                                            <td className="p-3 font-medium text-[var(--text-primary)]">{item.itemName || item.note || '-'}</td>
                                            <td className="p-3"><span className="bg-[var(--background-input)] px-2 py-1 rounded text-xs text-[var(--text-secondary)]">{item.category}</span></td>
                                            <td className="p-3 text-right font-mono text-[var(--text-primary)]">{item.qty || 1}</td>
                                            <td className="p-3 text-right font-mono text-[var(--text-primary)]">{item.price ? formatCurrency(item.price, 'KHR') : '-'}</td>
                                            <td className="p-3 text-right font-bold font-mono text-[var(--semantic-red)]">{formatCurrency(item.amountKhr || item.totalAmountKhr, 'KHR')}</td>
                                            <td className="p-3 text-xs text-[var(--text-secondary)]">{item.recordedBy}</td>
                                            <td className="p-3 text-center flex items-center justify-center gap-2">
                                                {/* Note Icon Action */}
                                                {item.note && (
                                                    <button 
                                                        onClick={() => setNoteToView(item.note)} 
                                                        className="p-1 text-[var(--semantic-yellow)] hover:opacity-80" 
                                                        title="View Note"
                                                    >
                                                        <Icon name="document-text"/>
                                                    </button>
                                                )}
                                                <button onClick={() => openEditModal(item)} disabled={!canModify} className="p-1 text-[var(--accent-color)] hover:text-[var(--accent-color-hover)] disabled:text-slate-600 disabled:cursor-not-allowed" title="Edit"><Icon name="note"/></button>
                                                <button onClick={() => setExpenseToDelete(item)} disabled={!canModify} className="p-1 text-[var(--semantic-red)] hover:text-[var(--semantic-red-hover)] disabled:text-slate-600 disabled:cursor-not-allowed" title="Delete"><Icon name="trash"/></button>
                                            </td>
                                        </tr>
                                    ))}
                                </tbody>
                                {/* Footer Row */}
                                {expenseList.length > 0 && userData?.role !== ROLES.STAFF && (
                                    <tfoot className="bg-[var(--background-secondary)] font-bold">
                                        <tr>
                                            <td colSpan="6" className="p-3 text-right text-[var(--text-primary)]">{t('grandTotalLabel')}:</td>
                                            <td className="p-3 text-right font-mono text-[var(--semantic-red)]">{formatCurrency(totalAmount, 'KHR')}</td>
                                            <td colSpan="2"></td>
                                        </tr>
                                    </tfoot>
                                )}
                            </table>
                        </div>
                    </div>
                    
                    {/* Add/Edit Modal */}
                    <DailyExpenseModal isOpen={isModalOpen} onClose={() => setIsModalOpen(false)} expenseToEdit={expenseToEdit} />
                    
                    {/* Delete Confirmation Modal */}
                    {expenseToDelete && (
                        <ConfirmationModal 
                            isOpen={!!expenseToDelete} 
                            onClose={() => setExpenseToDelete(null)} 
                            onConfirm={handleConfirmDelete} 
                            isSubmitting={isDeleting} 
                            title={t('confirmDeletionTitle')} 
                            message={t('confirmExpenseDelete')} 
                            confirmText={t('deleteButton')} 
                            confirmColor="red" 
                        />
                    )}

                    {/* Note View Modal */}
                    <NoteViewModal isOpen={!!noteToView} onClose={() => setNoteToView(null)} note={noteToView}/>
                </div>
            );
        };

        const CustomDateRangeModal = ({ isOpen, onClose, onApply }) => {
            const { t } = useTranslation();
            const [dates, setDates] = useState({ startDate: '', endDate: '' });
            return (<Modal isOpen={isOpen} onClose={onClose}><ModalHeader>{t('customDateTitle')}</ModalHeader><ModalBody><div className="space-y-4"><FormInput label={t('startDateLabel')} type="date" value={dates.startDate} onChange={e => setDates(d => ({...d, startDate: e.target.value}))} /><FormInput label={t('endDateLabel')} type="date" value={dates.endDate} onChange={e => setDates(d => ({...d, endDate: e.target.value}))} /></div></ModalBody><ModalFooter><button onClick={onClose} className="px-4 py-2 text-sm font-medium text-[var(--text-primary)] bg-[var(--background-input)] border border-[var(--border-color)] rounded-md hover:brightness-110">{t('cancelButton')}</button><button onClick={() => {onApply(dates); onClose();}} className="px-4 py-2 text-sm font-medium text-white bg-[var(--accent-color)] rounded-md hover:bg-[var(--accent-color-hover)]">{t('applyButton')}</button></ModalFooter></Modal>);
        };

        const EditReportModal = ({ isOpen, onClose, onSave, report, isSubmitting, shops }) => {
            const { t } = useTranslation();
            const [formData, setFormData] = useState({});
            useEffect(() => {
                if (report) {
                    setFormData({ ...report,
                        date: report.createdAt?.toISOString().split('T')[0] || '', // Optimized: createdAt is already Date
                        cashUsd: String(report.cashUsd || ''), cashKhr: String(report.cashKhr || ''),
                        bankUsd: String(report.bankUsd || ''), bankKhr: String(report.bankKhr || ''),
                        cashExchangeKhr: String(report.cashExchangeKhr || ''), cashExchangeUsd: String(report.cashExchangeUsd || ''),
                        note: report.note || '',
                    });
                } else setFormData({});
            }, [report]);
            const handleFormChange = (e) => {
                const { name, value } = e.target;
                // Simplified: SmartCurrencyInput handles formatting
                setFormData(prev => ({ ...prev, [name]: value }));
            };
            return (<Modal isOpen={isOpen} onClose={onClose}><ModalHeader>{t('editReportTitle')}</ModalHeader><form onSubmit={(e) => { e.preventDefault(); onSave(formData); }}><ModalBody className="space-y-4"><FormInput label={t('dateLabel')} type="date" name="date" value={formData.date || ''} onChange={handleFormChange} required /><FormSelect label={t('shopLabel')} name="shop" value={formData.shop || ''} onChange={handleFormChange} options={shops.map(s => ({value: s.name, label: s.name}))} required /><FormInput label={t('staffLabel')} name="staff" value={formData.staff || ''} disabled /><FormSelect label={t('shiftLabel')} name="shift" value={formData.shift || 'AM'} onChange={handleFormChange} options={[{value:'AM', label:'AM'}, {value:'PM', label:'PM'}]} /><CurrencyInputGroup title={t('byCashTitle')} khrName="cashKhr" usdName="cashUsd" khrValue={formData.cashKhr || ''} usdValue={formData.cashUsd || ''} onChange={handleFormChange} /><CurrencyInputGroup title={t('byBankTitle')} khrName="bankKhr" usdName="bankUsd" khrValue={formData.bankKhr || ''} usdValue={formData.bankUsd || ''} onChange={handleFormChange} /><CurrencyInputGroup title={t('cashExchangeTitle')} khrName="cashExchangeKhr" usdName="cashExchangeUsd" khrValue={formData.cashExchangeKhr || ''} usdValue={formData.cashExchangeUsd || ''} onChange={handleFormChange} /><FormInput label={t('noteLabel')} name="note" value={formData.note || ''} onChange={handleFormChange} placeholder={t('notePlaceholder')}/></ModalBody><ModalFooter><button type="button" onClick={onClose} disabled={isSubmitting} className="px-4 py-2 text-sm font-medium text-[var(--text-primary)] bg-[var(--background-input)] border border-[var(--border-color)] rounded-md hover:brightness-110">{t('cancelButton')}</button><button type="submit" disabled={isSubmitting} className="px-4 py-2 text-sm font-medium text-white bg-[var(--accent-color)] rounded-md hover:bg-[var(--accent-color-hover)] disabled:opacity-50 flex items-center gap-2">{isSubmitting && <Icon name="loader" className="w-4 h-4" />} {t('saveChangesButton')}</button></ModalFooter></form></Modal>);
        };
        const NoteViewModal = ({ isOpen, onClose, note }) => (<Modal isOpen={isOpen} onClose={onClose}><ModalHeader>Note</ModalHeader><ModalBody><p className="text-[var(--text-secondary)] whitespace-pre-wrap">{note}</p></ModalBody><ModalFooter><button type="button" onClick={onClose} className="px-4 py-2 text-sm font-medium text-[var(--text-primary)] bg-[var(--background-input)] border border-[var(--border-color)] rounded-md hover:brightness-110">Close</button></ModalFooter></Modal>);
        
        // UPDATED: SummaryContent now accepts frozenTime to stop the clock
        const SummaryContent = React.memo(({ formData, grandTotal, frozenTime }) => {
            const { t } = useTranslation();
            const [currentTime, setCurrentTime] = useState(frozenTime || new Date());
            
            useEffect(() => { 
                if (frozenTime) {
                    setCurrentTime(frozenTime);
                    return;
                }
                const timerId = setInterval(() => setCurrentTime(new Date()), 1000); 
                return () => clearInterval(timerId); 
            }, [frozenTime]);

            return (<div className="bg-[var(--background-secondary)]/50 border border-[var(--border-color)] p-6 rounded-lg shadow-lg space-y-4"><div className="border-b border-[var(--border-color)] pb-4"><h3 className="text-xl font-semibold text-[var(--text-primary)] text-center">{t('summaryTitle')}</h3><div className="text-center text-sm mt-2"><p className="font-semibold text-[var(--text-secondary)]"><span className="font-sans">{formData.date}</span><span className="mx-2 text-[var(--text-secondary)]/50">|</span><span className="font-mono">{currentTime.toLocaleTimeString('en-GB', { timeZone: 'Asia/Phnom_Penh', hour: '2-digit', minute: '2-digit', second: '2-digit' })}</span></p></div></div><div className="space-y-2 text-sm pt-2"><div className="flex justify-between items-center"><span className="text-[var(--text-secondary)]">{t('shopLabel')}:</span><span className="font-semibold text-[var(--text-primary)]">{formData.shop}</span></div><div className="flex justify-between items-center"><span className="text-[var(--text-secondary)]">{t('staffLabel')}:</span><span className="font-semibold text-[var(--text-primary)]">{formData.staff}</span></div><div className="flex justify-between items-center"><span className="text-[var(--text-secondary)]">{t('shiftLabel')}:</span><span className="font-semibold text-[var(--text-primary)]">{formData.shift}</span></div></div><div className="border-t border-[var(--border-color)] !my-4"></div><div className="space-y-3 text-md"><div className="flex justify-between items-center"><span className="text-[var(--text-secondary)]">{t('cashKhrLabel')} :</span><span className="font-mono font-semibold text-[var(--text-primary)]">{formatCurrency(formData.cashKhr, 'KHR')}</span></div><div className="flex justify-between items-center"><span className="text-[var(--text-secondary)]">{t('cashUsdLabel')} :</span><span className="font-mono font-semibold text-[var(--text-primary)]">{formatCurrency(formData.cashUsd, 'USD')}</span></div><div className="flex justify-between items-center"><span className="text-[var(--text-secondary)]">{t('bankKhrLabel')} :</span><span className="font-mono font-semibold text-[var(--text-primary)]">{formatCurrency(formData.bankKhr, 'KHR')}</span></div><div className="flex justify-between items-center"><span className="text-[var(--text-secondary)]">{t('bankUsdLabel')} :</span><span className="font-mono font-semibold text-[var(--text-primary)]">{formatCurrency(formData.bankUsd, 'USD')}</span></div></div><div className="border-t border-[var(--border-color)] !my-4"></div><div className="flex justify-between items-center"><span className="font-bold text-[var(--text-primary)] text-lg">{t('grandTotalLabel')} :</span><span className="font-extrabold text-[var(--semantic-red)] text-2xl">{formatCurrency(grandTotal, 'KHR')}</span></div><div className="border-t border-[var(--border-color)] !my-4"></div><div className="space-y-3 text-md"><div className="flex justify-between items-center"><span className="text-[var(--text-secondary)]">{t('cashExchangeKhrLabel')} :</span><span className="font-mono font-semibold text-[var(--text-primary)]">{formatCurrency(formData.cashExchangeKhr, 'KHR')}</span></div><div className="flex justify-between items-center"><span className="text-[var(--text-secondary)]">{t('cashExchangeUsdLabel')} :</span><span className="font-mono font-semibold text-[var(--text-primary)]">{formatCurrency(formData.cashExchangeUsd, 'USD')}</span></div></div>{formData.note && (<><div className="border-t border-[var(--border-color)] !my-4"></div><div><h4 className="font-semibold text-[var(--text-secondary)] mb-1">{t('noteLabel')}:</h4><p className="text-sm text-[var(--text-secondary)] bg-[var(--background-primary)]/50 p-3 rounded-md whitespace-pre-wrap">{formData.note}</p></div></>)}</div>);
        });
        
        // UPDATED: Modal now accepts submittedAt to freeze time
        const SummaryPreviewModal = ({ isOpen, onClose, formData, grandTotal, submittedAt }) => {
            const { t } = useTranslation();
            return (<Modal isOpen={isOpen} onClose={onClose}><ModalHeader><div className="text-center"><h3 className="text-lg font-bold text-[var(--text-primary)]">{t('submissionSuccessTitle')}</h3><p className="mt-2 text-sm text-[var(--text-secondary)]">{t('submissionSuccessMessage')}</p></div></ModalHeader><ModalBody className="bg-[var(--background-primary)]"><SummaryContent formData={formData} grandTotal={grandTotal} frozenTime={submittedAt} /></ModalBody><ModalFooter><button type="button" onClick={onClose} className="w-full justify-center px-4 py-2 text-sm font-medium text-white bg-[var(--accent-color)] rounded-md hover:bg-[var(--accent-color-hover)]">{t('closeButton')}</button></ModalFooter></Modal>);
        };

        const AppHeader = () => {
            const { userData, logout } = useAuth();
            const { t, locale, setLocale } = useTranslation();
            const [installPrompt, setInstallPrompt] = useState(null);
            useEffect(() => {
                const handler = e => { e.preventDefault(); setInstallPrompt(e); };
                window.addEventListener('beforeinstallprompt', handler);
                return () => window.removeEventListener('beforeinstallprompt', handler);
            }, []);
            const handleInstallClick = () => { if (installPrompt) { installPrompt.prompt(); installPrompt.userChoice.then(() => setInstallPrompt(null)); }};
            return (<header className="bg-[var(--background-secondary)]/50 border border-[var(--border-color)] p-4 rounded-lg shadow-lg mb-6 flex flex-col sm:flex-row justify-between items-center gap-4"><div className="text-center sm:text-left"><h1 className="text-2xl font-semibold text-[var(--text-primary)]">{t('headerTitle')}</h1><p className="mt-1 text-sm text-[var(--text-secondary)]">{t('welcomeMessage', { name: userData.name, role: userData.role })}</p></div><div className="flex items-center gap-2 w-full sm:w-auto"><div className="flex items-center gap-1 bg-[var(--background-input)]/50 p-1 rounded-lg"><button onClick={() => setLocale('en')} className={`px-2 py-1 text-xl rounded-md ${locale === 'en' ? 'bg-[var(--accent-color)] text-white' : 'text-opacity-70 hover:text-opacity-100 hover:bg-[var(--background-input)]'}`}>🇺🇸</button><button onClick={() => setLocale('km')} className={`px-2 py-1 text-xl rounded-md ${locale === 'km' ? 'bg-[var(--accent-color)] text-white' : 'text-opacity-70 hover:text-opacity-100 hover:bg-[var(--background-input)]'}`}>🇰🇭</button></div><ThemeSwitcher />{installPrompt && <button onClick={handleInstallClick} className="bg-[var(--semantic-green)] hover:bg-[var(--semantic-green-hover)] text-white font-semibold px-4 py-2 rounded-lg flex items-center gap-2 text-sm grow justify-center"><Icon name="install" /> {t('installAppButton')}</button>}<button onClick={logout} className="bg-[var(--semantic-red)] hover:bg-[var(--semantic-red-hover)] text-white font-semibold px-4 py-2 rounded-lg flex items-center gap-2 text-sm grow justify-center"><Icon name="logout" /> {t('logoutButton')}</button></div></header>);
        };
        
        const NewCashDropForm = () => {
            const { appSettings } = useAppContext();
            const { userData } = useAuth();
            const { t } = useTranslation();
            const availableShops = useAvailableShops();
            const getInitialState = useCallback(() => ({ date: new Date().toISOString().split('T')[0], shop: availableShops[0]?.name || '', staff: userData?.name || '', shift: 'AM', cashUsd: '', cashKhr: '', bankUsd: '', bankKhr: '', cashExchangeKhr: '', cashExchangeUsd: '', note: '' }), [availableShops, userData]);
            const [formData, setFormData] = useState(getInitialState);
            const [isSubmitting, setIsSubmitting] = useState(false);
            const [isConfirming, setIsConfirming] = useState(false);
            const [isPreviewing, setIsPreviewing] = useState(false);
            const [lastSubmittedData, setLastSubmittedData] = useState(null);
            useEffect(() => { setFormData(getInitialState()) }, [getInitialState]);
            const handleFormChange = (e) => {
                const { name, value } = e.target;
                // Simplified: SmartCurrencyInput handles formatting
                setFormData(prev => ({ ...prev, [name]: value }));
            };
            const grandTotal = useMemo(() => (parseCurrency(formData.cashUsd) + parseCurrency(formData.bankUsd)) * appSettings.exchangeRate + parseCurrency(formData.cashKhr) + parseCurrency(formData.bankKhr), [formData, appSettings.exchangeRate]);
            
            // UPDATED: Capture and freeze submission time
            const handleConfirmSubmit = async () => {
                setIsConfirming(false); setIsSubmitting(true);
                try {
                    const submissionTimestamp = createTimestampFromDateAndCurrentTime(formData.date);
                    const submissionDate = submissionTimestamp.toDate();

                    await firebaseService.addReport({ 
                        ...formData, 
                        cashUsd: parseCurrency(formData.cashUsd), 
                        cashKhr: parseCurrency(formData.cashKhr), 
                        bankUsd: parseCurrency(formData.bankUsd), 
                        bankKhr: parseCurrency(formData.bankKhr), 
                        cashExchangeKhr: parseCurrency(formData.cashExchangeKhr), 
                        cashExchangeUsd: parseCurrency(formData.cashExchangeUsd), 
                        grandTotalKhr: grandTotal, 
                        createdAt: submissionTimestamp, 
                        submittedBy: userData.uid 
                    });
                    
                    setLastSubmittedData({ formData, grandTotal, submittedAt: submissionDate }); // Store frozen time
                    setIsPreviewing(true);
                } catch (error) { console.error("Error submitting report:", error); } finally { setIsSubmitting(false); }
            };
            const handleClosePreviewAndReset = () => { setIsPreviewing(false); setFormData(getInitialState()); setLastSubmittedData(null); };
            return (<><form onSubmit={(e) => { e.preventDefault(); setIsConfirming(true); }} className="grid grid-cols-1 lg:grid-cols-3 gap-8 items-start"><div className="lg:col-span-2 bg-[var(--background-secondary)]/50 border border-[var(--border-color)] p-6 rounded-lg shadow-lg"><h2 className="text-xl font-semibold text-[var(--text-primary)] border-b border-[var(--border-color)] pb-4 mb-6">{t('newFormTitle')}</h2><div className="grid grid-cols-1 md:grid-cols-2 gap-6"><FormInput label={t('dateLabel')} type="date" name="date" value={formData.date} onChange={handleFormChange} required /><FormSelect label={t('shopLabel')} name="shop" value={formData.shop} onChange={handleFormChange} options={availableShops.map(s => ({value: s.name, label: s.name}))} required /><FormInput label={t('staffLabel')} name="staff" value={formData.staff} disabled /><FormSelect label={t('shiftLabel')} name="shift" value={formData.shift} onChange={handleFormChange} options={[{value:'AM', label:'AM'}, {value:'PM', label:'PM'}]} /></div><div className="space-y-4 pt-6 mt-6 border-t border-[var(--border-color)]"><CurrencyInputGroup title={t('byCashTitle')} khrName="cashKhr" usdName="cashUsd" khrValue={formData.cashKhr} usdValue={formData.cashUsd} onChange={handleFormChange} /><CurrencyInputGroup title={t('byBankTitle')} khrName="bankKhr" usdName="bankUsd" khrValue={formData.bankKhr} usdValue={formData.bankUsd} onChange={handleFormChange} /></div><div className="space-y-4 pt-6 mt-6 border-t border-[var(--border-color)]"><CurrencyInputGroup title={t('cashExchangeTitle')} khrName="cashExchangeKhr" usdName="cashExchangeUsd" khrValue={formData.cashExchangeKhr} usdValue={formData.cashExchangeUsd} onChange={handleFormChange} /></div><div className="pt-6 mt-6 border-t border-[var(--border-color)]"><FormInput label={t('noteLabel')} name="note" value={formData.note} onChange={handleFormChange} placeholder={t('notePlaceholder')}/></div></div><div className="lg:col-span-1 lg:sticky top-24"><SummaryContent formData={formData} grandTotal={grandTotal} /><button type="submit" disabled={isSubmitting} className="w-full bg-[var(--accent-color)] hover:bg-[var(--accent-color-hover)] text-white font-bold py-3 px-4 rounded-lg flex items-center justify-center !mt-6 disabled:opacity-50 transition-all shadow-lg hover:shadow-[var(--accent-color)]/50">{isSubmitting ? <Icon name="loader" /> : t('submitReportButton')}</button></div></form>{isConfirming && (<ConfirmationModal isOpen={isConfirming} onClose={() => setIsConfirming(false)} onConfirm={handleConfirmSubmit} isSubmitting={isSubmitting} title={t('confirmSubmissionTitle')} message={t('confirmSubmissionMessage')} confirmText={t('confirmButton')} confirmColor="accent" />)}{isPreviewing && lastSubmittedData && (<SummaryPreviewModal isOpen={isPreviewing} onClose={handleClosePreviewAndReset} formData={lastSubmittedData.formData} grandTotal={lastSubmittedData.grandTotal} submittedAt={lastSubmittedData.submittedAt} />)}</>);
        };
        
        const ReportFilters = React.memo(({ filters, setFilters, shops, onCustomClick }) => {
            const { t } = useTranslation();
            const timeFilterOptions = useMemo(() => [{ value: 'Today', label: t('timeFilters.today') }, { value: 'Yesterday', label: t('timeFilters.yesterday') }, { value: 'This Month', label: t('timeFilters.thisMonth') }, { value: 'Last Month', label: t('timeFilters.lastMonth') }, { value: 'This Year', label: t('timeFilters.thisYear') }, { value: 'Last Year', label: t('timeFilters.lastYear') }, { value: 'Custom', label: t('timeFilters.custom') }], [t]);
            const handleFilterChange = (e) => { const { name, value } = e.target; if (name === 'dueTime' && value === 'Custom') onCustomClick(); else setFilters(prev => ({...prev, [name]: value, startDate: '', endDate: ''})); };
            return (<div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4 p-4 bg-[var(--background-primary)]/50 rounded-lg items-center"><FormSelect label={t('shopLabel')} name="shop" value={filters.shop} onChange={handleFilterChange} options={[{value:'',label: t('allShops')}, ...shops.map(s=>({value:s.name, label:s.name}))]} /><FormSelect label={t('dueTimeLabel')} name="dueTime" value={filters.dueTime} onChange={handleFilterChange} options={timeFilterOptions} /></div>);
        });
        
        const ReportTable = React.memo(({ reports, totals, onEdit, onDelete, onViewNote, viewType }) => {
            const { userData } = useAuth();
            const { t } = useTranslation();
            const canModify = [ROLES.ADMIN, ROLES.MANAGEMENT, ROLES.SHOP_MANAGER].includes(userData?.role);
            const hasShiftColumn = ['Today', 'Yesterday'].includes(viewType);
            const colSpan = 3 + (hasShiftColumn ? 1 : 0);
            const shopColorMap = useShopColorMap();

            if (reports.length === 0) return <div className="text-center py-16 text-[var(--text-secondary)]"><p>{t('noReportsFound')}</p></div>;

            return (
                <div>
                    {/* --- MOBILE CARD VIEW (< 768px) --- */}
                    <div className="md:hidden space-y-4">
                        {reports.map(r => (
                            <div key={r.id} className={`p-4 rounded-lg border border-[var(--border-color)] shadow-sm ${shopColorMap[r.shop]?.base || 'bg-[var(--background-secondary)]'}`}>
                                <div className="flex justify-between items-start mb-2 border-b border-[var(--border-color)]/30 pb-2">
                                    <div>
                                        <div className="font-bold text-[var(--text-primary)]">{r.shop}</div>
                                        <div className="text-xs text-[var(--text-secondary)] font-mono">{formatFullDateTime(r.createdAt)}</div>
                                    </div>
                                    <div className="text-right">
                                        <div className="font-bold text-[var(--accent-color)] text-lg">{formatCurrency(r.grandTotalKhr, 'KHR')}</div>
                                        {hasShiftColumn && <span className="text-xs bg-[var(--background-input)] px-1.5 py-0.5 rounded text-[var(--text-secondary)]">{r.shift}</span>}
                                    </div>
                                </div>
                                
                                <div className="grid grid-cols-2 gap-x-4 gap-y-1 text-sm text-[var(--text-secondary)] mb-3">
                                    <div className="col-span-2 mb-1">Staff: <span className="text-[var(--text-primary)] font-medium">{r.staff}</span></div>
                                    
                                    <span>Cash $: <span className="font-mono text-[var(--text-primary)]">{formatCurrency(r.cashUsd, 'USD')}</span></span>
                                    <span className="text-right">Cash ៛: <span className="font-mono text-[var(--text-primary)]">{formatCurrency(r.cashKhr, 'KHR')}</span></span>
                                    
                                    <span>Bank $: <span className="font-mono text-[var(--text-primary)]">{formatCurrency(r.bankUsd, 'USD')}</span></span>
                                    <span className="text-right">Bank ៛: <span className="font-mono text-[var(--text-primary)]">{formatCurrency(r.bankKhr, 'KHR')}</span></span>
                                </div>

                                <div className="flex justify-between items-center pt-2 border-t border-[var(--border-color)]/30">
                                    <div>
                                        {r.note && <button onClick={() => onViewNote(r.note)} className="text-[var(--semantic-yellow)] text-xs flex items-center gap-1"><Icon name="document-text" className="w-4 h-4"/> Note</button>}
                                    </div>
                                    <div className="flex gap-3">
                                        <button onClick={() => onEdit(r)} disabled={!canModify} className="text-[var(--accent-color)] disabled:opacity-50"><Icon name="note" className="w-5 h-5"/></button>
                                        <button onClick={() => onDelete(r)} disabled={!canModify} className="text-[var(--semantic-red)] disabled:opacity-50"><Icon name="trash" className="w-5 h-5"/></button>
                                    </div>
                                </div>
                            </div>
                        ))}
                        {/* Mobile Totals Card */}
                        <div className="bg-[var(--background-secondary)] p-4 rounded-lg border border-[var(--border-color)]">
                            <h4 className="font-bold text-[var(--text-primary)] mb-2 uppercase text-sm border-b border-[var(--border-color)] pb-1">{t('subTotal')}</h4>
                            <div className="flex justify-between items-center mb-1">
                                <span className="text-[var(--text-secondary)]">{t('netSaleHeader')}:</span>
                                <span className="font-bold text-[var(--accent-color)] font-mono">{formatCurrency(totals.netSale, 'KHR')}</span>
                            </div>
                            <div className="grid grid-cols-2 gap-2 text-xs text-[var(--text-secondary)] mt-2">
                                <div>Cash $: {formatCurrency(totals.cashUsd, 'USD')}</div>
                                <div>Cash ៛: {formatCurrency(totals.cashKhr, 'KHR')}</div>
                                <div>Bank $: {formatCurrency(totals.bankUsd, 'USD')}</div>
                                <div>Bank ៛: {formatCurrency(totals.bankKhr, 'KHR')}</div>
                            </div>
                        </div>
                    </div>

                    {/* --- DESKTOP TABLE VIEW (>= 768px) --- */}
                    <div className="hidden md:block overflow-x-auto">
                        <table className="w-full text-sm text-left"><thead className="bg-[var(--background-primary)]/50 text-xs text-[var(--text-secondary)] uppercase"><tr><th className="p-3">{t('dateTimeHeader')}</th><th className="p-3">{t('shopHeader')}</th><th className="p-3">{t('staffHeader')}</th>{hasShiftColumn && <th className="p-3">{t('shiftHeader')}</th>}<th className="p-3 text-right">{t('netSaleHeader')}</th><th className="p-3 text-right">{t('cashUsdHeader')}</th><th className="p-3 text-right">{t('cashKhrHeader')}</th><th className="p-3 text-right">{t('bankUsdHeader')}</th><th className="p-3 text-right">{t('bankKhrHeader')}</th><th className="p-3 text-right">{t('cashExchUsdHeader')}</th><th className="p-3 text-right">{t('cashExchKhrHeader')}</th><th className="p-3 text-center">{t('actionsHeader')}</th></tr></thead><tbody className="divide-y divide-[var(--border-color)]">{reports.map(r => (<tr key={r.id} className={`${shopColorMap[r.shop]?.base || 'bg-transparent'} ${shopColorMap[r.shop]?.hover || 'hover:bg-[var(--border-color)]/50'}`}><td className="p-3 whitespace-nowrap text-[var(--text-secondary)] font-mono">{formatFullDateTime(r.createdAt)}</td><td className="p-3 text-[var(--text-primary)]">{r.shop}</td><td className="p-3 text-[var(--text-primary)]">{r.staff}</td>{hasShiftColumn && <td className="p-3 text-[var(--text-primary)]">{r.shift}</td>}<td className="p-3 text-right font-bold text-[var(--accent-color)]">{formatCurrency(r.grandTotalKhr, 'KHR')}</td><td className="p-3 text-right font-mono text-[var(--text-primary)]">{formatCurrency(r.cashUsd, 'USD')}</td><td className="p-3 text-right font-mono text-[var(--text-primary)]">{formatCurrency(r.cashKhr, 'KHR')}</td><td className="p-3 text-right font-mono text-[var(--text-primary)]">{formatCurrency(r.bankUsd, 'USD')}</td><td className="p-3 text-right font-mono text-[var(--text-primary)]">{formatCurrency(r.bankKhr, 'KHR')}</td><td className="p-3 text-right font-mono text-[var(--text-primary)]">{formatCurrency(r.cashExchangeUsd, 'USD')}</td><td className="p-3 text-right font-mono text-[var(--text-primary)]">{formatCurrency(r.cashExchangeKhr, 'KHR')}</td><td className="p-3 flex gap-2 justify-center">{r.note && <button onClick={() => onViewNote(r.note)} className="p-1 text-[var(--semantic-yellow)] hover:opacity-80"><Icon name="document-text"/></button>}<button onClick={() => onEdit(r)} disabled={!canModify} className="p-1 text-[var(--accent-color)] hover:text-[var(--accent-color-hover)] disabled:text-slate-600 disabled:cursor-not-allowed"><Icon name="note"/></button><button onClick={() => onDelete(r)} disabled={!canModify} className="p-1 text-[var(--semantic-red)] hover:text-[var(--semantic-red-hover)] disabled:text-slate-600 disabled:cursor-not-allowed"><Icon name="trash"/></button></td></tr>))}</tbody><tfoot className="bg-[var(--background-secondary)] font-bold"><tr><td colSpan={colSpan} className="p-3 text-right text-[var(--text-primary)]">{t('subTotal')}</td><td className="p-3 text-right font-mono text-[var(--accent-color)]">{formatCurrency(totals.netSale, 'KHR')}</td><td className="p-3 text-right font-mono text-[var(--text-primary)]">{formatCurrency(totals.cashUsd, 'USD')}</td><td className="p-3 text-right font-mono text-[var(--text-primary)]">{formatCurrency(totals.cashKhr, 'KHR')}</td><td className="p-3 text-right font-mono text-[var(--text-primary)]">{formatCurrency(totals.bankUsd, 'USD')}</td><td className="p-3 text-right font-mono text-[var(--text-primary)]">{formatCurrency(totals.bankKhr, 'KHR')}</td><td className="p-3 text-right font-mono text-[var(--text-primary)]">{formatCurrency(totals.cashExchangeUsd, 'USD')}</td><td className="p-3 text-right font-mono text-[var(--text-primary)]">{formatCurrency(totals.cashExchangeKhr, 'KHR')}</td><td /></tr></tfoot></table>}
                    </div>
                </div>
            )
        });

        const AggregatedReportTable = React.memo(({ reports, totals, periodType }) => {
            const { t } = useTranslation();
            const shopColorMap = useShopColorMap();
            return (
                <div className="overflow-x-auto">
                    {reports.length === 0 ? <div className="text-center py-16 text-[var(--text-secondary)]"><p>{t('noReportsFound')}</p></div> : <table className="w-full text-sm text-left"><thead className="bg-[var(--background-primary)]/50 text-xs text-[var(--text-secondary)] uppercase"><tr><th className="p-3">{periodType}</th><th className="p-3">{t('shopHeader')}</th><th className="p-3 text-right">{t('netSaleHeader')}</th><th className="p-3 text-right">{t('cashUsdHeader')}</th><th className="p-3 text-right">{t('cashKhrHeader')}</th><th className="p-3 text-right">{t('bankUsdHeader')}</th><th className="p-3 text-right">{t('bankKhrHeader')}</th><th className="p-3 text-right">{t('cashExchUsdHeader')}</th><th className="p-3 text-right">{t('cashExchKhrHeader')}</th></tr></thead><tbody className="divide-y divide-[var(--border-color)]">{reports.map(r => (<tr key={`${r.period}-${r.shop}`} className={`${shopColorMap[r.shop]?.base || 'bg-transparent'} ${shopColorMap[r.shop]?.hover || 'hover:bg-[var(--border-color)]/50'}`}><td className="p-3 whitespace-nowrap text-[var(--text-secondary)]">{r.period}</td><td className="p-3 text-[var(--text-primary)]">{r.shop}</td><td className="p-3 text-right font-bold text-[var(--accent-color)]">{formatCurrency(r.grandTotalKhr, 'KHR')}</td><td className="p-3 text-right font-mono text-[var(--text-primary)]">{formatCurrency(r.cashUsd, 'USD')}</td><td className="p-3 text-right font-mono text-[var(--text-primary)]">{formatCurrency(r.cashKhr, 'KHR')}</td><td className="p-3 text-right font-mono text-[var(--text-primary)]">{formatCurrency(r.bankUsd, 'USD')}</td><td className="p-3 text-right font-mono text-[var(--text-primary)]">{formatCurrency(r.bankKhr, 'KHR')}</td><td className="p-3 text-right font-mono text-[var(--text-primary)]">{formatCurrency(r.cashExchangeUsd, 'USD')}</td><td className="p-3 text-right font-mono text-[var(--text-primary)]">{formatCurrency(r.cashExchangeKhr, 'KHR')}</td></tr>))}</tbody><tfoot className="bg-[var(--background-secondary)] font-bold"><tr><td colSpan={2} className="p-3 text-right text-[var(--text-primary)]">{t('subTotal')}</td><td className="p-3 text-right font-mono text-[var(--accent-color)]">{formatCurrency(totals.netSale, 'KHR')}</td><td className="p-3 text-right font-mono text-[var(--text-primary)]">{formatCurrency(totals.cashUsd, 'USD')}</td><td className="p-auto text-right font-mono text-[var(--text-primary)]">{formatCurrency(totals.cashKhr, 'KHR')}</td><td className="p-3 text-right font-mono text-[var(--text-primary)]">{formatCurrency(totals.bankUsd, 'USD')}</td><td className="p-3 text-right font-mono text-[var(--text-primary)]">{formatCurrency(totals.bankKhr, 'KHR')}</td><td className="p-3 text-right font-mono text-[var(--text-primary)]">{formatCurrency(totals.cashExchangeUsd, 'USD')}</td><td className="p-3 text-right font-mono text-[var(--text-primary)]">{formatCurrency(totals.cashExchangeKhr, 'KHR')}</td></tr></tfoot></table>}
                </div>
            );
        });

        // NEW COMPONENT: Visual Analytics Cards
        const StatsCards = ({ totals }) => (
            <div className="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-6">
                {/* Net Sale Card */}
                <div className="bg-[var(--background-secondary)] p-5 rounded-xl border border-[var(--border-color)] shadow-lg relative overflow-hidden group">
                    <div className="relative z-10">
                        <p className="text-sm text-[var(--text-secondary)] font-medium uppercase tracking-wider">Total Net Sale</p>
                        <p className="text-2xl font-bold text-[var(--accent-color)] mt-2 font-mono tracking-tight">{formatCurrency(totals.netSale, 'KHR')}</p>
                    </div>
                    <div className="absolute right-0 bottom-0 opacity-10 transform translate-x-2 translate-y-2 group-hover:scale-110 transition-transform duration-300">
                        <Icon name="landmark" className="w-24 h-24 text-[var(--accent-color)]" />
                    </div>
                </div>

                {/* Cash Card */}
                <div className="bg-[var(--background-secondary)] p-5 rounded-xl border border-[var(--border-color)] shadow-lg flex flex-col justify-between">
                    <div className="flex items-center gap-2 mb-3">
                        <div className="p-2 bg-green-500/20 rounded-lg text-green-500"><Icon name="plus" className="w-4 h-4" /></div>
                        <p className="text-sm text-[var(--text-secondary)] font-medium uppercase tracking-wider">Cash Collected</p>
                    </div>
                    <div className="space-y-1">
                        <div className="flex justify-between items-end border-b border-[var(--border-color)]/30 pb-1 border-dashed">
                            <span className="text-xs text-[var(--text-secondary)] font-mono">USD</span>
                            <span className="font-mono font-bold text-[var(--text-primary)]">{formatCurrency(totals.cashUsd, 'USD')}</span>
                        </div>
                        <div className="flex justify-between items-end">
                            <span className="text-xs text-[var(--text-secondary)] font-mono">KHR</span>
                            <span className="font-mono font-bold text-[var(--text-primary)]">{formatCurrency(totals.cashKhr, 'KHR')}</span>
                        </div>
                    </div>
                </div>

                {/* Bank Card */}
                <div className="bg-[var(--background-secondary)] p-5 rounded-xl border border-[var(--border-color)] shadow-lg flex flex-col justify-between">
                    <div className="flex items-center gap-2 mb-3">
                        <div className="p-2 bg-blue-500/20 rounded-lg text-blue-500"><Icon name="document-text" className="w-4 h-4" /></div>
                        <p className="text-sm text-[var(--text-secondary)] font-medium uppercase tracking-wider">Bank Transfer</p>
                    </div>
                    <div className="space-y-1">
                        <div className="flex justify-between items-end border-b border-[var(--border-color)]/30 pb-1 border-dashed">
                            <span className="text-xs text-[var(--text-secondary)] font-mono">USD</span>
                            <span className="font-mono font-bold text-[var(--text-primary)]">{formatCurrency(totals.bankUsd, 'USD')}</span>
                        </div>
                        <div className="flex justify-between items-end">
                            <span className="text-xs text-[var(--text-secondary)] font-mono">KHR</span>
                            <span className="font-mono font-bold text-[var(--text-primary)]">{formatCurrency(totals.bankKhr, 'KHR')}</span>
                        </div>
                    </div>
                </div>
            </div>
        );

        const ReportsDashboard = () => {
            const { reports, appSettings, fetchReportsInRange, resetReportsFetch } = useAppContext();
            const { userData } = useAuth();
            const { t } = useTranslation();
            const availableShops = useAvailableShops();
            const [filters, setFilters] = useState({ shop: '', dueTime: 'Today', startDate: '', endDate: '' });
            const [isSubmitting, setIsSubmitting] = useState(false);
            const [modalState, setModalState] = useState({ edit: null, delete: null, note: null, customDate: false });
            
            // Effect: When DueTime changes, update the server fetch range
            useEffect(() => {
                const now = new Date();
                let start, end;
                
                switch (filters.dueTime) {
                    case 'Today': 
                        start = new Date(now.getFullYear(), now.getMonth(), now.getDate()); 
                        // FIX: Explicitly set end of today instead of leaving it undefined
                        end = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 23, 59, 59, 999);
                        break;
                    case 'Yesterday': 
                        start = new Date(now.getFullYear(), now.getMonth(), now.getDate() - 1); 
                        end = new Date(now.getFullYear(), now.getMonth(), now.getDate() - 1, 23, 59, 59, 999); 
                        break;
                    case 'This Month': 
                        start = new Date(now.getFullYear(), now.getMonth(), 1); 
                        break; 
                    case 'Last Month': 
                        start = new Date(now.getFullYear(), now.getMonth() - 1, 1); 
                        end = new Date(now.getFullYear(), now.getMonth(), 0, 23, 59, 59, 999); 
                        break;
                    case 'This Year': 
                        start = new Date(now.getFullYear(), 0, 1); 
                        break;
                    case 'Last Year': 
                        start = new Date(now.getFullYear() - 1, 0, 1); 
                        end = new Date(now.getFullYear() - 1, 11, 31, 23, 59, 59, 999); 
                        break;
                    case 'Custom': 
                        if (filters.startDate && filters.endDate) { 
                            start = new Date(filters.startDate + 'T00:00:00'); 
                            end = new Date(filters.endDate + 'T23:59:59.999'); 
                        } 
                        break;
                }

                if (start) {
                    // FIX: Use a Firestore-safe max date (Year 9999) instead of JS Max Date
                    if (!end) end = new Date('9999-12-31T23:59:59'); 
                    fetchReportsInRange(start, end);
                } else {
                    if (filters.dueTime !== 'Custom') resetReportsFetch();
                }
            }, [filters.dueTime, filters.startDate, filters.endDate, fetchReportsInRange, resetReportsFetch]);

            const { filteredAndAggregatedData, totals } = useFilteredReports(reports, filters, userData, availableShops);

            const handleModalOpen = useCallback((type, data) => setModalState(prev => ({ ...prev, [type]: data })), []);
            const handleModalClose = useCallback((type) => setModalState(prev => ({ ...prev, [type]: null })), []);

            const handleConfirmDelete = async () => {
                if (!modalState.delete) return;
                setIsSubmitting(true);
                try { await firebaseService.deleteReport(modalState.delete.id); handleModalClose('delete'); } catch (error) { console.error("Error deleting report:", error); } finally { setIsSubmitting(false); }
            };

            const handleSaveEdit = async (editedData) => {
                if (!modalState.edit) return;
                setIsSubmitting(true);
                try {
                    const grandTotal = (parseCurrency(editedData.cashUsd) + parseCurrency(editedData.bankUsd)) * appSettings.exchangeRate + parseCurrency(editedData.cashKhr) + parseCurrency(editedData.bankKhr);
                    await firebaseService.updateReport(modalState.edit.id, { ...editedData, createdAt: createTimestampFromDateAndCurrentTime(editedData.date), cashUsd: parseCurrency(editedData.cashUsd), cashKhr: parseCurrency(editedData.cashKhr), bankUsd: parseCurrency(editedData.bankUsd), bankKhr: parseCurrency(editedData.bankKhr), cashExchangeKhr: parseCurrency(editedData.cashExchangeKhr), cashExchangeUsd: parseCurrency(editedData.cashExchangeUsd), grandTotalKhr: grandTotal });
                    handleModalClose('edit');
                } catch (error) { console.error("Error updating report:", error); } finally { setIsSubmitting(false); }
            };

            const handleExport = () => {
                if (!filteredAndAggregatedData?.data) return;
                const dataToExport = filteredAndAggregatedData.data.map(row => (filteredAndAggregatedData.type === 'detailed') ? { [t('dateHeader')]: formatDateDDMMYYYY(row.createdAt), [t('shopHeader')]: row.shop, [t('staffHeader')]: row.staff, [t('netSaleHeader')]: row.grandTotalKhr, [t('cashUsdHeader')]: row.cashUsd, [t('cashKhrHeader')]: row.cashKhr, [t('bankUsdHeader')]: row.bankUsd, [t('bankKhrHeader')]: row.bankKhr, [t('cashExchUsdHeader')]: row.cashExchangeUsd, [t('cashExchKhrHeader')]: row.cashExchangeKhr, [t('shiftHeader')]: row.shift } : { [filters.dueTime]: row.period, [t('shopHeader')]: row.shop, [t('netSaleHeader')]: row.grandTotalKhr, [t('cashUsdHeader')]: row.cashUsd, [t('cashKhrHeader')]: row.cashKhr, [t('bankUsdHeader')]: row.bankUsd, [t('bankKhrHeader')]: row.bankKhr, [t('cashExchUsdHeader')]: row.cashExchangeUsd, [t('cashExchKhrHeader')]: row.cashExchangeKhr });
                const worksheet = XLSX.utils.json_to_sheet(dataToExport);
                const workbook = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(workbook, worksheet, "Cash Drop Report");
                XLSX.writeFile(workbook, `Cash_Drop_Report_${new Date().toISOString().split('T')[0]}.xlsx`);
            };

            return (
                <div className="bg-[var(--background-secondary)]/50 border border-[var(--border-color)] p-4 sm:p-6 rounded-lg shadow-lg mt-8">
                    <div className="flex flex-col sm:flex-row justify-between items-center mb-4 gap-4"><h2 className="text-xl font-semibold text-[var(--text-primary)]">{t('historyTitle')}</h2><button onClick={handleExport} className="bg-[var(--semantic-green)] hover:bg-[var(--semantic-green-hover)] text-white font-semibold px-4 py-2 rounded-lg flex items-center gap-2 text-sm w-full sm:w-auto justify-center"><Icon name="export" /> {t('exportButton')}</button></div>
                    
                    {/* Visual Analytics Cards */}
                    <StatsCards totals={totals} />

                    <ReportFilters filters={filters} setFilters={setFilters} shops={availableShops} onCustomClick={() => handleModalOpen('customDate', true)} />
                    {!filteredAndAggregatedData ? <div className="py-16 flex justify-center items-center"><Icon name="loader" className="w-8 h-8 text-[var(--text-secondary)]" /></div> : (filteredAndAggregatedData.type === 'detailed') ? <ReportTable reports={filteredAndAggregatedData.data} totals={totals} onEdit={(r) => handleModalOpen('edit', r)} onDelete={(r) => handleModalOpen('delete', r)} onViewNote={(n) => handleModalOpen('note', n)} viewType={filters.dueTime} /> : <AggregatedReportTable reports={filteredAndAggregatedData.data} totals={totals} periodType={filters.dueTime} />}
                    <EditReportModal isOpen={!!modalState.edit} onClose={() => handleModalClose('edit')} onSave={handleSaveEdit} report={modalState.edit} isSubmitting={isSubmitting} shops={availableShops}/>
                    {modalState.delete && (<ConfirmationModal isOpen={!!modalState.delete} onClose={() => handleModalClose('delete')} onConfirm={handleConfirmDelete} isSubmitting={isSubmitting} title={t('confirmDeletionTitle')} message={t('confirmDeletionMessage')} confirmText={t('deleteButton')} confirmColor="red" />)}
                    <CustomDateRangeModal isOpen={modalState.customDate} onClose={() => handleModalClose('customDate')} onApply={(dates) => setFilters(prev => ({...prev, ...dates, dueTime: 'Custom'}))}/>
                    <NoteViewModal isOpen={!!modalState.note} onClose={() => handleModalClose('note')} note={modalState.note}/>
                </div>
            );
        };
        
        const CashDropPage = () => {
            const { userData } = useAuth();
            const { isLoading } = useAppContext();
            const { t } = useTranslation();
            const [activeTab, setActiveTab] = useState('cashDrop');
            
            if (isLoading || !userData) return <LoadingSpinner />;
            const canViewDashboard = userData?.role !== ROLES.CASHIER && userData?.role !== ROLES.STAFF;
            
            // Allow staff to see expenses tab if that is the business requirement, otherwise hide it. 
            // Assuming for now Staff can add expenses.
            
            return (
                <div className="space-y-6">
                    {/* Tab Navigation - Revised for Bold Background */}
                    <div className="flex gap-4 p-1 bg-[var(--background-secondary)]/50 rounded-xl border border-[var(--border-color)] w-fit mx-auto sm:mx-0">
                        <button 
                            onClick={()=>setActiveTab('cashDrop')} 
                            className={`px-6 py-2.5 text-sm font-bold rounded-lg transition-all duration-200 ${
                                activeTab==='cashDrop' 
                                ? 'bg-[var(--accent-color)] text-white shadow-lg shadow-[var(--accent-color)]/20 transform scale-105' 
                                : 'text-[var(--text-secondary)] hover:text-[var(--text-primary)] hover:bg-[var(--background-input)]'
                            }`}
                        >
                            {t('tabs.cashDrop')}
                        </button>
                        <button 
                            onClick={()=>setActiveTab('expenses')} 
                            className={`px-6 py-2.5 text-sm font-bold rounded-lg transition-all duration-200 ${
                                activeTab==='expenses' 
                                ? 'bg-[var(--accent-color)] text-white shadow-lg shadow-[var(--accent-color)]/20 transform scale-105' 
                                : 'text-[var(--text-secondary)] hover:text-[var(--text-primary)] hover:bg-[var(--background-input)]'
                            }`}
                        >
                            {t('tabs.expenses')}
                        </button>
                    </div>

                    {activeTab === 'cashDrop' ? (
                        <div className="space-y-8 animate-in fade-in slide-in-from-bottom-4 duration-500">
                            <NewCashDropForm />
                            {canViewDashboard && <ReportsDashboard />}
                        </div>
                    ) : (
                        <div className="animate-in fade-in slide-in-from-bottom-4 duration-500">
                            <DailyOperationExpenseTab />
                        </div>
                    )}
                </div>
            );
        };

        const LoginPage = () => {
            const { login, authError, setAuthError } = useAuth();
            const { t, setLocale, locale } = useTranslation();
            const [credentials, setCredentials] = useState({ email: '', password: '' });
            const [error, setError] = useState(null);
            const [loading, setLoading] = useState(false);
            const [showPassword, setShowPassword] = useState(false);
            const [rememberMe, setRememberMe] = useState(true);
            useEffect(() => { if (authError) { setError({ message: t(authError.message) }); setAuthError(null); } }, [authError, setAuthError, t]);
            const handleChange = (e) => setCredentials(prev => ({...prev, [e.target.name]: e.target.value}));
            const handleSubmit = async (e) => { e.preventDefault(); setError(null); setLoading(true); try { await login(credentials.email, credentials.password, rememberMe); } catch (err) { setError({ message: t('loginError') }); } finally { setLoading(false); } };
            return (<div className="min-h-screen bg-[var(--background-primary)] flex flex-col justify-center items-center p-4"><div className="w-full max-w-md"><div className="absolute top-4 right-4 flex items-center gap-2"><div className="flex items-center gap-1 bg-[var(--background-input)]/50 p-1 rounded-lg"><button onClick={() => setLocale('en')} className={`px-2 py-1 text-xl rounded-md ${locale === 'en' ? 'bg-[var(--accent-color)] text-white' : 'text-opacity-70 hover:text-opacity-100'}`}>🇺🇸</button><button onClick={() => setLocale('km')} className={`px-2 py-1 text-xl rounded-md ${locale === 'km' ? 'bg-[var(--accent-color)] text-white' : 'text-opacity-70 hover:text-opacity-100'}`}>🇰🇭</button></div><ThemeSwitcher /></div><div className="bg-[var(--background-secondary)]/80 p-8 md:p-10 rounded-2xl shadow-lg border border-[var(--border-color)]"><div className="text-center mb-8"><h1 className="text-3xl font-bold text-[var(--text-primary)]">{t('loginTitle')}</h1><div className="mt-2 text-sm text-[var(--text-secondary)]"><p>{t('loginSubtitle1')}</p><p>{t('loginSubtitle2')}</p></div></div><form onSubmit={handleSubmit} className="space-y-6"><div className="relative"><input id="email" name="email" type="email" value={credentials.email} onChange={handleChange} required placeholder={t('emailPlaceholder')} className="block w-full pl-4 pr-3 py-2.5 bg-[var(--background-input)] border border-[var(--border-color)] rounded-lg placeholder-[var(--text-secondary)] focus:outline-none focus:ring-2 focus:ring-[var(--accent-color)] text-[var(--text-primary)]"/></div><div className="relative"><input id="password" name="password" type={showPassword ? 'text' : 'password'} value={credentials.password} onChange={handleChange} required placeholder={t('passwordPlaceholder')} className="block w-full pl-4 pr-10 py-2.5 bg-[var(--background-input)] border border-[var(--border-color)] rounded-lg placeholder-[var(--text-secondary)] focus:outline-none focus:ring-2 focus:ring-[var(--accent-color)] text-[var(--text-primary)]"/><button type="button" onClick={() => setShowPassword(!showPassword)} className="absolute inset-y-0 right-0 pr-3 flex items-center text-[var(--text-secondary)] hover:text-[var(--text-primary)]">{showPassword ? <Icon name="eye-off" /> : <Icon name="eye" />}</button></div><div className="flex items-center"><input id="remember-me" type="checkbox" checked={rememberMe} onChange={(e) => setRememberMe(e.target.checked)} className="h-4 w-4 text-[var(--accent-color)] focus:ring-[var(--accent-color)] border-[var(--border-color)] rounded bg-[var(--background-input)]"/><label htmlFor="remember-me" className="ml-2 block text-sm text-[var(--text-secondary)]">{t('rememberMe')}</label></div>{error && <p className="text-[var(--semantic-red)] text-sm text-center">{error.message}</p>}<button type="submit" disabled={loading} className="w-full bg-[var(--accent-color)] hover:bg-[var(--accent-color-hover)] text-white font-bold py-3 px-4 rounded-lg flex items-center justify-center disabled:opacity-50 transition-all shadow-lg hover:shadow-[var(--accent-color)]/50">{loading ? <Icon name="loader" /> : t('loginButton')}</button></form></div></div></div>);
        };
        
        const App = () => {
            const { user, loading } = useAuth();
            if (loading) return <LoadingSpinner />;
            return !user ? <LoginPage /> : <AppProvider><div className="container mx-auto p-4 md:p-8"><div className="max-w-7xl mx-auto"><AppHeader /><main><CashDropPage /></main></div></div></AppProvider>;
        };

        const Root = () => (<LanguageProvider><ToastProvider><AuthProvider><ThemeProvider><App /></ThemeProvider></AuthProvider></ToastProvider></LanguageProvider>);

        ReactDOM.createRoot(document.getElementById('root')).render(<Root />);
    </script>
</body>
</html>
