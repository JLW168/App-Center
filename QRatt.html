<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>HR Check-In</title>
    
    <link rel="manifest" href="./manifest.json">
    <meta name="theme-color" content="#0f172a">
    <meta name="apple-mobile-web-app-capable" content="yes">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    
    <!-- React -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- QR Scanner -->
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

    <style>
        @import url('https://rsms.me/inter/inter.css');
        html, body { font-family: 'Inter', sans-serif; background-color: #0f172a; color: #e2e8f0; height: 100%; }
        .input {
            width: 100%; padding: 0.75rem; border-radius: 0.5rem;
            background-color: #1e293b; border: 1px solid #334155; color: white;
            margin-bottom: 1rem;
        }
        .btn {
            width: 100%; padding: 0.75rem; border-radius: 0.75rem; font-weight: bold;
            text-align: center; transition: all 0.2s; cursor: pointer;
        }
        .btn-primary { background: linear-gradient(to right, #2563eb, #3b82f6); color: white; }
        .btn-primary:active { transform: scale(0.98); }
        .scanner-box { border-radius: 1rem; overflow: hidden; border: 2px solid #334155; background: #000; min-height: 300px; width: 100%; }
        
        @keyframes modalPop {
            0% { transform: scale(0.9); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }
        .animate-pop { animation: modalPop 0.3s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
    </style>
</head>
<body>
    <div id="root"></div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, where, orderBy, limit, getDocs, serverTimestamp, enableIndexedDbPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyB7_pnmwHj6aOeZRTykPvNusNFYReaTY6Q",
            authDomain: "hrsm-j.firebaseapp.com",
            projectId: "hrsm-j",
            storageBucket: "hrsm-j.appspot.com",
            messagingSenderId: "45063715478",
            appId: "1:45063715478:web:cc2dd21b83dd195771e0b7",
            measurementId: "G-8HQDG2LTKP"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        
        // Enable offline support if possible
        enableIndexedDbPersistence(db).catch(err => console.log("Persistence error", err.code));

        window.fb = { auth, db, signInWithEmailAndPassword, signOut, collection, addDoc, query, where, orderBy, limit, getDocs, serverTimestamp };
    </script>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- UTILS ---
        const getDistance = (lat1, lon1, lat2, lon2) => {
            const R = 6371e3; // Earth radius in meters
            const φ1 = lat1 * Math.PI/180;
            const φ2 = lat2 * Math.PI/180;
            const Δφ = (lat2-lat1) * Math.PI/180;
            const Δλ = (lon2-lon1) * Math.PI/180;

            const a = Math.sin(Δφ/2) * Math.sin(Δφ/2) +
                      Math.cos(φ1) * Math.cos(φ2) *
                      Math.sin(Δλ/2) * Math.sin(Δλ/2);
            
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c; // Distance in meters
        };

        // --- COMPONENTS ---

        // NEW: Modern Alert Modal Component
        const AlertModal = ({ isOpen, onClose, title, message, type }) => {
            if (!isOpen) return null;

            const isError = type === 'error';
            const isSuccess = type === 'success';
            
            // Icon configuration
            let iconClass = 'fa-info-circle';
            let colorClass = 'blue';
            
            if (isError) {
                iconClass = 'fa-shield-halved';
                colorClass = 'red';
            } else if (isSuccess) {
                iconClass = 'fa-circle-check';
                colorClass = 'green';
            }

            return (
                <div className="fixed inset-0 z-[100] flex items-center justify-center p-4 bg-black/80 backdrop-blur-sm animate-fade-in">
                    <div className={`w-full max-w-sm bg-slate-900 border rounded-2xl p-6 shadow-2xl animate-pop relative overflow-hidden ${isError ? 'border-red-500/50' : isSuccess ? 'border-green-500/50' : 'border-blue-500/50'}`}>
                        
                        {/* Background Glow */}
                        <div className={`absolute top-0 left-0 w-full h-1 bg-gradient-to-r ${isError ? 'from-red-500' : isSuccess ? 'from-green-500' : 'from-blue-500'} to-transparent`}></div>
                        
                        <div className="flex flex-col items-center text-center relative z-10">
                            {/* Animated Icon Container */}
                            <div className={`mb-5 p-4 rounded-full ${isError ? 'bg-red-500/10 text-red-500' : isSuccess ? 'bg-green-500/10 text-green-400' : 'bg-blue-500/10 text-blue-400'} ring-1 ring-white/5 shadow-lg`}>
                                <i className={`fas ${iconClass} text-3xl ${isError ? 'animate-pulse' : ''}`}></i>
                            </div>
                            
                            <h3 className="text-xl font-bold text-white mb-2">{title}</h3>
                            
                            {/* Message Area with Support for Newlines */}
                            <div className="bg-slate-800/50 rounded-xl p-3 w-full mb-6 border border-slate-700/50">
                                <p className="text-slate-300 text-sm leading-relaxed whitespace-pre-wrap">{message}</p>
                            </div>
                            
                            <button 
                                onClick={onClose}
                                className={`w-full py-3.5 rounded-xl font-bold text-sm tracking-wide transition-all active:scale-[0.98] shadow-lg ${
                                    isError ? 'bg-red-600 hover:bg-red-500 text-white shadow-red-900/20' : 
                                    isSuccess ? 'bg-green-600 hover:bg-green-500 text-white shadow-green-900/20' :
                                    'bg-slate-700 hover:bg-slate-600 text-white shadow-slate-900/20'
                                }`}
                            >
                                {isError ? 'UNDERSTOOD' : isSuccess ? 'CONTINUE' : 'OKAY'}
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        const LoginScreen = ({ onLogin }) => {
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState('');

            const handleLogin = async (e) => {
                e.preventDefault();
                setLoading(true);
                setError('');
                try {
                    await window.fb.signInWithEmailAndPassword(window.fb.auth, email, password);
                } catch (err) {
                    console.error(err);
                    setError("Invalid email or password.");
                    setLoading(false);
                }
            };

            return (
                <div className="flex flex-col items-center justify-center min-h-screen p-6">
                    <div className="w-16 h-16 bg-blue-600 rounded-2xl flex items-center justify-center mb-6 shadow-lg shadow-blue-500/30">
                        <i className="fas fa-fingerprint text-3xl text-white"></i>
                    </div>
                    <h1 className="text-2xl font-bold text-white mb-2">Staff Check-In</h1>
                    <p className="text-slate-400 mb-8 text-center">Scan QR codes to log your attendance</p>
                    
                    <form onSubmit={handleLogin} className="w-full max-w-sm">
                        <input type="email" placeholder="Email" className="input" value={email} onChange={e=>setEmail(e.target.value)} required />
                        <input type="password" placeholder="Password" className="input" value={password} onChange={e=>setPassword(e.target.value)} required />
                        {error && <p className="text-red-400 text-sm mb-4 text-center">{error}</p>}
                        <button type="submit" className="btn btn-primary" disabled={loading}>
                            {loading ? <i className="fas fa-spinner fa-spin"></i> : "Sign In"}
                        </button>
                    </form>
                </div>
            );
        };

        const ScannerModal = ({ isOpen, onClose, onScan }) => {
            const scannerRef = useRef(null); 

            useEffect(() => {
                if (isOpen && !scannerRef.current) {
                    const timer = setTimeout(() => {
                        try {
                            const html5QrCode = new Html5Qrcode("reader");
                            scannerRef.current = html5QrCode;

                            const config = { fps: 10, qrbox: { width: 250, height: 250 } };
                            
                            html5QrCode.start(
                                { facingMode: "environment" }, 
                                config,
                                (decodedText) => {
                                    html5QrCode.stop().then(() => {
                                        scannerRef.current = null;
                                        onScan(decodedText);
                                    }).catch(err => console.error("Failed to stop scanner", err));
                                },
                                (errorMessage) => {}
                            ).catch(err => {
                                console.error("Error starting scanner:", err);
                                alert("Unable to start camera. Please ensure you are on HTTPS (or localhost) and have granted permissions.");
                                onClose();
                            });
                        } catch(e) { console.error(e); }
                    }, 300);
                    return () => clearTimeout(timer);
                }
                return () => {
                    if (scannerRef.current) {
                        scannerRef.current.stop().catch(e => console.warn("Scanner cleanup warning", e));
                        scannerRef.current = null;
                    }
                };
            }, [isOpen]);

            if (!isOpen) return null;

            return (
                <div className="fixed inset-0 z-50 bg-black flex flex-col items-center justify-center p-4">
                    <div className="w-full max-w-md bg-slate-900 rounded-2xl p-4 border border-slate-700 relative">
                        <button onClick={onClose} className="absolute top-4 right-4 text-white text-xl z-10 bg-slate-800 rounded-full w-8 h-8 flex items-center justify-center shadow-md"><i className="fas fa-times"></i></button>
                        <h3 className="text-center text-white font-bold mb-4">Scan Shop QR</h3>
                        <div id="reader" className="scanner-box bg-slate-800"></div>
                        <p className="text-center text-slate-400 text-sm mt-4">Point your camera at the QR Code</p>
                    </div>
                </div>
            );
        };

        const MainScreen = ({ user }) => {
            const [scanning, setScanning] = useState(false);
            const [lastRecord, setLastRecord] = useState(null);
            const [loading, setLoading] = useState(false);
            const [currentTime, setCurrentTime] = useState(new Date());

            // --- NEW: Alert State ---
            const [alertState, setAlertState] = useState({ isOpen: false, title: '', message: '', type: 'info' });

            const showAlert = (title, message, type = 'info') => {
                setAlertState({ isOpen: true, title, message, type });
                setLoading(false); // Ensure loader stops when alert pops
            };

            const closeAlert = () => {
                setAlertState(prev => ({ ...prev, isOpen: false }));
            };
            // ------------------------

            // Live Clock
            useEffect(() => {
                const timer = setInterval(() => setCurrentTime(new Date()), 1000);
                return () => clearInterval(timer);
            }, []);

            // Fetch last action
            useEffect(() => {
                const fetchLast = async () => {
                    const q = window.fb.query(
                        window.fb.collection(window.fb.db, 'attendance'),
                        window.fb.where('employeeId', '==', user.uid),
                        window.fb.orderBy('timestamp', 'desc'),
                        window.fb.limit(1)
                    );
                    const snap = await window.fb.getDocs(q);
                    if (!snap.empty) {
                        setLastRecord(snap.docs[0].data());
                    }
                };
                fetchLast();
            }, [user]);

            const getGPS = () => {
                return new Promise((resolve, reject) => {
                    if (!navigator.geolocation) {
                        resolve(null); 
                        return;
                    }
                    navigator.geolocation.getCurrentPosition(
                        (pos) => resolve({ latitude: pos.coords.latitude, longitude: pos.coords.longitude }),
                        (err) => { console.warn("GPS Error", err); resolve(null); },
                        { enableHighAccuracy: true, timeout: 5000, maximumAge: 0 }
                    );
                });
            };

            const handleScanSuccess = async (qrText) => {
                setScanning(false);
                setLoading(true);
                
                try {
                    // 1. Get GPS (MANDATORY for Security Check)
                    const gps = await getGPS();
                    
                    if (!gps) {
                        showAlert("Location Required", "GPS access is denied or unavailable.\n\nWe need your location to verify you are at the shop.", "error");
                        return;
                    }

                    // 2. Fetch Shop Details from Firestore to get coordinates
                    const shopsRef = window.fb.collection(window.fb.db, 'shops');
                    const q = window.fb.query(shopsRef, window.fb.where("name", "==", qrText));
                    const querySnapshot = await window.fb.getDocs(q);

                    if (querySnapshot.empty) {
                        showAlert("Invalid QR Code", "This QR code is not recognized by the system.\n\nPlease scan a valid Shop QR.", "error");
                        return;
                    }

                    const shopData = querySnapshot.docs[0].data();

                    // --- SECURITY CHECK 1: Verify Staff Assignment ---
                    const userShops = Array.isArray(user.shop) ? user.shop : [user.shop];
                    const isAssigned = user.role === 'Admin' || user.role === 'CEO' || userShops.includes(qrText);

                    if (!isAssigned) {
                        showAlert(
                            "Access Denied", 
                            `You are assigned to: ${userShops.join(', ')}\n\nYou scanned: ${qrText}\n\nYou cannot check in at a location you are not assigned to.`, 
                            "error"
                        );
                        return;
                    }
                    
                    // --- SECURITY CHECK 2: VALIDATE DISTANCE ---
                    if (shopData.latitude && shopData.longitude) {
                        const distance = getDistance(
                            gps.latitude, 
                            gps.longitude, 
                            parseFloat(shopData.latitude), 
                            parseFloat(shopData.longitude)
                        );
                        
                        const allowedRadius = parseFloat(shopData.radius) || 500; // Default 500m

                        if (distance > allowedRadius) {
                            showAlert(
                                "Security Alert", 
                                `You are too far from the shop location.\n\nTarget: ${qrText}\nYour Distance: ${Math.round(distance)}m\nAllowed Radius: ${allowedRadius}m\n\nPlease move closer to the QR code area.`, 
                                "error"
                            );
                            return; // STOP EXECUTION
                        }
                    } else {
                        console.warn("Shop coordinates missing in database. Skipping distance check.");
                    }

                    // 4. Determine Action (Toggle In/Out)
                    const type = (lastRecord && lastRecord.type === 'in') ? 'out' : 'in';
                    
                    // 5. Save to Firestore
                    const payload = {
                        employeeId: user.uid,
                        employeeName: user.displayName || 'Staff',
                        shop: qrText, 
                        timestamp: window.fb.serverTimestamp(),
                        type: type,
                        verificationMethod: 'qr',
                        location: gps
                    };

                    await window.fb.addDoc(window.fb.collection(window.fb.db, 'attendance'), payload);

                    // 6. Update UI
                    const now = new Date();
                    setLastRecord({ ...payload, timestamp: { toDate: () => now } }); 
                    
                    // Format Date for Alert: DD-MM-YY|HH:MM:SS
                    const dd = String(now.getDate()).padStart(2, '0');
                    const mm = String(now.getMonth() + 1).padStart(2, '0');
                    const yy = String(now.getFullYear()).slice(-2);
                    const hh = String(now.getHours()).padStart(2, '0');
                    const min = String(now.getMinutes()).padStart(2, '0');
                    const ss = String(now.getSeconds()).padStart(2, '0');
                    const dateTimeStr = `${dd}-${mm}-${yy}|${hh}:${min}:${ss}`;

                    showAlert(
                        "Success", 
                        `Successfully Checked ${type.toUpperCase()}\nLocation: ${qrText}\nTime: ${dateTimeStr}\nStatus: Verified`, 
                        "success"
                    );

                } catch (error) {
                    console.error("Check-in failed", error);
                    showAlert("System Error", "Failed to save check-in data. Please check your internet connection.", "error");
                } finally {
                    setLoading(false);
                }
            };

            const isCheckedIn = lastRecord && lastRecord.type === 'in';

            return (
                <div className="flex flex-col h-screen bg-slate-900">
                    <AlertModal 
                        isOpen={alertState.isOpen} 
                        onClose={closeAlert} 
                        title={alertState.title} 
                        message={alertState.message} 
                        type={alertState.type} 
                    />

                    {/* Header */}
                    <div className="p-6 flex justify-between items-start bg-slate-800 shadow-md">
                        <div>
                            <h2 className="text-lg font-bold text-white mb-1">Hello, {user.displayName || 'Staff'}</h2>
                            <div className="flex flex-col">
                                <span className="text-sm font-bold text-slate-300">
                                    {currentTime.toLocaleDateString(undefined, { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}
                                </span>
                            </div>
                        </div>
                        <button onClick={() => window.fb.signOut(window.fb.auth)} className="text-red-400 bg-slate-700/50 p-3 rounded-xl hover:bg-slate-700 transition-colors border border-slate-600">
                            <i className="fas fa-power-off text-lg"></i>
                        </button>
                    </div>

                    {/* Content */}
                    <div className="flex-1 flex flex-col items-center justify-center p-6 space-y-8 relative overflow-hidden">
                        
                        {/* Ambient Background Glow */}
                        <div className={`absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-64 h-64 rounded-full blur-[100px] opacity-20 pointer-events-none transition-colors duration-700 ${isCheckedIn ? 'bg-green-500' : 'bg-slate-500'}`}></div>

                        {/* Status Card */}
                        <div className={`relative z-10 w-full max-w-sm rounded-3xl p-8 flex flex-col items-center justify-center shadow-2xl transition-all duration-500 border ${isCheckedIn ? 'bg-slate-800/90 border-green-500/30' : 'bg-slate-800/90 border-slate-600/30'}`}>
                            
                            <div className={`w-24 h-24 rounded-full flex items-center justify-center mb-5 transition-all duration-500 ${isCheckedIn ? 'bg-green-500 text-slate-900 shadow-[0_0_40px_rgba(34,197,94,0.3)]' : 'bg-slate-700 text-slate-400'}`}>
                                <i className={`fas ${isCheckedIn ? 'fa-check' : 'fa-user-clock'} text-4xl`}></i>
                            </div>

                            <p className="text-slate-400 text-[10px] font-bold uppercase tracking-[0.2em] mb-2">Current Status</p>
                            <h2 className={`text-3xl font-black tracking-tight mb-2 ${isCheckedIn ? 'text-green-400' : 'text-slate-200'}`}>
                                {isCheckedIn ? 'CHECKED IN' : 'CHECKED OUT'}
                            </h2>
                            
                            {/* Live Clock inside card */}
                            <div className="mb-6 font-mono text-2xl font-bold text-slate-300 tracking-widest bg-black/20 px-6 py-2 rounded-xl border border-white/5 shadow-inner">
                                {currentTime.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false })}
                            </div>

                            <div className="w-full bg-slate-900/60 rounded-xl p-4 border border-slate-700/50 backdrop-blur-sm">
                                <div className="flex justify-between items-center mb-1.5">
                                    <span className="text-[10px] uppercase font-bold text-slate-500 tracking-wide">Last Activity</span>
                                    <span className="text-xs text-slate-400 font-mono bg-slate-800 px-2 py-0.5 rounded">
                                        {lastRecord?.timestamp?.toDate ? lastRecord.timestamp.toDate().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}) : '--:--'}
                                    </span>
                                </div>
                                <div className="flex items-center gap-2">
                                     <i className={`fas fa-map-marker-alt text-sm ${isCheckedIn ? 'text-green-500' : 'text-slate-500'}`}></i>
                                     <span className="text-sm font-bold text-slate-200 truncate">{lastRecord?.shop || 'No recent activity'}</span>
                                </div>
                            </div>
                        </div>

                        {/* Scan Button */}
                        <button 
                            onClick={() => setScanning(true)} 
                            disabled={loading}
                            className="w-full max-w-sm py-5 rounded-2xl bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-500 hover:to-indigo-500 text-white font-bold text-lg shadow-xl shadow-blue-900/30 active:scale-[0.98] transition-all flex items-center justify-center gap-3 relative z-10 border-t border-white/10"
                        >
                            {loading ? (
                                <i className="fas fa-spinner fa-spin"></i>
                            ) : (
                                <>
                                    <i className="fas fa-qrcode text-xl"></i>
                                    <span>{isCheckedIn ? 'Scan to Check OUT' : 'Scan to Check IN'}</span>
                                </>
                            )}
                        </button>
                    </div>

                    <div className="p-4 text-center text-[10px] text-slate-600 font-mono uppercase tracking-widest">
                        Smart HR System v2.1
                    </div>

                    <ScannerModal isOpen={scanning} onClose={() => setScanning(false)} onScan={handleScanSuccess} />
                </div>
            );
        };

        const App = () => {
            const [user, setUser] = useState(null);
            const [loading, setLoading] = useState(true);

            useEffect(() => {
                window.fb.auth.onAuthStateChanged((u) => {
                    if (u) {
                        const q = window.fb.query(window.fb.collection(window.fb.db, 'employees'), window.fb.where('uid', '==', u.uid));
                        window.fb.getDocs(q).then(snap => {
                            if (!snap.empty) {
                                const data = snap.docs[0].data();
                                u.displayName = data.name; 
                                u.shop = data.shop;
                                u.role = data.role;
                                setUser(u);
                            } else {
                                alert("No employee record found for this account.");
                                window.fb.signOut(window.fb.auth);
                            }
                            setLoading(false);
                        });
                    } else {
                        setUser(null);
                        setLoading(false);
                    }
                });
            }, []);

            if (loading) return <div className="flex h-screen items-center justify-center bg-slate-900 text-blue-500"><i className="fas fa-circle-notch fa-spin text-4xl"></i></div>;

            return user ? <MainScreen user={user} /> : <LoginScreen />;
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
