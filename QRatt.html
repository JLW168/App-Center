<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>HR Check-In</title>
    
    <link rel="manifest" href="./manifest.json">
    <meta name="theme-color" content="#0f172a">
    <meta name="apple-mobile-web-app-capable" content="yes">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    
    <!-- React -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- QR Scanner -->
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

    <style>
        @import url('https://rsms.me/inter/inter.css');
        html, body { font-family: 'Inter', sans-serif; background-color: #0f172a; color: #e2e8f0; height: 100%; }
        .input {
            width: 100%; padding: 0.75rem; border-radius: 0.5rem;
            background-color: #1e293b; border: 1px solid #334155; color: white;
            margin-bottom: 1rem;
        }
        .btn {
            width: 100%; padding: 0.75rem; border-radius: 0.75rem; font-weight: bold;
            text-align: center; transition: all 0.2s; cursor: pointer;
        }
        .btn-primary { background: linear-gradient(to right, #2563eb, #3b82f6); color: white; }
        .btn-primary:active { transform: scale(0.98); }
        .scanner-box { border-radius: 1rem; overflow: hidden; border: 2px solid #334155; background: #000; min-height: 300px; width: 100%; }
    </style>
</head>
<body>
    <div id="root"></div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, where, orderBy, limit, getDocs, serverTimestamp, enableIndexedDbPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyB7_pnmwHj6aOeZRTykPvNusNFYReaTY6Q",
            authDomain: "hrsm-j.firebaseapp.com",
            projectId: "hrsm-j",
            storageBucket: "hrsm-j.appspot.com",
            messagingSenderId: "45063715478",
            appId: "1:45063715478:web:cc2dd21b83dd195771e0b7",
            measurementId: "G-8HQDG2LTKP"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        
        // Enable offline support if possible
        enableIndexedDbPersistence(db).catch(err => console.log("Persistence error", err.code));

        window.fb = { auth, db, signInWithEmailAndPassword, signOut, collection, addDoc, query, where, orderBy, limit, getDocs, serverTimestamp };
    </script>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- COMPONENTS ---

        const LoginScreen = ({ onLogin }) => {
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState('');

            const handleLogin = async (e) => {
                e.preventDefault();
                setLoading(true);
                setError('');
                try {
                    await window.fb.signInWithEmailAndPassword(window.fb.auth, email, password);
                    // Auth state listener in App will handle the transition
                } catch (err) {
                    console.error(err);
                    setError("Invalid email or password.");
                    setLoading(false);
                }
            };

            return (
                <div className="flex flex-col items-center justify-center min-h-screen p-6">
                    <div className="w-16 h-16 bg-blue-600 rounded-2xl flex items-center justify-center mb-6 shadow-lg shadow-blue-500/30">
                        <i className="fas fa-fingerprint text-3xl text-white"></i>
                    </div>
                    <h1 className="text-2xl font-bold text-white mb-2">Staff Check-In</h1>
                    <p className="text-slate-400 mb-8 text-center">Scan QR codes to log your attendance</p>
                    
                    <form onSubmit={handleLogin} className="w-full max-w-sm">
                        <input type="email" placeholder="Email" className="input" value={email} onChange={e=>setEmail(e.target.value)} required />
                        <input type="password" placeholder="Password" className="input" value={password} onChange={e=>setPassword(e.target.value)} required />
                        {error && <p className="text-red-400 text-sm mb-4 text-center">{error}</p>}
                        <button type="submit" className="btn btn-primary" disabled={loading}>
                            {loading ? <i className="fas fa-spinner fa-spin"></i> : "Sign In"}
                        </button>
                    </form>
                </div>
            );
        };

        const ScannerModal = ({ isOpen, onClose, onScan }) => {
            const scannerRef = useRef(null); // Used to hold the Html5Qrcode instance

            useEffect(() => {
                if (isOpen && !scannerRef.current) {
                    // Small delay to ensure the #reader div is rendered by React
                    const timer = setTimeout(() => {
                        // Use direct Html5Qrcode class instead of the Scanner widget
                        // This bypasses the "Request Permission" UI that can get stuck
                        const html5QrCode = new Html5Qrcode("reader");
                        scannerRef.current = html5QrCode;

                        const config = { fps: 10, qrbox: { width: 250, height: 250 } };
                        
                        // Explicitly start the back camera
                        html5QrCode.start(
                            { facingMode: "environment" }, 
                            config,
                            (decodedText) => {
                                // Success! Stop scanning and report back
                                html5QrCode.stop().then(() => {
                                    scannerRef.current = null;
                                    onScan(decodedText);
                                }).catch(err => console.error("Failed to stop scanner", err));
                            },
                            (errorMessage) => {
                                // Scanning in progress... ignore frame errors
                            }
                        ).catch(err => {
                            console.error("Error starting scanner:", err);
                            alert("Unable to start camera. Please ensure you are on HTTPS (or localhost) and have granted permissions.");
                            onClose();
                        });
                    }, 300);
                    
                    return () => clearTimeout(timer);
                }
                
                // Cleanup on unmount or close
                return () => {
                    if (scannerRef.current) {
                        scannerRef.current.stop().catch(err => console.warn("Scanner cleanup warning", err));
                        scannerRef.current = null;
                    }
                };
            }, [isOpen]);

            if (!isOpen) return null;

            return (
                <div className="fixed inset-0 z-50 bg-black flex flex-col items-center justify-center p-4">
                    <div className="w-full max-w-md bg-slate-900 rounded-2xl p-4 border border-slate-700 relative">
                        <button onClick={onClose} className="absolute top-4 right-4 text-white text-xl z-10 bg-slate-800 rounded-full w-8 h-8 flex items-center justify-center shadow-md"><i className="fas fa-times"></i></button>
                        <h3 className="text-center text-white font-bold mb-4">Scan Shop QR</h3>
                        
                        {/* Container for the direct scanner */}
                        <div id="reader" className="scanner-box bg-slate-800"></div>
                        
                        <p className="text-center text-slate-400 text-sm mt-4">Point your camera at the QR Code</p>
                    </div>
                </div>
            );
        };

        const MainScreen = ({ user }) => {
            const [scanning, setScanning] = useState(false);
            const [status, setStatus] = useState('');
            const [lastRecord, setLastRecord] = useState(null);
            const [loading, setLoading] = useState(false);
            const [location, setLocation] = useState(null);

            // Fetch last action on load
            useEffect(() => {
                const fetchLast = async () => {
                    // Simple query to get the very last record for this user to show status
                    const q = window.fb.query(
                        window.fb.collection(window.fb.db, 'attendance'),
                        window.fb.where('employeeId', '==', user.uid),
                        window.fb.orderBy('timestamp', 'desc'),
                        window.fb.limit(1)
                    );
                    const snap = await window.fb.getDocs(q);
                    if (!snap.empty) {
                        const data = snap.docs[0].data();
                        setLastRecord(data);
                    }
                };
                fetchLast();
            }, [user]);

            const getGPS = () => {
                return new Promise((resolve, reject) => {
                    if (!navigator.geolocation) {
                        resolve(null); 
                        return;
                    }
                    navigator.geolocation.getCurrentPosition(
                        (pos) => resolve({ latitude: pos.coords.latitude, longitude: pos.coords.longitude }),
                        (err) => { 
                            console.warn("GPS Error", err); 
                            // Resolve null so check-in proceeds even if GPS fails (QR is trusted)
                            resolve(null); 
                        },
                        { enableHighAccuracy: true, timeout: 5000, maximumAge: 0 }
                    );
                });
            };

            const handleScanSuccess = async (qrText) => {
                setScanning(false);
                setLoading(true);
                setStatus(`Identifying Shop: ${qrText}...`);

                try {
                    // 1. Get GPS (Background)
                    const gps = await getGPS();
                    
                    // 2. Determine Action (Toggle In/Out based on last record)
                    // If no last record, default to 'in'. If last was 'in', now is 'out'.
                    const type = (lastRecord && lastRecord.type === 'in') ? 'out' : 'in';
                    
                    // 3. Save to Firestore
                    // Note: We trust the QR text is the Shop Name (as per settings generator)
                    const payload = {
                        employeeId: user.uid,
                        employeeName: user.displayName || 'Staff',
                        shop: qrText, // The QR code contains the Shop Name
                        timestamp: window.fb.serverTimestamp(),
                        type: type,
                        verificationMethod: 'qr',
                        location: gps || { manual: true, note: 'QR Scan - No GPS' }
                    };

                    await window.fb.addDoc(window.fb.collection(window.fb.db, 'attendance'), payload);

                    // 4. Update UI
                    setLastRecord({ ...payload, timestamp: { toDate: () => new Date() } }); // Mock timestamp for immediate UI update
                    setStatus('Success!');
                    alert(`Successfully Checked ${type.toUpperCase()} at ${qrText}`);

                } catch (error) {
                    console.error("Check-in failed", error);
                    alert("Failed to save check-in. Please try again.");
                } finally {
                    setLoading(false);
                }
            };

            // Calculate active status color
            const isCheckedIn = lastRecord && lastRecord.type === 'in';

            return (
                <div className="flex flex-col h-screen bg-slate-900">
                    {/* Header */}
                    <div className="p-6 flex justify-between items-center bg-slate-800 shadow-md">
                        <div>
                            <h2 className="text-lg font-bold text-white">Hello, {user.displayName || 'Staff'}</h2>
                            <p className="text-xs text-slate-400">{new Date().toLocaleDateString()}</p>
                        </div>
                        <button onClick={() => window.fb.signOut(window.fb.auth)} className="text-red-400 bg-slate-700 p-2 rounded-full">
                            <i className="fas fa-power-off"></i>
                        </button>
                    </div>

                    {/* Status Card */}
                    <div className="p-6 flex flex-col items-center justify-center flex-1 space-y-8">
                        <div className={`w-40 h-40 rounded-full flex items-center justify-center border-4 shadow-2xl ${isCheckedIn ? 'border-green-500 shadow-green-500/20 bg-green-500/10' : 'border-slate-600 bg-slate-800'}`}>
                            <div className="text-center">
                                <p className="text-sm text-slate-400 uppercase tracking-widest mb-1">Current Status</p>
                                <h3 className={`text-2xl font-bold ${isCheckedIn ? 'text-green-400' : 'text-slate-300'}`}>
                                    {isCheckedIn ? 'CHECKED IN' : 'CHECKED OUT'}
                                </h3>
                            </div>
                        </div>

                        <div className="text-center space-y-1">
                            {lastRecord && (
                                <>
                                    <p className="text-slate-400 text-sm">Last Activity:</p>
                                    <p className="text-white font-medium text-lg">
                                        {lastRecord.shop} <span className="mx-2 text-slate-600">|</span> {lastRecord.timestamp?.toDate ? lastRecord.timestamp.toDate().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}) : 'Just now'}
                                    </p>
                                </>
                            )}
                        </div>

                        {/* Scan Button */}
                        <button 
                            onClick={() => setScanning(true)} 
                            disabled={loading}
                            className="w-full max-w-xs py-5 rounded-2xl bg-gradient-to-r from-blue-600 to-indigo-600 text-white font-bold text-xl shadow-xl shadow-blue-900/20 active:scale-95 transition-transform flex items-center justify-center gap-3"
                        >
                            {loading ? (
                                <i className="fas fa-spinner fa-spin"></i>
                            ) : (
                                <>
                                    <i className="fas fa-qrcode"></i>
                                    <span>{isCheckedIn ? 'Scan to Check OUT' : 'Scan to Check IN'}</span>
                                </>
                            )}
                        </button>
                    </div>

                    {/* Footer */}
                    <div className="p-4 text-center text-xs text-slate-600">
                        <p>Smart HR System v2.0</p>
                    </div>

                    {/* Scanner Modal */}
                    <ScannerModal isOpen={scanning} onClose={() => setScanning(false)} onScan={handleScanSuccess} />
                </div>
            );
        };

        const App = () => {
            const [user, setUser] = useState(null);
            const [loading, setLoading] = useState(true);

            useEffect(() => {
                window.fb.auth.onAuthStateChanged((u) => {
                    if (u) {
                        // Check if user has a profile in Firestore (Optional validation)
                        const q = window.fb.query(window.fb.collection(window.fb.db, 'employees'), window.fb.where('uid', '==', u.uid));
                        window.fb.getDocs(q).then(snap => {
                            if (!snap.empty) {
                                // Add display name from DB if Auth doesn't have it
                                const data = snap.docs[0].data();
                                u.displayName = data.name; 
                                setUser(u);
                            } else {
                                alert("No employee record found for this account.");
                                window.fb.signOut(window.fb.auth);
                            }
                            setLoading(false);
                        });
                    } else {
                        setUser(null);
                        setLoading(false);
                    }
                });
            }, []);

            if (loading) return <div className="flex h-screen items-center justify-center bg-slate-900 text-blue-500"><i className="fas fa-circle-notch fa-spin text-4xl"></i></div>;

            return user ? <MainScreen user={user} /> : <LoginScreen />;
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
