<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Smart HR Management System</title>
    
    <!-- PWA Manifest Link -->
    <link rel="manifest" href="./manifest.json">
    <meta name="theme-color" content="#0f172a">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/3135/3135715.png">

    <!-- External Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" xintegrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js" xintegrity="sha512-BNaRQnYJYiPSqHHDb58B0yaPfCu+Wgds8Gp/gU33kqBtgNS4tSPHuGibyoVBL5gI9kLmbG0C+wFjr8bCqwY2SA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <!-- FIX (Bug #1): Add DOMPurify library to sanitize HTML and prevent XSS attacks. -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/2.3.10/purify.min.js" xintegrity="sha512-C3B32e/iyn0Lhj3mG4PzKAftE49fXUDf2l2Rk2HM71PaGNm1LpB4i/kXdiG5YkF1r83lWWI41D0OMfVYl43hJg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    
    <!-- NEW: QR Code Generator Library (Phase 1) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>

    <!-- NEW: HTML5 QR Code Scanner Library (Step 1) -->
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

    <!-- Quill Rich Text Editor -->
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
    
    <!-- Custom Styles & Fonts -->
    <style>
        @import url('https://rsms.me/inter/inter.css');
        html, body { 
            font-family: 'Inter', sans-serif;
            overflow-x: hidden; /* Prevents horizontal scrolling */
        }
        /* Base input styles for a consistent look */
        .input, .select {
            margin-top: 0.25rem; display: block; width: 100%; padding: 0.5rem 0.75rem;
            border-width: 1px; border-color: #475569; border-radius: 0.375rem;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); line-height: 1.5;
            background-color: #334155; color: #f1f5f9;
        }
        .input:focus, .select:focus {
            outline: 2px solid transparent; outline-offset: 2px;
            --tw-ring-color: #2563eb; border-color: #2563eb;
        }
        .input[disabled], .select[disabled] {
            background-color: #475569;
            cursor: not-allowed;
            opacity: 0.7;
        }
        input[type="checkbox"]:disabled {
            cursor: not-allowed;
            opacity: 0.5;
        }
        /* Styles for rendered policy content */
        .policy-content p { margin-bottom: 1rem; line-height: 1.6; }
        .policy-content h1, .policy-content h2, .policy-content h3 { font-weight: bold; margin-top: 1.5rem; margin-bottom: 0.5rem; color: #f1f5f9; border-bottom: 1px solid #475569; padding-bottom: 0.25rem; }
        .policy-content h1 { font-size: 1.5em; }
        .policy-content h2 { font-size: 1.25em; }
        .policy-content h3 { font-size: 1.1em; }
        .policy-content ul, .policy-content ol { margin-left: 1.5rem; margin-bottom: 1rem; }
        .policy-content ul { list-style-type: disc; }
        .policy-content ol { list-style-type: decimal; }
        .policy-content a { color: #60a5fa; text-decoration: underline; }
        .policy-content strong { font-weight: bold; }
        .policy-content em { font-style: italic; }
        .policy-content u { text-decoration: underline; }
        .policy-content pre { background-color: #1e293b; padding: 1rem; border-radius: 0.5rem; white-space: pre-wrap; }
        .policy-content blockquote { border-left: 4px solid #475569; padding-left: 1rem; margin-left: 0; color: #94a3b8; }
        
        /* NEW: Correct Animation for Dashboard (Stays Visible) */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in {
            animation: fadeIn 0.6s ease-out forwards;
        }

        /* NEW: QR Scanner Styles (Step 1) */
        .scanner-box { 
            border-radius: 1rem; 
            overflow: hidden; 
            border: 2px solid #334155; 
            background: #000; 
            min-height: 300px; 
            width: 100%; 
        }
    </style>
</head>
<body class="bg-slate-900 text-slate-300">
    <div id="root"></div>

    <!-- Firebase SDK Module -->
    <script type="module">
        // Firebase SDK imports
        import { initializeApp, deleteApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut, createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        // MODIFIED (STEP 6.C): Added 'collectionGroup'
        // FIX: Added 'getDoc', 'arrayUnion', and 'arrayRemove' to imports
        import { getFirestore, collection, onSnapshot, doc, getDoc, addDoc, updateDoc, deleteDoc, query, where, serverTimestamp, getDocs, writeBatch, enableIndexedDbPersistence, setDoc, orderBy, limit, startAfter, runTransaction, deleteField, collectionGroup, arrayUnion, arrayRemove } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Make Firebase SDK available globally for the Babel script
        window.firebaseSDK = {
            initializeApp, deleteApp, getAuth, getFirestore, collection, onSnapshot,
            doc, getDoc, addDoc, updateDoc, deleteDoc, query, where, serverTimestamp,
            signInWithEmailAndPassword, onAuthStateChanged, signOut, getDocs, writeBatch,
            enableIndexedDbPersistence, setDoc,
            // MODIFIED (STEP 6.C): Added 'collectionGroup'
            orderBy, limit, startAfter, createUserWithEmailAndPassword, runTransaction, deleteField, collectionGroup, arrayUnion, arrayRemove
        };
    </script>
    
    <!-- React Application Script -->
    <script type="text/babel">
        // --- SERVICE WORKER REGISTRATION ---
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./service-worker.js')
                    .then(registration => {
                        console.log('SW registered: ', registration);
                    })
                    .catch(registrationError => {
                        console.log('SW registration failed: ', registrationError);
                    });
            });
        }

        // --- START REACT & FIREBASE SETUP ---
        const { useState, useEffect, useMemo, useCallback, createContext, useContext, memo, useRef } = React;

        // ... (rest of the React application code)
        // === FIREBASE CONFIGURATION ===
        // To deploy this application for a new company, replace the values in the
        // `firebaseConfig` object below with the new project's configuration details
        // from the Firebase console. This is the ONLY place you need to change it.
        // ===================================================================================
        const firebaseConfig = {
            apiKey: "AIzaSyB7_pnmwHj6aOeZRTykPvNusNFYReaTY6Q",
            authDomain: "hrsm-j.firebaseapp.com",
            projectId: "hrsm-j",
            storageBucket: "hrsm-j.appspot.com",
            messagingSenderId: "45063715478",
            appId: "1:45063715478:web:cc2dd21b83dd195771e0b7",
            measurementId: "G-8HQDG2LTKP"
        };

        // NEW: Dynamic Configuration Loader
        // Checks localStorage for an admin-saved configuration.
        // Falls back to the hardcoded config if nothing is found.
        let activeFirebaseConfig = firebaseConfig;
        try {
            const customConfigStr = localStorage.getItem('customFirebaseConfig');
            if (customConfigStr) {
                const customConfig = JSON.parse(customConfigStr);
                // Basic validation to ensure it's a valid config object
                if (customConfig.apiKey && customConfig.projectId) {
                    activeFirebaseConfig = customConfig;
                    console.log("Using custom Firebase configuration from localStorage.");
                }
            }
        } catch (error) {
            console.error("Failed to parse custom Firebase config, using default.", error);
        }

        // NEW: Connectivity Context for online/offline status
        const ConnectivityContext = createContext(null);
        const useConnectivity = () => useContext(ConnectivityContext);
        const ConnectivityProvider = ({ children }) => {
            const [isOnline, setIsOnline] = useState(navigator.onLine);

            useEffect(() => {
                const updateOnlineStatus = () => {
                    setIsOnline(navigator.onLine);
                };

                window.addEventListener('online', updateOnlineStatus);
                window.addEventListener('offline', updateOnlineStatus);

                // Set up a polling interval as a fallback for iframe environments where
                // the 'online'/'offline' events may not fire reliably. This checks the
                // navigator.onLine property directly every 3 seconds.
                const interval = setInterval(updateOnlineStatus, 3000);

                return () => {
                    window.removeEventListener('online', updateOnlineStatus);
                    window.removeEventListener('offline', updateOnlineStatus);
                    clearInterval(interval); // Cleanup on component unmount
                };
            }, []);

            return (
                <ConnectivityContext.Provider value={{ isOnline }}>
                    {children}
                </ConnectivityContext.Provider>
            );
        };

        // Firebase Configuration - MOVED TO TOP OF SCRIPT

        // Firebase Context for providing db and auth instances throughout the app
        const FirebaseContext = createContext(null);
        const useFirebase = () => useContext(FirebaseContext);

        const FirebaseProvider = ({ children }) => {
            const [db, setDb] = useState(null);
            const [auth, setAuth] = useState(null);
            const [currentUser, setCurrentUser] = useState(null);
            const [userProfile, setUserProfile] = useState(null);
            const [loading, setLoading] = useState(true);

            // Initialize Firebase and Auth state listener
            useEffect(() => {
                try {
                    const { initializeApp, getFirestore, getAuth, onAuthStateChanged, enableIndexedDbPersistence } = window.firebaseSDK;
                    const app = initializeApp(activeFirebaseConfig);
                    const dbInstance = getFirestore(app);
                    
                    // Enable offline persistence
                    enableIndexedDbPersistence(dbInstance).catch((err) => {
                        if (err.code === 'failed-precondition') console.warn("Firestore persistence failed: Multiple tabs open.");
                        else if (err.code === 'unimplemented') console.warn("Firestore persistence failed: Browser does not support it.");
                    });

                    const authInstance = getAuth(app);
                    setAuth(authInstance);
                    setDb(dbInstance);

                    const unsubscribe = onAuthStateChanged(authInstance, (user) => {
                        setCurrentUser(user);
                        if (!user) {
                            setUserProfile(null);
                            setLoading(false);
                        }
                    });
                    return () => unsubscribe();
                } catch (error) { 
                    console.error("Firebase initialization error:", error); 
                    setLoading(false);
                } 
            }, []);

            // Fetch user profile from Firestore when auth state changes
            useEffect(() => {
                if (!db || !currentUser) {
                    if (!currentUser) setLoading(false);
                    setUserProfile(null);
                    return;
                }

                setLoading(true);
                const { collection, query, where, onSnapshot } = window.firebaseSDK;
                const q = query(collection(db, "employees"), where("uid", "==", currentUser.uid));
                
                const unsubscribe = onSnapshot(q, (snapshot) => {
                    if (!snapshot.empty) {
                        const userDoc = snapshot.docs[0];
                        setUserProfile({ id: userDoc.id, ...userDoc.data() });
                    } else {
                        console.warn("Authenticated user has no employee profile in Firestore.");
                        setUserProfile(null);
                    }
                    setLoading(false);
                }, (error) => {
                    console.error("Error fetching user profile:", error);
                    setLoading(false);
                });

                return () => unsubscribe();
            }, [db, currentUser]);

            const value = { db, auth, currentUser, userProfile, loading };
            return <FirebaseContext.Provider value={value}>{children}</FirebaseContext.Provider>;
        };
        
        // Custom hook for real-time Firestore collection data
        const useCollection = (collectionName, queryConstraints = []) => {
            const { db, currentUser } = useFirebase(); // Get currentUser
            const [data, setData] = useState([]);
            const [loading, setLoading] = useState(true);

            useEffect(() => {
                if (!db || !currentUser) { // Add guard for currentUser
                    // If there's no user yet, we are in a loading state. Don't set loading to false.
                    setLoading(true);
                    return;
                }

                setLoading(true);
                const { collection, onSnapshot, query } = window.firebaseSDK;
                const q = query(collection(db, collectionName), ...queryConstraints);
                const unsubscribe = onSnapshot(q, (querySnapshot) => {
                    const items = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    setData(items);
                    setLoading(false);
                }, (error) => {
                    console.error(`Error fetching collection ${collectionName}:`, error);
                    setLoading(false);
                });
                return () => unsubscribe();
            }, [db, currentUser, collectionName, JSON.stringify(queryConstraints)]); // Add currentUser to dependency array
            return { data, loading };
        };

        // Custom hook for one-time Firestore collection data fetch
        const useStaticCollection = (collectionName) => {
            const { db, currentUser } = useFirebase();
            const [data, setData] = useState([]);
            const [loading, setLoading] = useState(true);

            useEffect(() => {
                if (!db || !currentUser) {
                    setLoading(true);
                    return;
                }

                const fetchData = async () => {
                    setLoading(true);
                    try {
                        const { collection, getDocs } = window.firebaseSDK;
                        const querySnapshot = await getDocs(collection(db, collectionName));
                        const items = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        setData(items);
                    } catch (error) {
                        console.error(`Error fetching static collection ${collectionName}:`, error);
                    } finally {
                        setLoading(false);
                    }
                };

                fetchData();
            }, [db, currentUser, collectionName]);

            return { data, loading };
        };
        
        // --- NEW: GLOBAL NAVIGATION CONFIGURATION ---
        // Centralized configuration for all app modules. 
        const APP_MODULES = [
            { key: 'dashboard', label: 'Dashboard', icon: 'fa-chart-pie', color: 'text-blue-500', bg: 'bg-blue-500/10' },
            { key: 'companyHub', label: 'Company Hub', icon: 'fa-building', color: 'text-indigo-500', bg: 'bg-indigo-500/10' }, // MERGED: Notice & Policy
            { key: 'employees', label: 'Employees', icon: 'fa-user-group', color: 'text-purple-500', bg: 'bg-purple-500/10' },
            { key: 'checkinme', label: 'CheckInMe', icon: 'fa-fingerprint', color: 'text-cyan-400', bg: 'bg-cyan-500/10' },
            { key: 'attendanceReport', label: 'Attendance Report', icon: 'fa-clipboard-user', color: 'text-indigo-400', bg: 'bg-indigo-500/10' },
            { key: 'payroll', label: 'Payroll', icon: 'fa-sack-dollar', color: 'text-emerald-400', bg: 'bg-emerald-500/10' },
            { key: 'hrBanking', label: 'HR Banking', icon: 'fa-landmark', color: 'text-yellow-500', bg: 'bg-yellow-500/10' },
            { key: 'expenseReport', label: 'Expense Report', icon: 'fa-receipt', color: 'text-pink-500', bg: 'bg-pink-500/10' },
            { key: 'assets', label: 'Asset Manager', icon: 'fa-boxes-stacked', color: 'text-orange-500', bg: 'bg-orange-500/10' },
            { key: 'tasks', label: 'Task Manager', icon: 'fa-list-check', color: 'text-lime-400', bg: 'bg-lime-500/10' }, 
            { key: 'userActivity', label: 'User Activity', icon: 'fa-timeline', color: 'text-teal-400', bg: 'bg-teal-500/10' },
            { key: 'settings', label: 'Settings', icon: 'fa-sliders', color: 'text-gray-400', bg: 'bg-gray-500/10' }
        ];
        
        // NEW: Standalone payroll calculation logic
        // MODIFIED: Added 'savingsWithdrawals' as a new argument
        // MODIFIED (STEP 5): Added 'savingsData' as a new argument
        const calculatePayrollForEmployee = (employee, selectedMonth, allData, manualLoanDeduction, savingsWithdrawals = [], savingsData = null) => {
            if (!employee || !selectedMonth) return { inputs: {}, calculations: {} };

            // NEW (Plan Step 1): Log the incoming withdrawal data to confirm it's being received.
            console.log(`[Payroll Calc] Received ${savingsWithdrawals.length} savings withdrawals for ${employee?.name} in ${selectedMonth}`, savingsWithdrawals);

            const { attendance, leaveRequests, otRequests, staffLoans, employeeStates, salaryRevisions, shops, shifts } = allData;

            // --- FIX: MOVED TIMEZONE LOGIC UP ---
            // We must get the employee's timezone *first* to correctly filter attendance by the local month.
            // 1. Determine the correct "home shop" name. Prioritize the new 'primaryShop' field.
            const employeeShopName = employee.primaryShop 
                ? employee.primaryShop // Use the new field if it exists
                : (Array.isArray(employee.shop) ? employee.shop[0] : employee.shop); // Fallback to old logic
            
            // 2. Find the shop details from the allData.shops list
            const employeeShop = (shops || []).find(s => s.name === employeeShopName);
            
            // 3. Get the timezone. This will now be the timezone of the primary shop.
            const employeeShopTimezone = employeeShop?.timezone; // e.g., 'Asia/Phnom_Penh'

            // --- 1. Filter data for the selected employee and month ---
            
            // FIX: The original filter used .toISOString().startsWith(selectedMonth), which is timezone-unaware
            // and caused the bug. This new filter uses the employee's shop timezone to get the correct
            // set of attendance records for their local month.
            const monthAttendance = (attendance || []).filter(r => {
                if (r.employeeId !== employee.id) return false;
                if (!r.timestamp || !r.timestamp.toDate) return false;
                // Get the record's local date (e.g., '2025-11-12') using the employee's primary shop timezone
                const { localDate } = Utils.formatDateInTimezone(r.timestamp, employeeShopTimezone);
                // Check if that local date's month (e.g., '2025-11') matches the selected month
                return localDate.startsWith(selectedMonth);
            });
            const monthLeave = (leaveRequests || []).filter(r => r.staffId === employee.id && r.status === 'Approved' && r.leaveDate.startsWith(selectedMonth));
            const monthOT = (otRequests || []).filter(r => r.staffId === employee.id && r.status === 'Approved' && r.reqDate.startsWith(selectedMonth));
            const monthStates = (employeeStates || []).filter(r => r.staffId === employee.id && r.date.startsWith(selectedMonth));
            
            // --- FIX: Corrected loan-finding logic ---
            // The previous .find() logic was not deterministic and could grab the wrong loan
            // if an employee had multiple active loans.
            // This new logic finds ALL applicable loans and sorts them to get the one
            // with the most recent effectiveDate that is on or before the selected month.
            const applicableLoans = (staffLoans || [])
                .filter(l => l.staffId === employee.id && 
                             l.status === 'Active' && 
                             (!l.effectiveDate || l.effectiveDate.slice(0, 7) <= selectedMonth)
                )
                .sort((a, b) => (b.effectiveDate || '0000-00').localeCompare(a.effectiveDate || '0000-00'));
            
            const activeLoan = applicableLoans.length > 0 ? applicableLoans[0] : null;
            // --- END FIX ---

            // --- MOVED UP: Calculate Base Salary & Salary Per Day first, as it's needed for penalty calculation ---
            const [year, month] = selectedMonth.split('-').map(Number);
            const daysInMonth = new Date(year, month, 0).getDate();
            const applicableRevisions = (salaryRevisions || [])
                .filter(rev => rev.staffId === employee.id && rev.effectiveDate && rev.effectiveDate <= `${selectedMonth}-31` && rev.status === 'Approved')
                .sort((a, b) => b.effectiveDate.localeCompare(a.effectiveDate));
            
            // --- START FIX: Prevent NaN from employee.salary or updatedSalary ---
            // The (parseFloat(...) || 0) pattern is flawed, as (NaN || 0) results in NaN.
            // We must explicitly check for NaN.
            let parsedBaseSalary;
            if (applicableRevisions.length > 0) {
                parsedBaseSalary = parseFloat(String(applicableRevisions[0].updatedSalary).replace(/[^0-9.-]/g, ''));
            } else {
                parsedBaseSalary = parseFloat(String(employee.salary).replace(/[^0-9.-]/g, ''));
            }
            
            const baseSalary = isNaN(parsedBaseSalary) ? 0 : parsedBaseSalary;
            // --- END FIX ---
            
            const salaryPerDay = baseSalary > 0 && daysInMonth > 0 ? baseSalary / daysInMonth : 0;


            // --- 2. Calculate inputs automatically ---
            const leaveDays = monthLeave.reduce((sum, r) => sum + (parseFloat(r.numberOfDays) || 0), 0);
            const otDays = monthOT.reduce((sum, r) => sum + (parseFloat(r.numberOfOTDays) || 0), 0);
            
            // --- FIX: Separate auto-calculation from manual override ---
            // 1. Calculate the "pure" automatic loan deduction first.
            const autoLoanDeduction = (activeLoan ? parseFloat(activeLoan.agreedMonthlyDeduction) || 0 : 0);
            // 2. Use the manual override if it exists, otherwise use the auto-value.
            const loanDeduction = manualLoanDeduction !== undefined ? parseFloat(manualLoanDeduction) : autoLoanDeduction;
            // --- END FIX ---
            
            const totalLateDays = monthStates.filter(es => es.statusState === 'Deduction' && es.note?.includes('CheckIn Late @')).length;

            // --- NEW (STEP 2): Get the employee's primary shop and their assigned timezone. This is crucial for all date calculations. ---
            // 1. Determine the correct "home shop" name. Prioritize the new 'primaryShop' field.
            // --- THIS BLOCK (lines 2198-2207) IS NOW MOVED to line 2158 ---
            /*
            const employeeShopName = employee.primaryShop 
                ? employee.primaryShop // Use the new field if it exists
                : (Array.isArray(employee.shop) ? employee.shop[0] : employee.shop); // Fallback to old logic

            // 2. Find the shop details from the allData.shops list
            const employeeShop = (shops || []).find(s => s.name === employeeShopName);
            
            // 3. Get the timezone. This will now be the timezone of the primary shop.
            const employeeShopTimezone = employeeShop?.timezone; // e.g., 'Asia/Phnom_Penh'
            */

            const dailyRecords = {};
            monthAttendance.forEach(rec => {
                // FIX: Use the timezone-aware utility to get the date key based on the shop's local timezone.
                const { localDate: dayKey } = Utils.formatDateInTimezone(rec.timestamp, employeeShopTimezone);
                
                if (!dailyRecords[dayKey]) dailyRecords[dayKey] = [];
                // Push the original Javascript Date object for time difference calculations.
                dailyRecords[dayKey].push({ date: rec.timestamp.toDate(), type: rec.type });
            });
            
            let workDays = 0;
            let noCheckOutCount = 0;
            // FIX: Get today's date string formatted in the shop's local timezone to correctly identify past vs. present days.
            const { localDate: todayStr } = Utils.formatDateInTimezone({ toDate: () => new Date() }, employeeShopTimezone);


            Object.entries(dailyRecords).forEach(([dayKey, dayRecs]) => {
                const ins = dayRecs.filter(r => r.type === 'in').sort((a,b) => a.date - b.date);
                const outs = dayRecs.filter(r => r.type === 'out').sort((a,b) => b.date - a.date);
                if (ins.length > 0 && outs.length > 0) {
                    const diffHours = (outs[0].date.getTime() - ins[0].date.getTime()) / 3600000;
                    if (diffHours >= 7) workDays += 1;
                    else if (diffHours >= 4) workDays += 0.5;
                } else if (ins.length > 0 && dayKey < todayStr) {
                    noCheckOutCount += 1;
                }
            });

            // NEW: Calculate Absent days & Penalty for absence on a rejected leave day.
            const attendedDays = new Set(Object.keys(dailyRecords));
            let absentDays = 0;
            let rejectedLeavePenaltyAmount = 0; // Initialize penalty amount

            for (let day = 1; day <= daysInMonth; day++) {
                const currentDay = new Date(year, month - 1, day);
                const loop_year = currentDay.getFullYear();
                const loop_month = String(currentDay.getMonth() + 1).padStart(2, '0');
                const loop_day = String(currentDay.getDate()).padStart(2, '0');
                const dayKey = `${loop_year}-${loop_month}-${loop_day}`;

                // FIX: Compare against the timezone-aware 'today' string instead of a local Date object.
                if (dayKey >= todayStr) break; // Don't count today or future days as absent.

                // An absence is a past day with no attendance record.
                if (!attendedDays.has(dayKey)) {
                    // FIX: Check if the employee was on approved leave for this day before marking as absent.
                    const isOnApprovedLeave = monthLeave.some(lr => dayKey >= lr.leaveDate && dayKey < lr.returnDate);
                    
                    if (!isOnApprovedLeave) {
                        absentDays++; // Only count as absent if not on approved leave.

                        // Check if there was a REJECTED leave request for this absent day.
                        const hadRejectedLeave = (leaveRequests || []).some(
                            lr => lr.staffId === employee.id &&
                                  lr.status === 'Rejected' &&
                                  // Check if the absent day falls within the rejected leave period.
                                  dayKey >= lr.leaveDate && dayKey < lr.returnDate 
                        );
                        
                        if (hadRejectedLeave) {
                            // Apply penalty: Salary per day x 2
                            rejectedLeavePenaltyAmount += (salaryPerDay * 2);
                        }
                    }
                }
            }
            
            const noAttendance = absentDays + noCheckOutCount;

            // NEW: Calculate "Given Off Days" based on the total number of work days.
            const givenOffDays = Math.floor(workDays / 6.5);

            // FIX: Create the autoInputs object to be returned, now including noAttendance.
            // --- MODIFIED: Also add the new autoLoanDeduction field ---
            const autoInputs = { workDays, givenOffDays, otDays, leaveDays, totalLateDays, noCheckOutCount, loanDeduction, noAttendance, autoLoanDeduction: autoLoanDeduction };

            // --- 3. Perform Final Salary Calculations ---
            const engagements = monthStates.filter(es => es.statusState === 'Engagement' && es.status === 'Approved').reduce((sum, item) => sum + (parseFloat(item.amount) || 0), 0);
            
            const lateDeductionsAmount = monthStates.filter(es => {
                if (!(es.statusState === 'Deduction' && es.note?.includes('CheckIn Late @'))) return false;
                const hasLeave = (leaveRequests || []).some(lr => lr.staffId === es.staffId && lr.status === 'Approved' && es.date >= lr.leaveDate && es.date < lr.returnDate);
                return !hasLeave;
            }).reduce((sum, item) => sum + (parseFloat(item.amount) || 0), 0);
            
            const otherDeductions = monthStates.filter(es => es.statusState === 'Deduction' && !es.note?.includes('CheckIn Late @')).reduce((sum, item) => sum + (parseFloat(item.amount) || 0), 0);

            // "No-CheckOut" is informational. Any associated monetary deduction is handled via the "Other Deductions" from Employee States.
            const daysToPayFor = (workDays || 0) + (givenOffDays || 0);
            const baseSalaryEarned = salaryPerDay * (daysToPayFor > 0 ? daysToPayFor : 0);
            const otSalary = salaryPerDay * (otDays || 0);
            
            // --- NEW (Plan Step 2, Part B): Calculate total savings withdrawal ---
            // Sum up all withdrawal amounts. This will be added to earnings.
            const totalSavingsWithdrawal = (savingsWithdrawals || []).reduce(
                (sum, tx) => sum + (parseFloat(tx.amountWithdrawn) || 0), 0
            );
            
            // MODIFIED (Plan Step 2, Part B): Add the savings withdrawal to the gross salary.
            const grossSalary = baseSalaryEarned + otSalary + engagements + totalSavingsWithdrawal;

            // --- NEW: Step 3 - Calculate Voluntary Savings Deduction ---
            let savingsDeduction = 0;
            // MODIFIED (STEP 5): This logic is now refactored to use the new 'savingsData' object
            // instead of the deprecated fields on the 'employee' object.
            if (
                savingsData && // Check if savingsData object exists
                savingsData.savingsProgramStatus === 'Active' &&
                parseFloat(savingsData.savingsPercentage) > 0 &&
                savingsData.savingsEffectiveMonth && 
                selectedMonth >= savingsData.savingsEffectiveMonth &&
                totalSavingsWithdrawal === 0 // Only deduct if no withdrawal
            ) {
                const percentage = parseFloat(savingsData.savingsPercentage) / 100;
                // Round the savings deduction
                savingsDeduction = Math.round(grossSalary * percentage);
            }
            // --- END: Step 3 ---
            
            // CORRECTED & UPDATED: Added the new penalty AND savings deduction to total deductions.
            const totalDeductions = loanDeduction + lateDeductionsAmount + otherDeductions + rejectedLeavePenaltyAmount + savingsDeduction;
            
            // FIX (Bug #4): Round the final netSalary to handle potential floating point inaccuracies.
            // Since KHR is the primary currency and has no decimal units, rounding to the nearest
            // whole number ensures a clean, accurate final value.
            const netSalary = Math.round(grossSalary - totalDeductions);

            // CORRECTED & UPDATED: Added new penalty and savings amounts to the returned calculations object.
            // MODIFIED (Plan Step 2): Add 'totalSavingsWithdrawal' to the calculations object.
            const calculations = { baseSalary, salaryPerDay, daysInMonth, baseSalaryEarned, otSalary, engagements, totalSavingsWithdrawal, grossSalary, otherDeductions, totalDeductions, netSalary, lateDeductionsAmount, rejectedLeavePenaltyAmount, savingsDeduction };

            return { inputs: autoInputs, calculations };
        };
        
        // NEW: Centralized Payroll Calculator Hook
        // MODIFIED: Added 'savingsWithdrawals' as a new argument and to the dependency array
        // MODIFIED (STEP 5): Added 'savingsData' as a new argument
        const usePayrollCalculator = (employee, selectedMonth, allData, manualLoanDeduction, savingsWithdrawals, savingsData) => {
            return useMemo(() => {
                // The complex logic is now in a separate function.
                // MODIFIED: Pass 'savingsWithdrawals' to the core function
                // MODIFIED (STEP 5): Pass 'savingsData' to the core function
                return calculatePayrollForEmployee(employee, selectedMonth, allData, manualLoanDeduction, savingsWithdrawals, savingsData);
            }, [employee, selectedMonth, allData, manualLoanDeduction, savingsWithdrawals, savingsData]); // MODIFIED (STEP 5): Added 'savingsData'
        };

        // NEW: Phase 3 - App Data Context for centralizing common data
        const AppDataContext = createContext(null);
        const useAppData = () => useContext(AppDataContext);

        const AppDataProvider = ({ children }) => {
            const { userProfile } = useFirebase();
            const { where } = window.firebaseSDK;
            
            // Create role-based query constraints to prevent permission errors.
            const employeeQueryConstraints = useMemo(() => {
                if (!userProfile) {
                    return [where("uid", "==", "null")];
                }
                const { role, uid, shop } = userProfile;

                if (role === 'Admin' || role === 'CEO' || role === 'Shop Manager') {
                    return [];
                }

                // FIX: Staff need to see colleagues for Birthday/Social features.
                // We filter by their assigned shop to allow "Social" visibility while restricting scope.
                if (role === 'Staff') {
                    const shopName = Array.isArray(shop) ? shop[0] : shop;
                    if (shopName) {
                        return [where("shop", "==", shopName), where("status", "==", "Active")];
                    }
                }

                // Fallback: If no shop assigned, only show self
                return [where("uid", "==", uid)];
            }, [userProfile]);

            // FIX: Switched from useStaticCollection to useCollection (Real-Time)
            // This ensures that when an Admin updates Settings (Shifts, Shops, Positions),
            // the UI reflects the changes immediately without needing a page refresh.
            const { data: employees, loading: employeesLoading } = useCollection('employees', employeeQueryConstraints);
            const { data: shops, loading: shopsLoading } = useCollection('shops');
            const { data: shifts, loading: shiftsLoading } = useCollection('shifts');
            const { data: positions, loading: positionsLoading } = useCollection('positions');
            
            // NEW: Fetch Expense Categories in real-time so updates in Settings reflect immediately in the Expense Report
            const { data: expenseCategories, loading: categoriesLoading } = useCollection('expenseCategories');

            // NEW: Fetch KPIs globally for Task Manager & Settings
            const { data: kpis, loading: kpisLoading } = useCollection('kpis');

            // NEW: Fetch Tasks for the Kanban Board (Optional: could be moved to the specific page if data gets heavy)
            // We fetch specific page data locally, so no global fetch here to save bandwidth.

            // Combine all loading states into a single flag.
            const isLoading = employeesLoading || shopsLoading || shiftsLoading || positionsLoading || categoriesLoading || kpisLoading;

            const value = useMemo(() => ({
                employees,
                shops,
                shifts,
                positions,
                expenseCategories, // Expose categories to the app
                kpis,              // NEW: Expose KPIs to the app
                isLoading
            }), [employees, shops, shifts, positions, expenseCategories, kpis, isLoading]);

            return (
                <AppDataContext.Provider value={value}>
                    {children}
                </AppDataContext.Provider>
            );
        };
        // --- END REACT & FIREBASE SETUP ---

        // --- START UTILITY FUNCTIONS ---
        const Utils = {
            formatCurrency: (value, currency = 'KHR') => {
                if (value === null || value === undefined) return '';
                const num = parseFloat(String(value).replace(/[^0-9.-]/g, ''));
                if (isNaN(num)) return '';
                const options = { style: 'currency', currency: currency, minimumFractionDigits: currency === 'KHR' ? 0 : 2, maximumFractionDigits: currency === 'KHR' ? 0 : 2 };
                const locale = currency === 'KHR' ? 'km-KH' : 'en-US';
                let formatted = new Intl.NumberFormat(locale, options).format(num);
                if (currency === 'KHR') { formatted = formatted.replace('KHR', '៛').trim(); }
                return formatted;
            },
            formatRequestDate: (timestamp) => {
                if (!timestamp || !timestamp.toDate) return 'N/A';
                const date = timestamp.toDate();
                return `${date.toLocaleDateString('en-GB', { day: '2-digit', month: '2-digit', year: '2-digit' })} | ${date.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: true })}`;
            },
            formatISOToDisplay: (isoDate) => {
                if (!isoDate || typeof isoDate !== 'string' || !isoDate.includes('-')) return isoDate || '';
                const [year, month, day] = isoDate.split('-');
                return `${day}-${month}-${year}`;
            },
            calculateWorkedDuration: (joinedDate, endDate) => { // Add endDate parameter
                if (!joinedDate) return 'N/A';
                const start = new Date(joinedDate);
                if (isNaN(start.getTime())) return 'N/A';
                const end = endDate ? new Date(endDate) : new Date(); // Use endDate if provided, else use now
                if (isNaN(end.getTime())) return 'N/A'; // Add a check for a valid end date

                let years = end.getFullYear() - start.getFullYear();
                let months = end.getMonth() - start.getMonth();
                let days = end.getDate() - start.getDate();
                if (days < 0) { months--; days += new Date(end.getFullYear(), end.getMonth(), 0).getDate(); }
                if (months < 0) { years--; months += 12; }
                return `${years}Y ${months}M ${days}D`;
            },
            // NEW: Timezone-aware date formatting utility
            formatDateInTimezone: (timestamp, timezone) => {
                // Return defaults if the timestamp is invalid
                if (!timestamp || !timestamp.toDate) {
                    return { localDate: 'N/A', displayDate: 'N/A', localTime: 'N/A' };
                }

                const date = timestamp.toDate();
                // Use the provided timezone, but fall back to the user's browser timezone if it's missing.
                const tz = timezone || Intl.DateTimeFormat().resolvedOptions().timeZone;

                try {
                    // 'sv-SE' (Swedish) locale reliably gives the YYYY-MM-DD format.
                    const localDate = date.toLocaleDateString('sv-SE', { timeZone: tz });
                    
                    // 'en-GB' gives the DD/MM/YYYY format for display purposes.
                    const displayDate = date.toLocaleDateString('en-GB', { day: '2-digit', month: '2-digit', year: 'numeric', timeZone: tz });

                    const localTime = date.toLocaleTimeString('en-US', {
                        hour: '2-digit', minute: '2-digit', hour12: true, timeZone: tz
                    });

                    return { localDate, displayDate, localTime };
                } catch (error) {
                    console.error("Invalid timezone provided to formatter:", timezone, error);
                    // If the provided timezone is invalid, fall back to basic UTC conversion to prevent crashes.
                    const localDate = date.toISOString().split('T')[0];
                    return { localDate, displayDate: localDate, localTime: date.toUTCString() };
                }
            },
            // Haversine formula to calculate distance between two lat/lon points
            getDistance: (lat1, lon1, lat2, lon2) => {
                const R = 6371e3; // Earth's radius in metres
                const φ1 = lat1 * Math.PI/180; const φ2 = lat2 * Math.PI/180;
                const Δφ = (lat2-lat1) * Math.PI/180; const Δλ = (lon2-lon1) * Math.PI/180;
                const a = Math.sin(Δφ/2) * Math.sin(Δφ/2) + Math.cos(φ1) * Math.cos(φ2) * Math.sin(Δλ/2) * Math.sin(Δλ/2);
                const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
                return R * c; // Distance in metres
            },

            // --- NEW FUNCTION FOR SALARY SAVING PROGRAM (STEP 1) ---
            // This function transactionally processes a savings contribution to ensure data integrity.
            // It updates the employee's total balance and creates an audit log entry simultaneously.
            // MODIFIED (STEP 3): Added 'shop' parameter for denormalization.
            // MODIFIED (Feature: Cash Deposit): Added 'note' parameter.
            // MODIFIED (Feature: Custom Date): Added 'customDate' parameter.
            manageSavingsContribution: async (db, employeeId, employeeName, shop, amount, payrollId, note, customDate) => {
                const { doc, collection, serverTimestamp, runTransaction } = window.firebaseSDK;
                const savingsRef = doc(db, 'savingprogram', employeeId);
                const transactionRef = doc(collection(db, 'savingprogram', employeeId, 'transactions'));
        
                try {
                    // NEW: Log the data being passed into the function
                    console.log(`[Savings RUN] manageSavingsContribution called:`, { employeeId, employeeName, shop, amount, payrollId, note, customDate });

                    // Use a transaction to ensure both writes succeed or neither does.
                    await runTransaction(db, async (transaction) => {
                        const savingsDoc = await transaction.get(savingsRef);
                        
                        const parseSafeFloat = (val) => {
                            if (val === null || val === undefined) return 0;
                            const num = parseFloat(val);
                            return isNaN(num) ? 0 : num;
                        };
                        
                        let currentBalance = 0;
                        let currentWithdrawals = 0;

                        if (savingsDoc.exists()) {
                            // --- Doc EXISTS, read values ---
                            currentBalance = parseSafeFloat(savingsDoc.data().currentBalance);
                            currentWithdrawals = parseSafeFloat(savingsDoc.data().mySavingWithdrawalTotal);
                        }

                        // --- NEW LOGIC: DIRECT SUMMATION (User Request) ---
                        // We prioritize the "Total Accumulated Savings" (currentBalance) as the source of truth.
                        // New Balance = Current Balance + Deposit Amount
                        const newBalance = currentBalance + amount;
                        
                        // We assume Credit = Balance + Withdrawals. We recalculate Credit to ensure consistency.
                        // This fixes any legacy data issues where Credit might be 0 or out of sync.
                        const newCredit = newBalance + currentWithdrawals;

                        // NEW: Log the values to be written
                        console.log(`[Savings TX] Updating Balance: ${currentBalance} -> ${newBalance} (Credit set to ${newCredit})`);

                        if (savingsDoc.exists()) {
                            // --- Operation 1: UPDATE existing document ---
                            transaction.update(savingsRef, { 
                                currentBalance: newBalance, 
                                mySavingCredit: newCredit,
                                lastUpdated: serverTimestamp() 
                            });
                        } else {
                            // --- Operation 1: SET new document ---
                            console.warn(`[Savings TX] Savings doc for ${employeeName} did not exist. Creating new doc.`);
                            transaction.set(savingsRef, { 
                                currentBalance: newBalance, 
                                mySavingCredit: newCredit, 
                                mySavingWithdrawalTotal: currentWithdrawals, // 0
                                employeeId: employeeId,
                                employeeName: employeeName,
                                shop: shop, 
                                lastUpdated: serverTimestamp(),
                                savingsProgramStatus: 'Active', // Default
                                savingsPercentage: 0 // Default
                            });
                        }

                        // Operation 2: Create a new transaction log for this specific contribution.
                        // MODIFIED: Use customDate if provided. 
                        // FIX: Append 'T12:00:00' to customDate to force it to Local Noon. 
                        // This prevents '2025-12-01' being treated as UTC Midnight (which could be prev day in US timezones).
                        const transactionDate = customDate ? new Date(`${customDate}T12:00:00`) : serverTimestamp();

                        const logData = {
                            employeeId: employeeId,
                            staffName: employeeName, // Denormalized field
                            shop: shop || 'N/A', // FIX: Prevent undefined 'shop' from failing the transaction
                            date: transactionDate,
                            amountDeducted: amount,
                            type: 'contribution',
                            payrollId: payrollId || null,
                            // MODIFIED (Feature: Cash Deposit): Smart default for the note
                            note: note || (payrollId ? 'Payroll Deduction' : 'Manual Cash Deposit') 
                        };
                        // NEW: Log the data being written to the subcollection
                        console.log(`[Savings TX] Writing log data:`, logData);
                        transaction.set(transactionRef, logData);
                    });
                    console.log(`[Savings SUCCESS] Savings contribution of ${amount} for ${employeeName} processed successfully.`);
                    return { success: true };
                } catch (error) {
                    console.error("Error within manageSavingsContribution transaction: ", error);
                    // NEW: Better error handling for Quota Exceeded
                    if (error.code === 'resource-exhausted') {
                        return { success: false, error: { message: "Daily Quota Exceeded. Please try again tomorrow or upgrade your Firebase plan." } };
                    }
                    return { success: false, error: error };
                }
            },
            // --- NEW FUNCTION FOR SALARY SAVING PROGRAM (STEP 2: Payback) ---
            // This function transactionally processes a savings withdrawal.
            // MODIFIED (STEP 3): Added 'employeeName' and 'shop' parameters for denormalization.
            manageSavingsWithdrawal: async (db, employeeId, employeeName, shop, amount, note) => {
                const { doc, collection, serverTimestamp, runTransaction } = window.firebaseSDK;
                // MODIFIED (STEP 3): Path changed to new '/savingprogram' collection.
                const savingsRef = doc(db, 'savingprogram', employeeId);
                // MODIFIED (STEP 3): Path changed to new '/savingprogram/{id}/transactions' subcollection.
                const transactionRef = doc(collection(db, 'savingprogram', employeeId, 'transactions'));
        
                try {
                    await runTransaction(db, async (transaction) => {
                        const savingsDoc = await transaction.get(savingsRef);
        
                        if (!savingsDoc.exists()) {
                            throw new Error("Employee has no savings record to withdraw from.");
                        }
        
                        // --- BUG FIX: Correctly parse floats, handling NaN/undefined/null ---
                        const parseSafeFloat = (val) => {
                            if (val === null || val === undefined) return 0;
                            const num = parseFloat(val);
                            return isNaN(num) ? 0 : num;
                        };

                        const currentBalance = parseSafeFloat(savingsDoc.data().currentBalance);
                        let currentCredit = parseSafeFloat(savingsDoc.data().mySavingCredit);
                        const currentWithdrawals = parseSafeFloat(savingsDoc.data().mySavingWithdrawalTotal);
                        // --- END BUG FIX ---

                        // --- NEW: Data-Integrity Patch (as requested) ---
                        // This patch detects and fixes legacy data where mySavingCredit was 0
                        // (or null) but currentBalance was correct.
                        if ((currentCredit === 0 || currentCredit === null) && currentBalance > 0) {
                            console.warn(`[Savings Patch: Withdrawal] Fixing inconsistent data for ${employeeId}.`);
                            // Back-calculate the correct total credit.
                            currentCredit = currentBalance + currentWithdrawals;
                            
                            // We also update the database field immediately to fix it permanently.
                            // This is safe because we are already in a transaction.
                            transaction.update(savingsRef, { mySavingCredit: currentCredit });
                        }
                        // --- END: Data-Integrity Patch ---
                        
                        if (amount > currentBalance) {
                            throw new Error("Withdrawal amount cannot exceed the current balance.");
                        }
        
                        // MODIFIED: Implement new logic
                        const newWithdrawals = currentWithdrawals + amount;
                        
                        // --- REVERTING PREVIOUS FIX ---
                        // Now that 'currentCredit' is patched and correct, we can
                        // safely use the original "source of truth" formula.
                        const newBalance = currentCredit - newWithdrawals;
        
                        // Operation 1: Update the employee's total savings balance.
                        transaction.update(savingsRef, { 
                            currentBalance: newBalance, 
                            mySavingWithdrawalTotal: newWithdrawals, // NEW: Set the new withdrawal total
                            lastUpdated: serverTimestamp() 
                        });
        
                        // Operation 2: Create a new transaction log for this withdrawal.
                        // MODIFIED (STEP 3): Added 'staffName' and 'shop' for denormalization.
                        transaction.set(transactionRef, {
                            employeeId: employeeId,
                            staffName: employeeName, // Denormalized field
                            shop: shop, // Denormalized field
                            date: serverTimestamp(),
                            amountWithdrawn: amount,
                            type: 'withdrawal',
                            note: note || 'Manual payback'
                        });
                    });
                    console.log(`Savings withdrawal of ${amount} for ${employeeId} processed successfully.`);
                    return { success: true };
                } catch (error) {
                    console.error("Error within manageSavingsWithdrawal transaction: ", error);
                    return { success: false, error: error };
                }
            },
            
            // --- NEW: Function to REVERSE a savings withdrawal transactionally ---
            reverseSavingsWithdrawal: async (db, txToReverse) => {
                const { doc, serverTimestamp, runTransaction } = window.firebaseSDK;
                
                // Ensure we have the necessary IDs to build document references
                if (!txToReverse || !txToReverse.employeeId || !txToReverse.id) {
                    return { success: false, error: new Error("Invalid transaction data provided.") };
                }

                const savingsRef = doc(db, 'savingprogram', txToReverse.employeeId);
                const transactionRef = doc(db, 'savingprogram', txToReverse.employeeId, 'transactions', txToReverse.id);

                try {
                    await runTransaction(db, async (transaction) => {
                        const savingsDoc = await transaction.get(savingsRef);

                        if (!savingsDoc.exists()) {
                            throw new Error("Employee has no savings record. Cannot reverse.");
                        }

                        // Helper to safely parse floats
                        const parseSafeFloat = (val) => {
                            if (val === null || val === undefined) return 0;
                            const num = parseFloat(val);
                            return isNaN(num) ? 0 : num;
                        };

                        const currentBalance = parseSafeFloat(savingsDoc.data().currentBalance);
                        let currentCredit = parseSafeFloat(savingsDoc.data().mySavingCredit);
                        const currentWithdrawals = parseSafeFloat(savingsDoc.data().mySavingWithdrawalTotal);
                        const amountToReverse = parseSafeFloat(txToReverse.amountWithdrawn);

                        // --- Data-Integrity Patch (same as in other functions) ---
                        if ((currentCredit === 0 || currentCredit === null) && (currentBalance > 0 || currentWithdrawals > 0)) {
                            console.warn(`[Savings Patch: Reversal] Fixing inconsistent data for ${txToReverse.employeeId}.`);
                            currentCredit = currentBalance + currentWithdrawals;
                            // Update the main doc immediately since we're in a transaction
                            transaction.update(savingsRef, { mySavingCredit: currentCredit });
                        }
                        // --- END: Data-Integrity Patch ---
                        
                        // Calculate new totals
                        const newWithdrawalTotal = currentWithdrawals - amountToReverse;
                        
                        // Use the "source of truth" formula to recalculate the balance
                        const newBalance = currentCredit - newWithdrawalTotal;

                        // Operation 1: Update the main savings document
                        transaction.update(savingsRef, {
                            currentBalance: newBalance,
                            mySavingWithdrawalTotal: newWithdrawalTotal,
                            lastUpdated: serverTimestamp()
                        });
                        
                        // Operation 2: Delete the withdrawal transaction log
                        transaction.delete(transactionRef);
                    });
                    
                    console.log(`Savings withdrawal ${txToReverse.id} of ${amountToReverse} for ${txToReverse.employeeId} reversed successfully.`);
                    return { success: true };
                } catch (error) {
                    console.error("Error within reverseSavingsWithdrawal transaction: ", error);
                    return { success: false, error: error };
                }
            },
            
            // --- NEW: Function to log user activity ---
            logUserActivity: async (db, auth, action, targetInfo = {}) => {
                const { addDoc, collection, serverTimestamp } = window.firebaseSDK;
                const userId = auth?.currentUser?.uid;
                if (!db || !userId) {
                    console.warn("User activity logging failed: DB or User not available.");
                    return;
                }

                try {
                    await addDoc(collection(db, 'userLogs'), {
                        userId: userId,
                        action: action, // e.g., "Add Employee"
                        targetId: targetInfo.id || null, // e.g., the employee's ID
                        targetName: targetInfo.name || null, // e.g., the employee's name
                        originalData: targetInfo.originalData || null, // Data *before* the change
                        updatedData: targetInfo.updatedData || null,   // Data *after* the change
                        timestamp: serverTimestamp()
                    });
                } catch (error) {
                    console.error("Failed to write user activity log:", error);
                }
            },
        };
        // --- END UTILITY FUNCTIONS ---

        // --- START REUSABLE UI COMPONENTS ---
        const Card = memo(({ children, className = '' }) => (<div className={`bg-slate-800/50 p-4 sm:p-6 rounded-lg shadow-lg border border-slate-700 ${className}`}>{children}</div>));
        const CardTitle = memo(({ children }) => (<h2 className="text-2xl font-semibold text-slate-100 mb-4 pb-4 border-b border-slate-700">{children}</h2>));
        const UnderConstructionPage = memo(({ title }) => (<Card><div className="text-center p-4 sm:p-8"><i className="fas fa-tools text-5xl text-yellow-400 mb-6"></i><h3 className="text-2xl sm:text-3xl font-bold text-slate-100">{title}</h3><p className="text-slate-400 mt-2">This page is under construction.</p></div></Card>));
        
        // NEW: Standardized Page Header to reduce redundancy
        const PageHeader = memo(({ title, children }) => (
            <div className="flex flex-wrap gap-4 justify-between items-center mb-6">
                <h3 className="text-xl font-semibold text-slate-100">{title}</h3>
                <div className="flex flex-wrap gap-4 items-center">
                    {children}
                </div>
            </div>
        ));

        // NEW: Standardized Search Input
        const SearchInput = memo(({ value, onChange, placeholder = "Search..." }) => (
            <input 
                type="text"
                placeholder={placeholder}
                value={value}
                onChange={onChange}
                className="input w-full sm:w-auto"
            />
        ));

        // REVISED: Robust Modal Component (Fixes positioning issues)
        // FIX: Switched to ReactDOM.createPortal to escape parent transforms/animations.
        // This ensures the modal is always fixed to the viewport, not the scrolled content.
        const Modal = ({ isOpen, onClose, children, maxWidth = "max-w-4xl" }) => { 
            if (!isOpen) return null; 
            
            return ReactDOM.createPortal(
                <div className="fixed inset-0 z-[60] overflow-y-auto" aria-labelledby="modal-title" role="dialog" aria-modal="true">
                    <div className="flex min-h-screen items-center justify-center p-4 text-center sm:p-0">
                        {/* Backdrop */}
                        <div className="fixed inset-0 bg-black bg-opacity-75 transition-opacity" aria-hidden="true" onClick={onClose}></div>

                        {/* Modal Panel */}
                        {/* FIX: Changed max-h-[90vh] to max-h-[85vh] and added 'flex flex-col' to the panel itself */}
                        <div className={`relative transform rounded-lg bg-slate-800 text-left shadow-2xl transition-all sm:my-8 w-full ${maxWidth} border border-slate-600 flex flex-col max-h-[85vh] overflow-hidden`}>
                            {children}
                        </div>
                    </div>
                </div>,
                document.body // Target container
            ); 
        };

        const ModalHeader = memo(({ title, onClose }) => (<div className="p-5 border-b border-slate-700 flex justify-between items-center flex-shrink-0"><h3 className="text-xl font-semibold text-slate-100">{title}</h3><Button variant="icon-close" onClick={onClose} className="text-2xl p-1">&times;</Button></div>));
        // FIX: Ensure ModalBody can shrink and grow, enabling scroll
        const ModalBody = memo(({ children }) => (<div className="p-6 flex-1 overflow-y-auto min-h-0">{children}</div>));
        const ModalFooter = memo(({ children }) => (<div className="p-4 bg-slate-900/50 border-t border-slate-700 flex justify-end gap-4 rounded-b-lg flex-shrink-0">{children}</div>));
        
        // NEW: Reusable Button Component
        const Button = memo(({ children, onClick, variant = 'primary', icon, disabled = false, type = 'button', className = '', title = '' }) => {
            const baseClasses = 'font-medium rounded-lg shadow-sm transition-colors flex items-center justify-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-slate-800';
            
            const variantStyles = {
                primary: 'bg-blue-600 text-white hover:bg-blue-700 focus:ring-blue-500 px-4 py-2',
                secondary: 'bg-slate-600 text-slate-200 hover:bg-slate-500 focus:ring-slate-400 px-4 py-2',
                danger: 'bg-red-600 text-white hover:bg-red-700 focus:ring-red-500 px-4 py-2',
                success: 'bg-green-600 text-white hover:bg-green-700 focus:ring-green-500 px-4 py-2',
                'icon-edit': 'text-blue-400 hover:text-blue-300',
                'icon-delete': 'text-red-500 hover:text-red-400',
                'icon-approve': 'text-green-400 hover:text-green-300',
                'icon-reject': 'text-orange-400 hover:text-orange-300',
                'icon-view': 'text-blue-400 hover:text-blue-300',
                'icon-edit-alt': 'text-indigo-400 hover:text-indigo-300',
                'icon-close': 'text-slate-400 hover:text-white',
                'icon-add-time': 'text-teal-400 hover:text-teal-300', // New variant for the manual check-out icon
            };

            const finalClasses = `${baseClasses} ${variantStyles[variant] || variantStyles.primary} ${className}`;

            return (
                <button type={type} onClick={onClick} disabled={disabled} className={finalClasses} title={title}>
                    {icon && <i className={`fas ${icon}`}></i>}
                    {children}
                </button>
            );
        });

        // FIX: Also updated ConfirmationModal to use Portal
        const ConfirmationModal = ({ isOpen, onClose, onConfirm, title, message }) => { 
            if (!isOpen) return null; 
            return ReactDOM.createPortal(
                <div className="fixed inset-0 bg-black bg-opacity-70 z-[70] flex justify-center items-center p-4">
                    <div className="bg-slate-800 rounded-lg shadow-2xl w-full max-w-sm border border-slate-600">
                        <div className="p-6">
                            <h3 className="text-lg font-bold text-slate-100">{title}</h3>
                            <p className="mt-2 text-sm text-slate-400">{message}</p>
                        </div>
                        <div className="p-4 bg-slate-900/50 border-t border-slate-700 flex justify-end gap-4 rounded-b-lg">
                            <Button variant="secondary" onClick={onClose}>Cancel</Button>
                            <Button variant="danger" onClick={onConfirm}>Confirm</Button>
                        </div>
                    </div>
                </div>,
                document.body
            ); 
        };
        const TabbedPage = memo(({ tabs, activeTab, setActiveTab, children }) => {
            const renderContent = () => React.Children.toArray(children).find(child => child.props.id === activeTab) || <UnderConstructionPage title={tabs[activeTab]} />;
            return (<div><div className="mb-6 overflow-x-auto"><nav className="flex space-x-2 sm:space-x-4" aria-label="Tabs">{Object.entries(tabs).map(([key, title]) => (<a href="#" key={key} onClick={(e) => { e.preventDefault(); setActiveTab(key); }} className={`whitespace-nowrap rounded-md px-3 py-2 text-sm font-medium transition-colors ${activeTab === key ? 'bg-blue-600 text-white shadow' : 'text-slate-400 hover:bg-slate-700/50 hover:text-slate-200'}`}>{title}</a>))}</nav></div>{renderContent()}</div>);
        });
        
        // MODIFIED: Updated NotificationBell to accept and display birthdayNotifications
        const NotificationBell = ({ pendingLeaves = [], pendingOTs = [], birthdayNotifications = [], onNotificationClick }) => {
            const [isOpen, setIsOpen] = useState(false);
            const totalCount = pendingLeaves.length + pendingOTs.length + (birthdayNotifications ? birthdayNotifications.length : 0);

            const handleLeaveClick = () => {
                onNotificationClick('leaveRequest');
                setIsOpen(false);
            };

            const handleOTClick = () => {
                onNotificationClick('otRequest');
                setIsOpen(false);
            };

            return (
                <div className="relative">
                    <button onClick={() => setIsOpen(!isOpen)} className="relative text-slate-400 hover:text-white focus:outline-none">
                        <i className="fas fa-bell text-xl"></i>
                        {totalCount > 0 && (
                            <span className="absolute -top-2 -right-2 flex h-5 w-5 items-center justify-center rounded-full bg-red-500 text-xs font-bold text-white">
                                {totalCount}
                            </span>
                        )}
                    </button>
                    {isOpen && (
                        <div className="absolute right-0 mt-2 w-80 origin-top-right rounded-md bg-slate-800 shadow-lg ring-1 ring-black ring-opacity-5 focus:outline-none border border-slate-700 z-50">
                            <div className="py-1">
                                <div className="px-4 py-2 text-sm font-semibold text-slate-100 border-b border-slate-700">Notifications</div>
                                {totalCount === 0 ? (
                                    <div className="px-4 py-3 text-sm text-slate-400">No new notifications</div>
                                ) : (
                                    <>
                                        {/* NEW: Birthday Section in Notifications */}
                                        {birthdayNotifications && birthdayNotifications.length > 0 && (
                                            <div className="border-b border-slate-700 pb-1 mb-1 bg-gradient-to-r from-pink-500/10 to-purple-500/10">
                                                <p className="px-4 py-2 text-xs font-bold text-pink-400 uppercase tracking-wider flex items-center gap-2">
                                                    <i className="fas fa-birthday-cake"></i> Birthdays Today
                                                </p>
                                                {birthdayNotifications.map(emp => (
                                                    <div key={emp.id} className="px-4 py-2 text-sm text-slate-300 flex items-center justify-between">
                                                        <span><strong>{emp.name}</strong></span>
                                                        <span className="text-xs bg-pink-500 text-white px-2 py-0.5 rounded-full">Celebrate!</span>
                                                    </div>
                                                ))}
                                            </div>
                                        )}

                                        {pendingLeaves.map(req => (
                                            <a href="#" key={req.id} onClick={handleLeaveClick} className="block px-4 py-3 text-sm text-slate-300 hover:bg-slate-700">
                                                <p className="font-medium text-slate-200">New Leave Request</p>
                                                <p className="text-xs text-slate-400">{req.staffName} - {req.numberOfDays} day(s)</p>
                                            </a>
                                        ))}
                                        {pendingOTs.map(req => (
                                            <a href="#" key={req.id} onClick={handleOTClick} className="block px-4 py-3 text-sm text-slate-300 hover:bg-slate-700">
                                                <p className="font-medium text-slate-200">New OT Request</p>
                                                <p className="text-xs text-slate-400">{req.numberOfOTDays} day(s)</p>
                                            </a>
                                        ))}
                                    </>
                                )}
                            </div>
                        </div>
                    )}
                </div>
            );
        };
        // --- END REUSABLE UI COMPONENTS ---

        // --- START CUSTOM OPTIMIZATION HOOKS (NEW) ---
        
        // OPTIMIZATION 1: Centralized Shop Permission Logic
        // This replaces the repetitive "if Admin return all, if Manager return subset" logic found in 12+ files.
        const useAllowedShops = (userProfile, shops) => {
            return useMemo(() => {
                if (!userProfile || !shops) return [];
                if (userProfile.role === 'Admin' || userProfile.role === 'CEO') return shops;
                if (userProfile.role === 'Shop Manager' && Array.isArray(userProfile.shop)) {
                    return shops.filter(s => userProfile.shop.includes(s.name));
                }
                return [];
            }, [userProfile, shops]);
        };

        // OPTIMIZATION 2: Shop Dropdown for Headers
        // A reusable dropdown that only appears for Admins/Multi-shop Managers
        const ShopFilterSelect = ({ userProfile, selectedShop, onChange, shops }) => {
            const allowedShops = useAllowedShops(userProfile, shops);
            
            // Don't render if the user only has 1 shop (or none) or is basic staff
            const shouldShow = (userProfile?.role === 'Admin' || userProfile?.role === 'CEO' || (userProfile?.role === 'Shop Manager' && Array.isArray(userProfile.shop)));
            
            if (!shouldShow) return null;

            return (
                <select value={selectedShop} onChange={onChange} className="select w-full sm:w-auto">
                    <option value="">{userProfile.role === 'Admin' || userProfile.role === 'CEO' ? 'All Shops' : 'All My Shops'}</option>
                    {allowedShops.map(s => <option key={s.id} value={s.name}>{s.name}</option>)}
                </select>
            );
        };
        // --- END CUSTOM OPTIMIZATION HOOKS ---

        // --- START AUTHENTICATION PAGE ---
        const LoginPage = () => {
            const { auth, db } = useFirebase();
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [error, setError] = useState('');
            const [loading, setLoading] = useState(false);
            const [showPassword, setShowPassword] = useState(false);

            // --- NEW: State for System Initialization ---
            const [showInitUI, setShowInitUI] = useState(false);
            const [initCode, setInitCode] = useState('');
            const [pendingUser, setPendingUser] = useState(null); // Stores the authenticated user while waiting for the code

            // *** SECURITY CONFIGURATION ***
            // Change this code to something secret before deploying!
            const SYSTEM_INIT_CODE = "HR2025"; 

            const handleLogin = useCallback(async (e) => {
                e.preventDefault();
                if (!auth || !db) { setError("System not ready. Please try again."); return; }
                setLoading(true);
                setError('');
                try {
                    const { signInWithEmailAndPassword, signOut, collection, query, where, getDocs, doc, updateDoc, addDoc, limit } = window.firebaseSDK;
                    
                    // 1. Authenticate with Firebase Auth
                    const userCredential = await signInWithEmailAndPassword(auth, email, password);
                    const user = userCredential.user;
                    
                    // 2. Check if this user has an employee profile
                    const q = query(collection(db, "employees"), where("email", "==", user.email));
                    const querySnapshot = await getDocs(q);

                    if (querySnapshot.empty) {
                        // --- NEW: SYSTEM BOOTSTRAP LOGIC WITH SECURITY CHECK ---
                        // If no profile found, check if the ENTIRE system is empty (fresh install)
                        const allEmployeesQuery = query(collection(db, "employees"), limit(1));
                        const allEmployeesSnap = await getDocs(allEmployeesQuery);

                        if (allEmployeesSnap.empty) {
                            // SYSTEM IS EMPTY: Do NOT create admin yet.
                            // Instead, store the user and show the Initialization Code UI.
                            console.log("Fresh system detected. Requesting Initialization Code...");
                            setPendingUser(user);
                            setShowInitUI(true);
                            setLoading(false); 
                            return; // Stop here and wait for the code
                        } else {
                            // System has users, but THIS user is not one of them.
                            await signOut(auth);
                            setError("No employee record found for this user.");
                        }
                    } else {
                        const employeeDoc = querySnapshot.docs[0];
                        const employeeData = employeeDoc.data();

                        if (employeeData.status !== 'Active') {
                            await signOut(auth);
                            setError("Your account is inactive. Please contact HR.");
                        } else {
                            // Automatically link UID if it's missing or incorrect.
                            if (!employeeData.uid || employeeData.uid !== user.uid) {
                                const employeeDocRef = doc(db, 'employees', employeeDoc.id);
                                await updateDoc(employeeDocRef, { uid: user.uid });
                            }
                            // Login is successful; onAuthStateChanged will handle profile loading.
                        }
                    }
                } catch (err) {
                    if (err.code === 'auth/invalid-credential' || err.code === 'auth/user-not-found' || err.code === 'auth/wrong-password') {
                        setError('Invalid email or password.');
                    } else {
                        setError('Failed to login. Please check connection.');
                        console.error(err);
                    }
                } finally {
                    // Only stop loading if we didn't trigger the Init UI
                    if (!showInitUI) setLoading(false);
                }
            }, [auth, db, email, password, showInitUI]); // Added showInitUI dependency

            // --- NEW: Handler for the Initialization Code Submit ---
            const handleInitSubmit = async (e) => {
                e.preventDefault();
                setError('');
                setLoading(true);

                if (initCode !== SYSTEM_INIT_CODE) {
                    setError("Incorrect Initialization Code.");
                    setLoading(false);
                    return;
                }

                try {
                    const { addDoc, collection } = window.firebaseSDK;
                    
                    // Code is correct! Create the Super Admin profile.
                    console.log("Code verified. Creating Super Admin profile...");
                    
                    await addDoc(collection(db, "employees"), {
                        uid: pendingUser.uid,
                        email: pendingUser.email,
                        name: "System Admin", 
                        role: "Admin",        
                        status: "Active",
                        joinedDate: new Date().toISOString().slice(0, 10),
                        position: "Administrator",
                        shop: "Head Office",
                        salary: 0,
                        permissions: ['policy', 'employees', 'checkinme', 'attendanceReport', 'payroll', 'hrBanking', 'salaryReport', 'expenseReport', 'userActivity', 'settings']
                    });

                    alert("System Initialized Successfully! You are now the Super Admin.");
                    // No need to reload; the onAuthStateChanged listener in AppContent will detect the new profile.
                    // Just reset the UI state to let the Dashboard render.
                    setShowInitUI(false); 
                    
                } catch (err) {
                    console.error("Error creating admin:", err);
                    setError("Failed to create admin profile. Check console.");
                } finally {
                    setLoading(false);
                }
            };

            // --- NEW: Render the Initialization Code Form if triggered ---
            if (showInitUI) {
                return (
                    <div className="flex items-center justify-center min-h-screen bg-slate-900">
                        <div className="w-full max-w-md p-8 space-y-8 bg-slate-800 rounded-2xl shadow-lg border border-yellow-600">
                            <div className="text-center">
                                <i className="fas fa-shield-halved text-5xl text-yellow-500"></i>
                                <h2 className="mt-6 text-3xl font-bold text-white">System Initialization</h2>
                                <p className="mt-2 text-sm text-slate-400">
                                    This database is empty. To claim the <strong>Admin</strong> role, please enter the system initialization code.
                                </p>
                            </div>
                            <form className="mt-8 space-y-6" onSubmit={handleInitSubmit}>
                                <div>
                                    <label htmlFor="init-code" className="sr-only">Initialization Code</label>
                                    <input 
                                        id="init-code" 
                                        name="code" 
                                        type="password" 
                                        required 
                                        className="appearance-none rounded relative block w-full px-3 py-3 border border-slate-600 bg-slate-700 text-white placeholder-slate-400 focus:outline-none focus:ring-yellow-500 focus:border-yellow-500 sm:text-sm text-center tracking-widest" 
                                        placeholder="ENTER CODE" 
                                        value={initCode} 
                                        onChange={(e) => setInitCode(e.target.value)} 
                                    />
                                </div>
                                {error && <p className="text-red-500 text-sm text-center font-bold animate-pulse">{error}</p>}
                                <div>
                                    <Button type="submit" variant="primary" disabled={loading} className="w-full py-3 bg-yellow-600 hover:bg-yellow-700 focus:ring-yellow-500">
                                        {loading ? <i className="fas fa-spinner fa-spin"></i> : 'Verify & Initialize'}
                                    </Button>
                                </div>
                                <div className="text-center">
                                    <button 
                                        type="button" 
                                        onClick={() => { setShowInitUI(false); setPendingUser(null); window.firebaseSDK.signOut(auth); }}
                                        className="text-sm text-slate-500 hover:text-slate-300 underline"
                                    >
                                        Cancel
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                );
            }

            return (
                <div className="flex items-center justify-center min-h-screen bg-slate-900">
                    <div className="w-full max-w-md p-8 space-y-8 bg-slate-800 rounded-2xl shadow-lg border border-slate-700">
                        <div className="text-center"><i className="fas fa-building-user text-5xl text-blue-500"></i><h2 className="mt-6 text-3xl font-bold text-white">HR Management System</h2><p className="mt-2 text-sm text-slate-400">Sign in to your account</p></div>
                        <form className="mt-8 space-y-6" onSubmit={handleLogin}>
                            <div className="rounded-md shadow-sm -space-y-px">
                                <div><input id="email-address" name="email" type="email" autoComplete="email" required className="appearance-none rounded-none relative block w-full px-3 py-3 border border-slate-600 bg-slate-700 text-white placeholder-slate-400 rounded-t-md focus:outline-none focus:ring-blue-500 focus:border-blue-500 focus:z-10 sm:text-sm" placeholder="Email address" value={email} onChange={(e) => setEmail(e.target.value)} /></div>
                                <div className="relative"><input id="password" name="password" type={showPassword ? "text" : "password"} autoComplete="current-password" required className="appearance-none rounded-none relative block w-full px-3 py-3 border border-slate-600 bg-slate-700 text-white placeholder-slate-400 rounded-b-md focus:outline-none focus:ring-blue-500 focus:border-blue-500 focus:z-10 sm:text-sm" placeholder="Password" value={password} onChange={(e) => setPassword(e.target.value)} /><button type="button" onClick={() => setShowPassword(!showPassword)} className="absolute inset-y-0 right-0 pr-3 flex items-center text-sm leading-5"><i className={`fas ${showPassword ? 'fa-eye-slash' : 'fa-eye'} text-slate-400 hover:text-slate-200`}></i></button></div>
                            </div>
                            {error && <p className="text-red-500 text-sm text-center">{error}</p>}
                            <div>
                                <Button type="submit" variant="primary" disabled={loading} className="w-full py-3">
                                    {loading ? <i className="fas fa-spinner fa-spin"></i> : 'Sign in'}
                                </Button>
                            </div>
                        </form>
                    </div>
                </div>
            );
        };
        // --- END AUTHENTICATION PAGE ---

        // --- START EMPLOYEES PAGE COMPONENTS ---

        // NEW: Phase 2 Refactoring - Custom Hook for Employee Fetching Logic
        const useFilteredEmployees = (userProfile, selectedShop) => {
            const { db, auth } = useFirebase();
            const [employees, setEmployees] = useState([]);
            const [loading, setLoading] = useState(true);

            useEffect(() => {
                if (!db || !userProfile || !auth?.currentUser) return () => {};
                
                const { collection, query, where, onSnapshot } = window.firebaseSDK;
                setLoading(true);
                let unsub1 = () => {};
                let unsub2 = () => {};

                const mergeResults = (res1, res2) => {
                    const combined = new Map();
                    res1.forEach(item => combined.set(item.id, item));
                    res2.forEach(item => combined.set(item.id, item));
                    setEmployees(Array.from(combined.values()));
                    setLoading(false);
                };

                const role = userProfile.role;
                
                if (role === 'Admin' || role === 'CEO') {
                    let results1 = [], results2 = [];
                    if (selectedShop) {
                        const q1 = query(collection(db, "employees"), where("shop", "==", selectedShop), where("status", "==", "Active"));
                        unsub1 = onSnapshot(q1, snap => { results1 = snap.docs.map(doc => ({ id: doc.id, ...doc.data() })); mergeResults(results1, results2); }, err => console.error("Admin query 1 failed:", err));
                        const q2 = query(collection(db, "employees"), where("shop", "array-contains", selectedShop), where("status", "==", "Active"));
                        unsub2 = onSnapshot(q2, snap => { results2 = snap.docs.map(doc => ({ id: doc.id, ...doc.data() })); mergeResults(results1, results2); }, err => console.error("Admin query 2 failed:", err));
                    } else {
                        const q1 = query(collection(db, "employees"), where("status", "==", "Active"));
                        unsub1 = onSnapshot(q1, snap => { setEmployees(snap.docs.map(doc => ({ id: doc.id, ...doc.data() }))); setLoading(false); }, err => console.error("Admin all employees query failed:", err));
                    }
                } else if (role === 'Shop Manager') {
                    const managedShops = Array.isArray(userProfile.shop) ? userProfile.shop : (userProfile.shop ? [userProfile.shop] : []);
                    
                    // --- FIX: Filter based on selectedShop if present ---
                    let shopsToQuery = managedShops;
                    if (selectedShop) {
                         // Only allow filtering by shops the manager actually owns
                         if (managedShops.includes(selectedShop)) {
                             shopsToQuery = [selectedShop];
                         }
                    }

                    if (shopsToQuery.length > 0) {
                        let results1 = [], results2 = [];
                        // Query 1: Single shop string matches
                        const q1 = query(collection(db, "employees"), where("shop", "in", shopsToQuery), where("status", "==", "Active"));
                        unsub1 = onSnapshot(q1, snap => { 
                            results1 = snap.docs.map(doc => ({ id: doc.id, ...doc.data() })); 
                            mergeResults(results1, results2); 
                        }, err => console.error("Manager query 1 failed:", err));
                        
                        // Query 2: Array contains...
                        let q2;
                        if (shopsToQuery.length === 1) {
                            // If specific shop selected (or manager only has 1 shop), use array-contains
                            q2 = query(collection(db, "employees"), where("shop", "array-contains", shopsToQuery[0]), where("status", "==", "Active"));
                        } else {
                            // If viewing "All My Shops", use array-contains-any
                            q2 = query(collection(db, "employees"), where("shop", "array-contains-any", shopsToQuery), where("status", "==", "Active"));
                        }

                        unsub2 = onSnapshot(q2, snap => { 
                            results2 = snap.docs.map(doc => ({ id: doc.id, ...doc.data() })); 
                            mergeResults(results1, results2); 
                        }, err => console.error("Manager query 2 failed:", err));
                    } else {
                        setEmployees([]); 
                        setLoading(false); 
                    }
                    // --- END FIX ---

                } else { // Staff role
                    const q1 = query(collection(db, "employees"), where("uid", "==", auth.currentUser.uid), where("status", "==", "Active"));
                    unsub1 = onSnapshot(q1, snap => { setEmployees(snap.docs.map(doc => ({ id: doc.id, ...doc.data() }))); setLoading(false); }, err => console.error("Staff query failed:", err));
                }

                return () => { unsub1(); unsub2(); };
            }, [db, userProfile, auth?.currentUser, selectedShop]);

            return { employees, loading };
        };

        // NEW: Phase 1 Refactoring - Employee Table Component
        // This component is now solely responsible for rendering the list of employees.
        // It receives the filtered list and action handlers as props.
        const EmployeeTable = memo(({ employees, userProfile, onView, onDelete }) => {
            return (
                <div className="overflow-x-auto">
                    <table className="min-w-full divide-y divide-slate-700">
                        <thead className="bg-slate-900/50">
                            <tr>
                                {/* NEW: Added Photo Column */}
                                <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Photo</th>
                                <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Name</th>
                                <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Position</th>
                                <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Shop</th>
                                <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Join Date</th>
                                <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Worked Dur.</th>
                                <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Shift</th>
                                <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Tel</th>
                                <th className="px-4 py-3 text-right text-xs font-semibold text-slate-400 uppercase">Salary</th>
                                <th className="px-4 py-3 text-center text-xs font-semibold text-slate-400 uppercase">Actions</th>
                            </tr>
                        </thead>
                        <tbody className="divide-y divide-slate-700">
                            {employees.map(emp => (
                                <tr key={emp.id} className="hover:bg-slate-700/50">
                                    {/* NEW: Render Photo or Initials */}
                                    <td className="px-4 py-4 whitespace-nowrap">
                                        <div className="flex-shrink-0 h-10 w-10">
                                            {emp.photo ? (
                                                <img className="h-10 w-10 rounded-full object-cover border border-slate-600" src={emp.photo} alt={emp.name} />
                                            ) : (
                                                <div className="h-10 w-10 rounded-full bg-slate-700 flex items-center justify-center text-slate-400 font-bold border border-slate-600">
                                                    {emp.name.charAt(0)}
                                                </div>
                                            )}
                                        </div>
                                    </td>
                                    <td className="px-4 py-4 text-sm text-slate-200 whitespace-nowrap">{emp.name}</td>
                                    <td className="px-4 py-4 text-sm text-slate-300 whitespace-nowrap">{emp.position}</td>
                                    <td className="px-4 py-4 text-sm text-slate-300 whitespace-nowrap">{Array.isArray(emp.shop) ? emp.shop.join(', ') : emp.shop}</td>
                                    <td className="px-4 py-4 text-sm text-slate-300 whitespace-nowrap">{emp.joinedDate}</td>
                                    <td className="px-4 py-4 text-sm text-slate-300 whitespace-nowrap">{Utils.calculateWorkedDuration(emp.joinedDate)}</td>
                                    <td className="px-4 py-4 text-sm text-slate-300 whitespace-nowrap">{emp.shift}</td>
                                    <td className="px-4 py-4 text-sm text-slate-300 whitespace-nowrap">{emp.tel}</td>
                                    <td className="px-4 py-4 text-sm text-slate-300 text-right whitespace-nowrap">{Utils.formatCurrency(emp.salary)}</td>
                                    <td className="px-4 py-4 text-center whitespace-nowrap">
                                        <div className="flex items-center justify-center gap-4">
                                            <Button variant="icon-view" icon="fa-eye" onClick={() => onView(emp)} />
                                            {(userProfile?.role === 'Admin' || userProfile?.role === 'CEO' || userProfile?.role === 'Shop Manager') && (
                                                <Button variant="icon-delete" icon="fa-trash" onClick={() => onDelete(emp)} />
                                            )}
                                        </div>
                                    </td>
                                </tr>
                            ))}
                        </tbody>
                    </table>
                </div>
            );
        });

        // Component: Employee Modal (Add/Edit Form)
        // MODIFIED: Added 'allEmployees' to props destructuring
        const EmployeeModal = ({ isOpen, onClose, onSave, employee, userProfile, isViewOnly = false, onSwitchToEdit, allEmployees }) => {
            const [formData, setFormData] = useState({});
            const [password, setPassword] = useState(''); // NEW: State for new user password
            const [showPassword, setShowPassword] = useState(false); // NEW: State for password visibility
            const [authError, setAuthError] = useState(''); // NEW: State for auth errors

            const { positions, shifts, shops } = useAppData(); // Use global data context

            // Determine available shops for the modal dropdown based on user role
            const availableShopsForModal = useAllowedShops(userProfile, shops);

            // Filter supervisors to only show Shop Managers assigned to the selected shop(s)
            const supervisors = useMemo(() => {
                // Ensure we always work with an array of selected shops
                const selectedShops = Array.isArray(formData.shop) ? formData.shop : (formData.shop ? [formData.shop] : []);

                // If no shop is selected, return empty list
                if (selectedShops.length === 0) return [];

                return (allEmployees || []).filter(e => {
                    if (e.role !== 'Shop Manager' || e.status !== 'Active') return false;
                    
                    // Get the manager's assigned shops
                    const managerShops = Array.isArray(e.shop) ? e.shop : (e.shop ? [e.shop] : []);
                    
                    // Check if the manager covers ANY of the selected shops
                    return managerShops.some(s => selectedShops.includes(s));
                });
            }, [allEmployees, formData.shop]);

            const availablePages = useMemo(() => [
                { key: 'employees', label: 'Employees' },
                { key: 'checkinme', label: 'CheckInMe' },
                // REMOVED: Saving Program permission
                { key: 'attendanceReport', label: 'Attendance Report' },
                { key: 'payroll', label: 'Payroll' },
                { key: 'hrBanking', label: 'HR Banking' },
                { key: 'salaryReport', label: 'Salary Revise Report' },
                { key: 'expenseReport', label: 'Expense Report' },
                { key: 'assets', label: 'Asset Manager' }, // ADDED: Asset Manager Permission
                // MODIFIED: 'tasks' removed from permission list as it is now globally accessible
                // { key: 'tasks', label: 'Task Manager' }, 
                { key: 'userActivity', label: 'User Activity' },
                { key: 'policy', label: 'Policy Board' },
                { key: 'settings', label: 'Settings' },
            ], []);

            // Filter shifts based on the employee's assigned shop(s)
            // MODIFIED: Deduplicate shift names to prevent "locked" select behavior
            const availableShifts = useMemo(() => {
                const employeeShops = Array.isArray(formData.shop) ? formData.shop : (formData.shop ? [formData.shop] : []);
                if (employeeShops.length === 0) return [];
                
                // Get all shifts available in the selected shops
                const relevantShifts = (shifts || []).filter(s => s.shopName && employeeShops.includes(s.shopName));
                
                // Extract unique names only. 
                // e.g. ["AM", "AM", "PM"] -> ["AM", "PM"]
                const uniqueNames = [...new Set(relevantShifts.map(s => s.name))].sort();
                
                return uniqueNames;
            }, [shifts, formData.shop]);

            // Initialize form data when modal opens or employee data changes
            useEffect(() => {
                const initialData = employee 
                    ? { ...employee, permissions: employee.permissions || [] } 
                    : { 
                        name: '', sex: 'M', dob: '', nationId: '', tel: '', shop: '', 
                        joinedDate: '', salary: '', position: '', shift: 'AM', supervisor: '', 
                        status: 'Active', email: '', uid: '', role: 'Staff', address: '', 
                        permissions: [], statusChangeDate: '', reasonForLeaving: '', 
                        savingsProgramStatus: 'Inactive', savingsPercentage: 0, primaryShop: '',
                        enrollInSavings: true, // NEW: Default to true for new employees
                        photo: '' // NEW: Photo field
                    };

                // When editing, ensure shop is in the right format based on role
                if (employee) {
                    if (employee.role === 'Shop Manager' || employee.role === 'Admin') {
                        initialData.shop = Array.isArray(employee.shop) ? employee.shop : (employee.shop ? [employee.shop] : []);
                    } else {
                        initialData.shop = Array.isArray(employee.shop) ? employee.shop[0] || '' : employee.shop || '';
                    }

                    // NEW: Set initial primaryShop
                    let defaultPrimary = '';
                    if (employee.primaryShop) {
                        defaultPrimary = employee.primaryShop;
                    } else if (Array.isArray(initialData.shop)) {
                        defaultPrimary = initialData.shop[0] || ''; // Default to first shop in array
                    } else {
                        defaultPrimary = initialData.shop; // Default to the single shop string
                    }
                    initialData.primaryShop = defaultPrimary;

                } else {
                    // For new employee, default based on Staff role
                    initialData.shop = '';
                    initialData.primaryShop = ''; // NEW
                }

                setFormData(initialData);
                setPassword(''); // NEW: Reset password on open
                setAuthError(''); // NEW: Reset error on open
            }, [employee, isOpen]);
            
            // Automatically grant 'checkinme' permission to Staff and Shop Manager roles
            useEffect(() => {
                if ((formData.role === 'Staff' || formData.role === 'Shop Manager') && !formData.permissions?.includes('checkinme')) {
                    setFormData(prev => ({ ...prev, permissions: [...new Set([...(prev.permissions || []), 'checkinme'])] }));
                }
            }, [formData.role]);

            const handleChange = useCallback((e) => {
                const { name, value, type, checked } = e.target;
                
                if (name === 'role') {
                    // When role changes, convert shop data structure accordingly
                    setFormData(prev => {
                        const newRole = value;
                        let newShopValue = prev.shop;
                        let newPermissions = prev.permissions || []; // Get current permissions
                        let newPrimaryShop = prev.primaryShop; // NEW
                        
                        if (newRole === 'Shop Manager' || newRole === 'Admin' || newRole === 'CEO') {
                            // convert to array if it's a string
                            newShopValue = Array.isArray(prev.shop) ? prev.shop : (prev.shop ? [prev.shop] : []);
                        } else {
                            // convert to string (first element) if it's an array
                            newShopValue = Array.isArray(prev.shop) ? prev.shop[0] || '' : prev.shop;
                            // NEW: If changing to single-shop, primaryShop MUST be that shop
                            newPrimaryShop = newShopValue;
                        }

                        // If role is changed to something other than Admin, remove the sysConfig permission.
                        
                        return { ...prev, role: newRole, shop: newShopValue, permissions: newPermissions, primaryShop: newPrimaryShop }; // NEW: return with newPrimaryShop
                    });
                } else if (type === 'checkbox') {
                    if (name === 'shop') { // Handling shop multi-select
                        setFormData(prev => {
                            const shopArray = Array.isArray(prev.shop) ? prev.shop : [];
                            const newShops = checked ? [...shopArray, value] : shopArray.filter(s => s !== value);
                            
                            // NEW: Check if primaryShop is still valid
                            let newPrimaryShop = prev.primaryShop;
                            if (!newShops.includes(newPrimaryShop)) {
                                newPrimaryShop = newShops[0] || ''; // Reset to first available, or empty
                            }
                            
                            // MODIFIED: Reset supervisor if shop selection changes
                            return { ...prev, shop: newShops, primaryShop: newPrimaryShop, supervisor: '' }; 
                        });
                    } else if (name === 'enrollInSavings') { // NEW: Handle Savings Checkbox
                        setFormData(prev => ({ ...prev, enrollInSavings: checked }));
                    } else { // Handling permissions
                        setFormData(prev => ({ ...prev, permissions: checked ? [...(prev.permissions || []), value] : (prev.permissions || []).filter(p => p !== value) }));
                    }
                } else {
                    // NEW: Handle single-shop change
                    if (name === 'shop') { 
                        // This is for single-shop roles
                        // MODIFIED: Reset supervisor if shop selection changes
                        setFormData(prev => ({ ...prev, [name]: value, primaryShop: value, supervisor: '' })); 
                    } else {
                        // This handles 'primaryShop' dropdown change and all others
                        setFormData(prev => ({ ...prev, [name]: value }));
                    }
                }
            }, []);

            // --- NEW: Image Upload Handler with Resize Logic ---
            const handleImageUpload = (e) => {
                const file = e.target.files[0];
                if (!file) return;

                if (file.size > 2 * 1024 * 1024) { // 2MB Limit
                    alert("File size is too large. Please select an image under 2MB.");
                    return;
                }

                const reader = new FileReader();
                reader.onload = (event) => {
                    const img = new Image();
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const MAX_WIDTH = 300;
                        const MAX_HEIGHT = 300;
                        let width = img.width;
                        let height = img.height;

                        // Calculate new dimensions
                        if (width > height) {
                            if (width > MAX_WIDTH) {
                                height *= MAX_WIDTH / width;
                                width = MAX_WIDTH;
                            }
                        } else {
                            if (height > MAX_HEIGHT) {
                                width *= MAX_HEIGHT / height;
                                height = MAX_HEIGHT;
                            }
                        }
                        canvas.width = width;
                        canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        
                        // Convert to Base64 (JPEG, 80% quality)
                        const dataUrl = canvas.toDataURL('image/jpeg', 0.8);
                        setFormData(prev => ({ ...prev, photo: dataUrl }));
                    };
                    img.src = event.target.result;
                };
                reader.readAsDataURL(file);
            };

            // Handlers for salary input to allow typing numbers and format on blur
            const handleSalaryChange = useCallback((e) => { setFormData(prev => ({ ...prev, salary: e.target.value.replace(/[^0-9.]/g, '') })); }, []);
            const handleSalaryBlur = useCallback((e) => { setFormData(prev => ({ ...prev, salary: Utils.formatCurrency(e.target.value) })); }, []);
            const handleSubmit = useCallback(async (e) => { 
                e.preventDefault(); 
                setAuthError(''); // Reset error on each submission attempt
                const dataToSave = { ...formData };
                // Final check to ensure staff have a string for shop, not array
                if (dataToSave.role !== 'Shop Manager' && dataToSave.role !== 'Admin' && dataToSave.role !== 'CEO') {
                    dataToSave.shop = Array.isArray(dataToSave.shop) ? dataToSave.shop[0] || '' : dataToSave.shop;
                }

                // --- MODIFIED: Handle user credential creation without changing global auth state ---
                if (!dataToSave.id && dataToSave.email && password) { // This is a new employee with login details
                    if (password.length < 6) {
                        setAuthError('Password must be at least 6 characters long.');
                        return; // Stop the save process
                    }
                    let tempApp = null;
                    try {
                        const { initializeApp, getAuth, createUserWithEmailAndPassword, deleteApp } = window.firebaseSDK;
                        // Initialize a temporary, secondary Firebase app to create the user.
                        // This prevents the main app's auth state from changing.
                        const tempAppName = `temp-user-creation-${Date.now()}`;
                        tempApp = initializeApp(activeFirebaseConfig, tempAppName);
                        const tempAuth = getAuth(tempApp);

                        // Create the user on the temporary instance.
                        const userCredential = await createUserWithEmailAndPassword(tempAuth, dataToSave.email, password);
                        // Add the new UID to the employee data object that will be saved to Firestore
                        dataToSave.uid = userCredential.user.uid;
                        
                    } catch (error) {
                        console.error("Error creating auth user:", error);
                        if (error.code === 'auth/email-already-in-use') {
                            setAuthError('This email is already in use by another login.');
                        } else {
                            setAuthError('Failed to create user login. Please check the email format.');
                        }
                        return; // Stop the save process if auth creation fails
                    } finally {
                        // Clean up the temporary app instance.
                        if (tempApp) {
                            await window.firebaseSDK.deleteApp(tempApp);
                        }
                    }
                } else if (!dataToSave.id && dataToSave.email && !password) {
                    setAuthError('Password is required when creating a new user with an email address.');
                    return; // Stop the save process
                }
                // --- End modified logic ---

                onSave(dataToSave); 
            }, [onSave, formData, password]);
            const isFormerEmployee = formData.status === 'Terminated' || formData.status === 'Resigned';

            return (
                <Modal isOpen={isOpen} onClose={onClose}>
                    {/* FIX: Added 'overflow-hidden' to the form to ensure internal scrolling works correctly within the flex container */}
                    <form onSubmit={handleSubmit} className="flex flex-col h-full overflow-hidden">
                        <ModalHeader title={isViewOnly ? 'View Employee Details' : (employee ? 'Edit Employee' : 'Add New Employee')} onClose={onClose} />
                        <ModalBody>
                            {/* --- NEW: Photo Uploader Section --- */}
                            <div className="flex flex-col items-center justify-center mb-6">
                                <div 
                                    className={`relative w-28 h-28 rounded-full overflow-hidden border-4 border-slate-600 bg-slate-700 flex items-center justify-center shadow-lg group ${!isViewOnly ? 'cursor-pointer hover:border-blue-500' : ''}`}
                                    onClick={() => !isViewOnly && document.getElementById('photo-upload').click()}
                                >
                                    {formData.photo ? (
                                        <img src={formData.photo} alt="Profile" className="w-full h-full object-cover" />
                                    ) : (
                                        <i className="fas fa-user text-5xl text-slate-500"></i>
                                    )}
                                    
                                    {!isViewOnly && (
                                        <div className="absolute inset-0 bg-black/50 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity">
                                            <i className="fas fa-camera text-white text-2xl"></i>
                                        </div>
                                    )}
                                </div>
                                {!isViewOnly && <p className="text-xs text-slate-400 mt-2">Tap to change photo</p>}
                                <input 
                                    type="file" 
                                    id="photo-upload" 
                                    accept="image/*" 
                                    className="hidden" 
                                    onChange={handleImageUpload}
                                    disabled={isViewOnly}
                                />
                            </div>
                            {/* --- End Photo Uploader --- */}

                            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                {/* Employee Personal & Job Details */}
                                <div><label className="text-sm font-medium text-slate-400"><i className="fas fa-user mr-2 text-blue-400"></i>Name</label><input name="name" value={formData.name || ''} onChange={handleChange} className="input" required disabled={isViewOnly} /></div>
                                <div><label className="text-sm font-medium text-slate-400"><i className="fas fa-venus-mars mr-2 text-pink-400"></i>Sex</label><select name="sex" value={formData.sex || 'M'} onChange={handleChange} className="select" disabled={isViewOnly}><option value="M">Male</option><option value="F">Female</option></select></div>
                                <div><label className="text-sm font-medium text-slate-400"><i className="fas fa-birthday-cake mr-2 text-yellow-400"></i>Date of Birth</label><input type="date" name="dob" value={formData.dob || ''} onChange={handleChange} className="input" disabled={isViewOnly} /></div>
                                <div><label className="text-sm font-medium text-slate-400"><i className="fas fa-id-card mr-2 text-green-400"></i>Nation ID</label><input name="nationId" value={formData.nationId || ''} onChange={handleChange} className="input" disabled={isViewOnly} /></div>
                                <div><label className="text-sm font-medium text-slate-400"><i className="fas fa-phone mr-2 text-indigo-400"></i>Tel No</label><input name="tel" value={formData.tel || ''} onChange={handleChange} className="input" disabled={isViewOnly} /></div>
                                
                                {(formData.role === 'Shop Manager' || formData.role === 'Admin' || formData.role === 'CEO') ? (
                                    <div className="md:col-span-full">
                                        <label className="text-sm font-medium text-slate-400"><i className="fas fa-store mr-2 text-cyan-400"></i>Shops</label>
                                        <div className="mt-2 grid grid-cols-2 sm:grid-cols-3 gap-4 p-4 border border-slate-600 rounded-lg bg-slate-700/50">
                                            {(availableShopsForModal || []).map(shop => (
                                                <div key={shop.id} className="flex items-center">
                                                    <input id={`shop-${shop.id}`} name="shop" type="checkbox" value={shop.name} checked={(Array.isArray(formData.shop) ? formData.shop : []).includes(shop.name)} onChange={handleChange} className="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500 bg-slate-600" disabled={isViewOnly} />
                                                    <label htmlFor={`shop-${shop.id}`} className="ml-3 text-sm text-slate-300">{shop.name}</label>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                ) : (
                                    <div>
                                        <label className="text-sm font-medium text-slate-400"><i className="fas fa-store mr-2 text-cyan-400"></i>Shop</label>
                                        <select name="shop" value={formData.shop || ''} onChange={handleChange} className="select" disabled={isViewOnly}>
                                            <option value="">Select Shop</option>
                                            {(availableShopsForModal || []).map(s => <option key={s.id} value={s.name}>{s.name}</option>)}
                                        </select>
                                    </div>
                                )}

                                {/* --- NEW: Primary Shop Dropdown --- */}
                                <div>
                                    <label className="text-sm font-medium text-slate-400"><i className="fas fa-map-pin mr-2 text-red-400"></i>Primary Shop</label>
                                    <select 
                                        name="primaryShop" 
                                        value={formData.primaryShop || ''} 
                                        onChange={handleChange} 
                                        className="select"
                                        // Disable if not a multi-shop role OR if no shops are assigned
                                        disabled={isViewOnly || !(formData.role === 'Shop Manager' || formData.role === 'Admin' || formData.role === 'CEO') || !formData.shop || formData.shop.length === 0}
                                    >
                                        <option value="">Select Primary Shop</option>
                                        {/* Populate options based on whether shop is an array (multi-shop) 
                                          or a string (single-shop, in which case it will be disabled anyway
                                          but this makes it robust).
                                        */}
                                        {Array.isArray(formData.shop) ? (
                                            formData.shop.map(shopName => (
                                                <option key={shopName} value={shopName}>{shopName}</option>
                                            ))
                                        ) : (
                                            formData.shop && <option value={formData.shop}>{formData.shop}</option>
                                        )}
                                    </select>
                                </div>
                                {/* --- END: Primary Shop Dropdown --- */}

                                <div><label className="text-sm font-medium text-slate-400"><i className="fas fa-calendar-check mr-2 text-teal-400"></i>Joined Date</label><input type="date" name="joinedDate" value={formData.joinedDate || ''} onChange={handleChange} className="input" disabled={isViewOnly} /></div>
                                <div><label className="text-sm font-medium text-slate-400"><i className="fas fa-money-bill-wave mr-2 text-green-500"></i>Salary</label><input name="salary" value={formData.salary || ''} onChange={handleSalaryChange} onBlur={handleSalaryBlur} className="input" disabled={isViewOnly || (userProfile?.role === 'Shop Manager' && employee)} /></div>
                                <div><label className="text-sm font-medium text-slate-400"><i className="fas fa-briefcase mr-2 text-orange-400"></i>Position</label><select name="position" value={formData.position || ''} onChange={handleChange} className="select" disabled={isViewOnly}><option value="">Select Position</option>{(positions || []).map(p => <option key={p.id} value={p.position}>{p.position}</option>)}</select></div>
                                <div>
                                    <label className="text-sm font-medium text-slate-400"><i className="fas fa-clock mr-2 text-purple-400"></i>Shift</label>
                                    <select name="shift" value={formData.shift || ''} onChange={handleChange} className="select" disabled={isViewOnly}>
                                        <option value="">Select Shift</option>
                                        {/* MODIFIED: Map over unique strings instead of objects */}
                                        {availableShifts.map(shiftName => (
                                            <option key={shiftName} value={shiftName}>{shiftName}</option>
                                        ))}
                                    </select>
                                </div>
                                <div><label className="text-sm font-medium text-slate-400"><i className="fas fa-user-tie mr-2 text-blue-300"></i>Supervisor</label><select name="supervisor" value={formData.supervisor || ''} onChange={handleChange} className="select" disabled={isViewOnly}><option value="">Select Supervisor</option>{supervisors.map(e => <option key={e.id} value={e.name}>{e.name}</option>)}</select></div>
                                <div><label className="text-sm font-medium text-slate-400"><i className="fas fa-info-circle mr-2 text-gray-400"></i>Staff Status</label><select name="status" value={formData.status || 'Active'} onChange={handleChange} className="select" disabled={isViewOnly}><option>Active</option><option>Terminated</option><option>Resigned</option></select></div>
                                {isFormerEmployee && (
                                    <>
                                        <div><label className="text-sm font-medium text-slate-400"><i className="fas fa-calendar-day mr-2 text-red-300"></i>Status Change Date</label><input type="date" name="statusChangeDate" value={formData.statusChangeDate || ''} onChange={handleChange} className="input" disabled={isViewOnly} /></div>
                                        <div className="md:col-span-2"><label className="text-sm font-medium text-slate-400"><i className="fas fa-comment-dots mr-2 text-yellow-300"></i>Reason for Leaving</label><textarea name="reasonForLeaving" value={formData.reasonForLeaving || ''} onChange={handleChange} className="input" rows="2" disabled={isViewOnly}></textarea></div>
                                    </>
                                )}
                                
                                {/* --- NEW: Savings Program Checkbox (Only for New Employees) --- */}
                                {!employee && !isViewOnly && (
                                    <div className="md:col-span-full">
                                        <div className="flex items-center p-3 border border-slate-600 rounded-lg bg-slate-700/50">
                                            <input 
                                                id="enrollInSavings" 
                                                name="enrollInSavings" 
                                                type="checkbox" 
                                                checked={formData.enrollInSavings !== false} // Default to true if undefined
                                                onChange={handleChange} 
                                                className="h-5 w-5 rounded border-gray-300 text-green-500 focus:ring-green-600 bg-slate-600" 
                                            />
                                            <div className="ml-3">
                                                <label htmlFor="enrollInSavings" className="text-sm font-bold text-green-300 cursor-pointer">
                                                    <i className="fas fa-piggy-bank mr-2"></i> Enroll in Savings Program
                                                </label>
                                                <p className="text-xs text-slate-400 mt-0.5">
                                                    If checked, a savings account will be created automatically with 5% contribution.
                                                </p>
                                            </div>
                                        </div>
                                    </div>
                                )}
                                {/* --- END Savings Checkbox --- */}

                                <div className="md:col-span-full"><hr className="border-slate-700 my-2"/></div>
                                {/* System & Permissions */}
                                <div><label className="text-sm font-medium text-slate-400"><i className="fas fa-envelope mr-2 text-cyan-300"></i>Email</label><input type="email" name="email" value={formData.email || ''} onChange={handleChange} className="input" disabled={isViewOnly} /></div>
                                
                                {/* NEW: Password field for new employee creation */}
                                {!employee && (
                                    <div>
                                        <label className="text-sm font-medium text-slate-400"><i className="fas fa-lock mr-2 text-red-300"></i>Password (new user)</label>
                                        <div className="relative">
                                            <input
                                                type={showPassword ? "text" : "password"}
                                                value={password}
                                                onChange={(e) => setPassword(e.target.value)}
                                                className="input"
                                                placeholder="Min. 6 characters"
                                                disabled={isViewOnly}
                                            />
                                            <button type="button" onClick={() => setShowPassword(!showPassword)} className="absolute inset-y-0 right-0 pr-3 flex items-center text-sm leading-5">
                                                <i className={`fas ${showPassword ? 'fa-eye-slash' : 'fa-eye'} text-slate-400 hover:text-slate-200`}></i>
                                            </button>
                                        </div>
                                    </div>
                                )}
                                
                                <div><label className="text-sm font-medium text-slate-400"><i className="fas fa-user-shield mr-2 text-emerald-300"></i>Role</label><select name="role" value={formData.role || 'Staff'} onChange={handleChange} className="select" disabled={isViewOnly || userProfile?.role === 'Shop Manager'}><option>Admin</option><option>CEO</option><option>Shop Manager</option><option>Staff</option></select></div>
                                <div className="md:col-span-2 lg:col-span-3"><label className="text-sm font-medium text-slate-400"><i className="fas fa-map-marker-alt mr-2 text-red-500"></i>Address</label><textarea name="address" value={formData.address || ''} onChange={handleChange} className="input" rows="3" disabled={isViewOnly}></textarea></div>

                                <div className="md:col-span-2 lg:col-span-3">
                                    <label className="text-sm font-medium text-slate-400"><i className="fas fa-key mr-2 text-yellow-500"></i>Page Permissions</label>
                                    <div className="mt-2 grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4 p-4 border border-slate-600 rounded-lg bg-slate-700/50">
                                        {availablePages.map(page => {
                                            // A Shop Manager cannot grant permissions for these specific pages.
                                            const isRestrictedForManager = userProfile?.role === 'Shop Manager' && ['expenseReport', 'userActivity', 'settings'].includes(page.key);
                                            
                                            // The checkbox is only disabled if the modal is view-only or if a Shop Manager is viewing a restricted permission.
                                            const isDisabled = isViewOnly || isRestrictedForManager;

                                            return (
                                                <div key={page.key} className="flex items-center">
                                                    <input id={`perm-${page.key}`} type="checkbox" value={page.key} checked={formData.permissions?.includes(page.key)} onChange={handleChange} disabled={isDisabled} className="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500 bg-slate-600" />
                                                    <label htmlFor={`perm-${page.key}`} className={`ml-3 text-sm ${isDisabled ? 'text-slate-500' : 'text-slate-300'}`}>{page.label}</label>
                                                </div>
                                            );
                                        })}
                                    </div>
                                </div>
                                {/* NEW: Display auth errors here */}
                                {authError && <p className="text-red-400 text-sm md:col-span-full">{authError}</p>}
                            </div>
                        </ModalBody>
                        <ModalFooter>
                            {isViewOnly ? (
                                <>
                                    <Button type="button" variant="secondary" onClick={onClose}>Close</Button>
                                    {(userProfile?.role === 'Admin' || userProfile?.role === 'CEO' || userProfile?.role === 'Shop Manager') && (
                                        <Button type="button" variant="primary" icon="fa-edit" onClick={(e) => { e.preventDefault(); onSwitchToEdit(); }}>Edit</Button>
                                    )}
                                </>
                            ) : (
                                <>
                                    <Button type="button" variant="secondary" onClick={onClose}>Cancel</Button>
                                    <Button type="submit" variant="primary" className="px-6">Save</Button>
                                </>
                            )}
                        </ModalFooter>
                    </form>
                </Modal>
            );
        };
        
        // NEW: ActiveEmployeesTab component to fix the reference error.
        // MODIFIED: Added 'pageParams' prop to handle auto-actions
        const ActiveEmployeesTab = ({ userProfile, pageParams }) => {
            // MODIFIED: Added 'auth'
            const { db, auth } = useFirebase();
            const [isModalOpen, setIsModalOpen] = useState(false);
            const [isViewOnly, setIsViewOnly] = useState(false);
            const [editingEmployee, setEditingEmployee] = useState(null);
            const [employeeToDelete, setEmployeeToDelete] = useState(null);
            
            // REFACTORED: Get global shops data from the App Data context provider.
            const { shops } = useAppData();
            
            const [selectedShop, setSelectedShop] = useState('');
            const [searchTerm, setSearchTerm] = useState(''); // NEW: State for the search term

            // --- NEW: Handle Auto-Open Action (from Dashboard) ---
            useEffect(() => {
                if (pageParams && pageParams.includes('add_new')) {
                    // Slight delay to ensure UI is ready
                    setTimeout(() => {
                        handleOpenModal(); 
                    }, 100);
                }
            }, [pageParams]);

            // Set the initial shop filter based on the user's role and assigned shop(s).
            useEffect(() => {
                if (userProfile && userProfile.role !== 'Admin' && userProfile.role !== 'CEO') {
                    // Managers with multiple shops default to 'All My Shops' (empty string).
                    // Single-shop users default to their assigned shop.
                    setSelectedShop(Array.isArray(userProfile.shop) ? '' : userProfile.shop || '');
                }
            }, [userProfile]);
            
            // Use the custom hook to fetch and filter employees based on the selected shop.
            const { employees, loading } = useFilteredEmployees(userProfile, selectedShop);

            // NEW: Further filter the employees based on the search term.
            const searchedEmployees = useMemo(() => {
                if (!searchTerm) {
                    return employees;
                }
                return employees.filter(emp => 
                    emp.name.toLowerCase().includes(searchTerm.toLowerCase())
                );
            }, [employees, searchTerm]);
            
            // NEW: Function to handle exporting the current employee list to an Excel file.
            const handleExportExcel = useCallback(() => {
                // Format the data to have more readable headers and select specific fields.
                const dataToExport = searchedEmployees.map(emp => ({ 
                    'Name': emp.name,
                    'Email': emp.email,
                    'Position': emp.position,
                    'Shop': Array.isArray(emp.shop) ? emp.shop.join(', ') : emp.shop,
                    'Join Date': emp.joinedDate,
                    'Worked Duration': Utils.calculateWorkedDuration(emp.joinedDate),
                    'Shift': emp.shift,
                    'Telephone': emp.tel,
                    'Salary (KHR)': parseFloat(String(emp.salary).replace(/[^0-9.-]/g, '')) || 0
                }));

                const worksheet = XLSX.utils.json_to_sheet(dataToExport);
                const workbook = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(workbook, worksheet, "Active Employees");
                
                // Set column widths for better readability
                worksheet["!cols"] = [ 
                    { wch: 25 }, // Name
                    { wch: 30 }, // Email
                    { wch: 20 }, // Position
                    { wch: 20 }, // Shop
                    { wch: 15 }, // Join Date
                    { wch: 18 }, // Worked Duration
                    { wch: 10 }, // Shift
                    { wch: 15 }, // Telephone
                    { wch: 18 }  // Salary
                ];
                
                XLSX.writeFile(workbook, "Active_Employees_Report.xlsx");
            }, [searchedEmployees]); // Dependency on the filtered list ensures the correct data is exported.
            
            const handleOpenModal = (employee = null, viewOnly = false) => {
                setEditingEmployee(employee);
                setIsViewOnly(viewOnly);
                setIsModalOpen(true);
            };

            const handleCloseModal = () => {
                setEditingEmployee(null);
                setIsModalOpen(false);
            };

            // Handler for saving a new or edited employee.
            const handleSaveEmployee = async (formData) => {
                // MODIFIED: Added setDoc and serverTimestamp for the auto-savings feature
                const { addDoc, updateDoc, doc, collection, setDoc, serverTimestamp } = window.firebaseSDK;
                const { id, enrollInSavings, ...dataToSave } = formData; // EXTRACT enrollInSavings
                
                // --- NEW LOGGING ---
                let action = '';
                let originalData = null;
                let savedEmployeeId = id; // Store the ID for logging

                try {
                    if (id) {
                        action = 'Edit Employee';
                        // Find original data *before* update
                        const originalEmployee = employees.find(e => e.id === id);
                        if (originalEmployee) originalData = originalEmployee;

                        await updateDoc(doc(db, 'employees', id), dataToSave);
                    } else {
                        action = 'Add Employee';
                        const newDocRef = await addDoc(collection(db, 'employees'), dataToSave);
                        savedEmployeeId = newDocRef.id; // Get the new ID

                        // --- NEW: AUTO-CREATE WELCOME NOTICE ---
                        try {
                            const shopName = Array.isArray(dataToSave.shop) ? (dataToSave.shop[0] || '') : (dataToSave.shop || '');
                            await addDoc(collection(db, 'memoAlerts'), {
                                title: `🎉 Welcome ${dataToSave.name}!`,
                                content: `We are thrilled to welcome **${dataToSave.name}** to the team!\n\nThey are joining us as a **${dataToSave.position}** at **${shopName}**.\n\nPlease give them a warm welcome!`,
                                startTime: '08:00',
                                endTime: '18:00',
                                targetShops: shopName ? [shopName] : [], // Target their shop (empty = global)
                                status: 'Active',
                                authorName: 'System',
                                authorId: 'system',
                                createdAt: serverTimestamp(),
                                readBy: [],
                                likes: []
                            });
                            console.log(`Welcome notice created for ${dataToSave.name}`);
                        } catch (noticeError) {
                            console.error("Failed to create welcome notice:", noticeError);
                        }
                        // --- END WELCOME NOTICE ---

                        // --- MODIFIED: Auto-Add to Savings Program (Conditional) ---
                        if (enrollInSavings !== false) { // Default to TRUE if undefined
                            try {
                                const today = new Date();
                                const savingsDefaults = {
                                    employeeId: savedEmployeeId,
                                    employeeName: dataToSave.name,
                                    // Ensure shop is a string. If array (multi-shop manager), take the first one.
                                    shop: Array.isArray(dataToSave.shop) ? (dataToSave.shop[0] || '') : (dataToSave.shop || ''),
                                    savingsProgramStatus: 'Active',
                                    savingsPercentage: 5, // Request: Default to 5%
                                    savingsJoinDate: today.toISOString().slice(0, 10), // Request: Current Date
                                    savingsEffectiveMonth: today.toISOString().slice(0, 7), // Request: Current Month
                                    currentBalance: 0,
                                    mySavingCredit: 0,
                                    mySavingWithdrawalTotal: 0,
                                    lastUpdated: serverTimestamp()
                                };

                                // Create the savings record immediately
                                await setDoc(doc(db, 'savingprogram', savedEmployeeId), savingsDefaults);
                                console.log(`Auto-enrolled ${dataToSave.name} in Savings Program.`);
                            } catch (savingsError) {
                                console.error("Failed to auto-enroll new employee in savings program:", savingsError);
                            }
                        } else {
                            console.log(`Skipped Savings Program enrollment for ${dataToSave.name}.`);
                        }
                        // --- END MODIFIED FEATURE ---
                    }

                    // --- NEW: Log the activity ---
                    Utils.logUserActivity(db, auth, action, {
                        id: savedEmployeeId,
                        name: dataToSave.name,
                        originalData: originalData,
                        updatedData: dataToSave
                    });
                    // --- END LOGGING ---

                    handleCloseModal();
                } catch (error) {
                    console.error("Error saving employee:", error);
                }
            };
            
            const handleDeleteEmployee = (employee) => {
                setEmployeeToDelete(employee);
            };

            const confirmDelete = async () => {
                if (!employeeToDelete) return;
                const { doc, updateDoc } = window.firebaseSDK;
                try {
                    const employeeRef = doc(db, 'employees', employeeToDelete.id);
                    // Instead of deleting, we change the status to 'Terminated'.
                    await updateDoc(employeeRef, { status: 'Terminated', statusChangeDate: new Date().toISOString().substring(0, 10), reasonForLeaving: 'Deleted from active list' });
                } catch (error) {
                    console.error("Error 'deleting' (terminating) employee:", error);
                } finally {
                    setEmployeeToDelete(null);
                }
            };

            // Render logic for the Active Employees tab.
            // OPTIMIZATION: Refactored to use PageHeader, SearchInput, and ShopFilterSelect
            return (
                <Card>
                    <PageHeader title={`Active Employee List - ${searchedEmployees.length}`}>
                        <SearchInput 
                            value={searchTerm} 
                            onChange={e => setSearchTerm(e.target.value)} 
                            placeholder="Search by name..."
                        />
                        
                        <ShopFilterSelect 
                            userProfile={userProfile}
                            shops={shops}
                            selectedShop={selectedShop}
                            onChange={e => setSelectedShop(e.target.value)}
                        />

                        <Button variant="success" icon="fa-file-excel" onClick={handleExportExcel} disabled={loading}>
                            Excel
                        </Button>
                        {(userProfile?.role === 'Admin' || userProfile?.role === 'CEO' || userProfile?.role === 'Shop Manager') && (
                            <Button variant="primary" icon="fa-plus" onClick={() => handleOpenModal()}>Add Employee</Button>
                        )}
                    </PageHeader>

                    {loading ? (
                        <div className="text-center py-10"><i className="fas fa-spinner fa-spin text-3xl"></i></div>
                    ) : (
                        <EmployeeTable
                            employees={searchedEmployees}
                            userProfile={userProfile}
                            onView={(emp) => handleOpenModal(emp, true)}
                            onDelete={handleDeleteEmployee}
                        />
                    )}

                    <EmployeeModal
                        isOpen={isModalOpen}
                        onClose={handleCloseModal}
                        onSave={handleSaveEmployee}
                        employee={editingEmployee}
                        userProfile={userProfile}
                        isViewOnly={isViewOnly}
                        onSwitchToEdit={() => setIsViewOnly(false)}
                        // FIX: Pass allEmployees (using the 'employees' list from the hook, 
                        // which contains filtered list. Or use global 'employees' from context if we need ALL for supervisor list)
                        // Using 'searchedEmployees' is risky if we filter out the supervisor. 
                        // It's safer to pass the full unfiltered list if possible, or 'employees' from the hook.
                        // Ideally we should pass 'employees' (the filtered list by shop) OR the global list.
                        // Let's pass 'employees' from the hook as it contains all active employees for the current view scope.
                        allEmployees={employees} 
                    />

                    <ConfirmationModal
                        isOpen={!!employeeToDelete}
                        onClose={() => setEmployeeToDelete(null)}
                        onConfirm={confirmDelete}
                        title="Confirm Deletion"
                        message={`Are you sure you want to remove ${employeeToDelete?.name}? Their status will be set to 'Terminated'.`}
                    />
                </Card>
            );
        };

        // NEW: Modal for adding/editing salary revisions
        const SalaryRevisionModal = ({ isOpen, onClose, onSave, revision, userProfile }) => {
            // Get global data from context
            const { shops, employees } = useAppData();
            const [formData, setFormData] = useState({});

            // OPTIMIZATION: Use the new hook
            const availableShops = useAllowedShops(userProfile, shops);

            const employeesInShop = useMemo(() => {
                if (!formData.shopName) return [];
                return employees.filter(emp => {
                    const employeeShops = Array.isArray(emp.shop) ? emp.shop : [emp.shop];
                    return employeeShops.includes(formData.shopName) && emp.status === 'Active';
                });
            }, [formData.shopName, employees]);

            // Initialize form
            useEffect(() => {
                const initialData = revision 
                    ? { ...revision }
                    : {
                        reqDate: new Date().toISOString().substring(0, 10),
                        effectiveDate: new Date().toISOString().substring(0, 10),
                        shopName: '',
                        staffId: '',
                        reviseAmount: '',
                        baseSalary: 0,
                        updatedSalary: 0,
                        status: 'Pending'
                    };
                setFormData(initialData);
            }, [revision, isOpen]);
            
            // REMOVED: The two separate useEffect hooks for salary calculation have been removed.

            // REVISED: Consolidated all salary calculation logic into a single, more robust handleChange function.
            // This prevents race conditions and ensures data consistency when the form is updated.
            const handleChange = useCallback((e) => {
                const { name, value } = e.target;
                
                setFormData(prev => {
                    const newFormData = { ...prev, [name]: value };

                    // When the shop selection changes...
                    if (name === 'shopName') {
                        // ...reset all employee-specific fields.
                        newFormData.staffId = '';
                        newFormData.staffName = '';
                        newFormData.baseSalary = 0;
                        newFormData.reviseAmount = '';
                        newFormData.updatedSalary = 0;
                    }

                    // When the staff selection changes...
                    if (name === 'staffId') {
                        const selectedEmployee = employees.find(emp => emp.id === value);
                        if (selectedEmployee) {
                            // ...update the staff name and recalculate salaries from scratch.
                            newFormData.staffName = selectedEmployee.name;
                            const currentSalary = parseFloat(String(selectedEmployee.salary).replace(/[^0-9.-]/g, '')) || 0;
                            const revisedAmount = parseFloat(newFormData.reviseAmount) || 0;
                            newFormData.baseSalary = currentSalary;
                            newFormData.updatedSalary = currentSalary + revisedAmount;
                        } else {
                            // ...or reset if the staff is deselected.
                            newFormData.staffName = '';
                            newFormData.baseSalary = 0;
                            newFormData.updatedSalary = parseFloat(newFormData.reviseAmount) || 0;
                        }
                    }

                    // When only the revision amount changes...
                    if (name === 'reviseAmount') {
                        // ...recalculate just the final salary.
                        const base = parseFloat(newFormData.baseSalary) || 0;
                        const revise = parseFloat(value) || 0;
                        newFormData.updatedSalary = base + revise;
                    }

                    return newFormData;
                });
            }, [employees]); // Dependency on employees is needed to find staff details.
            
            const handleSubmit = (e) => {
                e.preventDefault();
                onSave(formData);
            };
            
            return (
                <Modal isOpen={isOpen} onClose={onClose} maxWidth="max-w-3xl">
                    <form onSubmit={handleSubmit}>
                        <ModalHeader title={revision ? "Edit Salary Revision" : "Add New Salary Revision"} onClose={onClose} />
                        <ModalBody>
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <label className="text-sm font-medium text-slate-400">
                                        <i className="fas fa-calendar-alt mr-2 text-blue-400"></i>Request Date
                                    </label>
                                    <input type="date" name="reqDate" value={formData.reqDate || ''} onChange={handleChange} className="input" required />
                                </div>
                                <div>
                                    <label className="text-sm font-medium text-slate-400">
                                        <i className="fas fa-calendar-check mr-2 text-green-400"></i>Effective Date
                                    </label>
                                    <input type="date" name="effectiveDate" value={formData.effectiveDate || ''} onChange={handleChange} className="input" required />
                                </div>
                                
                                <div>
                                    <label className="text-sm font-medium text-slate-400">
                                        <i className="fas fa-store mr-2 text-purple-400"></i>Shop Name
                                    </label>
                                    <select name="shopName" value={formData.shopName || ''} onChange={handleChange} className="select" required>
                                        <option value="">Select Shop</option>
                                        {availableShops.map(shop => <option key={shop.id} value={shop.name}>{shop.name}</option>)}
                                    </select>
                                </div>
                                
                                <div>
                                    <label className="text-sm font-medium text-slate-400">
                                        <i className="fas fa-user mr-2 text-orange-400"></i>Staff Name
                                    </label>
                                    <select name="staffId" value={formData.staffId || ''} onChange={handleChange} className="select" required disabled={!formData.shopName}>
                                        <option value="">Select Staff</option>
                                        {employeesInShop.map(e => <option key={e.id} value={e.id}>{e.name}</option>)}
                                    </select>
                                </div>

                                <div>
                                    <label className="text-sm font-medium text-slate-400">
                                        <i className="fas fa-money-bill mr-2 text-slate-400"></i>Base Salary
                                    </label>
                                    <input value={Utils.formatCurrency(formData.baseSalary)} className="input" disabled />
                                </div>
                                <div>
                                    <label className="text-sm font-medium text-slate-400">
                                        <i className="fas fa-chart-line mr-2 text-yellow-400"></i>Revise Amount
                                    </label>
                                    <input type="number" name="reviseAmount" value={formData.reviseAmount || ''} onChange={handleChange} className="input" required />
                                </div>

                                <div className="md:col-span-2">
                                   <label className="text-sm font-medium text-slate-400">
                                       <i className="fas fa-money-bill-wave mr-2 text-green-500"></i>Updated Salary
                                   </label>
                                   <input value={Utils.formatCurrency(formData.updatedSalary)} className="input" disabled />
                                </div>
                            </div>
                        </ModalBody>
                        <ModalFooter>
                            <Button variant="secondary" onClick={onClose}>Cancel</Button>
                            <Button 
                                type="submit" 
                                variant="primary"
                                // FIX: Corrected disabled logic to use this component's state
                                // It should check for staffId and reviseAmount from its own formData.
                                disabled={!formData.staffId || !formData.reviseAmount}
                            >
                                {/* FIX: Corrected button text. */}
                                Save Revision
                            </Button>
                        </ModalFooter>
                    </form>
                </Modal>
            );
        };

        // Component: Salary Revise Report Tab
        const SalaryReviseReportTab = ({ userProfile }) => {
            // MODIFIED: Added 'auth'
            const { db, auth } = useFirebase();
            const { where } = window.firebaseSDK;
            const { shops } = useAppData();
            
            // State for modal and filters
            const [isModalOpen, setIsModalOpen] = useState(false);
            const [editingRevision, setEditingRevision] = useState(null);
            const [revisionToDelete, setRevisionToDelete] = useState(null);
            const [selectedShop, setSelectedShop] = useState('');
            // REVISED: Removed month filter state
            // const [selectedMonth, setSelectedMonth] = useState(new Date().toISOString().slice(0, 7));
            // REVISED: Added search term state
            const [searchTerm, setSearchTerm] = useState('');

            // Data fetching
            const queryConstraints = useMemo(() => {
                if (!userProfile) return [where("shopName", "==", "null")];
                if (userProfile.role === 'Admin' || userProfile.role === 'CEO') return [];
                if (userProfile.role === 'Shop Manager') {
                    const managedShops = Array.isArray(userProfile.shop) ? userProfile.shop : (userProfile.shop ? [userProfile.shop] : []);
                    return managedShops.length > 0 ? [where("shopName", "in", managedShops)] : [where("shopName", "==", "null")];
                }
                return [where("staffId", "==", userProfile.id || null)];
            }, [userProfile]);
            
            const { data: revisions, loading } = useCollection('salaryRevisions', queryConstraints);
            
            const filteredRevisions = useMemo(() => {
                return revisions
                    .filter(rev => 
                        (!selectedShop || rev.shopName === selectedShop) &&
                        // REVISED: Replaced month filter with search term filter
                        (!searchTerm || (rev.staffName && rev.staffName.toLowerCase().includes(searchTerm.toLowerCase())))
                    )
                    .sort((a,b) => (b.reqDate || '').localeCompare(a.reqDate || ''));
            // REVISED: Updated dependency array
            }, [revisions, selectedShop, searchTerm]);

            // Handlers
            const handleOpenModal = (revision = null) => { setEditingRevision(revision); setIsModalOpen(true); };
            const handleCloseModal = () => { setEditingRevision(null); setIsModalOpen(false); };
            
            const handleSaveRevision = async (formData) => {
                const { addDoc, updateDoc, doc, collection, serverTimestamp } = window.firebaseSDK;
                const { id, ...dataToSave } = formData;
                
                try {
                    if (id) {
                        await updateDoc(doc(db, 'salaryRevisions', id), dataToSave);
                    } else {
                        await addDoc(collection(db, 'salaryRevisions'), { ...dataToSave, status: 'Pending', createdAt: serverTimestamp() });
                    }
                    handleCloseModal();
                } catch (error) { console.error("Error saving salary revision:", error); }
            };
            
            const handleUpdateStatus = async (revision, newStatus) => {
                const { updateDoc, doc } = window.firebaseSDK;
                try {
                    const revisionRef = doc(db, 'salaryRevisions', revision.id);
                    await updateDoc(revisionRef, { status: newStatus });
                    
                    // --- NEW: Log the approval/rejection ---
                    const action = newStatus === 'Approved' ? 'Approve Salary Revision' : 'Reject Salary Revision';
                    Utils.logUserActivity(db, auth, action, {
                        id: revision.id,
                        name: revision.staffName,
                        originalData: { ...revision, status: 'Pending' },
                        updatedData: { ...revision, status: newStatus }
                    });
                    // --- END LOGGING ---
                    
                    // CRITICAL STEP: If approved, update the employee's main salary record.
                    // REMOVED: This line is removed to ensure historical payroll accuracy.
                    // The payroll calculator will now refer to the revision history instead.
                    /*
                    if (newStatus === 'Approved') {
                        const employeeRef = doc(db, 'employees', revision.staffId);
                        await updateDoc(employeeRef, { salary: revision.updatedSalary });
                    }
                    */
                } catch (error) { console.error("Error updating revision status:", error); }
            };
            
            const handleDeleteConfirm = async () => {
                if (!revisionToDelete) return;
                try {
                    await window.firebaseSDK.deleteDoc(window.firebaseSDK.doc(db, 'salaryRevisions', revisionToDelete.id));
                } catch (error) { console.error("Error deleting revision:", error); }
                finally { setRevisionToDelete(null); }
            };

            const canManage = userProfile?.role === 'Admin' || userProfile?.role === 'CEO';
            
            // OPTIMIZATION: Use the new hook
            const availableShops = useAllowedShops(userProfile, shops);

            return (
                <Card>
                    <PageHeader title="Salary Revision Management">
                        <ShopFilterSelect 
                            userProfile={userProfile}
                            shops={shops}
                            selectedShop={selectedShop}
                            onChange={e => setSelectedShop(e.target.value)}
                        />
                        <SearchInput value={searchTerm} onChange={e => setSearchTerm(e.target.value)} />
                        {canManage && <Button variant="primary" icon="fa-plus" onClick={() => handleOpenModal()}>Add Revision</Button>}
                    </PageHeader>

                    {loading ? <div className="text-center py-10"><i className="fas fa-spinner fa-spin text-3xl"></i></div> : (
                    <div className="overflow-x-auto">
                        <table className="min-w-full divide-y divide-slate-700">
                            <thead className="bg-slate-900/50">
                                <tr>
                                    <th className="px-4 py-3 text-left text-xs font-semibold uppercase">Req Date</th>
                                    <th className="px-4 py-3 text-left text-xs font-semibold uppercase">Effective Date</th>
                                    <th className="px-4 py-3 text-left text-xs font-semibold uppercase">Shop</th>
                                    <th className="px-4 py-3 text-left text-xs font-semibold uppercase">Staff Name</th>
                                    <th className="px-4 py-3 text-right text-xs font-semibold uppercase">Base Salary</th>
                                    <th className="px-4 py-3 text-right text-xs font-semibold uppercase">Revise Amount</th>
                                    <th className="px-4 py-3 text-right text-xs font-semibold uppercase">Updated Salary</th>
                                    <th className="px-4 py-3 text-center text-xs font-semibold uppercase">Status</th>
                                    <th className="px-4 py-3 text-center text-xs font-semibold uppercase">Actions</th>
                                </tr>
                            </thead>
                            <tbody className="divide-y divide-slate-700">
                                {filteredRevisions.map(rev => (
                                    <tr key={rev.id} className="hover:bg-slate-700/50">
                                        <td className="px-4 py-4 text-sm">{Utils.formatISOToDisplay(rev.reqDate)}</td>
                                        <td className="px-4 py-4 text-sm">{Utils.formatISOToDisplay(rev.effectiveDate)}</td>
                                        <td className="px-4 py-4 text-sm">{rev.shopName}</td>
                                        <td className="px-4 py-4 text-sm">{rev.staffName}</td>
                                        <td className="px-4 py-4 text-sm text-right">{Utils.formatCurrency(rev.baseSalary)}</td>
                                        <td className={`px-4 py-4 text-sm text-right font-semibold ${rev.reviseAmount >= 0 ? 'text-green-400' : 'text-red-400'}`}>{Utils.formatCurrency(rev.reviseAmount)}</td>
                                        <td className="px-4 py-4 text-sm text-slate-300 text-right font-semibold">{Utils.formatCurrency(rev.updatedSalary)}</td>
                                        <td className="px-4 py-4 text-center text-sm">
                                            <span className={`px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${ rev.status === 'Approved' ? 'bg-green-100 text-green-800' : rev.status === 'Rejected' ? 'bg-red-100 text-red-800' : 'bg-yellow-100 text-yellow-800' }`}>
                                                {rev.status}
                                            </span>
                                        </td>
                                        <td className="px-4 py-4 text-center whitespace-nowrap">
                                            <div className="flex items-center justify-center gap-2">
                                                {canManage && rev.status === 'Pending' && (
                                                    <>
                                                        <Button variant="icon-approve" icon="fa-check-circle" onClick={() => handleUpdateStatus(rev, 'Approved')} title="Approve" />
                                                        <Button variant="icon-reject" icon="fa-times-circle" onClick={() => handleUpdateStatus(rev, 'Rejected')} title="Reject" />
                                                    </>
                                                )}
                                                {canManage && (
                                                    <>
                                                        <Button variant="icon-edit" icon="fa-edit" onClick={() => handleOpenModal(rev)} title="Edit" />
                                                        <Button variant="icon-delete" icon="fa-trash" onClick={() => setRevisionToDelete(rev)} title="Delete" />
                                                    </>
                                                )}
                                            </div>
                                        </td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                    )}
                    <SalaryRevisionModal isOpen={isModalOpen} onClose={handleCloseModal} onSave={handleSaveRevision} revision={editingRevision} userProfile={userProfile} />
                    <ConfirmationModal isOpen={!!revisionToDelete} onClose={() => setRevisionToDelete(null)} onConfirm={handleDeleteConfirm} title="Delete Revision" message="Are you sure you want to delete this salary revision record?" />
                </Card>
            );
        };
        
        // NEW: Table component specifically for displaying former employees.
        const FormerEmployeeTable = memo(({ employees, userProfile, onEdit, onDelete }) => {
            return (
                <div className="overflow-x-auto">
                    <table className="min-w-full divide-y divide-slate-700">
                        <thead className="bg-slate-900/50">
                            <tr>
                                <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Date</th>
                                <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Shop Name</th>
                                <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Staff</th>
                                <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Worked Dur.</th>
                                <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Status</th>
                                <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Reason</th>
                                <th className="px-4 py-3 text-center text-xs font-semibold text-slate-400 uppercase">Actions</th>
                            </tr>
                        </thead>
                        <tbody className="divide-y divide-slate-700">
                            {employees.map(emp => (
                                <tr key={emp.id} className="hover:bg-slate-700/50">
                                    <td className="px-4 py-4 text-sm text-slate-300 whitespace-nowrap">{Utils.formatISOToDisplay(emp.statusChangeDate)}</td>
                                    <td className="px-4 py-4 text-sm text-slate-300 whitespace-nowrap">{Array.isArray(emp.shop) ? emp.shop.join(', ') : emp.shop}</td>
                                    <td className="px-4 py-4 text-sm text-slate-200 whitespace-nowrap">{emp.name}</td>
                                    <td className="px-4 py-4 text-sm text-slate-300 whitespace-nowrap">{Utils.calculateWorkedDuration(emp.joinedDate, emp.statusChangeDate)}</td>
                                    <td className="px-4 py-4 text-sm text-slate-300 whitespace-nowrap">{emp.status}</td>
                                    <td className="px-4 py-4 text-sm text-slate-300 whitespace-pre-wrap max-w-xs truncate" title={emp.reasonForLeaving}>{emp.reasonForLeaving}</td>
                                    <td className="px-4 py-4 text-center whitespace-nowrap">
                                        <div className="flex items-center justify-center gap-4">
                                            {(userProfile?.role === 'Admin' || userProfile?.role === 'CEO' || userProfile?.role === 'Shop Manager') && (
                                                <Button variant="icon-edit" icon="fa-edit" onClick={() => onEdit(emp)} title="Edit Record"/>
                                            )}
                                            {/* Permanent delete is restricted to Admin/CEO for data integrity */}
                                            {(userProfile?.role === 'Admin' || userProfile?.role === 'CEO') && (
                                                <Button variant="icon-delete" icon="fa-trash" onClick={() => onDelete(emp)} title="Permanently Delete"/>
                                            )}
                                        </div>
                                    </td>
                                </tr>
                            ))}
                        </tbody>
                    </table>
                </div>
            );
        });

        // REPLACED: This component now provides the requested report table for former employees.
        const FormerEmployeesTab = ({ userProfile }) => {
            const { db } = useFirebase();
            const [isModalOpen, setIsModalOpen] = useState(false);
            const [editingEmployee, setEditingEmployee] = useState(null);
            const [employeeToDelete, setEmployeeToDelete] = useState(null);
            
            // Get global shops data from context for the filter dropdown.
            const { shops } = useAppData();
            
            const [selectedShop, setSelectedShop] = useState('');
            const [searchTerm, setSearchTerm] = useState('');

            // Set initial shop filter based on user's role.
            useEffect(() => {
                if (userProfile && userProfile.role !== 'Admin' && userProfile.role !== 'CEO') {
                    setSelectedShop(Array.isArray(userProfile.shop) ? '' : userProfile.shop || '');
                }
            }, [userProfile]);
            
            // Custom hook to fetch former employees based on user role and selected shop.
            const useFormerEmployees = (userProfile, selectedShop) => {
                const { db } = useFirebase();
                const [employees, setEmployees] = useState([]);
                const [loading, setLoading] = useState(true);

                useEffect(() => {
                    if (!db || !userProfile) return () => {};
                    
                    const { collection, query, where, onSnapshot } = window.firebaseSDK;
                    setLoading(true);
                    
                    const statusFilter = where("status", "in", ["Terminated", "Resigned"]);
                    let finalQuery;
                    
                    const baseQuery = query(collection(db, "employees"), statusFilter);
                    const role = userProfile.role;

                    if (role === 'Admin' || role === 'CEO') {
                        finalQuery = selectedShop ? query(baseQuery, where("shop", "==", selectedShop)) : baseQuery;
                    } else if (role === 'Shop Manager') {
                        const managedShops = Array.isArray(userProfile.shop) ? userProfile.shop : (userProfile.shop ? [userProfile.shop] : []);
                        if (managedShops.length > 0) {
                            const shopsToQuery = selectedShop ? [selectedShop] : managedShops;
                            finalQuery = query(baseQuery, where("shop", "in", shopsToQuery));
                        } else {
                            setEmployees([]); setLoading(false); return; // Manager with no shops sees nothing
                        }
                    } else {
                        setEmployees([]); setLoading(false); return; // Staff role sees nothing
                    }

                    const unsub = onSnapshot(finalQuery, (snapshot) => {
                        setEmployees(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
                        setLoading(false);
                    }, (error) => {
                        console.error("Error fetching former employees:", error);
                        setLoading(false);
                    });

                    return () => unsub();
                }, [db, userProfile, selectedShop]);

                return { employees, loading };
            };

            const { employees, loading } = useFormerEmployees(userProfile, selectedShop);

            // Further filter employees based on search term on the client side.
            const searchedEmployees = useMemo(() => {
                if (!searchTerm) return employees;
                return employees.filter(emp => 
                    emp.name.toLowerCase().includes(searchTerm.toLowerCase())
                );
            }, [employees, searchTerm]);
            
            // Determine which shops are available for the filter dropdown.
            const availableShopsForFilter = useMemo(() => {
                if (!userProfile || !shops) return [];
                if (userProfile.role === 'Admin' || userProfile.role === 'CEO') return shops;
                if (userProfile.role === 'Shop Manager' && Array.isArray(userProfile.shop)) {
                    return userProfile.shop.map(name => ({ id: name, name: name }));
                }
                return [];
            }, [userProfile, shops]);
            
            // Handlers for modal operations.
            const handleOpenModal = (employee) => {
                setEditingEmployee(employee);
                setIsModalOpen(true);
            };

            const handleCloseModal = () => {
                setEditingEmployee(null);
                setIsModalOpen(false);
            };

            const handleSaveEmployee = async (formData) => {
                const { updateDoc, doc } = window.firebaseSDK;
                const { id, ...dataToSave } = formData;
                try {
                    await updateDoc(doc(db, 'employees', id), dataToSave);
                    handleCloseModal();
                } catch (error) {
                    console.error("Error updating former employee:", error);
                }
            };
            
            // Handlers for deletion.
            const handleDeleteEmployee = (employee) => {
                setEmployeeToDelete(employee);
            };

            const confirmDelete = async () => {
                if (!employeeToDelete) return;
                const { doc, deleteDoc } = window.firebaseSDK;
                try {
                    // This is a permanent, hard delete from the database.
                    await deleteDoc(doc(db, 'employees', employeeToDelete.id));
                } catch (error) {
                    console.error("Error permanently deleting employee record:", error);
                } finally {
                    setEmployeeToDelete(null);
                }
            };

            // OPTIMIZATION: Refactored to use new components
            return (
                <Card>
                    <PageHeader title="Resigned/Terminated Employee List">
                        <SearchInput value={searchTerm} onChange={e => setSearchTerm(e.target.value)} />
                        <ShopFilterSelect 
                            userProfile={userProfile}
                            shops={shops}
                            selectedShop={selectedShop}
                            onChange={e => setSelectedShop(e.target.value)}
                        />
                    </PageHeader>

                    {loading ? (
                        <div className="text-center py-10"><i className="fas fa-spinner fa-spin text-3xl"></i></div>
                    ) : (
                        <FormerEmployeeTable 
                            employees={searchedEmployees}
                            userProfile={userProfile}
                            onEdit={handleOpenModal}
                            onDelete={handleDeleteEmployee}
                        />
                    )}

                    <EmployeeModal
                        isOpen={isModalOpen}
                        onClose={handleCloseModal}
                        onSave={handleSaveEmployee}
                        employee={editingEmployee}
                        userProfile={userProfile}
                        isViewOnly={false} // Always open in edit mode for this tab
                        onSwitchToEdit={() => {}} // Not applicable here
                    />

                    <ConfirmationModal
                        isOpen={!!employeeToDelete}
                        onClose={() => setEmployeeToDelete(null)}
                        onConfirm={confirmDelete}
                        title="Confirm Permanent Deletion"
                        message={`Are you sure you want to PERMANENTLY delete the record for ${employeeToDelete?.name}? This action cannot be undone and will remove all their historical data.`}
                    />
                </Card>
            );
        };

        // Component: Main Employees Page (Tab Container)
        // MODIFIED: Added 'pageParams' prop
        const EmployeesPage = ({ userProfile, pageParams }) => {
            const [activeTab, setActiveTab] = useState('active');
            
            // MODIFIED: Added specific icons to the tabs for better navigation visuals
            const tabs = { 
                active: <span><i className="fas fa-users mr-2 text-blue-400"></i>Active Employees</span>, 
                salaryReport: <span><i className="fas fa-file-invoice-dollar mr-2 text-green-400"></i>Salary Revise Report</span>, 
                former: <span><i className="fas fa-user-slash mr-2 text-red-400"></i>Resigned/Terminated</span> 
            };

            return (
                <TabbedPage tabs={tabs} activeTab={activeTab} setActiveTab={setActiveTab}>
                    {/* MODIFIED: Pass pageParams to ActiveEmployeesTab */}
                    <div id="active"><ActiveEmployeesTab userProfile={userProfile} pageParams={pageParams} /></div>
                    <div id="salaryReport"><SalaryReviseReportTab userProfile={userProfile} /></div>
                    <div id="former"><FormerEmployeesTab userProfile={userProfile} /></div>
                </TabbedPage>
            );
        };
        // --- END EMPLOYEES PAGE COMPONENTS ---
        
        // --- START SAVINGS PROGRAM PAGE COMPONENTS (NEW) ---
        
        // NEW: Modal to Add/Edit Salary Saving Program Participants
        // MODIFIED (STEP 4): Added 'allSavings' prop
        const AddSalarySavingModal = ({ isOpen, onClose, onSave, participant, userProfile, allEmployees, allSavings }) => {
            const { shops } = useAppData();
            const [selectedShop, setSelectedShop] = useState('');
            const [selectedEmployeeId, setSelectedEmployeeId] = useState('');
            const [savingsPercentage, setSavingsPercentage] = useState(0);
            const [joinDate, setJoinDate] = useState('');
            const [effectiveMonth, setEffectiveMonth] = useState('');
            // --- NEW: State for participant status ---
            const [savingsProgramStatus, setSavingsProgramStatus] = useState('Active');
        
            useEffect(() => {
                if (participant) {
                    // EDIT MODE
                    const participantShop = Array.isArray(participant.shop) ? participant.shop[0] : participant.shop;
                    setSelectedShop(participantShop || '');
                    setSelectedEmployeeId(participant.id);
                    setSavingsPercentage(participant.savingsPercentage || 0);
                    setJoinDate(participant.savingsJoinDate || '');
                    setEffectiveMonth(participant.savingsEffectiveMonth || '');
                    // --- NEW: Load existing status in edit mode ---
                    setSavingsProgramStatus(participant.savingsProgramStatus || 'Active');
                } else {
                    // ADD MODE - Reset form
                    setSelectedShop('');
                    setSelectedEmployeeId('');
                    setSavingsPercentage(0);
                    const today = new Date().toISOString().slice(0, 10);
                    const currentMonth = new Date().toISOString().slice(0, 7);
                    setJoinDate(today);
                    setEffectiveMonth(currentMonth);
                    // --- NEW: Default status for new participants ---
                    setSavingsProgramStatus('Active');
                }
            }, [participant, isOpen]);
        
            // OPTIMIZATION: Use the new hook
            const availableShops = useAllowedShops(userProfile, shops);
            
            const availableEmployees = useMemo(() => {
                if (!selectedShop) return [];
                // MODIFIED (STEP 4): Check against the new 'allSavings' prop (from /savingprogram)
                // to see if an employee is already enrolled, instead of checking the deprecated
                // 'savingsProgramStatus' field on the employee document.
                
                // --- START FIX: Only filter out employees who are 'Active' ---
                // The original code created a Set of all IDs, blocking 'Inactive' ones.
                // This new code only adds 'Active' members to the set.
                const enrolledIds = new Set(
                    (allSavings || [])
                        .filter(s => s.savingsProgramStatus === 'Active')
                        .map(s => s.id)
                );
                // --- END FIX ---
                
                return allEmployees.filter(emp => {
                    const isInShop = Array.isArray(emp.shop) ? emp.shop.includes(selectedShop) : emp.shop === selectedShop;
                    // Use the new Set to check for enrollment
                    const isNotEnrolled = !enrolledIds.has(emp.id);
                    return emp.status === 'Active' && isInShop && (isNotEnrolled || emp.id === participant?.id);
                });
            }, [selectedShop, allEmployees, participant, allSavings]); // Added 'allSavings'
        
            const handleSubmit = (e) => {
                e.preventDefault();
                if (!selectedEmployeeId || isNaN(savingsPercentage) || savingsPercentage <= 0 || !joinDate || !effectiveMonth) {
                    alert("Please fill all required fields, including a savings percentage greater than 0.");
                    return;
                }
                // MODIFIED: Pass the new 'savingsProgramStatus' state
                onSave(selectedEmployeeId, savingsPercentage || 0, joinDate, effectiveMonth, !!participant, savingsProgramStatus);
            };
        
            return (
                <Modal isOpen={isOpen} onClose={onClose} maxWidth="max-w-xl">
                    <form onSubmit={handleSubmit}>
                        <ModalHeader title={participant ? "Edit Savings Percentage" : "Add to Savings Program"} onClose={onClose} />
                        <ModalBody>
                            <div className="space-y-4">
                                <div>
                                    <label className="text-sm font-medium text-slate-400"><i className="fas fa-store mr-2 text-cyan-400"></i>Shop</label>
                                    <select value={selectedShop} onChange={e => setSelectedShop(e.target.value)} className="select" disabled={!!participant}>
                                        <option value="">Select Shop</option>
                                        {availableShops.map(s => <option key={s.id} value={s.name}>{s.name}</option>)}
                                    </select>
                                </div>
                                <div>
                                    <label className="text-sm font-medium text-slate-400"><i className="fas fa-user mr-2 text-emerald-400"></i>Employee</label>
                                    <select value={selectedEmployeeId} onChange={e => setSelectedEmployeeId(e.target.value)} className="select" disabled={!selectedShop || !!participant}>
                                        <option value="">Select Employee</option>
                                        {availableEmployees.map(e => <option key={e.id} value={e.id}>{e.name}</option>)}
                                    </select>
                                </div>
                                <div>
                                    <label className="text-sm font-medium text-slate-400"><i className="fas fa-percent mr-2 text-purple-400"></i>Savings Percentage (%)</label>
                                    <input
                                        type="number"
                                        value={isNaN(savingsPercentage) ? '' : savingsPercentage}
                                        onChange={e => setSavingsPercentage(parseFloat(e.target.value))}
                                        className="input"
                                        min="0"
                                        max="100"
                                        placeholder="e.g., 10"
                                        required
                                    />
                                </div>
                                <div>
                                    <label className="text-sm font-medium text-slate-400"><i className="fas fa-calendar-plus mr-2 text-blue-400"></i>Join Program Date</label>
                                    <input
                                        type="date"
                                        value={joinDate}
                                        onChange={e => setJoinDate(e.target.value)}
                                        className="input"
                                        required
                                    />
                                </div>
                                <div>
                                    <label className="text-sm font-medium text-slate-400"><i className="fas fa-calendar-alt mr-2 text-orange-400"></i>Effective Month</label>
                                    <input
                                        type="month"
                                        value={effectiveMonth}
                                        onChange={e => setEffectiveMonth(e.target.value)}
                                        className="input"
                                        required
                                    />
                                </div>
                                {/* --- NEW: Status field for Edit Mode --- */}
                                {participant && (
                                    <div>
                                        <label className="text-sm font-medium text-slate-400"><i className="fas fa-info-circle mr-2 text-yellow-400"></i>Status</label>
                                        <select
                                            name="status"
                                            value={savingsProgramStatus}
                                            onChange={e => setSavingsProgramStatus(e.target.value)}
                                            className={`select ${
                                                savingsProgramStatus === 'Active' ? 'text-green-400' :
                                                savingsProgramStatus === 'Paused' ? 'text-yellow-400' :
                                                'text-red-400'
                                            }`}
                                            required
                                        >
                                            <option value="Active">Active</option>
                                            {/* NEW: Added Paused option */}
                                            <option value="Paused">Paused</option>
                                            <option value="Inactive">Inactive</option>
                                        </select>
                                    </div>
                                )}
                            </div>
                        </ModalBody>
                        <ModalFooter>
                            <Button variant="secondary" onClick={onClose}>Cancel</Button>
                            <Button 
                                type="submit" 
                                variant="primary"
                                // FIX: Corrected disabled logic to use this component's state
                                // (savingsPercentage, selectedEmployeeId) instead of 'amount'.
                                // This resolves the "amount is not defined" error.
                                disabled={!selectedEmployeeId || isNaN(savingsPercentage) || savingsPercentage <= 0 || !joinDate || !effectiveMonth}
                            >
                                {/* FIX: Corrected button text. */}
                                {participant ? "Update" : "Save Participant"}
                            </Button>
                        </ModalFooter>
                    </form>
                </Modal>
            );
        };

        // NEW: Modal for processing a savings payback
        const PaybackModal = ({ isOpen, onClose, onSave, participant }) => {
            const [amount, setAmount] = useState(0); 
            const [note, setNote] = useState('');
            const [error, setError] = useState('');
            const [selectedPercentage, setSelectedPercentage] = useState(null); 

            useEffect(() => {
                if (isOpen) {
                    setAmount(0);
                    setNote('');
                    setError('');
                    setSelectedPercentage(null); 
                }
            }, [isOpen]);
            
            // NEW: Handler for percentage buttons
            const handlePercentageClick = (percentage) => {
                if (!participant) return;
                const paybackAmount = Math.round((participant.savingsBalance || 0) * (percentage / 100));
                setAmount(paybackAmount);
                setSelectedPercentage(percentage);
                setError('');
            };

            const handleSubmit = (e) => {
                e.preventDefault();
                const paybackAmount = parseFloat(amount);
                
                if (isNaN(paybackAmount) || paybackAmount <= 0) { 
                    setError('Please select a valid payback percentage.');
                    return;
                }
                if (paybackAmount > participant.savingsBalance) {
                    setError('Payback amount cannot exceed the total savings.');
                    return;
                }
                onSave(participant.id, paybackAmount, note);
            };

            if (!participant) return null;

            return (
                <Modal isOpen={isOpen} onClose={onClose} maxWidth="max-w-md">
                    <form onSubmit={handleSubmit}>
                        <ModalHeader title="Process Savings Payback" onClose={onClose} />
                        <ModalBody>
                            <div className="space-y-4">
                                <div>
                                    <label className="text-sm font-medium text-slate-400"><i className="fas fa-user mr-2 text-slate-400"></i>Employee</label>
                                    <input value={participant.name} className="input" disabled />
                                </div>
                                <div>
                                    <label className="text-sm font-medium text-slate-400"><i className="fas fa-wallet mr-2 text-green-400"></i>Current Balance</label>
                                    <input value={Utils.formatCurrency(participant.savingsBalance)} className="input" disabled />
                                </div>
                                
                                <div>
                                    <label className="text-sm font-medium text-slate-400"><i className="fas fa-percent mr-2 text-blue-400"></i>Payback Percentage</label>
                                    <div className="grid grid-cols-4 gap-2 mt-1">
                                        {[25, 50, 75, 100].map(pct => (
                                            <button
                                                key={pct}
                                                type="button"
                                                onClick={() => handlePercentageClick(pct)}
                                                className={`py-2 text-sm font-medium rounded border transition-colors ${
                                                    selectedPercentage === pct
                                                        ? 'bg-blue-600 border-blue-600 text-white'
                                                        : 'bg-slate-700 border-slate-600 text-slate-300 hover:bg-slate-600'
                                                }`}
                                            >
                                                {pct}%
                                            </button>
                                        ))}
                                    </div>
                                </div>

                                <div>
                                    <label className="text-sm font-medium text-slate-400"><i className="fas fa-coins mr-2 text-yellow-400"></i>Calculated Amount (KHR)</label>
                                    <input
                                        type="text"
                                        value={Utils.formatCurrency(amount)}
                                        className="input"
                                        disabled
                                    />
                                </div>

                                <div>
                                    <label className="text-sm font-medium text-slate-400"><i className="fas fa-sticky-note mr-2 text-slate-400"></i>Note (Optional)</label>
                                    <input
                                        type="text"
                                        value={note}
                                        onChange={(e) => setNote(e.target.value)}
                                        className="input"
                                        placeholder="e.g., Resignation payout"
                                    />
                                </div>
                                {error && <p className="text-sm text-red-400">{error}</p>}
                            </div>
                        </ModalBody>
                        <ModalFooter>
                            <Button variant="secondary" onClick={onClose}>Cancel</Button>
                            <Button 
                                type="submit" 
                                variant="primary"
                                disabled={!amount || parseFloat(amount) <= 0}
                            >
                                Confirm Payback
                            </Button>
                        </ModalFooter>
                    </form>
                </Modal>
            );
        };

        // NEW: Modal for processing a savings deposit (Cash on Hand)
        const DepositModal = ({ isOpen, onClose, onSave, participant }) => {
            const [amount, setAmount] = useState('');
            const [note, setNote] = useState('');
            const [date, setDate] = useState(''); // NEW: Date state
            const [error, setError] = useState('');
            const [isSubmitting, setIsSubmitting] = useState(false); // NEW: Loading state

            useEffect(() => {
                if (isOpen) {
                    setAmount('');
                    setNote('Cash Deposit');
                    setDate(new Date().toISOString().slice(0, 10)); // Default to today
                    setError('');
                    setIsSubmitting(false); // Reset loading state
                }
            }, [isOpen]);

            // NEW: Calculate projected total
            const currentBalance = participant?.savingsBalance || 0;
            const depositAmountValue = parseFloat(amount) || 0;
            const projectedTotal = currentBalance + depositAmountValue;

            const handleSubmit = async (e) => { // Made async
                e.preventDefault();
                const depositAmount = parseFloat(amount);
                
                if (isNaN(depositAmount) || depositAmount <= 0) { 
                    setError('Please enter a valid positive amount.');
                    return;
                }

                setIsSubmitting(true); // Start loading
                
                // Await the result to know if we should reset loading or if modal will close
                // MODIFIED: Pass date to onSave
                const success = await onSave(participant.id, depositAmount, note, date);
                
                if (!success) {
                    setIsSubmitting(false); // Only reset if failed (modal stays open)
                }
                // If success, parent component will close the modal, so we don't need to do anything.
            };

            if (!participant) return null;

            return (
                <Modal isOpen={isOpen} onClose={onClose} maxWidth="max-w-md">
                    <form onSubmit={handleSubmit}>
                        <ModalHeader title="Deposit Cash to Savings" onClose={onClose} />
                        <ModalBody>
                            <div className="space-y-4">
                                <div>
                                    <label className="text-sm font-medium text-slate-400"><i className="fas fa-user mr-2 text-slate-400"></i>Employee</label>
                                    <input value={participant.name} className="input" disabled />
                                </div>
                                <div className="grid grid-cols-2 gap-4">
                                    <div>
                                        <label className="text-sm font-medium text-slate-400"><i className="fas fa-wallet mr-2 text-slate-400"></i>Current Balance</label>
                                        <input value={Utils.formatCurrency(currentBalance)} className="input" disabled />
                                    </div>
                                    {/* NEW: Date Input */}
                                    <div>
                                        <label className="text-sm font-medium text-slate-400"><i className="fas fa-calendar-day mr-2 text-blue-400"></i>Date</label>
                                        <input 
                                            type="date" 
                                            value={date} 
                                            onChange={(e) => setDate(e.target.value)} 
                                            className="input" 
                                            required 
                                            disabled={isSubmitting}
                                        />
                                    </div>
                                </div>
                                
                                <div>
                                    <label className="text-sm font-medium text-slate-400"><i className="fas fa-money-bill-wave mr-2 text-green-400"></i>Deposit Amount (KHR)</label>
                                    <input
                                        type="number"
                                        value={amount}
                                        onChange={(e) => setAmount(e.target.value)}
                                        className="input font-bold text-green-400"
                                        placeholder="Enter amount"
                                        required
                                        min="100"
                                        disabled={isSubmitting} // Disable while submitting
                                    />
                                </div>

                                {/* NEW: Total Calculation Display */}
                                <div>
                                    <label className="text-sm font-medium text-slate-400"><i className="fas fa-calculator mr-2 text-blue-400"></i>Total (Current + Deposit)</label>
                                    <input 
                                        value={Utils.formatCurrency(projectedTotal)} 
                                        className="input font-bold text-blue-400 bg-slate-800" 
                                        disabled 
                                    />
                                </div>

                                <div>
                                    <label className="text-sm font-medium text-slate-400"><i className="fas fa-sticky-note mr-2 text-slate-400"></i>Note (Optional)</label>
                                    <input
                                        type="text"
                                        value={note}
                                        onChange={(e) => setNote(e.target.value)}
                                        className="input"
                                        placeholder="e.g., Cash from employee"
                                        disabled={isSubmitting}
                                    />
                                </div>
                                {error && <p className="text-sm text-red-400">{error}</p>}
                            </div>
                        </ModalBody>
                        <ModalFooter>
                            <Button variant="secondary" onClick={onClose} disabled={isSubmitting}>Cancel</Button>
                            <Button 
                                type="submit" 
                                variant="success" 
                                disabled={!amount || parseFloat(amount) <= 0 || !date || isSubmitting}
                            >
                                {isSubmitting ? <><i className="fas fa-spinner fa-spin"></i> Processing...</> : 'Confirm Deposit'}
                            </Button>
                        </ModalFooter>
                    </form>
                </Modal>
            );
        };

        // --- FIX: ADDED MISSING SavingsHistoryModal COMPONENT ---
        const SavingsHistoryModal = ({ isOpen, onClose, employeeName, transactions }) => {
            if (!isOpen) return null;

            return (
                <Modal isOpen={isOpen} onClose={onClose} maxWidth="max-w-2xl">
                    <ModalHeader title={`Savings History: ${employeeName}`} onClose={onClose} />
                    <ModalBody>
                        {(!transactions || transactions.length === 0) ? (
                            <p className="text-center text-slate-400 py-4">No transactions found.</p>
                        ) : (
                            <div className="overflow-x-auto">
                                <table className="min-w-full divide-y divide-slate-700">
                                    <thead className="bg-slate-900/50">
                                        <tr>
                                            <th className="px-4 py-2 text-left text-xs font-semibold text-slate-400 uppercase">Date</th>
                                            <th className="px-4 py-2 text-left text-xs font-semibold text-slate-400 uppercase">Type</th>
                                            <th className="px-4 py-2 text-right text-xs font-semibold text-slate-400 uppercase">Amount</th>
                                            <th className="px-4 py-2 text-left text-xs font-semibold text-slate-400 uppercase">Note</th>
                                        </tr>
                                    </thead>
                                    <tbody className="divide-y divide-slate-700">
                                        {transactions.map((tx) => (
                                            <tr key={tx.id} className="hover:bg-slate-700/30">
                                                <td className="px-4 py-2 text-sm text-slate-300">{Utils.formatRequestDate(tx.date)}</td>
                                                <td className="px-4 py-2 text-sm">
                                                    <span className={`px-2 py-0.5 text-xs rounded-full ${
                                                        tx.type === 'contribution' ? 'bg-green-900 text-green-300' : 'bg-red-900 text-red-300'
                                                    }`}>
                                                        {tx.type === 'contribution' ? 'Deposit' : 'Withdrawal'}
                                                    </span>
                                                </td>
                                                <td className={`px-4 py-2 text-sm text-right font-medium ${
                                                    tx.type === 'contribution' ? 'text-green-400' : 'text-red-400'
                                                }`}>
                                                    {Utils.formatCurrency(tx.amountDeducted || tx.amountWithdrawn)}
                                                </td>
                                                <td className="px-4 py-2 text-sm text-slate-400">{tx.note || tx.payrollId || '-'}</td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </div>
                        )}
                    </ModalBody>
                    <ModalFooter>
                        <Button variant="secondary" onClick={onClose}>Close</Button>
                    </ModalFooter>
                </Modal>
            );
        };

        // MOVED & RENAMED: from SalarySavingTab to ParticipantsTab
        // MODIFIED (STEP 4): This component is heavily refactored to use the new '/savingprogram' collection.
        const ParticipantsTab = ({ userProfile }) => {
            // MODIFIED: Added 'auth'
            const { db, auth } = useFirebase();
            // MODIFIED (STEP 4): Added setDoc and deleteField
            const { doc, updateDoc, where, setDoc, deleteField } = window.firebaseSDK;
            const { employees, shops } = useAppData();
            
            const [selectedShop, setSelectedShop] = useState('');
            const [searchTerm, setSearchTerm] = useState('');
            
            // --- NEW: State for the sub-tabs (Active vs Inactive) ---
            const [listTab, setListTab] = useState('active');

            // --- OPTIMIZATION: Only fetch the data needed for the current tab ---
            // If tab is 'active', fetch 'Active' and 'Paused'. 
            // If tab is 'inactive', fetch 'Inactive'.
            // This prevents downloading hundreds of old inactive records on page load.
            const savingsQueryConstraints = useMemo(() => {
                if (listTab === 'active') {
                    return [where('savingsProgramStatus', 'in', ['Active', 'Paused'])];
                } else {
                    return [where('savingsProgramStatus', '==', 'Inactive')];
                }
            }, [listTab]);

            // MODIFIED: Pass constraints to useCollection
            const { data: savingsList } = useCollection('savingprogram', savingsQueryConstraints);
            
            const [isSavingModalOpen, setIsSavingModalOpen] = useState(false);
            const [editingParticipant, setEditingParticipant] = useState(null);
            const [participantToRemove, setParticipantToRemove] = useState(null);
            const [paybackParticipant, setPaybackParticipant] = useState(null);
            const [depositParticipant, setDepositParticipant] = useState(null); // NEW: State for deposit modal
            const [historyParticipant, setHistoryParticipant] = useState(null);
            const [participantForPaybackConfirmation, setParticipantForPaybackConfirmation] = useState(null);

            // MODIFIED (STEP 6.B): Replaced 'useCollection' with a 'useEffect'
            // to listen to the new dynamic subcollection path.
            const [transactionHistory, setTransactionHistory] = useState([]);
            useEffect(() => {
                if (!db || !historyParticipant) {
                    setTransactionHistory([]);
                    return;
                }
                
                const { collection, onSnapshot, orderBy, query } = window.firebaseSDK;
                const collectionRef = collection(db, 'savingprogram', historyParticipant.id, 'transactions');
                const q = query(collectionRef, orderBy('date', 'desc')); // Order by date descending

                const unsubscribe = onSnapshot(q, (snapshot) => {
                    const history = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    setTransactionHistory(history);
                }, (error) => {
                    console.error("Error fetching transaction history:", error);
                    setTransactionHistory([]);
                });

                // Clean up the listener when the modal is closed or participant changes
                return () => unsubscribe();
            }, [db, historyParticipant]); // Re-run when the selected participant changes

            const handleOpenSavingModal = (participant = null) => {
                setEditingParticipant(participant);
                setIsSavingModalOpen(true);
            };

            const handleCloseSavingModal = () => {
                setEditingParticipant(null);
                setIsSavingModalOpen(false);
            };

            // MODIFIED (STEP 4): This function now writes to '/savingprogram' and cleans up '/employees'.
            // MODIFIED (Bug Fix): Added 'isEdit' flag to correctly initialize balance for new participants.
            // MODIFIED (User Request): Added 'status' parameter
            const handleSaveParticipant = async (employeeId, percentage, joinDate, effectiveMonth, isEdit, status) => {
                if (!employeeId || !db) return;
                
                // Find the employee to get their name and shop for denormalization
                const employee = employees.find(e => e.id === employeeId);
                if (!employee) {
                    alert("Could not find employee data.");
                    return;
                }
                
                try {
                    // 1. Set (or update) the document in the new '/savingprogram' collection
                    const savingsDocRef = doc(db, 'savingprogram', employeeId);
                    const newData = {
                        employeeId: employeeId,
                        employeeName: employee.name,
                        shop: Array.isArray(employee.shop) ? employee.shop[0] : employee.shop,
                        // MODIFIED (User Request): Use the passed-in status
                        savingsProgramStatus: status || 'Active',
                        savingsPercentage: percentage,
                        savingsJoinDate: joinDate,
                        savingsEffectiveMonth: effectiveMonth,
                        // Do not overwrite currentBalance if it's just an edit
                    };

                    // FIX: If this is a NEW participant (not an edit), initialize their balance to 0.
                    if (!isEdit) {
                        newData.currentBalance = 0;
                        newData.mySavingCredit = 0; // NEW: Initialize new credit field
                        newData.mySavingWithdrawalTotal = 0; // NEW: Initialize new withdrawal field
                    }

                    // Use { merge: true } to create or update without overwriting the balance
                    await setDoc(savingsDocRef, newData, { merge: true }); 

                    // 2. Remove the deprecated fields from the '/employees' document
                    const employeeRef = doc(db, 'employees', employeeId);
                    await updateDoc(employeeRef, {
                        savingsProgramStatus: deleteField(),
                        savingsPercentage: deleteField(),
                        savingsJoinDate: deleteField(),
                        savingsEffectiveMonth: deleteField()
                    });
                    
                    // --- NEW: Log the activity ---
                    const action = isEdit ? 'Edit Savings Participant' : 'Add Savings Participant';
                    // We don't have easy access to original data here, so we'll just log the new data.
                    Utils.logUserActivity(db, auth, action, {
                        id: employeeId,
                        name: employee.name,
                        updatedData: newData
                    });
                    // --- END LOGGING ---
                    
                    handleCloseSavingModal();
                } catch (error) {
                    console.error("Error saving participant:", error);
                    alert("Failed to save participant.");
                }
            };
            
            // MODIFIED (STEP 4): This function now updates the '/savingprogram' collection.
            const handleConfirmRemove = async () => {
                if (!participantToRemove || !db) return;
                try {
                    // Update the '/savingprogram' doc instead of the '/employees' doc
                    const savingsDocRef = doc(db, 'savingprogram', participantToRemove.id);
                    await updateDoc(savingsDocRef, {
                        savingsProgramStatus: 'Inactive',
                        savingsPercentage: 0
                    });

                    // --- NEW: Log the activity ---
                    Utils.logUserActivity(db, auth, 'Remove Savings Participant', {
                        id: participantToRemove.id,
                        name: participantToRemove.name,
                        originalData: participantToRemove,
                        updatedData: { ...participantToRemove, savingsProgramStatus: 'Inactive', savingsPercentage: 0 }
                    });
                    // --- END LOGGING ---

                    setParticipantToRemove(null);
                } catch (error) {
                    console.error("Error removing participant:", error);
                    alert("Failed to remove participant.");
                }
            };
            
            const handleStartPaybackProcess = () => {
                if (!participantForPaybackConfirmation) return;
                setPaybackParticipant(participantForPaybackConfirmation);
                setParticipantForPaybackConfirmation(null);
            };
            
            // MODIFIED (STEP 4): This function now passes the required 'employeeName' and 'shop'
            // to match the new signature of Utils.manageSavingsWithdrawal.
            const handleProcessPayback = async (employeeId, amount, note) => {
                if (!paybackParticipant) {
                    alert("Error: No participant selected for payback.");
                    return;
                }
                
                const participantShop = Array.isArray(paybackParticipant.shop) ? paybackParticipant.shop[0] : paybackParticipant.shop;
                
                const result = await Utils.manageSavingsWithdrawal(
                    db, 
                    employeeId, 
                    paybackParticipant.name, // Pass Employee Name
                    participantShop, // Pass Shop
                    amount, 
                    note
                );
                
                if (result.success) {
                    alert("Payback processed successfully!");
                    setPaybackParticipant(null);
                } else {
                    alert(`Payback failed: ${result.error?.message || 'An unknown error occurred.'}`);
                }
            };

            // --- NEW: Handler for processing cash deposits ---
            // MODIFIED: Accepts 'date' parameter
            const handleProcessDeposit = async (employeeId, amount, note, date) => {
                // SECURITY CHECK: Ensure only Admin or CEO can perform this action
                if (userProfile.role !== 'Admin' && userProfile.role !== 'CEO') {
                    alert("Permission Denied: Only Administrators and CEOs can process cash deposits.");
                    return false; // Return failure
                }

                if (!depositParticipant) {
                    alert("Error: No participant selected for deposit.");
                    return false; // Return failure
                }
                
                const participantShop = Array.isArray(depositParticipant.shop) ? depositParticipant.shop[0] : depositParticipant.shop;
                
                // Reuse the existing contribution utility, passing the note and null for payrollId
                // MODIFIED: Pass 'date'
                const result = await Utils.manageSavingsContribution(
                    db,
                    employeeId,
                    depositParticipant.name,
                    participantShop,
                    amount,
                    null, // No payrollId for manual deposit
                    note,  // Pass the note
                    date   // Pass the custom date
                );
                
                if (result.success) {
                    alert("Cash deposit processed successfully!");
                    setDepositParticipant(null);
                    return true; // Return success
                } else {
                    alert(`Deposit failed: ${result.error?.message || 'An unknown error occurred.'}`);
                    return false; // Return failure
                }
            };

            useEffect(() => {
                if (userProfile && userProfile.role !== 'Admin' && userProfile.role !== 'CEO') {
                    setSelectedShop(Array.isArray(userProfile.shop) ? '' : userProfile.shop || '');
                }
            }, [userProfile]);
            
            const availableShops = useMemo(() => {
                // FIX: Cleaned up logic and added guard for userProfile
                if (!userProfile) return [];
                if (userProfile.role === 'Admin' || userProfile.role === 'CEO') return shops;
                if (userProfile.role === 'Shop Manager' && Array.isArray(userProfile.shop)) {
                    // Manager with multiple shops can filter by their assigned shops
                    return shops.filter(s => userProfile.shop.includes(s.name));
                }
                // Manager with one shop, or staff, don't get a filter dropdown.
                return [];
            }, [shops, userProfile]);

            // MODIFIED (STEP 4): This logic is completely rebuilt to use '/savingprogram'
            // as the source of truth for participants.
            const enrolledEmployees = useMemo(() => {
                // 1. Create a map of all employees from context for quick lookup
                const employeeMap = new Map((employees || []).map(e => [e.id, e]));

                // 2. Map over 'savingsList' (fetched based on active tab) and merge with employee data
                const enrolled = (savingsList || []).map(savingDoc => {
                    const employeeData = employeeMap.get(savingDoc.id);
                    // Use employeeData if available, but fallback to denormalized data
                    // in savingDoc just in case (e.g., for a resigned employee).
                    return {
                        ...employeeData, // Full employee record (includes 'status', 'position', etc.)
                        ...savingDoc,   // Full savings record (overwrites with fresher savings data)
                        id: savingDoc.id, // Ensure savingDoc.id is primary
                        name: employeeData?.name || savingDoc.employeeName,
                        shop: employeeData?.shop || savingDoc.shop, // Use employee's current shop
                        savingsBalance: savingDoc.currentBalance || 0
                    };
                });

                // 3. Apply role-based filtering
                const roleFiltered = enrolled.filter(emp => {
                    if (!userProfile) return false;
                    
                    if (userProfile.role === 'Admin' || userProfile.role === 'CEO') {
                        return true; // Admins/CEOs see everyone
                    }
                    if (userProfile.role === 'Shop Manager') {
                        const managedShops = Array.isArray(userProfile.shop) ? userProfile.shop : (userProfile.shop ? [userProfile.shop] : []);
                        const employeeShops = Array.isArray(emp.shop) ? emp.shop : (emp.shop ? [emp.shop] : []);
                        return employeeShops.some(s => managedShops.includes(s));
                    }
                    if (userProfile.role === 'Staff') {
                        return emp.id === userProfile.id; // Staff only see themselves
                    }
                    return false; // Default deny
                });

                // 4. Apply the UI filters (selectedShop dropdown and search term)
                const filtered = roleFiltered.filter(emp => 
                    (!selectedShop || (Array.isArray(emp.shop) ? emp.shop.includes(selectedShop) : emp.shop === selectedShop)) &&
                    (emp.name.toLowerCase().includes(searchTerm.toLowerCase()))
                );
                
                return filtered.sort((a,b) => a.name.localeCompare(b.name));
            }, [employees, savingsList, selectedShop, searchTerm, userProfile]); 

            // --- NEW: Filter by Active/Inactive Tab ---
            // NOTE: The 'savingsList' is ALREADY filtered by the database query based on 'listTab'.
            // However, we keep this secondary check for robust filtering in case of latency.
            const displayEmployees = useMemo(() => {
                return enrolledEmployees.filter(emp => {
                    const status = emp.savingsProgramStatus || 'Active'; // Default to Active if undefined
                    if (listTab === 'active') {
                        // Show Active and Paused in the first tab
                        return status === 'Active' || status === 'Paused';
                    } else {
                        // Show Inactive in the second tab
                        return status === 'Inactive';
                    }
                });
            }, [enrolledEmployees, listTab]);

            // MODIFIED: Calculate total savings based on the DISPLAYED list, not the full list.
            const totalSavings = useMemo(() => {
                return displayEmployees.reduce((sum, emp) => sum + emp.savingsBalance, 0);
            }, [displayEmployees]);

            const handleExportExcel = useCallback(() => {
                // MODIFIED: Export only displayed employees
                const dataToExport = displayEmployees.map(emp => ({ 
                    'Name': emp.name,
                    'Shop': Array.isArray(emp.shop) ? emp.shop.join(', ') : emp.shop,
                    'Status': emp.savingsProgramStatus,
                    'Savings Percentage (%)': emp.savingsPercentage,
                    'Total Accumulated Savings (KHR)': emp.savingsBalance
                }));
                const worksheet = XLSX.utils.json_to_sheet(dataToExport);
                const workbook = XLSX.utils.book_new();
                const sheetName = listTab === 'active' ? "Active Savings" : "Inactive Savings";
                XLSX.utils.book_append_sheet(workbook, worksheet, sheetName);
                worksheet["!cols"] = [ { wch: 25 }, { wch: 20 }, { wch: 10 }, { wch: 25 }, { wch: 30 } ];
                XLSX.writeFile(workbook, `Salary_Savings_Report_${listTab}.xlsx`);
            }, [displayEmployees, listTab]);

            return (
                <Card>
                    {/* --- NEW: Tab Navigation for Active / Inactive Lists --- */}
                    <div className="flex space-x-6 border-b border-slate-700 mb-6">
                        <button
                            className={`pb-3 text-sm font-medium transition-colors border-b-2 ${
                                listTab === 'active' 
                                    ? 'border-blue-500 text-blue-400' 
                                    : 'border-transparent text-slate-400 hover:text-slate-200 hover:border-slate-600'
                            }`}
                            onClick={() => setListTab('active')}
                        >
                            Active Participants
                        </button>
                        <button
                            className={`pb-3 text-sm font-medium transition-colors border-b-2 ${
                                listTab === 'inactive' 
                                    ? 'border-blue-500 text-blue-400' 
                                    : 'border-transparent text-slate-400 hover:text-slate-200 hover:border-slate-600'
                            }`}
                            onClick={() => setListTab('inactive')}
                        >
                            Inactive / Removed
                        </button>
                    </div>

                    <div className="flex flex-wrap gap-4 justify-between items-center mb-6">
                        <h3 className="text-xl font-semibold text-slate-100">Salary Saving Program Participants</h3>
                        <div className="flex flex-wrap gap-4 items-center">
                            <input 
                                type="text" 
                                placeholder="Search by name..." 
                                value={searchTerm} 
                                onChange={e => setSearchTerm(e.target.value)} 
                                className="input w-full sm:w-auto" 
                            />
                            {(userProfile?.role === 'Admin' || userProfile?.role === 'CEO' || (userProfile?.role === 'Shop Manager' && Array.isArray(userProfile.shop))) && (
                                <select value={selectedShop} onChange={e => setSelectedShop(e.target.value)} className="select w-full sm:w-auto">
                                    <option value="">{userProfile.role === 'Admin' || userProfile.role === 'CEO' ? 'All Shops' : 'All My Shops'}</option>
                                    {availableShops.map(s => <option key={s.id} value={s.name}>{s.name}</option>)}
                                </select>
                            )}
                             {(userProfile?.role === 'Admin' || userProfile?.role === 'CEO' || userProfile?.role === 'Shop Manager') && (
                                <Button variant="primary" icon="fa-plus" onClick={() => handleOpenSavingModal()}>Add Participant</Button>
                            )}
                            <Button variant="success" icon="fa-file-excel" onClick={handleExportExcel}>Excel</Button>
                        </div>
                    </div>
                    <div className="overflow-x-auto">
                        <table className="min-w-full divide-y divide-slate-700">
                            <thead className="bg-slate-900/50">
                                <tr>
                                    <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Staff Name</th>
                                    <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Shop</th>
                                    <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Join Date</th>
                                    <th className="px-4 py-3 text-center text-xs font-semibold text-slate-400 uppercase">Savings Percentage</th>
                                    <th className="px-4 py-3 text-center text-xs font-semibold text-slate-400 uppercase">Effective Month</th>
                                    
                                    {/* NEW: Added Status column header */}
                                    <th className="px-4 py-3 text-center text-xs font-semibold text-slate-400 uppercase">Status</th>

                                    {/* MODIFIED: Removed 'My Saving Credit' to prevent duplication */}
                                    {/* <th className="px-4 py-3 text-right text-xs font-semibold text-slate-400 uppercase">My Saving Credit</th> */}
                                    
                                    {/* NEW: Added 'Total Withdrawals' for clarity */}
                                    <th className="px-4 py-3 text-right text-xs font-semibold text-slate-400 uppercase">Total Withdrawals</th>
                                    
                                    <th className="px-4 py-3 text-right text-xs font-semibold text-slate-400 uppercase">Total Accumulated Savings</th>
                                    {(userProfile?.role === 'Admin' || userProfile?.role === 'CEO' || userProfile?.role === 'Shop Manager') && (
                                        <th className="px-4 py-3 text-center text-xs font-semibold text-slate-400 uppercase">Actions</th>
                                    )}
                                </tr>
                            </thead>
                            <tbody className="divide-y divide-slate-700">
                                {/* MODIFIED: Map over displayEmployees instead of enrolledEmployees */}
                                {displayEmployees.map(emp => (
                                    <tr key={emp.id} className="hover:bg-slate-700/50">
                                        <td className="px-4 py-4 text-sm text-slate-200">{emp.name}</td>
                                        <td className="px-4 py-4 text-sm text-slate-300">{Array.isArray(emp.shop) ? emp.shop.join(', ') : emp.shop}</td>
                                        <td className="px-4 py-4 text-sm text-slate-300">{Utils.formatISOToDisplay(emp.savingsJoinDate)}</td>
                                        <td className="px-4 py-4 text-sm text-slate-300 text-center">{emp.savingsPercentage}%</td>
                                        <td className="px-4 py-4 text-sm text-slate-300 text-center">{emp.savingsEffectiveMonth}</td>
                                        
                                        {/* NEW: Added Status column data cell */}
                                        <td className="px-4 py-4 text-center text-sm">
                                            <span className={`px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${
                                                emp.savingsProgramStatus === 'Active' ? 'bg-green-100 text-green-800' :
                                                emp.savingsProgramStatus === 'Paused' ? 'bg-yellow-100 text-yellow-800' :
                                                'bg-slate-100 text-slate-800'
                                            }`}>
                                                {emp.savingsProgramStatus || 'N/A'}
                                            </span>
                                        </td>
                                        
                                        {/* NEW: Added 'Total Withdrawals' column data */}
                                        <td className="px-4 py-4 text-sm text-red-300 font-semibold text-right">{Utils.formatCurrency(emp.mySavingWithdrawalTotal)}</td>
                                        
                                        <td className="px-4 py-4 text-sm text-blue-300 font-semibold text-right">{Utils.formatCurrency(emp.savingsBalance)}</td>
                                        {(userProfile?.role === 'Admin' || userProfile?.role === 'CEO' || userProfile?.role === 'Shop Manager') && (
                                            <td className="px-4 py-4 text-center">
                                                <div className="flex items-center justify-center gap-2">
                                                    <Button variant="icon-view" icon="fa-history" onClick={() => setHistoryParticipant(emp)} title="View History"/>
                                                    
                                                    {/* NEW: Add Deposit Button for Cash on Hand - RESTRICTED TO ADMIN/CEO AND ACTIVE/PAUSED STATUS ONLY */}
                                                    {(userProfile?.role === 'Admin' || userProfile?.role === 'CEO') && emp.savingsProgramStatus !== 'Inactive' && (
                                                        <Button variant="icon-approve" icon="fa-circle-plus" onClick={() => setDepositParticipant(emp)} title="Deposit Cash" />
                                                    )}

                                                    {/* MODIFIED: Allow Payback for Active/Paused users ONLY. Hidden for Inactive/Removed. */}
                                                    {(userProfile?.role === 'Admin' || userProfile?.role === 'CEO') && emp.savingsProgramStatus !== 'Inactive' && (
                                                        <Button variant="icon-edit-alt" icon="fa-hand-holding-dollar" onClick={() => setParticipantForPaybackConfirmation(emp)} title="Process Payback" />
                                                    )}
                                                    
                                                    <Button variant="icon-edit" icon="fa-edit" onClick={() => handleOpenSavingModal(emp)} title="Edit Percentage"/>
                                                    
                                                    {/* MODIFIED: Show 'Remove' button only if status is NOT 'Inactive' */}
                                                    {(userProfile?.role === 'Admin' || userProfile?.role === 'CEO') && emp.savingsProgramStatus !== 'Inactive' && (
                                                        <Button variant="icon-delete" icon="fa-user-minus" onClick={() => setParticipantToRemove(emp)} title="Remove from Program"/>
                                                    )}
                                                </div>
                                            </td>
                                        )}
                                    </tr>
                                ))}
                                {displayEmployees.length === 0 && (
                                    <tr>
                                        <td colSpan="9" className="px-4 py-8 text-center text-slate-500">
                                            No {listTab} participants found.
                                        </td>
                                    </tr>
                                )}
                            </tbody>
                            <tfoot className="bg-slate-900/50">
                                <tr>
                                    {/* MODIFIED: Dynamic ColSpan based on visible columns */}
                                    <td colSpan={userProfile?.role === 'Admin' || userProfile?.role === 'CEO' || userProfile?.role === 'Shop Manager' ? 7 : 6} className="px-4 py-3 text-right font-bold text-slate-300 uppercase">Total Savings ({listTab === 'active' ? 'Active' : 'Inactive'})</td>
                                    <td className="px-4 py-3 text-right font-bold text-blue-300">{Utils.formatCurrency(totalSavings)}</td>
                                    {(userProfile?.role === 'Admin' || userProfile?.role === 'CEO' || userProfile?.role === 'Shop Manager') && <td></td>}
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                    <AddSalarySavingModal
                        isOpen={isSavingModalOpen}
                        onClose={handleCloseSavingModal}
                        onSave={handleSaveParticipant}
                        participant={editingParticipant}
                        userProfile={userProfile}
                        allEmployees={employees}
                        allSavings={savingsList} // MODIFIED (STEP 4): Pass 'savingsList' data
                    />
                    <ConfirmationModal 
                        isOpen={!!participantToRemove}
                        onClose={() => setParticipantToRemove(null)}
                        onConfirm={handleConfirmRemove}
                        title="Remove from Program"
                        message={`Are you sure you want to remove ${participantToRemove?.name} from the Salary Saving Program? This action will set their status to Inactive.`}
                    />
                    <ConfirmationModal
                        isOpen={!!participantForPaybackConfirmation}
                        onClose={() => setParticipantForPaybackConfirmation(null)}
                        onConfirm={handleStartPaybackProcess}
                        title="Confirm Payback"
                        message={`Are you sure you want to start the payback process for ${participantForPaybackConfirmation?.name}?`}
                    />
                    <PaybackModal
                        isOpen={!!paybackParticipant}
                        onClose={() => setPaybackParticipant(null)}
                        onSave={handleProcessPayback}
                        participant={paybackParticipant}
                    />
                    {/* NEW: Render the Deposit Modal */}
                    <DepositModal
                        isOpen={!!depositParticipant}
                        onClose={() => setDepositParticipant(null)}
                        onSave={handleProcessDeposit}
                        participant={depositParticipant}
                    />
                    <SavingsHistoryModal
                        isOpen={!!historyParticipant}
                        onClose={() => setHistoryParticipant(null)}
                        employeeName={historyParticipant?.name}
                        transactions={transactionHistory}
                    />
                </Card>
            );
        };

        // MOVED: Savings History Tab
        // MODIFIED (STEP 6.C): Refactored to extract and display the Index Creation Link automatically.
        const SavingsHistoryTab = ({ userProfile }) => {
            const { db } = useFirebase();
            const { shops } = useAppData(); 
            
            const [transactions, setTransactions] = useState([]);
            const [loading, setLoading] = useState(true);
            const [errorMsg, setErrorMsg] = useState('');
            const [indexLink, setIndexLink] = useState(null); // NEW: State to hold the creation link
            const [retryTrigger, setRetryTrigger] = useState(0);

            const [selectedShop, setSelectedShop] = useState('');
            const [selectedMonth, setSelectedMonth] = useState(new Date().toISOString().slice(0, 7));
            const [searchTerm, setSearchTerm] = useState('');

            useEffect(() => {
                if (!db || !userProfile) return;

                setLoading(true);
                setErrorMsg('');
                setIndexLink(null); // Reset link

                const { collectionGroup, query, where, onSnapshot, orderBy } = window.firebaseSDK;
                
                let q = query(collectionGroup(db, 'transactions'), orderBy('date', 'desc'));
                
                if (selectedMonth) {
                    const [y, m] = selectedMonth.split('-').map(Number);
                    const startOfMonth = new Date(y, m - 1, 1);
                    const endOfMonth = new Date(y, m, 0, 23, 59, 59, 999);
                    q = query(q, where('date', '>=', startOfMonth), where('date', '<=', endOfMonth));
                }

                if (userProfile.role === 'Shop Manager') {
                    const managedShops = Array.isArray(userProfile.shop) ? userProfile.shop : (userProfile.shop ? [userProfile.shop] : []);
                    if (managedShops.length > 0) {
                        q = query(q, where("shop", "in", managedShops));
                    } else {
                        q = query(q, where("shop", "==", "null"));
                    }
                } else if (userProfile.role === 'Staff') {
                    q = query(q, where("employeeId", "==", userProfile.id));
                }

                const unsubscribe = onSnapshot(q, (snapshot) => {
                    const txs = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    setTransactions(txs);
                    setLoading(false);
                }, (error) => {
                    console.error("Savings History Error:", error);
                    if (error.code === 'failed-precondition') {
                        setErrorMsg("Database Index Required");
                        // NEW: Extract the URL from the error message
                        const match = error.message.match(/https:\/\/console\.firebase\.google\.com[^\s]+/);
                        if (match) {
                            setIndexLink(match[0]);
                        }
                    } else {
                        setErrorMsg(error.message);
                    }
                    setTransactions([]);
                    setLoading(false);
                });

                return () => unsubscribe();
                
            }, [db, userProfile, selectedMonth, retryTrigger]);

            useEffect(() => {
                if (userProfile && userProfile.role !== 'Admin' && userProfile.role !== 'CEO') {
                    setSelectedShop(Array.isArray(userProfile.shop) ? '' : userProfile.shop || '');
                }
            }, [userProfile]);
            
            const availableShops = useMemo(() => {
                if (userProfile?.role === 'Admin' || userProfile?.role === 'CEO') return shops;
                if (userProfile?.role === 'Shop Manager' && Array.isArray(userProfile.shop)) {
                    return shops.filter(s => userProfile.shop.includes(s.name));
                }
                return [];
            }, [shops, userProfile]);

            const { processedTransactions, totals } = useMemo(() => {
                const filtered = transactions.filter(tx => {
                    const shopMatch = !selectedShop || tx.shop === selectedShop;
                    const searchMatch = !searchTerm || (tx.staffName && tx.staffName.toLowerCase().includes(searchTerm.toLowerCase()));
                    return shopMatch && searchMatch;
                });
                
                const totals = filtered.reduce((acc, tx) => {
                    if (tx.type === 'contribution') {
                        acc.totalContributions += tx.amountDeducted || 0;
                    } else if (tx.type === 'withdrawal') {
                        acc.totalWithdrawals += tx.amountWithdrawn || 0;
                    }
                    return acc;
                }, { totalContributions: 0, totalWithdrawals: 0 });

                return { processedTransactions: filtered, totals };
            }, [transactions, selectedShop, searchTerm]); 

            const handleExportExcel = useCallback(() => {
                const dataToExport = processedTransactions.map(tx => ({ 
                    'Date': Utils.formatRequestDate(tx.date),
                    'Staff Name': tx.staffName,
                    'Shop': tx.shop,
                    'Type': tx.type,
                    'Amount (KHR)': tx.amountDeducted || tx.amountWithdrawn,
                    'Note / Payroll ID': tx.payrollId || tx.note || '-'
                }));
                const worksheet = XLSX.utils.json_to_sheet(dataToExport);
                const workbook = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(workbook, worksheet, "Savings History");
                worksheet["!cols"] = [ { wch: 20 }, { wch: 25 }, { wch: 20 }, { wch: 15 }, { wch: 20 }, { wch: 30 } ];
                XLSX.writeFile(workbook, `Savings_History_${selectedMonth}.xlsx`);
            }, [processedTransactions, selectedMonth]);

            return (
                <Card>
                    <div className="flex flex-wrap gap-4 justify-between items-center mb-6">
                        <h3 className="text-xl font-semibold text-slate-100">Savings Transaction History</h3>
                        <div className="flex flex-wrap gap-4 items-center">
                            <input type="text" placeholder="Search by name..." value={searchTerm} onChange={e => setSearchTerm(e.target.value)} className="input w-full sm:w-auto" />
                             {(userProfile?.role === 'Admin' || userProfile?.role === 'CEO' || (userProfile?.role === 'Shop Manager' && Array.isArray(userProfile.shop))) && (
                                <select value={selectedShop} onChange={e => setSelectedShop(e.target.value)} className="select w-full sm:w-auto">
                                    <option value="">{userProfile.role === 'Admin' || userProfile.role === 'CEO' ? 'All Shops' : 'All My Shops'}</option>
                                    {availableShops.map(s => <option key={s.id} value={s.name}>{s.name}</option>)}
                                </select>
                            )}
                            <input type="month" value={selectedMonth} onChange={e => setSelectedMonth(e.target.value)} className="input w-full sm:w-auto" />
                            <Button variant="success" icon="fa-file-excel" onClick={handleExportExcel}>Excel</Button>
                        </div>
                    </div>
                    
                    {/* NEW: Smart Error Message with Direct Action Button */}
                    {errorMsg && (
                        <div className="mb-6 p-4 bg-red-900/30 border border-red-500/50 rounded-lg text-red-200 flex flex-col items-center justify-center gap-4 text-center">
                            <div>
                                <p className="font-bold text-lg flex items-center justify-center"><i className="fas fa-database mr-2 text-yellow-400"></i> {errorMsg}</p>
                                {indexLink ? (
                                    <p className="text-sm mt-2 opacity-90 max-w-lg">
                                        Firebase requires a specialized index to search across all employee folders. 
                                        Click the button below to create it instantly.
                                    </p>
                                ) : (
                                    <p className="text-sm mt-2 opacity-90">Open console (F12) to see details.</p>
                                )}
                            </div>
                            <div className="flex gap-4">
                                {indexLink && (
                                    <a 
                                        href={indexLink} 
                                        target="_blank" 
                                        rel="noopener noreferrer" 
                                        className="bg-yellow-600 hover:bg-yellow-500 text-white font-bold py-2 px-6 rounded-lg shadow-lg flex items-center transition-transform transform hover:scale-105"
                                    >
                                        <i className="fas fa-hammer mr-2"></i> Create Missing Index
                                    </a>
                                )}
                                <Button variant="secondary" onClick={() => setRetryTrigger(prev => prev + 1)} icon="fa-sync">
                                    Retry Connection
                                </Button>
                            </div>
                        </div>
                    )}

                     {loading ? (
                        <div className="text-center py-10"><i className="fas fa-spinner fa-spin text-3xl text-blue-400"></i></div>
                    ) : (
                    <div className="overflow-x-auto">
                        <table className="min-w-full divide-y divide-slate-700">
                            <thead className="bg-slate-900/50">
                                <tr>
                                    <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Date</th>
                                    <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Staff Name</th>
                                    <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Shop</th>
                                    <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Type</th>
                                    <th className="px-4 py-3 text-right text-xs font-semibold text-slate-400 uppercase">Amount</th>
                                    <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Note / Payroll ID</th>
                                </tr>
                            </thead>
                            <tbody className="divide-y divide-slate-700">
                                {processedTransactions.length === 0 ? (
                                    <tr><td colSpan="6" className="px-4 py-8 text-center text-slate-500">No transactions found for this month.</td></tr>
                                ) : (
                                    processedTransactions.map(tx => (
                                        <tr key={tx.id} className="hover:bg-slate-700/50">
                                            <td className="px-4 py-4 text-sm text-slate-300 whitespace-nowrap">{Utils.formatRequestDate(tx.date)}</td>
                                            <td className="px-4 py-4 text-sm text-slate-200">{tx.staffName}</td>
                                            <td className="px-4 py-4 text-sm text-slate-300">{tx.shop}</td>
                                            <td className="px-4 py-4 text-sm font-semibold">
                                                {tx.type === 'contribution' ? (
                                                    <span className="text-green-400">Contribution</span>
                                                ) : (
                                                    <span className="text-red-400">Withdrawal</span>
                                                )}
                                            </td>
                                            <td className={`px-4 py-4 text-sm text-right font-semibold ${tx.type === 'contribution' ? 'text-green-400' : 'text-red-400'}`}>
                                                {Utils.formatCurrency(tx.amountDeducted || tx.amountWithdrawn)}
                                            </td>
                                            <td className="px-4 py-4 text-sm text-slate-400">{tx.payrollId || tx.note || '-'}</td>
                                        </tr>
                                    ))
                                )}
                            </tbody>
                            <tfoot className="bg-slate-900/50">
                                <tr>
                                    <td colSpan="4" className="px-4 py-3 text-right font-bold text-green-400 uppercase">Total Contributions</td>
                                    <td className="px-4 py-3 text-right font-bold text-green-400">{Utils.formatCurrency(totals.totalContributions)}</td>
                                    <td></td>
                                </tr>
                                <tr>
                                    <td colSpan="4" className="px-4 py-3 text-right font-bold text-red-400 uppercase">Total Withdrawals</td>
                                    <td className="px-4 py-3 text-right font-bold text-red-400">{Utils.formatCurrency(totals.totalWithdrawals)}</td>
                                    <td></td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                    )}
                </Card>
            );
        };

        // --- NEW: Deposit Cash Report Tab (Updated with Index Link Logic) ---
        const DepositCashReportTab = ({ userProfile }) => {
            const { db } = useFirebase();
            const { shops } = useAppData();
            
            const [transactions, setTransactions] = useState([]);
            const [loading, setLoading] = useState(true);
            const [errorMsg, setErrorMsg] = useState('');
            const [indexLink, setIndexLink] = useState(null); // NEW
            const [retryTrigger, setRetryTrigger] = useState(0);

            const [selectedShop, setSelectedShop] = useState('');
            const [selectedMonth, setSelectedMonth] = useState(new Date().toISOString().slice(0, 7));
            const [searchTerm, setSearchTerm] = useState('');

            useEffect(() => {
                if (!db || !userProfile) return;

                setLoading(true);
                setErrorMsg('');
                setIndexLink(null);
                const { collectionGroup, query, where, onSnapshot, orderBy } = window.firebaseSDK;
                
                let q = query(collectionGroup(db, 'transactions'), orderBy('date', 'desc'));
                
                if (selectedMonth) {
                    const [y, m] = selectedMonth.split('-').map(Number);
                    const startOfMonth = new Date(y, m - 1, 1);
                    const endOfMonth = new Date(y, m, 0, 23, 59, 59, 999);
                    q = query(q, where('date', '>=', startOfMonth), where('date', '<=', endOfMonth));
                }

                if (userProfile.role === 'Shop Manager') {
                    const managedShops = Array.isArray(userProfile.shop) ? userProfile.shop : (userProfile.shop ? [userProfile.shop] : []);
                    if (managedShops.length > 0) {
                        q = query(q, where("shop", "in", managedShops));
                    } else {
                        q = query(q, where("shop", "==", "null")); 
                    }
                } else if (userProfile.role === 'Staff') {
                    q = query(q, where("employeeId", "==", userProfile.id));
                }

                const unsubscribe = onSnapshot(q, (snapshot) => {
                    const txs = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    setTransactions(txs);
                    setLoading(false);
                }, (error) => {
                    console.error("Deposit Report Error:", error);
                    if (error.code === 'failed-precondition') {
                        setErrorMsg("Database Index Required");
                        const match = error.message.match(/https:\/\/console\.firebase\.google\.com[^\s]+/);
                        if (match) {
                            setIndexLink(match[0]);
                        }
                    } else {
                        setErrorMsg(error.message);
                    }
                    setTransactions([]);
                    setLoading(false);
                });

                return () => unsubscribe();
            }, [db, userProfile, selectedMonth, retryTrigger]);

            useEffect(() => {
                if (userProfile && userProfile.role !== 'Admin' && userProfile.role !== 'CEO') {
                    setSelectedShop(Array.isArray(userProfile.shop) ? '' : userProfile.shop || '');
                }
            }, [userProfile]);
            
            const availableShops = useMemo(() => {
                if (userProfile?.role === 'Admin' || userProfile?.role === 'CEO') return shops;
                if (userProfile?.role === 'Shop Manager' && Array.isArray(userProfile.shop)) {
                    return shops.filter(s => userProfile.shop.includes(s.name));
                }
                return [];
            }, [shops, userProfile]);

            const { depositTransactions, totalDeposits } = useMemo(() => {
                const filtered = transactions.filter(tx => {
                    const shopMatch = !selectedShop || tx.shop === selectedShop;
                    const searchMatch = !searchTerm || (tx.staffName && tx.staffName.toLowerCase().includes(searchTerm.toLowerCase()));
                    const isCashDeposit = tx.type === 'contribution' && !tx.payrollId;
                    return shopMatch && searchMatch && isCashDeposit;
                });
                
                const total = filtered.reduce((sum, tx) => sum + (tx.amountDeducted || 0), 0);
                return { depositTransactions: filtered, totalDeposits: total };
            }, [transactions, selectedShop, searchTerm]);

            const handleExportExcel = useCallback(() => {
                const dataToExport = depositTransactions.map(tx => ({ 
                    'Date': Utils.formatRequestDate(tx.date),
                    'Staff Name': tx.staffName,
                    'Shop': tx.shop,
                    'Amount (KHR)': tx.amountDeducted,
                    'Note': tx.note || 'Manual Cash Deposit'
                }));
                const worksheet = XLSX.utils.json_to_sheet(dataToExport);
                const workbook = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(workbook, worksheet, "Cash Deposits");
                worksheet["!cols"] = [ { wch: 20 }, { wch: 25 }, { wch: 20 }, { wch: 15 }, { wch: 30 } ];
                XLSX.writeFile(workbook, `Cash_Deposit_Report_${selectedMonth}.xlsx`);
            }, [depositTransactions, selectedMonth]);

            return (
                <Card>
                    <div className="flex flex-wrap gap-4 justify-between items-center mb-6">
                        <h3 className="text-xl font-semibold text-slate-100">Deposit Cash Report</h3>
                        <div className="flex flex-wrap gap-4 items-center">
                            <input type="text" placeholder="Search by name..." value={searchTerm} onChange={e => setSearchTerm(e.target.value)} className="input w-full sm:w-auto" />
                             {(userProfile?.role === 'Admin' || userProfile?.role === 'CEO' || (userProfile?.role === 'Shop Manager' && Array.isArray(userProfile.shop))) && (
                                <select value={selectedShop} onChange={e => setSelectedShop(e.target.value)} className="select w-full sm:w-auto">
                                    <option value="">{userProfile.role === 'Admin' || userProfile.role === 'CEO' ? 'All Shops' : 'All My Shops'}</option>
                                    {availableShops.map(s => <option key={s.id} value={s.name}>{s.name}</option>)}
                                </select>
                            )}
                            <input type="month" value={selectedMonth} onChange={e => setSelectedMonth(e.target.value)} className="input w-full sm:w-auto" />
                            <Button variant="success" icon="fa-file-excel" onClick={handleExportExcel}>Excel</Button>
                        </div>
                    </div>

                    {errorMsg && (
                        <div className="mb-6 p-4 bg-red-900/30 border border-red-500/50 rounded-lg text-red-200 flex flex-col items-center justify-center gap-4 text-center">
                            <div>
                                <p className="font-bold text-lg flex items-center justify-center"><i className="fas fa-database mr-2 text-yellow-400"></i> {errorMsg}</p>
                                {indexLink ? (
                                    <p className="text-sm mt-2 opacity-90 max-w-lg">
                                        Firebase requires a specialized index for this report.
                                    </p>
                                ) : (
                                    <p className="text-sm mt-2 opacity-90">Open console (F12) to see details.</p>
                                )}
                            </div>
                            <div className="flex gap-4">
                                {indexLink && (
                                    <a 
                                        href={indexLink} 
                                        target="_blank" 
                                        rel="noopener noreferrer" 
                                        className="bg-yellow-600 hover:bg-yellow-500 text-white font-bold py-2 px-6 rounded-lg shadow-lg flex items-center transition-transform transform hover:scale-105"
                                    >
                                        <i className="fas fa-hammer mr-2"></i> Create Missing Index
                                    </a>
                                )}
                                <Button variant="secondary" onClick={() => setRetryTrigger(prev => prev + 1)} icon="fa-sync">
                                    Retry Connection
                                </Button>
                            </div>
                        </div>
                    )}

                     {loading ? (
                        <div className="text-center py-10"><i className="fas fa-spinner fa-spin text-3xl text-blue-400"></i></div>
                    ) : (
                    <div className="overflow-x-auto">
                        <table className="min-w-full divide-y divide-slate-700">
                            <thead className="bg-slate-900/50">
                                <tr>
                                    <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Date</th>
                                    <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Staff Name</th>
                                    <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Shop</th>
                                    <th className="px-4 py-3 text-right text-xs font-semibold text-slate-400 uppercase">Amount</th>
                                    <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Note</th>
                                </tr>
                            </thead>
                            <tbody className="divide-y divide-slate-700">
                                {depositTransactions.length === 0 ? (
                                    <tr><td colSpan="5" className="px-4 py-8 text-center text-slate-500">No cash deposits found for this period.</td></tr>
                                ) : (
                                    depositTransactions.map(tx => (
                                        <tr key={tx.id} className="hover:bg-slate-700/50">
                                            <td className="px-4 py-4 text-sm text-slate-300 whitespace-nowrap">{Utils.formatRequestDate(tx.date)}</td>
                                            <td className="px-4 py-4 text-sm text-slate-200">{tx.staffName}</td>
                                            <td className="px-4 py-4 text-sm text-slate-300">{tx.shop}</td>
                                            <td className="px-4 py-4 text-sm text-right font-semibold text-green-400">
                                                {Utils.formatCurrency(tx.amountDeducted)}
                                            </td>
                                            <td className="px-4 py-4 text-sm text-slate-400">{tx.note || 'Manual Cash Deposit'}</td>
                                        </tr>
                                    ))
                                )}
                            </tbody>
                            <tfoot className="bg-slate-900/50">
                                <tr>
                                    <td colSpan="3" className="px-4 py-3 text-right font-bold text-green-400 uppercase">Total Cash Deposits</td>
                                    <td className="px-4 py-3 text-right font-bold text-green-400">{Utils.formatCurrency(totalDeposits)}</td>
                                    <td></td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                    )}
                </Card>
            );
        };
        
        // NEW: Main Savings Program Page (Tab Container)
        const SavingsProgramPage = ({ userProfile }) => {
            // MODIFIED: Re-introduced TabbedPage to include the new report tab
            const [activeTab, setActiveTab] = useState('participants');
            
            const tabs = {
                participants: <span><i className="fas fa-users mr-2 text-blue-400"></i>Participants</span>,
                history: <span><i className="fas fa-history mr-2 text-orange-400"></i>Transaction History</span>,
                depositReport: <span><i className="fas fa-file-invoice mr-2 text-green-400"></i>Deposit Cash Report</span>
            };

            return (
                <TabbedPage tabs={tabs} activeTab={activeTab} setActiveTab={setActiveTab}>
                    <div id="participants"><ParticipantsTab userProfile={userProfile} /></div>
                    <div id="history"><SavingsHistoryTab userProfile={userProfile} /></div>
                    <div id="depositReport"><DepositCashReportTab userProfile={userProfile} /></div>
                </TabbedPage>
            );
        };
        // --- END SAVINGS PROGRAM PAGE COMPONENTS ---

        // --- START HR BANKING PAGE (RESTORED) ---
        const HRBankingPage = ({ userProfile }) => {
            const [activeTab, setActiveTab] = useState('loans');

            const tabs = {
                loans: <span><i className="fas fa-landmark mr-2 text-blue-400"></i>Loan Manager</span>,
                savings: <span><i className="fas fa-piggy-bank mr-2 text-green-400"></i>Savings Program</span>
            };

            return (
                <TabbedPage tabs={tabs} activeTab={activeTab} setActiveTab={setActiveTab}>
                    <div id="loans"><LoanManagerPage userProfile={userProfile} /></div>
                    <div id="savings"><SavingsProgramPage userProfile={userProfile} /></div>
                </TabbedPage>
            );
        };
        // --- END HR BANKING PAGE ---

        // --- START CHECKINME PAGE COMPONENTS ---

        // Component: Check In / Out Tab
        const CheckInOutTab = ({ userProfile }) => {
            const { db } = useFirebase();
            const [currentTime, setCurrentTime] = useState(new Date());
            const [location, setLocation] = useState(null);
            const [accuracy, setAccuracy] = useState(null); // NEW: State for location accuracy
            const [status, setStatus] = useState('Ready to verify location.');
            const [loading, setLoading] = useState(false);
            const [distance, setDistance] = useState(null);
            const [selectedShopForCheckIn, setSelectedShopForCheckIn] = useState('');
            const [alertModal, setAlertModal] = useState({ isOpen: false, message: '' }); 
            const [savingsData, setSavingsData] = useState(null); 
            
            const [savingsWithdrawals, setSavingsWithdrawals] = useState([]);

            // NEW: Step 1 States for QR Mode
            const [checkInMethod, setCheckInMethod] = useState('gps'); // 'gps' or 'qr'
            const [isScannerOpen, setIsScannerOpen] = useState(false);
            
            const [selectedMonth, setSelectedMonth] = useState(() => {
                const now = new Date();
                const year = now.getFullYear();
                const month = String(now.getMonth() + 1).padStart(2, '0');
                return `${year}-${month}`;
            });

            const { where } = window.firebaseSDK;
            const { shops, shifts } = useAppData();

            const staffQueryConstraints = useMemo(() => userProfile?.id ? [where("staffId", "==", userProfile.id)] : [], [userProfile?.id]);
            const attendanceQueryConstraints = useMemo(() => userProfile?.id ? [where("employeeId", "==", userProfile.id)] : [], [userProfile?.id]);

            const allData = {
                shops: shops,
                attendance: useCollection('attendance', attendanceQueryConstraints).data,
                leaveRequests: useCollection('leaveRequests', staffQueryConstraints).data,
                otRequests: useCollection('otRequests', staffQueryConstraints).data,
                staffLoans: useCollection('staffLoans', staffQueryConstraints).data,
                employeeStates: useCollection('employeeStates', staffQueryConstraints).data,
                salaryRevisions: useCollection('salaryRevisions', staffQueryConstraints).data,
                shifts: shifts,
            };
            
            useEffect(() => {
                if (!db || !userProfile?.id) return;
                const { doc, onSnapshot } = window.firebaseSDK;
                const savingsDocRef = doc(db, 'savingprogram', userProfile.id);

                const unsubscribe = onSnapshot(savingsDocRef, (doc) => {
                    if (doc.exists()) {
                        setSavingsData(doc.data());
                    } else {
                        setSavingsData(null);
                    }
                }, (error) => { 
                    console.error("Error fetching savings balance:", error); 
                    setSavingsData(null); 
                });
                return () => unsubscribe();
            }, [db, userProfile?.id]);
            
            useEffect(() => {
                if (!db || !userProfile?.id || !selectedMonth) {
                    setSavingsWithdrawals([]);
                    return;
                }

                const fetchWithdrawals = async () => {
                    try {
                        const { collection, query, where, getDocs } = window.firebaseSDK;
                        const [year, month] = selectedMonth.split('-').map(Number);
                        const startDate = new Date(year, month - 1, 1);
                        const endDate = new Date(year, month, 0, 23, 59, 59, 999); 

                        const q = query(
                            collection(db, 'savingprogram', userProfile.id, 'transactions'),
                            where("date", ">=", startDate),
                            where("date", "<=", endDate)
                        );
                        
                        const querySnapshot = await getDocs(q);
                        const withdrawals = querySnapshot.docs
                            .map(doc => ({ id: doc.id, ...doc.data() }))
                            .filter(tx => tx.type === 'withdrawal');
                        setSavingsWithdrawals(withdrawals);
                    } catch (error) {
                        console.error("Error fetching savings withdrawals for preview:", error);
                        setSavingsWithdrawals([]);
                    }
                };

                fetchWithdrawals();
            }, [db, userProfile?.id, selectedMonth]);
            
            const isMultiShopManager = userProfile.role === 'Shop Manager' && Array.isArray(userProfile.shop);

            useEffect(() => {
                if (!isMultiShopManager) {
                    setSelectedShopForCheckIn(userProfile.shop);
                }
            }, [userProfile, isMultiShopManager]);

            const userShop = useMemo(() => {
                if (!selectedShopForCheckIn) return null;
                return allData.shops.find(s => s.name === selectedShopForCheckIn);
            }, [selectedShopForCheckIn, allData.shops]);

            const todayInShopTimezone = useMemo(() => {
                if (!userShop?.timezone) {
                    const now = new Date();
                    const year = now.getFullYear();
                    const month = String(now.getMonth() + 1).padStart(2, '0');
                    const day = String(now.getDate()).padStart(2, '0');
                    return `${year}-${month}-${day}`;
                }
                return Utils.formatDateInTimezone({ toDate: () => new Date() }, userShop.timezone).localDate;
            }, [userShop]);

            const userAttendanceToday = useMemo(() => {
                return (allData.attendance || [])
                    .filter(a => {
                        if (a.employeeId !== userProfile.id) return false;
                        const { localDate: recordDate } = Utils.formatDateInTimezone(a.timestamp, userShop?.timezone);
                        return recordDate === todayInShopTimezone;
                    })
                    .sort((a, b) => (b.timestamp?.toDate() || 0) - (a.timestamp?.toDate() || 0));
            }, [userProfile, allData.attendance, userShop, todayInShopTimezone]);
            
            const lastAction = userAttendanceToday[0] || null;

            useEffect(() => { const timerId = setInterval(() => setCurrentTime(new Date()), 1000); return () => clearInterval(timerId); }, []);
            
            const getLocation = useCallback((isCheckAction = false) => {
                if (!userShop && checkInMethod === 'gps') { 
                    setStatus(isMultiShopManager ? "Select a shop." : "Shop not found."); 
                    setLoading(false);
                    return Promise.reject("No user shop selected"); 
                }
                
                setStatus("Locating...");
                setLoading(true);

                return new Promise((resolve, reject) => {
                    navigator.geolocation.getCurrentPosition(
                        (position) => {
                            const { latitude, longitude, accuracy: posAccuracy } = position.coords;
                            const newLocation = { latitude, longitude };
                            setLocation(newLocation);
                            setAccuracy(posAccuracy);
                            
                            let dist = 0;
                            if (userShop) {
                                dist = Utils.getDistance(latitude, longitude, parseFloat(userShop.latitude), parseFloat(userShop.longitude));
                                setDistance(dist);
                                
                                const radius = parseFloat(userShop.radius) || 500;
                                const isInRange = dist <= radius;
                                
                                if (!isCheckAction) {
                                    setStatus(isInRange 
                                        ? "You are in range."
                                        : "You are too far."
                                    );
                                }
                            }
                            
                            setLoading(false);
                            resolve({ location: newLocation, distance: dist, shop: userShop });
                        },
                        (error) => {
                            setStatus(error.code === 1 ? "Permission denied." : "Location unavailable."); 
                            setLoading(false);
                            reject(error);
                        }, 
                        { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
                    );
                });
            }, [userShop, isMultiShopManager, checkInMethod]);

            // ... (keep handleScanSuccess and handleCheckAction exactly as they were) ...
            // [Abbreviated to save space, assuming they are unchanged from previous full context]
            const handleScanSuccess = async (qrText) => {
                setIsScannerOpen(false);
                setLoading(true);
                setStatus("Verifying QR...");
                try {
                    const { location: gpsLocation } = await getLocation(true);
                    const scannedShop = allData.shops.find(s => s.name === qrText);
                    if (!scannedShop) { alert("Invalid QR Code."); setLoading(false); return; }
                    
                    const userShops = Array.isArray(userProfile.shop) ? userProfile.shop : [userProfile.shop];
                    if (userProfile.role !== 'Admin' && userProfile.role !== 'CEO' && !userShops.includes(qrText)) {
                        alert(`Access Denied to ${qrText}.`); setLoading(false); return;
                    }

                    const dist = Utils.getDistance(gpsLocation.latitude, gpsLocation.longitude, parseFloat(scannedShop.latitude), parseFloat(scannedShop.longitude));
                    const radius = parseFloat(scannedShop.radius) || 500;
                    if (dist > radius) { alert(`Too far from ${qrText} (${Math.round(dist)}m).`); setLoading(false); return; }

                    const nextActionType = lastAction?.type === 'in' ? 'out' : 'in';
                    const checkInTimestamp = new Date();
                    const { addDoc, collection, serverTimestamp, setDoc, doc, query, getDocs, where } = window.firebaseSDK;
                    
                    await addDoc(collection(db, 'attendance'), { 
                        employeeId: userProfile.id, employeeName: userProfile.name, shop: qrText, timestamp: serverTimestamp(), type: nextActionType, verificationMethod: 'qr', location: gpsLocation 
                    });
                    setSelectedShopForCheckIn(qrText);

                    // Late Logic (Simplified copy for brevity)
                    if (nextActionType === 'in') {
                        const shiftDetails = (allData.shifts || []).find(s => s.name === userProfile.shift && s.shopName === qrText);
                        if (shiftDetails && shiftDetails.lateThreshold && scannedShop.timezone) {
                            const timeInZoneString = checkInTimestamp.toLocaleTimeString('en-GB', { timeZone: scannedShop.timezone, hour: '2-digit', minute: '2-digit' });
                            const [checkInHour, checkInMinute] = timeInZoneString.split(':').map(Number);
                            const [lateHour, lateMinute] = shiftDetails.lateThreshold.split(':').map(Number);
                            const [startHour] = (shiftDetails.startTime || '00:00').split(':').map(Number);
                            if (checkInHour - startHour < 3) {
                                if (checkInHour > lateHour || (checkInHour === lateHour && checkInMinute > lateMinute)) {
                                    const { localDate: todayStr } = Utils.formatDateInTimezone({ toDate: () => checkInTimestamp }, scannedShop.timezone);
                                    const penaltyDocId = `late_${userProfile.id}_${todayStr}`;
                                    const q = query(collection(db, "employeeStates"), where("staffId", "==", userProfile.id), where("date", "==", todayStr));
                                    const snap = await getDocs(q);
                                    if (!snap.docs.some(doc => doc.data().note?.startsWith('CheckIn Late @'))) {
                                        const formattedTime = checkInTimestamp.toLocaleTimeString('en-US', { timeZone: scannedShop.timezone, hour: '2-digit', minute: '2-digit', hour12: true });
                                        await setDoc(doc(db, 'employeeStates', penaltyDocId), { 
                                            staffId: userProfile.id, staffName: userProfile.name, shop: qrText, date: todayStr, statusState: 'Deduction', amount: 5000, note: `CheckIn Late @${formattedTime}`, status: 'Approved' 
                                        });
                                    }
                                }
                            }
                        }
                    }
                    setAlertModal({ isOpen: true, message: `Successfully Checked ${nextActionType.toUpperCase()} via QR.` });
                    setStatus(`Checked ${nextActionType} via QR.`);
                } catch (error) { console.error("QR Error:", error); alert("QR Check-in Failed."); } finally { setLoading(false); }
            };

            const handleCheckAction = useCallback(async () => {
                setLoading(true);
                setStatus("Verifying...");
                try {
                    const { location: freshLocation, distance: freshDistance, shop } = await getLocation(true);
                    if (freshDistance > (parseFloat(shop.radius) || 500)) {
                        setStatus(`Too far (${Math.round(freshDistance)}m).`); setLoading(false); return;
                    }
                    
                    const { addDoc, collection, serverTimestamp, getDocs, query, where, setDoc, doc } = window.firebaseSDK;
                    const nextActionType = lastAction?.type === 'in' ? 'out' : 'in';
                    const checkInTimestamp = new Date();
                    
                    await addDoc(collection(db, 'attendance'), { employeeId: userProfile.id, employeeName: userProfile.name, shop: selectedShopForCheckIn, timestamp: serverTimestamp(), type: nextActionType, location: freshLocation, verificationMethod: 'gps' });
                    
                    if (nextActionType === 'in') {
                        const shiftDetails = (allData.shifts || []).find(s => s.name === userProfile.shift && s.shopName === selectedShopForCheckIn);
                        if (shiftDetails && shiftDetails.lateThreshold && shop.timezone) {
                            const [lateHour, lateMinute] = shiftDetails.lateThreshold.split(':').map(Number);
                            const [startHour] = (shiftDetails.startTime || '00:00').split(':').map(Number);
                            const timeInZoneString = checkInTimestamp.toLocaleTimeString('en-GB', { timeZone: shop.timezone, hour: '2-digit', minute: '2-digit' });
                            const [checkInHour, checkInMinute] = timeInZoneString.split(':').map(Number);
                            
                            if (checkInHour - startHour < 3) {
                                if (checkInHour > lateHour || (checkInHour === lateHour && checkInMinute > lateMinute)) {
                                    const { localDate: todayStr } = Utils.formatDateInTimezone({ toDate: () => checkInTimestamp }, shop.timezone);
                                    const penaltyDocId = `late_${userProfile.id}_${todayStr}`;
                                    const q = query(collection(db, "employeeStates"), where("staffId", "==", userProfile.id), where("date", "==", todayStr));
                                    const snap = await getDocs(q);
                                    if (!snap.docs.some(doc => doc.data().note?.startsWith('CheckIn Late @'))) {
                                        const formattedTime = checkInTimestamp.toLocaleTimeString('en-US', { timeZone: shop.timezone, hour: '2-digit', minute: '2-digit', hour12: true });
                                        await setDoc(doc(db, 'employeeStates', penaltyDocId), { 
                                            staffId: userProfile.id, staffName: userProfile.name, shop: selectedShopForCheckIn, date: todayStr, statusState: 'Deduction', amount: 5000, note: `CheckIn Late @${formattedTime}`, status: 'Approved'
                                        });
                                    }
                                }
                            }
                        }
                    }
                    setAlertModal({ isOpen: true, message: `Successfully checked ${nextActionType}.` });
                    setStatus(`Checked ${nextActionType}.`); 
                } catch (error) { setStatus("Failed."); console.error(error); } finally { setLoading(false); }
            }, [db, lastAction, userProfile, selectedShopForCheckIn, allData.leaveRequests, getLocation]);

            const canCheck = distance !== null && userShop && distance <= (parseFloat(userShop.radius) || 500);
            const { inputs, calculations } = usePayrollCalculator(userProfile, selectedMonth, allData, undefined, savingsWithdrawals, savingsData);

            // Determine if checked in
            const isCheckedIn = lastAction?.type === 'in';

            return (
                <Card className="max-w-2xl mx-auto">
                    <div className="flex flex-col items-center justify-center p-2 sm:p-6 space-y-6">
                    {/* Header: Time & Date */}
                    <div className="text-center">
                        <p className="text-4xl sm:text-7xl font-bold text-slate-100 tracking-wider">
                            {currentTime.toLocaleTimeString('en-US', { timeZone: userShop?.timezone || Intl.DateTimeFormat().resolvedOptions().timeZone, hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: true })}
                        </p>
                        <p className="text-lg text-slate-400 mt-2">
                            {currentTime.toLocaleDateString('en-US', { timeZone: userShop?.timezone || Intl.DateTimeFormat().resolvedOptions().timeZone, weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}
                        </p>
                    </div>

                    {/* Method Toggle */}
                    <div className="flex bg-slate-700/50 p-1 rounded-lg w-full max-w-sm">
                        <button onClick={() => setCheckInMethod('gps')} className={`flex-1 py-2 rounded-md text-sm font-bold transition-all ${checkInMethod === 'gps' ? 'bg-blue-600 text-white shadow-lg' : 'text-slate-400 hover:text-white'}`}>
                            <i className="fas fa-map-marker-alt mr-2"></i> GPS
                        </button>
                        <button onClick={() => setCheckInMethod('qr')} className={`flex-1 py-2 rounded-md text-sm font-bold transition-all ${checkInMethod === 'qr' ? 'bg-purple-600 text-white shadow-lg' : 'text-slate-400 hover:text-white'}`}>
                            <i className="fas fa-qrcode mr-2"></i> QR Code
                        </button>
                    </div>

                    {/* Conditional Rendering based on Method */}
                    {checkInMethod === 'gps' ? (
                        <div className="w-full max-w-sm animate-fade-in space-y-4">
                            {isMultiShopManager && (
                                <div className="w-full">
                                    <select value={selectedShopForCheckIn} onChange={e => setSelectedShopForCheckIn(e.target.value)} className="select bg-slate-800 border-slate-600 text-white text-center">
                                        <option value="">-- Select Your Shop --</option>
                                        {userProfile.shop.map(shopName => <option key={shopName} value={shopName}>{shopName}</option>)}
                                    </select>
                                </div>
                            )}

                            {/* --- REDESIGNED GPS UI START --- */}
                            
                            {/* 1. Location Status Bar */}
                            <div className={`flex items-center justify-between p-3 rounded-xl border ${canCheck ? 'bg-green-500/10 border-green-500/30' : 'bg-red-500/10 border-red-500/30'} transition-colors`}>
                                <div className="flex items-center gap-3">
                                    <div className={`w-2 h-2 rounded-full ${canCheck ? 'bg-green-500 animate-pulse' : 'bg-red-500'}`}></div>
                                    <div className="flex flex-col">
                                        <span className={`text-xs font-bold ${canCheck ? 'text-green-400' : 'text-red-400'}`}>
                                            {loading ? 'Locating...' : (canCheck ? 'In Range' : 'Out of Range')}
                                        </span>
                                        <span className="text-[10px] text-slate-400">
                                            {distance !== null ? `${Math.round(distance)}m from shop` : 'Unknown location'}
                                        </span>
                                    </div>
                                </div>
                                <button 
                                    onClick={() => getLocation(false)} 
                                    disabled={loading || !userShop}
                                    className="p-2 rounded-lg bg-slate-700 hover:bg-slate-600 text-slate-300 transition-colors"
                                    title="Refresh Location"
                                >
                                    <i className={`fas fa-sync-alt ${loading ? 'fa-spin' : ''}`}></i>
                                </button>
                            </div>

                            {/* 2. Hero Action Buttons */}
                            <div className="grid grid-cols-2 gap-4">
                                {/* Check IN Button */}
                                <button 
                                    onClick={handleCheckAction} 
                                    disabled={isCheckedIn || loading} 
                                    className={`relative p-4 rounded-2xl flex flex-col items-center justify-center gap-2 border-2 transition-all transform active:scale-95 ${
                                        isCheckedIn 
                                            ? 'bg-slate-800/50 border-slate-700 text-slate-500 cursor-not-allowed opacity-50' 
                                            : 'bg-gradient-to-br from-green-600 to-emerald-700 border-green-500 text-white shadow-lg shadow-green-900/30 hover:-translate-y-1'
                                    }`}
                                >
                                    <i className="fas fa-sign-in-alt text-2xl mb-1"></i>
                                    <span className="text-lg font-bold">Check IN</span>
                                    {!isCheckedIn && !loading && canCheck && (
                                        <span className="absolute top-2 right-2 w-3 h-3 bg-white rounded-full animate-ping"></span>
                                    )}
                                </button>

                                {/* Check OUT Button */}
                                <button 
                                    onClick={handleCheckAction} 
                                    disabled={!isCheckedIn || loading} 
                                    className={`relative p-4 rounded-2xl flex flex-col items-center justify-center gap-2 border-2 transition-all transform active:scale-95 ${
                                        !isCheckedIn 
                                            ? 'bg-slate-800/50 border-slate-700 text-slate-500 cursor-not-allowed opacity-50' 
                                            : 'bg-gradient-to-br from-red-600 to-rose-700 border-red-500 text-white shadow-lg shadow-red-900/30 hover:-translate-y-1'
                                    }`}
                                >
                                    <i className="fas fa-sign-out-alt text-2xl mb-1"></i>
                                    <span className="text-lg font-bold">Check OUT</span>
                                    {isCheckedIn && !loading && canCheck && (
                                        <span className="absolute top-2 right-2 w-3 h-3 bg-white rounded-full animate-ping"></span>
                                    )}
                                </button>
                            </div>
                            
                            {/* 3. Small Status Text */}
                            <p className="text-center text-xs text-slate-500 mt-2">{status}</p>

                            {/* --- REDESIGNED GPS UI END --- */}
                        </div>
                    ) : (
                        <div className="w-full max-w-sm animate-fade-in flex flex-col items-center gap-4">
                            <button onClick={() => setIsScannerOpen(true)} className="w-full py-6 rounded-2xl bg-gradient-to-r from-purple-600 to-indigo-600 text-white font-bold text-xl shadow-lg flex items-center justify-center gap-3 transition-transform active:scale-95 hover:shadow-purple-500/20">
                                <i className="fas fa-qrcode text-2xl"></i>
                                <span>{lastAction?.type === 'in' ? 'Scan to Check OUT' : 'Scan to Check IN'}</span>
                            </button>
                            <p className="text-xs text-slate-500">Requires camera access. GPS verification still applies.</p>
                        </div>
                    )}

                    {/* Savings & Salary Preview Logic remains same */}
                    {savingsData && (savingsData.savingsProgramStatus === 'Active' || savingsData.savingsProgramStatus === 'Paused') && (
                        <div className="w-full max-w-md mt-8 p-4 bg-indigo-900/50 border border-indigo-700 rounded-lg text-center">
                            <h4 className="text-lg font-semibold text-indigo-200">កម្មវិធីសន្សំរបស់ខ្ញុំ</h4>
                            <p className="text-sm text-slate-400">សមតុល្យសរុប</p>
                            <p className="text-4xl font-bold text-white mt-2">
                                {Utils.formatCurrency(savingsData?.currentBalance || 0)}
                            </p>
                        </div>
                    )}

                    <div className="text-center text-sm text-slate-400 pt-4 border-t border-slate-700 w-full max-w-md">
                        <p>Welcome, <span className="font-bold text-slate-200">{userProfile?.name}</span></p>
                        <p>Shop: <span className="font-bold text-slate-200">{selectedShopForCheckIn || 'N/A'}</span></p>
                        {lastAction && (<p className="mt-2">Last action: Checked <span className="font-semibold text-slate-200">{
                        Utils.formatDateInTimezone(lastAction.timestamp, userShop?.timezone).localTime
                    }</span></p>)}</div>
                    
                    {/* Salary Preview Section (Restored) */}
                    <div className="w-full max-w-md mt-4 p-4 bg-slate-700/50 border border-slate-600 rounded-lg">
                        <div className="flex justify-between items-center mb-4">
                             <h4 className="text-lg font-semibold text-slate-100">ប្រាក់ខែរកបាន</h4>
                             <input type="month" value={selectedMonth} onChange={e => setSelectedMonth(e.target.value)} className="input !mt-0 w-auto" />
                        </div>
                        <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            <div className="space-y-2">
                                <h5 className="font-semibold text-slate-200 border-b border-slate-600 pb-1 mb-2">ប្រាក់ចំណូល :</h5>
                                <div className="flex justify-between items-center text-sm"><span className="text-slate-400">ថ្ងៃធ្វើការ :</span><span className="font-semibold text-slate-200">{inputs.workDays || 0}</span></div>
                                <div className="flex justify-between items-center text-sm"><span className="text-slate-400">ផ្តល់ជូន :</span><span className="font-semibold text-slate-200">{inputs.givenOffDays || 0}</span></div>
                                <div className="flex justify-between items-center text-sm"><span className="text-slate-400">ថែមម៉ោង :</span><span className="font-semibold text-slate-200">{inputs.otDays || 0}</span></div>
                                <div className="flex justify-between items-center text-sm"><span className="text-slate-400">ប្រាក់បន្ថែម :</span><span className="font-semibold text-slate-200">{Utils.formatCurrency(calculations.engagements)}</span></div>
                                {calculations.totalSavingsWithdrawal > 0 && (
                                    <div className="flex justify-between items-center text-sm" title="Savings Program Payback">
                                        <span className="text-slate-400">ការទូទាត់សងប្រាក់សន្សំ :</span>
                                        <span className="font-semibold text-indigo-400">{Utils.formatCurrency(calculations.totalSavingsWithdrawal)}</span>
                                    </div>
                                )}
                                <div className="pt-2 border-t border-slate-600 flex justify-between items-center text-sm"><span className="font-bold text-green-400">ប្រាក់ចំណូលសរុប :</span><span className="font-bold text-green-400">{Utils.formatCurrency(calculations.grossSalary)}</span></div>
                            </div>
                            <div className="space-y-2">
                                <h5 className="font-semibold text-slate-200 border-b border-slate-600 pb-1 mb-2">ការកាត់ប្រាក់ :</h5>
                                <div className="flex justify-between items-center text-sm"><span className="text-slate-400">ច្បាប់សម្រាក :</span><span className="font-semibold text-slate-200">{inputs.leaveDays || 0}</span></div>
                                <div className="flex justify-between items-center text-sm"><span className="text-slate-400">មកយឺតសរុប :</span><span className="font-semibold text-slate-200">{inputs.totalLateDays || 0}</span></div>
                                <div className="flex justify-between items-center text-sm" title="អវត្តមាន + ភ្លេចចុចចេញ"><span className="text-slate-400">អវត្តមាន :</span><span className="font-semibold text-slate-200">{inputs.noAttendance || 0}</span></div>
                                <div className="flex justify-between items-center text-sm"><span className="text-slate-400">បំណុលរំលួស :</span><span className="font-semibold text-slate-200">{Utils.formatCurrency(inputs.loanDeduction)}</span></div>
                                {calculations.savingsDeduction > 0 && (
                                    <div className="flex justify-between items-center text-sm">
                                        <span className="text-slate-400">ការកាត់សន្សំ :</span>
                                        <span className="font-semibold text-blue-400">{Utils.formatCurrency(calculations.savingsDeduction)}</span>
                                    </div>
                                )}
                                {calculations.rejectedLeavePenaltyAmount > 0 && (
                                    <div className="flex justify-between items-center text-sm" title="Penalty for absence on a day with a rejected leave request">
                                        <span className="text-slate-400">ច្បាប់សម្រាកបដិសេធ :</span>
                                        <span className="font-semibold text-red-400">{Utils.formatCurrency(calculations.rejectedLeavePenaltyAmount)}</span>
                                    </div>
                                )}
                                <div className="flex justify-between items-center text-sm"><span className="text-slate-400">ការកាត់ផ្សេងៗ :</span><span className="font-semibold text-slate-200">{Utils.formatCurrency(calculations.otherDeductions)}</span></div>
                                <div className="pt-2 border-t border-slate-600 flex justify-between items-center text-sm"><span className="font-bold text-red-400">ការកាត់ប្រាក់សរុប :</span><span className="font-bold text-red-400">{Utils.formatCurrency(calculations.totalDeductions)}</span></div>
                            </div>
                        </div>
                        <div className="mt-4 pt-4 border-t border-slate-600 flex justify-between items-center">
                            <span className="font-bold text-slate-200">ប្រាក់ខែសុទ្ធទទួលបាន :</span>
                            <span className="text-xl font-bold text-blue-400">{Utils.formatCurrency(calculations.netSalary)}</span>
                        </div>
                    </div>
                </div>
                <Modal isOpen={alertModal.isOpen} onClose={() => setAlertModal({ isOpen: false, message: '' })} maxWidth="max-w-sm">
                    <ModalHeader title="Notification" onClose={() => setAlertModal({ isOpen: false, message: '' })} />
                    <ModalBody><p className="text-slate-300">{alertModal.message}</p></ModalBody>
                    <ModalFooter><Button variant="primary" onClick={() => setAlertModal({ isOpen: false, message: '' })}>OK</Button></ModalFooter>
                </Modal>
                <ScannerModal isOpen={isScannerOpen} onClose={() => setIsScannerOpen(false)} onScan={handleScanSuccess} />
                </Card>
            );
        };
        
        // Component: Leave Request Modal
        const LeaveRequestModal = ({ isOpen, onClose, onSave, request, userProfile }) => {
            const [formData, setFormData] = useState({});
            
            // Get global data from context
            const { shops, employees } = useAppData();

            const isManagerial = useMemo(() => userProfile?.role === 'Admin' || userProfile?.role === 'Shop Manager', [userProfile]);

            // Filter employees for the dropdown based on the selected shop in the modal
            const employeesInShop = useMemo(() => {
                if (!formData.shop) return [];
                return employees.filter(emp => {
                    const employeeShops = Array.isArray(emp.shop) ? emp.shop : [emp.shop];
                    return employeeShops.includes(formData.shop) && emp.status === 'Active';
                });
            }, [formData.shop, employees]);
            
            // Determine which shops should be available in the dropdown
            const availableShopsForModal = useMemo(() => {
                if (!userProfile) return [];
                if (userProfile.role === 'Admin' || userProfile.role === 'CEO') return shops;
                if (userProfile.role === 'Shop Manager') {
                    const managedShops = Array.isArray(userProfile.shop) ? userProfile.shop : (userProfile.shop ? [userProfile.shop] : []);
                    return shops.filter(s => managedShops.includes(s.name));
                }
                return []; // Staff don't get a shop dropdown
            }, [userProfile, shops]);

            useEffect(() => {
                if (request) { // EDIT mode: Populate with existing request data
                    setFormData(request);
                } else if (userProfile) { // NEW request mode
                    const initialData = {
                        leaveDate: new Date().toISOString().substring(0, 10),
                        returnDate: new Date().toISOString().substring(0, 10),
                        numberOfDays: 1,
                        leaveSession: 'Full Day',
                        leaveType: 'Relaxing Leave',
                        reason: '',
                        // Conditionally pre-fill based on role
                        shop: isManagerial ? '' : (Array.isArray(userProfile.shop) ? userProfile.shop[0] : userProfile.shop || ''),
                        staffId: isManagerial ? '' : (userProfile.id || ''),
                        staffName: isManagerial ? '' : (userProfile.name || ''),
                        supervisor: isManagerial ? '' : (userProfile.supervisor || ''),
                    };
                    setFormData(initialData);
                }
            }, [request, userProfile, isOpen, isManagerial]);

            const dateDiffInDays = useMemo(() => {
                if (formData.leaveDate && formData.returnDate) {
                    const start = new Date(formData.leaveDate);
                    const end = new Date(formData.returnDate);
                    if (end <= start) return 0;
                    const diffTime = end.getTime() - start.getTime();
                    return Math.round(diffTime / (1000 * 60 * 60 * 24));
                }
                return 0;
            }, [formData.leaveDate, formData.returnDate]);

            const isMultiDayLeave = dateDiffInDays > 1;

            const handleChange = useCallback((e) => {
                const { name, value } = e.target;
                let newFormData = { ...formData, [name]: value };

                // When a manager selects a shop, reset the staff selection
                if (name === 'shop') {
                    newFormData.staffId = '';
                    newFormData.staffName = '';
                    newFormData.supervisor = '';
                }

                // When a manager selects a staff member, populate their details
                if (name === 'staffId') {
                    const selectedEmployee = employees.find(emp => emp.id === value);
                    if (selectedEmployee) {
                        newFormData.staffName = selectedEmployee.name;
                        newFormData.supervisor = selectedEmployee.supervisor || '';
                    } else {
                        newFormData.staffName = '';
                        newFormData.supervisor = '';
                    }
                }

                // Recalculate days based on dates and session.
                const { leaveDate, returnDate, leaveSession } = newFormData;

                if (leaveDate && returnDate) {
                    const start = new Date(leaveDate);
                    const end = new Date(returnDate);
                    start.setHours(0, 0, 0, 0); // Normalize to avoid timezone issues
                    end.setHours(0, 0, 0, 0);

                    if (end < start) {
                        newFormData.numberOfDays = 0;
                    } else {
                        const diffTime = end.getTime() - start.getTime();
                        const diffDays = Math.round(diffTime / (1000 * 60 * 60 * 24));

                        // Case: User selects same leave and return date. We interpret this as a single-day event.
                        if (diffDays === 0) {
                            if (leaveSession === 'Full Day') { newFormData.numberOfDays = 1; } 
                            else { newFormData.numberOfDays = 0.5; }
                        } 
                        // Case: Standard single day leave (e.g., leave Mon, return Tue)
                        else if (diffDays === 1) {
                            if (leaveSession === 'Full Day') { newFormData.numberOfDays = 1; } 
                            else { newFormData.numberOfDays = 0.5; }
                        } 
                        // Case: Multi-day leave
                        else {
                            newFormData.numberOfDays = diffDays;
                            newFormData.leaveSession = 'Full Day'; // Force full day for multi-day leaves
                        }
                    }
                } else {
                    newFormData.numberOfDays = 0;
                }
                
                setFormData(newFormData);
            }, [formData, employees]);
            
            const handleSubmit = useCallback((e) => { 
                e.preventDefault(); 
                if ((isManagerial || Array.isArray(userProfile.shop)) && !formData.shop) {
                    alert("Please select a shop for the leave request.");
                    return;
                }

                // --- BUG FIX: Validation to prevent 0 days or negative dates ---
                if (formData.numberOfDays <= 0) {
                    alert("Invalid date range. The Return Date cannot be before the Leave Date.");
                    return;
                }
                // --- END FIX ---

                const dataToSave = { ...formData };
                if (dataToSave.leaveDate && dataToSave.leaveDate === dataToSave.returnDate) {
                    const returnDate = new Date(dataToSave.returnDate);
                    returnDate.setDate(returnDate.getDate() + 1);
                    dataToSave.returnDate = returnDate.toISOString().substring(0, 10);
                }
                onSave(dataToSave); 
            }, [onSave, formData, isManagerial, userProfile]);
            
            return (
                <Modal isOpen={isOpen} onClose={onClose} maxWidth="max-w-4xl">
                    {/* FIX: Added 'flex flex-col h-full overflow-hidden' to ensure the form stays within modal bounds and scrolls correctly */}
                    <form onSubmit={handleSubmit} className="flex flex-col h-full overflow-hidden">
                        <ModalHeader title={request ? "Edit Leave Request" : "New Leave Request"} onClose={onClose} />
                        <ModalBody>
                            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                <div>
                                    <label className="text-sm font-medium text-slate-400"><i className="fas fa-calendar-minus mr-2 text-orange-400"></i>Leave Date</label>
                                    <input type="date" name="leaveDate" value={formData.leaveDate || ''} onChange={handleChange} className="input" required />
                                </div>
                                <div>
                                    <label className="text-sm font-medium text-slate-400"><i className="fas fa-calendar-check mr-2 text-green-400"></i>Return Date</label>
                                    <input type="date" name="returnDate" value={formData.returnDate || ''} onChange={handleChange} className="input" required />
                                </div>
                                
                                <div>
                                    <label className="text-sm font-medium text-slate-400"><i className="fas fa-sun mr-2 text-yellow-400"></i>Session</label>
                                    <select name="leaveSession" value={formData.leaveSession || 'Full Day'} onChange={handleChange} className="select" disabled={isMultiDayLeave}>
                                        <option value="Full Day">Full Day</option>
                                        <option value="AM">AM (Morning)</option>
                                        <option value="PM">PM (Afternoon)</option>
                                    </select>
                                </div>
                                <div>
                                    <label className="text-sm font-medium text-slate-400"><i className="fas fa-calculator mr-2 text-blue-400"></i>No. Day(s)</label>
                                    <input 
                                        type="number"
                                        name="numberOfDays" 
                                        value={formData.numberOfDays || ''} 
                                        className="input" required 
                                        disabled
                                    />
                                </div>
                                
                                {isManagerial ? (
                                    <div>
                                        <label className="text-sm font-medium text-slate-400"><i className="fas fa-store mr-2 text-cyan-400"></i>Shop Name</label>
                                        <select name="shop" value={formData.shop || ''} onChange={handleChange} className="select" required>
                                            <option value="">Select Shop</option>
                                            {availableShopsForModal.map(shop => <option key={shop.id} value={shop.name}>{shop.name}</option>)}
                                        </select>
                                    </div>
                                ) : (
                                    <div><label className="text-sm font-medium text-slate-400"><i className="fas fa-store mr-2 text-cyan-400"></i>Shop Name</label><input value={formData.shop || ''} className="input" disabled /></div>
                                )}
                                
                                {isManagerial && !request ? (
                                    <div>
                                        <label className="text-sm font-medium text-slate-400"><i className="fas fa-user mr-2 text-emerald-400"></i>Staff Name</label>
                                        <select name="staffId" value={formData.staffId || ''} onChange={handleChange} className="select" required disabled={!formData.shop}>
                                            <option value="">Select Staff</option>
                                            {employeesInShop.map(e => <option key={e.id} value={e.id}>{e.name}</option>)}
                                        </select>
                                    </div>
                                ) : (
                                    <div><label className="text-sm font-medium text-slate-400"><i className="fas fa-user mr-2 text-emerald-400"></i>Staff Name</label><input value={formData.staffName || ''} className="input" disabled /></div>
                                )}
                                
                                <div><label className="text-sm font-medium text-slate-400"><i className="fas fa-user-tie mr-2 text-indigo-400"></i>Supervisor</label><input value={formData.supervisor || ''} className="input" disabled /></div>

                                <div className="lg:col-span-3">
                                    <label className="text-sm font-medium text-slate-400"><i className="fas fa-tags mr-2 text-pink-400"></i>Leave Type</label>
                                    <select name="leaveType" value={formData.leaveType || 'Relaxing Leave'} onChange={handleChange} className="select" required>
                                        <option>Relaxing Leave</option>
                                        <option>Sick Leave</option>
                                        <option>Emergency Leave</option>
                
                                    </select>
                                </div>
                                <div className="lg:col-span-3"><label className="text-sm font-medium text-slate-400"><i className="fas fa-comment-alt mr-2 text-slate-400"></i>Reason</label><textarea name="reason" value={formData.reason || ''} onChange={handleChange} className="input" rows="3" required></textarea></div>
                            </div>
                        </ModalBody>
                        <ModalFooter>
                            <Button type="button" variant="secondary" onClick={onClose}>Cancel</Button>
                            <Button type="submit" variant="primary" className="px-6">Submit Request</Button>
                        </ModalFooter>
                    </form>
                </Modal>
            );
        };

        // Component: OT Request Modal
        const OTRequestModal = ({ isOpen, onClose, onSave, request, userProfile }) => {
            const [formData, setFormData] = useState({});
            
            // Get global data from context
            const { shops, employees } = useAppData();

            const isManagerial = useMemo(() => userProfile?.role === 'Admin' || userProfile?.role === 'Shop Manager', [userProfile]);
            
            // Filter employees for dropdown based on selected shop
            const employeesInShop = useMemo(() => {
                if (!formData.shop) return [];
                return employees.filter(emp => {
                    const employeeShops = Array.isArray(emp.shop) ? emp.shop : [emp.shop];
                    return employeeShops.includes(formData.shop) && emp.status === 'Active';
                });
            }, [formData.shop, employees]);

            // Determine available shops for dropdown
            const availableShopsForModal = useMemo(() => {
                if (!userProfile) return [];
                if (userProfile.role === 'Admin' || userProfile.role === 'CEO') return shops;
                if (userProfile.role === 'Shop Manager') {
                    const managedShops = Array.isArray(userProfile.shop) ? userProfile.shop : (userProfile.shop ? [userProfile.shop] : []);
                    return shops.filter(s => managedShops.includes(s.name));
                }
                return [];
            }, [userProfile, shops]);

            // Initialize form data
            useEffect(() => {
                if (request) { // EDIT mode
                    setFormData(request);
                } else if (userProfile) { // NEW request mode
                    const initialData = {
                        reqDate: new Date().toISOString().substring(0, 10),
                        startTime: '', endTime: '', numberOfOTDays: 0, reason: '',
                        shop: isManagerial ? '' : (Array.isArray(userProfile.shop) ? userProfile.shop[0] : userProfile.shop || ''),
                        staffId: isManagerial ? '' : (userProfile.id || ''),
                        staffName: isManagerial ? '' : (userProfile.name || ''),
                        supervisor: isManagerial ? '' : (userProfile.supervisor || ''),
                    };
                    setFormData(initialData);
                }
            }, [request, userProfile, isOpen, isManagerial]);

            // Calculate OT days from start and end times
            useEffect(() => {
                if (formData.startTime && formData.endTime && formData.staffId && employees) {
                    const selectedEmployee = employees.find(e => e.id === formData.staffId);
                    const employeeShift = selectedEmployee ? selectedEmployee.shift : null;

                    if (employeeShift && (employeeShift === 'AM' || employeeShift === 'PM')) {
                        if (formData.startTime === '07:30' && formData.endTime === '17:00') { setFormData(prev => ({ ...prev, numberOfOTDays: 1 })); return; }
                        if (formData.startTime === '07:30' && formData.endTime === '21:00') { setFormData(prev => ({ ...prev, numberOfOTDays: 1.5 })); return; }
                    }
                    if (employeeShift && employeeShift === 'APM') {
                         if (formData.startTime === '07:30' && formData.endTime === '21:00') { setFormData(prev => ({ ...prev, numberOfOTDays: 1 })); return; }
                    }

                    const [startHour, startMinute] = formData.startTime.split(':').map(Number);
                    const [endHour, endMinute] = formData.endTime.split(':').map(Number);

                    if (!isNaN(startHour) && !isNaN(startMinute) && !isNaN(endHour) && !isNaN(endMinute)) {
                        const startDate = new Date(0, 0, 0, startHour, startMinute, 0);
                        let endDate = new Date(0, 0, 0, endHour, endMinute, 0);
                        if (endDate < startDate) { endDate.setDate(endDate.getDate() + 1); }
                        const diffMillis = endDate - startDate;
                        const diffHours = diffMillis / (1000 * 60 * 60);
                        let otDays = 0;
                        const OT_HOURS_PER_DAY = 8;
                        if (diffHours < 4) { otDays = 0; } 
                        else if (diffHours >= 4 && diffHours <= 5) { otDays = 0.5; } 
                        else { otDays = diffHours / OT_HOURS_PER_DAY; }
                        setFormData(prev => ({ ...prev, numberOfOTDays: otDays > 0 ? otDays.toFixed(2) : 0 }));
                    }
                }
            }, [formData.startTime, formData.endTime, formData.staffId, employees]);

            const handleChange = useCallback((e) => { 
                const { name, value } = e.target;
                let newFormData = { ...formData, [name]: value };

                if (name === 'shop') {
                    newFormData.staffId = '';
                    newFormData.staffName = '';
                    newFormData.supervisor = '';
                }
                if (name === 'staffId') {
                    const selectedEmployee = employees.find(emp => emp.id === value);
                    if (selectedEmployee) {
                        newFormData.staffName = selectedEmployee.name;
                        newFormData.supervisor = selectedEmployee.supervisor || '';
                    } else {
                        newFormData.staffName = '';
                        newFormData.supervisor = '';
                    }
                }
                setFormData(newFormData);
            }, [formData, employees]);
            
            const handleSubmit = useCallback((e) => { 
                e.preventDefault(); 
                if ((isManagerial || Array.isArray(userProfile.shop)) && !formData.shop) {
                    alert("Please select a shop for the OT request.");
                    return;
                }
                onSave(formData); 
            }, [onSave, formData, isManagerial, userProfile]);
            
            return (
                <Modal isOpen={isOpen} onClose={onClose} maxWidth="max-w-4xl">
                    {/* FIX: Added 'flex flex-col h-full overflow-hidden' to ensure the form stays within modal bounds and scrolls correctly */}
                    <form onSubmit={handleSubmit} className="flex flex-col h-full overflow-hidden">
                        <ModalHeader title={request ? "Edit OT Request" : "New OT Request"} onClose={onClose} />
                        <ModalBody>
                            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                <div><label className="text-sm font-medium text-slate-400"><i className="fas fa-calendar-day mr-2 text-orange-400"></i>OT Date</label><input type="date" name="reqDate" value={formData.reqDate || ''} onChange={handleChange} className="input" required /></div>
                                <div><label className="text-sm font-medium text-slate-400"><i className="fas fa-hourglass-start mr-2 text-blue-400"></i>Start Hour</label><input type="time" name="startTime" value={formData.startTime || ''} onChange={handleChange} className="input" required /></div>
                                <div><label className="text-sm font-medium text-slate-400"><i className="fas fa-hourglass-end mr-2 text-purple-400"></i>End Hour</label><input type="time" name="endTime" value={formData.endTime || ''} onChange={handleChange} className="input" required /></div>
                                
                                {isManagerial ? (
                                    <div>
                                        <label className="text-sm font-medium text-slate-400"><i className="fas fa-store mr-2 text-cyan-400"></i>Shop Name</label>
                                        <select name="shop" value={formData.shop || ''} onChange={handleChange} className="select" required>
                                            <option value="">Select Shop</option>
                                            {availableShopsForModal.map(shop => <option key={shop.id} value={shop.name}>{shop.name}</option>)}
                                        </select>
                                    </div>
                                ) : (
                                    <div><label className="text-sm font-medium text-slate-400"><i className="fas fa-store mr-2 text-cyan-400"></i>Shop Name</label><input value={formData.shop || ''} className="input" disabled /></div>
                                )}
                                
                                {isManagerial && !request ? (
                                    <div>
                                        <label className="text-sm font-medium text-slate-400"><i className="fas fa-user mr-2 text-emerald-400"></i>Staff Name</label>
                                        <select name="staffId" value={formData.staffId || ''} onChange={handleChange} className="select" required disabled={!formData.shop}>
                                            <option value="">Select Staff</option>
                                            {employeesInShop.map(e => <option key={e.id} value={e.id}>{e.name}</option>)}
                                        </select>
                                    </div>
                                ) : (
                                    <div><label className="text-sm font-medium text-slate-400"><i className="fas fa-user mr-2 text-emerald-400"></i>Staff Name</label><input value={formData.staffName || ''} className="input" disabled /></div>
                                )}
                                
                                <div><label className="text-sm font-medium text-slate-400"><i className="fas fa-user-tie mr-2 text-indigo-400"></i>Supervisor</label><input value={formData.supervisor || ''} className="input" disabled /></div>
                                
                                <div className="lg:col-span-3"><label className="text-sm font-medium text-slate-400"><i className="fas fa-calculator mr-2 text-green-400"></i>No. OT Day(s)</label><input type="number" name="numberOfOTDays" value={formData.numberOfOTDays || ''} className="input" disabled /></div>
                                <div className="lg:col-span-3"><label className="text-sm font-medium text-slate-400"><i className="fas fa-comment-alt mr-2 text-slate-400"></i>Reason</label><textarea name="reason" value={formData.reason || ''} onChange={handleChange} className="input" rows="3" required></textarea></div>
                            </div>
                        </ModalBody>
                        <ModalFooter>
                            <Button type="button" variant="secondary" onClick={onClose}>Cancel</Button>
                            <Button type="submit" variant="primary" className="px-6">Submit Request</Button>
                        </ModalFooter>
                    </form>
                </Modal>
            );
        };
        
        // Component: A single card for displaying a request in the mobile view
        const RequestCard = memo(({ request, userProfile, config, onUpdateStatus, onEdit, onDelete }) => {
            const { cardFields } = config;

            return (
                <div className="bg-slate-700/50 rounded-lg p-4 space-y-3 flex flex-col">
                    <div className="flex justify-between items-start">
                        <div>
                            <p className="font-bold text-lg text-slate-100">{request.staffName}</p>
                            <p className="text-sm text-slate-300">{request.shop}</p>
                        </div>
                        <span className="px-2 py-1 text-xs font-semibold rounded-full bg-yellow-200 text-yellow-900">{request.status}</span>
                    </div>
                    <div className="grid grid-cols-2 gap-x-4 gap-y-2 text-sm pt-2 border-t border-slate-600 flex-grow">
                        {cardFields.map(field => (
                            <div key={field.label}>
                                <p className="text-slate-400">{field.label}</p>
                                <p className="text-slate-200 font-medium">{field.value(request)}</p>
                            </div>
                        ))}
                        <div className="col-span-2">
                            <p className="text-slate-400">Reason</p>
                            <p className="text-slate-200 font-medium whitespace-pre-wrap">{request.reason}</p>
                        </div>
                    </div>
                    <div className="flex justify-end space-x-3 pt-2">
                        {(userProfile?.role === 'Admin' || userProfile?.role === 'CEO' || (userProfile?.role === 'Shop Manager' && userProfile.id !== request.staffId)) && request.status === 'Pending' && (
                            <>
                                <Button variant="icon-approve" icon="fa-check-circle" onClick={() => onUpdateStatus(request.id, 'Approved')} title="Approve" className="text-xl" />
                                <Button variant="icon-reject" icon="fa-times-circle" onClick={() => onUpdateStatus(request.id, 'Rejected')} title="Reject" className="text-xl" />
                            </>
                        )}
                        <Button variant="icon-edit-alt" icon="fa-edit" onClick={() => onEdit(request)} title="Edit" className="text-xl" />
                        <Button variant="icon-delete" icon="fa-trash" onClick={() => onDelete(request.id)} title="Delete" className="text-xl" />
                    </div>
                </div>
            );
        });

        // NEW: Phase 1 Refactoring - Request Filters Component
        const RequestFilters = memo(({
            title, userProfile, shops, employeesInShop,
            selectedShop, setSelectedShop, selectedEmployeeId, setSelectedEmployeeId,
            filterPeriod, setFilterPeriod, customDate, setCustomDate,
            onNewRequest
        }) => {
            return (
                <div className="flex flex-wrap gap-4 justify-between items-center mb-6">
                    <h3 className="text-xl font-semibold text-slate-100">{title}s</h3>
                    <div className="flex flex-wrap gap-4 items-center">
                        {(userProfile.role === 'Admin' || (userProfile.role === 'Shop Manager' && Array.isArray(userProfile.shop))) && (
                            <select value={selectedShop} onChange={e => { setSelectedShop(e.target.value); setSelectedEmployeeId(''); }} className="select w-full sm:w-auto">
                                <option value="">{userProfile.role === 'Admin' ? 'All Shops' : 'All My Shops'}</option>
                                {(userProfile.role === 'Admin' ? shops : (userProfile.shop || []).map(name => ({ id: name, name: name }))).map(s => <option key={s.id} value={s.name}>{s.name}</option>)}
                            </select>
                        )}
                        {(userProfile.role === 'Admin' || userProfile.role === 'Shop Manager') && selectedShop && (
                            <select value={selectedEmployeeId} onChange={e => setSelectedEmployeeId(e.target.value)} className="select w-full sm:w-auto">
                                <option value="">All Staff</option>
                                {employeesInShop.map(e => <option key={e.id} value={e.id}>{e.name}</option>)}
                            </select>
                        )}
                        {(userProfile.role === 'Admin' || userProfile.role === 'Shop Manager') && (
                            <select value={filterPeriod} onChange={e => setFilterPeriod(e.target.value)} className="select w-full sm:w-auto">
                                <option value="thisWeek">This Week</option><option value="thisMonth">This Month</option>
                                <option value="lastMonth">Last Month</option><option value="thisYear">This Year</option>
                                <option value="custom">Custom Date</option>
                            </select>
                        )}
                        {filterPeriod === 'custom' && (<input type="date" value={customDate} onChange={e => setCustomDate(e.target.value)} className="input w-full sm:w-auto" />)}
                        <Button variant="primary" icon="fa-plus" onClick={onNewRequest}>New Request</Button>
                    </div>
                </div>
            );
        });

        // NEW: Phase 1 Refactoring - Pending Requests Grid
        const PendingRequestsGrid = memo(({ requests, userProfile, config, onUpdateStatus, onEdit, onDelete }) => {
            if (requests.length === 0) return null;
            return (
                <div className="mb-8">
                    <h4 className="text-lg font-semibold text-slate-200 mb-4">Pending Requests</h4>
                    <div className="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-4">
                        {requests.map(req => (
                            <RequestCard
                                key={req.id}
                                request={req}
                                userProfile={userProfile}
                                config={config}
                                onUpdateStatus={onUpdateStatus}
                                onEdit={onEdit}
                                onDelete={onDelete}
                            />
                        ))}
                    </div>
                </div>
            );
        });

        // NEW: Phase 1 Refactoring - Request History Table
        const RequestHistoryTable = memo(({ requests, title, config, onEdit, onDelete, onViewReason }) => {
            const { tableColumns } = config;
            return (
                <div>
                    <h4 className="text-lg font-semibold text-slate-200 mb-4">{title} History</h4>
                    <div className="overflow-x-auto">
                        <table className="min-w-full divide-y divide-slate-700">
                            <thead className="bg-slate-900/50">
                                <tr>
                                    {tableColumns.map(col => <th key={col.header} className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">{col.header}</th>)}
                                    <th className="px-4 py-3 text-center text-xs font-semibold text-slate-400 uppercase">Reason</th>
                                    <th className="px-4 py-3 text-center text-xs font-semibold text-slate-400 uppercase">Status</th>
                                    <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Approval Time</th>
                                    <th className="px-4 py-3 text-center text-xs font-semibold text-slate-400 uppercase">Actions</th>
                                </tr>
                            </thead>
                            <tbody className="divide-y divide-slate-700">
                                {requests.map(req => (
                                    <tr key={req.id} className="hover:bg-slate-700/50">
                                        {tableColumns.map(col => <td key={col.header} className="px-4 py-4 text-sm text-slate-300">{typeof col.accessor === 'function' ? col.accessor(req) : req[col.accessor]}</td>)}
                                        <td className="px-4 py-4 text-center text-sm"><Button variant="icon-view" icon="fa-eye" onClick={() => onViewReason(req.reason)} /></td>
                                        <td className="px-4 py-4 text-center text-sm"><span className={`px-2 py-1 text-xs font-semibold rounded-full ${req.status === 'Approved' ? 'bg-green-200 text-green-900' : 'bg-red-200 text-red-900'}`}>{req.status}</span></td>
                                        <td className="px-4 py-4 text-sm text-slate-300">{req.status === 'Approved' ? req.approvalTimestamp || '' : ''}</td>
                                        <td className="px-4 py-4 text-center whitespace-nowrap">
                                            <div className="flex items-center justify-center gap-4">
                                                <Button variant="icon-edit-alt" icon="fa-edit" onClick={() => onEdit(req)} title="Edit" />
                                                <Button variant="icon-delete" icon="fa-trash" onClick={() => onDelete(req.id)} title="Delete" />
                                            </div>
                                        </td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                </div>
            );
        });

        // Component: Generic Tab for managing requests (Leave, OT, etc.)
        // MODIFIED: Added 'onAutoOpenProcessed' to handle one-time quick actions
        const RequestManagementTab = ({ userProfile, config, autoOpenNew, onAutoOpenProcessed }) => {
            const { collectionName, title, ModalComponent, dateField, submissionDateField } = config;
            const { db } = useFirebase();
            const [isModalOpen, setModalOpen] = useState(false);
            const [editingRequest, setEditingRequest] = useState(null);
            const [requestToDelete, setRequestToDelete] = useState(null);
            const [reasonToView, setReasonToView] = useState(null);
            const { where } = window.firebaseSDK;
            // REFACTORED: Get global data from context instead of separate collection calls.
            const { shops, employees } = useAppData();
            const [selectedShop, setSelectedShop] = useState('');
            const [filterPeriod, setFilterPeriod] = useState('thisMonth');
            const [customDate, setCustomDate] = useState(new Date().toISOString().slice(0, 10));
            const [selectedEmployeeId, setSelectedEmployeeId] = useState('');

            // NEW: Effect to auto-open the "New Request" modal if triggered via Quick Action
            useEffect(() => {
                if (autoOpenNew) {
                    setEditingRequest(null); // Ensure it's a new request
                    setModalOpen(true);
                    // Mark the action as processed so it doesn't open again on tab switch
                    if (onAutoOpenProcessed) onAutoOpenProcessed();
                }
            }, [autoOpenNew]); // Removed onAutoOpenProcessed from dependency to avoid loop

            // Set initial shop filter based on user role
            useEffect(() => {
                if (userProfile && userProfile.role !== 'Admin') {
                    setSelectedShop(Array.isArray(userProfile.shop) ? '' : userProfile.shop || '');
                }
            }, [userProfile]);

            // Define query constraints to fetch requests based on user role
            const queryConstraints = useMemo(() => {
                if (!userProfile) return [where("staffId", "==", "null")];
                if (userProfile.role === 'Admin') return [];
                if (userProfile.role === 'Shop Manager') {
                    const shops = Array.isArray(userProfile.shop) ? userProfile.shop : (userProfile.shop ? [userProfile.shop] : []);
                    if (shops.length > 0) return [where("shop", "in", shops)];
                    return [where("staffId", "==", "null")];
                }
                return [where("staffId", "==", userProfile.id)];
            }, [userProfile]);

            const { data: requests } = useCollection(collectionName, queryConstraints);

            // Get employees for the filter dropdown based on selected shop
            const employeesInShop = useMemo(() => {
                if (!selectedShop) return [];
                return employees.filter(emp => {
                    const employeeShops = Array.isArray(emp.shop) ? emp.shop : [emp.shop];
                    return employeeShops.includes(selectedShop) && emp.status === 'Active';
                });
            }, [selectedShop, employees]);

            // Filter and sort requests for display
            const { pendingRequests, historyRequests } = useMemo(() => {
                const filtered = requests.filter(req => {
                    if (!req[dateField]) return false;
                    const now = new Date();
                    let dateMatch = false;
                    switch (filterPeriod) {
                        case 'thisWeek':
                            const startOfWeek = new Date(now);
                            startOfWeek.setDate(now.getDate() - now.getDay());
                            startOfWeek.setHours(0, 0, 0, 0);
                            const endOfWeek = new Date(startOfWeek);
                            endOfWeek.setDate(startOfWeek.getDate() + 6);
                            endOfWeek.setHours(23, 59, 59, 999);
                            const reqDate = new Date(req[dateField]);
                            dateMatch = reqDate >= startOfWeek && reqDate <= endOfWeek;
                            break;
                        // FIX: The following cases now use local date components to avoid timezone errors.
                        case 'thisMonth':
                            const year_tm = now.getFullYear();
                            const month_tm = String(now.getMonth() + 1).padStart(2, '0');
                            dateMatch = req[dateField].startsWith(`${year_tm}-${month_tm}`);
                            break;
                        case 'lastMonth':
                            const lastMonthDate = new Date();
                            lastMonthDate.setMonth(lastMonthDate.getMonth() - 1);
                            const year_lm = lastMonthDate.getFullYear();
                            const month_lm = String(lastMonthDate.getMonth() + 1).padStart(2, '0');
                            dateMatch = req[dateField].startsWith(`${year_lm}-${month_lm}`);
                            break;
                        case 'thisYear':
                            dateMatch = req[dateField].startsWith(now.getFullYear().toString());
                            break;
                        case 'custom':
                            dateMatch = req[dateField] === customDate;
                            break;
                        default:
                            dateMatch = true;
                    }
                    return dateMatch && (!selectedShop || req.shop === selectedShop) && (!selectedEmployeeId || req.staffId === selectedEmployeeId);
                });

                const pending = filtered.filter(req => req.status === 'Pending').sort((a, b) => (b[submissionDateField]?.toDate() || 0) - (a[submissionDateField]?.toDate() || 0));
                const history = filtered.filter(req => req.status !== 'Pending').sort((a, b) => (b[submissionDateField]?.toDate() || 0) - (a[submissionDateField]?.toDate() || 0));
                
                return { pendingRequests: pending, historyRequests: history };
            }, [requests, selectedShop, selectedEmployeeId, filterPeriod, customDate, dateField, submissionDateField]);

            const handleOpenModal = useCallback((request = null) => { setEditingRequest(request); setModalOpen(true); }, []);
            const handleCloseModal = useCallback(() => { setEditingRequest(null); setModalOpen(false); }, []);
            
            const handleSaveRequest = useCallback(async (formData) => {
                const { doc, addDoc, updateDoc, collection, serverTimestamp } = window.firebaseSDK;
                const staffName = employees.find(e => e.id === formData.staffId)?.name || '';
                try {
                    if (formData.id) { 
                        const { id, ...dataToUpdate } = formData; 
                        await updateDoc(doc(db, collectionName, id), { ...dataToUpdate, staffName }); 
                    } else { 
                        const dataToAdd = { ...formData, staffName, status: 'Pending' };
                        dataToAdd[submissionDateField] = serverTimestamp();
                        await addDoc(collection(db, collectionName), dataToAdd); 
                    }
                    handleCloseModal();
                } catch (error) { console.error(`Error saving ${title}:`, error); }
            }, [db, employees, handleCloseModal, collectionName, title, submissionDateField]);

            const handleUpdateRequestStatus = useCallback(async (id, status) => {
                const { doc, updateDoc } = window.firebaseSDK;
                const dataToUpdate = { status };
                if (status === 'Approved') {
                    const now = new Date();
                    const formattedTimestamp = `${String(now.getDate()).padStart(2, '0')}/${String(now.getMonth() + 1).padStart(2, '0')} | ${now.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: true })}`;
                    dataToUpdate.approvalTimestamp = formattedTimestamp;
                }
                try { await updateDoc(doc(db, collectionName, id), dataToUpdate); } 
                catch (error) { console.error(`Error updating status for ${title} ${id}:`, error); }
            }, [db, collectionName, title]);

            const confirmDelete = useCallback(async () => {
                if (!requestToDelete) return;
                try { await window.firebaseSDK.deleteDoc(window.firebaseSDK.doc(db, collectionName, requestToDelete)); } 
                catch (error) { console.error(`Error deleting ${title} ${requestToDelete}:`, error); } 
                finally { setRequestToDelete(null); }
            }, [db, requestToDelete, collectionName, title]);

            return (
                <Card>
                    <RequestFilters
                        title={title}
                        userProfile={userProfile}
                        shops={shops}
                        employeesInShop={employeesInShop}
                        selectedShop={selectedShop}
                        setSelectedShop={setSelectedShop}
                        selectedEmployeeId={selectedEmployeeId}
                        setSelectedEmployeeId={setSelectedEmployeeId}
                        filterPeriod={filterPeriod}
                        setFilterPeriod={setFilterPeriod}
                        customDate={customDate}
                        setCustomDate={setCustomDate}
                        onNewRequest={() => handleOpenModal()}
                    />
                    <PendingRequestsGrid
                        requests={pendingRequests}
                        userProfile={userProfile}
                        config={config}
                        onUpdateStatus={handleUpdateRequestStatus}
                        onEdit={handleOpenModal}
                        onDelete={setRequestToDelete}
                    />
                    <RequestHistoryTable
                        requests={historyRequests}
                        title={title}
                        config={config}
                        onEdit={handleOpenModal}
                        onDelete={setRequestToDelete}
                        onViewReason={setReasonToView}
                    />
                    {/* REFACTORED: Removed shops and employees props as the modal now gets them from context */}
                    <ModalComponent isOpen={isModalOpen} onClose={handleCloseModal} onSave={handleSaveRequest} request={editingRequest} userProfile={userProfile} />
                    <ConfirmationModal isOpen={!!requestToDelete} onClose={() => setRequestToDelete(null)} onConfirm={confirmDelete} title={`Delete ${title}`} message={`Are you sure you want to permanently delete this ${title.toLowerCase()}?`} />
                    <Modal isOpen={!!reasonToView} onClose={() => setReasonToView(null)} maxWidth="max-w-md">
                        <ModalHeader title={`${title} Reason`} onClose={() => setReasonToView(null)} />
                        <ModalBody><p className="text-slate-300">{reasonToView}</p></ModalBody>
                        <ModalFooter><Button variant="secondary" onClick={() => setReasonToView(null)}>Close</Button></ModalFooter>
                    </Modal>
                </Card>
            );
        };
        
        // --- START EMPLOYEE STATE COMPONENTS (RESTORED) ---
        
        const EmployeeStateModal = ({ isOpen, onClose, onSave, record, userProfile }) => {
            const [formData, setFormData] = useState({});
            const { shops, employees } = useAppData();
            const isManagerial = userProfile?.role === 'Admin' || userProfile?.role === 'Shop Manager';

            const employeesInShop = useMemo(() => {
                if (!formData.shop) return [];
                return employees.filter(emp => {
                    const employeeShops = Array.isArray(emp.shop) ? emp.shop : [emp.shop];
                    return employeeShops.includes(formData.shop) && emp.status === 'Active';
                });
            }, [formData.shop, employees]);

            const availableShopsForModal = useAllowedShops(userProfile, shops);

            useEffect(() => {
                if (isOpen) {
                    setFormData(record ? { ...record } : {
                        date: new Date().toISOString().slice(0, 10),
                        shop: isManagerial ? '' : (Array.isArray(userProfile.shop) ? userProfile.shop[0] : userProfile.shop || ''),
                        staffId: isManagerial ? '' : (userProfile.id || ''),
                        staffName: isManagerial ? '' : (userProfile.name || ''),
                        statusState: 'Engagement',
                        amount: '',
                        note: '',
                        status: 'Pending'
                    });
                }
            }, [isOpen, record, userProfile, isManagerial]);

            const handleChange = (e) => {
                const { name, value } = e.target;
                setFormData(prev => {
                    const newData = { ...prev, [name]: value };
                    if (name === 'shop') {
                        newData.staffId = ''; newData.staffName = '';
                    }
                    if (name === 'staffId') {
                        const emp = employees.find(e => e.id === value);
                        if (emp) newData.staffName = emp.name;
                    }
                    return newData;
                });
            };

            const handleSubmit = (e) => {
                e.preventDefault();
                onSave({ ...formData, amount: parseFloat(formData.amount) });
            };

            return (
                <Modal isOpen={isOpen} onClose={onClose}>
                    {/* FIX: Added 'flex flex-col h-full overflow-hidden' to ensure proper scrolling and keep footer visible */}
                    <form onSubmit={handleSubmit} className="flex flex-col h-full overflow-hidden">
                        <ModalHeader title={record ? "Edit Record" : "Add Engagement/Deduction"} onClose={onClose} />
                        <ModalBody>
                            <div className="space-y-4">
                                <div className="grid grid-cols-2 gap-4">
                                    <div>
                                        <label className="text-sm font-medium text-slate-400">
                                            <i className="fas fa-calendar-day mr-2 text-blue-400"></i>Date
                                        </label>
                                        {/* FIX: Added || '' to value to prevent uncontrolled input warning */}
                                        <input type="date" name="date" value={formData.date || ''} onChange={handleChange} className="input" required />
                                    </div>
                                    <div>
                                        <label className="text-sm font-medium text-slate-400">
                                            <i className="fas fa-tag mr-2 text-purple-400"></i>Type
                                        </label>
                                        {/* FIX: Added || 'Engagement' default */}
                                        <select name="statusState" value={formData.statusState || 'Engagement'} onChange={handleChange} className="select">
                                            <option value="Engagement">Engagement (Bonus)</option>
                                            <option value="Deduction">Deduction (Fine)</option>
                                        </select>
                                    </div>
                                </div>
                                
                                {isManagerial ? (
                                    <div>
                                        <label className="text-sm font-medium text-slate-400">
                                            <i className="fas fa-store mr-2 text-cyan-400"></i>Shop
                                        </label>
                                        {/* FIX: Added || '' */}
                                        <select name="shop" value={formData.shop || ''} onChange={handleChange} className="select" required>
                                            <option value="">Select Shop</option>
                                            {availableShopsForModal.map(s => <option key={s.id} value={s.name}>{s.name}</option>)}
                                        </select>
                                    </div>
                                ) : (
                                    /* FIX: Added || '' */
                                    <input value={formData.shop || ''} className="input" disabled />
                                )}

                                {isManagerial && !record ? (
                                    <div>
                                        <label className="text-sm font-medium text-slate-400">
                                            <i className="fas fa-user mr-2 text-emerald-400"></i>Staff
                                        </label>
                                        {/* FIX: Added || '' */}
                                        <select name="staffId" value={formData.staffId || ''} onChange={handleChange} className="select" required disabled={!formData.shop}>
                                            <option value="">Select Staff</option>
                                            {employeesInShop.map(e => <option key={e.id} value={e.id}>{e.name}</option>)}
                                        </select>
                                    </div>
                                ) : (
                                    /* FIX: Added || '' */
                                    <input value={formData.staffName || ''} className="input" disabled />
                                )}

                                <div>
                                    <label className="text-sm font-medium text-slate-400">
                                        <i className="fas fa-money-bill-wave mr-2 text-green-400"></i>Amount (KHR)
                                    </label>
                                    {/* FIX: Added || '' */}
                                    <input type="number" name="amount" value={formData.amount || ''} onChange={handleChange} className="input font-bold text-orange-400" required />
                                </div>
                                <div>
                                    <label className="text-sm font-medium text-slate-400">
                                        <i className="fas fa-sticky-note mr-2 text-slate-400"></i>Note
                                    </label>
                                    {/* FIX: Added || '' */}
                                    <textarea name="note" value={formData.note || ''} onChange={handleChange} className="input" rows="2" required></textarea>
                                </div>
                            </div>
                        </ModalBody>
                        <ModalFooter>
                            <Button variant="secondary" onClick={onClose}>Cancel</Button>
                            <Button type="submit" variant="primary">Save</Button>
                        </ModalFooter>
                    </form>
                </Modal>
            );
        };

        const EmployeeStateTab = ({ userProfile }) => {
            const { db } = useFirebase();
            const { shops } = useAppData();
            const [selectedShop, setSelectedShop] = useState('');
            const [searchTerm, setSearchTerm] = useState('');
            // NEW: State for Month Filter (Defaults to current month)
            const [selectedMonth, setSelectedMonth] = useState(new Date().toISOString().slice(0, 7));
            
            const [isModalOpen, setIsModalOpen] = useState(false);
            const [editingRecord, setEditingRecord] = useState(null);
            const [recordToDelete, setRecordToDelete] = useState(null);

            // Set initial shop
            useEffect(() => {
                if (userProfile && userProfile.role !== 'Admin' && userProfile.role !== 'CEO') {
                    setSelectedShop(Array.isArray(userProfile.shop) ? '' : userProfile.shop || '');
                }
            }, [userProfile]);

            const queryConstraints = useMemo(() => {
                const { where } = window.firebaseSDK;
                if (!userProfile) return [where("shop", "==", "null")];
                if (userProfile.role === 'Admin' || userProfile.role === 'CEO') return [];
                if (userProfile.role === 'Shop Manager') {
                    const managedShops = Array.isArray(userProfile.shop) ? userProfile.shop : (userProfile.shop ? [userProfile.shop] : []);
                    return managedShops.length > 0 ? [where("shop", "in", managedShops)] : [where("shop", "==", "null")];
                }
                return [where("staffId", "==", userProfile.id)];
            }, [userProfile]);

            const { data: records, loading } = useCollection('employeeStates', queryConstraints);

            const filteredRecords = useMemo(() => {
                return records.filter(r => 
                    (!selectedShop || r.shop === selectedShop) &&
                    (!searchTerm || r.staffName.toLowerCase().includes(searchTerm.toLowerCase())) &&
                    // NEW: Filter by selected month
                    (!selectedMonth || r.date.startsWith(selectedMonth))
                ).sort((a,b) => b.date.localeCompare(a.date));
            }, [records, selectedShop, searchTerm, selectedMonth]); // Added selectedMonth dependency

            const handleSave = async (formData) => {
                const { addDoc, updateDoc, doc, collection, serverTimestamp } = window.firebaseSDK;
                const { id, ...data } = formData;
                try {
                    if (id) await updateDoc(doc(db, 'employeeStates', id), data);
                    else await addDoc(collection(db, 'employeeStates'), { ...data, createdAt: serverTimestamp() });
                    setIsModalOpen(false);
                    setEditingRecord(null);
                } catch (error) { console.error("Error saving record:", error); }
            };

            const handleDelete = async () => {
                if (!recordToDelete) return;
                try {
                    await window.firebaseSDK.deleteDoc(window.firebaseSDK.doc(db, 'employeeStates', recordToDelete.id));
                    setRecordToDelete(null);
                } catch (error) { console.error("Error deleting record:", error); }
            };

            const handleUpdateStatus = async (record, status) => {
                try {
                    await window.firebaseSDK.updateDoc(window.firebaseSDK.doc(db, 'employeeStates', record.id), { status });
                } catch (error) { console.error("Error updating status:", error); }
            };

            const canManage = userProfile?.role === 'Admin' || userProfile?.role === 'CEO' || userProfile?.role === 'Shop Manager';

            return (
                <Card>
                    <PageHeader title="Engagements & Deductions">
                        <SearchInput value={searchTerm} onChange={e => setSearchTerm(e.target.value)} />
                        <ShopFilterSelect userProfile={userProfile} shops={shops} selectedShop={selectedShop} onChange={e => setSelectedShop(e.target.value)} />
                        
                        {/* NEW: Month Filter Input */}
                        <input 
                            type="month" 
                            value={selectedMonth} 
                            onChange={e => setSelectedMonth(e.target.value)} 
                            className="input w-full sm:w-auto" 
                        />

                        {canManage && <Button variant="primary" icon="fa-plus" onClick={() => { setEditingRecord(null); setIsModalOpen(true); }}>Add Record</Button>}
                    </PageHeader>

                    {loading ? <div className="text-center py-10"><i className="fas fa-spinner fa-spin text-3xl"></i></div> : (
                        <div className="overflow-x-auto">
                            <table className="min-w-full divide-y divide-slate-700">
                                <thead className="bg-slate-900/50">
                                    <tr>
                                        <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Date</th>
                                        <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Staff</th>
                                        <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Type</th>
                                        <th className="px-4 py-3 text-right text-xs font-semibold text-slate-400 uppercase">Amount</th>
                                        <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Note</th>
                                        <th className="px-4 py-3 text-center text-xs font-semibold text-slate-400 uppercase">Status</th>
                                        <th className="px-4 py-3 text-center text-xs font-semibold text-slate-400 uppercase">Actions</th>
                                    </tr>
                                </thead>
                                <tbody className="divide-y divide-slate-700">
                                    {filteredRecords.map(rec => (
                                        <tr key={rec.id} className="hover:bg-slate-700/50">
                                            <td className="px-4 py-4 text-sm text-slate-300">{Utils.formatISOToDisplay(rec.date)}</td>
                                            <td className="px-4 py-4 text-sm text-slate-200">{rec.staffName}</td>
                                            <td className="px-4 py-4 text-sm"><span className={`px-2 py-1 text-xs rounded-full ${rec.statusState === 'Engagement' ? 'bg-green-900 text-green-300' : 'bg-red-900 text-red-300'}`}>{rec.statusState}</span></td>
                                            <td className="px-4 py-4 text-sm text-right font-bold text-orange-300">{Utils.formatCurrency(rec.amount)}</td>
                                            <td className="px-4 py-4 text-sm text-slate-300">{rec.note}</td>
                                            <td className="px-4 py-4 text-center text-sm"><span className={`px-2 py-1 text-xs rounded-full ${rec.status === 'Approved' ? 'bg-green-200 text-green-900' : 'bg-yellow-200 text-yellow-900'}`}>{rec.status}</span></td>
                                            <td className="px-4 py-4 text-center">
                                                <div className="flex items-center justify-center gap-2">
                                                    {(canManage && rec.status === 'Pending') && (
                                                        <>
                                                            <Button variant="icon-approve" icon="fa-check" onClick={() => handleUpdateStatus(rec, 'Approved')} />
                                                            <Button variant="icon-reject" icon="fa-times" onClick={() => handleUpdateStatus(rec, 'Rejected')} />
                                                        </>
                                                    )}
                                                    {canManage && (
                                                        <>
                                                            <Button variant="icon-edit" icon="fa-edit" onClick={() => { setEditingRecord(rec); setIsModalOpen(true); }} />
                                                            <Button variant="icon-delete" icon="fa-trash" onClick={() => setRecordToDelete(rec)} />
                                                        </>
                                                    )}
                                                </div>
                                            </td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                    )}
                    <EmployeeStateModal isOpen={isModalOpen} onClose={() => setIsModalOpen(false)} onSave={handleSave} record={editingRecord} userProfile={userProfile} />
                    <ConfirmationModal isOpen={!!recordToDelete} onClose={() => setRecordToDelete(null)} onConfirm={handleDelete} title="Delete Record" message="Are you sure you want to delete this record?" />
                </Card>
            );
        };
        // --- END EMPLOYEE STATE COMPONENTS ---
        
        // Component: Main CheckInMe Page (Tab Container)
        const CheckInMePage = ({ userProfile, initialTab = 'checkInOut' }) => {
            // FIX: Split prop into ID, Action, and Timestamp to handle unique events
            const [propTabId, propAction, propTs] = initialTab ? initialTab.split(':') : ['checkInOut', null, null];
            
            const [activeTab, setActiveTab] = useState('checkInOut');
            
            // NEW: State to track which quick action ID has already been handled (consumed)
            const [handledActionId, setHandledActionId] = useState(null);

            // Sync active tab when initialTab prop changes (e.g., incoming Quick Action)
            useEffect(() => {
                if (propTabId) setActiveTab(propTabId);
            }, [initialTab, propTabId]);
            
            // FIX: Helper to determine if we should auto-open the modal.
            // It returns true ONLY if:
            // 1. The current active tab matches the requested tab.
            // 2. The action is 'new'.
            // 3. This specific action timestamp hasn't been handled yet.
            const shouldAutoOpen = (tabKey) => {
                const uniqueActionId = `${tabKey}:${propAction}:${propTs}`;
                return activeTab === tabKey && 
                       propAction === 'new' && 
                       propTabId === tabKey && 
                       handledActionId !== uniqueActionId;
            };

            // Callback to mark the action as handled
            const handleActionProcessed = () => {
                const uniqueActionId = `${propTabId}:${propAction}:${propTs}`;
                setHandledActionId(uniqueActionId);
            };
            
            // Define configurations for our generic request management tab
            const leaveRequestConfig = {
                collectionName: 'leaveRequests',
                title: 'Leave Request',
                ModalComponent: LeaveRequestModal,
                dateField: 'leaveDate',
                submissionDateField: 'requestDate',
                cardFields: [
                    { label: 'Leave Date', value: (req) => Utils.formatISOToDisplay(req.leaveDate) },
                    { label: 'Return Date', value: (req) => Utils.formatISOToDisplay(req.returnDate) },
                    { label: 'Days', value: (req) => req.numberOfDays },
                    { label: 'Session', value: (req) => req.leaveSession || '-' },
                    { label: 'Supervisor', value: (req) => req.supervisor },
                    { label: 'Submitted', value: (req) => Utils.formatRequestDate(req.requestDate) },
                    // FIX: Ensured this value directly displays the saved req.leaveType
                    { label: 'Type', value: (req) => req.leaveType },
                ],
                tableColumns: [
                    { header: 'Request Date', accessor: (req) => Utils.formatRequestDate(req.requestDate) },
                    { header: 'Shop', accessor: 'shop' },
                    { header: 'Name', accessor: 'staffName' },
                    { header: 'Leave Date', accessor: (req) => Utils.formatISOToDisplay(req.leaveDate) },
                    { header: 'Return Date', accessor: (req) => Utils.formatISOToDisplay(req.returnDate) },
                    { header: 'No. Days', accessor: 'numberOfDays' },
                    { header: 'Session', accessor: 'leaveSession' },
                    { header: 'Leave Type', accessor: 'leaveType' },
                    { header: 'Supervisor', accessor: 'supervisor' },
                ]
            };
            
            const otRequestConfig = {
                collectionName: 'otRequests',
                title: 'OT Request',
                ModalComponent: OTRequestModal,
                dateField: 'reqDate',
                submissionDateField: 'submissionDate',
                cardFields: [
                    { label: 'OT Date', value: (req) => Utils.formatISOToDisplay(req.reqDate) },
                    { label: 'Days', value: (req) => req.numberOfOTDays },
                    { label: 'Start Time', value: (req) => req.startTime || 'N/A' },
                    { label: 'End Time', value: (req) => req.endTime || 'N/A' },
                    { label: 'Supervisor', value: (req) => req.supervisor },
                    { label: 'Submitted', value: (req) => Utils.formatRequestDate(req.submissionDate) },
                ],
                tableColumns: [
                    { header: 'Request Date', accessor: (req) => Utils.formatRequestDate(req.submissionDate) },
                    { header: 'Shop', accessor: 'shop' },
                    { header: 'Name', accessor: 'staffName' },
                    { header: 'OT Date', accessor: (req) => Utils.formatISOToDisplay(req.reqDate) },
                    { header: 'Start Time', accessor: 'startTime' },
                    { header: 'End Time', accessor: 'endTime' },
                    { header: 'No. OT Days', accessor: 'numberOfOTDays' },
                    { header: 'Supervisor', accessor: 'supervisor' },
                ]
            };

            // MODIFIED: Define tabs with icons
            const tabs = { 
                checkInOut: <span><i className="fas fa-fingerprint mr-2 text-blue-400"></i>Check In/Out</span>, 
                leaveRequest: <span><i className="fas fa-calendar-minus mr-2 text-orange-400"></i>Leave Request</span>, 
                otRequest: <span><i className="fas fa-clock mr-2 text-purple-400"></i>OT Request</span>, 
                employeeState: <span><i className="fas fa-file-contract mr-2 text-yellow-400"></i>Engagements / Deductions</span> 
            };

            return (
                <TabbedPage tabs={tabs} activeTab={activeTab} setActiveTab={setActiveTab}>
                    <div id="checkInOut"><CheckInOutTab userProfile={userProfile} /></div>
                    <div id="leaveRequest">
                        {/* MODIFIED: Pass shouldAutoOpen function and handler */}
                        <RequestManagementTab 
                            userProfile={userProfile} 
                            config={leaveRequestConfig} 
                            autoOpenNew={shouldAutoOpen('leaveRequest')} 
                            onAutoOpenProcessed={handleActionProcessed}
                        />
                    </div>
                    <div id="otRequest">
                        {/* MODIFIED: Pass shouldAutoOpen function and handler */}
                        <RequestManagementTab 
                            userProfile={userProfile} 
                            config={otRequestConfig} 
                            autoOpenNew={shouldAutoOpen('otRequest')} 
                            onAutoOpenProcessed={handleActionProcessed}
                        />
                    </div>
                    <div id="employeeState"><EmployeeStateTab userProfile={userProfile} /></div>
                </TabbedPage>
            );
        };
        // --- END CHECKINME PAGE COMPONENTS ---

        // --- START ATTENDANCE REPORT PAGE ---

        // NEW: Phase 1 Refactoring - Daily Report Filters Component
        // OPTIMIZATION: Updated to use standard PageHeader style internally
        const DailyReportFilters = memo(({
            userProfile, selectedShop, setSelectedShop, searchTerm, setSearchTerm, availableShops,
            filterType, setFilterType, customMonth, setCustomMonth,
            selectedShift, setSelectedShift, uniqueShiftNames, onExportExcel
        }) => {
            return (
                <div className="flex flex-wrap gap-4 justify-between items-center mb-6">
                    <h3 className="text-xl font-semibold text-slate-100">Daily Attendance Report</h3>
                    <div className="flex flex-wrap gap-4 items-center">
                        <ShopFilterSelect 
                            userProfile={userProfile}
                            shops={availableShops} // Pass pre-calculated allowed shops
                            selectedShop={selectedShop}
                            onChange={e => { setSelectedShop(e.target.value); setSearchTerm(''); }}
                        />
                        
                        {userProfile?.role !== 'Staff' && (
                            <SearchInput 
                                value={searchTerm} 
                                onChange={e => setSearchTerm(e.target.value)} 
                                placeholder="Search staff..."
                            />
                        )}
                        
                        <select value={filterType} onChange={e => setFilterType(e.target.value)} className="select w-full sm:w-auto">
                            <option value="today">Today</option>
                            <option value="yesterday">Yesterday</option>
                            <option value="thisMonth">This Month</option>
                            <option value="lastMonth">Last Month</option>
                            <option value="custom">Custom Month</option>
                        </select>
                        
                        {filterType === 'custom' && (
                            <input type="month" value={customMonth} onChange={e => setCustomMonth(e.target.value)} className="input w-full sm:w-auto" />
                        )}
                        
                        <select value={selectedShift} onChange={e => setSelectedShift(e.target.value)} className="select w-full sm:w-auto">
                            <option value="">All Shifts</option>
                            {uniqueShiftNames.map(name => <option key={name} value={name}>{name}</option>)}
                        </select>
                        
                        <Button variant="success" icon="fa-file-excel" onClick={onExportExcel}>Excel</Button>
                    </div>
                </div>
            );
        });
        
        // NEW: Phase 1 Refactoring - Daily Report Table Component
        const DailyReportTable = memo(({ attendanceReport, userProfile, onAddCheckOut, onDeleteRecord }) => {
            return (
                <div className="overflow-x-auto">
                    <table className="min-w-full divide-y divide-slate-700">
                        <thead className="bg-slate-900/50">
                            <tr>
                                <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Date</th>
                                <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Shop Name</th>
                                <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Staff Name</th>
                                <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Shift</th>
                                <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Check In</th>
                                <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Check Out</th>
                                <th className="px-4 py-3 text-center text-xs font-semibold text-slate-400 uppercase">Leave Status</th>
                                <th className="px-4 py-3 text-center text-xs font-semibold text-slate-400 uppercase">OT Status</th>
                                <th className="px-4 py-3 text-center text-xs font-semibold text-slate-400 uppercase">Actions</th>
                            </tr>
                        </thead>
                        <tbody className="divide-y divide-slate-700">
                            {attendanceReport.map((report) => (
                                <tr key={`${report.employeeId}-${report.date}`} className="transition-colors hover:bg-slate-700/50">
                                    <td className="px-4 py-4 text-sm text-slate-200">{report.date}</td>
                                    <td className="px-4 py-4 text-sm text-slate-300">{report.shop}</td>
                                    <td className="px-4 py-4 text-sm text-slate-200">{report.employeeName}</td>
                                    <td className="px-4 py-4 text-sm text-slate-300">{report.shift}</td>
                                    <td className={`px-4 py-4 text-sm ${report.isLate ? 'bg-red-900/60 text-red-300 font-semibold' : 'text-slate-300'}`}>{report.checkIn}</td>
                                    <td className="px-4 py-4 text-sm text-slate-300">{report.checkOut}</td>
                                    <td className={`px-4 py-4 text-sm text-center ${report.isOnLeave === 'Absent' ? 'text-red-400 font-semibold' : 'text-slate-300'}`}>{report.isOnLeave}</td>
                                    <td className="px-4 py-4 text-sm text-center text-slate-300">{report.otStatus}</td>
                                    <td className="px-4 py-4 text-center whitespace-nowrap">
                                        <div className="flex items-center justify-center gap-4">
                                            {(userProfile?.role === 'Admin' || userProfile?.role === 'CEO') && report.checkIn && !report.checkOut && (
                                                <Button variant="icon-add-time" icon="fa-clock" onClick={() => onAddCheckOut(report)} title="Add Check-Out"/>
                                            )}
                                            {(userProfile?.role === 'Admin' || userProfile?.role === 'CEO') && report.docIds.length > 0 && (
                                                <Button variant="icon-delete" icon="fa-trash" onClick={() => onDeleteRecord(report)} title="Delete" />
                                            )}
                                        </div>
                                    </td>
                                </tr>
                            ))}
                        </tbody>
                    </table>
                </div>
            );
        });

        // NEW: Phase 1 Refactoring - Work Day Report Filters Component
        // OPTIMIZATION: Updated to use standard PageHeader style internally
        const WorkDayReportFilters = memo(({
            userProfile, selectedShop, setSelectedShop, searchTerm, setSearchTerm, availableShops,
            filterType, setFilterType, selectedMonth, setSelectedMonth,
            selectedShift, setSelectedShift, uniqueShiftNames, onExportExcel
        }) => {
            return (
                <div className="flex flex-wrap gap-4 justify-between items-center mb-6">
                    <h3 className="text-xl font-semibold text-slate-100">Monthly Work Day Report</h3>
                    <div className="flex flex-wrap gap-4 items-center">
                        <ShopFilterSelect 
                            userProfile={userProfile}
                            shops={availableShops} // Pass pre-calculated allowed shops
                            selectedShop={selectedShop}
                            onChange={e => { setSelectedShop(e.target.value); setSearchTerm(''); }}
                        />

                        {userProfile?.role !== 'Staff' && (
                            <SearchInput 
                                value={searchTerm} 
                                onChange={e => setSearchTerm(e.target.value)} 
                                placeholder="Search staff..."
                            />
                        )}

                        <select value={filterType} onChange={e => setFilterType(e.target.value)} className="select w-full sm:w-auto">
                            <option value="thisMonth">This Month</option>
                            <option value="lastMonth">Last Month</option>
                            <option value="custom">Custom Month</option>
                        </select>
                        
                        {filterType === 'custom' && (
                            <input type="month" value={selectedMonth} onChange={e => setSelectedMonth(e.target.value)} className="input w-full sm:w-auto" />
                        )}
                        
                        <select value={selectedShift} onChange={e => setSelectedShift(e.target.value)} className="select w-full sm:w-auto">
                            <option value="">All Shifts</option>
                            {uniqueShiftNames.map(name => <option key={name} value={name}>{name}</option>)}
                        </select>
                        
                        <Button variant="success" icon="fa-file-excel" onClick={onExportExcel}>Excel</Button>
                    </div>
                </div>
            );
        });

        // NEW: Phase 1 Refactoring - Work Day Report Table Component
        const WorkDayReportTable = memo(({ workDayReport }) => {
            return (
                <div className="overflow-x-auto">
                    <table className="min-w-full divide-y divide-slate-700">
                        <thead className="bg-slate-900/50">
                            <tr>
                                <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Date</th>
                                <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Shop Name</th>
                                <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Staff Name</th>
                                <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">No. Work Day</th>
                                <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Given Off Day</th>
                                <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Total OT</th>
                                <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Total Leave No</th>
                                <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Total LATE</th>
                                <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">No-CheckOut</th>
                                <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">No-Absent</th>
                                <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Salary Day</th>
                            </tr>
                        </thead>
                        <tbody className="divide-y divide-slate-700">
                            {workDayReport.map((report, index) => (
                                <tr key={`${report.staffName}-${report.dueTime}-${index}`} className="hover:bg-slate-700/50">
                                    <td className="px-4 py-4 text-sm text-slate-200">{report.dueTime}</td>
                                    <td className="px-4 py-4 text-sm text-slate-300">{report.shopName}</td>
                                    <td className="px-4 py-4 text-sm text-slate-200">{report.staffName}</td>
                                    <td className="px-4 py-4 text-sm font-semibold text-blue-400">{report.workDays}</td>
                                    <td className="px-4 py-4 text-sm font-semibold text-cyan-400">{report.givenOffDays}</td>
                                    <td className="px-4 py-4 text-sm font-semibold text-green-400">{report.totalOT > 0 ? report.totalOT.toFixed(2) : 0}</td>
                                    <td className="px-4 py-4 text-sm font-semibold text-yellow-400">{report.totalLeave}</td>
                                    <td className="px-4 py-4 text-sm font-semibold text-red-400">{report.totalLate}</td>
                                    <td className="px-4 py-4 text-sm font-semibold text-orange-400">{report.noCheckOutCount}</td>
                                    <td className="px-4 py-4 text-sm font-semibold text-red-500">{report.noAbsentCount}</td>
                                    <td className="px-4 py-4 text-sm font-semibold text-indigo-400">{report.salaryDay.toFixed(2)}</td>
                                </tr>
                            ))}
                        </tbody>
                    </table>
                </div>
            );
        });

         const AttendanceReportPage = ({ userProfile }) => {
            const [activeTab, setActiveTab] = useState('daily');
            const { db } = useFirebase();
            const { where, query, collection, getDocs } = window.firebaseSDK;
            const [reportData, setReportData] = useState({ leaveRequests: [], otRequests: [] });
            const [loading, setLoading] = useState(false);

            // PHASE 3 OPTIMIZATION: For Admins/CEOs, we now fetch this data on-demand in the child components.
            const isRealTime = userProfile?.role !== 'Admin' && userProfile?.role !== 'CEO';
            
            const staffQueryConstraints = useMemo(() => {
                const { role, id, shop } = userProfile || {};
                if (role === 'Staff' && id) {
                    return [where("staffId", "==", id)];
                }
                if (role === 'Shop Manager') {
                    const managedShops = Array.isArray(shop) ? shop : (shop ? [shop] : []);
                    if (managedShops.length > 0) {
                        return [where("shop", "in", managedShops)];
                    }
                    return [where("staffId", "==", "null")]; // No shops assigned, so return no results.
                }
                return []; // Admin query is built on-demand.
            }, [userProfile]);
            
            // Real-time data for Staff/Managers
            const { data: realTimeLeaveRequests } = useCollection('leaveRequests', isRealTime ? staffQueryConstraints : []);
            const { data: realTimeOtRequests } = useCollection('otRequests', isRealTime ? staffQueryConstraints : []);
            
            // On-demand data for Admins (passed down)
            const leaveRequests = isRealTime ? realTimeLeaveRequests : reportData.leaveRequests;
            const otRequests = isRealTime ? realTimeOtRequests : reportData.otRequests;

            // MODIFIED: Define tabs with icons
            const tabs = { 
                daily: <span><i className="fas fa-calendar-day mr-2 text-blue-400"></i>Daily Report</span>, 
                monthly: <span><i className="fas fa-briefcase mr-2 text-green-400"></i>No. Work Day</span> 
            };

            return (
                <TabbedPage tabs={tabs} activeTab={activeTab} setActiveTab={setActiveTab}>
                    <div id="daily"><DailyReportTab userProfile={userProfile} leaveRequests={leaveRequests} otRequests={otRequests} setAdminReportData={setReportData} setLoadingAdminReport={setLoading} isAdminLoading={loading} /></div>
                    <div id="monthly"><WorkDayReportTab userProfile={userProfile} leaveRequests={leaveRequests} otRequests={otRequests} setAdminReportData={setReportData} setLoadingAdminReport={setLoading} isAdminLoading={loading} /></div>
                </TabbedPage>
            );
        };

        // NEW: Modal for manually adding a check-out time
        const ManualCheckOutModal = ({ isOpen, onClose, onSave, record }) => {
            const [checkOutTime, setCheckOutTime] = useState('');

            useEffect(() => {
                // Reset time when modal opens for a new record
                if (isOpen) {
                    setCheckOutTime('');
                }
            }, [isOpen]);
            
            const handleSubmit = (e) => {
                e.preventDefault();
                if (record && checkOutTime) {
                    onSave(record, checkOutTime);
                }
            };

            if (!record) return null;

            return (
                <Modal isOpen={isOpen} onClose={onClose} maxWidth="max-w-md">
                    <form onSubmit={handleSubmit}>
                        <ModalHeader title="Add Manual Check-Out" onClose={onClose} />
                        <ModalBody>
                            <div className="space-y-4">
                                <div>
                                    <label className="text-sm font-medium text-slate-400">Employee</label>
                                    <input value={record.employeeName} className="input" disabled />
                                </div>
                                <div>
                                    <label className="text-sm font-medium text-slate-400">Date</label>
                                    <input value={record.date} className="input" disabled />
                                </div>
                                <div>
                                    <label className="text-sm font-medium text-slate-400">Check-Out Time</label>
                                    <input
                                        type="time"
                                        value={checkOutTime}
                                        onChange={(e) => setCheckOutTime(e.target.value)}
                                        className="input"
                                        required
                                    />
                                </div>
                            </div>
                        </ModalBody>
                        <ModalFooter>
                            <Button variant="secondary" onClick={onClose}>Cancel</Button>
                            <Button type="submit" variant="primary">Save Check-Out</Button>
                        </ModalFooter>
                    </form>
                </Modal>
            );
        };

        const DailyReportTab = ({ userProfile, leaveRequests, otRequests, setAdminReportData, setLoadingAdminReport, isAdminLoading }) => {
            const { db } = useFirebase();
            const { where, query, collection, getDocs } = window.firebaseSDK;
            const [recordToDelete, setRecordToDelete] = useState(null);
            const [recordToCorrect, setRecordToCorrect] = useState(null);
            const [isCorrectionModalOpen, setCorrectionModalOpen] = useState(false);

            // Filters State
            const [selectedShop, setSelectedShop] = useState('');
            const [filterType, setFilterType] = useState('today');
            const [customMonth, setCustomMonth] = useState(new Date().toISOString().slice(0, 7));
            const [searchTerm, setSearchTerm] = useState('');
            const [selectedShift, setSelectedShift] = useState('');

            // Data State
            const { shops, employees, shifts } = useAppData();
            
            // NEW: Create a unique list of shift names for the filter dropdown to avoid duplicates.
            const uniqueShiftNames = useMemo(() => {
                if (!shifts) return [];
                const shiftNames = shifts.map(s => s.name);
                return [...new Set(shiftNames)].sort();
            }, [shifts]);
            
            // PHASE 3: Data state for Admin's one-time fetches
            const [adminAttendance, setAdminAttendance] = useState([]);
            
            // PHASE 2 & 3: Combined logic for fetching attendance data.
            const isRealTime = userProfile?.role !== 'Admin' && userProfile?.role !== 'CEO';
            const attendanceQueryConstraints = useMemo(() => {
                // This is ONLY for real-time listeners (Staff/Manager)
                if (!isRealTime) return []; 
                
                const { role, id, shop } = userProfile || {};
                if (role === 'Staff' && id) return [where("employeeId", "==", id)];
                
                if (role === 'Shop Manager') {
                    const managedShops = Array.isArray(shop) ? shop : (shop ? [shop] : []);
                    if (managedShops.length > 0) return [where("shop", "in", managedShops)];
                    return [where("employeeId", "==", "null")];
                }
                return []; // Should not happen for real-time
            }, [userProfile, isRealTime]);
            
            const { data: realTimeAttendance, loading: attendanceLoading } = useCollection('attendance', attendanceQueryConstraints);
            const attendance = isRealTime ? realTimeAttendance : adminAttendance;
            const isReportLoading = isRealTime ? attendanceLoading : isAdminLoading;
            
            // PHASE 3: ON-DEMAND DATA FETCHING FOR ADMIN (OPTIMIZED) ---
            useEffect(() => {
                if (userProfile?.role !== 'Admin' && userProfile?.role !== 'CEO') return;

                const fetchAdminData = async () => {
                    setLoadingAdminReport(true);
                    
                    const startDate = new Date();
                    const endDate = new Date();
                    
                    switch (filterType) {
                        case 'today': startDate.setHours(0, 0, 0, 0); endDate.setHours(23, 59, 59, 999); break;
                        case 'yesterday': startDate.setDate(startDate.getDate() - 1); startDate.setHours(0, 0, 0, 0); endDate.setDate(endDate.getDate() - 1); endDate.setHours(23, 59, 59, 999); break;
                        case 'thisMonth': startDate.setDate(1); startDate.setHours(0, 0, 0, 0); endDate.setMonth(endDate.getMonth() + 1); endDate.setDate(0); endDate.setHours(23, 59, 59, 999); break;
                        case 'lastMonth': startDate.setMonth(startDate.getMonth() - 1); startDate.setDate(1); startDate.setHours(0, 0, 0, 0); endDate.setDate(0); endDate.setHours(23, 59, 59, 999); break;
                        case 'custom': const [year, month] = customMonth.split('-').map(Number); if (year && month) { startDate.setFullYear(year, month - 1, 1); startDate.setHours(0, 0, 0, 0); endDate.setFullYear(year, month, 0); endDate.setHours(23, 59, 59, 999); } break;
                    }
                    
                    // --- OPTIMIZATION START: Server-Side Shop Filtering ---
                    // Instead of fetching ALL data and filtering in JS, we ask Firebase to filter for us.
                    // This drastically reduces download size and processing time.
                    
                    let attendanceQuery = query(collection(db, 'attendance'), where('timestamp', '>=', startDate), where('timestamp', '<=', endDate));
                    let leaveQuery = query(collection(db, 'leaveRequests'), where('returnDate', '>=', startDate.toISOString().slice(0, 10)));
                    let otQuery = query(collection(db, 'otRequests'), where('reqDate', '>=', startDate.toISOString().slice(0, 10)), where('reqDate', '<=', endDate.toISOString().slice(0, 10)));
                    
                    // Apply Shop Filter at the Database Level if a shop is selected
                    if (selectedShop) {
                        attendanceQuery = query(attendanceQuery, where('shop', '==', selectedShop));
                        leaveQuery = query(leaveQuery, where('shop', '==', selectedShop));
                        otQuery = query(otQuery, where('shop', '==', selectedShop));
                    }
                    // --- OPTIMIZATION END ---

                    try {
                        const [attSnap, leaveSnap, otSnap] = await Promise.all([
                            getDocs(attendanceQuery),
                            getDocs(leaveQuery),
                            getDocs(otQuery)
                        ]);
                        
                        // Client-side filtering is now lighter, primarily for search terms
                        const attendanceData = attSnap.docs.map(d => ({id: d.id, ...d.data()}))
                            .filter(rec => {
                                // Redundant shop check kept for safety, but DB handles heavy lifting
                                const shopMatch = !selectedShop || rec.shop === selectedShop;
                                const empMatch = !searchTerm || (rec.employeeName && rec.employeeName.toLowerCase().includes(searchTerm.toLowerCase()));
                                return shopMatch && empMatch;
                            });
                        setAdminAttendance(attendanceData);
                        
                        const leaveData = leaveSnap.docs.map(d => ({ id: d.id, ...d.data() }))
                            .filter(lr => {
                                const shopMatch = !selectedShop || lr.shop === selectedShop;
                                const empMatch = !searchTerm || (lr.staffName && lr.staffName.toLowerCase().includes(searchTerm.toLowerCase()));
                                const dateMatch = lr.leaveDate <= endDate.toISOString().slice(0, 10);
                                return shopMatch && empMatch && dateMatch;
                            });

                        const otData = otSnap.docs.map(d => ({id: d.id, ...d.data()}))
                             .filter(rec => {
                                const shopMatch = !selectedShop || rec.shop === selectedShop;
                                const empMatch = !searchTerm || (rec.staffName && rec.staffName.toLowerCase().includes(searchTerm.toLowerCase()));
                                return shopMatch && empMatch;
                            });
                        
                        setAdminReportData({
                            leaveRequests: leaveData,
                            otRequests: otData
                        });

                    } catch (error) {
                        console.error("Error fetching admin report data:", error);
                        if (error.code === 'failed-precondition') {
                            alert("Performance Optimization Required: Please check the browser console (F12) and click the Firebase Index creation link.");
                        }
                    } finally {
                        setLoadingAdminReport(false);
                    }
                };
                
                fetchAdminData();

            }, [userProfile, filterType, customMonth, selectedShop, searchTerm, db, setLoadingAdminReport, setAdminReportData]);

            // Set initial shop selection
            useEffect(() => {
                if (userProfile && userProfile.role !== 'Admin' && userProfile.role !== 'CEO') {
                    setSelectedShop(Array.isArray(userProfile.shop) ? '' : userProfile.shop || '');
                }
            }, [userProfile]);
            
            // OPTIMIZATION: Use centralized hook for shops
            const availableShops = useAllowedShops(userProfile, shops);

            const attendanceReport = useMemo(() => {
                const startDate = new Date();
                const endDate = new Date();

                // 1. Determine Date Range from Filters
                switch (filterType) {
                    case 'today': startDate.setHours(0, 0, 0, 0); endDate.setHours(23, 59, 59, 999); break;
                    case 'yesterday': startDate.setDate(startDate.getDate() - 1); startDate.setHours(0, 0, 0, 0); endDate.setDate(endDate.getDate() - 1); endDate.setHours(23, 59, 59, 999); break;
                    case 'thisMonth': startDate.setDate(1); startDate.setHours(0, 0, 0, 0); endDate.setMonth(endDate.getMonth() + 1); endDate.setDate(0); endDate.setHours(23, 59, 59, 999); break;
                    case 'lastMonth': startDate.setMonth(startDate.getMonth() - 1); startDate.setDate(1); startDate.setHours(0, 0, 0, 0); endDate.setDate(0); endDate.setHours(23, 59, 59, 999); break;
                    case 'custom': const [year, month] = customMonth.split('-').map(Number); if (year && month) { startDate.setFullYear(year, month - 1, 1); startDate.setHours(0, 0, 0, 0); endDate.setFullYear(year, month, 0); endDate.setHours(23, 59, 59, 999); } break;
                }

                // 2. Get a list of employees to report on, based on user role and filters.
                const relevantEmployees = employees.filter(emp => {
                    const employeeShops = Array.isArray(emp.shop) ? emp.shop : (emp.shop ? [emp.shop] : []);
                    const userManagedShops = Array.isArray(userProfile.shop) ? userProfile.shop : (userProfile.shop ? [userProfile.shop] : []);

                    let roleMatch = false;
                    if (userProfile.role === 'Admin' || userProfile.role === 'CEO') roleMatch = true;
                    else if (userProfile.role === 'Shop Manager') roleMatch = employeeShops.some(s => userManagedShops.includes(s));
                    else roleMatch = emp.id === userProfile.id;

                    const shopMatch = !selectedShop || employeeShops.includes(selectedShop);
                    const shiftMatch = !selectedShift || emp.shift === selectedShift;
                    const searchMatch = !searchTerm || emp.name.toLowerCase().includes(searchTerm.toLowerCase());
                    return emp.status === 'Active' && roleMatch && shopMatch && searchMatch && shiftMatch && emp.role !== 'Admin' && emp.role !== 'CEO';
                });
                
                const relevantEmployeeIds = new Set(relevantEmployees.map(e => e.id));

                // 3. Process ONLY the available attendance data.
                const reportMap = new Map();
                attendance.forEach(record => {
                    if (!relevantEmployeeIds.has(record.employeeId)) return;
                    
                    if (!record.timestamp) return;
                    const recordDate = record.timestamp.toDate();
                    if (!(recordDate >= startDate && recordDate <= endDate)) return;

                    const recordShop = shops.find(s => s.name === record.shop);
                    const { localDate: dateKey } = Utils.formatDateInTimezone(record.timestamp, recordShop?.timezone);
                    const reportKey = `${record.employeeId}_${dateKey}`;

                    if (!reportMap.has(reportKey)) {
                        reportMap.set(reportKey, {
                            date: dateKey,
                            employeeId: record.employeeId,
                            checkInRecords: [],
                            checkOutRecords: [],
                            docIds: []
                        });
                    }
                    
                    const entry = reportMap.get(reportKey);
                    const recordData = { date: record.timestamp.toDate(), shop: record.shop };
                    if (record.type === 'in') entry.checkInRecords.push(recordData);
                    if (record.type === 'out') entry.checkOutRecords.push(recordData);
                    entry.docIds.push(record.id);
                });

                // 4. Intelligently add absent days for past and present dates.
                const today = new Date();
                today.setHours(0,0,0,0);
                const currentDate = new Date(startDate);
                
                while(currentDate <= endDate && currentDate <= today) {
                    const dateKey = `${currentDate.getFullYear()}-${String(currentDate.getMonth() + 1).padStart(2, '0')}-${String(currentDate.getDate()).padStart(2, '0')}`;
                    for (const employee of relevantEmployees) {
                         const reportKey = `${employee.id}_${dateKey}`;
                         if (!reportMap.has(reportKey)) {
                            reportMap.set(reportKey, {
                                date: dateKey, employeeId: employee.id,
                                checkInRecords: [], checkOutRecords: [], docIds: []
                            });
                         }
                    }
                    currentDate.setDate(currentDate.getDate() + 1);
                }

                // 5. Finalize calculations for each entry.
                const reportArray = Array.from(reportMap.values()).map(entry => {
                    const employee = employees.find(e => e.id === entry.employeeId);
                    if (!employee) return null;

                    const firstCheckInRecord = entry.checkInRecords.length > 0
                        ? entry.checkInRecords.reduce((earliest, current) => current.date < earliest.date ? current : earliest)
                        : null;
                    const lastCheckOutRecord = entry.checkOutRecords.length > 0
                        ? entry.checkOutRecords.reduce((latest, current) => current.date > latest.date ? current : latest)
                        : null;

                    const checkIn = firstCheckInRecord ? firstCheckInRecord.date : null;
                    const checkOut = lastCheckOutRecord ? lastCheckOutRecord.date : null;
                    
                    const shopDetails = shops.find(s => s.name === (firstCheckInRecord?.shop || (Array.isArray(employee.shop) ? employee.shop[0] : employee.shop)));
                    const shopTimezone = shopDetails?.timezone;

                    let isLate = false;
                    if (checkIn && employee) {
                        const shiftDetails = (shifts || []).find(s => s.name === employee.shift && s.shopName === firstCheckInRecord.shop);
                        if (shiftDetails?.lateThreshold) {
                            const [lateHour, lateMinute] = shiftDetails.lateThreshold.split(':').map(Number);
                            const timeInZoneString = checkIn.toLocaleTimeString('en-GB', { timeZone: shopTimezone, hour: '2-digit', minute: '2-digit' });
                            const [checkInHour, checkInMinute] = timeInZoneString.split(':').map(Number);
                            if (checkInHour > lateHour || (checkInHour === lateHour && checkInMinute > lateMinute)) {
                                isLate = true;
                            }
                        }
                    }

                    const approvedLeave = leaveRequests.find(lr => lr.staffId === employee.id && lr.status === 'Approved' && entry.date >= lr.leaveDate && entry.date < lr.returnDate);
                    let isOnLeave;

                    if (approvedLeave) {
                        isOnLeave = approvedLeave.leaveSession === 'Full Day' ? 'Y-Full Day' : `Y-${approvedLeave.leaveSession}`;
                    } else if (checkIn || checkOut) {
                        isOnLeave = 'N';
                    } else {
                        if (isReportLoading) {
                            isOnLeave = '-';
                        } else {
                            isOnLeave = 'Absent';
                        }
                    }

                    const isOnOT = otRequests.some(ot => ot.staffId === employee.id && ot.status === 'Approved' && ot.reqDate === entry.date);
                    const otStatus = isOnOT ? 'Y' : 'N';
                    
                    const { localTime: checkInTimeStr } = checkIn ? Utils.formatDateInTimezone({ toDate: () => checkIn }, shopTimezone) : { localTime: '' };
                    const { localTime: checkOutTimeStr } = checkOut ? Utils.formatDateInTimezone({ toDate: () => checkOut }, shopTimezone) : { localTime: '' };
                    
                    let shopDisplay = Array.isArray(employee.shop) ? employee.shop.join(', ') : employee.shop;
                    if (firstCheckInRecord && lastCheckOutRecord) {
                        if (firstCheckInRecord.shop === lastCheckOutRecord.shop) {
                            shopDisplay = firstCheckInRecord.shop;
                        } else {
                            shopDisplay = `${firstCheckInRecord.shop} (In) → ${lastCheckOutRecord.shop} (Out)`;
                        }
                    } else if (firstCheckInRecord) {
                        shopDisplay = firstCheckInRecord.shop;
                    } else if (lastCheckOutRecord) {
                        shopDisplay = lastCheckOutRecord.shop;
                    }

                    return {
                        date: entry.date,
                        employeeId: employee.id,
                        employeeName: employee.name,
                        shop: shopDisplay,
                        shift: employee.shift,
                        checkIn: checkInTimeStr,
                        checkOut: checkOutTimeStr,
                        isLate, isOnLeave, otStatus, docIds: entry.docIds
                    };
                }).filter(Boolean);
                
                return reportArray.sort((a, b) => (a.shop || '').localeCompare(b.shop || '') || b.date.localeCompare(a.date) || a.employeeName.localeCompare(b.employeeName));
            }, [attendance, selectedShop, filterType, customMonth, searchTerm, employees, leaveRequests, otRequests, selectedShift, shops, shifts, userProfile, isReportLoading]);

            const handleDelete = async () => {
                if (!recordToDelete?.docIds) return;
                const { doc, writeBatch } = window.firebaseSDK;
                const batch = writeBatch(db);
                recordToDelete.docIds.forEach(id => batch.delete(doc(db, 'attendance', id)));
                try { await batch.commit(); } catch (error) { console.error("Error deleting attendance records: ", error); } 
                finally { setRecordToDelete(null); }
            };

            const handleOpenCorrectionModal = useCallback((record) => {
                setRecordToCorrect(record);
                setCorrectionModalOpen(true);
            }, []);

            const handleCloseCorrectionModal = useCallback(() => {
                setRecordToCorrect(null);
                setCorrectionModalOpen(false);
            }, []);
            
            const handleSaveCheckOut = useCallback(async (record, time) => {
                const { addDoc, collection } = window.firebaseSDK;
                const [hour, minute] = time.split(':');
                const checkOutDateTime = new Date(`${record.date}T${time}:00`);

                try {
                    const newDocRef = await addDoc(collection(db, 'attendance'), {
                        employeeId: record.employeeId,
                        employeeName: record.employeeName,
                        shop: record.shop,
                        timestamp: checkOutDateTime,
                        type: 'out',
                        location: { manualEntry: true, note: 'Added by Admin' }
                    });

                    if (userProfile?.role === 'Admin' || userProfile?.role === 'CEO') {
                        const newRecordForState = {
                            id: newDocRef.id,
                            employeeId: record.employeeId,
                            employeeName: record.employeeName,
                            shop: record.shop,
                            timestamp: { toDate: () => checkOutDateTime },
                            type: 'out',
                            location: { manualEntry: true, note: 'Added by Admin' }
                        };
                        setAdminAttendance(prev => [...prev, newRecordForState]);
                    }
                    handleCloseCorrectionModal();
                } catch (error) {
                    console.error("Error saving manual check-out:", error);
                    alert("Failed to save the manual check-out time.");
                }
            }, [db, handleCloseCorrectionModal, userProfile]);

            const handleExportExcel = useCallback(() => {
                const dataToExport = attendanceReport.map(report => ({
                    'Date': report.date,
                    'Shop Name': report.shop,
                    'Staff Name': report.employeeName,
                    'Shift': report.shift,
                    'Check In': report.checkIn,
                    'Check Out': report.checkOut,
                    'On Leave': report.isOnLeave,
                    'OT Status': report.otStatus,
                    'Late Check-In': report.isLate ? 'Yes' : 'No'
                }));

                const getReportFilename = () => {
                    const todayStr = new Date().toISOString().slice(0, 10);
                    switch (filterType) {
                        case 'today': return `Daily_Attendance_Report_Today_${todayStr}.xlsx`;
                        case 'yesterday': 
                            const yesterday = new Date();
                            yesterday.setDate(yesterday.getDate() - 1);
                            return `Daily_Attendance_Report_Yesterday_${yesterday.toISOString().slice(0, 10)}.xlsx`;
                        case 'thisMonth': return `Daily_Attendance_Report_ThisMonth_${new Date().toISOString().slice(0, 7)}.xlsx`;
                        case 'lastMonth': 
                            const lastMonth = new Date();
                            lastMonth.setMonth(lastMonth.getMonth() - 1);
                            return `Daily_Attendance_Report_LastMonth_${lastMonth.toISOString().slice(0, 7)}.xlsx`;
                        case 'custom': return `Daily_Attendance_Report_${customMonth}.xlsx`;
                        default: return 'Daily_Attendance_Report.xlsx';
                    }
                };

                const worksheet = XLSX.utils.json_to_sheet(dataToExport);
                const workbook = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(workbook, worksheet, "Daily Attendance");

                worksheet["!cols"] = [ { wch: 12 }, { wch: 15 }, { wch: 25 }, { wch: 10 }, { wch: 15 }, { wch: 15 }, { wch: 15 }, { wch: 12 }, { wch: 15 } ];
                
                XLSX.writeFile(workbook, getReportFilename());
            }, [attendanceReport, filterType, customMonth]);

            return (
                <Card>
                    <DailyReportFilters
                        userProfile={userProfile}
                        selectedShop={selectedShop}
                        setSelectedShop={setSelectedShop}
                        searchTerm={searchTerm}
                        setSearchTerm={setSearchTerm}
                        availableShops={availableShops}
                        filterType={filterType}
                        setFilterType={setFilterType}
                        customMonth={customMonth}
                        setCustomMonth={setCustomMonth}
                        selectedShift={selectedShift}
                        setSelectedShift={setSelectedShift}
                        uniqueShiftNames={uniqueShiftNames}
                        onExportExcel={handleExportExcel}
                    />
                    <DailyReportTable
                        attendanceReport={attendanceReport}
                        userProfile={userProfile}
                        onAddCheckOut={handleOpenCorrectionModal}
                        onDeleteRecord={setRecordToDelete}
                    />
                    <ConfirmationModal isOpen={!!recordToDelete} onClose={() => setRecordToDelete(null)} onConfirm={handleDelete} title="Delete Attendance Record" message={`Are you sure you want to delete all attendance records for ${recordToDelete?.employeeName} on ${recordToDelete?.date}? This action cannot be undone.`} />
                    <ManualCheckOutModal isOpen={isCorrectionModalOpen} onClose={handleCloseCorrectionModal} onSave={handleSaveCheckOut} record={recordToCorrect} />
                </Card>
            );
        };
        
        const WorkDayReportTab = ({ userProfile, leaveRequests, otRequests, setAdminReportData, setLoadingAdminReport, isAdminLoading }) => {
            const { db } = useFirebase();
            const { where, query, collection, getDocs } = window.firebaseSDK;

            // Filter States
            const [selectedShop, setSelectedShop] = useState('');
            const [filterType, setFilterType] = useState('thisMonth');
            const [selectedMonth, setSelectedMonth] = useState(new Date().toISOString().slice(0, 7));
            const [searchTerm, setSearchTerm] = useState('');
            const [selectedShift, setSelectedShift] = useState('');

            // Data States
            const { shops, employees, shifts } = useAppData();

            // NEW: Get unique shift names for the filter dropdown
            const uniqueShiftNames = useMemo(() => {
                if (!shifts) return [];
                const shiftNames = shifts.map(s => s.name);
                return [...new Set(shiftNames)].sort();
            }, [shifts]);
            
            // PHASE 3: Data states for Admin's one-time fetches
            const [adminAttendance, setAdminAttendance] = useState([]);
            const [adminEmployeeStates, setAdminEmployeeStates] = useState([]);

            // PHASE 2 & 3: Combined logic for fetching data.
            const isRealTime = userProfile?.role !== 'Admin' && userProfile?.role !== 'CEO';
            
            const realTimeQueryConstraints = useMemo(() => {
                if (!isRealTime) return { attendance: [], employeeStates: [] };
                const { role, id, shop } = userProfile || {};
                
                let attendanceCons = [], statesCons = [];

                if (role === 'Staff' && id) {
                    attendanceCons = [where("employeeId", "==", id)];
                    statesCons = [where("staffId", "==", id)];
                } else if (role === 'Shop Manager') {
                    const managedShops = Array.isArray(shop) ? shop : (shop ? [shop] : []);
                    if (managedShops.length > 0) {
                        attendanceCons = [where("shop", "in", managedShops)];
                        statesCons = [where("shop", "in", managedShops)];
                    } else {
                        attendanceCons = [where("employeeId", "==", "null")];
                        statesCons = [where("staffId", "==", "null")];
                    }
                }
                return { attendance: attendanceCons, employeeStates: statesCons };
            }, [userProfile, isRealTime]);

            const { data: realTimeAttendance } = useCollection('attendance', realTimeQueryConstraints.attendance);
            const { data: realTimeEmployeeStates } = useCollection('employeeStates', realTimeQueryConstraints.employeeStates);
            
            const attendance = isRealTime ? realTimeAttendance : adminAttendance;
            const employeeStates = isRealTime ? realTimeEmployeeStates : adminEmployeeStates;

             // --- PHASE 3: ON-DEMAND DATA FETCHING FOR ADMIN ---
            useEffect(() => {
                if (userProfile?.role !== 'Admin' && userProfile?.role !== 'CEO') return;

                const fetchAdminData = async () => {
                    setLoadingAdminReport(true);
                    
                    let targetMonth;
                    const now = new Date();
                    switch (filterType) {
                        case 'lastMonth':
                            const lastMonthDate = new Date(now.getFullYear(), now.getMonth() - 1, 1);
                            const year_lm = lastMonthDate.getFullYear();
                            const month_lm = String(lastMonthDate.getMonth() + 1).padStart(2, '0');
                            targetMonth = `${year_lm}-${month_lm}`;
                            break;
                        case 'custom': targetMonth = selectedMonth; break;
                        default: targetMonth = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`; break;
                    }

                    const startDate = `${targetMonth}-01`;
                    const endDate = `${targetMonth}-31`; 

                    // --- OPTIMIZATION START: Server-Side Shop Filtering for Monthly Report ---
                    let attendanceQuery = query(collection(db, 'attendance'), where('timestamp', '>=', new Date(startDate)), where('timestamp', '<=', new Date(endDate + "T23:59:59")));
                    let statesQuery = query(collection(db, 'employeeStates'), where('date', '>=', startDate), where('date', '<=', endDate));
                    let leaveQuery = query(collection(db, 'leaveRequests'), where('returnDate', '>=', startDate));
                    let otQuery = query(collection(db, 'otRequests'), where('reqDate', '>=', startDate), where('reqDate', '<=', endDate));
                    
                    // Apply Shop Filter at the Database Level if a shop is selected
                    if (selectedShop) {
                        attendanceQuery = query(attendanceQuery, where('shop', '==', selectedShop));
                        statesQuery = query(statesQuery, where('shop', '==', selectedShop));
                        leaveQuery = query(leaveQuery, where('shop', '==', selectedShop));
                        otQuery = query(otQuery, where('shop', '==', selectedShop));
                    }
                    // --- OPTIMIZATION END ---
                    
                    try {
                        const [attSnap, statesSnap, leaveSnap, otSnap] = await Promise.all([ getDocs(attendanceQuery), getDocs(statesQuery), getDocs(leaveQuery), getDocs(otQuery) ]);
                        
                        const attendanceData = attSnap.docs.map(d => ({id: d.id, ...d.data()}))
                            .filter(rec => {
                                const shopMatch = !selectedShop || rec.shop === selectedShop;
                                const empMatch = !searchTerm || (rec.employeeName && rec.employeeName.toLowerCase().includes(searchTerm.toLowerCase()));
                                return shopMatch && empMatch;
                            });
                        setAdminAttendance(attendanceData);

                        const statesData = statesSnap.docs.map(d => ({id: d.id, ...d.data()}))
                            .filter(rec => {
                                const shopMatch = !selectedShop || rec.shop === selectedShop;
                                const empMatch = !searchTerm || (rec.staffName && rec.staffName.toLowerCase().includes(searchTerm.toLowerCase()));
                                return shopMatch && empMatch;
                            });
                        setAdminEmployeeStates(statesData);
                        
                        const leaveData = leaveSnap.docs.map(d => ({ id: d.id, ...d.data() }))
                            .filter(lr => {
                                const shopMatch = !selectedShop || lr.shop === selectedShop;
                                const empMatch = !searchTerm || (lr.staffName && lr.staffName.toLowerCase().includes(searchTerm.toLowerCase()));
                                // FIX: Client-side check for overlap: starts before end of month
                                const dateMatch = lr.leaveDate <= endDate;
                                return shopMatch && empMatch && dateMatch;
                            });
                        
                        const otData = otSnap.docs.map(d => ({id: d.id, ...d.data()}))
                             .filter(rec => {
                                const shopMatch = !selectedShop || rec.shop === selectedShop;
                                const empMatch = !searchTerm || (rec.staffName && rec.staffName.toLowerCase().includes(searchTerm.toLowerCase()));
                                return shopMatch && empMatch;
                            });

                        setAdminReportData({
                            leaveRequests: leaveData,
                            otRequests: otData
                        });

                    } catch (error) {
                        console.error("Error fetching admin work day report data:", error);
                        if (error.code === 'failed-precondition') {
                            alert("Performance Optimization Required: Please check the browser console (F12) and click the Firebase Index creation link.");
                        }
                    } finally {
                        setLoadingAdminReport(false);
                    }
                };
                
                fetchAdminData();

            }, [userProfile, filterType, selectedMonth, selectedShop, searchTerm, db, setLoadingAdminReport, setAdminReportData]);

            // Set initial shop selection
            useEffect(() => {
                if (userProfile && userProfile.role !== 'Admin' && userProfile.role !== 'CEO') {
                    setSelectedShop(Array.isArray(userProfile.shop) ? '' : userProfile.shop || '');
                }
            }, [userProfile]);

            // OPTIMIZATION: Use centralized hook for shops
            const availableShops = useAllowedShops(userProfile, shops);

            const workDayReport = useMemo(() => {
                let targetMonth;
                const now = new Date();
                switch (filterType) {
                    case 'lastMonth':
                        const lastMonthDate = new Date(now.getFullYear(), now.getMonth() - 1, 1);
                        const year_lm = lastMonthDate.getFullYear();
                        const month_lm = String(lastMonthDate.getMonth() + 1).padStart(2, '0');
                        targetMonth = `${year_lm}-${month_lm}`;
                        break;
                    case 'custom':
                        targetMonth = selectedMonth;
                        break;
                    case 'thisMonth':
                    default:
                        const year_tm = now.getFullYear();
                        const month_tm = String(now.getMonth() + 1).padStart(2, '0');
                        targetMonth = `${year_tm}-${month_tm}`;
                        break;
                }

                // 1. Determine which employees to generate a report for based on filters
                const employeesToReportOn = employees.filter(emp => {
                    if (emp.status !== 'Active') return false;

                    const employeeShops = Array.isArray(emp.shop) ? emp.shop : (emp.shop ? [emp.shop] : []);
                    const userManagedShops = Array.isArray(userProfile.shop) ? userProfile.shop : (userProfile.shop ? [userProfile.shop] : []);

                    let roleMatch = false;
                    if (userProfile.role === 'Admin' || userProfile.role === 'CEO') roleMatch = true;
                    else if (userProfile.role === 'Shop Manager') roleMatch = employeeShops.some(s => userManagedShops.includes(s));
                    else roleMatch = emp.id === userProfile.id; // Staff see only themselves
                    
                    const shopFilterMatch = !selectedShop || employeeShops.includes(selectedShop);
                    const employeeFilterMatch = !searchTerm || emp.name.toLowerCase().includes(searchTerm.toLowerCase());
                    const shiftFilterMatch = !selectedShift || emp.shift === selectedShift;

                    return roleMatch && shopFilterMatch && employeeFilterMatch && shiftFilterMatch && emp.role !== 'Admin' && emp.role !== 'CEO';
                });
                
                // 2. Generate a report row for each of those employees
                const report = employeesToReportOn.map(employee => {
                    const employeeShopName = employee.primaryShop 
                        ? employee.primaryShop 
                        : (Array.isArray(employee.shop) ? employee.shop[0] : employee.shop);

                    const employeeShop = shops.find(s => s.name === employeeShopName);
                    const employeeShopTimezone = employeeShop?.timezone;

                    const monthAttendance = (attendance || []).filter(r => {
                        if (r.employeeId !== employee.id) return false;
                        if (!r.timestamp || !r.timestamp.toDate) return false;
                        const { localDate } = Utils.formatDateInTimezone(r.timestamp, employeeShopTimezone);
                        return localDate.startsWith(targetMonth);
                    });
                    const monthLeave = leaveRequests.filter(r => r.staffId === employee.id && r.status === 'Approved' && r.leaveDate.startsWith(targetMonth));
                    const monthOT = otRequests.filter(r => r.staffId === employee.id && r.status === 'Approved' && r.reqDate.startsWith(targetMonth));
                    const monthStates = employeeStates.filter(r => r.staffId === employee.id && r.date.startsWith(targetMonth));

                    const totalLeave = monthLeave.reduce((sum, r) => sum + (parseFloat(r.numberOfDays) || 0), 0);
                    const totalOT = monthOT.reduce((sum, r) => sum + (parseFloat(r.numberOfOTDays) || 0), 0);
                    const totalLate = monthStates.filter(es => es.statusState === 'Deduction' && es.note?.includes('CheckIn Late @')).length;
                    
                    const dailyRecords = {};
                    monthAttendance.forEach(rec => {
                        const { localDate: dayKey } = Utils.formatDateInTimezone(rec.timestamp, employeeShopTimezone);
                        if (!dailyRecords[dayKey]) dailyRecords[dayKey] = [];
                        dailyRecords[dayKey].push({ date: rec.timestamp.toDate(), type: rec.type });
                    });
                    
                    let workDays = 0;
                    let noCheckOutCount = 0;
                    const { localDate: todayStr } = Utils.formatDateInTimezone({ toDate: () => new Date() }, employeeShopTimezone);

                    Object.entries(dailyRecords).forEach(([dayKey, dayRecs]) => {
                        const ins = dayRecs.filter(r => r.type === 'in').sort((a,b) => a.date - b.date);
                        const outs = dayRecs.filter(r => r.type === 'out').sort((a,b) => b.date - a.date);
                        if (ins.length > 0 && outs.length > 0) {
                            const diffHours = (outs[0].date.getTime() - ins[0].date.getTime()) / 3600000;
                            if (diffHours >= 7) workDays += 1;
                            else if (diffHours >= 4) workDays += 0.5;
                        } else if (ins.length > 0 && dayKey < todayStr) {
                            noCheckOutCount += 1;
                        }
                    });

                    const [year, month] = targetMonth.split('-').map(Number);
                    const daysInMonth = new Date(year, month, 0).getDate();
                    const attendedDays = new Set(Object.keys(dailyRecords));
                    let noAbsentCount = 0;

                    for (let day = 1; day <= daysInMonth; day++) {
                        const dayKey = `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                        if (dayKey >= todayStr) break;
                        if (!attendedDays.has(dayKey)) {
                            const isOnLeave = monthLeave.some(lr => dayKey >= lr.leaveDate && dayKey < lr.returnDate);
                            if (!isOnLeave) noAbsentCount++;
                        }
                    }

                    const givenOffDays = Math.floor(workDays / 6.5);
                    const [reportYear, reportMonth] = targetMonth.split('-');
                    const salaryDay = workDays + givenOffDays + totalOT;

                    return { 
                        dueTime: `${reportMonth}-${reportYear.substring(2)}`, 
                        shopName: employeeShopName, 
                        staffName: employee.name, 
                        workDays, 
                        givenOffDays, 
                        totalOT, 
                        totalLeave, 
                        totalLate, 
                        noCheckOutCount, 
                        noAbsentCount, 
                        salaryDay,
                    };
                });
                
                return report.sort((a, b) => (a.shopName || '').localeCompare(b.shopName || '') || (a.staffName || '').localeCompare(b.staffName || ''));

            }, [attendance, leaveRequests, otRequests, employeeStates, employees, shops, filterType, selectedMonth, selectedShop, searchTerm, userProfile, selectedShift]);

            const handleExportExcel = useCallback(() => {
                const dataToExport = workDayReport.map(rec => ({
                    'Due Time (MM-YY)': rec.dueTime,
                    'Shop Name': rec.shopName,
                    'Staff Name': rec.staffName,
                    'No. Work Day': rec.workDays,
                    'Given Off Day': rec.givenOffDays,
                    'Total OT': rec.totalOT,
                    'Total Leave No': rec.totalLeave,
                    'Total LATE': rec.totalLate,
                    'No-CheckOut': rec.noCheckOutCount,
                    'No-Absent': rec.noAbsentCount,
                    'Salary Day': rec.salaryDay,
                }));

                const getReportFilename = () => {
                    const now = new Date();
                    switch (filterType) {
                        case 'thisMonth':
                            const year_tm = now.getFullYear();
                            const month_tm = String(now.getMonth() + 1).padStart(2, '0');
                            return `Monthly_Work_Day_Report_${year_tm}-${month_tm}.xlsx`;
                        case 'lastMonth': 
                            const lastMonthDate = new Date(now.getFullYear(), now.getMonth() - 1, 1);
                            const year_lm = lastMonthDate.getFullYear();
                            const month_lm = String(lastMonthDate.getMonth() + 1).padStart(2, '0');
                            return `Monthly_Work_Day_Report_${year_lm}-${month_lm}.xlsx`;
                        case 'custom': return `Monthly_Work_Day_Report_${selectedMonth}.xlsx`;
                        default: return 'Monthly_Work_Day_Report.xlsx';
                    }
                };

                const worksheet = XLSX.utils.json_to_sheet(dataToExport);
                const workbook = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(workbook, worksheet, "Monthly Work Day Report");
                
                worksheet["!cols"] = [ { wch: 18 }, { wch: 20 }, { wch: 25 }, { wch: 15 }, { wch: 15 }, { wch: 15 }, { wch: 15 }, { wch: 15 }, { wch: 15 }, { wch: 15 }, { wch: 15 } ];
                
                XLSX.writeFile(workbook, getReportFilename());
            }, [workDayReport, filterType, selectedMonth]);

            return (
                <Card>
                    <WorkDayReportFilters
                        userProfile={userProfile}
                        selectedShop={selectedShop}
                        setSelectedShop={setSelectedShop}
                        searchTerm={searchTerm}
                        setSearchTerm={setSearchTerm}
                        availableShops={availableShops}
                        filterType={filterType}
                        setFilterType={setFilterType}
                        selectedMonth={selectedMonth}
                        setSelectedMonth={setSelectedMonth}
                        selectedShift={selectedShift}
                        setSelectedShift={setSelectedShift}
                        uniqueShiftNames={uniqueShiftNames}
                        onExportExcel={handleExportExcel}
                    />
                    <WorkDayReportTable workDayReport={workDayReport} />
                </Card>
            );
        };
        // --- END ATTENDANCE REPORT PAGE ---

        // --- START PAYROLL PAGE (RESTORED) ---
        // A dedicated component for rendering the payslip.
        const PayslipPreview = memo(({ selectedEmployee, selectedMonth, manualInputs, calculations, isRecalculated, originalRecord }) => {
            const getChangeIndicatorClass = (newValue, oldValue) => {
                if (!isRecalculated || oldValue === undefined || newValue === oldValue) return ''; 
                if (typeof newValue === 'number' && typeof oldValue === 'number') {
                    if (newValue > oldValue) return 'text-green-600 font-bold'; 
                    if (newValue < oldValue) return 'text-red-600 font-bold';   
                }
                return 'text-yellow-600 font-bold'; 
            };

            const oldCalcs = originalRecord?.calculations || {};
            const oldInputs = originalRecord?.manualInputs || {};

            return (
                <div id="payslip-preview" className="bg-white text-slate-800 p-6 rounded-lg shadow-2xl font-sans">
                    <div className="text-center mb-6">
                        <h2 className="text-2xl font-bold">PAYSLIP</h2>
                        <p className="text-slate-500">For the month of {selectedMonth}</p>
                    </div>
                    {selectedEmployee ? (
                    <>
                        <div className="grid grid-cols-2 gap-4 mb-6 text-sm">
                            <div>
                                <p className="font-bold">{selectedEmployee.name}</p>
                                <p>{selectedEmployee.position}</p>
                                <p>Shift: {selectedEmployee.shift}</p>
                            </div>
                            <div className="text-right">
                                <p>Shop: {Array.isArray(selectedEmployee.shop) ? selectedEmployee.shop.join(', ') : selectedEmployee.shop}</p>
                                <p>Base Salary: {Utils.formatCurrency(calculations.baseSalary)}</p>
                                <p>Worked Dur.: {Utils.calculateWorkedDuration(selectedEmployee.joinedDate)}</p>
                            </div>
                        </div>
                        <div className="grid grid-cols-2 gap-6">
                            <div className="space-y-2 p-4 border-t-4 border-green-500 bg-green-50 rounded-b-lg">
                                <h3 className="text-lg font-semibold text-slate-900">Earnings</h3>
                                <div className="flex justify-between text-sm"><p>Work Days</p><p className={getChangeIndicatorClass(manualInputs.workDays, oldInputs.workDays)}>{manualInputs.workDays || 0}</p></div>
                                <div className="flex justify-between text-sm"><p>Given Off Days</p><p className={getChangeIndicatorClass(manualInputs.givenOffDays, oldInputs.givenOffDays)}>{manualInputs.givenOffDays || 0}</p></div>
                                <div className="flex justify-between text-sm pt-2 border-t border-slate-200"><p>Salary Earned</p><p className={getChangeIndicatorClass(calculations.baseSalaryEarned, oldCalcs.baseSalaryEarned)}>{Utils.formatCurrency(calculations.baseSalaryEarned)}</p></div>
                                <div className="flex justify-between text-sm"><p>OT Salary ({manualInputs.otDays || 0})</p><p className={getChangeIndicatorClass(calculations.otSalary, oldCalcs.otSalary)}>{Utils.formatCurrency(calculations.otSalary)}</p></div>
                                <div className="flex justify-between text-sm"><p>Engagements</p><p className={getChangeIndicatorClass(calculations.engagements, oldCalcs.engagements)}>{Utils.formatCurrency(calculations.engagements)}</p></div>
                                
                                {calculations.totalSavingsWithdrawal > 0 && (
                                    <div className="flex justify-between text-sm text-indigo-700 font-semibold" title="Savings Program Payback">
                                        <p>Savings Payback</p>
                                        <p className={getChangeIndicatorClass(calculations.totalSavingsWithdrawal, oldCalcs.totalSavingsWithdrawal)}>{Utils.formatCurrency(calculations.totalSavingsWithdrawal)}</p>
                                    </div>
                                )}

                                <div className="flex justify-between font-bold pt-2 border-t border-slate-300"><p>Gross Salary</p><p className={getChangeIndicatorClass(calculations.grossSalary, oldCalcs.grossSalary)}>{Utils.formatCurrency(calculations.grossSalary)}</p></div>
                            </div>
                            <div className="space-y-2 p-4 border-t-4 border-red-500 bg-red-50 rounded-b-lg">
                                <h3 className="text-lg font-semibold text-slate-900">Deductions</h3>
                                <div className="flex justify-between text-sm"><p>Leave Days</p><p className={`text-red-600 ${getChangeIndicatorClass(manualInputs.leaveDays, oldInputs.leaveDays)}`}>-{manualInputs.leaveDays || 0}</p></div>
                                <div className="flex justify-between text-sm"><p>Late ({manualInputs.totalLateDays || 0})</p><p className={getChangeIndicatorClass(calculations.lateDeductionsAmount, oldCalcs.lateDeductionsAmount)}>{Utils.formatCurrency(calculations.lateDeductionsAmount)}</p></div>
                                <div className="flex justify-between text-sm" title="Absent + No-CheckOut"><p>No-Attendance</p><p className={getChangeIndicatorClass(manualInputs.noAttendance, oldInputs.noAttendance)}>{manualInputs.noAttendance || 0}</p></div>
                                <div className="flex justify-between text-sm"><p>Loan Deduction</p><p className={getChangeIndicatorClass(manualInputs.loanDeduction, oldInputs.loanDeduction)}>{Utils.formatCurrency(manualInputs.loanDeduction)}</p></div>
                                <div className="flex justify-between text-sm"><p>Other Deductions</p><p className={getChangeIndicatorClass(calculations.otherDeductions, oldCalcs.otherDeductions)}>{Utils.formatCurrency(calculations.otherDeductions)}</p></div>
                                {calculations.rejectedLeavePenaltyAmount > 0 && (
                                    <div className="flex justify-between text-sm text-red-700 font-semibold" title="Penalty: Absence on a day with a rejected leave request. (Salary Per Day x 2)">
                                        <p>Penalty Leave Rejected</p>
                                        <p className={getChangeIndicatorClass(calculations.rejectedLeavePenaltyAmount, oldCalcs.rejectedLeavePenaltyAmount)}>{Utils.formatCurrency(calculations.rejectedLeavePenaltyAmount)}</p>
                                    </div>
                                )}
                                {calculations.savingsDeduction > 0 && (
                                    <div className="flex justify-between text-sm text-blue-700 font-semibold" title="Voluntary Savings Program">
                                        <p>Savings Deduction</p>
                                        <p className={getChangeIndicatorClass(calculations.savingsDeduction, oldCalcs.savingsDeduction)}>{Utils.formatCurrency(calculations.savingsDeduction)}</p>
                                    </div>
                                )}
                                <div className="flex justify-between font-bold pt-2 border-t border-slate-300"><p>Total Deductions</p><p className={`text-red-600 ${getChangeIndicatorClass(calculations.totalDeductions, oldCalcs.totalDeductions)}`}>{Utils.formatCurrency(calculations.totalDeductions)}</p></div>
                            </div>
                        </div>
                        <div className="mt-6 p-4 bg-blue-100 border border-blue-300 rounded-lg text-center">
                            <p className="text-sm font-semibold text-blue-800">NET SALARY</p>
                            <p className={`text-3xl font-bold text-blue-900 ${getChangeIndicatorClass(calculations.netSalary, oldCalcs.netSalary)}`}>{Utils.formatCurrency(calculations.netSalary)}</p>
                        </div>
                    </>
                    ) : (
                        <div className="text-center py-20 text-slate-500"><i className="fas fa-file-invoice-dollar text-4xl mb-4"></i><p>Please select an employee to view the payslip.</p></div>
                    )}
                </div>
            );
        });

        const PayrollCalculatorTab = ({ userProfile, editingRecord, onSaveSuccess }) => {
            const { db } = useFirebase();
            const currentMonth = new Date().toISOString().slice(0, 7);
            const [selectedMonth, setSelectedMonth] = useState(currentMonth);
            const [selectedShop, setSelectedShop] = useState('');
            const [selectedEmployeeId, setSelectedEmployeeId] = useState('');
            const { where } = window.firebaseSDK;

            const { shops, employees, shifts } = useAppData();

            // PHASE 2 OPTIMIZATION: Add query constraints for Shop Managers
            const payrollQueryConstraints = useMemo(() => {
                const { role, shop, id } = userProfile || {};
                
                if (role === 'Admin' || role === 'CEO') {
                    if (!selectedShop) return { attendance: [where("shop", "==", "null")], leave: [where("shop", "==", "null")], ot: [where("shop", "==", "null")], loan: [where("shop", "==", "null")], state: [where("shop", "==", "null")], salary: [where("shopName", "==", "null")] };
                    return { attendance: [where("shop", "==", selectedShop)], leave: [where("shop", "==", selectedShop)], ot: [where("shop", "==", selectedShop)], loan: [where("shop", "==", selectedShop)], state: [where("shop", "==", selectedShop)], salary: [where("shopName", "==", selectedShop)] };
                }

                if (role === 'Shop Manager') {
                    const managedShops = Array.isArray(shop) ? shop : (shop ? [shop] : []);
                    if (managedShops.length > 0) {
                        return { attendance: [where("shop", "in", managedShops)], leave: [where("shop", "in", managedShops)], ot: [where("shop", "in", managedShops)], loan: [where("shop", "in", managedShops)], state: [where("shop", "in", managedShops)], salary: [where("shopName", "in", managedShops)] };
                    }
                }
                
                if (role === 'Staff' && id) {
                    return { attendance: [where("employeeId", "==", id)], leave: [where("staffId", "==", id)], ot: [where("staffId", "==", id)], loan: [where("staffId", "==", id)], state: [where("staffId", "==", id)], salary: [where("staffId", "==", id)] };
                }

                return { attendance: [where("shop", "==", "null")], leave: [where("shop", "==", "null")], ot: [where("shop", "==", "null")], loan: [where("shop", "==", "null")], state: [where("shop", "==", "null")], salary: [where("shopName", "==", "null")] };

            }, [userProfile, selectedShop]);
            
            const { data: attendanceData } = useCollection('attendance', payrollQueryConstraints.attendance);
            const { data: leaveRequestsData } = useCollection('leaveRequests', payrollQueryConstraints.leave);
            const { data: otRequestsData } = useCollection('otRequests', payrollQueryConstraints.ot);
            const { data: staffLoansData } = useCollection('staffLoans', payrollQueryConstraints.loan);
            const { data: employeeStatesData } = useCollection('employeeStates', payrollQueryConstraints.state);
            const { data: salaryRevisionsData } = useCollection('salaryRevisions', payrollQueryConstraints.salary);

            const allData = useMemo(() => ({
                shops, employees, shifts,
                attendance: attendanceData, leaveRequests: leaveRequestsData, otRequests: otRequestsData,
                staffLoans: staffLoansData, employeeStates: employeeStatesData, salaryRevisions: salaryRevisionsData,
            }), [shops, employees, shifts, attendanceData, leaveRequestsData, otRequestsData, staffLoansData, employeeStatesData, salaryRevisionsData]);
            
            const [manualLoanDeduction, setManualLoanDeduction] = useState(undefined);
            const [isProcessing, setIsProcessing] = useState(false);
            const [isRecalculated, setIsRecalculated] = useState(false);
            const [displayInputs, setDisplayInputs] = useState({});
            const [displayCalculations, setDisplayCalculations] = useState({});
            const [savingsData, setSavingsData] = useState(null);
            const [savingsWithdrawals, setSavingsWithdrawals] = useState([]);

            useEffect(() => {
                if (!db || !selectedEmployeeId) { setSavingsData(null); return; }
                const { doc, onSnapshot } = window.firebaseSDK;
                const unsubscribe = onSnapshot(doc(db, 'savingprogram', selectedEmployeeId), (doc) => {
                    if (doc.exists()) { setSavingsData(doc.data()); } else { setSavingsData(null); }
                }, (error) => { console.error("Error fetching savings data for payroll:", error); setSavingsData(null); });
                return () => unsubscribe();
            }, [db, selectedEmployeeId]);

            // --- Fetch Savings Withdrawals for Payroll Calculation ---
            useEffect(() => {
                if (!db || !selectedEmployeeId || !selectedMonth) {
                    setSavingsWithdrawals([]);
                    return;
                }
                const fetchWithdrawals = async () => {
                    try {
                        const { collection, query, where, getDocs } = window.firebaseSDK;
                        const [year, month] = selectedMonth.split('-').map(Number);
                        const startDate = new Date(year, month - 1, 1);
                        const endDate = new Date(year, month, 0, 23, 59, 59, 999); 

                        const q = query(
                            collection(db, 'savingprogram', selectedEmployeeId, 'transactions'),
                            where("date", ">=", startDate),
                            where("date", "<=", endDate)
                        );
                        
                        const querySnapshot = await getDocs(q);
                        const withdrawals = querySnapshot.docs
                            .map(doc => ({ id: doc.id, ...doc.data() }))
                            .filter(tx => tx.type === 'withdrawal');
                        setSavingsWithdrawals(withdrawals);
                    } catch (error) {
                        console.error("Error fetching payroll savings withdrawals:", error);
                        setSavingsWithdrawals([]);
                    }
                };
                fetchWithdrawals();
            }, [db, selectedEmployeeId, selectedMonth]);

            const isMultiShopManager = userProfile?.role === 'Shop Manager' && Array.isArray(userProfile.shop);
            const isShopManager = userProfile?.role === 'Shop Manager';

            const managedShops = useMemo(() => {
                if (isShopManager) {
                    return Array.isArray(userProfile.shop) ? userProfile.shop : (userProfile.shop ? [userProfile.shop] : []);
                }
                return [];
            }, [userProfile, isShopManager]);

            const selectedEmployee = useMemo(() => employees.find(emp => emp.id === selectedEmployeeId), [selectedEmployeeId, employees]);
            const { inputs: liveInputs, calculations: liveCalculations } = usePayrollCalculator(selectedEmployee, selectedMonth, allData, manualLoanDeduction, savingsWithdrawals, savingsData);

            useEffect(() => {
                if (editingRecord) {
                    setSelectedMonth(editingRecord.month); 
                    setSelectedShop(editingRecord.shop); 
                    setSelectedEmployeeId(editingRecord.employeeId);
                    setIsRecalculated(false); 
                }
            }, [editingRecord]);

            useEffect(() => {
                if (editingRecord && !isRecalculated) {
                    setDisplayInputs(editingRecord.manualInputs || {});
                    setDisplayCalculations(editingRecord.calculations || {});
                    setManualLoanDeduction(editingRecord.manualInputs?.loanDeduction);
                } else {
                    setDisplayInputs(liveInputs || {});
                    setDisplayCalculations(liveCalculations || {});
                }
            }, [editingRecord, liveInputs, liveCalculations, isRecalculated]);

            useEffect(() => {
                if (!editingRecord || isRecalculated) {
                    setManualLoanDeduction(liveInputs.autoLoanDeduction);
                }
            }, [liveInputs.autoLoanDeduction, editingRecord, isRecalculated]);

            useEffect(() => {
                if (!editingRecord && userProfile) {
                    if (userProfile.role === 'Admin' || isShopManager) { setSelectedShop(''); } 
                    else { setSelectedShop(userProfile.shop || ''); }
                    setSelectedEmployeeId(''); 
                    setSelectedMonth(currentMonth);
                    setManualLoanDeduction(undefined);
                    setIsRecalculated(false);
                }
            }, [editingRecord, userProfile, currentMonth, isShopManager]);
            
            const handleManualLoanChange = (e) => {
                const value = e.target.value;
                setManualLoanDeduction(value === '' ? undefined : parseFloat(value));
            };
            
            const handleRecalculate = () => {
                setDisplayInputs(liveInputs || {});
                setDisplayCalculations(liveCalculations || {});
                setManualLoanDeduction(liveInputs.loanDeduction); 
                setIsRecalculated(true);
            };

            const handleCancelRecalculation = () => {
                if (editingRecord) {
                    setDisplayInputs(editingRecord.manualInputs || {});
                    setDisplayCalculations(editingRecord.calculations || {});
                    setManualLoanDeduction(editingRecord.manualInputs?.loanDeduction);
                    setIsRecalculated(false);
                }
            };

            const availableShops = useAllowedShops(userProfile, shops);

            const employeesForDropdown = useMemo(() => {
                let relevantEmployees = [];
                if (userProfile?.role === 'Admin' || userProfile?.role === 'CEO') {
                     relevantEmployees = selectedShop 
                        ? employees.filter(e => Array.isArray(e.shop) ? e.shop.includes(selectedShop) : e.shop === selectedShop)
                        : []; 
                } else if (isShopManager) {
                    const shopsToFilter = selectedShop ? [selectedShop] : managedShops;
                    relevantEmployees = employees.filter(e => {
                        const employeeShops = Array.isArray(e.shop) ? e.shop : [e.shop];
                        return employeeShops.some(s => shopsToFilter.includes(s));
                    });
                } else { // Staff
                    relevantEmployees = employees.filter(e => e.shop === userProfile.shop);
                }
                return relevantEmployees.filter(e => e.status === 'Active');
            }, [selectedShop, employees, userProfile, isShopManager, managedShops]);

            const handleDownloadPayslip = () => {
                const payslipElement = document.getElementById('payslip-preview');
                if (!payslipElement || !selectedEmployee) { alert("Please select an employee to generate a payslip."); return; }
                const [year, month] = selectedMonth.split('-');
                const shopName = Array.isArray(selectedEmployee.shop) ? selectedEmployee.shop[0] : selectedEmployee.shop;
                html2canvas(payslipElement, { backgroundColor: '#ffffff', scale: 2 }).then(canvas => {
                    const link = document.createElement('a');
                    link.download = `${shopName}-${selectedEmployee.name}-${month}-${year.substring(2)}.png`;
                    link.href = canvas.toDataURL('image/png'); link.click();
                });
            };

            const handleSaveAndDownload = async () => {
                setIsProcessing(true);
                if (!selectedEmployee || displayCalculations.netSalary === undefined) {
                    alert("Cannot process. Please ensure an employee is selected and payroll is calculated.");
                    setIsProcessing(false);
                    return;
                }
                const shopName = Array.isArray(selectedEmployee.shop) ? selectedEmployee.shop[0] : selectedEmployee.shop;
                const { addDoc, collection, serverTimestamp, doc, updateDoc, getDocs, query, where } = window.firebaseSDK;
                
                if (!editingRecord) {
                    const payrollCheckQuery = query(collection(db, "payrollHistory"), where("employeeId", "==", selectedEmployee.id), where("month", "==", selectedMonth));
                    const existingPayrollSnap = await getDocs(payrollCheckQuery);
                    if (!existingPayrollSnap.empty) {
                        alert(`Payroll for ${selectedEmployee.name} for ${selectedMonth} has already been generated and saved.`);
                        setIsProcessing(false);
                        return; 
                    }
                }

                const finalInputsForSave = { ...displayInputs, loanDeduction: manualLoanDeduction };
                const payrollData = { month: selectedMonth, shop: shopName, employeeId: selectedEmployee.id, employeeName: selectedEmployee.name, baseSalary: displayCalculations.baseSalary, netSalary: displayCalculations.netSalary, manualInputs: finalInputsForSave, calculations: displayCalculations };
                
                let payrollRecordId;
                let success = false;
                try {
                    if (editingRecord) { 
                        await updateDoc(doc(db, 'payrollHistory', editingRecord.id), payrollData); 
                        payrollRecordId = editingRecord.id;
                    } 
                    else { 
                        const newDocRef = await addDoc(collection(db, 'payrollHistory'), { ...payrollData, createdAt: serverTimestamp() }); 
                        payrollRecordId = newDocRef.id;
                    }
                    
                    if (finalInputsForSave.loanDeduction > 0) {
                        const applicableLoans = (allData.staffLoans || [])
                            .filter(l => l.staffId === selectedEmployee.id && l.status === 'Active' && (!l.effectiveDate || l.effectiveDate.slice(0, 7) <= selectedMonth))
                            .sort((a, b) => (b.effectiveDate || '0000-00').localeCompare(a.effectiveDate || '0000-00'));

                        const activeLoan = applicableLoans.length > 0 ? applicableLoans[0] : null;

                        if (activeLoan) {
                            const newTotalPaid = (activeLoan.totalPaid || 0) + finalInputsForSave.loanDeduction;
                            const newBalance = activeLoan.loanAmount - newTotalPaid;
                            const newStatus = newBalance <= 0 ? 'Paid Off' : 'Active';
                            await updateDoc(doc(db, 'staffLoans', activeLoan.id), { totalPaid: newTotalPaid, status: newStatus });
                            await addDoc(collection(db, 'loanPayments'), { paymentDate: `${selectedMonth}-${new Date(selectedMonth.split('-')[0], selectedMonth.split('-')[1], 0).getDate()}`, staffId: selectedEmployee.id, staffName: selectedEmployee.name, shop: shopName, loanId: activeLoan.id, amountPaid: finalInputsForSave.loanDeduction, remainingBalance: newBalance, note: "Paid via payroll", payrollId: payrollRecordId });
                        }
                    }

                    if (displayCalculations.savingsDeduction > 0) {
                        await Utils.manageSavingsContribution(db, selectedEmployee.id, selectedEmployee.name, shopName, displayCalculations.savingsDeduction, payrollRecordId);
                    }

                    alert('Payroll saved successfully!');
                    success = true;
                } catch (error) {
                    console.error("Error saving payroll: ", error);
                    alert('Failed to save payroll.');
                    success = false;
                }

                if (success) {
                    setTimeout(() => {
                        handleDownloadPayslip();
                        onSaveSuccess(selectedMonth);
                    }, 500);
                } else {
                    setIsProcessing(false);
                }
            };
           
            const canSelectShop = (userProfile?.role === 'Admin' || userProfile?.role === 'CEO' || isShopManager) && !editingRecord;
        
            return (
                <>
                    <div className="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <Card><CardTitle>Payroll Calculator</CardTitle>
                        <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div>
                            <label className="text-sm font-medium text-slate-400"><i className="fas fa-calendar-alt mr-2 text-blue-400"></i>Month</label>
                            <input type="month" value={selectedMonth} onChange={e => setSelectedMonth(e.target.value)} className="input" disabled={!!editingRecord} />
                        </div>
                        <div>
                            <label className="text-sm font-medium text-slate-400"><i className="fas fa-store mr-2 text-cyan-400"></i>Shop</label>
                            {canSelectShop ? (
                                <select value={selectedShop} onChange={e => { setSelectedShop(e.target.value); setSelectedEmployeeId(''); }} className="select">
                                    <option value="">{userProfile?.role === 'Admin' || userProfile?.role === 'CEO' ? 'All Shops' : 'All My Shops'}</option>
                                    {availableShops.map(s => <option key={s.id} value={s.name}>{s.name}</option>)}
                                </select>
                            ) : (
                                <input value={selectedShop} className="input" disabled />
                            )}
                        </div>
                        <div>
                            <label className="text-sm font-medium text-slate-400"><i className="fas fa-user mr-2 text-emerald-400"></i>Employee</label>
                            <select value={selectedEmployeeId} onChange={e => setSelectedEmployeeId(e.target.value)} className="select" disabled={!!editingRecord || employeesForDropdown.length === 0}>
                                <option value="">Select Employee</option>
                                {employeesForDropdown.map(e => <option key={e.id} value={e.id}>{e.name}</option>)}
                            </select>
                        </div>
                    </div>{selectedEmployee && (<><div className="grid grid-cols-1 md:grid-cols-3 gap-4 pt-6 border-t border-slate-700"><h3 className="md:col-span-3 text-lg font-semibold text-slate-200">Attendance & Deductions</h3><div><label className="text-sm"><i className="fas fa-briefcase mr-2 text-slate-400"></i>Work Days</label><input type="number" name="workDays" value={displayInputs.workDays ?? ''} className="input" disabled /></div><div><label className="text-sm"><i className="fas fa-gift mr-2 text-pink-400"></i>Given Off Days</label><input type="number" name="givenOffDays" value={displayInputs.givenOffDays ?? ''} className="input" disabled /></div><div><label className="text-sm"><i className="fas fa-clock mr-2 text-purple-400"></i>OT Days</label><input type="number" name="otDays" value={displayInputs.otDays ?? ''} className="input" disabled /></div><div><label className="text-sm"><i className="fas fa-calendar-minus mr-2 text-orange-400"></i>Leave Days</label><input type="number" name="leaveDays" value={displayInputs.leaveDays ?? ''} className="input" disabled /></div><div><label className="text-sm"><i className="fas fa-user-clock mr-2 text-red-400"></i>Total Late Days</label><input type="number" name="totalLateDays" value={displayInputs.totalLateDays ?? ''} className="input" disabled /></div><div><label className="text-sm"><i className="fas fa-hand-holding-dollar mr-2 text-green-400"></i>Loan Deduction</label><input type="number" name="loanDeduction" value={manualLoanDeduction ?? ''} onChange={handleManualLoanChange} className="input" /></div></div><div className="pt-6 border-t border-slate-700 flex flex-col sm:flex-row gap-4">
                        {editingRecord ? (
                            isRecalculated ? (
                                <>
                                    <Button variant="secondary" onClick={handleCancelRecalculation} className="flex-1">
                                        <i className="fas fa-undo"></i> Cancel Recalculation
                                    </Button>
                                    <Button variant="primary" onClick={handleSaveAndDownload} disabled={isProcessing} className="flex-1">
                                        {isProcessing ? (<><i className="fas fa-spinner fa-spin"></i> Processing...</>) : (<><i className="fas fa-save"></i> Save Updated Record</>)}
                                    </Button>
                                </>
                            ) : (
                                <>
                                    <Button variant="secondary" onClick={handleDownloadPayslip} className="flex-1">
                                        <i className="fas fa-download"></i> Download Original
                                    </Button>
                                    <Button variant="primary" onClick={handleRecalculate} icon="fa-calculator" className="flex-1">
                                        Recalculate with Live Data
                                    </Button>
                                </>
                            )
                        ) : (
                            <Button variant="primary" onClick={handleSaveAndDownload} disabled={isProcessing} className="flex-1">
                                {isProcessing ? (<><i className="fas fa-spinner fa-spin"></i> Processing...</>) : (<><i className="fas fa-save"></i> Save & Download</>)}
                            </Button>
                        )}
                    </div></>)}</Card>
                    <PayslipPreview 
                        selectedEmployee={selectedEmployee}
                        selectedMonth={selectedMonth}
                        manualInputs={{...displayInputs, loanDeduction: manualLoanDeduction }}
                        calculations={displayCalculations}
                        isRecalculated={isRecalculated}
                        originalRecord={editingRecord}
                    />
                    </div>

                    {(userProfile?.role === 'Admin' || userProfile?.role === 'CEO' || userProfile?.role === 'Shop Manager') && (
                        <div className="mt-8">
                            <TriggerSalaryTab />
                        </div>
                    )}
                </>
            );
        };

        const PayrollHistoryTab = ({ onEdit, userProfile }) => {
            const { db } = useFirebase();
            const { where, query, collection, getDocs, doc, runTransaction, deleteDoc, collectionGroup } = window.firebaseSDK;

            const [selectedShop, setSelectedShop] = useState('');
            const [selectedMonth, setSelectedMonth] = useState(new Date().toISOString().slice(0, 7));
            const [history, setHistory] = useState([]);
            const [loading, setLoading] = useState(false);
            const { shops } = useAppData();

            useEffect(() => {
                const fetchHistory = async () => {
                    if (!userProfile) return;
                    setLoading(true);

                    const { role, shop } = userProfile;
                    let q = query(collection(db, 'payrollHistory'));

                    if (role === 'Shop Manager') {
                        const managedShops = Array.isArray(shop) ? shop : (shop ? [shop] : []);
                        if (managedShops.length > 0) {
                            if (selectedShop) {
                                q = query(q, where("shop", "==", selectedShop));
                            } else {
                                q = query(q, where("shop", "in", managedShops));
                            }
                        } else {
                            q = query(q, where("shop", "==", "null"));
                        }
                    } else if (role === 'Admin' || role === 'CEO') {
                        if (selectedShop) {
                            q = query(q, where("shop", "==", selectedShop));
                        } else {
                            q = query(q, where("shop", "==", "null"));
                        }
                    } else { // Staff
                        q = query(q, where("employeeId", "==", userProfile.id));
                    }
                    
                    if (selectedMonth) {
                        q = query(q, where("month", "==", selectedMonth));
                    }
                    
                    try {
                        const snapshot = await getDocs(q);
                        const historyData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        setHistory(historyData);
                    } catch (error) {
                        console.error("Error fetching payroll history:", error);
                    } finally {
                        setLoading(false);
                    }
                };

                fetchHistory();
            }, [db, userProfile, selectedMonth, selectedShop]);

            const [recordToDelete, setRecordToDelete] = useState(null);
            
            useEffect(() => { 
                if (userProfile && userProfile.role === 'Shop Manager' && (!Array.isArray(userProfile.shop) || userProfile.shop.length === 1)) {
                     setSelectedShop(userProfile.shop || ''); 
                } else {
                    setSelectedShop('');
                }
            }, [userProfile]);

            const { filteredHistory, totals } = useMemo(() => {
                const sorted = [...history].sort((a,b) => (b.createdAt?.toDate() || 0) - (a.createdAt?.toDate() || 0));
                const totals = sorted.reduce((acc, curr) => { 
                    acc.baseSalary += curr.baseSalary || 0; 
                    acc.engagements += curr.calculations?.engagements || 0;
                    acc.otSalary += curr.calculations?.otSalary || 0;
                    acc.totalSavingsPayback += curr.calculations?.totalSavingsWithdrawal || 0; 
                    acc.loanDeduction += curr.manualInputs?.loanDeduction || 0; 
                    acc.otherDeductions += curr.calculations?.otherDeductions || 0;
                    acc.savingsDeduction += curr.calculations?.savingsDeduction || 0; 
                    acc.netSalary += curr.netSalary || 0; 
                    return acc; 
                }, { baseSalary: 0, engagements: 0, otSalary: 0, totalSavingsPayback: 0, loanDeduction: 0, otherDeductions: 0, savingsDeduction: 0, netSalary: 0 });
                return { filteredHistory: sorted, totals };
            }, [history]);

            const handleDelete = async () => {
                if (!recordToDelete) return;
                
                const payrollId = recordToDelete.id;
                const employeeId = recordToDelete.employeeId;
                const loanDeductionAmount = recordToDelete.manualInputs?.loanDeduction || 0;
                const savingsContributionAmount = recordToDelete.calculations?.savingsDeduction || 0;

                try {
                    const loanPaymentQuery = query(collection(db, 'loanPayments'), where("payrollId", "==", payrollId));
                    const loanPaymentSnap = await getDocs(loanPaymentQuery);

                    const savingsTxQuery = query(
                        collection(db, 'savingprogram', employeeId, 'transactions'), 
                        where("payrollId", "==", payrollId), 
                        where("type", "==", "contribution")
                    );
                    const savingsTxSnap = await getDocs(savingsTxQuery);

                    await runTransaction(db, async (transaction) => {
                        if (loanDeductionAmount > 0) {
                            if (!loanPaymentSnap.empty) {
                                const loanPaymentDoc = loanPaymentSnap.docs[0];
                                const loanPaymentData = loanPaymentDoc.data();
                                const loanId = loanPaymentData.loanId;
                                const amountPaidInPayroll = loanPaymentData.amountPaid || 0;

                                const staffLoanRef = doc(db, 'staffLoans', loanId);
                                const staffLoanDoc = await transaction.get(staffLoanRef);

                                if (staffLoanDoc.exists()) {
                                    const staffLoanData = staffLoanDoc.data();
                                    const currentTotalPaid = staffLoanData.totalPaid || 0;
                                    const newTotalPaid = Math.max(0, currentTotalPaid - amountPaidInPayroll); 
                                    const newStatus = newTotalPaid < staffLoanData.loanAmount ? 'Active' : 'Paid Off';

                                    transaction.update(staffLoanRef, { 
                                        totalPaid: newTotalPaid,
                                        status: newStatus 
                                    });
                                }
                                transaction.delete(loanPaymentDoc.ref);
                            }
                        }

                        if (savingsContributionAmount > 0) {
                            if (!savingsTxSnap.empty) {
                                const savingsTxDoc = savingsTxSnap.docs[0];
                                const amountContributed = savingsTxDoc.data().amountDeducted || 0;
                                
                                const employeeSavingsRef = doc(db, 'savingprogram', employeeId);
                                const employeeSavingsDoc = await transaction.get(employeeSavingsRef);

                                if (employeeSavingsDoc.exists()) {
                                    const currentBalance = employeeSavingsDoc.data().currentBalance || 0;
                                    const newBalance = Math.max(0, currentBalance - amountContributed); 

                                    transaction.update(employeeSavingsRef, { 
                                        currentBalance: newBalance 
                                    });
                                }
                                transaction.delete(savingsTxDoc.ref);
                            }
                        }
                        
                        const payrollHistoryRef = doc(db, 'payrollHistory', payrollId);
                        transaction.delete(payrollHistoryRef);
                    });
                    
                    setHistory(prevHistory => prevHistory.filter(record => record.id !== payrollId));
                    alert('Payroll record and associated transactions deleted successfully.');

                } catch (error) {
                    console.error("Error during transactional delete of payroll record:", error);
                    alert(`Failed to delete payroll record: ${error.message}`);
                } finally {
                    setRecordToDelete(null); 
                }
            };

            return (
                <Card>
                    <PageHeader title="Payroll History">
                        <ShopFilterSelect 
                            userProfile={userProfile}
                            shops={shops}
                            selectedShop={selectedShop}
                            onChange={e => setSelectedShop(e.target.value)}
                        />
                        <input type="month" value={selectedMonth} onChange={e => setSelectedMonth(e.target.value)} className="input w-full sm:w-auto" />
                    </PageHeader>

                    {loading ? (
                        <div className="text-center py-10"><i className="fas fa-spinner fa-spin text-3xl text-blue-400"></i></div>
                    ) : (
                        <div className="overflow-x-auto">
                            <table className="min-w-full divide-y divide-slate-700">
                                <thead className="bg-slate-900/50">
                                    <tr>
                                        <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Month</th>
                                        <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Shop</th>
                                        <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Staff</th>
                                        <th className="px-4 py-3 text-right text-xs font-semibold text-slate-400 uppercase">Base Salary</th>
                                        <th className="px-4 py-3 text-right text-xs font-semibold text-slate-400 uppercase">Engagements</th>
                                        <th className="px-4 py-3 text-right text-xs font-semibold text-slate-400 uppercase">OT Salary</th>
                                        <th className="px-4 py-3 text-right text-xs font-semibold text-slate-400 uppercase">Savings Payback</th>
                                        <th className="px-4 py-3 text-right text-xs font-semibold text-slate-400 uppercase">Loan Ded.</th>
                                        <th className="px-4 py-3 text-right text-xs font-semibold text-slate-400 uppercase">Other Ded.</th>
                                        <th className="px-4 py-3 text-right text-xs font-semibold text-slate-400 uppercase">Savings Ded.</th>
                                        <th className="px-4 py-3 text-right text-xs font-semibold text-slate-400 uppercase">Net Salary</th>
                                        <th className="px-4 py-3 text-center text-xs font-semibold text-slate-400 uppercase">Actions</th>
                                    </tr>
                                </thead>
                                <tbody className="divide-y divide-slate-700">
                                    {filteredHistory.map(record => (
                                        <tr key={record.id} className="hover:bg-slate-700/50">
                                            <td className="px-4 py-4 text-sm text-slate-300 whitespace-nowrap">{record.month}</td>
                                            <td className="px-4 py-4 text-sm text-slate-300 whitespace-nowrap">{record.shop}</td>
                                            <td className="px-4 py-4 text-sm text-slate-200 whitespace-nowrap">{record.employeeName}</td>
                                            <td className="px-4 py-4 text-sm text-right">{Utils.formatCurrency(record.baseSalary)}</td>
                                            <td className="px-4 py-4 text-sm text-right">{Utils.formatCurrency(record.calculations?.engagements)}</td>
                                            <td className="px-4 py-4 text-sm text-right">{Utils.formatCurrency(record.calculations?.otSalary)}</td>
                                            <td className="px-4 py-4 text-sm text-right">{Utils.formatCurrency(record.calculations?.totalSavingsWithdrawal)}</td>
                                            <td className="px-4 py-4 text-sm text-right">{Utils.formatCurrency(record.manualInputs?.loanDeduction)}</td>
                                            <td className="px-4 py-4 text-sm text-right">{Utils.formatCurrency(record.calculations?.otherDeductions)}</td>
                                            <td className="px-4 py-4 text-sm text-right">{Utils.formatCurrency(record.calculations?.savingsDeduction)}</td>
                                            <td className="px-4 py-4 text-sm text-right font-bold text-blue-300">{Utils.formatCurrency(record.netSalary)}</td>
                                            <td className="px-4 py-4 text-center">
                                                <div className="flex items-center justify-center gap-4">
                                                    {(userProfile?.role === 'Admin' || userProfile?.role === 'CEO') && (
                                                        <>
                                                            <Button variant="icon-edit" icon="fa-edit" onClick={() => onEdit(record)} title="Edit"/>
                                                            <Button variant="icon-delete" icon="fa-trash" onClick={() => setRecordToDelete(record)} title="Delete"/>
                                                        </>
                                                    )}
                                                </div>
                                            </td>
                                        </tr>
                                    ))}
                                </tbody>
                                <tfoot className="bg-slate-900/50">
                                    <tr>
                                        <td colSpan="3" className="px-4 py-3 text-right font-bold text-slate-300 uppercase">Total</td>
                                        <td className="px-4 py-3 text-right font-bold text-slate-300">{Utils.formatCurrency(totals.baseSalary)}</td>
                                        <td className="px-4 py-3 text-right font-bold text-slate-300">{Utils.formatCurrency(totals.engagements)}</td>
                                        <td className="px-4 py-3 text-right font-bold text-slate-300">{Utils.formatCurrency(totals.otSalary)}</td>
                                        <td className="px-4 py-3 text-right font-bold text-slate-300">{Utils.formatCurrency(totals.totalSavingsPayback)}</td>
                                        <td className="px-4 py-3 text-right font-bold text-slate-300">{Utils.formatCurrency(totals.loanDeduction)}</td>
                                        <td className="px-4 py-3 text-right font-bold text-slate-300">{Utils.formatCurrency(totals.otherDeductions)}</td>
                                        <td className="px-4 py-3 text-right font-bold text-blue-300">{Utils.formatCurrency(totals.savingsDeduction)}</td>
                                        <td className="px-4 py-3 text-right font-bold text-blue-300">{Utils.formatCurrency(totals.netSalary)}</td>
                                        <td></td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                    )}
                    <ConfirmationModal 
                        isOpen={!!recordToDelete} 
                        onClose={() => setRecordToDelete(null)} 
                        onConfirm={handleDelete} 
                        title="Delete Payroll Record" 
                        message={`Are you sure you want to delete the payroll record for ${recordToDelete?.employeeName}? This action will also revert any associated loan payments and savings contributions.`}
                    />
                </Card>
            );
        };

        const PayrollPage = ({ userProfile }) => {
            const [activeTab, setActiveTab] = useState('calculator');
            const [editingRecord, setEditingRecord] = useState(null);
            
            const { employees } = useAppData();
            
            const handleEdit = (record) => { 
                setEditingRecord(record); 
                setActiveTab('calculator'); 
            };

            const handleSaveSuccess = () => { 
                setEditingRecord(null); 
                setActiveTab('history'); 
            };

            const tabs = { 
                calculator: <span><i className="fas fa-calculator mr-2 text-blue-400"></i>Payroll Calculator</span>, 
                history: <span><i className="fas fa-history mr-2 text-green-400"></i>Payroll History</span> 
            };

            return (
                <TabbedPage tabs={tabs} activeTab={activeTab} setActiveTab={setActiveTab}>
                   <div id="calculator"><PayrollCalculatorTab userProfile={userProfile} editingRecord={editingRecord} onSaveSuccess={handleSaveSuccess} /></div>
                    <div id="history"><PayrollHistoryTab onEdit={handleEdit} userProfile={userProfile} /></div>
                </TabbedPage>
            );
        };
        // --- END PAYROLL PAGE (RESTORED) ---

        // --- START LOAN MANAGER PAGE ---
        const LoanManagerPage = ({ userProfile }) => {
            return (
                <div className="space-y-6">
                    <LoanManagementTab userProfile={userProfile} />
                    <LoanHistoryTab userProfile={userProfile} />
                </div>
            );
        };

        const LoanManagementTab = ({ userProfile }) => {
            const { db } = useFirebase();
            const [isModalOpen, setModalOpen] = useState(false);
            const [editingLoan, setEditingLoan] = useState(null);
            const [loanToDelete, setLoanToDelete] = useState(null);
            const { where } = window.firebaseSDK;
            
            // REFACTORED: Get global data from App Data Context.
            const { shops, employees } = useAppData();
            const [selectedShop, setSelectedShop] = useState(''); // For the modal's employee list
            const [formData, setFormData] = useState({});
            const [filterShop, setFilterShop] = useState(''); // For filtering the main list
            const [searchTerm, setSearchTerm] = useState(''); // State for the search input

            const queryConstraints = useMemo(() => {
                if (!userProfile) return [where("shop", "==", "null")];
                if (userProfile.role === 'Admin' || userProfile.role === 'CEO') return [];
                if (userProfile.role === 'Shop Manager') {
                    const shops = Array.isArray(userProfile.shop) ? userProfile.shop : (userProfile.shop ? [userProfile.shop] : []);
                    if (shops.length > 0) {
                        return [where("shop", "in", shops)];
                    }
                    return [where("staffId", "==", "null")]; // No shops, no data
                }
                return [where("shop", "==", userProfile.shop || null)];
            }, [userProfile]);

            const { data: loans } = useCollection('staffLoans', queryConstraints);

            // OPTIMIZATION: Use the centralized hook
            const allowedShops = useAllowedShops(userProfile, shops);

            // Set initial filter shop
            useEffect(() => {
                if (userProfile && userProfile.role !== 'Admin' && userProfile.role !== 'CEO') {
                    setFilterShop(Array.isArray(userProfile.shop) ? '' : userProfile.shop || '');
                }
            }, [userProfile]);

            const filteredLoans = useMemo(() => {
                return loans.filter(loan =>
                    (!filterShop || loan.shop === filterShop) &&
                    (loan.staffName.toLowerCase().includes(searchTerm.toLowerCase()))
                );
            }, [loans, filterShop, searchTerm]);

            const employeesInShop = useMemo(() => {
                if (!selectedShop) return [];
                return employees.filter(emp => {
                    const employeeShops = Array.isArray(emp.shop) ? emp.shop : [emp.shop];
                    return employeeShops.includes(selectedShop) && emp.status === 'Active';
                });
            }, [selectedShop, employees]);
            
            const canSelectShopInModal = userProfile?.role === 'Admin' || userProfile?.role === 'CEO' || (userProfile?.role === 'Shop Manager' && Array.isArray(userProfile.shop));

            const handleOpenModal = (loan = null) => {
                setEditingLoan(loan);
                let initialShop = '';
                if (userProfile.role === 'Shop Manager') {
                    const managedShops = Array.isArray(userProfile.shop) ? userProfile.shop : [userProfile.shop];
                    if (managedShops.length === 1) initialShop = managedShops[0];
                } else if (userProfile.role !== 'Admin' && userProfile.role !== 'CEO') {
                    initialShop = userProfile.shop || '';
                }

                const initialData = loan ? { ...loan } : { loanDate: new Date().toISOString().substring(0, 10), effectiveDate: new Date().toISOString().substring(0, 10), shop: initialShop, staffId: '', loanAmount: '', agreedMonthlyDeduction: '', reason: '', totalPaid: 0, status: 'Active' };
                setFormData(initialData);
                setSelectedShop(initialData.shop || '');
                setModalOpen(true);
            };

            const handleCloseModal = () => { setModalOpen(false); setEditingLoan(null); };
            const handleChange = (e) => {
                const { name, value } = e.target;
                setFormData(prev => ({ ...prev, [name]: value }));
                if (name === 'shop') { setSelectedShop(value); setFormData(prev => ({...prev, staffId: ''})); }
            };
            const handleSave = async () => {
                const { addDoc, updateDoc, doc, collection } = window.firebaseSDK;
                const dataToSave = { ...formData, loanAmount: parseFloat(formData.loanAmount) || 0, agreedMonthlyDeduction: parseFloat(formData.agreedMonthlyDeduction) || 0, staffName: employees.find(e => e.id === formData.staffId)?.name || '' };
                try {
                    if (editingLoan) { await updateDoc(doc(db, 'staffLoans', editingLoan.id), dataToSave); } 
                    else { await addDoc(collection(db, 'staffLoans'), dataToSave); }
                    handleCloseModal();
                } catch (error) { console.error("Error saving loan:", error); }
            };
            const confirmDelete = async () => {
                if (!loanToDelete) return;
                const { writeBatch, collection, query, where, getDocs, doc } = window.firebaseSDK;
                const batch = writeBatch(db);
                try {
                    const paymentsQuery = query(collection(db, 'loanPayments'), where("loanId", "==", loanToDelete.id));
                    const paymentsSnapshot = await getDocs(paymentsQuery);
                    paymentsSnapshot.forEach((paymentDoc) => { batch.delete(paymentDoc.ref); });
                    const loanRef = doc(db, 'staffLoans', loanToDelete.id);
                    batch.delete(loanRef);
                    await batch.commit();
                } catch (error) {
                    console.error("Error deleting loan and its payments:", error);
                    alert("Failed to delete the loan and its history. Please try again.");
                } finally {
                    setLoanToDelete(null);
                }
            };
            
            // OPTIMIZATION: Refactored UI
            return (
                 <Card>
                    <PageHeader title="Loan Management">
                        <SearchInput 
                            value={searchTerm} 
                            onChange={e => setSearchTerm(e.target.value)} 
                            placeholder="Search by staff name..."
                        />
                        <ShopFilterSelect 
                            userProfile={userProfile}
                            shops={shops}
                            selectedShop={filterShop}
                            onChange={e => setFilterShop(e.target.value)}
                        />
                        <Button variant="primary" icon="fa-plus" onClick={() => handleOpenModal()}>Add New Loan</Button>
                    </PageHeader>

                    <div className="overflow-x-auto"><table className="min-w-full divide-y divide-slate-700"><thead className="bg-slate-900/50"><tr><th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Staff Name</th><th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Loan Date</th><th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Effective Date</th><th className="px-4 py-3 text-right text-xs font-semibold text-slate-400 uppercase">Loan Amount</th><th className="px-4 py-3 text-right text-xs font-semibold text-slate-400 uppercase">Agreed Amount</th><th className="px-4 py-3 text-right text-xs font-semibold text-slate-400 uppercase">Total Paid</th><th className="px-4 py-3 text-right text-xs font-semibold text-slate-400 uppercase">Balance</th><th className="px-4 py-3 text-center text-xs font-semibold text-slate-400 uppercase">Status</th><th className="px-4 py-3 text-center text-xs font-semibold text-slate-400 uppercase">Actions</th></tr></thead><tbody className="divide-y divide-slate-700">{filteredLoans.map(loan => { const balance = loan.loanAmount - loan.totalPaid; return (<tr key={loan.id} className="hover:bg-slate-700/50"><td className="px-4 py-4 text-sm text-slate-200">{loan.staffName}</td><td className="px-4 py-4 text-sm text-slate-300">{Utils.formatISOToDisplay(loan.loanDate)}</td><td className="px-4 py-4 text-sm text-slate-300">{Utils.formatISOToDisplay(loan.effectiveDate)}</td><td className="px-4 py-4 text-sm text-slate-300 text-right">{Utils.formatCurrency(loan.loanAmount)}</td><td className="px-4 py-4 text-sm text-slate-300 text-right">{Utils.formatCurrency(loan.agreedMonthlyDeduction)}</td><td className="px-4 py-4 text-sm text-slate-300 text-right">{Utils.formatCurrency(loan.totalPaid)}</td><td className="px-4 py-4 text-sm text-slate-300 text-right">{Utils.formatCurrency(balance)}</td><td className="px-4 py-4 text-center text-sm"><span className={`px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${balance <= 0 ? 'bg-green-100 text-green-800' : 'bg-blue-100 text-blue-800'}`}>{balance <= 0 ? 'Paid Off' : 'Active'}</span></td><td className="px-4 py-4 text-center whitespace-nowrap"><div className="flex items-center justify-center gap-4"><Button variant="icon-edit" icon="fa-edit" onClick={() => handleOpenModal(loan)} title="Edit" /><Button variant="icon-delete" icon="fa-trash" onClick={() => setLoanToDelete(loan)} title="Delete" /></div></td></tr>); })}</tbody></table></div>
                    <Modal isOpen={isModalOpen} onClose={handleCloseModal}><ModalHeader title={editingLoan ? "Edit Loan" : "Add New Loan"} onClose={handleCloseModal} /><ModalBody><div className="space-y-4"><div><label className="text-sm text-slate-400">Shop</label><select name="shop" value={formData.shop || ''} onChange={handleChange} className="select" disabled={!canSelectShopInModal}><option value="">Select Shop</option>{allowedShops.map(s => <option key={s.id} value={s.name}>{s.name}</option>)}</select></div><div><label className="text-sm text-slate-400">Staff</label><select name="staffId" value={formData.staffId || ''} onChange={handleChange} className="select" disabled={!selectedShop}><option value="">Select Staff</option>{employeesInShop.map(e => <option key={e.id} value={e.id}>{e.name}</option>)}</select></div><div><label className="text-sm text-slate-400">Loan Date</label><input type="date" name="loanDate" value={formData.loanDate || ''} onChange={handleChange} className="input"/></div><div><label className="text-sm text-slate-400">Effective Date</label><input type="date" name="effectiveDate" value={formData.effectiveDate || ''} onChange={handleChange} className="input"/></div><div><label className="text-sm text-slate-400">Loan Amount</label><input type="number" name="loanAmount" value={formData.loanAmount || ''} onChange={handleChange} className="input"/></div><div><label className="text-sm text-slate-400">Agreed Monthly Deduction</label><input type="number" name="agreedMonthlyDeduction" value={formData.agreedMonthlyDeduction || ''} onChange={handleChange} className="input"/></div><div><label className="text-sm text-slate-400">Reason</label><textarea name="reason" value={formData.reason || ''} onChange={handleChange} className="input" rows="3"></textarea></div></div></ModalBody><ModalFooter><Button variant="secondary" onClick={handleCloseModal}>Cancel</Button><Button variant="primary" onClick={handleSave} className="px-6">Save Loan</Button></ModalFooter></Modal>
                    <ConfirmationModal isOpen={!!loanToDelete} onClose={() => setLoanToDelete(null)} onConfirm={confirmDelete} title="Delete Loan" message="Are you sure you want to delete this loan record?" />
                </Card>
            );
        };
        
        const LoanHistoryTab = ({ userProfile }) => {
            const { db } = useFirebase();
            const { where } = window.firebaseSDK;
            const [selectedShop, setSelectedShop] = useState('');
            // REFACTORED: Get global data from App Data Context.
            const { shops } = useAppData();

            // Set initial shop based on role
            useEffect(() => {
                if (userProfile && userProfile.role !== 'Admin' && userProfile.role !== 'CEO') {
                    setSelectedShop(Array.isArray(userProfile.shop) ? '' : userProfile.shop || '');
                }
            }, [userProfile]);

            // Query logic
            const queryConstraints = useMemo(() => {
                if (!userProfile) return [where("shop", "==", "null")];
                if (userProfile.role === 'Admin' || userProfile.role === 'CEO') {
                    return selectedShop ? [where("shop", "==", selectedShop)] : [];
                }
                if (userProfile.role === 'Shop Manager') {
                    const managedShops = Array.isArray(userProfile.shop) ? userProfile.shop : (userProfile.shop ? [userProfile.shop] : []);
                    if (managedShops.length === 0) return [where("shop", "==", "null")];
                    if (selectedShop) {
                        return [where("shop", "==", selectedShop)];
                    }
                    return [where("shop", "in", managedShops)];
                }
                return [where("shop", "==", userProfile.shop || null)];
            }, [userProfile, selectedShop]);
            
            const { data: loanPayments } = useCollection('loanPayments', queryConstraints);
            const { data: staffLoans } = useCollection('staffLoans');
            const [paymentToDelete, setPaymentToDelete] = useState(null);

            const confirmDelete = async () => {
                if (!paymentToDelete) return;
                const { doc, updateDoc, deleteDoc } = window.firebaseSDK;
                try {
                    // Revert the loan's totalPaid amount
                    const loan = staffLoans.find(l => l.id === paymentToDelete.loanId);
                    if (loan) {
                        const newTotalPaid = (loan.totalPaid || 0) - paymentToDelete.amountPaid;
                        const newStatus = newTotalPaid >= loan.loanAmount ? 'Paid Off' : 'Active';
                        await updateDoc(doc(db, 'staffLoans', loan.id), { totalPaid: newTotalPaid, status: newStatus });
                    }
                    await deleteDoc(doc(db, 'loanPayments', paymentToDelete.id));
                } catch (error) { console.error("Error deleting loan payment:", error); alert("Failed to delete loan payment."); } 
                finally { setPaymentToDelete(null); }
            };
            
            // OPTIMIZATION: Used new hook
            const allowedShops = useAllowedShops(userProfile, shops);

            // OPTIMIZATION: Refactored UI
            return (
                 <Card>
                    <PageHeader title="Loan Payment History">
                        <ShopFilterSelect 
                            userProfile={userProfile}
                            shops={shops}
                            selectedShop={selectedShop}
                            onChange={e => setSelectedShop(e.target.value)}
                        />
                    </PageHeader>
                    <div className="overflow-x-auto"><table className="min-w-full divide-y divide-slate-700"><thead className="bg-slate-900/50"><tr><th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Payment Date</th><th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Staff Name</th><th className="px-4 py-3 text-right text-xs font-semibold text-slate-400 uppercase">Amount Paid</th><th className="px-4 py-3 text-right text-xs font-semibold text-slate-400 uppercase">Remaining Balance</th><th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Note</th><th className="px-4 py-3 text-center text-xs font-semibold text-slate-400 uppercase">Actions</th></tr></thead><tbody className="divide-y divide-slate-700">{loanPayments.map(payment => (<tr key={payment.id} className="hover:bg-slate-700/50"><td className="px-4 py-4 text-sm text-slate-200">{payment.paymentDate}</td><td className="px-4 py-4 text-sm text-slate-300">{payment.staffName}</td><td className="px-4 py-4 text-sm text-slate-300 text-right">{Utils.formatCurrency(payment.amountPaid)}</td><td className="px-4 py-4 text-sm text-slate-300 text-right">{Utils.formatCurrency(payment.remainingBalance)}</td><td className="px-4 py-4 text-sm text-slate-300">{payment.note}</td><td className="px-4 py-4 text-center whitespace-nowrap"><Button variant="icon-delete" icon="fa-trash" onClick={() => setPaymentToDelete(payment)} title="Delete" /></td></tr>))}</tbody></table></div>
                    <ConfirmationModal isOpen={!!paymentToDelete} onClose={() => setPaymentToDelete(null)} onConfirm={confirmDelete} title="Delete Loan Payment" message="Are you sure you want to delete this payment record? This will also update the loan's total paid amount." />
                </Card>
            );
        };
        // --- END LOAN MANAGER PAGE ---

        // --- REMOVED DUPLICATE SAVINGS PROGRAM COMPONENTS HERE ---

        // --- START EXPENSE REPORT PAGE ---
        
        // NEW: Component to manage Operational (Shop) Expenses
        const OperationalExpensesTab = ({ userProfile }) => {
            const { db } = useFirebase();
            // MODIFIED: Get expenseCategories from context
            const { shops, expenseCategories } = useAppData();
            const { where, addDoc, updateDoc, deleteDoc, doc, collection, serverTimestamp } = window.firebaseSDK;

            const [expenses, setExpenses] = useState([]);
            const [loading, setLoading] = useState(true);
            const [isModalOpen, setIsModalOpen] = useState(false);
            const [editingExpense, setEditingExpense] = useState(null);
            const [expenseToDelete, setExpenseToDelete] = useState(null);

            // Filters
            const [selectedShop, setSelectedShop] = useState('');
            const [selectedMonth, setSelectedMonth] = useState(new Date().toISOString().slice(0, 7));
            const [selectedCategory, setSelectedCategory] = useState('');

            // MODIFIED: Use database categories if available, otherwise fallback to defaults
            const categoriesList = useMemo(() => {
                if (expenseCategories && expenseCategories.length > 0) {
                    return expenseCategories.map(c => c.name).sort();
                }
                return ['Utilities (Water/Electric)', 'Internet/Phone', 'Office Supplies', 'Cleaning Supplies', 'Maintenance/Repairs', 'Rent', 'Staff Welfare', 'Transportation', 'Marketing', 'Other'];
            }, [expenseCategories]);

            // Fetch Expenses
            useEffect(() => {
                if (!db || !userProfile) return;
                setLoading(true);

                const { query, onSnapshot, orderBy } = window.firebaseSDK;
                const collectionRef = collection(db, 'shopExpenses');
                
                // Base constraints based on role
                let constraints = [orderBy('date', 'desc')];
                
                if (userProfile.role === 'Shop Manager') {
                    const managedShops = Array.isArray(userProfile.shop) ? userProfile.shop : (userProfile.shop ? [userProfile.shop] : []);
                    if (managedShops.length > 0) {
                        constraints.push(where("shop", "in", managedShops));
                    } else {
                        constraints.push(where("shop", "==", "null"));
                    }
                } else if (userProfile.role === 'Staff') {
                     constraints.push(where("shop", "==", "null")); // Staff cannot see expenses
                }

                const q = query(collectionRef, ...constraints);

                const unsubscribe = onSnapshot(q, (snapshot) => {
                    const items = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    setExpenses(items);
                    setLoading(false);
                }, (error) => {
                    console.error("Error fetching expenses:", error);
                    setLoading(false);
                });

                return () => unsubscribe();
            }, [db, userProfile]);

            // Set initial shop filter
            useEffect(() => {
                if (userProfile && userProfile.role !== 'Admin' && userProfile.role !== 'CEO') {
                    setSelectedShop(Array.isArray(userProfile.shop) ? '' : userProfile.shop || '');
                }
            }, [userProfile]);

            const availableShops = useMemo(() => {
                if (userProfile?.role === 'Admin' || userProfile?.role === 'CEO') return shops;
                if (userProfile?.role === 'Shop Manager' && Array.isArray(userProfile.shop)) {
                    return shops.filter(s => userProfile.shop.includes(s.name));
                }
                return [];
            }, [shops, userProfile]);

            // Filter logic
            const filteredExpenses = useMemo(() => {
                return expenses.filter(exp => {
                    const dateMatch = !selectedMonth || exp.date.startsWith(selectedMonth);
                    const shopMatch = !selectedShop || exp.shop === selectedShop;
                    const catMatch = !selectedCategory || exp.category === selectedCategory;
                    return dateMatch && shopMatch && catMatch;
                });
            }, [expenses, selectedMonth, selectedShop, selectedCategory]);

            // Calculate Total
            const totalAmount = useMemo(() => filteredExpenses.reduce((sum, item) => sum + (parseFloat(item.amount) || 0), 0), [filteredExpenses]);

            // Handlers
            const handleOpenModal = (expense = null) => {
                setEditingExpense(expense);
                setIsModalOpen(true);
            };

            const handleSave = async (formData) => {
                try {
                    const data = { ...formData, amount: parseFloat(formData.amount) };
                    if (editingExpense) {
                        await updateDoc(doc(db, 'shopExpenses', editingExpense.id), { ...data, updatedAt: serverTimestamp() });
                    } else {
                        await addDoc(collection(db, 'shopExpenses'), { ...data, createdAt: serverTimestamp(), createdBy: userProfile.id });
                    }
                    setIsModalOpen(false);
                    setEditingExpense(null);
                } catch (error) {
                    console.error("Error saving expense:", error);
                    alert("Failed to save expense.");
                }
            };

            const handleDelete = async () => {
                if (!expenseToDelete) return;
                try {
                    await deleteDoc(doc(db, 'shopExpenses', expenseToDelete.id));
                    setExpenseToDelete(null);
                } catch (error) {
                    console.error("Error deleting expense:", error);
                }
            };

            const handleExportExcel = () => {
                const data = filteredExpenses.map(e => ({
                    'Date': e.date,
                    'Shop': e.shop,
                    'Category': e.category,
                    'Description': e.description,
                    'Amount (KHR)': e.amount,
                    'Recorded By': e.recordedBy || '-'
                }));
                const ws = XLSX.utils.json_to_sheet(data);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Operational Expenses");
                XLSX.writeFile(wb, `Operational_Expenses_${selectedMonth}.xlsx`);
            };

            const canManage = userProfile?.role === 'Admin' || userProfile?.role === 'CEO' || userProfile?.role === 'Shop Manager';

            return (
                <Card>
                    <div className="flex flex-wrap gap-4 justify-between items-center mb-6">
                        <h3 className="text-xl font-semibold text-slate-100">Operational Expenses</h3>
                        <div className="flex flex-wrap gap-4 items-center">
                            {canManage && (
                                <select value={selectedShop} onChange={e => setSelectedShop(e.target.value)} className="select w-full sm:w-auto">
                                    <option value="">{userProfile.role === 'Admin' || userProfile.role === 'CEO' ? 'All Shops' : 'All My Shops'}</option>
                                    {availableShops.map(s => <option key={s.id} value={s.name}>{s.name}</option>)}
                                </select>
                            )}
                            <input type="month" value={selectedMonth} onChange={e => setSelectedMonth(e.target.value)} className="input w-full sm:w-auto" />
                            <select value={selectedCategory} onChange={e => setSelectedCategory(e.target.value)} className="select w-full sm:w-auto">
                                <option value="">All Categories</option>
                                {/* MODIFIED: Map over the dynamic list */}
                                {categoriesList.map(c => <option key={c} value={c}>{c}</option>)}
                            </select>
                            {canManage && <Button variant="primary" icon="fa-plus" onClick={() => handleOpenModal()}>Add Expense</Button>}
                            <Button variant="success" icon="fa-file-excel" onClick={handleExportExcel}>Excel</Button>
                        </div>
                    </div>

                    {loading ? (
                        <div className="text-center py-10"><i className="fas fa-spinner fa-spin text-3xl text-blue-400"></i></div>
                    ) : (
                        <div className="overflow-x-auto">
                            <table className="min-w-full divide-y divide-slate-700">
                                <thead className="bg-slate-900/50">
                                    <tr>
                                        <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Date</th>
                                        <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Shop</th>
                                        <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Category</th>
                                        <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Description</th>
                                        <th className="px-4 py-3 text-right text-xs font-semibold text-slate-400 uppercase">Amount</th>
                                        {canManage && <th className="px-4 py-3 text-center text-xs font-semibold text-slate-400 uppercase">Actions</th>}
                                    </tr>
                                </thead>
                                <tbody className="divide-y divide-slate-700">
                                    {filteredExpenses.length === 0 ? (
                                        <tr><td colSpan="6" className="px-4 py-8 text-center text-slate-500">No expenses found.</td></tr>
                                    ) : (
                                        filteredExpenses.map(exp => (
                                            <tr key={exp.id} className="hover:bg-slate-700/50">
                                                <td className="px-4 py-4 text-sm text-slate-300 whitespace-nowrap">{exp.date}</td>
                                                <td className="px-4 py-4 text-sm text-slate-300">{exp.shop}</td>
                                                <td className="px-4 py-4 text-sm text-slate-200">
                                                    <span className="px-2 py-1 bg-slate-700 rounded text-xs">{exp.category}</span>
                                                </td>
                                                <td className="px-4 py-4 text-sm text-slate-300">{exp.description}</td>
                                                <td className="px-4 py-4 text-sm text-right font-semibold text-orange-400">{Utils.formatCurrency(exp.amount)}</td>
                                                {canManage && (
                                                    <td className="px-4 py-4 text-center">
                                                        <div className="flex items-center justify-center gap-2">
                                                            <Button variant="icon-edit" icon="fa-edit" onClick={() => handleOpenModal(exp)} />
                                                            <Button variant="icon-delete" icon="fa-trash" onClick={() => setExpenseToDelete(exp)} />
                                                        </div>
                                                    </td>
                                                )}
                                            </tr>
                                        ))
                                    )}
                                </tbody>
                                <tfoot className="bg-slate-900/50">
                                    <tr>
                                        <td colSpan="4" className="px-4 py-3 text-right font-bold text-slate-300 uppercase">Total Expenses</td>
                                        <td className="px-4 py-3 text-right font-bold text-orange-400">{Utils.formatCurrency(totalAmount)}</td>
                                        {canManage && <td></td>}
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                    )}

                    <ExpenseModal 
                        isOpen={isModalOpen} 
                        onClose={() => setIsModalOpen(false)} 
                        onSave={handleSave} 
                        expense={editingExpense} 
                        categories={categoriesList} // MODIFIED: Pass dynamic list
                        availableShops={availableShops}
                        userProfile={userProfile}
                    />
                    <ConfirmationModal 
                        isOpen={!!expenseToDelete} 
                        onClose={() => setExpenseToDelete(null)} 
                        onConfirm={handleDelete} 
                        title="Delete Expense" 
                        message="Are you sure you want to delete this expense record?" 
                    />
                </Card>
            );
        };

        const ExpenseModal = ({ isOpen, onClose, onSave, expense, categories, availableShops, userProfile }) => {
            const [formData, setFormData] = useState({});

            useEffect(() => {
                if (isOpen) {
                    const initialShop = (userProfile.role === 'Shop Manager' && Array.isArray(userProfile.shop) && userProfile.shop.length === 1) 
                        ? userProfile.shop[0] 
                        : '';

                    setFormData(expense || {
                        date: new Date().toISOString().slice(0, 10),
                        shop: initialShop,
                        category: categories[0],
                        amount: '',
                        description: '',
                        recordedBy: userProfile.name
                    });
                }
            }, [isOpen, expense, userProfile]);

            const handleChange = (e) => {
                setFormData(prev => ({ ...prev, [e.target.name]: e.target.value }));
            };

            const handleSubmit = (e) => {
                e.preventDefault();
                if (!formData.amount || formData.amount <= 0) {
                    alert("Please enter a valid amount.");
                    return;
                }
                onSave(formData);
            };

            return (
                <Modal isOpen={isOpen} onClose={onClose} maxWidth="max-w-md">
                    <form onSubmit={handleSubmit}>
                        <ModalHeader title={expense ? "Edit Expense" : "Add Shop Expense"} onClose={onClose} />
                        <ModalBody>
                            <div className="space-y-4">
                                <div>
                                    <label className="text-sm font-medium text-slate-400">
                                        <i className="fas fa-calendar-day mr-2 text-blue-400"></i>Date
                                    </label>
                                    <input type="date" name="date" value={formData.date} onChange={handleChange} className="input" required />
                                </div>
                                <div>
                                    <label className="text-sm font-medium text-slate-400">
                                        <i className="fas fa-store mr-2 text-cyan-400"></i>Shop
                                    </label>
                                    <select name="shop" value={formData.shop} onChange={handleChange} className="select" required>
                                        <option value="">Select Shop</option>
                                        {availableShops.map(s => <option key={s.id} value={s.name}>{s.name}</option>)}
                                    </select>
                                </div>
                                <div>
                                    <label className="text-sm font-medium text-slate-400">
                                        <i className="fas fa-tags mr-2 text-purple-400"></i>Category
                                    </label>
                                    <select name="category" value={formData.category} onChange={handleChange} className="select" required>
                                        {categories.map(c => <option key={c} value={c}>{c}</option>)}
                                    </select>
                                </div>
                                <div>
                                    <label className="text-sm font-medium text-slate-400">
                                        <i className="fas fa-money-bill-wave mr-2 text-green-400"></i>Amount (KHR)
                                    </label>
                                    <input type="number" name="amount" value={formData.amount} onChange={handleChange} className="input font-bold text-orange-400" placeholder="0" required />
                                </div>
                                <div>
                                    <label className="text-sm font-medium text-slate-400">
                                        <i className="fas fa-comment-alt mr-2 text-slate-400"></i>Description / Item Name
                                    </label>
                                    <textarea name="description" value={formData.description} onChange={handleChange} className="input" rows="3" placeholder="e.g., Bought 5 packs of A4 paper"></textarea>
                                </div>
                            </div>
                        </ModalBody>
                        <ModalFooter>
                            <Button variant="secondary" onClick={onClose}>Cancel</Button>
                            <Button type="submit" variant="primary">Save Expense</Button>
                        </ModalFooter>
                    </form>
                </Modal>
            );
        };

        const PayrollExpensesTab = ({ userProfile }) => {
            const { where } = window.firebaseSDK;
            // ... (Previous logic from ExpenseReportPage goes here) ...
            // RE-USE EXISTING LOGIC from the original ExpenseReportPage component
            // to populate this tab.
            
            // COPYING LOGIC FROM OLD ExpenseReportPage
            const { data: payrollHistory } = useCollection('payrollHistory', []); // Query constraints logic handles permissions below
            const { data: shops } = useCollection('shops');
            const [selectedShop, setSelectedShop] = useState('');
            const [selectedMonth, setSelectedMonth] = useState(new Date().toISOString().slice(0, 7));
            
            useEffect(() => {
                if (userProfile && userProfile.role !== 'Admin' && userProfile.role !== 'CEO') {
                    setSelectedShop(Array.isArray(userProfile.shop) ? '' : userProfile.shop || '');
                }
            }, [userProfile]);

            const availableShops = useMemo(() => {
                if (userProfile?.role === 'Admin' || userProfile?.role === 'CEO') return shops;
                if (userProfile?.role === 'Shop Manager' && Array.isArray(userProfile.shop)) {
                    return shops.filter(s => userProfile.shop.includes(s.name));
                }
                return [];
            }, [shops, userProfile]);

            const { expenseSummary, totals } = useMemo(() => {
                if (!payrollHistory.length) return { expenseSummary: [], totals: {} };
                
                // Client-side filtering because useCollection reused logic is tricky here without props
                const filteredHistory = payrollHistory.filter(rec => {
                    const shopMatch = !selectedShop || rec.shop === selectedShop;
                    const monthMatch = !selectedMonth || rec.month === selectedMonth;
                    
                    // Role check
                    let roleMatch = false;
                    if (userProfile?.role === 'Admin' || userProfile?.role === 'CEO') roleMatch = true;
                    else if (userProfile?.role === 'Shop Manager') {
                        const managed = Array.isArray(userProfile.shop) ? userProfile.shop : [userProfile.shop];
                        roleMatch = managed.includes(rec.shop);
                    }
                    
                    return shopMatch && monthMatch && roleMatch;
                });
                
                const summary = filteredHistory.reduce((acc, rec) => {
                    if (!rec.shop || !rec.month) return acc;
                    const key = `${rec.shop}_${rec.month}`;
                    if (!acc[key]) { acc[key] = { month: rec.month, shopName: rec.shop, totalLoanDed: 0, totalOtherDed: 0, totalSavingsDed: 0, totalSavingsPayback: 0, totalFinalSalary: 0 }; }
                    acc[key].totalLoanDed += parseFloat(rec.manualInputs?.loanDeduction) || 0;
                    acc[key].totalOtherDed += parseFloat(rec.calculations?.otherDeductions) || 0;
                    acc[key].totalSavingsDed += parseFloat(rec.calculations?.savingsDeduction) || 0;
                    acc[key].totalSavingsPayback += parseFloat(rec.calculations?.totalSavingsWithdrawal) || 0;
                    acc[key].totalFinalSalary += parseFloat(rec.netSalary) || 0;
                    return acc;
                }, {});

                const summaryArray = Object.values(summary).map(item => {
                    const accountNote = (item.totalFinalSalary || 0) + (item.totalLoanDed || 0) + (item.totalOtherDed || 0) + (item.totalSavingsDed || 0);
                    return { ...item, accountNote };
                }).sort((a, b) => b.month.localeCompare(a.month) || a.shopName.localeCompare(b.shopName));

                const totals = summaryArray.reduce((acc, curr) => { 
                    acc.totalLoanDed += curr.totalLoanDed; 
                    acc.totalOtherDed += curr.totalOtherDed; 
                    acc.totalSavingsDed += curr.totalSavingsDed;
                    acc.totalSavingsPayback += curr.totalSavingsPayback;
                    acc.totalFinalSalary += curr.totalFinalSalary; 
                    acc.totalAccountNote += curr.accountNote;
                    return acc; 
                }, { totalLoanDed: 0, totalOtherDed: 0, totalSavingsDed: 0, totalSavingsPayback: 0, totalFinalSalary: 0, totalAccountNote: 0 });
                
                return { expenseSummary: summaryArray, totals };
            }, [payrollHistory, selectedShop, selectedMonth, userProfile]);
            
            const canFilterByShop = userProfile?.role === 'Admin' || userProfile?.role === 'CEO' || (userProfile?.role === 'Shop Manager' && Array.isArray(userProfile.shop));

            return (
                <Card>
                    <div className="flex flex-wrap gap-4 justify-between items-center mb-6">
                        <h3 className="text-xl font-semibold text-slate-100">Payroll Expense Summary</h3>
                        <div className="flex flex-wrap gap-4 items-center">
                            {canFilterByShop && (
                                <select value={selectedShop} onChange={e => setSelectedShop(e.target.value)} className="select w-full sm:w-auto">
                                    <option value="">{userProfile.role === 'Admin' || userProfile.role === 'CEO' ? 'All Shops' : 'All My Shops'}</option>
                                    {availableShops.map(s => <option key={s.id} value={s.name}>{s.name}</option>)}
                                </select>
                            )}
                            <input type="month" value={selectedMonth} onChange={e => setSelectedMonth(e.target.value)} className="input w-full sm:w-auto" />
                        </div>
                    </div>
                    <div className="overflow-x-auto"><table className="min-w-full divide-y divide-slate-700"><thead className="bg-slate-900/50"><tr><th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Month</th><th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Shop Name</th><th className="px-4 py-3 text-right text-xs font-semibold text-slate-400 uppercase">Total Loan Ded.</th><th className="px-4 py-3 text-right text-xs font-semibold text-slate-400 uppercase">Total Other Ded.</th><th className="px-4 py-3 text-right text-xs font-semibold text-slate-400 uppercase">Saving Program</th><th className="px-4 py-3 text-right text-xs font-semibold text-slate-400 uppercase">Savings Payback</th><th className="px-4 py-3 text-right text-xs font-semibold text-slate-400 uppercase">Total Final Salary</th><th className="px-4 py-3 text-right text-xs font-semibold text-slate-400 uppercase">Account Note</th></tr></thead><tbody className="divide-y divide-slate-700">{expenseSummary.map((item, index) => (<tr key={index} className="hover:bg-slate-700/50"><td className="px-4 py-4 text-sm text-slate-200">{item.month}</td><td className="px-4 py-4 text-sm text-slate-300">{item.shopName}</td><td className="px-4 py-4 text-sm text-slate-300 text-right">{Utils.formatCurrency(item.totalLoanDed)}</td><td className="px-4 py-4 text-sm text-slate-300 text-right">{Utils.formatCurrency(item.totalOtherDed)}</td><td className="px-4 py-4 text-sm text-slate-300 text-right">{Utils.formatCurrency(item.totalSavingsDed)}</td><td className="px-4 py-4 text-sm text-slate-300 text-right">{Utils.formatCurrency(item.totalSavingsPayback)}</td><td className="px-4 py-4 text-sm text-slate-300 text-right font-semibold">{Utils.formatCurrency(item.totalFinalSalary)}</td><td className="px-4 py-4 text-sm text-slate-300 text-right font-semibold">{Utils.formatCurrency(item.accountNote)}</td></tr>))}</tbody><tfoot className="bg-slate-900/50"><tr><td colSpan="2" className="px-4 py-3 text-right font-bold text-slate-300 uppercase">Sub-Total</td><td className="px-4 py-3 text-right font-bold text-slate-300">{Utils.formatCurrency(totals.totalLoanDed)}</td><td className="px-4 py-3 text-right font-bold text-slate-300">{Utils.formatCurrency(totals.totalOtherDed)}</td><td className="px-4 py-3 text-right font-bold text-slate-300">{Utils.formatCurrency(totals.totalSavingsDed)}</td><td className="px-4 py-3 text-right font-bold text-slate-300">{Utils.formatCurrency(totals.totalSavingsPayback)}</td><td className="px-4 py-3 text-right font-bold text-slate-300">{Utils.formatCurrency(totals.totalFinalSalary)}</td><td className="px-4 py-3 text-right font-bold text-slate-300">{Utils.formatCurrency(totals.totalAccountNote)}</td></tr></tfoot></table></div>
                </Card>
            );
        };

        const ExpenseReportPage = ({ userProfile }) => {
            const [activeTab, setActiveTab] = useState('payrollExpenses');
            // MODIFIED: Added icons to tabs
            const tabs = { 
                payrollExpenses: <span><i className="fas fa-file-invoice-dollar mr-2 text-green-400"></i>Payroll Expenses</span>, 
                operationalExpenses: <span><i className="fas fa-receipt mr-2 text-orange-400"></i>Operational Expenses</span> 
            };

            return (
                <TabbedPage tabs={tabs} activeTab={activeTab} setActiveTab={setActiveTab}>
                    <div id="payrollExpenses"><PayrollExpensesTab userProfile={userProfile} /></div>
                    <div id="operationalExpenses"><OperationalExpensesTab userProfile={userProfile} /></div>
                </TabbedPage>
            );
        };
        // --- END EXPENSE REPORT PAGE ---

        // --- NEW: SYSTEM CONFIGURATION TAB (DATABASE INDEXES) ---
        const SysConfigTab = () => {
            const { db } = useFirebase();
            const [indexStatuses, setIndexStatuses] = useState({}); // Stores status for each index

            /* * -------------------------------------------------------------------------
             * DEVELOPER NOTE: INDEX MANAGEMENT
             * -------------------------------------------------------------------------
             * When adding new features that use complex Firestore queries (e.g., combining 
             * 'where' equality checks with 'orderBy' sorting or Range comparisons like <, >), 
             * you MUST add the required Composite Index configuration to the list below.
             * * Format:
             * {
             * title: "Feature Name",
             * description: "Reason for index",
             * collection: "collectionName",
             * scope: "COLLECTION" or "COLLECTION_GROUP",
             * fields: [
             * { name: "fieldName1", mode: "ASCENDING" }, 
             * { name: "fieldName2", mode: "DESCENDING" }
             * ]
             * }
             * -------------------------------------------------------------------------
             */

            // Define the required indexes based on app logic
            const requiredIndexes = [
                // --- TASK MANAGER & KPI ---
                {
                    title: "Tasks: Staff KPI",
                    description: "For 'My KPI Scorecard' (Filter by Staff + Date Range).",
                    collection: "tasks",
                    scope: "COLLECTION",
                    fields: [
                        { name: "staffId", mode: "ASCENDING" },
                        { name: "completedTimestamp", mode: "ASCENDING" }
                    ]
                },
                {
                    title: "Tasks: Shop KPI",
                    description: "For 'KPI Performance Overview' (Filter by Shop + Date Range).",
                    collection: "tasks",
                    scope: "COLLECTION",
                    fields: [
                        { name: "shopName", mode: "ASCENDING" },
                        { name: "completedTimestamp", mode: "ASCENDING" }
                    ]
                },
                {
                    title: "Task Board: Staff View",
                    description: "For Staff Kanban Board (Filter by Staff + Sort Newest).",
                    collection: "tasks",
                    scope: "COLLECTION",
                    fields: [
                        { name: "staffId", mode: "ASCENDING" },
                        { name: "taskTimestamp", mode: "DESCENDING" }
                    ]
                },
                {
                    title: "Task Board: Manager View",
                    description: "For Manager Kanban Board (Filter by Shop + Sort Newest).",
                    collection: "tasks",
                    scope: "COLLECTION",
                    fields: [
                        { name: "shopName", mode: "ASCENDING" },
                        { name: "taskTimestamp", mode: "DESCENDING" }
                    ]
                },

                // --- SAVINGS PROGRAM ---
                {
                    title: "Savings History: By Shop",
                    description: "For Savings Reports (Filter by Shop + Sort Date).",
                    collection: "transactions",
                    scope: "COLLECTION_GROUP", 
                    fields: [
                        { name: "shop", mode: "ASCENDING" },
                        { name: "date", mode: "DESCENDING" }
                    ]
                },
                {
                    title: "Savings History: By Employee",
                    description: "For Staff Savings View (Filter by Employee + Sort Date).",
                    collection: "transactions",
                    scope: "COLLECTION_GROUP",
                    fields: [
                        { name: "employeeId", mode: "ASCENDING" },
                        { name: "date", mode: "DESCENDING" }
                    ]
                },

                // --- EXPENSES ---
                {
                    title: "Shop Expenses: Manager View",
                    description: "For Expense Report (Filter by Shop + Sort Date).",
                    collection: "shopExpenses",
                    scope: "COLLECTION",
                    fields: [
                        { name: "shop", mode: "ASCENDING" },
                        { name: "date", mode: "DESCENDING" }
                    ]
                },

                // --- MEETINGS ---
                {
                    title: "Meetings: General Schedule",
                    description: "For Meeting Room (Sort by Date + Start Time).",
                    collection: "meetings",
                    scope: "COLLECTION",
                    fields: [
                        { name: "date", mode: "ASCENDING" },
                        { name: "startTime", mode: "ASCENDING" }
                    ]
                },

                // --- ADMIN REPORTS (Optimized Server-Side Filtering) ---
                {
                    title: "Attendance Report: By Shop",
                    description: "Optimizes Daily & Monthly Attendance Reports when a specific Shop is selected.",
                    collection: "attendance",
                    scope: "COLLECTION",
                    fields: [
                        { name: "shop", mode: "ASCENDING" },
                        { name: "timestamp", mode: "ASCENDING" }
                    ]
                },
                {
                    title: "Leave Report: By Shop (Start Date)",
                    description: "Optimizes fetching Leave Requests by Shop within a date range.",
                    collection: "leaveRequests",
                    scope: "COLLECTION",
                    fields: [
                        { name: "shop", mode: "ASCENDING" },
                        { name: "leaveDate", mode: "ASCENDING" } 
                    ]
                },
                // --- NEW INDEXES ADDED HERE ---
                {
                    title: "Leave Report: By Shop (Return Date)",
                    description: "Crucial for Admin Reports to find active leaves that overlap with the report period.",
                    collection: "leaveRequests",
                    scope: "COLLECTION",
                    fields: [
                        { name: "shop", mode: "ASCENDING" },
                        { name: "returnDate", mode: "ASCENDING" }
                    ]
                },
                {
                    title: "Dashboard: Manager Pending Leaves",
                    description: "For Shop Managers to count pending leaves in their shops.",
                    collection: "leaveRequests",
                    scope: "COLLECTION",
                    fields: [
                        { name: "shop", mode: "ASCENDING" },
                        { name: "status", mode: "ASCENDING" }
                    ]
                },
                {
                    title: "Dashboard: Manager Pending OT",
                    description: "For Shop Managers to count pending OT in their shops.",
                    collection: "otRequests",
                    scope: "COLLECTION",
                    fields: [
                        { name: "shop", mode: "ASCENDING" },
                        { name: "status", mode: "ASCENDING" }
                    ]
                },
                {
                    title: "Dashboard: Employee Stats",
                    description: "For Staff Dashboard to calculate 'My Stats' (Late/Deductions) by date.",
                    collection: "employeeStates",
                    scope: "COLLECTION",
                    fields: [
                        { name: "staffId", mode: "ASCENDING" },
                        { name: "date", mode: "ASCENDING" }
                    ]
                },
                {
                    title: "Dashboard: Employee OT Stats",
                    description: "For Staff Dashboard to calculate approved OT days in range.",
                    collection: "otRequests",
                    scope: "COLLECTION",
                    fields: [
                        { name: "staffId", mode: "ASCENDING" },
                        { name: "status", mode: "ASCENDING" },
                        { name: "reqDate", mode: "ASCENDING" }
                    ]
                },
                // --- END NEW INDEXES ---
                {
                    title: "OT Report: By Shop",
                    description: "Optimizes fetching OT Requests by Shop within a date range.",
                    collection: "otRequests",
                    scope: "COLLECTION",
                    fields: [
                        { name: "shop", mode: "ASCENDING" },
                        { name: "reqDate", mode: "ASCENDING" }
                    ]
                },
                {
                    title: "Deductions Report: By Shop",
                    description: "Optimizes fetching Employee States (Late/Bonus) by Shop within a date range.",
                    collection: "employeeStates",
                    scope: "COLLECTION",
                    fields: [
                        { name: "shop", mode: "ASCENDING" },
                        { name: "date", mode: "ASCENDING" }
                    ]
                }
            ];

            // NEW: Function to verify index status by running a dummy query
            const checkIndexStatus = async (idx) => {
                // Set status to checking
                setIndexStatuses(prev => ({ ...prev, [idx.title]: { status: 'checking' } }));

                try {
                    const { collection, collectionGroup, query, orderBy, limit, getDocs } = window.firebaseSDK;
                    
                    // 1. Determine Collection Ref based on scope
                    let ref;
                    if (idx.scope === 'COLLECTION_GROUP') {
                        ref = collectionGroup(db, idx.collection);
                    } else {
                        ref = collection(db, idx.collection);
                    }

                    // 2. Build a test query that forces Firestore to check the index
                    let q = ref;
                    idx.fields.forEach(field => {
                        const direction = field.mode === 'ASCENDING' ? 'asc' : 'desc';
                        q = query(q, orderBy(field.name, direction));
                    });
                    q = query(q, limit(1)); // We only need 1 doc to test

                    // 3. Execute
                    await getDocs(q);
                    
                    // If successful, index exists!
                    setIndexStatuses(prev => ({ ...prev, [idx.title]: { status: 'valid' } }));

                } catch (error) {
                    if (error.code === 'failed-precondition') {
                        // This is the specific error for missing index.
                        // Firebase provides the creation link in the error message.
                        const match = error.message.match(/https:\/\/console\.firebase\.google\.com[^\s]+/);
                        const link = match ? match[0] : null;
                        
                        setIndexStatuses(prev => ({ 
                            ...prev, 
                            [idx.title]: { status: 'missing', link: link } 
                        }));
                    } else {
                        console.error("Index check error:", error);
                        setIndexStatuses(prev => ({ 
                            ...prev, 
                            [idx.title]: { status: 'error', message: error.message } 
                        }));
                    }
                }
            };

            return (
                <Card>
                    <PageHeader title="System Configuration & Database Indexes">
                        <div className="bg-blue-900/30 text-blue-200 px-3 py-1 rounded text-xs border border-blue-800">
                            Project ID: <span className="font-mono font-bold text-white">{activeFirebaseConfig.projectId}</span>
                        </div>
                    </PageHeader>

                    <div className="bg-slate-900/50 p-6 rounded-lg border border-slate-700 mb-6">
                        <h4 className="text-lg font-bold text-slate-200 mb-2"><i className="fas fa-database text-yellow-500 mr-2"></i>Database Optimization</h4>
                        <p className="text-sm text-slate-400 mb-4">
                            The following Composite Indexes are required for advanced filtering and reporting features. 
                            Click <strong>"Check Status"</strong> to verify each index. If missing, a direct creation link will be provided.
                        </p>
                        
                        <div className="grid grid-cols-1 gap-4">
                            {requiredIndexes.map((idx, index) => {
                                const statusObj = indexStatuses[idx.title] || { status: 'unknown' };
                                
                                return (
                                    <div key={index} className="flex flex-col sm:flex-row items-start sm:items-center justify-between p-4 bg-slate-800 rounded-lg border border-slate-600 hover:border-slate-500 transition-colors">
                                        <div className="mb-3 sm:mb-0 flex-1">
                                            <div className="flex items-center gap-2">
                                                <h5 className="font-bold text-slate-200 text-sm">{idx.title}</h5>
                                                {statusObj.status === 'valid' && <span className="text-green-400 text-xs font-bold"><i className="fas fa-check-circle"></i> Active</span>}
                                                {statusObj.status === 'missing' && <span className="text-red-400 text-xs font-bold"><i className="fas fa-exclamation-circle"></i> Missing</span>}
                                            </div>
                                            <p className="text-xs text-slate-500 mt-1">{idx.description}</p>
                                            <div className="flex gap-2 mt-2">
                                                <span className="text-[10px] bg-slate-700 text-slate-300 px-2 py-0.5 rounded font-mono">
                                                    {idx.scope === 'COLLECTION_GROUP' ? 'Collection Group' : 'Collection'}: {idx.collection}
                                                </span>
                                                {idx.fields.map(f => (
                                                    <span key={f.name} className="text-[10px] bg-slate-700 text-slate-300 px-2 py-0.5 rounded font-mono">
                                                        {f.name} ({f.mode === 'ASCENDING' ? 'Asc' : 'Desc'})
                                                    </span>
                                                ))}
                                            </div>
                                        </div>
                                        
                                        <div className="flex items-center gap-3">
                                            {statusObj.status === 'missing' && statusObj.link ? (
                                                <a 
                                                    href={statusObj.link} 
                                                    target="_blank" 
                                                    rel="noopener noreferrer"
                                                    className="flex items-center gap-2 bg-yellow-600 hover:bg-yellow-500 text-white text-xs font-bold py-2 px-4 rounded shadow-lg transition-transform active:scale-95 whitespace-nowrap animate-pulse"
                                                >
                                                    <i className="fas fa-hammer"></i> Create Index
                                                </a>
                                            ) : (
                                                <Button 
                                                    onClick={() => checkIndexStatus(idx)} 
                                                    variant="secondary" 
                                                    className="text-xs whitespace-nowrap"
                                                    disabled={statusObj.status === 'checking'}
                                                >
                                                    {statusObj.status === 'checking' ? <i className="fas fa-spinner fa-spin"></i> : (statusObj.status === 'valid' ? 'Re-Check' : 'Check Status')}
                                                </Button>
                                            )}
                                        </div>
                                    </div>
                                );
                            })}
                        </div>
                    </div>
                    
                    <div className="p-4 rounded-lg bg-yellow-900/10 border border-yellow-700/30 text-yellow-200/80 text-xs">
                        <i className="fas fa-info-circle mr-2"></i>
                        <strong>Note:</strong> After clicking "Create Index", it may take several minutes for Firebase to build the index. During this time, the "Check Status" button may still show "Missing".
                    </div>
                </Card>
            );
        };

        // --- START SETTINGS PAGE ---

        // NEW: QR Code Generator Modal for Shop Settings (Phase 1)
        const ShopQRModal = ({ isOpen, onClose, shop }) => {
            const canvasRef = useRef(null);

            useEffect(() => {
                if (isOpen && shop && canvasRef.current) {
                    // Generate QR Code using QRious (Standard resolution for preview)
                    new QRious({
                        element: canvasRef.current,
                        value: shop.name, 
                        size: 250,
                        level: 'H' // High error correction
                    });
                }
            }, [isOpen, shop]);

            // MODIFIED: Updated to generate a High-Resolution composite poster image
            const handleDownload = () => {
                if (!canvasRef.current || !shop) return;

                // Create a temporary canvas to combine text and QR code
                const tempCanvas = document.createElement('canvas');
                const ctx = tempCanvas.getContext('2d');
                
                // Set dimensions (High Res Scale Factor = 4x)
                const scale = 4;
                const width = 400 * scale;  // 1600px
                const height = 520 * scale; // 2080px
                
                tempCanvas.width = width;
                tempCanvas.height = height;

                // 1. White Background
                ctx.fillStyle = '#ffffff';
                ctx.fillRect(0, 0, width, height);

                // 2. Shop Name (Header)
                ctx.fillStyle = '#1e293b'; // slate-800
                ctx.font = `bold ${28 * scale}px sans-serif`; // Scaled Font
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText(shop.name, width / 2, 60 * scale);

                // 3. Draw QR Code with Border
                const qrSize = 250 * scale; // 1000px
                const qrX = (width - qrSize) / 2;
                const qrY = 110 * scale;
                
                // Draw border rect
                ctx.fillStyle = '#1e293b'; 
                const borderSize = 4 * scale;
                ctx.fillRect(qrX - borderSize, qrY - borderSize, qrSize + (borderSize*2), qrSize + (borderSize*2));
                
                // Generate a separate High-Res QR code for the download image
                const highResQrCanvas = document.createElement('canvas');
                new QRious({
                    element: highResQrCanvas,
                    value: shop.name, 
                    size: qrSize, // Generate at full high-res size
                    level: 'H'
                });

                // Draw the high-res QR onto the poster
                ctx.drawImage(highResQrCanvas, qrX, qrY, qrSize, qrSize);

                // 4. Instructions (Footer)
                ctx.fillStyle = '#475569'; // slate-600
                ctx.font = `bold ${18 * scale}px sans-serif`;
                ctx.fillText("Scan to Check In", width / 2, qrY + qrSize + (50 * scale));
                
                ctx.fillStyle = '#94a3b8'; // slate-400
                ctx.font = `${14 * scale}px sans-serif`;
                ctx.fillText("HR System Attendance", width / 2, qrY + qrSize + (80 * scale));

                // 5. Trigger Download
                const link = document.createElement('a');
                link.download = `QR_Poster_${shop.name.replace(/\s+/g, '_')}_HighRes.png`;
                link.href = tempCanvas.toDataURL('image/png');
                link.click();
            };

            if (!shop) return null;

            return (
                <Modal isOpen={isOpen} onClose={onClose} maxWidth="max-w-sm">
                    <ModalHeader title="Shop QR Code" onClose={onClose} />
                    <ModalBody>
                        <div className="flex flex-col items-center justify-center p-6 space-y-6 bg-white rounded-lg border border-slate-200">
                            <h3 className="text-xl font-bold text-slate-800">{shop.name}</h3>
                            <canvas ref={canvasRef} className="border-4 border-slate-800 rounded-lg shadow-xl"></canvas>
                            <div className="text-center space-y-1">
                                <p className="text-sm font-semibold text-slate-600">Scan to Check In</p>
                                <p className="text-xs text-slate-400">Print this and place it at the shop entrance.</p>
                            </div>
                        </div>
                    </ModalBody>
                    <ModalFooter>
                        <Button variant="secondary" onClick={onClose}>Close</Button>
                        <Button variant="primary" onClick={handleDownload} icon="fa-download">Download Poster</Button>
                    </ModalFooter>
                </Modal>
            );
        };

        // NEW: Memo Alert Modal
        const MemoAlertModal = ({ isOpen, onClose, onSave, memo }) => {
            const { shops } = useAppData();
            const [formData, setFormData] = useState({});

            useEffect(() => {
                if (isOpen) {
                    setFormData(memo ? { ...memo } : { 
                        title: '', 
                        content: '', 
                        startTime: '', 
                        endTime: '', 
                        targetShops: [], 
                        status: 'Active',
                        readBy: [] // Initialized Data: Prevent errors with read tracking
                    });
                }
            }, [isOpen, memo]);

            const handleChange = (e) => {
                const { name, value } = e.target;
                setFormData(prev => ({ ...prev, [name]: value }));
            };

            const handleShopToggle = (shopName) => {
                setFormData(prev => {
                    const current = prev.targetShops || [];
                    const updated = current.includes(shopName)
                        ? current.filter(s => s !== shopName)
                        : [...current, shopName];
                    return { ...prev, targetShops: updated };
                });
            };

            const handleSubmit = (e) => {
                e.preventDefault();
                onSave(formData);
            };

            return (
                <Modal isOpen={isOpen} onClose={onClose} maxWidth="max-w-lg">
                    {/* Fixed Layout: Added flex flex-col h-full overflow-hidden */}
                    <form onSubmit={handleSubmit} className="flex flex-col h-full overflow-hidden">
                        <ModalHeader title={memo ? "Edit Memo" : "Add New Memo"} onClose={onClose} />
                        <ModalBody>
                            <div className="space-y-4">
                                <div>
                                    <label className="text-sm font-medium text-slate-400">Title</label>
                                    <input name="title" value={formData.title || ''} onChange={handleChange} className="input" required />
                                </div>
                                <div className="grid grid-cols-2 gap-4">
                                    <div>
                                        <label className="text-sm font-medium text-slate-400">Start Time</label>
                                        <input type="time" name="startTime" value={formData.startTime || ''} onChange={handleChange} className="input" required />
                                    </div>
                                    <div>
                                        <label className="text-sm font-medium text-slate-400">End Time</label>
                                        <input type="time" name="endTime" value={formData.endTime || ''} onChange={handleChange} className="input" required />
                                    </div>
                                </div>
                                <div>
                                    <label className="text-sm font-medium text-slate-400">Content</label>
                                    <textarea name="content" value={formData.content || ''} onChange={handleChange} className="input" rows="3" required></textarea>
                                </div>
                                <div>
                                    <label className="text-sm font-medium text-slate-400 mb-2 block">Target Shops</label>
                                    <div className="grid grid-cols-2 gap-2 p-2 border border-slate-600 rounded bg-slate-700/50 max-h-40 overflow-y-auto">
                                        {shops.map(shop => (
                                            <div key={shop.id} className="flex items-center">
                                                <input 
                                                    type="checkbox" 
                                                    checked={(formData.targetShops || []).includes(shop.name)} 
                                                    onChange={() => handleShopToggle(shop.name)}
                                                    className="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500 bg-slate-600"
                                                />
                                                <label className="ml-2 text-sm text-slate-300">{shop.name}</label>
                                            </div>
                                        ))}
                                    </div>
                                    <p className="text-xs text-slate-500 mt-1">Leave empty to target ALL shops.</p>
                                </div>
                                <div>
                                    <label className="text-sm font-medium text-slate-400">Status</label>
                                    <select name="status" value={formData.status || 'Active'} onChange={handleChange} className="select">
                                        <option value="Active">Active</option>
                                        <option value="Inactive">Inactive</option>
                                    </select>
                                </div>
                            </div>
                        </ModalBody>
                        <ModalFooter>
                            <Button variant="secondary" onClick={onClose}>Cancel</Button>
                            {/* Corrected Button Label */}
                            <Button type="submit" variant="primary">{memo ? "Update Memo" : "Add Memo"}</Button>
                        </ModalFooter>
                    </form>
                </Modal>
            );
        };

        // NEW: Memo Alert Tab
        const MemoAlertTab = () => {
            const { db } = useFirebase();
            const { data: memos, loading } = useCollection('memoAlerts');
            const [isModalOpen, setIsModalOpen] = useState(false);
            const [editingMemo, setEditingMemo] = useState(null);
            const [memoToDelete, setMemoToDelete] = useState(null);

            const handleOpenModal = (memo = null) => {
                setEditingMemo(memo);
                setIsModalOpen(true);
            };
            const handleCloseModal = () => {
                setEditingMemo(null);
                setIsModalOpen(false);
            };

            const handleSave = async (formData) => {
                const { addDoc, updateDoc, doc, collection, serverTimestamp } = window.firebaseSDK;
                const { id, ...dataToSave } = formData;
                
                try {
                    if (id) {
                        await updateDoc(doc(db, 'memoAlerts', id), { ...dataToSave, updatedAt: serverTimestamp() });
                    } else {
                        await addDoc(collection(db, 'memoAlerts'), { ...dataToSave, createdAt: serverTimestamp() });
                    }
                    handleCloseModal();
                } catch (error) {
                    console.error("Error saving memo:", error);
                }
            };

            const handleDeleteConfirm = async () => {
                if (!memoToDelete) return;
                try {
                    await window.firebaseSDK.deleteDoc(window.firebaseSDK.doc(db, 'memoAlerts', memoToDelete.id));
                } catch (error) {
                    console.error("Error deleting memo:", error);
                } finally {
                    setMemoToDelete(null);
                }
            };

            const sortedMemos = useMemo(() => {
                if (!memos) return [];
                return [...memos].sort((a, b) => (a.startTime || '00:00').localeCompare(b.startTime || '00:00'));
            }, [memos]);

            return (
                <Card>
                    <PageHeader title="Memo Alert Management">
                        <Button variant="primary" icon="fa-plus" onClick={() => handleOpenModal()}>Add New Memo</Button>
                    </PageHeader>

                    {loading ? (
                        <div className="text-center py-10"><i className="fas fa-spinner fa-spin text-3xl"></i></div>
                    ) : (
                        <div className="overflow-x-auto">
                            <table className="min-w-full divide-y divide-slate-700">
                                <thead className="bg-slate-900/50">
                                    <tr>
                                        <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Title</th>
                                        <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Time Window</th>
                                        <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Target Shops</th>
                                        <th className="px-4 py-3 text-center text-xs font-semibold text-slate-400 uppercase">Status</th>
                                        <th className="px-4 py-3 text-right text-xs font-semibold text-slate-400 uppercase">Actions</th>
                                    </tr>
                                </thead>
                                <tbody className="divide-y divide-slate-700">
                                    {sortedMemos.map(memo => (
                                        <tr key={memo.id} className="hover:bg-slate-700/50">
                                            <td className="px-4 py-4 text-sm text-slate-200">{memo.title}</td>
                                            <td className="px-4 py-4 text-sm text-slate-300">{memo.startTime} to {memo.endTime}</td>
                                            <td className="px-4 py-4 text-sm text-slate-300">
                                                {(Array.isArray(memo.targetShops) && memo.targetShops.length > 0)
                                                    ? memo.targetShops.join(', ')
                                                    : 'All Shops'
                                                }
                                            </td>
                                            <td className="px-4 py-4 text-center text-sm">
                                                <span className={`px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${memo.status === 'Active' ? 'bg-green-100 text-green-800' : 'bg-slate-100 text-slate-800'}`}>
                                                    {memo.status}
                                                </span>
                                            </td>
                                            <td className="px-4 py-4 text-right">
                                                <div className="flex items-center justify-end gap-4">
                                                    <Button variant="icon-edit" icon="fa-edit" onClick={() => handleOpenModal(memo)} />
                                                    <Button variant="icon-delete" icon="fa-trash" onClick={() => setMemoToDelete(memo)} />
                                                </div>
                                            </td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                    )}
                    <MemoAlertModal isOpen={isModalOpen} onClose={handleCloseModal} onSave={handleSave} memo={editingMemo} />
                    <ConfirmationModal isOpen={!!memoToDelete} onClose={() => setMemoToDelete(null)} onConfirm={handleDeleteConfirm} title="Delete Memo" message={`Are you sure you want to delete the memo "${memoToDelete?.title}"?`} />
                </Card>
            );
        };

        // --- NEW: KPI COMPONENTS (Missing in previous version) ---

        // KPI Modal
        const KPIModal = ({ isOpen, onClose, onSave, kpi }) => {
            const { positions } = useAppData();
            const [formData, setFormData] = useState({});

            useEffect(() => {
                if (isOpen) {
                    setFormData(kpi ? { ...kpi, assignedPositions: kpi.assignedPositions || [] } : { 
                        name: '', 
                        assignedPositions: [] 
                    });
                }
            }, [isOpen, kpi]);

            const handleChange = (e) => {
                const { name, value } = e.target;
                setFormData(prev => ({ ...prev, [name]: value }));
            };

            const handlePositionToggle = (positionName) => {
                setFormData(prev => {
                    const current = prev.assignedPositions || [];
                    const updated = current.includes(positionName)
                        ? current.filter(p => p !== positionName)
                        : [...current, positionName];
                    return { ...prev, assignedPositions: updated };
                });
            };

            const handleSubmit = (e) => {
                e.preventDefault();
                if (!formData.name) {
                    alert("KPI Name is required.");
                    return;
                }
                onSave(formData);
            };

            return (
                <Modal isOpen={isOpen} onClose={onClose} maxWidth="max-w-lg">
                    <form onSubmit={handleSubmit}>
                        <ModalHeader title={kpi ? "Edit KPI" : "Add New KPI"} onClose={onClose} />
                        <ModalBody>
                            <div className="space-y-4">
                                <div>
                                    <label className="text-sm font-medium text-slate-400">
                                        <i className="fas fa-chart-line mr-2 text-blue-400"></i>KPI Name
                                    </label>
                                    <input 
                                        name="name" 
                                        value={formData.name || ''} 
                                        onChange={handleChange} 
                                        className="input" 
                                        placeholder="e.g., Monthly Sales Target" 
                                        required 
                                    />
                                </div>
                                
                                <div>
                                    <label className="text-sm font-medium text-slate-400 mb-2 block">
                                        <i className="fas fa-briefcase mr-2 text-purple-400"></i>Assigned To (Positions)
                                    </label>
                                    <div className="p-3 border border-slate-600 rounded-lg bg-slate-700/50 max-h-60 overflow-y-auto custom-scrollbar">
                                        {positions && positions.length > 0 ? (
                                            <div className="grid grid-cols-1 gap-2">
                                                {positions.map(pos => (
                                                    <div key={pos.id} className="flex items-center hover:bg-slate-700 p-1.5 rounded transition-colors cursor-pointer" onClick={() => handlePositionToggle(pos.position)}>
                                                        <div className={`w-5 h-5 rounded border flex items-center justify-center mr-3 transition-colors ${
                                                            (formData.assignedPositions || []).includes(pos.position) 
                                                                ? 'bg-blue-600 border-blue-600' 
                                                                : 'border-slate-500 bg-slate-800'
                                                        }`}>
                                                            {(formData.assignedPositions || []).includes(pos.position) && <i className="fas fa-check text-white text-xs"></i>}
                                                        </div>
                                                        <span className="text-sm text-slate-200 select-none">{pos.position}</span>
                                                    </div>
                                                ))}
                                            </div>
                                        ) : (
                                            <p className="text-sm text-slate-500 italic text-center py-4">No positions found. Please add positions first.</p>
                                        )}
                                    </div>
                                    <p className="text-xs text-slate-500 mt-2">Select the positions responsible for this KPI.</p>
                                </div>
                            </div>
                        </ModalBody>
                        <ModalFooter>
                            <Button variant="secondary" onClick={onClose}>Cancel</Button>
                            <Button type="submit" variant="primary">Save KPI</Button>
                        </ModalFooter>
                    </form>
                </Modal>
            );
        };

        // KPI Manager Tab Component
        const KPIManagerTab = () => {
            const { db } = useFirebase();
            const { data: kpis, loading } = useCollection('kpis');
            const [isModalOpen, setIsModalOpen] = useState(false);
            const [editingKPI, setEditingKPI] = useState(null);
            const [kpiToDelete, setKPIToDelete] = useState(null);

            const handleOpenModal = (kpi = null) => {
                setEditingKPI(kpi);
                setIsModalOpen(true);
            };

            const handleCloseModal = () => {
                setEditingKPI(null);
                setIsModalOpen(false);
            };

            const handleSave = async (formData) => {
                const { addDoc, updateDoc, doc, collection, serverTimestamp } = window.firebaseSDK;
                const { id, ...dataToSave } = formData;
                
                try {
                    if (id) {
                        await updateDoc(doc(db, 'kpis', id), { ...dataToSave, updatedAt: serverTimestamp() });
                    } else {
                        await addDoc(collection(db, 'kpis'), { ...dataToSave, createdAt: serverTimestamp() });
                    }
                    handleCloseModal();
                } catch (error) {
                    console.error("Error saving KPI:", error);
                    alert("Failed to save KPI.");
                }
            };

            const handleDeleteConfirm = async () => {
                if (!kpiToDelete) return;
                try {
                    await window.firebaseSDK.deleteDoc(window.firebaseSDK.doc(db, 'kpis', kpiToDelete.id));
                } catch (error) {
                    console.error("Error deleting KPI:", error);
                } finally {
                    setKPIToDelete(null);
                }
            };

            return (
                <Card>
                    <PageHeader title="KPI Management">
                        <Button variant="primary" icon="fa-plus" onClick={() => handleOpenModal()}>Add New KPI</Button>
                    </PageHeader>

                    {loading ? (
                        <div className="text-center py-10"><i className="fas fa-spinner fa-spin text-3xl"></i></div>
                    ) : (
                        <div className="overflow-x-auto">
                            <table className="min-w-full divide-y divide-slate-700">
                                <thead className="bg-slate-900/50">
                                    <tr>
                                        <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">KPI Name</th>
                                        <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Assigned To (Positions)</th>
                                        <th className="px-4 py-3 text-right text-xs font-semibold text-slate-400 uppercase">Actions</th>
                                    </tr>
                                </thead>
                                <tbody className="divide-y divide-slate-700">
                                    {kpis.map(kpi => (
                                        <tr key={kpi.id} className="hover:bg-slate-700/50">
                                            <td className="px-4 py-4 text-sm text-slate-200 font-medium">{kpi.name}</td>
                                            <td className="px-4 py-4 text-sm text-slate-300">
                                                {Array.isArray(kpi.assignedPositions) && kpi.assignedPositions.length > 0 
                                                    ? <div className="flex flex-wrap gap-1">
                                                        {kpi.assignedPositions.map((pos, idx) => (
                                                            <span key={idx} className="px-2 py-0.5 rounded-full bg-blue-900/40 text-blue-300 border border-blue-800/50 text-xs">
                                                                {pos}
                                                            </span>
                                                        ))}
                                                      </div>
                                                    : <span className="text-slate-500 italic">None assigned</span>
                                                }
                                            </td>
                                            <td className="px-4 py-4 text-right">
                                                <div className="flex items-center justify-end gap-4">
                                                    <Button variant="icon-edit" icon="fa-edit" onClick={() => handleOpenModal(kpi)} />
                                                    <Button variant="icon-delete" icon="fa-trash" onClick={() => setKPIToDelete(kpi)} />
                                                </div>
                                            </td>
                                        </tr>
                                    ))}
                                    {kpis.length === 0 && (
                                        <tr><td colSpan="3" className="px-4 py-8 text-center text-slate-500">No KPIs found.</td></tr>
                                    )}
                                </tbody>
                            </table>
                        </div>
                    )}
                    
                    <KPIModal isOpen={isModalOpen} onClose={handleCloseModal} onSave={handleSave} kpi={editingKPI} />
                    <ConfirmationModal isOpen={!!kpiToDelete} onClose={() => setKPIToDelete(null)} onConfirm={handleDeleteConfirm} title="Delete KPI" message={`Are you sure you want to delete the KPI "${kpiToDelete?.name}"?`} />
                </Card>
            );
        };

        const SettingsPage = ({ initialTab = 'shop' }) => {
            // REDUNDANCY FIX: Use global context data instead of fetching collections again
            const { shops, positions, shifts, expenseCategories } = useAppData();
            
            const [activeTab, setActiveTab] = useState(initialTab);
            const { userProfile } = useFirebase(); 

            useEffect(() => {
                setActiveTab(initialTab);
            }, [initialTab]);
            
            // MODIFIED: Added icons to the tabs
            const tabs = useMemo(() => {
                const baseTabs = { 
                    shop: <span><i className="fas fa-building mr-2 text-blue-400"></i>Shop & Shift Management</span>, 
                    // REVISED: Renamed Position tab to include KPI
                    position: <span><i className="fas fa-id-badge mr-2 text-purple-400"></i>Position & KPI</span>,
                    // REMOVED: kpi tab is now integrated into position
                    expenses: <span><i className="fas fa-tags mr-2 text-green-400"></i>Expense Categories</span>, 
                    memo: <span><i className="fas fa-bell mr-2 text-yellow-400"></i>Memo Alert</span> 
                };

                // NEW: Add Sys Config tab only for Admin/CEO
                if (userProfile?.role === 'Admin' || userProfile?.role === 'CEO') {
                    baseTabs.sysConfig = <span><i className="fas fa-cogs mr-2 text-red-400"></i>System Config</span>;
                }

                return baseTabs;
            }, [userProfile]);

            // NEW: Timezone options for shop settings
            const timezoneOptions = [
                'Asia/Phnom_Penh',
                'Asia/Bangkok',
                'Asia/Ho_Chi_Minh',
                'Asia/Singapore',
                'Asia/Kuala_Lumpur',
                'Asia/Tokyo',
                'Europe/London',
                'America/New_York',
                'UTC'
            ];

            // Configuration for the generic CRUD component for Shops
            const shopFormFields = [
                { name: 'name', label: 'Shop Name', icon: 'fa-store', required: true }, 
                { name: 'latitude', label: 'Latitude', icon: 'fa-location-dot' }, 
                { name: 'longitude', label: 'Longitude', icon: 'fa-location-crosshairs' }, 
                { name: 'radius', label: 'Radius (m)', type: 'number', icon: 'fa-circle-notch' }, 
                { name: 'timezone', label: 'Time Zone', type: 'select', options: timezoneOptions, required: true, icon: 'fa-globe' },
                { name: 'note', label: 'Note', fullWidth: true, icon: 'fa-sticky-note' }
            ];

            const shopListColumns = [
                { header: 'Shop Name', accessor: 'name' },
                { header: 'Time Zone', accessor: 'timezone' },
                { header: 'Radius (m)', accessor: 'radius' },
                { header: 'Note', accessor: 'note' }
            ];

            const shopNames = useMemo(() => shops.map(s => s.name), [shops]);

            const shiftFormFields = [
                { name: 'shopName', label: 'Shop Name', type: 'select', options: shopNames, required: true, icon: 'fa-store' },
                { name: 'name', label: 'Shift Name', required: true, icon: 'fa-clock' },
                { name: 'startTime', label: 'Start Time', type: 'time', icon: 'fa-hourglass-start' },
                { name: 'endTime', label: 'End Time', type: 'time', icon: 'fa-hourglass-end' },
                { name: 'lateThreshold', label: 'Standard Late Limit', type: 'time', icon: 'fa-user-clock' },
                { name: 'amLeaveThreshold', label: 'AM Leave Check-In Limit (Afternoon Start)', type: 'time', icon: 'fa-sun' },
                { name: 'pmLeaveThreshold', label: 'PM Leave Check-In Limit (Morning Start)', type: 'time', icon: 'fa-moon' }
            ];
            
            const shiftListColumns = [
                { header: 'Shift Name', accessor: 'name' },
                { header: 'Start', accessor: 'startTime' },
                { header: 'Standard Late', accessor: 'lateThreshold' },
                { header: 'AM Leave Limit', accessor: 'amLeaveThreshold' },
                { header: 'PM Leave Limit', accessor: 'pmLeaveThreshold' }
            ];

            const positionFormFields = [
                { name: 'position', label: 'Position Name', required: true, icon: 'fa-briefcase' }
            ];
            
            const positionListColumns = [
                { header: 'Position Name', accessor: 'position' }
            ];
            
            const expenseCategoryFormFields = [
                { name: 'name', label: 'Category Name', required: true, icon: 'fa-tag' }
            ];
            
            const expenseCategoryListColumns = [
                { header: 'Category Name', accessor: 'name' }
            ];

            return (
                <TabbedPage tabs={tabs} activeTab={activeTab} setActiveTab={setActiveTab}>
                    <div id="shop">
                        <SettingsCRUD title="Shop" collectionName="shops" items={shops} formFields={shopFormFields} listColumns={shopListColumns} />
                        <div className="mt-8">
                           <SettingsCRUD title="Shift" collectionName="shifts" items={shifts} formFields={shiftFormFields} listColumns={shiftListColumns} />
                        </div>
                    </div>
                    {/* REVISED: Integrated KPI Manager into Position Tab */}
                    <div id="position">
                        <SettingsCRUD title="Position" collectionName="positions" items={positions} formFields={positionFormFields} listColumns={positionListColumns} />
                        <div className="mt-8">
                            <KPIManagerTab />
                        </div>
                    </div>
                    {/* <div id="kpi"><KPIManagerTab /></div> REMOVED standalone KPI tab */}
                    <div id="expenses">
                        <SettingsCRUD 
                            title="Expense Category" 
                            collectionName="expenseCategories" 
                            items={expenseCategories} 
                            formFields={expenseCategoryFormFields} 
                            listColumns={expenseCategoryListColumns} 
                        />
                    </div>
                    <div id="memo"><MemoAlertTab /></div>
                    {/* NEW: Render Sys Config Tab */}
                    {(userProfile?.role === 'Admin' || userProfile?.role === 'CEO') && (
                        <div id="sysConfig"><SysConfigTab /></div>
                    )}
                </TabbedPage>
            );
        }

        // NEW: Component for manually triggering payroll for a whole shop
        const TriggerSalaryTab = () => {
            const { db, userProfile } = useFirebase(); // MODIFIED: Added useFirebase hook to get db
            const [selectedShop, setSelectedShop] = useState('');
            const [selectedMonth, setSelectedMonth] = useState(new Date().toISOString().slice(0, 7));
            const [triggerConfirmed, setTriggerConfirmed] = useState(false);
            const [isProcessing, setIsProcessing] = useState(false);
            const [processLog, setProcessLog] = useState([]);
            const [processComplete, setProcessComplete] = useState(false);

            // Use static collection for shops dropdown only
            const { data: allShops } = useStaticCollection('shops');

            const handleTriggerPayroll = async () => {
                if (!triggerConfirmed || !selectedShop || !selectedMonth) {
                    alert("Please select a shop, month, and confirm the action.");
                    return;
                }

                setIsProcessing(true);
                setProcessLog([]);
                setProcessComplete(false);

                // --- OPTIMIZED DATA FETCHING ---
                setProcessLog(prev => [...prev, 'Fetching data for selected month...']);

                const { collection, getDocs, query, where, writeBatch, doc, serverTimestamp } = window.firebaseSDK;

                let allShopsData, employees, attendance, leaveRequests, otRequests, staffLoans, employeeStates, salaryRevisions;
                let savingsData;

                try {
                    // 1. Calculate Date Range for the selected month to filter queries
                    const [y, m] = selectedMonth.split('-').map(Number);
                    // Start of month
                    const startOfMonth = new Date(y, m - 1, 1);
                    // End of month (last millisecond)
                    const endOfMonth = new Date(y, m, 0, 23, 59, 59, 999);
                    
                    // String formats for fields that store dates as strings (YYYY-MM-DD)
                    const startStr = startOfMonth.toISOString().slice(0, 10);
                    const endStr = endOfMonth.toISOString().slice(0, 10);

                    // 2. Prepare Optimized Queries
                    const [
                        shopsSnap,
                        empSnap,
                        attSnap,
                        leaveSnap,
                        otSnap,
                        loanSnap,
                        stateSnap,
                        revSnap,
                        savingsSnap
                    ] = await Promise.all([
                        getDocs(collection(db, 'shops')),
                        getDocs(collection(db, 'employees')), // Employees are needed to check status
                        
                        // OPTIMIZATION: Only fetch attendance for the specific month
                        getDocs(query(collection(db, 'attendance'), where('timestamp', '>=', startOfMonth), where('timestamp', '<=', endOfMonth))),
                        
                        // OPTIMIZATION: Only fetch leave overlapping the month
                        getDocs(query(collection(db, 'leaveRequests'), where('leaveDate', '<=', endStr))), 
                        
                        // OPTIMIZATION: Only fetch OT in range
                        getDocs(query(collection(db, 'otRequests'), where('reqDate', '>=', startStr), where('reqDate', '<=', endStr))),
                        
                        getDocs(collection(db, 'staffLoans')), // Active loans needed
                        
                        // OPTIMIZATION: Only fetch states (deductions/engagements) in range
                        getDocs(query(collection(db, 'employeeStates'), where('date', '>=', startStr), where('date', '<=', endStr))),
                        
                        getDocs(collection(db, 'salaryRevisions')), // Revisions history needed
                        getDocs(collection(db, 'savingprogram'))    // Savings status needed
                    ]);

                    allShopsData = shopsSnap.docs.map(d => ({ id: d.id, ...d.data() }));
                    employees = empSnap.docs.map(d => ({ id: d.id, ...d.data() }));
                    attendance = attSnap.docs.map(d => ({ id: d.id, ...d.data() }));
                    leaveRequests = leaveSnap.docs.map(d => ({ id: d.id, ...d.data() }));
                    otRequests = otSnap.docs.map(d => ({ id: d.id, ...d.data() }));
                    staffLoans = loanSnap.docs.map(d => ({ id: d.id, ...d.data() }));
                    employeeStates = stateSnap.docs.map(d => ({ id: d.id, ...d.data() }));
                    salaryRevisions = revSnap.docs.map(d => ({ id: d.id, ...d.data() }));
                    savingsData = savingsSnap.docs.map(d => ({ id: d.id, ...d.data() }));

                    setProcessLog(prev => [...prev, `Data fetched. (${attendance.length} attendance records found for this month)`]);

                } catch (fetchError) {
                    console.error("Critical error fetching bulk data:", fetchError);
                    setProcessLog(prev => [...prev, `FATAL ERROR: Could not fetch data. ${fetchError.message}`]);
                    setIsProcessing(false);
                    return;
                }
                // --- END OPTIMIZATION ---

                // MODIFIED: Use the locally fetched data
                const allData = { shops: allShopsData, employees, attendance, leaveRequests, otRequests, staffLoans, employeeStates, salaryRevisions };
                // MODIFIED (STEP 5): Create a Map for savings data
                const savingsDataMap = new Map(savingsData.map(d => [d.id, d]));

                let employeesToProcess = [];
                if (selectedShop === 'ALL_SHOPS') {
                    employeesToProcess = employees.filter(e => e.status === 'Active');
                } else {
                    employeesToProcess = employees.filter(e => e.status === 'Active' && (Array.isArray(e.shop) ? e.shop.includes(selectedShop) : e.shop === selectedShop));
                }

                if (employeesToProcess.length === 0) {
                    setProcessLog(['No active employees found for the selected shop.']);
                    setIsProcessing(false);
                    return;
                }

                setProcessLog(prev => [...prev, `Found ${employeesToProcess.length} employees. Starting payroll generation...`]);
                
                // --- NEW: Re-calculate dates for the transaction query loop ---
                const [year, month] = selectedMonth.split('-').map(Number);
                const startDate = new Date(year, month - 1, 1);
                const endDate = new Date(year, month, 0, 23, 59, 59, 999);

                let successCount = 0;
                for (const employee of employeesToProcess) {
                    await new Promise(res => setTimeout(res, 50)); // Tiny delay for UI to update
                    
                    // --- DUPLICATE CHECK ---
                    try {
                        const payrollCheckQuery = query(
                            collection(db, "payrollHistory"), 
                            where("employeeId", "==", employee.id), 
                            where("month", "==", selectedMonth)
                        );
                        const existingPayrollSnap = await getDocs(payrollCheckQuery);
                        
                        if (!existingPayrollSnap.empty) {
                            setProcessLog(prev => [...prev, `[Skipped] ${employee.name}: Payroll record already exists for ${selectedMonth}.`]);
                            continue; 
                        }
                    } catch (checkError) {
                        setProcessLog(prev => [...prev, `[Error] Failed to check duplicates for ${employee.name}: ${checkError.message}`]);
                        continue; 
                    }

                    setProcessLog(prev => [...prev, `[${successCount + 1}/${employeesToProcess.length}] Calculating for ${employee.name}...`]);

                    // --- FETCH SAVINGS WITHDRAWALS ---
                    let employeeSavingsWithdrawals = [];
                    try {
                        const q = query(
                            collection(db, 'savingprogram', employee.id, 'transactions'),
                            where("date", ">=", startDate),
                            where("date", "<=", endDate)
                        );
                        
                        const querySnapshot = await getDocs(q);
                        employeeSavingsWithdrawals = querySnapshot.docs
                            .map(doc => ({ id: doc.id, ...doc.data() }))
                            .filter(tx => tx.type === 'withdrawal');
                            
                        if (employeeSavingsWithdrawals.length > 0) {
                             setProcessLog(prev => [...prev.slice(0, -1), `[${successCount + 1}/${employeesToProcess.length}] Calculating for ${employee.name}... (Found ${employeeSavingsWithdrawals.length} withdrawals)`]);
                        }
                    } catch (error) {
                        console.error(`Error fetching savings withdrawals for ${employee.name}:`, error);
                         // Don't stop the process, just log
                    }

                    const employeeSavingsData = savingsDataMap.get(employee.id) || null;
                    
                    const { inputs, calculations } = calculatePayrollForEmployee(employee, selectedMonth, allData, undefined, employeeSavingsWithdrawals, employeeSavingsData);
                    
                    if (calculations.netSalary !== undefined) {
                        const batch = writeBatch(db);
                        
                        const shopName = Array.isArray(employee.shop) ? employee.shop[0] : employee.shop;
                        const payrollData = { month: selectedMonth, shop: shopName, employeeId: employee.id, employeeName: employee.name, baseSalary: calculations.baseSalary, netSalary: calculations.netSalary, manualInputs: inputs, calculations: calculations, createdAt: serverTimestamp() };
                        
                        const payrollDocRef = doc(collection(db, "payrollHistory"));
                        batch.set(payrollDocRef, payrollData);
                        
                        // Handle loan deduction
                        if (inputs.loanDeduction > 0) {
                            const applicableLoans = (staffLoans || [])
                                .filter(l => l.staffId === employee.id && l.status === 'Active' && (!l.effectiveDate || l.effectiveDate.slice(0, 7) <= selectedMonth))
                                .sort((a, b) => (b.effectiveDate || '0000-00').localeCompare(a.effectiveDate || '0000-00'));
                            
                            const activeLoan = applicableLoans.length > 0 ? applicableLoans[0] : null;

                            if (activeLoan) {
                                const newTotalPaid = (activeLoan.totalPaid || 0) + inputs.loanDeduction;
                                const newBalance = activeLoan.loanAmount - newTotalPaid;
                                const newStatus = newBalance <= 0 ? 'Paid Off' : 'Active';
                                
                                batch.update(doc(db, 'staffLoans', activeLoan.id), { totalPaid: newTotalPaid, status: newStatus });
                                
                                batch.set(doc(collection(db, 'loanPayments')), { 
                                    paymentDate: `${selectedMonth}-${new Date(year, month, 0).getDate()}`, 
                                    staffId: employee.id, 
                                    staffName: employee.name, 
                                    shop: shopName, 
                                    loanId: activeLoan.id, 
                                    amountPaid: inputs.loanDeduction, 
                                    remainingBalance: newBalance, 
                                    note: "Paid via payroll",
                                    payrollId: payrollDocRef.id 
                                });
                            }
                        }

                        // --- Commit and Process Savings ---
                        try {
                            await batch.commit();

                            if (calculations.savingsDeduction > 0) {
                                await Utils.manageSavingsContribution(
                                    db,
                                    employee.id,
                                    employee.name,
                                    shopName,
                                    calculations.savingsDeduction,
                                    payrollDocRef.id
                                );
                            }

                            successCount++;
                            setProcessLog(prev => [...prev.slice(0, -1), `[${successCount}/${employeesToProcess.length}] Successfully processed for ${employee.name}.`]);
                        
                        } catch (error) {
                             setProcessLog(prev => [...prev.slice(0, -1), `[Error] Failed to save for ${employee.name}: ${error.message}`]);
                        }
                    } else {
                         setProcessLog(prev => [...prev.slice(0, -1), `[Skipped] Could not calculate salary for ${employee.name}.`]);
                    }
                }

                setProcessLog(prev => [...prev, `\nProcess finished. Successfully generated payroll for ${successCount} out of ${employeesToProcess.length} employees.`]);
                setIsProcessing(false);
                setProcessComplete(true);
                setTriggerConfirmed(false); 
            };

            return (
                <Card>
                    <CardTitle>Trigger Bulk Salary Calculation</CardTitle>
                    <div className="max-w-xl mx-auto space-y-6">
                        <p className="text-slate-400">This tool allows you to generate payroll for all active employees in a selected shop for a specific month. The results will be saved to the Payroll History.</p>
                        
                        <div>
                            <label className="text-sm font-medium text-slate-400"><i className="fas fa-calendar-alt mr-2 text-blue-400"></i>Select Month</label>
                            <input type="month" value={selectedMonth} onChange={e => setSelectedMonth(e.target.value)} className="input" disabled={isProcessing} />
                        </div>

                        <div>
                            <label className="text-sm font-medium text-slate-400"><i className="fas fa-store mr-2 text-cyan-400"></i>Select Shop</label>
                            <select value={selectedShop} onChange={e => setSelectedShop(e.target.value)} className="select" disabled={isProcessing}>
                                <option value="">-- Select a Shop --</option>
                                <option value="ALL_SHOPS">All Shops (Admin Only)</option>
                                {allShops.map(s => <option key={s.id} value={s.name}>{s.name}</option>)}
                            </select>
                        </div>
                        
                        <div className="p-4 border border-yellow-600 bg-yellow-900/20 rounded-lg space-y-3">
                            <h4 className="font-bold text-yellow-300">Confirmation</h4>
                            <div className="flex items-start">
                                <input id="confirm-trigger" type="checkbox" checked={triggerConfirmed} onChange={e => setTriggerConfirmed(e.target.checked)} className="h-5 w-5 rounded border-gray-300 text-blue-600 focus:ring-blue-500 bg-slate-600 mt-1" disabled={isProcessing} />
                                <label htmlFor="confirm-trigger" className="ml-3 text-sm text-slate-300">I understand that this action will generate and save payroll records for all employees in the selected shop and month. This may overwrite existing records if run multiple times.</label>
                            </div>
                        </div>

                        <Button 
                            onClick={handleTriggerPayroll} 
                            disabled={!triggerConfirmed || isProcessing || !selectedShop}
                            variant="danger"
                            className="w-full py-3 text-base"
                        >
                            {isProcessing ? <><i className="fas fa-spinner fa-spin"></i> Processing...</> : <><i className="fas fa-bolt"></i> Trigger Payroll Generation</>}
                        </Button>
                        
                        {(isProcessing || processLog.length > 0) && (
                            <div className="mt-6">
                                <h4 className="font-semibold text-slate-200">Processing Log:</h4>
                                <pre className="mt-2 bg-slate-900/70 p-4 rounded-lg text-sm text-slate-300 h-64 overflow-y-auto font-mono">
                                    {processLog.join('\n')}
                                </pre>
                            </div>
                        )}
                        {processComplete && (
                             <div className="mt-4 p-4 text-center bg-green-900/50 border border-green-700 rounded-lg">
                                <p className="font-semibold text-green-300">Process Complete!</p>
                            </div>
                        )}
                    </div>
                </Card>
            );
        };

        // Generic component for CRUD operations (Create, Read, Update, Delete)
        function SettingsCRUD({ title, collectionName, items, formFields, listColumns }) {
            const { db } = useFirebase();
            const [editingItem, setEditingItem] = useState(null);
            const [itemToDelete, setItemToDelete] = useState(null);
            
            // NEW: QR Modal State (Phase 1)
            const [qrShop, setQrShop] = useState(null);

            // --- MODIFIED: Robust Initial State Logic ---
            // Ensure arrays (for checkbox-groups) are initialized as [] and strings as ''
            const getInitialState = useCallback(() => formFields.reduce((acc, field) => {
                if (field.type === 'checkbox-group') {
                    acc[field.name] = []; 
                } else {
                    acc[field.name] = '';
                }
                return acc;
            }, {}), [formFields]);

            const [newItem, setNewItem] = useState(getInitialState());

            useEffect(() => { setNewItem(getInitialState()); }, [getInitialState]);

            // Memoized grouping logic specifically for shifts
            const groupedItems = useMemo(() => {
                if (collectionName !== 'shifts') return null;

                // Group items by shopName
                const grouped = items.reduce((acc, item) => {
                    const groupKey = item.shopName || 'Uncategorized';
                    if (!acc[groupKey]) {
                        acc[groupKey] = [];
                    }
                    acc[groupKey].push(item);
                    return acc;
                }, {});

                // Sort shifts within each group (e.g., AM, PM)
                Object.keys(grouped).forEach(shop => {
                    grouped[shop].sort((a, b) => a.name.localeCompare(b.name));
                });

                return grouped;
            }, [items, collectionName]);

            // NEW: Get sorted keys for rendering the groups in alphabetical order
            const sortedGroupKeys = useMemo(() => {
                if (!groupedItems) return [];
                return Object.keys(groupedItems).sort();
            }, [groupedItems]);


            const handleSave = useCallback(async (item) => {
                const { doc, updateDoc, addDoc, collection } = window.firebaseSDK;
                
                // --- BUG FIX: Check for duplicates on BOTH Create and Update ---
                if (collectionName === 'shifts') {
                    const isDuplicate = items.some(existingShift => 
                        existingShift.name === item.name && 
                        existingShift.shopName === item.shopName &&
                        existingShift.id !== item.id // Exclude itself when editing
                    );

                    if (isDuplicate) {
                        alert(`A shift with the name "${item.name}" already exists for "${item.shopName}". Please choose a different name.`);
                        return; // Stop the save
                    }
                }
                // --- END FIX ---

                try {
                    if (item.id) { const { id, ...data } = item; await updateDoc(doc(db, collectionName, id), data); } 
                    else { 
                        await addDoc(collection(db, collectionName), item); 
                    }
                    setEditingItem(null); setNewItem(getInitialState());
                } catch (e) { console.error(`Error saving ${collectionName}:`, e); }
            }, [db, collectionName, getInitialState, items]); 
            
            const handleDelete = useCallback(async () => {
                if (!itemToDelete) return;
                try { 
                    await window.firebaseSDK.deleteDoc(window.firebaseSDK.doc(db, collectionName, itemToDelete.id)); 
                } catch (e) { 
                    console.error(`Error deleting ${collectionName}:`, e); 
                } finally {
                    setItemToDelete(null);
                }
            }, [db, collectionName, itemToDelete]);

            // Reusable form renderer
            // MODIFIED: Added logic to render icons in labels
            const renderForm = (item, setItem, isNew = false) => (
                <form onSubmit={(e) => { e.preventDefault(); handleSave(item); }} className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-4 items-end p-4 bg-slate-800/50 rounded-lg mb-6 border border-slate-700">
                    {formFields.map(field => (
                        <div key={field.name} className={field.fullWidth ? 'col-span-full' : 'sm:col-span-1'}>
                            <label className="block text-sm font-medium text-slate-400 mb-1">
                                {field.icon && <i className={`fas ${field.icon} mr-2 text-blue-400`}></i>}
                                {field.label}
                            </label>
                            {field.type === 'select' ? (
                                <select name={field.name} value={item[field.name] || ''} onChange={(e) => setItem({...item, [field.name]: e.target.value})} className="select" required={field.required}>
                                    <option value="">Select {field.label}</option>
                                    {(field.options || []).map(option => (<option key={option} value={option}>{option}</option>))}
                                </select>
                            ) : field.type === 'checkbox-group' ? (
                                // --- NEW: Checkbox Group Renderer ---
                                // Optimization: Added max-height and scrolling for large lists of positions
                                <div className="mt-2 grid grid-cols-2 gap-2 p-2 border border-slate-600 rounded bg-slate-700/50 max-h-32 overflow-y-auto">
                                    {(field.options || []).map(opt => (
                                        <div key={opt.id} className="flex items-center">
                                            <input 
                                                type="checkbox" 
                                                id={`${field.name}-${opt.id}`} 
                                                name={field.name} 
                                                value={opt.id} 
                                                // Check if the ID is in the current array
                                                checked={(item[field.name] || []).includes(opt.id)} 
                                                onChange={(e) => {
                                                    const checked = e.target.checked;
                                                    const val = opt.id;
                                                    const current = item[field.name] || [];
                                                    // Add or Remove from array
                                                    const updated = checked ? [...current, val] : current.filter(v => v !== val);
                                                    setItem({...item, [field.name]: updated});
                                                }}
                                                className="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500 bg-slate-600"
                                            />
                                            <label htmlFor={`${field.name}-${opt.id}`} className="ml-2 text-xs text-slate-300 truncate cursor-pointer">{opt.name}</label>
                                        </div>
                                    ))}
                                </div>
                            ) : (
                                <input type={field.type || 'text'} name={field.name} value={item[field.name] || ''} onChange={(e) => setItem({...item, [field.name]: e.target.value})} className="input" required={field.required} />
                            )}
                        </div>
                    ))}
                    <div className="flex space-x-2 col-span-full md:col-span-1 self-end mt-4 md:mt-0">
                        <Button type="submit" variant="primary" className="w-full">{isNew ? `Add ${title}` : 'Save'}</Button>
                        {!isNew && <Button type="button" variant="secondary" onClick={() => setEditingItem(null)} className="w-full">Cancel</Button>}
                    </div>
                </form>
            );

            // OPTIMIZATION: Refactored UI to use PageHeader
            return (
                <Card>
                    <PageHeader title={`${title} Management`} />
                    {renderForm(newItem, setNewItem, true)}
                    <div className="overflow-x-auto">
                        <table className="min-w-full divide-y divide-slate-700">
                            <thead className="bg-slate-900/50">
                                <tr>
                                    {listColumns.map(col => <th key={col.accessor} className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">{col.header}</th>)}
                                    <th className="px-4 py-3 text-right text-xs font-semibold text-slate-400 uppercase">Actions</th>
                                </tr>
                            </thead>
                            <tbody className="divide-y divide-slate-700">
                                {/* NEW: Conditional rendering for grouped shifts vs. flat lists */}
                                {collectionName === 'shifts' && groupedItems ? (
                                    sortedGroupKeys.map(shopName => (
                                        <React.Fragment key={shopName}>
                                            <tr className="bg-slate-900">
                                                <td colSpan={listColumns.length + 1} className="px-4 py-2 text-sm font-semibold text-blue-400 tracking-wider">
                                                    {shopName}
                                                </td>
                                            </tr>
                                            {groupedItems[shopName].map(item => (
                                                <tr key={item.id} className="hover:bg-slate-700/50">
                                                    {editingItem?.id === item.id ? (
                                                        <td colSpan={listColumns.length + 1} className="p-0">{renderForm(editingItem, setEditingItem)}</td>
                                                    ) : (
                                                        <>
                                                            {listColumns.map(col => <td key={col.accessor} className="px-4 py-4 text-sm text-slate-300">{col.render ? col.render(item) : item[col.accessor]}</td>)}
                                                            <td className="px-4 py-4 text-sm">
                                                                <div className="flex items-center justify-end gap-4">
                                                                    <Button variant="icon-edit" icon="fa-edit" onClick={() => setEditingItem({ ...item })} />
                                                                    <Button variant="icon-delete" icon="fa-trash" onClick={() => setItemToDelete(item)} />
                                                                </div>
                                                            </td>
                                                        </>
                                                    )}
                                                </tr>
                                            ))}
                                        </React.Fragment>
                                    ))
                                ) : (
                                    items.map(item => (
                                        <tr key={item.id} className="hover:bg-slate-700/50">
                                            {editingItem?.id === item.id ? (
                                                <td colSpan={listColumns.length + 1} className="p-0">{renderForm(editingItem, setEditingItem)}</td>
                                            ) : (
                                                <>
                                                    {listColumns.map(col => <td key={col.accessor} className="px-4 py-4 text-sm text-slate-300">{col.render ? col.render(item) : item[col.accessor]}</td>)}
                                                    <td className="px-4 py-4 text-sm">
                                                        <div className="flex items-center justify-end gap-2">
                                                            {/* NEW: Add QR Button for Shops (Phase 1) */}
                                                            {collectionName === 'shops' && (
                                                                <Button variant="icon-view" icon="fa-qrcode" onClick={() => setQrShop(item)} title="Generate QR Code" className="text-purple-400 hover:text-purple-300" />
                                                            )}
                                                            <Button variant="icon-edit" icon="fa-edit" onClick={() => setEditingItem({ ...item })} />
                                                            <Button variant="icon-delete" icon="fa-trash" onClick={() => setItemToDelete(item)} />
                                                        </div>
                                                    </td>
                                                </>
                                            )}
                                        </tr>
                                    ))
                                )}
                            </tbody>
                        </table>
                    </div>
                    <ConfirmationModal isOpen={!!itemToDelete} onClose={() => setItemToDelete(null)} onConfirm={handleDelete} title={`Delete ${title}`} message="Are you sure you want to delete this item?" />
                    
                    {/* NEW: Render QR Modal (Phase 1) */}
                    <ShopQRModal isOpen={!!qrShop} onClose={() => setQrShop(null)} shop={qrShop} />
                </Card>
            );
        }
        // --- END SETTINGS PAGE ---

        // --- START ASSET MANAGER PAGE (NEW) ---
        
        // Modal for Adding/Editing Assets
        const AssetModal = ({ isOpen, onClose, onSave, asset, userProfile }) => {
            const [formData, setFormData] = useState({});
            // MODIFIED: Get employees from context to populate the list
            const { shops, employees } = useAppData();

            // OPTIMIZATION: Use the new hook
            const availableShops = useAllowedShops(userProfile, shops);

            // NEW: Filter employees for the selected shop
            const shopEmployees = useMemo(() => {
                if (!formData.shop) return [];
                return employees.filter(e => {
                    const empShops = Array.isArray(e.shop) ? e.shop : [e.shop];
                    return empShops.includes(formData.shop) && e.status === 'Active';
                });
            }, [formData.shop, employees]);

            useEffect(() => {
                if (isOpen) {
                    const initialShop = (userProfile.role === 'Shop Manager' && Array.isArray(userProfile.shop) && userProfile.shop.length === 1) 
                        ? userProfile.shop[0] 
                        : '';
                    
                    // Helper to format existing date for input or default to today
                    const defaultDate = new Date().toISOString().slice(0, 10);
                    let initialDate = defaultDate;
                    
                    if (asset && asset.lastUpdated && asset.lastUpdated.toDate) {
                        initialDate = asset.lastUpdated.toDate().toISOString().slice(0, 10);
                    }

                    setFormData(asset ? { ...asset, assignedDate: initialDate } : {
                        name: '',
                        category: 'Equipment', 
                        shop: initialShop,
                        purchaseValue: '',
                        condition: 'New',
                        status: 'Available',
                        notes: '',
                        currentHolderId: '', // NEW: Default empty
                        assignedDate: defaultDate // NEW: Default to today
                    });
                }
            }, [isOpen, asset, userProfile]);

            const handleChange = (e) => {
                const { name, value } = e.target;
                setFormData(prev => {
                    const newData = { ...prev, [name]: value };
                    
                    // NEW: If Shop changes, clear the assigned staff to prevent mismatch
                    if (name === 'shop') {
                        newData.currentHolderId = '';
                    }
                    return newData;
                });
            };

            const handleSubmit = (e) => {
                e.preventDefault();
                if (!formData.name || !formData.shop) {
                    alert("Please fill in required fields.");
                    return;
                }
                onSave(formData);
            };

            return (
                <Modal isOpen={isOpen} onClose={onClose}>
                    <form onSubmit={handleSubmit}>
                        <ModalHeader title={asset ? "Edit Asset" : "Add New Asset"} onClose={onClose} />
                        <ModalBody>
                            <div className="space-y-4">
                                <div>
                                    <label className="text-sm font-medium text-slate-400">
                                        <i className="fas fa-tag mr-2 text-blue-400"></i>Asset Name
                                    </label>
                                    <input name="name" value={formData.name || ''} onChange={handleChange} className="input" placeholder="e.g., Shop Key #1, Dell Laptop" required />
                                </div>
                                <div className="grid grid-cols-2 gap-4">
                                    <div>
                                        <label className="text-sm font-medium text-slate-400">
                                            <i className="fas fa-layer-group mr-2 text-purple-400"></i>Category
                                        </label>
                                        <select name="category" value={formData.category} onChange={handleChange} className="select">
                                            <option>Equipment</option>
                                            <option>Keys</option>
                                            <option>Electronics</option>
                                            <option>Uniform</option>
                                            <option>Vehicle</option>
                                            <option>Other</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label className="text-sm font-medium text-slate-400">
                                            <i className="fas fa-store mr-2 text-cyan-400"></i>Shop Location
                                        </label>
                                        <select name="shop" value={formData.shop || ''} onChange={handleChange} className="select" required disabled={asset && asset.status === 'Assigned'}>
                                            <option value="">Select Shop</option>
                                            {availableShops.map(s => <option key={s.id} value={s.name}>{s.name}</option>)}
                                        </select>
                                    </div>
                                </div>

                                {/* NEW: Assignment Section - Only visible if Shop is selected */}
                                {formData.shop && (
                                    <div className="p-4 bg-slate-700/30 rounded-lg border border-slate-600/50">
                                        <h4 className="text-xs font-bold text-slate-400 uppercase mb-3">Initial Assignment</h4>
                                        <div className="grid grid-cols-2 gap-4">
                                            <div>
                                                <label className="text-sm font-medium text-slate-400">
                                                    <i className="fas fa-user mr-2 text-emerald-400"></i>Assigned To
                                                </label>
                                                <select 
                                                    name="currentHolderId" 
                                                    value={formData.currentHolderId || ''} 
                                                    onChange={handleChange} 
                                                    className="select"
                                                >
                                                    <option value="">-- Available (None) --</option>
                                                    {shopEmployees.map(e => <option key={e.id} value={e.id}>{e.name}</option>)}
                                                </select>
                                            </div>
                                            
                                            {/* Show Date Picker only if a staff is selected */}
                                            {formData.currentHolderId && (
                                                <div className="animate-fade-in">
                                                    <label className="text-sm font-medium text-slate-400">
                                                        <i className="fas fa-calendar-check mr-2 text-orange-400"></i>Assigned Date
                                                    </label>
                                                    <input 
                                                        type="date" 
                                                        name="assignedDate" 
                                                        value={formData.assignedDate || ''} 
                                                        onChange={handleChange} 
                                                        className="input" 
                                                    />
                                                </div>
                                            )}
                                        </div>
                                    </div>
                                )}

                                <div className="grid grid-cols-2 gap-4">
                                    <div>
                                        <label className="text-sm font-medium text-slate-400">
                                            <i className="fas fa-money-bill-wave mr-2 text-green-400"></i>Value (KHR)
                                        </label>
                                        <input type="number" name="purchaseValue" value={formData.purchaseValue || ''} onChange={handleChange} className="input" placeholder="0" />
                                    </div>
                                    <div>
                                        <label className="text-sm font-medium text-slate-400">
                                            <i className="fas fa-clipboard-check mr-2 text-yellow-400"></i>Condition
                                        </label>
                                        <select name="condition" value={formData.condition} onChange={handleChange} className="select">
                                            <option>New</option>
                                            <option>Good</option>
                                            <option>Fair</option>
                                            <option>Poor</option>
                                            <option>Broken</option>
                                        </select>
                                    </div>
                                </div>
                                <div>
                                    <label className="text-sm font-medium text-slate-400">
                                        <i className="fas fa-sticky-note mr-2 text-slate-400"></i>Notes
                                    </label>
                                    <textarea name="notes" value={formData.notes || ''} onChange={handleChange} className="input" rows="2"></textarea>
                                </div>
                            </div>
                        </ModalBody>
                        <ModalFooter>
                            <Button variant="secondary" onClick={onClose}>Cancel</Button>
                            <Button type="submit" variant="primary">Save Asset</Button>
                        </ModalFooter>
                    </form>
                </Modal>
            );
        };

        // Modal for Assigning, Returning, or Reporting Lost Assets
        const AssetActionModal = ({ isOpen, onClose, onProcess, asset, employees }) => {
            const [actionType, setActionType] = useState('checkout'); // 'checkout', 'checkin', 'lost'
            const [selectedEmployeeId, setSelectedEmployeeId] = useState('');
            const [notes, setNotes] = useState('');
            const [condition, setCondition] = useState('Good');
            const [deductFromPayroll, setDeductFromPayroll] = useState(false);
            const [deductionAmount, setDeductionAmount] = useState(0);
            // NEW: State for the action date (Return Date or Lost Date)
            const [actionDate, setActionDate] = useState('');

            useEffect(() => {
                if (isOpen && asset) {
                    if (asset.status === 'Available') setActionType('checkout');
                    else setActionType('checkin');
                    
                    setSelectedEmployeeId('');
                    setNotes('');
                    setCondition(asset.condition || 'Good');
                    setDeductFromPayroll(false);
                    setDeductionAmount(parseFloat(asset.purchaseValue) || 0);
                    // NEW: Default to today
                    setActionDate(new Date().toISOString().slice(0, 10));
                }
            }, [isOpen, asset]);

            // Filter employees for the asset's shop
            const eligibleEmployees = useMemo(() => {
                if (!asset || !employees) return [];
                return employees.filter(e => {
                    const empShops = Array.isArray(e.shop) ? e.shop : [e.shop];
                    return empShops.includes(asset.shop) && e.status === 'Active';
                });
            }, [employees, asset]);

            const handleSubmit = (e) => {
                e.preventDefault();
                onProcess({
                    actionType,
                    assetId: asset.id,
                    employeeId: selectedEmployeeId,
                    notes,
                    condition,
                    deductFromPayroll,
                    deductionAmount,
                    actionDate // NEW: Pass the date
                });
            };

            if (!asset) return null;

            return (
                <Modal isOpen={isOpen} onClose={onClose} maxWidth="max-w-md">
                    <form onSubmit={handleSubmit}>
                        <ModalHeader title={`Manage: ${asset.name}`} onClose={onClose} />
                        <ModalBody>
                            {/* Action Selector */}
                            {asset.status === 'Assigned' && (
                                <div className="flex space-x-2 mb-6 p-1 bg-slate-700 rounded-lg">
                                    <button type="button" onClick={() => setActionType('checkin')} className={`flex-1 py-2 rounded-md text-sm font-medium transition-colors ${actionType === 'checkin' ? 'bg-blue-600 text-white shadow' : 'text-slate-300 hover:text-white'}`}>Return (Check-In)</button>
                                    <button type="button" onClick={() => setActionType('lost')} className={`flex-1 py-2 rounded-md text-sm font-medium transition-colors ${actionType === 'lost' ? 'bg-red-600 text-white shadow' : 'text-slate-300 hover:text-white'}`}>Report Lost</button>
                                </div>
                            )}

                            {/* Check Out View */}
                            {actionType === 'checkout' && (
                                <div className="space-y-4">
                                    <div className="p-3 bg-blue-900/30 border border-blue-700/50 rounded-lg text-blue-200 text-sm">
                                        <i className="fas fa-info-circle mr-2"></i> Assigning item from <strong>{asset.shop}</strong>
                                    </div>
                                    <div>
                                        <label className="text-sm font-medium text-slate-400">
                                            <i className="fas fa-user mr-2 text-emerald-400"></i>Assign to Employee
                                        </label>
                                        <select value={selectedEmployeeId} onChange={e => setSelectedEmployeeId(e.target.value)} className="select" required>
                                            <option value="">Select Employee</option>
                                            {eligibleEmployees.map(e => <option key={e.id} value={e.id}>{e.name}</option>)}
                                        </select>
                                    </div>
                                    <div>
                                        <label className="text-sm font-medium text-slate-400">
                                            <i className="fas fa-calendar-minus mr-2 text-orange-400"></i>Check-Out Date
                                        </label>
                                        <input type="date" value={actionDate} onChange={e => setActionDate(e.target.value)} className="input" required />
                                    </div>
                                    <div>
                                        <label className="text-sm font-medium text-slate-400">
                                            <i className="fas fa-sticky-note mr-2 text-slate-400"></i>Check-Out Notes
                                        </label>
                                        <textarea value={notes} onChange={e => setNotes(e.target.value)} className="input" rows="2" placeholder="e.g., Handed over with charger"></textarea>
                                    </div>
                                </div>
                            )}

                            {/* Check In View */}
                            {actionType === 'checkin' && (
                                <div className="space-y-4">
                                    <div className="p-3 bg-green-900/30 border border-green-700/50 rounded-lg text-green-200 text-sm">
                                        <i className="fas fa-undo mr-2"></i> Returning item from <strong>{asset.currentHolderName}</strong>
                                    </div>
                                    <div>
                                        <label className="text-sm font-medium text-slate-400">
                                            <i className="fas fa-calendar-plus mr-2 text-green-400"></i>Return Date
                                        </label>
                                        <input type="date" value={actionDate} onChange={e => setActionDate(e.target.value)} className="input" required />
                                    </div>
                                    <div>
                                        <label className="text-sm font-medium text-slate-400">
                                            <i className="fas fa-clipboard-check mr-2 text-yellow-400"></i>Return Condition
                                        </label>
                                        <select value={condition} onChange={e => setCondition(e.target.value)} className="select">
                                            <option>New</option>
                                            <option>Good</option>
                                            <option>Fair</option>
                                            <option>Poor</option>
                                            <option>Broken</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label className="text-sm font-medium text-slate-400">
                                            <i className="fas fa-sticky-note mr-2 text-slate-400"></i>Return Notes
                                        </label>
                                        <textarea value={notes} onChange={e => setNotes(e.target.value)} className="input" rows="2" placeholder="e.g., Returned in good condition"></textarea>
                                    </div>
                                </div>
                            )}

                            {/* Report Lost View */}
                            {actionType === 'lost' && (
                                <div className="space-y-4">
                                    <div className="p-3 bg-red-900/30 border border-red-700/50 rounded-lg text-red-200 text-sm">
                                        <i className="fas fa-exclamation-triangle mr-2"></i> Reporting lost by <strong>{asset.currentHolderName}</strong>
                                    </div>
                                    
                                    <div>
                                        <label className="text-sm font-medium text-slate-400">
                                            <i className="fas fa-calendar-xmark mr-2 text-red-400"></i>Lost Date
                                        </label>
                                        <input type="date" value={actionDate} onChange={e => setActionDate(e.target.value)} className="input" required />
                                    </div>

                                    <div className="flex items-center p-3 border border-slate-600 rounded-lg bg-slate-700/30">
                                        <input 
                                            id="deduct-check" 
                                            type="checkbox" 
                                            checked={deductFromPayroll} 
                                            onChange={e => setDeductFromPayroll(e.target.checked)} 
                                            className="h-5 w-5 rounded border-gray-300 text-red-600 focus:ring-red-500 bg-slate-600"
                                        />
                                        <label htmlFor="deduct-check" className="ml-3 text-sm font-medium text-slate-200">Deduct cost from Payroll?</label>
                                    </div>

                                    {deductFromPayroll && (
                                        <div className="animate-fade-in">
                                            <label className="text-sm font-medium text-slate-400">
                                                <i className="fas fa-money-bill mr-2 text-green-400"></i>Deduction Amount (KHR)
                                            </label>
                                            <input 
                                                type="number" 
                                                value={deductionAmount} 
                                                onChange={e => setDeductionAmount(e.target.value)} 
                                                className="input font-bold text-red-400" 
                                            />
                                            <p className="text-xs text-slate-500 mt-1">This will create a 'Deduction' record in Employee States.</p>
                                        </div>
                                    )}

                                    <div>
                                        <label className="text-sm font-medium text-slate-400">
                                            <i className="fas fa-comment-alt mr-2 text-slate-400"></i>Notes / Reason
                                        </label>
                                        <textarea value={notes} onChange={e => setNotes(e.target.value)} className="input" rows="2" required placeholder="Details about the loss..."></textarea>
                                    </div>
                                </div>
                            )}

                        </ModalBody>
                        <ModalFooter>
                            <Button variant="secondary" onClick={onClose}>Cancel</Button>
                            <Button 
                                type="submit" 
                                variant={actionType === 'lost' ? 'danger' : actionType === 'checkin' ? 'success' : 'primary'}
                                disabled={actionType === 'checkout' && !selectedEmployeeId}
                            >
                                {actionType === 'checkout' ? 'Confirm Check-Out' : actionType === 'checkin' ? 'Confirm Return' : 'Report Lost'}
                            </Button>
                        </ModalFooter>
                    </form>
                </Modal>
            );
        };

        const AssetManagerPage = ({ userProfile }) => {
            const { db, auth } = useFirebase();
            const { shops, employees } = useAppData();
            const { where, collection, addDoc, updateDoc, doc, serverTimestamp, deleteDoc } = window.firebaseSDK;

            // Filters
            const [selectedShop, setSelectedShop] = useState('');
            const [statusFilter, setStatusFilter] = useState('All');
            const [searchTerm, setSearchTerm] = useState('');

            // Modals
            const [isAssetModalOpen, setIsAssetModalOpen] = useState(false);
            const [isActionModalOpen, setIsActionModalOpen] = useState(false);
            const [editingAsset, setEditingAsset] = useState(null);
            const [activeAsset, setActiveAsset] = useState(null); // Asset being acted upon (Check In/Out)
            const [assetToDelete, setAssetToDelete] = useState(null);

            // Fetch Assets
            const queryConstraints = useMemo(() => {
                if (!userProfile) return [where("shop", "==", "null")];
                if (userProfile.role === 'Admin' || userProfile.role === 'CEO') return [];
                if (userProfile.role === 'Shop Manager') {
                    const managedShops = Array.isArray(userProfile.shop) ? userProfile.shop : (userProfile.shop ? [userProfile.shop] : []);
                    return managedShops.length > 0 ? [where("shop", "in", managedShops)] : [where("shop", "==", "null")];
                }
                return [where("shop", "==", "null")]; // Staff don't see this generally, or maybe read-only later
            }, [userProfile]);

            const { data: assets, loading } = useCollection('assets', queryConstraints);

            // Filter Logic
            const filteredAssets = useMemo(() => {
                return assets.filter(asset => {
                    const shopMatch = !selectedShop || asset.shop === selectedShop;
                    const statusMatch = statusFilter === 'All' || asset.status === statusFilter;
                    const searchMatch = !searchTerm || 
                        asset.name.toLowerCase().includes(searchTerm.toLowerCase()) || 
                        (asset.currentHolderName && asset.currentHolderName.toLowerCase().includes(searchTerm.toLowerCase()));
                    
                    return shopMatch && statusMatch && searchMatch;
                });
            }, [assets, selectedShop, statusFilter, searchTerm]);

            // Handlers
            const handleSaveAsset = async (formData) => {
                // ... (Logic from previous step for Add/Edit Modal) ...
                try {
                    // NEW: Logic to handle assignment from the modal
                    const { currentHolderId, assignedDate, ...restFormData } = formData;
                    
                    let status = 'Available';
                    let holderData = { currentHolderId: null, currentHolderName: null };
                    let timestampData = { updatedAt: serverTimestamp() }; // Default timestamp

                    if (currentHolderId) {
                        status = 'Assigned';
                        const emp = employees.find(e => e.id === currentHolderId);
                        if (emp) {
                            holderData = {
                                currentHolderId: emp.id,
                                currentHolderName: emp.name
                            };
                        }
                        
                        // Use the custom assigned date if provided
                        if (assignedDate) {
                            // Append time to ensure it doesn't shift due to timezone
                            timestampData = { lastUpdated: new Date(`${assignedDate}T12:00:00`) };
                        } else {
                            timestampData = { lastUpdated: serverTimestamp() };
                        }
                    } else {
                        // If no holder selected, ensure fields are cleared
                        holderData = { currentHolderId: null, currentHolderName: null };
                        if (!editingAsset) { // Only set to Available if it's new and unassigned
                             status = 'Available'; 
                        } else {
                             // If editing and we manually cleared the holder, set to Available
                             status = 'Available';
                        }
                    }

                    const data = { 
                        ...restFormData, 
                        ...holderData,
                        ...timestampData,
                        status: status,
                        purchaseValue: parseFloat(formData.purchaseValue) || 0 
                    };
                    
                    if (editingAsset) {
                        await updateDoc(doc(db, 'assets', editingAsset.id), data);
                    } else {
                        // For new assets, we use createdAt
                        await addDoc(collection(db, 'assets'), { 
                            ...data, 
                            createdAt: serverTimestamp() 
                        });
                    }
                    setIsAssetModalOpen(false);
                    setEditingAsset(null);
                } catch (error) {
                    console.error("Error saving asset:", error);
                    alert("Failed to save asset.");
                }
            };

            const handleProcessAction = async ({ actionType, assetId, employeeId, notes, condition, deductFromPayroll, deductionAmount, actionDate }) => {
                try {
                    const assetRef = doc(db, 'assets', assetId);
                    const employee = employees.find(e => e.id === employeeId);
                    
                    // NEW: Determine timestamp from the selected date (defaulting to Noon to avoid TZ shifts)
                    // If no date provided, fallback to current server time.
                    const timestamp = actionDate ? new Date(`${actionDate}T12:00:00`) : new Date();

                    // 1. Handle Check-Out
                    if (actionType === 'checkout') {
                        if (!employee) return;
                        await updateDoc(assetRef, {
                            status: 'Assigned',
                            currentHolderId: employee.id,
                            currentHolderName: employee.name,
                            lastUpdated: timestamp, // Use custom date
                            notes: notes ? `Check-Out Note: ${notes}` : ''
                        });
                    } 
                    // 2. Handle Check-In
                    else if (actionType === 'checkin') {
                        await updateDoc(assetRef, {
                            status: 'Available',
                            condition: condition,
                            currentHolderId: null,
                            currentHolderName: null,
                            lastUpdated: timestamp, // Use custom date
                            notes: notes ? `Return Note: ${notes}` : ''
                        });
                    }
                    // 3. Handle Lost
                    else if (actionType === 'lost') {
                        await updateDoc(assetRef, {
                            status: 'Lost',
                            currentHolderId: null, 
                            // keeping currentHolderName in a "lastHolder" field could be useful, skipping for simplicity
                            notes: `Marked Lost. ${notes}`,
                            lastUpdated: timestamp // Use custom date
                        });

                        // Create Deduction Record if requested
                        if (deductFromPayroll && activeAsset.currentHolderId) {
                            await addDoc(collection(db, 'employeeStates'), {
                                staffId: activeAsset.currentHolderId,
                                staffName: activeAsset.currentHolderName,
                                shop: activeAsset.shop,
                                date: actionDate || new Date().toISOString().slice(0, 10), // Use custom date
                                statusState: 'Deduction',
                                amount: parseFloat(deductionAmount),
                                note: `Lost Asset Deduction: ${activeAsset.name} - ${notes}`,
                                status: 'Approved' // Auto-approve
                            });
                        }
                    }

                    // Log Activity
                    const actionName = actionType === 'checkout' ? 'Asset Check-Out' : actionType === 'checkin' ? 'Asset Check-In' : 'Asset Lost Report';
                    Utils.logUserActivity(db, auth, actionName, {
                        assetName: activeAsset.name,
                        employee: employee ? employee.name : activeAsset.currentHolderName,
                        date: actionDate,
                        notes
                    });

                    setIsActionModalOpen(false);
                    setActiveAsset(null);

                } catch (error) {
                    console.error("Error processing asset action:", error);
                    alert("Failed to update asset.");
                }
            };

            const handleDelete = async () => {
                if (!assetToDelete) return;
                try {
                    await deleteDoc(doc(db, 'assets', assetToDelete.id));
                    setAssetToDelete(null);
                } catch (error) {
                    console.error("Error deleting asset:", error);
                }
            };

            // OPTIMIZATION: Used new hook
            const availableShops = useAllowedShops(userProfile, shops);

            // OPTIMIZATION: Refactored Layout
            return (
                <Card>
                    <PageHeader title="Asset Manager">
                        <ShopFilterSelect 
                            userProfile={userProfile}
                            shops={shops}
                            selectedShop={selectedShop}
                            onChange={e => setSelectedShop(e.target.value)}
                        />
                        <select value={statusFilter} onChange={e => setStatusFilter(e.target.value)} className="select w-full sm:w-auto">
                            <option value="All">All Status</option>
                            <option value="Available">Available</option>
                            <option value="Assigned">Assigned</option>
                            <option value="Lost">Lost</option>
                            <option value="Broken">Broken</option>
                        </select>
                        <SearchInput value={searchTerm} onChange={e => setSearchTerm(e.target.value)} placeholder="Search asset or staff..." />
                        <Button variant="primary" icon="fa-plus" onClick={() => { setEditingAsset(null); setIsAssetModalOpen(true); }}>Add Asset</Button>
                    </PageHeader>

                    {loading ? (
                        <div className="text-center py-10"><i className="fas fa-spinner fa-spin text-3xl text-blue-400"></i></div>
                    ) : (
                        <div className="overflow-x-auto">
                            <table className="min-w-full divide-y divide-slate-700">
                                <thead className="bg-slate-900/50">
                                    <tr>
                                        <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Asset Name</th>
                                        <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Type</th>
                                        <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Shop</th>
                                        <th className="px-4 py-3 text-center text-xs font-semibold text-slate-400 uppercase">Status</th>
                                        <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Current Holder</th>
                                        <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Condition</th>
                                        <th className="px-4 py-3 text-right text-xs font-semibold text-slate-400 uppercase">Value</th>
                                        <th className="px-4 py-3 text-center text-xs font-semibold text-slate-400 uppercase">Actions</th>
                                    </tr>
                                </thead>
                                <tbody className="divide-y divide-slate-700">
                                    {filteredAssets.length === 0 ? (
                                        <tr><td colSpan="8" className="px-4 py-8 text-center text-slate-500">No assets found.</td></tr>
                                    ) : (
                                        filteredAssets.map(asset => (
                                            <tr key={asset.id} className="hover:bg-slate-700/50">
                                                <td className="px-4 py-4 text-sm text-slate-200 font-medium">{asset.name}</td>
                                                <td className="px-4 py-4 text-sm text-slate-400">{asset.category}</td>
                                                <td className="px-4 py-4 text-sm text-slate-300">{asset.shop}</td>
                                                <td className="px-4 py-4 text-center">
                                                    <span className={`px-2 py-1 text-xs font-bold rounded-full ${
                                                        asset.status === 'Available' ? 'bg-green-900 text-green-300' :
                                                        asset.status === 'Assigned' ? 'bg-blue-900 text-blue-300' :
                                                        'bg-red-900 text-red-300'
                                                    }`}>
                                                        {asset.status}
                                                    </span>
                                                </td>
                                                <td className="px-4 py-4 text-sm text-slate-200">{asset.currentHolderName || '-'}</td>
                                                <td className="px-4 py-4 text-sm text-slate-300">{asset.condition}</td>
                                                <td className="px-4 py-4 text-sm text-right text-slate-400">{Utils.formatCurrency(asset.purchaseValue)}</td>
                                                <td className="px-4 py-4 text-center">
                                                    <div className="flex items-center justify-center gap-2">
                                                        {asset.status === 'Available' ? (
                                                            <Button variant="icon-approve" icon="fa-share-from-square" onClick={() => { setActiveAsset(asset); setIsActionModalOpen(true); }} title="Check-Out / Assign" />
                                                        ) : asset.status === 'Assigned' ? (
                                                            <Button variant="icon-edit-alt" icon="fa-reply" onClick={() => { setActiveAsset(asset); setIsActionModalOpen(true); }} title="Return / Lost" />
                                                        ) : null}
                                                        
                                                        <Button variant="icon-edit" icon="fa-edit" onClick={() => { setEditingAsset(asset); setIsAssetModalOpen(true); }} />
                                                        <Button variant="icon-delete" icon="fa-trash" onClick={() => setAssetToDelete(asset)} />
                                                    </div>
                                                </td>
                                            </tr>
                                        ))
                                    )}
                                </tbody>
                            </table>
                        </div>
                    )}

                    <AssetModal 
                        isOpen={isAssetModalOpen} 
                        onClose={() => setIsAssetModalOpen(false)} 
                        onSave={handleSaveAsset} 
                        asset={editingAsset} 
                        userProfile={userProfile} 
                    />
                    
                    <AssetActionModal
                        isOpen={isActionModalOpen}
                        onClose={() => setIsActionModalOpen(false)}
                        onProcess={handleProcessAction}
                        asset={activeAsset}
                        employees={employees}
                    />

                    <ConfirmationModal 
                        isOpen={!!assetToDelete} 
                        onClose={() => setAssetToDelete(null)} 
                        onConfirm={handleDelete} 
                        title="Delete Asset" 
                        message={`Are you sure you want to delete "${assetToDelete?.name}"?`} 
                    />
                </Card>
            );
        };
        // --- END ASSET MANAGER PAGE ---

        // --- START TASK MANAGER PAGE (NEW INTEGRATION) ---
        
        // Constants & Helpers for Task Manager
        const KANBAN_STATUS = {
            TODO: 'todo',
            IN_PROGRESS: 'in_progress',
            AUDITING: 'auditing',
            DONE: 'done'
        };

        const ICONS = {
            KPI: (props) => <i className={`fas fa-chart-line ${props.className}`}></i>
        };

        // Helper to format timestamps
        const formatFullDateTime = (timestamp) => {
            if (!timestamp) return '';
            const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
            return date.toLocaleString('en-GB', { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
        };

        // NEW: Helper to calculate work duration for history items
        const getTaskWorkTime = (task) => {
            if (task.progressTimestamp && task.workCompletedTimestamp) {
                const start = task.progressTimestamp.toDate ? task.progressTimestamp.toDate() : new Date(task.progressTimestamp);
                const end = task.workCompletedTimestamp.toDate ? task.workCompletedTimestamp.toDate() : new Date(task.workCompletedTimestamp);
                const diffMs = end - start;
                
                // Handle edge cases where timestamps might be invalid
                if (diffMs < 0) return '-';

                const diffMins = Math.floor(diffMs / 60000);
                const hours = Math.floor(diffMins / 60);
                const mins = diffMins % 60;
                
                // Format: "1h 30m" or "45m"
                if (hours > 0) return `${hours}h ${mins}m`;
                return `${mins}m`;
            }
            return '-';
        };

        // Helper Hook: Calculate duration since task started
        // MODIFIED: Updated to show HH:MM:SS live timing
        const useLiveTaskDuration = (task) => {
            const [duration, setDuration] = useState('');
            
            useEffect(() => {
                if (task.status !== KANBAN_STATUS.IN_PROGRESS || !task.progressTimestamp) {
                    setDuration('');
                    return;
                }

                const calculate = () => {
                    const start = task.progressTimestamp.toDate ? task.progressTimestamp.toDate() : new Date(task.progressTimestamp);
                    const now = new Date();
                    const diffMs = Math.max(0, now - start); // Ensure no negative time
                    
                    const seconds = Math.floor((diffMs / 1000) % 60);
                    const minutes = Math.floor((diffMs / (1000 * 60)) % 60);
                    const hours = Math.floor((diffMs / (1000 * 60 * 60)));

                    // Format with leading zeros (HH:MM:SS)
                    const formatted = [
                        hours.toString().padStart(2, '0'),
                        minutes.toString().padStart(2, '0'),
                        seconds.toString().padStart(2, '0')
                    ].join(':');

                    setDuration(formatted);
                };

                calculate();
                const timer = setInterval(calculate, 1000); // Update every second
                return () => clearInterval(timer);
            }, [task]);

            return duration;
        };

        // Helper Hook: Static duration for completed phases
        const useTaskDuration = (task) => {
            if (task.status === KANBAN_STATUS.AUDITING && task.progressTimestamp && task.workCompletedTimestamp) {
                const start = task.progressTimestamp.toDate();
                const end = task.workCompletedTimestamp.toDate();
                const diffMins = Math.floor((end - start) / 60000);
                const hours = Math.floor(diffMins / 60);
                const mins = diffMins % 60;
                return `${hours}h ${mins}m (Work Time)`;
            }
            return null;
        };

        // Sub-Component: Filter Select
        const FilterSelect = memo(({ label, name, value, onChange, options, disabled, simple = false }) => (
            <div className={simple ? "" : "flex-1 w-full"}>
                {!simple && <label htmlFor={`${name}-filter`} className="block text-sm font-medium text-slate-400 mb-1">{label}</label>}
                <select id={`${name}-filter`} name={name} value={value} onChange={onChange} className={`input ${simple ? 'text-sm' : 'w-full'}`} disabled={disabled}>
                    <option value="">{`All ${label || name}s`}</option>
                    {options.map((opt, idx) => {
                        const isObject = typeof opt === 'object' && opt !== null;
                        const val = isObject ? opt.id : opt;
                        const text = isObject ? (opt.text || opt.name) : opt;
                        return <option key={idx} value={val}>{text}</option>;
                    })}
                </select>
            </div>
        ));

        // Sub-Component: Task Audit Controls
        const TaskAuditControls = ({ task, onTaskAction, isProcessing, userProfile }) => {
            const [score, setScore] = useState('');
            const [comment, setComment] = useState(task.auditComment || '');
            
            // Allow Admin or the Shop Manager of that shop to audit
            const canAudit = userProfile.role === 'Admin' || userProfile.role === 'CEO' || (userProfile.role === 'Shop Manager');
            
            if (!canAudit) return null;
            
            return (
                <div className="space-y-3 bg-slate-900/50 p-3 rounded-lg border border-slate-700/50">
                    <p className="text-xs font-bold text-blue-300 uppercase">Manager Review</p>
                    <textarea 
                        value={comment} 
                        onChange={(e) => setComment(e.target.value)} 
                        className="input text-sm p-2" 
                        rows="2" 
                        placeholder="Feedback or instructions..." 
                    />
                    <select value={score} onChange={(e) => setScore(e.target.value)} className="input text-sm p-2">
                        <option value="">Select Score / Result...</option>
                        {["100% - Excellent", "90% - Good", "70% - Acceptable", "50% - Needs Improvement", "Rejected"].map(s => <option key={s} value={s}>{s}</option>)}
                    </select>
                    <div className="flex justify-end gap-2"> 
                        <Button 
                            onClick={() => onTaskAction('move', task, { newStatus: KANBAN_STATUS.IN_PROGRESS, comment })} 
                            variant="secondary"
                            disabled={!comment || isProcessing}
                            className="text-xs"
                        >
                            Return for Rework
                        </Button>
                        <Button 
                            onClick={() => onTaskAction('approve', task, { score, comment })} 
                            variant="success"
                            disabled={isProcessing || !score}
                            className="text-xs"
                        >
                            {isProcessing ? 'Processing...' : 'Approve & Close'}
                        </Button>
                    </div>
                </div>
            );
        };

        // Sub-Component: Task Card
        // MODIFIED: Accepts 'onDelete' prop to trigger confirmation modal
        const TaskCard = memo(({ task, onEdit, onTaskAction, onDelete, processingTaskIds, userProfile }) => {
            const staticDuration = useTaskDuration(task);
            const liveDuration = useLiveTaskDuration(task);
            const isProcessing = processingTaskIds.has(task.id);

            // Row Helper
            const InfoRow = ({ icon, label, value }) => (
                <div className="flex items-center gap-2" title={label}>
                    <span className="w-4 text-center">{icon}</span>
                    <span className="truncate">{value}</span>
                </div>
            );

            const handleComplete = () => {
                const newStatus = KANBAN_STATUS.AUDITING; 
                onTaskAction('move', task, { newStatus });
            };

            return (
                <div className="bg-slate-700 border border-slate-600 p-4 rounded-lg shadow-sm group mb-4 hover:border-blue-500/50 transition-all">
                    <div className="flex justify-between items-start mb-2">
                        <div 
                            onClick={() => onEdit(task)} 
                            className="font-semibold text-slate-100 flex-grow pr-2 cursor-pointer hover:text-blue-400 transition-colors"
                        >
                            {task.text}
                        </div>
                        {(userProfile.role === 'Admin' || userProfile.role === 'CEO' || userProfile.id === task.creatorUid) && (
                            <button 
                                // FIX: Use onDelete to trigger modal instead of immediate action
                                onClick={() => onDelete(task)} 
                                className="text-slate-500 hover:text-red-500 transition-colors px-1"
                                title="Delete Task"
                            >
                                <i className="fas fa-times"></i>
                            </button>
                        )}
                    </div>

                    <div className="text-xs text-slate-400 space-y-1.5 border-t border-slate-600/50 pt-2">
                        {task.kpiText && <InfoRow icon={<ICONS.KPI className="text-purple-400" />} label='KPI' value={<span className="font-semibold text-purple-400">{task.kpiText}</span>} />}
                        {task.shopName && <InfoRow icon="🏢" label='Shop' value={task.shopName} />}
                        {task.staffName && <InfoRow icon="👤" label='Staff' value={task.staffName} />}
                        
                        {task.taskTimestamp && <InfoRow icon="📅" label='Created' value={formatFullDateTime(task.taskTimestamp)} />}
                        
                        {/* Timers */}
                        {staticDuration && <InfoRow icon="⏱️" label='Duration' value={staticDuration} />}
                        {liveDuration && <InfoRow icon="⏱️" label='Active Time' value={<span className="font-bold text-yellow-400 animate-pulse">{liveDuration}</span>} />}
                        
                        {/* Audit Comments */}
                        {task.auditComment && (
                            <div className="mt-2 p-2 bg-yellow-500/10 border border-yellow-500/20 rounded text-yellow-200 italic">
                                "{task.auditComment}"
                            </div>
                        )}
                    </div>

                    {/* Actions Footer */}
                    <div className="mt-3 pt-3 border-t border-slate-600 flex justify-end gap-2">
                        {task.status === KANBAN_STATUS.AUDITING ? (
                            <TaskAuditControls task={task} onTaskAction={onTaskAction} isProcessing={isProcessing} userProfile={userProfile} />
                        ) : (
                            <>
                                {task.status === KANBAN_STATUS.TODO && (
                                    <button 
                                        onClick={() => onTaskAction('move', task, { newStatus: KANBAN_STATUS.IN_PROGRESS })} 
                                        className="px-3 py-1 text-xs bg-blue-600 text-white rounded hover:bg-blue-500 transition-colors"
                                        disabled={isProcessing}
                                    >
                                        Start Work
                                    </button>
                                )}
                                {task.status === KANBAN_STATUS.IN_PROGRESS && (
                                    <>
                                        <button 
                                            onClick={() => onTaskAction('move', task, { newStatus: KANBAN_STATUS.TODO })} 
                                            className="px-3 py-1 text-xs bg-slate-600 text-slate-200 rounded hover:bg-slate-500 transition-colors"
                                            disabled={isProcessing}
                                        >
                                            Stop
                                        </button>
                                        <button 
                                            onClick={handleComplete} 
                                            className="px-3 py-1 text-xs bg-green-600 text-white rounded hover:bg-green-500 transition-colors font-bold"
                                            disabled={isProcessing}
                                        >
                                            Submit for Audit
                                        </button>
                                    </>
                                )}
                            </>
                        )}
                    </div>
                </div>
            );
        });

        // --- INSERTED MISSING COMPONENT: Task Modal ---
        const TaskModal = ({ isOpen, onClose, onSave, task, userProfile, kpis, employees }) => {
            const [formData, setFormData] = useState({});
            
            // Filter employees based on role
            const availableEmployees = useMemo(() => {
                if (!employees) return [];
                if (userProfile.role === 'Admin' || userProfile.role === 'CEO') return employees.filter(e => e.status === 'Active');
                if (userProfile.role === 'Shop Manager') {
                    const myShops = Array.isArray(userProfile.shop) ? userProfile.shop : [userProfile.shop];
                    return employees.filter(e => {
                        const empShops = Array.isArray(e.shop) ? e.shop : [e.shop];
                        return e.status === 'Active' && empShops.some(s => myShops.includes(s));
                    });
                }
                return [];
            }, [employees, userProfile]);

            useEffect(() => {
                if (isOpen) {
                    setFormData(task ? { ...task } : {
                        text: '',
                        kpiId: '',
                        staffId: userProfile.role === 'Staff' ? userProfile.id : '',
                        link: '',
                    });
                }
            }, [isOpen, task, userProfile]);

            const handleChange = (e) => {
                const { name, value } = e.target;
                setFormData(prev => ({ ...prev, [name]: value }));
            };

            const handleSubmit = (e) => {
                e.preventDefault();
                if (!formData.text) return;
                
                // Enrich data before saving
                let staffName = '';
                let shopName = '';
                
                if (userProfile.role === 'Staff') {
                    staffName = userProfile.name;
                    shopName = Array.isArray(userProfile.shop) ? userProfile.shop[0] : userProfile.shop;
                } else if (formData.staffId) {
                    const emp = employees.find(e => e.id === formData.staffId);
                    if (emp) {
                        staffName = emp.name;
                        shopName = Array.isArray(emp.shop) ? emp.shop[0] : emp.shop;
                    }
                }

                let kpiText = '';
                if (formData.kpiId) {
                    const kpi = kpis.find(k => k.id === formData.kpiId);
                    if (kpi) kpiText = kpi.name;
                }

                onSave({
                    ...formData,
                    staffName,
                    shopName,
                    kpiText
                });
            };

            const canAssignStaff = userProfile.role !== 'Staff';

            return (
                <Modal isOpen={isOpen} onClose={onClose} maxWidth="max-w-lg">
                    <form onSubmit={handleSubmit}>
                        <ModalHeader title={task ? "Edit Task" : "Add New Task"} onClose={onClose} />
                        <ModalBody>
                            <div className="space-y-4">
                                <div>
                                    <label className="text-sm font-medium text-slate-400">Task Description</label>
                                    <textarea name="text" value={formData.text || ''} onChange={handleChange} className="input" rows="3" required placeholder="What needs to be done?" />
                                </div>
                                
                                <div>
                                    <label className="text-sm font-medium text-slate-400">Link to KPI (Optional)</label>
                                    <select name="kpiId" value={formData.kpiId || ''} onChange={handleChange} className="select">
                                        <option value="">-- No KPI --</option>
                                        {kpis && kpis.map(k => <option key={k.id} value={k.id}>{k.name}</option>)}
                                    </select>
                                </div>

                                {canAssignStaff && (
                                    <div>
                                        <label className="text-sm font-medium text-slate-400">Assign To</label>
                                        <select name="staffId" value={formData.staffId || ''} onChange={handleChange} className="select" required>
                                            <option value="">Select Staff</option>
                                            {availableEmployees.map(e => <option key={e.id} value={e.id}>{e.name}</option>)}
                                        </select>
                                    </div>
                                )}

                                <div>
                                    <label className="text-sm font-medium text-slate-400">External Link (Optional)</label>
                                    <input name="link" value={formData.link || ''} onChange={handleChange} className="input" placeholder="https://..." />
                                </div>
                            </div>
                        </ModalBody>
                        <ModalFooter>
                            <Button variant="secondary" onClick={onClose}>Cancel</Button>
                            <Button type="submit" variant="primary">{task ? "Update" : "Create"}</Button>
                        </ModalFooter>
                    </form>
                </Modal>
            );
        };

        // --- INSERTED MISSING COMPONENT: TaskKanbanTab ---
        const TaskKanbanTab = ({ userProfile }) => {
            const { db } = useFirebase();
            const { kpis, employees } = useAppData(); // Use global data
            const { collection, query, where, onSnapshot, orderBy, addDoc, updateDoc, deleteDoc, doc, serverTimestamp } = window.firebaseSDK;

            const [tasks, setTasks] = useState([]);
            const [loading, setLoading] = useState(true);
            const [processingTaskIds, setProcessingTaskIds] = useState(new Set());
            
            // Modals
            const [isModalOpen, setIsModalOpen] = useState(false);
            const [editingTask, setEditingTask] = useState(null);
            const [taskToDelete, setTaskToDelete] = useState(null);

            // Filters
            const [filterStaff, setFilterStaff] = useState('');
            const [filterKpi, setFilterKpi] = useState('');

            // Data Fetching
            useEffect(() => {
                if (!db || !userProfile) return;
                setLoading(true);

                let q = query(collection(db, 'tasks'), orderBy('taskTimestamp', 'desc'));

                if (userProfile.role === 'Staff') {
                    q = query(q, where('staffId', '==', userProfile.id));
                } else if (userProfile.role === 'Shop Manager') {
                    const myShops = Array.isArray(userProfile.shop) ? userProfile.shop : [userProfile.shop];
                    if (myShops.length > 0) {
                        q = query(q, where('shopName', 'in', myShops));
                    } else {
                        q = query(q, where('shopName', '==', 'null'));
                    }
                }
                
                const unsubscribe = onSnapshot(q, (snapshot) => {
                    const items = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    setTasks(items);
                    setLoading(false);
                }, (error) => {
                    console.error("Error fetching tasks:", error);
                    setLoading(false);
                });

                return () => unsubscribe();
            }, [db, userProfile]);

            // Filter Logic
            const filteredTasks = useMemo(() => {
                return tasks.filter(t => {
                    if (filterStaff && t.staffId !== filterStaff) return false;
                    if (filterKpi && t.kpiId !== filterKpi) return false;
                    return true;
                });
            }, [tasks, filterStaff, filterKpi]);

            // Columns
            const columns = {
                [KANBAN_STATUS.TODO]: filteredTasks.filter(t => t.status === KANBAN_STATUS.TODO),
                [KANBAN_STATUS.IN_PROGRESS]: filteredTasks.filter(t => t.status === KANBAN_STATUS.IN_PROGRESS),
                [KANBAN_STATUS.AUDITING]: filteredTasks.filter(t => t.status === KANBAN_STATUS.AUDITING),
                [KANBAN_STATUS.DONE]: filteredTasks.filter(t => t.status === KANBAN_STATUS.DONE),
            };

            // Actions
            const handleTaskAction = async (action, task, payload) => {
                setProcessingTaskIds(prev => new Set(prev).add(task.id));
                try {
                    const taskRef = doc(db, 'tasks', task.id);
                    const updateData = {};

                    if (action === 'move') {
                        updateData.status = payload.newStatus;
                        // Handle timestamps
                        if (payload.newStatus === KANBAN_STATUS.IN_PROGRESS) updateData.progressTimestamp = serverTimestamp();
                        if (payload.newStatus === KANBAN_STATUS.AUDITING) updateData.workCompletedTimestamp = serverTimestamp();
                        // Reset rejection comments if moving back
                        if (payload.comment) updateData.auditComment = payload.comment; 
                    } 
                    else if (action === 'approve') {
                        updateData.status = KANBAN_STATUS.DONE;
                        updateData.completedTimestamp = serverTimestamp();
                        updateData.auditScore = payload.score;
                        updateData.auditComment = payload.comment;
                        updateData.auditorName = userProfile.name;
                    }

                    await updateDoc(taskRef, updateData);
                } catch (error) {
                    console.error("Task action failed:", error);
                    alert("Failed to update task.");
                } finally {
                    setProcessingTaskIds(prev => { const next = new Set(prev); next.delete(task.id); return next; });
                }
            };

            const handleSaveTask = async (formData) => {
                try {
                    if (editingTask) {
                        await updateDoc(doc(db, 'tasks', editingTask.id), formData);
                    } else {
                        await addDoc(collection(db, 'tasks'), {
                            ...formData,
                            status: KANBAN_STATUS.TODO,
                            taskTimestamp: serverTimestamp(),
                            creatorUid: userProfile.id
                        });
                    }
                    setIsModalOpen(false);
                    setEditingTask(null);
                } catch (error) {
                    console.error("Error saving task:", error);
                    alert("Failed to save task.");
                }
            };

            const handleDeleteTask = async () => {
                if (!taskToDelete) return;
                try {
                    await deleteDoc(doc(db, 'tasks', taskToDelete.id));
                    setTaskToDelete(null);
                } catch (error) {
                    console.error("Error deleting task:", error);
                }
            };

            const canManage = userProfile.role !== 'Staff';

            return (
                <div className="flex flex-col space-y-6">
                    {/* Toolbar */}
                    <div className="flex flex-wrap gap-4 justify-between items-center mb-0 bg-slate-800/50 p-4 rounded-xl border border-slate-700">
                        <div className="flex gap-4 items-center flex-1">
                            {canManage && (
                                <select value={filterStaff} onChange={e => setFilterStaff(e.target.value)} className="select text-sm w-auto">
                                    <option value="">All Staff</option>
                                    {employees && employees.map(e => <option key={e.id} value={e.id}>{e.name}</option>)}
                                </select>
                            )}
                            <select value={filterKpi} onChange={e => setFilterKpi(e.target.value)} className="select text-sm w-auto">
                                <option value="">All KPIs</option>
                                {kpis && kpis.map(k => <option key={k.id} value={k.id}>{k.name}</option>)}
                            </select>
                        </div>
                        <Button variant="primary" icon="fa-plus" onClick={() => { setEditingTask(null); setIsModalOpen(true); }}>
                            New Task
                        </Button>
                    </div>

                    {/* Board & History */}
                    {loading ? (
                        <div className="flex justify-center items-center py-20"><i className="fas fa-spinner fa-spin text-3xl text-blue-500"></i></div>
                    ) : (
                        <>
                            {/* Active Columns */}
                            <div className="overflow-x-auto pb-2">
                                <div className="flex gap-4 min-w-[900px]">
                                    <KanbanColumn title="To Do" status={KANBAN_STATUS.TODO} tasks={columns[KANBAN_STATUS.TODO]} color="slate" userProfile={userProfile} onEdit={(t) => { setEditingTask(t); setIsModalOpen(true); }} onDelete={setTaskToDelete} onTaskAction={handleTaskAction} processingTaskIds={processingTaskIds} />
                                    <KanbanColumn title="In Progress" status={KANBAN_STATUS.IN_PROGRESS} tasks={columns[KANBAN_STATUS.IN_PROGRESS]} color="blue" userProfile={userProfile} onEdit={(t) => { setEditingTask(t); setIsModalOpen(true); }} onDelete={setTaskToDelete} onTaskAction={handleTaskAction} processingTaskIds={processingTaskIds} />
                                    <KanbanColumn title="Auditing" status={KANBAN_STATUS.AUDITING} tasks={columns[KANBAN_STATUS.AUDITING]} color="yellow" userProfile={userProfile} onEdit={(t) => { setEditingTask(t); setIsModalOpen(true); }} onDelete={setTaskToDelete} onTaskAction={handleTaskAction} processingTaskIds={processingTaskIds} />
                                </div>
                            </div>

                            {/* Completed History Table (Replaces 'Done' Column) */}
                            <Card>
                                <div className="flex justify-between items-center mb-4">
                                    <h3 className="text-lg font-bold text-slate-100 flex items-center gap-2">
                                        <i className="fas fa-history text-green-400"></i> Completed Tasks History
                                    </h3>
                                    <div className="text-xs text-slate-400 bg-slate-800 px-3 py-1 rounded-full border border-slate-700 font-mono">
                                        Total: {columns[KANBAN_STATUS.DONE].length}
                                    </div>
                                </div>
                                <div className="overflow-x-auto">
                                    <table className="min-w-full divide-y divide-slate-700">
                                        <thead className="bg-slate-900/50">
                                            <tr>
                                                <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Completed Date</th>
                                                <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Task Description</th>
                                                <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Staff</th>
                                                <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Shop</th>
                                                <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">KPI</th>
                                                <th className="px-4 py-3 text-center text-xs font-semibold text-slate-400 uppercase">Result</th>
                                                <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Auditor</th>
                                            </tr>
                                        </thead>
                                        <tbody className="divide-y divide-slate-700">
                                            {columns[KANBAN_STATUS.DONE].map(task => (
                                                <tr key={task.id} className="hover:bg-slate-700/50 transition-colors">
                                                    <td className="px-4 py-3 text-sm text-slate-300 whitespace-nowrap">{formatFullDateTime(task.completedTimestamp)}</td>
                                                    <td className="px-4 py-3 text-sm text-slate-200 font-medium">{task.text}</td>
                                                    <td className="px-4 py-3 text-sm text-slate-300">{task.staffName}</td>
                                                    <td className="px-4 py-3 text-sm text-slate-400">{task.shopName}</td>
                                                    <td className="px-4 py-3 text-sm text-slate-300">{task.kpiText || '-'}</td>
                                                    <td className="px-4 py-3 text-sm text-center">
                                                        <span className={`px-2 py-1 text-xs font-bold rounded-full border ${
                                                            task.auditScore?.includes('100%') ? 'bg-green-500/10 text-green-400 border-green-500/20' :
                                                            task.auditScore?.includes('Rejected') ? 'bg-red-500/10 text-red-400 border-red-500/20' : 
                                                            'bg-blue-500/10 text-blue-400 border-blue-500/20'
                                                        }`}>
                                                            {task.auditScore || 'Approved'}
                                                        </span>
                                                    </td>
                                                    <td className="px-4 py-3 text-sm text-slate-400">{task.auditorName || 'System'}</td>
                                                </tr>
                                            ))}
                                            {columns[KANBAN_STATUS.DONE].length === 0 && (
                                                <tr><td colSpan="7" className="px-4 py-8 text-center text-slate-500 italic">No completed tasks found.</td></tr>
                                            )}
                                        </tbody>
                                    </table>
                                </div>
                            </Card>
                        </>
                    )}

                    <TaskModal isOpen={isModalOpen} onClose={() => setIsModalOpen(false)} onSave={handleSaveTask} task={editingTask} userProfile={userProfile} kpis={kpis} employees={employees} />
                    <ConfirmationModal isOpen={!!taskToDelete} onClose={() => setTaskToDelete(null)} onConfirm={handleDeleteTask} title="Delete Task" message="Are you sure you want to delete this task?" />
                </div>
            );
        };

        const KanbanColumn = ({ title, status, tasks, color, userProfile, onEdit, onDelete, onTaskAction, processingTaskIds }) => (
            <div className={`flex-1 bg-slate-800/30 rounded-xl border border-slate-700/50 flex flex-col min-h-[500px]`}>
                <div className={`p-3 border-b border-slate-700/50 flex justify-between items-center bg-${color}-900/20 rounded-t-xl`}>
                    <h3 className={`font-bold text-${color}-400 uppercase text-xs tracking-wider`}>{title}</h3>
                    <span className="bg-slate-700 text-slate-300 text-xs px-2 py-0.5 rounded-full">{tasks.length}</span>
                </div>
                <div className="p-2 flex-1 overflow-y-auto space-y-2 custom-scrollbar">
                    {tasks.map(task => (
                        <TaskCard 
                            key={task.id} 
                            task={task} 
                            onEdit={onEdit} 
                            onDelete={onDelete}
                            onTaskAction={onTaskAction}
                            processingTaskIds={processingTaskIds}
                            userProfile={userProfile}
                        />
                    ))}
                </div>
            </div>
        );

        // --- NEW: MEETING ROOM COMPONENTS ---

        // NEW: Modal for responding to an invitation
        const MeetingResponseModal = ({ isOpen, onClose, onConfirm, actionType }) => {
            const [reason, setReason] = useState('');

            useEffect(() => {
                if (isOpen) setReason('');
            }, [isOpen]);

            const handleSubmit = (e) => {
                e.preventDefault();
                onConfirm(actionType, reason);
            };

            if (!isOpen) return null;

            const isReject = actionType === 'rejected';

            return (
                <Modal isOpen={isOpen} onClose={onClose} maxWidth="max-w-md">
                    <form onSubmit={handleSubmit}>
                        <ModalHeader title={isReject ? "Decline Invitation" : "Accept Invitation"} onClose={onClose} />
                        <ModalBody>
                            <div className="space-y-4">
                                <p className="text-slate-300">
                                    {isReject 
                                        ? "Are you sure you want to decline this meeting? Please provide a reason." 
                                        : "Confirm your attendance for this meeting."}
                                </p>
                                <div>
                                    <label className="text-sm font-medium text-slate-400">
                                        {isReject ? "Reason for Rejection (Required)" : "Note (Optional)"}
                                    </label>
                                    <textarea 
                                        className="input" 
                                        rows="3" 
                                        value={reason} 
                                        onChange={(e) => setReason(e.target.value)}
                                        placeholder={isReject ? "e.g., Conflicting schedule, Sick leave..." : "e.g., I might be 5 mins late..."}
                                        required={isReject}
                                    ></textarea>
                                </div>
                            </div>
                        </ModalBody>
                        <ModalFooter>
                            <Button variant="secondary" onClick={onClose}>Cancel</Button>
                            <Button 
                                type="submit" 
                                variant={isReject ? 'danger' : 'success'}
                                disabled={isReject && !reason.trim()}
                            >
                                {isReject ? "Decline" : "Confirm Attendance"}
                            </Button>
                        </ModalFooter>
                    </form>
                </Modal>
            );
        };

        // --- NEW FEATURE: PENDING MEETING ALERT COMPONENTS ---
        
        // Sub-component for individual item logic in the alert list
        const PendingMeetingItem = ({ meeting, onRespond }) => {
            const [isRejecting, setIsRejecting] = useState(false);
            const [reason, setReason] = useState('');

            const handleRejectSubmit = () => {
                if (!reason.trim()) return;
                onRespond(meeting, 'rejected', reason);
            };

            return (
                <div className="p-4 border-b border-slate-700 bg-slate-800/30 hover:bg-slate-800/80 transition-colors first:rounded-t-lg last:rounded-b-lg last:border-b-0">
                    <div className="flex justify-between items-start mb-2">
                        <div>
                            <div className="flex items-center gap-2">
                                <i className="fas fa-calendar-check text-blue-400"></i>
                                <h4 className="font-bold text-white text-lg">{meeting.title}</h4>
                            </div>
                            <p className="text-sm text-slate-300 font-medium mt-1 ml-6">
                                {new Date(meeting.date).toLocaleDateString('en-GB', {weekday: 'short', day: 'numeric', month: 'short', year: 'numeric'})} 
                                <span className="mx-2 text-slate-600">|</span> 
                                <span className="text-yellow-400">{meeting.startTime} - {meeting.endTime}</span>
                            </p>
                        </div>
                        <div className="text-[10px] bg-slate-700 px-2 py-1 rounded text-slate-400 uppercase tracking-wider font-bold">
                            Host: {meeting.hostName?.split(' ')[0]}
                        </div>
                    </div>
                    
                    {meeting.location && (
                        <p className="text-xs text-slate-400 mb-3 ml-6">
                            <i className={`fas ${meeting.type === 'Online' ? 'fa-video' : 'fa-map-marker-alt'} mr-1 w-4 text-center`}></i> 
                            {meeting.location}
                        </p>
                    )}

                    {isRejecting ? (
                        <div className="mt-3 ml-6 bg-red-900/10 p-3 rounded-lg border border-red-900/30 animate-fade-in">
                            <label className="text-xs font-bold text-red-400 mb-1 block">Reason for declining:</label>
                            <textarea 
                                className="input text-sm w-full mb-2 bg-slate-900 border-red-900/30 focus:border-red-500" 
                                rows="2" 
                                value={reason} 
                                onChange={(e) => setReason(e.target.value)}
                                placeholder="e.g., Conflicting schedule..."
                                autoFocus
                            ></textarea>
                            <div className="flex gap-2 justify-end">
                                <button onClick={() => setIsRejecting(false)} className="text-xs text-slate-400 hover:text-white px-3 py-1">Cancel</button>
                                <Button variant="danger" onClick={handleRejectSubmit} disabled={!reason.trim()} className="py-1 px-3 text-xs">Confirm Decline</Button>
                            </div>
                        </div>
                    ) : (
                        <div className="flex gap-3 mt-4 ml-6">
                            <Button variant="success" onClick={() => onRespond(meeting, 'accepted')} className="flex-1 py-2 text-sm shadow-lg shadow-green-900/20" icon="fa-check">Accept</Button>
                            <Button variant="danger" onClick={() => setIsRejecting(true)} className="flex-1 py-2 text-sm shadow-lg shadow-red-900/20" icon="fa-times">Decline</Button>
                        </div>
                    )}
                </div>
            );
        };

        // --- NEW: SCANNER MODAL COMPONENT (Restored) ---
        const ScannerModal = ({ isOpen, onClose, onScan }) => {
            const scannerRef = useRef(null); 
            const onScanRef = useRef(onScan);

            useEffect(() => {
                onScanRef.current = onScan;
            }, [onScan]);

            useEffect(() => {
                if (isOpen && !scannerRef.current) {
                    const timer = setTimeout(() => {
                        try {
                            if (window.Html5Qrcode) {
                                const html5QrCode = new window.Html5Qrcode("reader");
                                scannerRef.current = html5QrCode;
                                html5QrCode.start({ facingMode: "environment" }, { fps: 10, qrbox: { width: 250, height: 250 } },
                                    (decodedText) => { 
                                        html5QrCode.stop().then(() => { 
                                            scannerRef.current = null; 
                                            if (onScanRef.current) onScanRef.current(decodedText); 
                                        }).catch(console.error); 
                                    },
                                    () => {}
                                ).catch(err => { console.error("Scanner Error:", err); alert("Unable to start camera. Ensure HTTPS and permissions."); onClose(); });
                            } else {
                                console.error("Html5Qrcode library not loaded");
                            }
                        } catch(e) { console.error(e); }
                    }, 300);
                    return () => clearTimeout(timer);
                }
                return () => { if (scannerRef.current) scannerRef.current.stop().catch(console.warn); };
            }, [isOpen]); 

            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 z-50 bg-black flex flex-col items-center justify-center p-4">
                    <div className="w-full max-w-md bg-slate-900 rounded-2xl p-4 border border-slate-700 relative">
                        <button onClick={onClose} className="absolute top-4 right-4 text-white text-xl z-10 bg-slate-800 rounded-full w-8 h-8 flex items-center justify-center shadow-md"><i className="fas fa-times"></i></button>
                        <h3 className="text-center text-white font-bold mb-4">Scan Shop QR</h3>
                        <div id="reader" className="scanner-box bg-slate-800"></div>
                        <p className="text-center text-slate-400 text-sm mt-4">Point your camera at the QR Code</p>
                    </div>
                </div>
            );
        };
        // --- END REUSABLE UI COMPONENTS ---

        // --- START CUSTOM OPTIMIZATION HOOKS (NEW) ---
        
        // OPTIMIZATION 1: Centralized Shop Permission Logic
        // Main Modal Component for the Alert
        const PendingMeetingsModal = ({ isOpen, onClose, meetings, onRespond }) => {
            if (!isOpen || meetings.length === 0) return null;

            return (
                <Modal isOpen={isOpen} onClose={onClose} maxWidth="max-w-lg">
                    <div className="flex flex-col max-h-[80vh]">
                        <div className="p-5 border-b border-slate-700 bg-slate-800 flex justify-between items-center shrink-0">
                            <div className="flex items-center gap-3">
                                <div className="p-2 bg-yellow-500/10 rounded-lg text-yellow-400 animate-pulse">
                                    <i className="fas fa-bell"></i>
                                </div>
                                <div>
                                    <h3 className="text-xl font-bold text-white">Action Required</h3>
                                    <p className="text-xs text-slate-400">You have {meetings.length} pending invitation{meetings.length > 1 ? 's' : ''}</p>
                                </div>
                            </div>
                            <Button variant="icon-close" onClick={onClose} className="text-2xl p-1">&times;</Button>
                        </div>
                        
                        <div className="overflow-y-auto custom-scrollbar bg-slate-900/50 p-4 space-y-4">
                            {meetings.map(meeting => (
                                <PendingMeetingItem key={meeting.id} meeting={meeting} onRespond={onRespond} />
                            ))}
                        </div>
                        
                        <div className="p-4 bg-slate-800 border-t border-slate-700 shrink-0 flex justify-end">
                            <Button variant="secondary" onClick={onClose}>Remind Me Later</Button>
                        </div>
                    </div>
                </Modal>
            );
        };

        // --- NEW: Birthday Celebration Pop-up Component ---
        const BirthdayCelebrationModal = ({ isOpen, onClose, celebrants }) => {
            if (!isOpen || !celebrants || celebrants.length === 0) return null;

            return (
                <Modal isOpen={isOpen} onClose={onClose} maxWidth="max-w-md">
                    <div className="relative overflow-hidden rounded-lg">
                        {/* Festive Background & Confetti Effect */}
                        <div className="absolute inset-0 bg-gradient-to-br from-slate-900 via-slate-800 to-slate-900 z-0"></div>
                        <div className="absolute top-0 right-0 w-64 h-64 bg-pink-500/10 rounded-full blur-3xl -mr-16 -mt-16 pointer-events-none"></div>
                        <div className="absolute bottom-0 left-0 w-48 h-48 bg-purple-500/10 rounded-full blur-3xl -ml-10 -mb-10 pointer-events-none"></div>
                        
                        {/* Content */}
                        <div className="relative z-10 p-8 text-center flex flex-col items-center">
                            <div className="w-24 h-24 bg-gradient-to-tr from-pink-500 to-purple-600 rounded-full flex items-center justify-center mb-6 shadow-lg shadow-pink-500/30 animate-bounce">
                                <i className="fas fa-birthday-cake text-4xl text-white"></i>
                            </div>
                            
                            <h2 className="text-3xl font-bold text-white mb-2 tracking-tight">Time to Celebrate!</h2>
                            <p className="text-slate-400 mb-8 text-sm">Today is a special day for your team.</p>

                            <div className="w-full space-y-3 mb-8">
                                {celebrants.map(emp => (
                                    <div key={emp.id} className="bg-slate-800/80 p-3 rounded-xl border border-slate-700/50 flex items-center gap-4 shadow-sm transform transition-transform hover:scale-105">
                                        <div className="w-12 h-12 rounded-full bg-slate-700 flex items-center justify-center text-white font-bold text-lg border-2 border-pink-500/50">
                                            {emp.name.charAt(0)}
                                        </div>
                                        <div className="text-left">
                                            <p className="font-bold text-white text-lg leading-none mb-1">{emp.name}</p>
                                            <p className="text-xs text-pink-400 font-bold uppercase tracking-wider">
                                                <i className="fas fa-star mr-1"></i> Happy Birthday!
                                            </p>
                                        </div>
                                    </div>
                                ))}
                            </div>

                            <Button 
                                onClick={onClose} 
                                className="w-full py-3.5 text-base font-bold bg-gradient-to-r from-pink-600 to-purple-600 hover:from-pink-500 hover:to-purple-500 text-white rounded-xl shadow-lg shadow-pink-900/20 transform transition-all active:scale-95"
                            >
                                <i className="fas fa-glass-cheers mr-2"></i> Join the Celebration
                            </Button>
                        </div>
                    </div>
                </Modal>
            );
        };
        // --- END NEW FEATURE COMPONENTS ---

        // NEW: Modal to view attendee status list (For Host)
        const MeetingAttendeesModal = ({ isOpen, onClose, meeting, employees }) => {
            if (!isOpen || !meeting) return null;

            const responses = meeting.responses || {};
            const invitedIds = meeting.invitedStaffIds || [];

            // Map IDs to employee data and status
            const attendeeList = invitedIds.map(id => {
                const emp = employees.find(e => e.id === id);
                const response = responses[id] || { status: 'pending' };
                return {
                    id,
                    name: emp ? emp.name : 'Unknown Staff',
                    position: emp ? emp.position : '',
                    status: response.status,
                    reason: response.reason,
                    timestamp: response.timestamp
                };
            });

            const counts = attendeeList.reduce((acc, curr) => {
                acc[curr.status] = (acc[curr.status] || 0) + 1;
                return acc;
            }, {});

            return (
                <Modal isOpen={isOpen} onClose={onClose} maxWidth="max-w-2xl">
                    <ModalHeader title={`Attendance: ${meeting.title}`} onClose={onClose} />
                    <ModalBody>
                        <div className="flex gap-4 mb-6 border-b border-slate-700 pb-4">
                            <div className="text-center flex-1">
                                <span className="block text-2xl font-bold text-green-400">{counts.accepted || 0}</span>
                                <span className="text-xs text-slate-500 uppercase">Accepted</span>
                            </div>
                            <div className="text-center flex-1">
                                <span className="block text-2xl font-bold text-red-400">{counts.rejected || 0}</span>
                                <span className="text-xs text-slate-500 uppercase">Declined</span>
                            </div>
                            <div className="text-center flex-1">
                                <span className="block text-2xl font-bold text-yellow-400">{counts.pending || 0}</span>
                                <span className="text-xs text-slate-500 uppercase">Pending</span>
                            </div>
                        </div>
                        <div className="space-y-3 max-h-96 overflow-y-auto custom-scrollbar">
                            {attendeeList.map(att => (
                                <div key={att.id} className="flex items-start justify-between p-3 rounded-lg bg-slate-700/30 border border-slate-600/50">
                                    <div>
                                        <p className="font-bold text-slate-200">{att.name}</p>
                                        <p className="text-xs text-slate-400">{att.position}</p>
                                        {att.reason && (
                                            <div className="mt-2 text-xs bg-slate-800/50 p-2 rounded text-slate-300 italic border-l-2 border-slate-500">
                                                "{att.reason}"
                                            </div>
                                        )}
                                    </div>
                                    <span className={`px-2 py-1 text-xs font-bold rounded-full uppercase ${
                                        att.status === 'accepted' ? 'bg-green-900 text-green-300' :
                                        att.status === 'rejected' ? 'bg-red-900 text-red-300' :
                                        'bg-yellow-900 text-yellow-300'
                                    }`}>
                                        {att.status}
                                    </span>
                                </div>
                            ))}
                        </div>
                    </ModalBody>
                    <ModalFooter>
                        <Button variant="secondary" onClick={onClose}>Close</Button>
                    </ModalFooter>
                </Modal>
            );
        };

        // Sub-Component: Meeting Modal (Schedule)
        const MeetingModal = ({ isOpen, onClose, onSave, meeting, userProfile, employees, shops }) => {
            const [formData, setFormData] = useState({});
            
            // Helper to determine available shops for the dropdown
            const availableShops = useMemo(() => {
                if (userProfile.role === 'Admin' || userProfile.role === 'CEO') return shops;
                if (userProfile.role === 'Shop Manager' && Array.isArray(userProfile.shop)) {
                    return shops.filter(s => userProfile.shop.includes(s.name));
                }
                return [];
            }, [shops, userProfile]);

            // Filter employees based on selected shop for the dropdown
            const availableEmployees = useMemo(() => {
                if (!formData.shop) return [];
                return employees.filter(e => {
                    const empShops = Array.isArray(e.shop) ? e.shop : [e.shop];
                    const isAlreadyInvited = (formData.invitedStaffIds || []).includes(e.id);
                    return empShops.includes(formData.shop) && e.status === 'Active' && !isAlreadyInvited;
                });
            }, [formData.shop, employees, formData.invitedStaffIds]);

            // Get list of currently invited staff objects for display
            const invitedStaff = useMemo(() => {
                const ids = formData.invitedStaffIds || [];
                return employees.filter(e => ids.includes(e.id));
            }, [formData.invitedStaffIds, employees]);

            useEffect(() => {
                if (isOpen) {
                    const initialShop = (userProfile.role === 'Shop Manager' && Array.isArray(userProfile.shop) && userProfile.shop.length === 1) 
                        ? userProfile.shop[0] 
                        : '';

                    setFormData(meeting ? { ...meeting } : {
                        title: '',
                        agenda: '',
                        date: new Date().toISOString().slice(0, 10),
                        startTime: '',
                        endTime: '',
                        type: 'In-Person', // or 'Online'
                        shop: initialShop,
                        location: '', // Room name or URL
                        invitedStaffIds: [] 
                    });
                }
            }, [isOpen, meeting, userProfile]);

            const handleChange = (e) => {
                const { name, value } = e.target;
                setFormData(prev => ({ ...prev, [name]: value }));
            };

            const handleAddStaff = (e) => {
                const staffId = e.target.value;
                if (!staffId) return;
                
                setFormData(prev => ({
                    ...prev,
                    invitedStaffIds: [...(prev.invitedStaffIds || []), staffId]
                }));
            };

            const handleRemoveStaff = (staffId) => {
                setFormData(prev => ({
                    ...prev,
                    invitedStaffIds: (prev.invitedStaffIds || []).filter(id => id !== staffId)
                }));
            };

            const handleSubmit = (e) => {
                e.preventDefault();
                if (!formData.title || !formData.date || !formData.startTime || !formData.endTime || !formData.shop) {
                    alert("Please fill in all required fields, including Shop.");
                    return;
                }
                onSave(formData);
            };

            return (
                <Modal isOpen={isOpen} onClose={onClose} maxWidth="max-w-2xl">
                    <form onSubmit={handleSubmit} className="flex flex-col h-full overflow-hidden">
                        <ModalHeader title={meeting ? "Edit Meeting" : "Schedule Meeting"} onClose={onClose} />
                        <ModalBody>
                            <div className="space-y-4">
                                <div>
                                    <label className="text-sm font-medium text-slate-400"><i className="fas fa-heading mr-2 text-blue-400"></i>Meeting Topic</label>
                                    <input name="title" value={formData.title || ''} onChange={handleChange} className="input" required placeholder="e.g., Monthly Sales Review" />
                                </div>

                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label className="text-sm font-medium text-slate-400"><i className="fas fa-store mr-2 text-cyan-400"></i>Shop Name</label>
                                        <select name="shop" value={formData.shop || ''} onChange={handleChange} className="select" required>
                                            <option value="">Select Shop</option>
                                            {availableShops.map(s => <option key={s.id} value={s.name}>{s.name}</option>)}
                                        </select>
                                    </div>
                                    <div>
                                        <label className="text-sm font-medium text-slate-400">
                                            {formData.type === 'Online' ? <><i className="fas fa-link mr-2 text-pink-400"></i>Meeting Link</> : <><i className="fas fa-map-marker-alt mr-2 text-red-400"></i>Location / Room</>}
                                        </label>
                                        <input 
                                            name="location" 
                                            value={formData.location || ''} 
                                            onChange={handleChange} 
                                            className="input" 
                                            placeholder={formData.type === 'Online' ? 'Zoom/Meet Link' : 'e.g., Conference Room A'} 
                                        />
                                    </div>
                                </div>

                                <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                                    <div>
                                        <label className="text-sm font-medium text-slate-400"><i className="fas fa-calendar-day mr-2 text-orange-400"></i>Date</label>
                                        <input type="date" name="date" value={formData.date || ''} onChange={handleChange} className="input" required />
                                    </div>
                                    <div>
                                        <label className="text-sm font-medium text-slate-400"><i className="fas fa-clock mr-2 text-green-400"></i>Start Time</label>
                                        <input type="time" name="startTime" value={formData.startTime || ''} onChange={handleChange} className="input" required />
                                    </div>
                                    <div>
                                        <label className="text-sm font-medium text-slate-400">End Time</label>
                                        <input type="time" name="endTime" value={formData.endTime || ''} onChange={handleChange} className="input" required />
                                    </div>
                                </div>

                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label className="text-sm font-medium text-slate-400"><i className="fas fa-video mr-2 text-purple-400"></i>Meeting Type</label>
                                        <select name="type" value={formData.type || 'In-Person'} onChange={handleChange} className="select">
                                            <option value="In-Person">In-Person</option>
                                            <option value="Online">Online (Video Call)</option>
                                        </select>
                                    </div>
                                </div>

                                <div>
                                    <label className="text-sm font-medium text-slate-400"><i className="fas fa-list-ul mr-2 text-slate-400"></i>Agenda</label>
                                    <textarea name="agenda" value={formData.agenda || ''} onChange={handleChange} className="input" rows="2" placeholder="Key points..."></textarea>
                                </div>

                                <div className="border-t border-slate-700 pt-4 mt-2">
                                    <label className="text-sm font-medium text-slate-400 mb-2 block"><i className="fas fa-users mr-2 text-teal-400"></i>Invite Attendees</label>
                                    
                                    {/* Staff Dropdown */}
                                    <div className="flex gap-2 mb-3">
                                        <select 
                                            value="" 
                                            onChange={handleAddStaff} 
                                            className="select flex-grow" 
                                            disabled={!formData.shop}
                                        >
                                            <option value="">{formData.shop ? "Select Staff to Add..." : "Select a Shop first"}</option>
                                            {availableEmployees.map(emp => (
                                                <option key={emp.id} value={emp.id}>{emp.name} - {emp.position}</option>
                                            ))}
                                        </select>
                                    </div>

                                    {/* Selected Staff Chips */}
                                    <div className="flex flex-wrap gap-2 p-3 border border-slate-600 rounded-lg bg-slate-700/30 min-h-[60px]">
                                        {invitedStaff.length > 0 ? (
                                            invitedStaff.map(emp => (
                                                <div key={emp.id} className="flex items-center gap-2 bg-slate-600 text-slate-200 px-3 py-1 rounded-full text-sm border border-slate-500 shadow-sm animate-fade-in">
                                                    <span>{emp.name}</span>
                                                    <button 
                                                        type="button" 
                                                        onClick={() => handleRemoveStaff(emp.id)}
                                                        className="text-slate-400 hover:text-red-400 focus:outline-none"
                                                    >
                                                        <i className="fas fa-times-circle"></i>
                                                    </button>
                                                </div>
                                            ))
                                        ) : (
                                            <span className="text-slate-500 text-sm italic self-center">No attendees added yet.</span>
                                        )}
                                    </div>
                                </div>
                            </div>
                        </ModalBody>
                        <ModalFooter>
                            <Button variant="secondary" onClick={onClose}>Cancel</Button>
                            <Button type="submit" variant="primary">Schedule Meeting</Button>
                        </ModalFooter>
                    </form>
                </Modal>
            );
        };

        // Sub-Component: Meeting Card
        const MeetingCard = ({ meeting, userProfile, onEdit, onDelete, employees, onResponseAction, onViewAttendees }) => {
            const getStatus = () => {
                const now = new Date();
                const start = new Date(`${meeting.date}T${meeting.startTime}`);
                const end = new Date(`${meeting.date}T${meeting.endTime}`);
                
                if (now > end) return { label: 'Completed', color: 'bg-slate-600 text-slate-300' };
                if (now >= start && now <= end) return { label: 'In Progress', color: 'bg-green-600 text-white animate-pulse' };
                return { label: 'Upcoming', color: 'bg-blue-600 text-white' };
            };

            const status = getStatus();
            const isHost = meeting.hostId === userProfile.id;
            const canManage = userProfile.role === 'Admin' || userProfile.role === 'CEO' || isHost;
            const isInvited = meeting.invitedStaffIds?.includes(userProfile.id);

            // Response Logic
            const myResponse = meeting.responses?.[userProfile.id];
            const myStatus = myResponse?.status || 'pending';

            // Counts for Host View
            const responses = meeting.responses || {};
            const acceptedCount = Object.values(responses).filter(r => r.status === 'accepted').length;
            const rejectedCount = Object.values(responses).filter(r => r.status === 'rejected').length;
            const totalInvited = meeting.invitedStaffIds?.length || 0;
            const pendingCount = totalInvited - acceptedCount - rejectedCount;
            
            return (
                <div className="bg-slate-800/50 border border-slate-700 rounded-xl p-5 shadow-lg hover:border-slate-600 transition-all flex flex-col h-full group">
                    {/* Header: Date & Status Badge */}
                    <div className="flex justify-between items-start mb-3">
                        <div className="flex flex-col">
                            <span className="text-3xl font-bold text-slate-200 leading-none mb-1">
                                {new Date(meeting.date).getDate()}
                            </span>
                            <span className="text-xs uppercase font-bold text-slate-500">
                                {new Date(meeting.date).toLocaleDateString('en-US', { month: 'short' })}
                            </span>
                        </div>
                        <span className={`px-3 py-1 rounded-full text-xs font-bold ${status.color} shadow-sm`}>
                            {status.label}
                        </span>
                    </div>

                    {/* Title */}
                    <h3 className="text-lg font-bold text-white mb-1 line-clamp-2">{meeting.title}</h3>
                    
                    {/* Details */}
                    <div className="text-sm text-slate-400 mb-4 space-y-1">
                        <div className="flex items-center gap-2">
                            <i className="fas fa-clock text-slate-500 w-4"></i>
                            <span>{meeting.startTime} - {meeting.endTime}</span>
                        </div>
                        <div className="flex items-center gap-2">
                            <i className={`fas ${meeting.type === 'Online' ? 'fa-video text-purple-400' : 'fa-map-marker-alt text-red-400'} w-4`}></i>
                            <span className="truncate">{meeting.location || 'No location set'}</span>
                        </div>
                        <div className="flex items-center gap-2">
                            <i className="fas fa-user-circle text-slate-500 w-4"></i>
                            <span>Host: {meeting.hostName}</span>
                        </div>
                        
                        {/* Host View: Attendance Summary */}
                        {canManage && (
                            <div className="flex items-center gap-2 mt-2 cursor-pointer hover:bg-slate-700/50 p-1 rounded -ml-1 transition-colors" onClick={() => onViewAttendees(meeting)}>
                                <i className="fas fa-users text-teal-500 w-4"></i>
                                <span className="text-xs font-medium">
                                    <span className="text-green-400">{acceptedCount}✓</span> · <span className="text-red-400">{rejectedCount}✕</span> · <span className="text-yellow-400">{pendingCount}?</span>
                                </span>
                                <i className="fas fa-chevron-right text-[10px] ml-auto text-slate-600"></i>
                            </div>
                        )}
                        
                        {/* Staff View: Simple Count */}
                        {!canManage && (
                            <div className="flex items-center gap-2">
                                <i className="fas fa-users text-teal-500 w-4"></i>
                                <span>{totalInvited} Invited</span>
                            </div>
                        )}
                    </div>

                    {meeting.agenda && (
                        <div className="mb-4 p-3 bg-slate-900/50 rounded-lg text-sm text-slate-300 italic border border-slate-700/50 line-clamp-3">
                            "{meeting.agenda}"
                        </div>
                    )}

                    {/* Footer Actions */}
                    <div className="mt-auto space-y-3">
                        {/* Invitation Response Buttons (For Staff) */}
                        {!isHost && isInvited && meeting.status !== 'Completed' && (
                            <div className="pt-3 border-t border-slate-700">
                                {myStatus === 'pending' ? (
                                    <div className="flex gap-2">
                                        <button 
                                            onClick={() => onResponseAction(meeting, 'accepted')} 
                                            className="flex-1 bg-green-600 hover:bg-green-500 text-white text-sm font-bold py-2 rounded-lg transition-colors flex justify-center items-center gap-2"
                                        >
                                            <i className="fas fa-check"></i> Accept
                                        </button>
                                        <button 
                                            onClick={() => onResponseAction(meeting, 'rejected')} 
                                            className="flex-1 bg-red-600 hover:bg-red-500 text-white text-sm font-bold py-2 rounded-lg transition-colors flex justify-center items-center gap-2"
                                        >
                                            <i className="fas fa-times"></i> Reject
                                        </button>
                                    </div>
                                ) : (
                                    <div className="flex items-center justify-between bg-slate-900/50 p-2 rounded-lg border border-slate-700">
                                        <div className="flex items-center gap-2">
                                            <div className={`w-2 h-2 rounded-full ${myStatus === 'accepted' ? 'bg-green-500' : 'bg-red-500'}`}></div>
                                            <span className="text-sm font-medium text-slate-300">You {myStatus}</span>
                                        </div>
                                        <button onClick={() => onResponseAction(meeting, 'edit')} className="text-xs text-blue-400 hover:text-blue-300 underline">Change</button>
                                    </div>
                                )}
                            </div>
                        )}

                        <div className="flex gap-2">
                            {meeting.type === 'Online' && meeting.location && meeting.location.startsWith('http') && (myStatus === 'accepted' || isHost) && (
                                <a 
                                    href={meeting.location} 
                                    target="_blank" 
                                    rel="noopener noreferrer"
                                    className="flex-1 bg-purple-600 hover:bg-purple-500 text-white text-sm font-bold py-2 px-4 rounded-lg text-center transition-colors flex items-center justify-center gap-2"
                                >
                                    <i className="fas fa-video"></i> Join
                                </a>
                            )}
                            
                            {canManage && (
                                <>
                                    <button onClick={() => onEdit(meeting)} className="p-2 bg-slate-700 hover:bg-blue-600 text-slate-300 hover:text-white rounded-lg transition-colors">
                                        <i className="fas fa-edit"></i>
                                    </button>
                                    <button onClick={() => onDelete(meeting)} className="p-2 bg-slate-700 hover:bg-red-600 text-slate-300 hover:text-white rounded-lg transition-colors">
                                        <i className="fas fa-trash"></i>
                                    </button>
                                </>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        // Main Tab Component
        const MeetingRoomTab = ({ userProfile }) => {
            const { db, auth } = useFirebase();
            const { employees, shops } = useAppData();
            const { collection, query, where, onSnapshot, orderBy, addDoc, updateDoc, deleteDoc, doc, serverTimestamp } = window.firebaseSDK;

            const [meetings, setMeetings] = useState([]);
            const [loading, setLoading] = useState(true);
            const [isModalOpen, setIsModalOpen] = useState(false);
            const [editingMeeting, setEditingMeeting] = useState(null);
            const [meetingToDelete, setMeetingToDelete] = useState(null);
            
            // NEW STATES
            const [isResponseModalOpen, setIsResponseModalOpen] = useState(false);
            const [respondingMeeting, setRespondingMeeting] = useState(null);
            const [responseActionType, setResponseActionType] = useState('accepted');
            const [isAttendeesModalOpen, setIsAttendeesModalOpen] = useState(false);
            const [viewingAttendeesMeeting, setViewingAttendeesMeeting] = useState(null);
            
            // Filters
            const [filterType, setFilterType] = useState('upcoming'); // 'upcoming', 'history'

            useEffect(() => {
                if (!db || !userProfile) return;
                setLoading(true);

                // Build Query
                let q = query(collection(db, 'meetings'), orderBy('date', 'asc'), orderBy('startTime', 'asc'));
                
                const unsubscribe = onSnapshot(q, (snapshot) => {
                    const allMeetings = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    
                    // Filter based on Role and Invitation
                    const visibleMeetings = allMeetings.filter(m => {
                        const isHost = m.hostId === userProfile.id;
                        const isInvited = m.invitedStaffIds?.includes(userProfile.id);
                        
                        if (userProfile.role === 'Admin' || userProfile.role === 'CEO') return true;
                        if (userProfile.role === 'Shop Manager') {
                            const myShops = Array.isArray(userProfile.shop) ? userProfile.shop : [userProfile.shop];
                            return isHost || isInvited || (m.shop && myShops.includes(m.shop));
                        }
                        // Staff
                        return isInvited || isHost;
                    });

                    // Filter based on Time (Upcoming vs History)
                    const now = new Date();
                    now.setHours(0,0,0,0); // Start of today
                    const todayStr = now.toISOString().slice(0, 10);

                    const finalSet = visibleMeetings.filter(m => {
                        if (filterType === 'upcoming') return m.date >= todayStr;
                        return m.date < todayStr;
                    });

                    setMeetings(finalSet);
                    setLoading(false);
                });

                return () => unsubscribe();
            }, [db, userProfile, filterType]);

            const handleSave = async (formData) => {
                const payload = {
                    ...formData,
                    hostId: editingMeeting ? editingMeeting.hostId : userProfile.id,
                    hostName: editingMeeting ? editingMeeting.hostName : userProfile.name,
                    updatedAt: serverTimestamp()
                };

                if (!editingMeeting) {
                    payload.createdAt = serverTimestamp();
                    // Initialize empty responses map logic (handled naturally by Firestore when adding items later)
                }

                try {
                    if (editingMeeting) {
                        await updateDoc(doc(db, 'meetings', editingMeeting.id), payload);
                    } else {
                        await addDoc(collection(db, 'meetings'), payload);
                    }
                    setIsModalOpen(false);
                    setEditingMeeting(null);
                } catch (error) {
                    console.error("Error saving meeting:", error);
                    alert("Failed to save meeting.");
                }
            };

            const handleDelete = async () => {
                if (!meetingToDelete) return;
                try {
                    await deleteDoc(doc(db, 'meetings', meetingToDelete.id));
                    setMeetingToDelete(null);
                } catch (error) {
                    console.error("Error deleting meeting:", error);
                }
            };

            // NEW: Handle Staff Clicking Accept/Reject
            const handleResponseAction = (meeting, type) => {
                setRespondingMeeting(meeting);
                setResponseActionType(type === 'edit' ? 'accepted' : type); // Default to accepted if editing
                setIsResponseModalOpen(true);
            };

            // NEW: Submit Response to Firestore
            const handleSubmitResponse = async (type, reason) => {
                if (!respondingMeeting) return;
                
                try {
                    const meetingRef = doc(db, 'meetings', respondingMeeting.id);
                    // Update specific field in the map using dot notation
                    const fieldPath = `responses.${userProfile.id}`;
                    
                    await updateDoc(meetingRef, {
                        [fieldPath]: {
                            status: type,
                            reason: reason || '',
                            timestamp: new Date().toISOString()
                        }
                    });
                    
                    setIsResponseModalOpen(false);
                    setRespondingMeeting(null);
                } catch (error) {
                    console.error("Error saving response:", error);
                    alert("Failed to save response. Please try again.");
                }
            };

            const handleViewAttendees = (meeting) => {
                setViewingAttendeesMeeting(meeting);
                setIsAttendeesModalOpen(true);
            };

            const canCreate = userProfile.role === 'Admin' || userProfile.role === 'CEO' || userProfile.role === 'Shop Manager';

            return (
                <div className="space-y-6">
                    <div className="flex flex-col md:flex-row justify-between items-center gap-4 bg-slate-800/50 p-4 rounded-xl border border-slate-700">
                        <div>
                            <h2 className="text-xl font-bold text-white">Meeting Schedule</h2>
                            <p className="text-sm text-slate-400">View upcoming sessions and invitations</p>
                        </div>
                        <div className="flex items-center gap-4 w-full md:w-auto">
                            <div className="flex p-1 bg-slate-700 rounded-lg">
                                <button 
                                    onClick={() => setFilterType('upcoming')}
                                    className={`px-4 py-2 text-sm font-medium rounded-md transition-all ${filterType === 'upcoming' ? 'bg-blue-600 text-white shadow' : 'text-slate-400 hover:text-white'}`}
                                >
                                    Upcoming
                                </button>
                                <button 
                                    onClick={() => setFilterType('history')}
                                    className={`px-4 py-2 text-sm font-medium rounded-md transition-all ${filterType === 'history' ? 'bg-slate-600 text-white shadow' : 'text-slate-400 hover:text-white'}`}
                                >
                                    History
                                </button>
                            </div>
                            {canCreate && (
                                <Button variant="primary" icon="fa-plus" onClick={() => { setEditingMeeting(null); setIsModalOpen(true); }}>
                                    Schedule
                                </Button>
                            )}
                        </div>
                    </div>

                    {loading ? (
                        <div className="text-center py-20"><i className="fas fa-spinner fa-spin text-3xl text-blue-500"></i></div>
                    ) : meetings.length === 0 ? (
                        <div className="text-center py-20 opacity-50">
                            <i className="fas fa-calendar-times text-5xl text-slate-600 mb-4"></i>
                            <p className="text-lg text-slate-400">No {filterType} meetings found.</p>
                        </div>
                    ) : (
                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                            {meetings.map(meeting => (
                                <MeetingCard 
                                    key={meeting.id} 
                                    meeting={meeting} 
                                    userProfile={userProfile} 
                                    onEdit={() => { setEditingMeeting(meeting); setIsModalOpen(true); }}
                                    onDelete={() => setMeetingToDelete(meeting)}
                                    onResponseAction={handleResponseAction}
                                    onViewAttendees={handleViewAttendees}
                                    employees={employees}
                                />
                            ))}
                        </div>
                    )}

                    <MeetingModal 
                        isOpen={isModalOpen} 
                        onClose={() => setIsModalOpen(false)} 
                        onSave={handleSave} 
                        meeting={editingMeeting} 
                        userProfile={userProfile}
                        employees={employees}
                        shops={shops}
                    />

                    <MeetingResponseModal
                        isOpen={isResponseModalOpen}
                        onClose={() => setIsResponseModalOpen(false)}
                        onConfirm={handleSubmitResponse}
                        actionType={responseActionType}
                    />

                    <MeetingAttendeesModal
                        isOpen={isAttendeesModalOpen}
                        onClose={() => setIsAttendeesModalOpen(false)}
                        meeting={viewingAttendeesMeeting}
                        employees={employees}
                    />

                    <ConfirmationModal 
                        isOpen={!!meetingToDelete} 
                        onClose={() => setMeetingToDelete(null)} 
                        onConfirm={handleDelete} 
                        title="Cancel Meeting" 
                        message={`Are you sure you want to cancel "${meetingToDelete?.title}"?`} 
                    />
                </div>
            );
        };

        // NEW: Main Task Manager Page Container (Tabs)
        const TaskBoardPage = ({ userProfile }) => {
            const [activeTab, setActiveTab] = useState('kanban');

            const tabs = {
                kanban: <span><i className="fas fa-list-check mr-2 text-blue-400"></i>Task Board</span>,
                meetingRoom: <span><i className="fas fa-chalkboard-user mr-2 text-purple-400"></i>Meeting Room</span>
            };

            return (
                <TabbedPage tabs={tabs} activeTab={activeTab} setActiveTab={setActiveTab}>
                    <div id="kanban">
                        <TaskKanbanTab userProfile={userProfile} />
                    </div>
                    <div id="meetingRoom">
                        {/* REPLACED UnderConstructionPage with MeetingRoomTab */}
                        <MeetingRoomTab userProfile={userProfile} />
                    </div>
                </TabbedPage>
            );
        };
        // --- END TASK MANAGER PAGE ---

        // --- START DASHBOARD SUMMARY PAGE ---
        
        // NEW: Sub-component for Memo Item to handle "Read More" logic
        const DashboardMemoItem = ({ memo, isRead }) => { // Updated to accept isRead prop
            const [expanded, setExpanded] = useState(false);
            // Check if text is long enough to warrant a "Read More" button (e.g., > 80 chars)
            const isLongText = memo.content && memo.content.length > 80;

            return (
                <div className={`p-4 rounded-xl border relative transition-colors ${
                    isRead ? 'bg-slate-800/30 border-slate-700/30' : 'bg-slate-800 border-yellow-500/30 shadow-sm'
                }`}>
                    <div className="flex justify-between items-start mb-1">
                        <h4 className={`font-bold ${isRead ? 'text-slate-400' : 'text-slate-200'}`}>{memo.title}</h4>
                        {!isRead && <span className="bg-yellow-500 text-black text-[9px] font-bold px-1.5 py-0.5 rounded animate-pulse">NEW</span>}
                    </div>
                    
                    {/* Use whitespace-pre-line to preserve line breaks when expanded */}
                    <p className={`text-sm ${isRead ? 'text-slate-500' : 'text-slate-300'} whitespace-pre-line ${expanded ? '' : 'line-clamp-2'}`}>
                        {memo.content}
                    </p>
                    <div className="mt-2 flex items-center justify-between">
                        <div className="flex items-center gap-2 text-[10px] text-slate-500 font-medium uppercase">
                            <i className="fas fa-clock"></i>
                            <span>{memo.startTime} - {memo.endTime}</span>
                        </div>
                        {isLongText && (
                            <button 
                                onClick={(e) => { e.stopPropagation(); setExpanded(!expanded); }}
                                className="text-xs font-bold text-blue-400 hover:text-blue-300 transition-colors focus:outline-none"
                            >
                                {expanded ? "Show Less" : "Read More"}
                            </button>
                        )}
                    </div>
                </div>
            );
        };

        // --- NEW WIDGET: TEAM STATUS (Who is Present/Leave/OT Today) ---
        const TeamStatusWidget = ({ userProfile, db }) => {
            // ... (existing code for TeamStatusWidget)
            const [activeTab, setActiveTab] = useState('present');
            const [data, setData] = useState({ present: [], leave: [], ot: [] });
            const [loading, setLoading] = useState(true);

            useEffect(() => {
                const fetchTeamData = async () => {
                    if (!db || !userProfile) {
                        setLoading(false);
                        return;
                    }

                    try {
                        const { collection, query, where, getDocs } = window.firebaseSDK;
                        
                        // FIX 1: Generate 'todayStr' using local time to ensure correct date matching
                        const now = new Date();
                        const year = now.getFullYear();
                        const month = String(now.getMonth() + 1).padStart(2, '0');
                        const day = String(now.getDate()).padStart(2, '0');
                        const todayStr = `${year}-${month}-${day}`;
                        
                        // Timestamps for Attendance Query
                        const startOfDay = new Date(); startOfDay.setHours(0,0,0,0);
                        const endOfDay = new Date(); endOfDay.setHours(23,59,59,999);

                        // FIX 2: Remove complex 'shop' filters from DB query to avoid "Missing Index" errors.
                        // We will filter by shop in JavaScript instead. This is robust and works immediately.
                        
                        // 1. Fetch ALL Attendance for Today
                        const attQ = query(
                            collection(db, 'attendance'),
                            where('timestamp', '>=', startOfDay),
                            where('timestamp', '<=', endOfDay)
                        );

                        // 2. Fetch Active Leaves
                        const leaveQ = query(
                            collection(db, 'leaveRequests'),
                            where('status', '==', 'Approved'),
                            where('returnDate', '>', todayStr) 
                        );

                        // 3. Fetch Today's OT
                        const otQ = query(
                            collection(db, 'otRequests'),
                            where('status', '==', 'Approved'),
                            where('reqDate', '==', todayStr)
                        );

                        const [attSnap, leaveSnap, otSnap] = await Promise.all([
                            getDocs(attQ), getDocs(leaveQ), getDocs(otQ)
                        ]);

                        // --- FIX 3: Helper function to check if a record belongs to the user's allowed shops ---
                        const isAllowedShop = (recordShop) => {
                            if (!recordShop) return false;
                            if (userProfile.role === 'Admin' || userProfile.role === 'CEO') return true;
                            if (userProfile.role === 'Shop Manager') {
                                const myShops = Array.isArray(userProfile.shop) ? userProfile.shop : [userProfile.shop];
                                return myShops.includes(recordShop);
                            }
                            // Staff
                            const myShop = Array.isArray(userProfile.shop) ? userProfile.shop[0] : userProfile.shop;
                            return recordShop === myShop;
                        };

                        // Define Title Suffix
                        let headerTitleSuffix = "My Shop";
                        if (userProfile.role === 'Admin' || userProfile.role === 'CEO') headerTitleSuffix = "All Shops";
                        else if (userProfile.role === 'Shop Manager' && Array.isArray(userProfile.shop) && userProfile.shop.length > 1) headerTitleSuffix = "My Shops";
                        else if (userProfile.shop) headerTitleSuffix = Array.isArray(userProfile.shop) ? userProfile.shop[0] : userProfile.shop;

                        // Process Attendance
                        // MODIFIED: Aggregation logic to capture earliest IN and latest OUT
                        const dailyStatsMap = {};

                        attSnap.docs.forEach(doc => {
                            const d = doc.data();
                            if (isAllowedShop(d.shop)) {
                                if (!dailyStatsMap[d.employeeId]) {
                                    dailyStatsMap[d.employeeId] = {
                                        id: d.employeeId,
                                        name: d.employeeName,
                                        shop: d.shop,
                                        inTime: null,
                                        outTime: null,
                                        latestTimestamp: 0,
                                        latestType: null
                                    };
                                }
                                
                                const record = dailyStatsMap[d.employeeId];
                                const time = d.timestamp.toDate();

                                // Update latest action for status determination (Online/Offline)
                                if (time > record.latestTimestamp) {
                                    record.latestTimestamp = time;
                                    record.latestType = d.type;
                                    record.shop = d.shop; // Update current shop location if moved
                                }

                                // Capture Earliest Check-In
                                if (d.type === 'in') {
                                    if (!record.inTime || time < record.inTime) {
                                        record.inTime = time;
                                    }
                                } 
                                // Capture Latest Check-Out
                                else if (d.type === 'out') {
                                    if (!record.outTime || time > record.outTime) {
                                        record.outTime = time;
                                    }
                                }
                            }
                        });
                        
                        const presentList = Object.values(dailyStatsMap)
                            .filter(rec => rec.inTime !== null) // Must have at least checked in
                            .map(rec => {
                                const inStr = rec.inTime.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                                const outStr = rec.outTime ? rec.outTime.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : '-';
                                
                                return {
                                    id: rec.id,
                                    name: rec.name,
                                    info: `${rec.shop} • In: ${inStr} - Out: ${outStr}`,
                                    status: rec.latestType === 'in' ? 'Online' : 'Offline'
                                };
                            });

                        // Process Leaves
                        const leaveList = leaveSnap.docs
                            .map(doc => doc.data())
                            .filter(l => isAllowedShop(l.shop) && l.leaveDate <= todayStr) // JS Filter: Shop + Active Date
                            .map(l => ({
                                id: l.staffId,
                                name: l.staffName,
                                info: `${l.shop} • ${l.leaveSession || 'Full Day'}`,
                                status: l.leaveType
                            }));

                        // Process OT
                        const otList = otSnap.docs
                            .map(doc => doc.data())
                            .filter(o => isAllowedShop(o.shop)) // JS Filter: Shop
                            .map(o => ({
                                id: o.staffId,
                                name: o.staffName,
                                info: `${o.shop} • ${o.startTime} - ${o.endTime}`,
                                status: `${o.numberOfOTDays} Day(s)`
                            }));

                        setData({ present: presentList, leave: leaveList, ot: otList, titleSuffix: headerTitleSuffix });

                    } catch (error) {
                        console.error("Error fetching team status:", error);
                    } finally {
                        setLoading(false);
                    }
                };

                fetchTeamData();
            }, [db, userProfile]);

            const renderList = (list, emptyMsg, icon, color) => {
                if (list.length === 0) return <div className="text-center py-8 text-slate-500 text-sm">{emptyMsg}</div>;
                return (
                    <div className="space-y-3">
                        {list.map((item, idx) => (
                            <div key={`${item.id}-${idx}`} className="flex items-center justify-between p-3 rounded-lg bg-slate-800/50 border border-slate-700/50 hover:bg-slate-800 transition-colors">
                                <div className="flex items-center gap-3">
                                    <div className={`w-8 h-8 rounded-full bg-${color}-500/20 text-${color}-400 flex items-center justify-center border border-${color}-500/30`}>
                                        <i className={`fas ${icon}`}></i>
                                    </div>
                                    <div>
                                        <p className="text-sm font-bold text-slate-200">{item.name}</p>
                                        <p className="text-[10px] text-slate-400 font-mono">{item.info}</p>
                                    </div>
                                </div>
                                <span className={`text-[10px] px-2 py-1 rounded bg-${color}-900/30 text-${color}-300 border border-${color}-700/50`}>
                                    {item.status}
                                </span>
                            </div>
                        ))}
                    </div>
                );
            };

            return (
                <div className="bg-slate-900 rounded-2xl border border-slate-800 shadow-lg overflow-hidden flex flex-col h-full">
                    <div className="p-4 border-b border-slate-800 bg-slate-900/80">
                        <div className="flex items-center justify-between mb-4">
                            <h3 className="text-lg font-bold text-white flex items-center gap-2">
                                <i className="fas fa-store text-blue-400"></i> Today at {data.titleSuffix}
                            </h3>
                        </div>
                        <div className="flex p-1 bg-slate-800 rounded-lg">
                            <button onClick={() => setActiveTab('present')} className={`flex-1 py-1.5 text-xs font-bold rounded-md transition-all ${activeTab === 'present' ? 'bg-green-600 text-white shadow' : 'text-slate-400 hover:text-white'}`}>
                                Present ({data.present.length})
                            </button>
                            <button onClick={() => setActiveTab('leave')} className={`flex-1 py-1.5 text-xs font-bold rounded-md transition-all ${activeTab === 'leave' ? 'bg-pink-600 text-white shadow' : 'text-slate-400 hover:text-white'}`}>
                                Leave ({data.leave.length})
                            </button>
                            <button onClick={() => setActiveTab('ot')} className={`flex-1 py-1.5 text-xs font-bold rounded-md transition-all ${activeTab === 'ot' ? 'bg-purple-600 text-white shadow' : 'text-slate-400 hover:text-white'}`}>
                                OT ({data.ot.length})
                            </button>
                        </div>
                    </div>
                    <div className="flex-1 overflow-y-auto p-4 custom-scrollbar max-h-80">
                        {loading ? (
                            <div className="flex justify-center py-8"><i className="fas fa-spinner fa-spin text-2xl text-blue-500"></i></div>
                        ) : (
                            <>
                                {activeTab === 'present' && renderList(data.present, "No one is currently checked in.", "fa-user-check", "green")}
                                {activeTab === 'leave' && renderList(data.leave, "No one is on leave today.", "fa-umbrella-beach", "pink")}
                                {activeTab === 'ot' && renderList(data.ot, "No approved OT for today.", "fa-clock", "purple")}
                            </>
                        )}
                    </div>
                </div>
            );
        };

        // --- NEW WIDGET: BIRTHDAY CELEBRATION (Upcoming & Today) ---
        // FIX: Added useAppData to access shops for Timezone calculation
        const BirthdayWidget = ({ employees }) => {
            const { shops } = useAppData(); // Access global shops data

            const birthdayData = useMemo(() => {
                if (!employees || employees.length === 0 || !shops) return { today: [], upcoming: [] };

                // Filter valid employees
                const validEmployees = employees.filter(e => e.status === 'Active' && e.dob);

                const list = validEmployees.map(emp => {
                    // ... (Timezone & Date Logic remains the same) ...
                    // 1. Determine the employee's shop timezone
                    const empShopName = Array.isArray(emp.shop) ? emp.shop[0] : emp.shop;
                    const shop = shops.find(s => s.name === empShopName);
                    const timezone = shop?.timezone;

                    // 2. Get "Today" in that specific timezone
                    const { localDate: todayStr } = Utils.formatDateInTimezone({ toDate: () => new Date() }, timezone);
                    const [tYear, tMonth, tDay] = todayStr.split('-').map(Number);
                    
                    const todayDate = new Date(tYear, tMonth - 1, tDay);

                    // 3. Parse DOB
                    const [y, m, d] = emp.dob.split('-').map(Number);
                    if (!y || !m || !d) return null;

                    const thisYear = tYear;
                    let nextBirthday = new Date(thisYear, m - 1, d);
                    
                    if (nextBirthday < todayDate) {
                        nextBirthday.setFullYear(thisYear + 1);
                    }

                    const diffTime = nextBirthday - todayDate;
                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                    
                    const birthYear = y;
                    const turningAge = nextBirthday.getFullYear() - birthYear;

                    const dd = String(d).padStart(2, '0');
                    const mm = String(m).padStart(2, '0');
                    const displayDate = `${dd}-${mm}`;

                    const prefix = emp.sex === 'F' ? 'Ms.' : 'Mr.';

                    return { 
                        ...emp, 
                        nextBirthday, 
                        diffDays, 
                        turningAge,
                        displayDate, 
                        prefix
                    };
                }).filter(Boolean);

                const todaysBirthdays = list.filter(b => b.diffDays === 0);
                const upcomingBirthdays = list
                    .filter(b => b.diffDays > 0 && b.diffDays <= 14)
                    .sort((a, b) => a.diffDays - b.diffDays);

                return { today: todaysBirthdays, upcoming: upcomingBirthdays };
            }, [employees, shops]); 

            const { today, upcoming } = birthdayData;

            if (today.length === 0 && upcoming.length === 0) {
                return (
                    <div className="bg-slate-900 rounded-2xl border border-slate-800 shadow-lg p-5 flex flex-col items-center justify-center h-full min-h-[200px] bg-gradient-to-br from-slate-900 to-slate-800">
                        <div className="w-12 h-12 bg-slate-800 rounded-full flex items-center justify-center mb-3 text-slate-600">
                            <i className="fas fa-calendar text-xl"></i>
                        </div>
                        <p className="text-slate-500 text-sm font-medium">No birthdays in the next 2 weeks.</p>
                    </div>
                );
            }

            return (
                <div className="bg-slate-900 rounded-2xl border border-slate-800 shadow-lg overflow-hidden flex flex-col h-full relative">
                    {/* Header */}
                    <div className="relative p-5 bg-gradient-to-r from-pink-600 to-purple-600 overflow-hidden">
                        <div className="absolute top-0 right-0 w-32 h-32 bg-white/10 rounded-full blur-2xl -mr-10 -mt-10"></div>
                        <div className="flex items-center gap-3 relative z-10">
                            <div className="p-2.5 bg-white/20 backdrop-blur-md rounded-xl text-white shadow-sm border border-white/10">
                                <i className="fas fa-birthday-cake text-xl"></i>
                            </div>
                            <div>
                                <h3 className="text-lg font-bold text-white tracking-wide">Celebrations</h3>
                                <p className="text-xs text-pink-100 font-medium">{today.length > 0 ? "It's a special day!" : "Upcoming Birthdays"}</p>
                            </div>
                        </div>
                    </div>

                    <div className="flex-1 overflow-y-auto p-5 custom-scrollbar bg-slate-900/50 space-y-6">
                        {/* Today Section */}
                        {today.length > 0 && (
                            <div className="space-y-3">
                                <div className="flex items-center gap-2 mb-2">
                                    <span className="relative flex h-3 w-3">
                                      <span className="animate-ping absolute inline-flex h-full w-full rounded-full bg-pink-400 opacity-75"></span>
                                      <span className="relative inline-flex rounded-full h-3 w-3 bg-pink-500"></span>
                                    </span>
                                    <p className="text-xs font-bold text-white uppercase tracking-widest">Happening Today</p>
                                </div>
                                {today.map(emp => (
                                    <div key={emp.id} className="relative group overflow-hidden rounded-2xl bg-gradient-to-br from-slate-800 to-slate-900 border border-slate-700 p-4 shadow-lg shadow-pink-500/10 hover:shadow-pink-500/20 transition-all duration-300 transform hover:-translate-y-1">
                                        <div className="absolute top-0 right-0 p-3 opacity-10 group-hover:opacity-20 transition-opacity">
                                            <i className="fas fa-gift text-6xl text-pink-500 transform rotate-12"></i>
                                        </div>
                                        <div className="flex items-center gap-4 relative z-10">
                                            {/* MODIFIED: Use Photo if available */}
                                            <div className="w-14 h-14 rounded-full bg-gradient-to-tr from-pink-500 to-orange-400 p-[2px] shadow-lg flex-shrink-0">
                                                {emp.photo ? (
                                                    <img src={emp.photo} alt={emp.name} className="w-full h-full rounded-full object-cover border-2 border-slate-900" />
                                                ) : (
                                                    <div className="w-full h-full rounded-full bg-slate-800 flex items-center justify-center text-white font-bold text-xl border-2 border-slate-900">
                                                        {emp.name.charAt(0)}
                                                    </div>
                                                )}
                                            </div>
                                            <div>
                                                <h4 className="text-lg font-bold text-white leading-tight">{emp.name}</h4>
                                                <p className="text-xs text-pink-300 font-medium uppercase tracking-wide mb-1">{emp.position}</p>
                                                <span className="inline-flex items-center gap-1.5 px-2.5 py-0.5 rounded-full bg-pink-500/20 text-pink-300 text-xs font-bold border border-pink-500/30">
                                                    <i className="fas fa-star text-[10px]"></i> Turning {emp.turningAge}
                                                </span>
                                            </div>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        )}

                        {/* Upcoming Section */}
                        {upcoming.length > 0 && (
                            <div className="space-y-3">
                                {today.length > 0 && <div className="h-px bg-gradient-to-r from-transparent via-slate-700 to-transparent my-4"></div>}
                                <p className="text-xs font-bold text-slate-400 uppercase tracking-widest pl-1">Upcoming Birthdays</p>
                                <div className="grid gap-3">
                                    {upcoming.map(emp => (
                                        <div key={emp.id} className="flex items-start gap-3 p-3 rounded-xl bg-slate-800/40 border border-slate-700/50 hover:bg-slate-800 transition-colors group">
                                            {/* MODIFIED: Use Photo if available */}
                                            <div className="w-10 h-10 rounded-full flex-shrink-0 border border-slate-600 group-hover:border-blue-500/50 overflow-hidden bg-slate-700 flex items-center justify-center">
                                                {emp.photo ? (
                                                    <img src={emp.photo} alt={emp.name} className="w-full h-full object-cover" />
                                                ) : (
                                                    <span className="text-slate-400 font-bold group-hover:text-blue-400 transition-colors">{emp.name.charAt(0)}</span>
                                                )}
                                            </div>
                                            <div className="flex-1 min-w-0">
                                                <div className="flex justify-between items-start">
                                                    <h5 className="text-sm font-bold text-slate-200 truncate">{emp.name}</h5>
                                                    <span className="text-[10px] font-bold text-slate-500 bg-slate-900 px-2 py-0.5 rounded-full border border-slate-700 whitespace-nowrap">
                                                        In {emp.diffDays} day{emp.diffDays > 1 ? 's' : ''}
                                                    </span>
                                                </div>
                                                <p className="text-[10px] text-slate-500 font-medium uppercase tracking-wide mb-1.5">{emp.position}</p>
                                                
                                                <div className="text-xs text-blue-200/80 bg-blue-500/5 rounded-lg p-2 border border-blue-500/10 italic">
                                                    "{emp.prefix} {emp.name.split(' ')[0]} have upcoming birthday on {emp.displayDate} - {emp.turningAge} Y"
                                                </div>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        const DashboardSummaryPage = ({ userProfile, setActivePage, onNavigateWithTab }) => {
            // ... (rest of DashboardSummaryPage logic)
            const { employees, shops, shifts, isLoading } = useAppData(); 
            const { db } = useFirebase();
            const { collection, query, where, getDocs, limit, orderBy } = window.firebaseSDK;

            // MODIFIED: State to hold split counts
            const [pendingStats, setPendingStats] = useState({ leave: 0, ot: 0 });
            const [dailyStats, setDailyStats] = useState([]);
            const [loadingStats, setLoadingStats] = useState(true);
            
            // --- NEW STATE FOR EMPLOYEE DASHBOARD ---
            // MODIFIED: Added engagementAmount to state
            const [myStats, setMyStats] = useState({ workDays: 0, lateCount: 0, otDays: 0, engagementAmount: 0 });
            const [myRecentRequests, setMyRecentRequests] = useState([]);
            const [activeMemos, setActiveMemos] = useState([]);

            // --- NEW: KPI Stats State ---
            const [kpiStats, setKpiStats] = useState([]);

            // --- STEP 1 RE-EXECUTION: PREPARE SOCIAL/COLLEAGUE DATA FOR BIRTHDAYS ---
            // This logic allows Staff to see their colleagues' birthdays, even if they can't see their payroll data.
            const socialEmployees = useMemo(() => {
                if (!employees) return [];
                // Admins/CEOs see everyone
                if (userProfile.role === 'Admin' || userProfile.role === 'CEO') return employees;
                
                // For Shop Manager & Staff: See everyone in their shop(s)
                const myShops = Array.isArray(userProfile.shop) ? userProfile.shop : [userProfile.shop];
                
                return employees.filter(e => {
                    const eShops = Array.isArray(e.shop) ? e.shop : [e.shop];
                    // Check intersection: Does employee work in ANY of my shops?
                    return eShops.some(s => myShops.includes(s));
                });
            }, [employees, userProfile]);

            const activeSocialEmployees = socialEmployees.filter(e => e.status === 'Active');
            // --- END STEP 1 ---

            // --- BUG FIX: Calculate Active Shops Count based on Role ---
            const activeShopsCount = useMemo(() => {
                if (!shops) return 0;
                if (userProfile.role === 'Admin' || userProfile.role === 'CEO') {
                    return shops.length;
                }
                if (userProfile.role === 'Shop Manager') {
                    if (Array.isArray(userProfile.shop)) {
                        // Count shops that exist in the system and are assigned to the manager
                        return shops.filter(s => userProfile.shop.includes(s.name)).length;
                    }
                    // Single shop manager
                    return userProfile.shop ? 1 : 0;
                }
                return 1; // Staff
            }, [shops, userProfile]);
            // --- END FIX ---
            
            // ... (keep useEffects for data fetching same as before)
            
            // Fetch extra dashboard data
            useEffect(() => {
                if (!db || !userProfile) return;

                const fetchDashboardData = async () => {
                    const isStaff = userProfile.role === 'Staff';
                    const isManager = userProfile.role === 'Shop Manager';
                    const isAdmin = userProfile.role === 'Admin' || userProfile.role === 'CEO';

                    const today = new Date();
                    const startOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);
                    const endOfMonth = new Date(today.getFullYear(), today.getMonth() + 1, 0, 23, 59, 59);

                    // --- 1. KPI DATA FETCHING & PROCESSING ---
                    try {
                        let kpiQuery;
                        
                        // Define base query for "Done" tasks this month
                        if (isStaff) {
                            kpiQuery = query(
                                collection(db, 'tasks'),
                                where('staffId', '==', userProfile.id),
                                where('completedTimestamp', '>=', startOfMonth),
                                where('completedTimestamp', '<=', endOfMonth)
                            );
                        } else if (isManager) {
                            const myShops = Array.isArray(userProfile.shop) ? userProfile.shop : (userProfile.shop ? [userProfile.shop] : []);
                            if (myShops.length > 0) {
                                kpiQuery = query(
                                    collection(db, 'tasks'),
                                    where('shopName', 'in', myShops),
                                    where('completedTimestamp', '>=', startOfMonth),
                                    where('completedTimestamp', '<=', endOfMonth)
                                );
                            } else {
                                kpiQuery = query(collection(db, 'tasks'), where('shopName', '==', 'null')); // No access
                            }
                        } else {
                            // Admin/CEO
                            kpiQuery = query(
                                collection(db, 'tasks'),
                                where('completedTimestamp', '>=', startOfMonth),
                                where('completedTimestamp', '<=', endOfMonth)
                            );
                        }

                        if (kpiQuery) {
                            const kpiSnap = await getDocs(kpiQuery);
                            const tasks = kpiSnap.docs.map(d => d.data()).filter(t => t.status === 'done'); // Ensure status is done

                            // Aggregate Data
                            const statsMap = {};
                            
                            tasks.forEach(task => {
                                const kpiName = task.kpiText || 'General Tasks';
                                if (!statsMap[kpiName]) {
                                    statsMap[kpiName] = { name: kpiName, count: 0, totalScore: 0, scoreCount: 0 };
                                }
                                statsMap[kpiName].count += 1;
                                
                                // Parse score "100% - Excellent" -> 100
                                if (task.auditScore) {
                                    const scoreMatch = task.auditScore.match(/(\d+)%/);
                                    if (scoreMatch) {
                                        statsMap[kpiName].totalScore += parseInt(scoreMatch[1], 10);
                                        statsMap[kpiName].scoreCount += 1;
                                    }
                                }
                            });

                            const statsArray = Object.values(statsMap).map(s => ({
                                ...s,
                                avgScore: s.scoreCount > 0 ? Math.round(s.totalScore / s.scoreCount) : 0
                            })).sort((a, b) => b.count - a.count); // Sort by volume

                            setKpiStats(statsArray);
                        }

                    } catch (error) {
                        console.error("Error fetching KPI Dashboard Data:", error);
                    }
                    // --- END KPI FETCHING ---

                    // 1. Pending Leaves Count (For Admins/Managers)
                    if (!isStaff) {
                        try {
                            let leaveQ = query(collection(db, 'leaveRequests'), where('status', '==', 'Pending'));
                            let otQ = query(collection(db, 'otRequests'), where('status', '==', 'Pending'));

                            if (userProfile.role === 'Shop Manager' && Array.isArray(userProfile.shop)) {
                                leaveQ = query(leaveQ, where('shop', 'in', userProfile.shop));
                                otQ = query(otQ, where('shop', 'in', userProfile.shop));
                            }

                            const [leaveSnap, otSnap] = await Promise.all([
                                getDocs(leaveQ),
                                getDocs(otQ)
                            ]);
                            
                            setPendingStats({
                                leave: leaveSnap.size,
                                ot: otSnap.size
                            });
                        } catch (err) { console.error("Error fetching dashboard pending counts", err); }
                    }

                    // 2. Employee Specific Data (For Staff)
                    if (isStaff) {
                        try {
                            const currentMonthStr = today.toISOString().slice(0, 7); // YYYY-MM

                            // A. Calculate "My Stats" for this month
                            // Work Days (Count unique attendance dates)
                            const attQ = query(collection(db, 'attendance'), 
                                where('employeeId', '==', userProfile.id),
                                where('timestamp', '>=', startOfMonth),
                                where('timestamp', '<=', endOfMonth)
                            );
                            // Lates & Engagements (Count records)
                            const stateQ = query(collection(db, 'employeeStates'),
                                where('staffId', '==', userProfile.id),
                                where('date', '>=', currentMonthStr + '-01'),
                                where('date', '<=', currentMonthStr + '-31')
                            );
                            // OT (Sum OT days)
                            const otQ = query(collection(db, 'otRequests'),
                                where('staffId', '==', userProfile.id),
                                where('reqDate', '>=', currentMonthStr + '-01'),
                                where('reqDate', '<=', currentMonthStr + '-31'),
                                where('status', '==', 'Approved')
                            );

                            // B. Fetch Recent Requests (Client-Side Sort to fix Index Error)
                            const recentLeaveQ = query(collection(db, 'leaveRequests'), where('staffId', '==', userProfile.id));
                            const recentOtQ = query(collection(db, 'otRequests'), where('staffId', '==', userProfile.id));

                            // C. Fetch Active Memos
                            const memosQ = query(collection(db, 'memoAlerts'), where('status', '==', 'Active'));

                            // Execute all queries
                            const [attSnap, stateSnap, otSnap, rLeaveSnap, rOtSnap, memoSnap] = await Promise.all([
                                getDocs(attQ), getDocs(stateQ), getDocs(otQ), getDocs(recentLeaveQ), getDocs(recentOtQ), getDocs(memosQ)
                            ]);

                            // Process Stats
                            const uniqueDays = new Set(attSnap.docs.map(d => {
                                return d.data().timestamp?.toDate().toDateString();
                            }));
                            
                            // Filter for Lates
                            const lates = stateSnap.docs.filter(d => d.data().statusState === 'Deduction' && d.data().note?.includes('Late')).length;
                            
                            // Filter for Engagements (Bonuses)
                            const engagements = stateSnap.docs.filter(d => d.data().statusState === 'Engagement');
                            const totalEngagementAmount = engagements.reduce((sum, d) => sum + (parseFloat(d.data().amount) || 0), 0);

                            const otTotal = otSnap.docs.reduce((sum, d) => sum + (parseFloat(d.data().numberOfOTDays) || 0), 0);

                            // MODIFIED: Updated state with engagementAmount
                            setMyStats({ workDays: uniqueDays.size, lateCount: lates, otDays: otTotal, engagementAmount: totalEngagementAmount });

                            // Process Requests (Sort & Limit in JavaScript)
                            const leaveReqs = rLeaveSnap.docs.map(d => ({ ...d.data(), type: 'Leave', date: d.data().requestDate }));
                            const otReqs = rOtSnap.docs.map(d => ({ ...d.data(), type: 'OT', date: d.data().submissionDate }));
                            
                            const combinedRequests = [...leaveReqs, ...otReqs]
                                .sort((a, b) => {
                                    const dateA = a.date?.toDate ? a.date.toDate() : new Date(a.date);
                                    const dateB = b.date?.toDate ? b.date.toDate() : new Date(b.date);
                                    return dateB - dateA;
                                })
                                .slice(0, 3); // Take top 3 most recent
                                
                            setMyRecentRequests(combinedRequests);

                            // Process Memos
                            // MODIFIED: Smart Dashboard Logic (Sort Unread First)
                            const rawMemos = memoSnap.docs.map(d => ({id: d.id, ...d.data()}));
                            
                            // Filter logic: Apply targetShops check here as well to match NoticeBoardTab
                            const relevantMemos = rawMemos.filter(m => {
                                if (!m.targetShops || m.targetShops.length === 0) return true;
                                const userShops = Array.isArray(userProfile.shop) ? userProfile.shop : [userProfile.shop];
                                const validUserShops = userShops.filter(Boolean);
                                // Check overlap
                                return validUserShops.some(s => m.targetShops.includes(s));
                            });

                            // Sort: Unread first, then by Creation Date
                            relevantMemos.sort((a, b) => {
                                const aRead = (a.readBy || []).includes(userProfile.id);
                                const bRead = (b.readBy || []).includes(userProfile.id);
                                
                                if (aRead === bRead) {
                                    // If status matches, sort by date (newest first)
                                    return (b.createdAt?.toDate() || 0) - (a.createdAt?.toDate() || 0);
                                }
                                return aRead ? 1 : -1; // Unread comes first
                            });

                            setActiveMemos(relevantMemos.slice(0, 5)); // Show top 5

                        } catch (err) { console.error("Error fetching employee dashboard data", err); }
                    }
                };

                fetchDashboardData();
            }, [db, userProfile]);

            // --- NEW: Calculate Daily Attendance Stats per Shop ---
            useEffect(() => {
                if (!db || isLoading || !employees || !shops) return;

                const calculateDailyStats = async () => {
                    setLoadingStats(true);
                    try {
                        const today = new Date();
                        const startOfDay = new Date(today); startOfDay.setHours(0, 0, 0, 0);
                        const endOfDay = new Date(today); endOfDay.setHours(23, 59, 59, 999);
                        
                        let attQ = query(collection(db, 'attendance'), where('timestamp', '>=', startOfDay), where('timestamp', '<=', endOfDay));
                        let leaveQ = query(collection(db, 'leaveRequests'), where('status', '==', 'Approved'));

                        const [attSnap, leaveSnap] = await Promise.all([getDocs(attQ), getDocs(leaveQ)]);
                        const attendanceDocs = attSnap.docs.map(d => d.data());
                        const leaveDocs = leaveSnap.docs.map(d => d.data());

                        const relevantShops = (userProfile.role === 'Shop Manager' && Array.isArray(userProfile.shop))
                            ? shops.filter(s => userProfile.shop.includes(s.name))
                            : shops;

                        const stats = relevantShops.map(shop => {
                            const { localDate: shopTodayStr } = Utils.formatDateInTimezone({ toDate: () => new Date() }, shop.timezone);

                            const shopEmployees = employees.filter(e => {
                                const eShops = Array.isArray(e.shop) ? e.shop : [e.shop];
                                return eShops.includes(shop.name) && e.status === 'Active';
                            });

                            let presentCount = 0;
                            let lateCount = 0;
                            let leaveCount = 0;

                            shopEmployees.forEach(emp => {
                                const empAtt = attendanceDocs.filter(a => a.employeeId === emp.id && a.shop === shop.name);
                                const isPresent = empAtt.length > 0;

                                if (isPresent) {
                                    presentCount++;
                                    const firstIn = empAtt.find(a => a.type === 'in');
                                    if (firstIn && firstIn.timestamp) {
                                        const shift = shifts.find(s => s.name === emp.shift && s.shopName === shop.name);
                                        if (shift?.lateThreshold) {
                                            const checkInDate = firstIn.timestamp.toDate();
                                            const [lateH, lateM] = shift.lateThreshold.split(':').map(Number);
                                            const timeInZone = checkInDate.toLocaleTimeString('en-GB', { timeZone: shop.timezone || 'Asia/Phnom_Penh', hour: '2-digit', minute: '2-digit' });
                                            const [checkH, checkM] = timeInZone.split(':').map(Number);
                                            
                                            if (checkH > lateH || (checkH === lateH && checkM > lateM)) {
                                                lateCount++;
                                            }
                                        }
                                    }
                                } else {
                                    const isOnLeave = leaveDocs.some(l => 
                                        l.staffId === emp.id && 
                                        l.leaveDate <= shopTodayStr && 
                                        l.returnDate > shopTodayStr
                                    );
                                    if (isOnLeave) {
                                        leaveCount++;
                                    }
                                }
                            });

                            return {
                                id: shop.id,
                                name: shop.name,
                                totalStaff: shopEmployees.length,
                                present: presentCount,
                                late: lateCount,
                                leave: leaveCount,
                                absent: Math.max(0, shopEmployees.length - presentCount - leaveCount)
                            };
                        });

                        setDailyStats(stats);
                    } catch (error) {
                        console.error("Error calculating daily stats:", error);
                    } finally {
                        setLoadingStats(false);
                    }
                };

                calculateDailyStats();
            }, [db, employees, shops, shifts, userProfile, isLoading]);

            // --- Calculations ---
            const visibleEmployees = useMemo(() => {
                if (!employees) return [];
                if (userProfile.role === 'Admin' || userProfile.role === 'CEO') return employees;
                if (userProfile.role === 'Shop Manager') {
                    const managedShops = Array.isArray(userProfile.shop) ? userProfile.shop : (userProfile.shop ? [userProfile.shop] : []);
                    return employees.filter(e => {
                        const empShops = Array.isArray(e.shop) ? e.shop : [e.shop];
                        return empShops.some(s => managedShops.includes(s));
                    });
                }
                return employees.filter(e => e.id === userProfile.id);
            }, [employees, userProfile]);

            const activeEmployees = visibleEmployees.filter(e => e.status === 'Active');
            
            // NEW: Calculate Gender breakdown for Operations Card
            const maleStaffCount = activeEmployees.filter(e => e.sex === 'M').length;
            const femaleStaffCount = activeEmployees.filter(e => e.sex === 'F').length;
            
            // --- Helper Components ---
            const DashboardMetricCard = ({ title, value, subtitle, icon, color, onClick }) => (
                <div 
                    onClick={onClick}
                    // MODIFIED: Responsive padding (p-3 on mobile, p-5 on desktop) to fit 2-col grid
                    className={`relative p-3 sm:p-5 rounded-2xl border border-slate-800 bg-slate-900/50 shadow-lg overflow-hidden group transition-all duration-300 hover:shadow-xl hover:border-slate-700 hover:-translate-y-1 ${onClick ? 'cursor-pointer' : ''}`}
                >
                    <div className="flex justify-between items-start mb-2 relative z-10">
                        <div className={`p-2.5 rounded-xl bg-${color}-500/10 text-${color}-400 border border-${color}-500/20`}>
                            <i className={`fas ${icon} text-lg`}></i>
                        </div>
                        {onClick && <i className="fas fa-chevron-right text-slate-600 text-xs"></i>}
                    </div>
                    <div className="relative z-10">
                        {/* MODIFIED: Responsive font size (text-xl on mobile) to prevent overflow */}
                        <h3 className="text-xl sm:text-3xl font-bold text-white tracking-tight mb-0.5 font-sans truncate">{value}</h3>
                        <p className="text-xs font-semibold text-slate-400 uppercase tracking-wider truncate">{title}</p>
                        <p className="text-[10px] text-slate-500 mt-2 font-medium flex items-center gap-1 truncate">
                            <span className={`w-1.5 h-1.5 rounded-full bg-${color}-500 inline-block`}></span> {subtitle}
                        </p>
                    </div>
                    <div className={`absolute -right-4 -bottom-4 w-24 h-24 bg-${color}-500/5 rounded-full blur-xl group-hover:bg-${color}-500/10 transition-all duration-500`}></div>
                </div>
            );

            const CompactActionButton = ({ icon, label, onClick, color }) => (
                <button 
                    onClick={onClick}
                    className="group flex flex-col items-center justify-center p-3 rounded-xl border border-slate-700/50 bg-slate-800/50 hover:bg-slate-800 transition-all duration-200 hover:border-slate-600 hover:shadow-md"
                >
                    <div className={`mb-2 text-${color}-400 group-hover:scale-110 transition-transform duration-200`}>
                        <i className={`fas ${icon} text-xl`}></i>
                    </div>
                    <span className="text-[10px] font-bold text-slate-300 uppercase tracking-wide group-hover:text-white">{label}</span>
                </button>
            );

            const KPIStatsWidget = ({ stats, title, icon, color }) => (
                <div className="bg-slate-900 rounded-2xl border border-slate-800 shadow-lg overflow-hidden flex flex-col h-full">
                    <div className="p-5 border-b border-slate-800 flex justify-between items-center bg-slate-900/80">
                        <div className="flex items-center gap-3">
                            <div className={`p-2 bg-${color}-500/10 rounded-lg text-${color}-400`}>
                                <i className={`fas ${icon}`}></i>
                            </div>
                            <h3 className="text-lg font-bold text-white">{title}</h3>
                        </div>
                        <button onClick={() => setActivePage('tasks')} className="text-xs font-bold text-blue-400 hover:text-blue-300">
                            VIEW DETAILS
                        </button>
                    </div>
                    <div className="flex-1 overflow-y-auto max-h-64 p-4 space-y-3">
                        {stats.length === 0 ? (
                            <p className="text-slate-500 text-sm text-center py-8">No KPI data for this month.</p>
                        ) : (
                            stats.map((item, idx) => (
                                <div key={idx} className="flex items-center justify-between p-3 rounded-xl bg-slate-800/50 border border-slate-700/50">
                                    <div className="flex-1 min-w-0 pr-4">
                                        <p className="text-sm font-semibold text-slate-200 truncate">{item.name}</p>
                                        <div className="flex items-center gap-2 mt-1">
                                            <div className="flex-1 h-1.5 bg-slate-700 rounded-full overflow-hidden">
                                                <div className={`h-full bg-${color}-500 rounded-full`} style={{ width: `${Math.min(100, item.avgScore)}%` }}></div>
                                            </div>
                                            <span className="text-[10px] text-slate-400 font-mono">{item.avgScore}% Qual.</span>
                                        </div>
                                    </div>
                                    <div className="text-right">
                                        <span className="block text-lg font-bold text-white leading-none">{item.count}</span>
                                        <span className="text-[10px] text-slate-500 uppercase">Tasks</span>
                                    </div>
                                </div>
                            ))
                        )}
                    </div>
                </div>
            );

            if (isLoading) return <div className="text-center py-20"><i className="fas fa-spinner fa-spin text-4xl text-blue-500"></i><p className="mt-4 text-slate-400 animate-pulse">Initializing Dashboard...</p></div>;

            // --- VIEW 1: ADMIN & MANAGER DASHBOARD ---
            if (userProfile.role !== 'Staff') {
                return (
                    <div className="grid grid-cols-1 lg:grid-cols-6 gap-6 animate-fade-in pb-10">
                        
                        {/* 1. OPERATIONS CARD */}
                        {/* Mobile: Order 1 | Desktop: Order 1, Col-Span 2 (1/3 width) */}
                        <div className="order-1 lg:order-1 lg:col-span-2 relative p-5 rounded-2xl border border-slate-800 bg-slate-900/50 shadow-lg flex flex-col justify-between group hover:border-slate-700 transition-colors h-full min-h-[160px]">
                            <div className="flex items-center gap-3 mb-4">
                                <div className="p-2 bg-indigo-500/10 rounded-lg text-indigo-400 border border-indigo-500/20">
                                    <i className="fas fa-network-wired"></i>
                                </div>
                                <span className="text-sm font-bold text-slate-300 uppercase tracking-wide">Operations</span>
                            </div>
                            <div className="grid grid-cols-2 divide-x divide-slate-700/50 mb-3">
                                <div className="pr-4">
                                    <div className="text-3xl font-bold text-white">{activeEmployees.length}</div>
                                    <div className="text-xs text-slate-500 font-medium uppercase mt-1">Active Staff</div>
                                </div>
                                <div className="pl-4">
                                    {/* FIX: Use the calculated activeShopsCount instead of shops.length */}
                                    <div className="text-3xl font-bold text-white">{activeShopsCount}</div>
                                    <div className="text-xs text-slate-500 font-medium uppercase mt-1">Active Shops</div>
                                </div>
                            </div>

                            {/* NEW: Gender Stats Breakdown */}
                            <div className="flex items-center gap-6 pt-3 border-t border-slate-700/50">
                                <div className="flex items-center gap-2">
                                    <div className="w-2 h-2 rounded-full bg-blue-500 shadow-sm shadow-blue-500/50"></div>
                                    <span className="text-xs text-slate-400 font-medium">Male: <span className="text-white font-bold">{maleStaffCount}</span></span>
                                </div>
                                <div className="flex items-center gap-2">
                                    <div className="w-2 h-2 rounded-full bg-pink-500 shadow-sm shadow-pink-500/50"></div>
                                    <span className="text-xs text-slate-400 font-medium">Female: <span className="text-white font-bold">{femaleStaffCount}</span></span>
                                </div>
                            </div>

                            <div className="absolute top-0 right-0 w-20 h-20 bg-indigo-500/5 rounded-bl-full blur-xl"></div>
                        </div>

                        {/* 2. PENDING REQUESTS (Swapped to Order 2 on Mobile) */}
                        {/* Mobile: Order 2 | Desktop: Order 3, Col-Span 2 (1/3 width) */}
                        <div className="order-2 lg:order-3 lg:col-span-2 grid grid-cols-2 lg:flex lg:flex-col gap-4 h-full">
                            <div 
                                onClick={() => onNavigateWithTab('leaveRequest')}
                                className="flex-1 relative p-5 rounded-2xl border border-slate-800 bg-slate-900/50 shadow-lg group cursor-pointer hover:border-slate-700 hover:-translate-y-1 transition-all"
                            >
                                 <div className="flex justify-between items-start mb-1">
                                    <div className="p-2 rounded-lg bg-orange-500/10 text-orange-400 border border-orange-500/20">
                                        <i className="fas fa-calendar-minus"></i>
                                    </div>
                                    <span className="text-xs font-bold text-slate-500 uppercase tracking-wider">Leave</span>
                                </div>
                                <div className="text-2xl font-bold text-white mt-2">{pendingStats.leave} <span className="text-sm font-normal text-slate-400">Pending</span></div>
                                <div className="absolute -right-4 -bottom-4 w-16 h-16 bg-orange-500/5 rounded-full blur-xl group-hover:bg-orange-500/10 transition-all duration-500"></div>
                            </div>

                            <div 
                                onClick={() => onNavigateWithTab('otRequest')}
                                className="flex-1 relative p-5 rounded-2xl border border-slate-800 bg-slate-900/50 shadow-lg group cursor-pointer hover:border-slate-700 hover:-translate-y-1 transition-all"
                            >
                                 <div className="flex justify-between items-start mb-1">
                                    <div className="p-2 rounded-lg bg-purple-500/10 text-purple-400 border border-purple-500/20">
                                        <i className="fas fa-clock"></i>
                                    </div>
                                     <span className="text-xs font-bold text-slate-500 uppercase tracking-wider">Overtime</span>
                                </div>
                                <div className="text-2xl font-bold text-white mt-2">{pendingStats.ot} <span className="text-sm font-normal text-slate-400">Pending</span></div>
                                <div className="absolute -right-4 -bottom-4 w-16 h-16 bg-purple-500/5 rounded-full blur-xl group-hover:bg-purple-500/10 transition-all duration-500"></div>
                            </div>
                        </div>

                        {/* 3. LIVE ATTENDANCE MONITOR (Swapped to Order 3 on Mobile) */}
                        {/* Mobile: Order 3 | Desktop: Order 4, Col-Span 3 (1/2 width, Row 2) */}
                        <div className="order-3 lg:order-4 lg:col-span-3 h-[500px] lg:h-auto">
                            <TeamStatusWidget userProfile={userProfile} db={db} />
                        </div>

                        {/* 4. COMMAND CENTER */}
                        {/* Mobile: Order 4 | Desktop: Order 2, Col-Span 2 (1/3 width) */}
                        <div className="order-4 lg:order-2 lg:col-span-2 p-5 rounded-2xl border border-slate-800 bg-slate-900 shadow-lg flex flex-col h-full min-h-[160px]">
                            <div className="flex items-center justify-between mb-4">
                                <div className="flex items-center gap-2">
                                    <i className="fas fa-bolt text-yellow-500"></i>
                                    <span className="text-sm font-bold text-white uppercase tracking-wide">Command Center</span>
                                </div>
                            </div>
                            <div className="grid grid-cols-2 gap-3 flex-grow">
                                <CompactActionButton icon="fa-user-clock" label="Check In" color="blue" onClick={() => setActivePage('checkinme')} />
                                <CompactActionButton 
                                    icon="fa-user-plus" 
                                    label="Add Staff" 
                                    color="emerald" 
                                    onClick={() => setActivePage(`employees:add_new:${Date.now()}`)} 
                                />
                                <CompactActionButton icon="fa-file-invoice-dollar" label="Payroll" color="amber" onClick={() => setActivePage('payroll')} />
                                <CompactActionButton icon="fa-cog" label="Config" color="slate" onClick={() => setActivePage('settings')} />
                            </div>
                        </div>

                        {/* 5. KPI STATS */}
                        {/* Mobile: Order 5 | Desktop: Order 5, Col-Span 3 (1/2 width, Row 2) */}
                        <div className="order-5 lg:order-5 lg:col-span-3 h-[500px] lg:h-auto">
                            <KPIStatsWidget stats={kpiStats} title="KPI Performance (This Month)" icon="fa-chart-pie" color="purple" />
                        </div>

                        {/* NEW: 6. BIRTHDAY CELEBRATIONS */}
                        <div className="order-6 lg:order-6 lg:col-span-2 h-[500px] lg:h-auto">
                            <BirthdayWidget employees={activeEmployees} />
                        </div>
                    </div>
                );
            }

            // --- VIEW 2: EMPLOYEE (STAFF) DASHBOARD ---
            return (
                <div className="space-y-6 animate-fade-in pb-10">
                    {/* MODIFIED: Changed to grid-cols-2 (2 columns) on mobile with smaller gap (gap-3) */}
                    <div className="grid grid-cols-2 lg:grid-cols-4 gap-3 sm:gap-6">
                        <DashboardMetricCard title="Work Days" value={myStats.workDays} subtitle="This Month" icon="fa-calendar-check" color="blue" />
                        <DashboardMetricCard title="Late Count" value={myStats.lateCount} subtitle="Deductions" icon="fa-user-clock" color={myStats.lateCount > 0 ? "red" : "green"} />
                        <DashboardMetricCard title="OT Days" value={myStats.otDays.toFixed(1)} subtitle="Approved" icon="fa-business-time" color="purple" />
                        {/* NEW: Added Engagement Card */}
                        <DashboardMetricCard title="Engagement" value={Utils.formatCurrency(myStats.engagementAmount)} subtitle="Bonuses" icon="fa-hand-holding-dollar" color="teal" />
                    </div>

                    <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <div className="lg:col-span-2">
                            {/* NEW: Team Status Widget */}
                            <TeamStatusWidget userProfile={userProfile} db={db} />
                        </div>
                        <div className="lg:col-span-1">
                            <KPIStatsWidget stats={kpiStats} title="My KPI Scorecard" icon="fa-award" color="emerald" />
                        </div>
                    </div>

                    {/* Tracker & Announcements & Birthdays Row */}
                    <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        {/* NEW: Birthday Widget for Staff */}
                        <div className="lg:col-span-1 h-[400px] lg:h-auto">
                            {/* FIX: Use activeSocialEmployees so staff can see colleagues' birthdays */}
                            <BirthdayWidget employees={activeSocialEmployees} />
                        </div>

                        {/* Removed Announcements Card as requested */}

                        <div className="bg-slate-900 rounded-2xl border border-slate-800 shadow-lg overflow-hidden flex flex-col h-full lg:col-span-2">
                            <div className="p-5 border-b border-slate-800 flex justify-between items-center bg-slate-900/80">
                                <div className="flex items-center gap-3">
                                    <div className="p-2 bg-blue-500/10 rounded-lg text-blue-400"><i className="fas fa-list-ul"></i></div>
                                    <h3 className="text-lg font-bold text-white">My Request Tracker</h3>
                                </div>
                                <button onClick={() => setActivePage('checkinme')} className="text-xs font-bold text-blue-400 hover:text-blue-300">VIEW ALL</button>
                            </div>
                            <div className="flex-1 overflow-hidden">
                                {myRecentRequests.length === 0 ? (
                                    <p className="text-slate-500 text-sm text-center py-10">No recent requests found.</p>
                                ) : (
                                    <div className="divide-y divide-slate-800/50">
                                        {myRecentRequests.map((req, idx) => (
                                            <div key={idx} className="p-4 flex justify-between items-center hover:bg-slate-800/30 transition-colors">
                                                <div>
                                                    <div className="flex items-center gap-2 mb-1">
                                                        <span className={`text-xs font-bold px-2 py-0.5 rounded-md ${req.type === 'Leave' ? 'bg-pink-500/10 text-pink-400' : 'bg-purple-500/10 text-purple-400'}`}>{req.type}</span>
                                                        <span className="text-sm font-semibold text-slate-200">{req.type === 'Leave' ? `${req.numberOfDays} Day(s)` : `${req.numberOfOTDays} Day(s)`}</span>
                                                    </div>
                                                    <p className="text-xs text-slate-500">Submitted: {Utils.formatRequestDate(req.requestDate || req.submissionDate)}</p>
                                                </div>
                                                <div>
                                                    <span className={`px-3 py-1 text-xs font-bold rounded-full border ${
                                                        req.status === 'Approved' ? 'bg-green-500/10 text-green-400 border-green-500/20' :
                                                        req.status === 'Rejected' ? 'bg-red-500/10 text-red-400 border-red-500/20' :
                                                        'bg-yellow-500/10 text-yellow-400 border-yellow-500/20'
                                                    }`}>{req.status}</span>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                )}
                            </div>
                        </div>
                    </div>
                </div>
            );
        };
        // --- END DASHBOARD SUMMARY PAGE ---

        // --- START POLICY BOARD PAGE ---
        
        // NEW: Modal for Creating/Editing Policies
        const PolicyModal = ({ isOpen, onClose, onSave, policy }) => {
            const [formData, setFormData] = useState({ title: '', category: 'General', content: '' });
            
            useEffect(() => {
                if (isOpen) {
                    setFormData(policy ? { ...policy } : { title: '', category: 'General', content: '' });
                }
            }, [isOpen, policy]);

            const handleChange = (e) => {
                const { name, value } = e.target;
                setFormData(prev => ({ ...prev, [name]: value }));
            };

            const handleSubmit = (e) => {
                e.preventDefault();
                onSave(formData);
            };

            return (
                <Modal isOpen={isOpen} onClose={onClose} maxWidth="max-w-3xl">
                    <form onSubmit={handleSubmit} className="flex flex-col h-full overflow-hidden">
                        <ModalHeader title={policy ? "Edit Policy" : "New Policy"} onClose={onClose} />
                        <ModalBody>
                            <div className="space-y-4">
                                <div>
                                    <label className="text-sm font-medium text-slate-400">Title</label>
                                    <input name="title" value={formData.title} onChange={handleChange} className="input" required placeholder="e.g., Dress Code Policy" />
                                </div>
                                <div>
                                    <label className="text-sm font-medium text-slate-400">Category</label>
                                    <select name="category" value={formData.category} onChange={handleChange} className="select">
                                        <option>General</option>
                                        <option>HR</option>
                                        <option>IT & Security</option>
                                        <option>Safety</option>
                                        <option>Finance</option>
                                        <option>Operations</option>
                                    </select>
                                </div>
                                <div className="flex-1">
                                    <label className="text-sm font-medium text-slate-400 mb-2 block">Content (HTML Supported)</label>
                                    <textarea 
                                        name="content" 
                                        value={formData.content} 
                                        onChange={handleChange} 
                                        className="input h-64 font-mono text-sm leading-relaxed" 
                                        required
                                        placeholder="<p>Enter policy details here...</p>"
                                    ></textarea>
                                </div>
                            </div>
                        </ModalBody>
                        <ModalFooter>
                            <Button variant="secondary" onClick={onClose}>Cancel</Button>
                            <Button type="submit" variant="primary">Save Policy</Button>
                        </ModalFooter>
                    </form>
                </Modal>
            );
        };

        // NEW: Modal for Reading Policies
        // MODIFIED: Added onRead prop and effect to trigger read status
        const PolicyReadModal = ({ isOpen, onClose, policy, onRead }) => {
            
            useEffect(() => {
                if (isOpen && policy && onRead) {
                    onRead(policy);
                }
            }, [isOpen, policy]);

            if (!policy) return null;
            return (
                <Modal isOpen={isOpen} onClose={onClose} maxWidth="max-w-4xl">
                    <div className="flex flex-col h-[85vh]">
                        <div className="p-6 border-b border-slate-700 bg-slate-800 shrink-0 flex justify-between items-start">
                            <div>
                                <span className="inline-block px-2 py-1 mb-2 text-xs font-bold text-blue-300 bg-blue-900/50 rounded uppercase tracking-wider">
                                    {policy.category || 'General'}
                                </span>
                                <h2 className="text-2xl font-bold text-white leading-tight">{policy.title}</h2>
                            </div>
                            <button onClick={onClose} className="text-slate-400 hover:text-white transition-colors">
                                <i className="fas fa-times text-2xl"></i>
                            </button>
                        </div>
                        <div className="p-8 overflow-y-auto bg-slate-900/50 flex-1">
                            <div 
                                className="policy-content prose prose-invert max-w-none text-slate-300 leading-7"
                                dangerouslySetInnerHTML={{ __html: DOMPurify.sanitize(policy.content) }}
                            />
                        </div>
                        <div className="p-4 bg-slate-800 border-t border-slate-700 shrink-0 text-xs text-slate-500 flex justify-between items-center">
                            <span>Last Updated: {policy.updatedAt?.toDate ? policy.updatedAt.toDate().toLocaleDateString() : 'N/A'}</span>
                            <Button variant="primary" onClick={onClose} className="px-6">Close</Button>
                        </div>
                    </div>
                </Modal>
            );
        };

        // --- NEW COMPONENT: Read Stats Modal (For Notice Board Admin) ---
        const ReadStatsModal = ({ isOpen, onClose, notice }) => {
            const { employees } = useAppData();
            
            const stats = useMemo(() => {
                if (!notice || !employees) return { read: [], unread: [], percent: 0 };

                // 1. Determine Target Audience based on notice.targetShops
                const targetAudience = employees.filter(emp => {
                    if (emp.status !== 'Active') return false;
                    // If no target shops, it's global (all active staff)
                    if (!notice.targetShops || notice.targetShops.length === 0) return true;
                    
                    const empShops = Array.isArray(emp.shop) ? emp.shop : [emp.shop];
                    // Check intersection: Does employee work in ANY of the target shops?
                    return empShops.some(s => notice.targetShops.includes(s));
                });

                // 2. Split into Read vs Unread
                const readIds = new Set(notice.readBy || []);
                const read = [];
                const unread = [];

                targetAudience.forEach(emp => {
                    if (readIds.has(emp.id)) {
                        read.push(emp);
                    } else {
                        unread.push(emp);
                    }
                });

                const percent = targetAudience.length > 0 ? Math.round((read.length / targetAudience.length) * 100) : 0;

                return { read, unread, percent, total: targetAudience.length };
            }, [notice, employees]);

            if (!isOpen || !notice) return null;

            return (
                <Modal isOpen={isOpen} onClose={onClose} maxWidth="max-w-3xl">
                    <ModalHeader title="Engagement Statistics" onClose={onClose} />
                    <ModalBody>
                        <div className="mb-6 p-4 bg-slate-700/30 rounded-xl border border-slate-600/50">
                            <h3 className="text-lg font-bold text-white mb-2">{notice.title}</h3>
                            <div className="flex justify-between items-end mb-2">
                                <p className="text-xs text-slate-400 uppercase font-bold tracking-wider">Read Completion</p>
                                <span className="text-xl font-bold text-white">{stats.percent}% <span className="text-sm text-slate-500 font-normal">({stats.read.length}/{stats.total})</span></span>
                            </div>
                            <div className="w-full bg-slate-700 rounded-full h-3 overflow-hidden">
                                <div className="bg-gradient-to-r from-green-500 to-emerald-400 h-full transition-all duration-1000 ease-out" style={{ width: `${stats.percent}%` }}></div>
                            </div>
                        </div>

                        <div className="grid grid-cols-1 sm:grid-cols-2 gap-4 h-[400px]">
                            {/* Read Column */}
                            <div className="bg-slate-900/50 rounded-xl border border-green-900/30 flex flex-col overflow-hidden">
                                <div className="p-3 bg-green-900/20 border-b border-green-900/30 flex justify-between items-center">
                                    <span className="text-green-400 font-bold text-xs uppercase"><i className="fas fa-check-circle mr-2"></i>Read ({stats.read.length})</span>
                                </div>
                                <div className="p-2 overflow-y-auto custom-scrollbar flex-1 space-y-1">
                                    {stats.read.map(emp => (
                                        <div key={emp.id} className="flex items-center gap-3 p-2 rounded hover:bg-slate-800/50 transition-colors">
                                            <div className="w-8 h-8 rounded-full bg-green-500/20 text-green-400 flex items-center justify-center text-xs font-bold border border-green-500/30">
                                                {emp.name.charAt(0)}
                                            </div>
                                            <div>
                                                <p className="text-xs text-slate-200 font-bold">{emp.name}</p>
                                                <p className="text-[10px] text-slate-500">{Array.isArray(emp.shop) ? emp.shop[0] : emp.shop}</p>
                                            </div>
                                        </div>
                                    ))}
                                    {stats.read.length === 0 && <p className="text-center text-xs text-slate-600 py-10 italic">No one has read this yet.</p>}
                                </div>
                            </div>

                            {/* Unread Column */}
                            <div className="bg-slate-900/50 rounded-xl border border-red-900/30 flex flex-col overflow-hidden">
                                <div className="p-3 bg-red-900/20 border-b border-red-900/30 flex justify-between items-center">
                                    <span className="text-red-400 font-bold text-xs uppercase"><i className="fas fa-times-circle mr-2"></i>Pending ({stats.unread.length})</span>
                                </div>
                                <div className="p-2 overflow-y-auto custom-scrollbar flex-1 space-y-1">
                                    {stats.unread.map(emp => (
                                        <div key={emp.id} className="flex items-center gap-3 p-2 rounded hover:bg-slate-800/50 transition-colors">
                                            <div className="w-8 h-8 rounded-full bg-red-500/20 text-red-400 flex items-center justify-center text-xs font-bold border border-red-500/30">
                                                {emp.name.charAt(0)}
                                            </div>
                                            <div>
                                                <p className="text-xs text-slate-200 font-bold">{emp.name}</p>
                                                <p className="text-[10px] text-slate-500">{Array.isArray(emp.shop) ? emp.shop[0] : emp.shop}</p>
                                            </div>
                                        </div>
                                    ))}
                                    {stats.unread.length === 0 && <p className="text-center text-xs text-slate-600 py-10 italic">All caught up!</p>}
                                </div>
                            </div>
                        </div>
                    </ModalBody>
                    <ModalFooter>
                        <Button variant="secondary" onClick={onClose}>Close</Button>
                    </ModalFooter>
                </Modal>
            );
        };

        // REDESIGNED: Policy Board Tab (Renamed from Page)
        const PolicyBoardTab = ({ userProfile }) => {
            const { db } = useFirebase();
            const { data: policies, loading } = useCollection('policies');
            // MODIFIED: Imported needed functions
            const { doc, updateDoc, arrayUnion } = window.firebaseSDK;
            
            const [searchTerm, setSearchTerm] = useState('');
            const [isModalOpen, setModalOpen] = useState(false);
            const [editingPolicy, setEditingPolicy] = useState(null);
            const [policyToDelete, setPolicyToDelete] = useState(null);
            const [policyToRead, setPolicyToRead] = useState(null); 
            // MODIFIED: Added state for stats modal
            const [statsPolicy, setStatsPolicy] = useState(null);

            const isAdmin = userProfile?.role === 'Admin' || userProfile?.role === 'CEO';

            const categorizedPolicies = useMemo(() => {
                const filtered = policies.filter(p =>
                    (p.title?.toLowerCase() || '').includes(searchTerm.toLowerCase()) ||
                    (p.content?.toLowerCase() || '').includes(searchTerm.toLowerCase())
                );

                const grouped = filtered.reduce((acc, policy) => {
                    const category = policy.category || 'General';
                    if (!acc[category]) {
                        acc[category] = [];
                    }
                    acc[category].push(policy);
                    return acc;
                }, {});

                for (const category in grouped) {
                    grouped[category].sort((a, b) => a.title.localeCompare(b.title));
                }
                return grouped;
            }, [policies, searchTerm]);

            const sortedCategories = useMemo(() => Object.keys(categorizedPolicies).sort(), [categorizedPolicies]);

            const handleOpenModal = useCallback((policy = null) => { setEditingPolicy(policy); setModalOpen(true); }, []);
            const handleCloseModal = useCallback(() => { setEditingPolicy(null); setModalOpen(false); }, []);
            
            const handleReadPolicy = useCallback((policy) => { setPolicyToRead(policy); }, []);
            const handleCloseReadModal = useCallback(() => { setPolicyToRead(null); }, []);

            // NEW: Function to mark policy as read in Firestore
            const handleMarkAsRead = useCallback(async (policy) => {
                if (!userProfile?.id || !policy?.id) return;
                // Optimization: Don't write if already in the list
                if (policy.readBy && policy.readBy.includes(userProfile.id)) return;

                try {
                    const policyRef = doc(db, 'policies', policy.id);
                    await updateDoc(policyRef, {
                        readBy: arrayUnion(userProfile.id)
                    });
                } catch (error) {
                    console.error("Error marking policy as read:", error);
                }
            }, [db, userProfile]);

            const handleSavePolicy = useCallback(async (policyData) => {
                const { addDoc, updateDoc, doc, collection, serverTimestamp } = window.firebaseSDK;
                const dataToSave = { ...policyData };
                try {
                    if (dataToSave.id) {
                        const { id, ...data } = dataToSave;
                        await updateDoc(doc(db, 'policies', id), { ...data, updatedAt: serverTimestamp() });
                    } else {
                        await addDoc(collection(db, 'policies'), { ...dataToSave, createdAt: serverTimestamp(), updatedAt: serverTimestamp(), readBy: [] }); // Initialize readBy
                    }
                    handleCloseModal();
                } catch (error) {
                    console.error("Error saving policy:", error);
                }
            }, [db, handleCloseModal]);

            const handleDeleteConfirm = useCallback(async () => {
                if (!policyToDelete) return;
                try {
                    await window.firebaseSDK.deleteDoc(window.firebaseSDK.doc(db, 'policies', policyToDelete.id));
                } catch (error) {
                    console.error("Error deleting policy:", error);
                } finally {
                    setPolicyToDelete(null);
                }
            }, [db, policyToDelete]);

            return (
                <div className="space-y-8 animate-fade-in pb-12">
                    {/* Hero Section */}
                    <div className="relative overflow-hidden rounded-3xl bg-gradient-to-r from-slate-800 to-slate-900 border border-slate-700 p-8 flex flex-col md:flex-row items-center justify-between shadow-2xl">
                        <div className="z-10 max-w-2xl relative">
                            <div className="inline-flex items-center gap-2 px-3 py-1 rounded-full bg-blue-500/10 border border-blue-500/20 text-blue-300 text-xs font-bold uppercase tracking-wider mb-3">
                                <i className="fas fa-book"></i> Knowledge Base
                            </div>
                            <h1 className="text-3xl md:text-4xl font-bold text-white mb-2 tracking-tight">Policy Reading Center</h1>
                            <p className="text-slate-400 text-lg leading-relaxed">Stay informed about our company guidelines, protocols, and employee handbooks.</p>
                        </div>
                        <div className="mt-6 md:mt-0 z-10 flex gap-3 w-full md:w-auto items-center">
                                <div className="relative w-full md:w-64">
                                <i className="fas fa-search absolute left-4 top-3.5 text-slate-500"></i>
                                <input 
                                    type="text" 
                                    placeholder="Search policies..." 
                                    value={searchTerm} 
                                    onChange={e => setSearchTerm(e.target.value)} 
                                    className="w-full bg-slate-950/50 border border-slate-700 text-slate-200 text-sm rounded-xl focus:ring-blue-500 focus:border-blue-500 block pl-10 p-3 shadow-inner transition-all placeholder-slate-500" 
                                />
                            </div>
                            {isAdmin && (
                                <button onClick={() => handleOpenModal()} className="bg-blue-600 hover:bg-blue-500 text-white w-11 h-11 rounded-xl shadow-lg transition-transform active:scale-95 flex items-center justify-center shrink-0 border border-blue-500/50" title="Add New Policy">
                                    <i className="fas fa-plus text-lg"></i>
                                </button>
                            )}
                        </div>
                        {/* Decor */}
                        <div className="absolute top-0 right-0 -mr-16 -mt-16 w-64 h-64 bg-blue-500/10 rounded-full blur-3xl"></div>
                        <div className="absolute bottom-0 left-0 -ml-16 -mb-16 w-48 h-48 bg-purple-500/10 rounded-full blur-3xl"></div>
                    </div>

                    {loading ? (
                        <div className="text-center py-20"><i className="fas fa-spinner fa-spin text-4xl text-blue-500"></i><p className="mt-4 text-slate-500">Loading Library...</p></div>
                    ) : (
                        <div className="space-y-12">
                            {sortedCategories.length > 0 ? sortedCategories.map(category => (
                                <div key={category} className="animate-fade-in">
                                    <div className="flex items-center gap-4 mb-6">
                                        <div className="w-1 h-6 bg-blue-500 rounded-full"></div>
                                        <h3 className="text-xl font-bold text-slate-200 uppercase tracking-widest">{category}</h3>
                                        <div className="h-px flex-1 bg-slate-800"></div>
                                    </div>
                                    
                                    <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                                        {categorizedPolicies[category].map(policy => {
                                            // Check read status
                                            const isRead = (policy.readBy || []).includes(userProfile.id);

                                            return (
                                            <div 
                                                    key={policy.id} 
                                                    onClick={() => handleReadPolicy(policy)}
                                                    className="group relative bg-slate-800/60 rounded-2xl p-6 border border-slate-700/50 hover:border-blue-500/30 hover:bg-slate-800 transition-all duration-300 cursor-pointer shadow-lg hover:shadow-blue-900/10 hover:-translate-y-1 flex flex-col h-full overflow-hidden"
                                            >
                                                    {/* Top Decoration Line */}
                                                    <div className="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-blue-500/0 via-blue-500/50 to-blue-500/0 opacity-0 group-hover:opacity-100 transition-opacity"></div>

                                                    {/* Icon / Actions Header */}
                                                    <div className="flex items-start justify-between mb-5">
                                                        <div className="w-12 h-12 rounded-xl bg-slate-700/50 group-hover:bg-blue-600/10 border border-white/5 group-hover:border-blue-500/20 flex items-center justify-center transition-all duration-300">
                                                            <i className={`fas ${isRead ? 'fa-check text-green-400' : 'fa-book-open text-slate-400'} text-xl group-hover:text-blue-400 transition-colors`}></i>
                                                        </div>
                                                        {isAdmin && (
                                                            <div className="flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity duration-200 bg-slate-900/80 rounded-lg p-1 border border-slate-700" onClick={e => e.stopPropagation()}>
                                                                    {/* NEW: Stats Button */}
                                                                    <button onClick={() => setStatsPolicy(policy)} className="w-8 h-8 flex items-center justify-center rounded-md text-slate-400 hover:text-green-400 hover:bg-slate-800 transition-colors" title="View Read Stats"><i className="fas fa-chart-pie text-xs"></i></button>
                                                                    
                                                                    <button onClick={() => handleOpenModal(policy)} className="w-8 h-8 flex items-center justify-center rounded-md text-slate-400 hover:text-blue-400 hover:bg-slate-800 transition-colors"><i className="fas fa-pen text-xs"></i></button>
                                                                    <button onClick={() => setPolicyToDelete(policy)} className="w-8 h-8 flex items-center justify-center rounded-md text-slate-400 hover:text-red-400 hover:bg-slate-800 transition-colors"><i className="fas fa-trash text-xs"></i></button>
                                                            </div>
                                                        )}
                                                    </div>
                                                    
                                                    {/* Content Snippet */}
                                                    <div className="flex-1">
                                                        <h4 className="text-lg font-bold text-slate-100 mb-2 line-clamp-2 leading-snug group-hover:text-blue-300 transition-colors">
                                                                {policy.title}
                                                        </h4>
                                                        <p className="text-sm text-slate-400 line-clamp-3 leading-relaxed mb-4 font-light">
                                                                {/* Strip HTML tags for clean preview text */}
                                                                {policy.content.replace(/<[^>]+>/g, '').substring(0, 120)}...
                                                        </p>
                                                    </div>

                                                    {/* Footer Meta */}
                                                    <div className="pt-4 border-t border-slate-700/50 flex justify-between items-center text-[11px] text-slate-500 font-medium uppercase tracking-wide">
                                                        <span>{new Date(policy.updatedAt?.toDate() || Date.now()).toLocaleDateString(undefined, {month: 'short', day: 'numeric'})}</span>
                                                        <span className={`group-hover:translate-x-1 transition-transform flex items-center gap-1 ${isRead ? 'text-green-500' : 'text-blue-500/80 group-hover:text-blue-400'}`}>
                                                                {isRead ? 'Read ✓' : <>Read <i className="fas fa-arrow-right text-[10px]"></i></>}
                                                        </span>
                                                    </div>
                                            </div>
                                        );
                                        })}
                                    </div>
                                </div>
                            )) : (
                                <div className="text-center py-32 opacity-50">
                                    <div className="inline-flex items-center justify-center w-24 h-24 rounded-full bg-slate-800 mb-6">
                                        <i className="fas fa-search text-4xl text-slate-600"></i>
                                    </div>
                                    <h3 className="text-2xl font-bold text-slate-300 mb-2">No policies found</h3>
                                    <p className="text-slate-500">Try adjusting your search terms or category.</p>
                                </div>
                            )}
                        </div>
                    )}
                    <PolicyModal isOpen={isModalOpen} onClose={handleCloseModal} onSave={handleSavePolicy} policy={editingPolicy} />
                    <ConfirmationModal isOpen={!!policyToDelete} onClose={() => setPolicyToDelete(null)} onConfirm={handleDeleteConfirm} title="Delete Policy" message={`Are you sure you want to delete the policy "${policyToDelete?.title}"? This action cannot be undone.`} />
                    {/* MODIFIED: Pass handleMarkAsRead to the read modal */}
                    <PolicyReadModal isOpen={!!policyToRead} onClose={handleCloseReadModal} policy={policyToRead} onRead={handleMarkAsRead} />
                    
                    {/* NEW: Stats Modal for Policies */}
                    <ReadStatsModal 
                        isOpen={!!statsPolicy} 
                        onClose={() => setStatsPolicy(null)} 
                        notice={statsPolicy} 
                    />
                </div>
            );
        };
        // --- END POLICY BOARD PAGE ---

        // --- START NOTICE BOARD PAGE (PHASE 1) (Renamed to Tab) ---
        
        // NEW: Component for Individual Notice Card with Like/Comment Support
        const NoticeCard = ({ notice, userProfile, canManage, onEdit, onDelete, onMarkRead, onViewStats }) => {
            const { db } = useFirebase();
            const { doc, updateDoc, arrayUnion, arrayRemove, collection, addDoc, serverTimestamp, query, orderBy, onSnapshot } = window.firebaseSDK;
            
            const [showComments, setShowComments] = useState(false);
            const [comments, setComments] = useState([]);
            const [newComment, setNewComment] = useState('');
            const [isSubmittingComment, setIsSubmittingComment] = useState(false);

            const isLiked = (notice.likes || []).includes(userProfile.id);
            const likeCount = (notice.likes || []).length;
            const isRead = (notice.readBy || []).includes(userProfile.id);

            // Fetch comments real-time ONLY when section is open
            useEffect(() => {
                let unsubscribe = () => {};
                if (showComments && notice.id) {
                    const q = query(collection(db, 'memoAlerts', notice.id, 'comments'), orderBy('createdAt', 'asc'));
                    unsubscribe = onSnapshot(q, (snapshot) => {
                        setComments(snapshot.docs.map(d => ({ id: d.id, ...d.data() })));
                    });
                }
                return () => unsubscribe();
            }, [showComments, notice.id, db]);

            const handleToggleLike = async () => {
                try {
                    const ref = doc(db, 'memoAlerts', notice.id);
                    if (isLiked) {
                        await updateDoc(ref, { likes: arrayRemove(userProfile.id) });
                    } else {
                        await updateDoc(ref, { likes: arrayUnion(userProfile.id) });
                    }
                } catch (err) {
                    console.error("Like error:", err);
                }
            };

            const handleAddComment = async (e) => {
                e.preventDefault();
                if (!newComment.trim()) return;
                setIsSubmittingComment(true);
                try {
                    await addDoc(collection(db, 'memoAlerts', notice.id, 'comments'), {
                        text: newComment,
                        userId: userProfile.id,
                        userName: userProfile.name,
                        createdAt: serverTimestamp()
                    });
                    setNewComment('');
                } catch (err) {
                    console.error("Comment error:", err);
                } finally {
                    setIsSubmittingComment(false);
                }
            };
            
            const formatCommentTime = (timestamp) => {
                if (!timestamp) return 'Just now';
                const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
                return date.toLocaleString('en-US', { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
            };

            return (
                <div className={`rounded-xl border shadow-lg overflow-hidden transition-all duration-300 flex flex-col ${
                    isRead && !canManage
                        ? 'bg-slate-800 border-slate-700 opacity-90' 
                        : 'bg-slate-800 border-yellow-500/50 shadow-yellow-900/20 ring-1 ring-yellow-500/20'
                }`}>
                    <div className="p-5 flex-1">
                        {/* Header */}
                        <div className="flex justify-between items-start mb-3">
                            <div>
                                <div className="flex items-center gap-2 mb-1">
                                    <h3 className="text-lg font-bold text-white">{notice.title}</h3>
                                    {!isRead && !canManage && (
                                        <span className="bg-yellow-500 text-slate-900 text-[10px] font-bold px-2 py-0.5 rounded-full animate-pulse">NEW</span>
                                    )}
                                    {notice.status === 'Inactive' && (
                                        <span className="bg-red-500/20 text-red-400 text-[10px] font-bold px-2 py-0.5 rounded-full border border-red-500/30">Inactive</span>
                                    )}
                                </div>
                                <p className="text-xs text-slate-500">
                                    <i className="fas fa-calendar mr-1"></i> 
                                    {notice.createdAt?.toDate ? notice.createdAt.toDate().toLocaleDateString() : 'Just now'}
                                    <span className="mx-2">•</span>
                                    By {notice.authorName || 'Admin'}
                                </p>
                            </div>
                            
                            {/* Target Badge */}
                            {notice.targetShops && notice.targetShops.length > 0 ? (
                                <span className="px-2 py-1 bg-slate-700 text-[10px] rounded text-slate-300 border border-slate-600">
                                    {notice.targetShops.length > 2 ? `${notice.targetShops.length} Shops` : notice.targetShops.join(', ')}
                                </span>
                            ) : (
                                <span className="px-2 py-1 bg-blue-900/30 text-[10px] rounded text-blue-300 border border-blue-800/50">
                                    Global
                                </span>
                            )}
                        </div>
                        
                        <div className="prose prose-invert prose-sm max-w-none mb-4">
                            <p className="text-slate-300 whitespace-pre-wrap leading-relaxed">{notice.content}</p>
                        </div>
                    </div>
                    
                    {/* Action Footer */}
                    <div className="px-5 py-3 bg-slate-900/50 border-t border-slate-700/50 flex flex-col gap-3">
                        <div className="flex justify-between items-center">
                            {/* Social Buttons */}
                            <div className="flex items-center gap-4">
                                <button 
                                    onClick={handleToggleLike}
                                    className={`flex items-center gap-1.5 text-sm font-bold transition-colors ${isLiked ? 'text-pink-500' : 'text-slate-400 hover:text-pink-400'}`}
                                >
                                    <i className={`${isLiked ? 'fas' : 'far'} fa-heart`}></i> {likeCount > 0 && likeCount}
                                </button>
                                <button 
                                    onClick={() => setShowComments(!showComments)}
                                    className={`flex items-center gap-1.5 text-sm font-bold transition-colors ${showComments ? 'text-blue-400' : 'text-slate-400 hover:text-blue-400'}`}
                                >
                                    <i className="far fa-comment-alt"></i> Comment
                                </button>
                            </div>

                            {/* Management / Acknowledge Buttons */}
                            <div className="flex items-center gap-3">
                                {canManage ? (
                                    <>
                                        <Button variant="secondary" onClick={() => onViewStats(notice)} className="text-xs py-1 px-2 h-8" title="View Stats">
                                            <i className="fas fa-chart-pie mr-1"></i> {(notice.readBy || []).length}
                                        </Button>
                                        <div className="h-4 w-px bg-slate-700 mx-1"></div>
                                        <button onClick={() => onEdit(notice)} className="text-blue-400 hover:text-white transition-colors p-1"><i className="fas fa-edit"></i></button>
                                        <button onClick={() => onDelete(notice)} className="text-red-400 hover:text-white transition-colors p-1"><i className="fas fa-trash"></i></button>
                                    </>
                                ) : (
                                    !isRead ? (
                                        <Button variant="primary" onClick={() => onMarkRead(notice)} className="text-xs py-1 px-4 bg-yellow-600 hover:bg-yellow-500 text-white shadow-lg shadow-yellow-900/20 h-auto animate-pulse">
                                            <i className="fas fa-check-double mr-1"></i> Acknowledge
                                        </Button>
                                    ) : (
                                        <span className="text-xs font-bold text-green-500 flex items-center gap-1 bg-green-900/20 px-3 py-1 rounded-full border border-green-900/30">
                                            <i className="fas fa-check-circle"></i> Read
                                        </span>
                                    )
                                )}
                            </div>
                        </div>

                        {/* Comments Section */}
                        {showComments && (
                            <div className="mt-2 pt-3 border-t border-slate-700/50 animate-fade-in">
                                <div className="space-y-3 mb-3 max-h-48 overflow-y-auto custom-scrollbar pr-1">
                                    {comments.length === 0 && <p className="text-xs text-slate-500 italic">No comments yet. Be the first!</p>}
                                    {comments.map(comment => (
                                        <div key={comment.id} className="flex gap-2">
                                            <div className="w-6 h-6 rounded-full bg-slate-700 flex items-center justify-center text-[10px] font-bold text-slate-300 shrink-0">
                                                {comment.userName ? comment.userName.charAt(0) : '?'}
                                            </div>
                                            <div className="bg-slate-800/80 rounded-lg rounded-tl-none p-2 text-xs text-slate-300 flex-1">
                                                <div className="flex justify-between items-baseline mb-0.5">
                                                    <span className="font-bold text-slate-200">{comment.userName}</span>
                                                    <span className="text-[10px] text-slate-600">{formatCommentTime(comment.createdAt)}</span>
                                                </div>
                                                <p>{comment.text}</p>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                                <form onSubmit={handleAddComment} className="flex gap-2">
                                    <input 
                                        type="text" 
                                        value={newComment}
                                        onChange={(e) => setNewComment(e.target.value)}
                                        // FIX: Changed text-xs to text-base sm:text-sm. 
                                        // Browsers auto-zoom on inputs < 16px on mobile. text-base ensures it stays at 100% scale.
                                        className="input text-base sm:text-sm py-2" 
                                        placeholder="Write a comment..." 
                                        disabled={isSubmittingComment}
                                    />
                                    <button 
                                        type="submit" 
                                        disabled={!newComment.trim() || isSubmittingComment}
                                        className="bg-blue-600 hover:bg-blue-500 text-white rounded-lg px-3 py-1 disabled:opacity-50 disabled:cursor-not-allowed"
                                    >
                                        <i className="fas fa-paper-plane text-xs"></i>
                                    </button>
                                </form>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        // UPDATED: Added Memo Management (Create/Edit/Delete) directly here
        const NoticeBoardTab = ({ userProfile }) => {
            const { db } = useFirebase();
            const { collection, query, where, onSnapshot, orderBy, doc, updateDoc, arrayUnion, addDoc, serverTimestamp, deleteDoc } = window.firebaseSDK;
            const { employees } = useAppData(); 
            
            const [notices, setNotices] = useState([]);
            const [loading, setLoading] = useState(true);
            
            // Stats Modal State
            const [statsNotice, setStatsNotice] = useState(null);
            
            // Management States (New)
            const [isCreateModalOpen, setIsCreateModalOpen] = useState(false);
            const [editingMemo, setEditingMemo] = useState(null);
            const [memoToDelete, setMemoToDelete] = useState(null);

            useEffect(() => {
                if (!db || !userProfile) return;
                setLoading(true);

                // Fetch all memos ordered by creation time
                const q = query(collection(db, 'memoAlerts'), orderBy('createdAt', 'desc'));
                
                const unsubscribe = onSnapshot(q, (snapshot) => {
                    const allNotices = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    
                    // Filter relevant notices in JavaScript
                    const visibleNotices = allNotices.filter(n => {
                        // Admin/CEO/Manager sees everything so they can manage them
                        if (userProfile.role !== 'Staff') return true;

                        // Staff: Only show Active
                        if (n.status !== 'Active') return false;

                        // Staff: Shop Targeting Check
                        if (!n.targetShops || n.targetShops.length === 0) return true;
                        
                        const userShops = Array.isArray(userProfile.shop) ? userProfile.shop : [userProfile.shop];
                        return userShops.some(s => n.targetShops.includes(s));
                    });

                    setNotices(visibleNotices);
                    setLoading(false);
                }, (error) => {
                    console.error("Error fetching notices:", error);
                    setLoading(false);
                });

                return () => unsubscribe();
            }, [db, userProfile]);

            // Handler: Mark as Read
            const handleMarkAsRead = async (notice) => {
                if (!userProfile?.id) return;
                try {
                    const noticeRef = doc(db, 'memoAlerts', notice.id);
                    await updateDoc(noticeRef, {
                        readBy: arrayUnion(userProfile.id)
                    });
                } catch (error) {
                    console.error("Error marking notice as read:", error);
                    alert("Failed to acknowledge. Please try again.");
                }
            };

            // NEW: Handler to Save Memo (Create/Update)
            const handleSaveMemo = async (formData) => {
                const { id, ...dataToSave } = formData;
                // Add author info if new
                if (!id) {
                    dataToSave.authorId = userProfile.id;
                    dataToSave.authorName = userProfile.name;
                    dataToSave.readBy = []; // Reset read stats for new memo
                    dataToSave.likes = []; // Initialize likes
                }

                try {
                    if (id) {
                        await updateDoc(doc(db, 'memoAlerts', id), { ...dataToSave, updatedAt: serverTimestamp() });
                    } else {
                        await addDoc(collection(db, 'memoAlerts'), { ...dataToSave, createdAt: serverTimestamp() });
                    }
                    setIsCreateModalOpen(false);
                    setEditingMemo(null);
                } catch (error) {
                    console.error("Error saving memo:", error);
                    alert("Failed to save memo.");
                }
            };

            // NEW: Handler to Delete Memo
            const handleDeleteMemo = async () => {
                if (!memoToDelete) return;
                try {
                    await deleteDoc(doc(db, 'memoAlerts', memoToDelete.id));
                    setMemoToDelete(null);
                } catch (error) {
                    console.error("Error deleting memo:", error);
                    alert("Failed to delete memo.");
                }
            };

            const canManage = userProfile.role === 'Admin' || userProfile.role === 'CEO' || userProfile.role === 'Shop Manager';

            return (
                <div className="space-y-6 animate-fade-in pb-10">
                    <PageHeader title="Company Notice Board">
                        <div className="flex items-center gap-3">
                            <span className="text-xs text-slate-500 hidden sm:inline">
                                <i className="fas fa-info-circle mr-1"></i> Announcements & Updates
                            </span>
                            {/* NEW: Add Memo Button as Icon Logo */}
                            {canManage && (
                                <button 
                                    onClick={() => { setEditingMemo(null); setIsCreateModalOpen(true); }}
                                    className="bg-yellow-500 hover:bg-yellow-400 text-slate-900 w-8 h-8 rounded-full flex items-center justify-center shadow-lg transition-transform hover:scale-110"
                                    title="Add New Memo"
                                >
                                    <i className="fas fa-plus text-sm font-bold"></i>
                                </button>
                            )}
                        </div>
                    </PageHeader>

                    {loading ? (
                        <div className="text-center py-20"><i className="fas fa-spinner fa-spin text-3xl text-blue-500"></i></div>
                    ) : (
                        <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            {notices.length === 0 ? (
                                <div className="col-span-full text-center py-20 opacity-50 bg-slate-800/50 rounded-xl border border-slate-700 border-dashed">
                                    <i className="fas fa-bullhorn text-4xl text-slate-600 mb-4"></i>
                                    <p className="text-lg text-slate-300">No notices at this time.</p>
                                    {canManage && <p className="text-sm text-slate-500 mt-2">Click the + button to create one.</p>}
                                </div>
                            ) : (
                                notices.map(notice => (
                                    <NoticeCard 
                                        key={notice.id}
                                        notice={notice}
                                        userProfile={userProfile}
                                        canManage={canManage}
                                        onEdit={() => { setEditingMemo(notice); setIsCreateModalOpen(true); }}
                                        onDelete={() => setMemoToDelete(notice)}
                                        onMarkRead={() => handleMarkAsRead(notice)}
                                        onViewStats={() => setStatsNotice(notice)}
                                    />
                                ))
                            )}
                        </div>
                    )}
                    
                    {/* Modals */}
                    <ReadStatsModal 
                        isOpen={!!statsNotice} 
                        onClose={() => setStatsNotice(null)} 
                        notice={statsNotice} 
                    />
                    
                    <MemoAlertModal 
                        isOpen={isCreateModalOpen} 
                        onClose={() => { setIsCreateModalOpen(false); setEditingMemo(null); }} 
                        onSave={handleSaveMemo} 
                        memo={editingMemo} 
                    />

                    <ConfirmationModal 
                        isOpen={!!memoToDelete} 
                        onClose={() => setMemoToDelete(null)} 
                        onConfirm={handleDeleteMemo} 
                        title="Delete Memo" 
                        message={`Are you sure you want to delete "${memoToDelete?.title}"?`} 
                    />
                </div>
            );
        };
        
        // --- NEW: MERGED PAGE (CompanyHubPage) ---
        const CompanyHubPage = ({ userProfile }) => {
            const [activeTab, setActiveTab] = useState('notices');

            const tabs = {
                notices: <span><i className="fas fa-bullhorn mr-2 text-yellow-500"></i>Notices</span>,
                policies: <span><i className="fas fa-scale-balanced mr-2 text-blue-400"></i>Policies</span>
            };

            return (
                <TabbedPage tabs={tabs} activeTab={activeTab} setActiveTab={setActiveTab}>
                    <div id="notices"><NoticeBoardTab userProfile={userProfile} /></div>
                    <div id="policies"><PolicyBoardTab userProfile={userProfile} /></div>
                </TabbedPage>
            );
        };
        // --- END NOTICE BOARD PAGE ---

        // --- START USER ACTIVITY PAGE ---
        const UserActivityPage = () => {
            const { db } = useFirebase();
            const { employees } = useAppData();
            const [logs, setLogs] = useState([]);
            const [limitCount, setLimitCount] = useState(50);
            const [loading, setLoading] = useState(true);

            useEffect(() => {
                if (!db) return;
                setLoading(true);
                const { collection, query, orderBy, limit, onSnapshot } = window.firebaseSDK;
                const q = query(collection(db, 'userLogs'), orderBy('timestamp', 'desc'), limit(limitCount));
                
                const unsubscribe = onSnapshot(q, (snapshot) => {
                    const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    setLogs(data);
                    setLoading(false);
                }, (error) => {
                    console.error("Error fetching user logs:", error);
                    setLoading(false);
                });
                return () => unsubscribe();
            }, [db, limitCount]);

            const getEmployeeName = (uid) => {
                if (!uid) return 'System';
                const emp = employees.find(e => e.uid === uid);
                return emp ? emp.name : 'Unknown User';
            };

            const formatLogTime = (timestamp) => {
                if (!timestamp || !timestamp.toDate) return '-';
                return timestamp.toDate().toLocaleString('en-GB');
            };

            // NEW: Helper to detect changes between original and updated data
            const getChangeDetails = (log) => {
                if (log.action === 'Delete Task' || log.action.includes('Delete')) {
                    return <span className="text-red-400">Item Deleted</span>;
                }
                
                if (!log.originalData && log.updatedData) {
                    return <span className="text-green-400">New Record Created</span>;
                }

                if (log.originalData && log.updatedData) {
                    const changes = [];
                    // Check for changes in updatedData against originalData
                    Object.keys(log.updatedData).forEach(key => {
                        // Skip internal fields or arrays that are hard to compare simply
                        if (['id', 'uid', 'createdAt', 'updatedAt', 'lastUpdated'].includes(key)) return;
                        
                        const originalVal = log.originalData[key];
                        const newVal = log.updatedData[key];

                        // Simple comparison (loose equality to handle '500' vs 500)
                        // Also check if one is undefined/null and other is not
                        if (JSON.stringify(originalVal) !== JSON.stringify(newVal)) {
                            // Format arrays (like shops) for display
                            const fmt = (v) => Array.isArray(v) ? v.join(', ') : (v === undefined || v === null || v === '' ? '(empty)' : v.toString());
                            
                            changes.push(
                                <div key={key} className="text-xs">
                                    <span className="font-semibold text-slate-400 capitalize">{key}:</span>{' '}
                                    <span className="text-red-300 line-through">{fmt(originalVal)}</span>{' '}
                                    <i className="fas fa-arrow-right text-slate-500 mx-1"></i>{' '}
                                    <span className="text-green-300">{fmt(newVal)}</span>
                                </div>
                            );
                        }
                    });

                    if (changes.length === 0) return <span className="text-slate-500">No changes detected</span>;
                    return <div className="flex flex-col gap-1">{changes}</div>;
                }

                return <span className="text-slate-500">-</span>;
            };

            return (
                <Card>
                    <div className="flex flex-wrap justify-between items-center mb-6 gap-4">
                        <h3 className="text-xl font-semibold text-slate-100">User Activity Logs</h3>
                        <div className="flex items-center gap-2">
                            <label className="text-sm text-slate-400">Show:</label>
                            <select 
                                value={limitCount} 
                                onChange={(e) => setLimitCount(Number(e.target.value))} 
                                className="select w-auto py-1 px-2 text-sm"
                            >
                                <option value={50}>50</option>
                                <option value={100}>100</option>
                                <option value={200}>200</option>
                            </select>
                        </div>
                    </div>

                    {loading ? (
                        <div className="text-center py-10"><i className="fas fa-spinner fa-spin text-3xl text-blue-500"></i></div>
                    ) : (
                        <div className="overflow-x-auto">
                            <table className="min-w-full divide-y divide-slate-700">
                                <thead className="bg-slate-900/50">
                                    <tr>
                                        <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Time</th>
                                        <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">User</th>
                                        <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Action</th>
                                        <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Target</th>
                                        {/* NEW COLUMN */}
                                        <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Changes Log</th>
                                    </tr>
                                </thead>
                                <tbody className="divide-y divide-slate-700">
                                    {logs.map(log => (
                                        <tr key={log.id} className="hover:bg-slate-700/50 transition-colors">
                                            <td className="px-4 py-3 text-sm text-slate-300 whitespace-nowrap font-mono align-top">
                                                {formatLogTime(log.timestamp)}
                                            </td>
                                            <td className="px-4 py-3 text-sm text-slate-200 font-medium align-top">
                                                {getEmployeeName(log.userId)}
                                            </td>
                                            <td className="px-4 py-3 text-sm text-blue-400 font-medium align-top">
                                                {log.action}
                                            </td>
                                            <td className="px-4 py-3 text-sm text-slate-300 align-top">
                                                {log.targetName || log.targetId || '-'}
                                            </td>
                                            <td className="px-4 py-3 text-sm text-slate-300 align-top">
                                                {/* Use the new helper to render diffs */}
                                                {getChangeDetails(log)}
                                            </td>
                                        </tr>
                                    ))}
                                    {logs.length === 0 && (
                                        <tr><td colSpan="5" className="px-4 py-8 text-center text-slate-500">No activity recorded found.</td></tr>
                                    )}
                                </tbody>
                            </table>
                        </div>
                    )}
                </Card>
            );
        };
        // --- END USER ACTIVITY PAGE ---

        // --- START LAYOUT & MAIN APP COMPONENTS ---
        
        // NEW: System Launch Pad Component (Redesigned to match "JLW Manager" Image)
        // MODIFIED: Refactored to use APP_MODULES global config
        // MODIFIED: Added 'companyHubUnreadCount' prop
        const SystemLaunchPad = ({ isOpen, onClose, activePage, onNavigate, userProfile, currentTime, pendingLeaves, pendingOTs, onNotificationClick, auth, setInitialCheckInMeTab, allowedLinkKeys, companyHubUnreadCount }) => {
            const { db } = useFirebase();
            const { employees } = useAppData(); 
            const [isEmployeeModalOpen, setIsEmployeeModalOpen] = useState(false);
            // FIX: Added state for profile menu to ensure it works on mobile (touch) instead of relying on hover
            const [isProfileOpen, setIsProfileOpen] = useState(false);

            if (!isOpen) return null;

            // NEW: Parse base page from activePage (which might contain params like "employees:add_new")
            const activeBasePage = activePage.split(':')[0];

            // Quick Action Handlers
            const handleQuickAction = (action) => {
                switch(action) {
                    case 'checkInOut':
                        onNavigate('checkinme');
                        setInitialCheckInMeTab('checkInOut');
                        onClose();
                        break;
                    case 'leaveRequest':
                        onNavigate('checkinme');
                        // MODIFIED: Append ':new' and timestamp to force update and trigger modal
                        setInitialCheckInMeTab(`leaveRequest:new:${Date.now()}`);
                        onClose();
                        break;
                    case 'otRequest':
                        onNavigate('checkinme');
                        // MODIFIED: Append ':new' and timestamp to force update and trigger modal
                        setInitialCheckInMeTab(`otRequest:new:${Date.now()}`);
                        onClose();
                        break;
                    case 'addStaff':
                        setIsEmployeeModalOpen(true);
                        break;
                    default:
                        break;
                }
            };

            const handleSaveEmployee = async (formData) => {
               // ... (Existing save logic) ...
               // (Keeping the logic same as before to save space in display, but it works exactly as the previous version)
                const { addDoc, updateDoc, doc, collection, setDoc, serverTimestamp } = window.firebaseSDK;
                const { id, ...dataToSave } = formData;
                try {
                    const newDocRef = await addDoc(collection(db, 'employees'), dataToSave);
                    const savedEmployeeId = newDocRef.id;
                    
                    const shopName = Array.isArray(dataToSave.shop) ? (dataToSave.shop[0] || '') : (dataToSave.shop || '');

                    // --- NEW: AUTO-CREATE WELCOME NOTICE (Quick Action) ---
                    try {
                        await addDoc(collection(db, 'memoAlerts'), {
                            title: `🎉 Welcome ${dataToSave.name}!`,
                            content: `We are thrilled to welcome **${dataToSave.name}** to the team!\n\nThey are joining us as a **${dataToSave.position}** at **${shopName}**.\n\nPlease give them a warm welcome!`,
                            startTime: '08:00',
                            endTime: '18:00',
                            targetShops: shopName ? [shopName] : [],
                            status: 'Active',
                            authorName: 'System',
                            authorId: 'system',
                            createdAt: serverTimestamp(),
                            readBy: [],
                            likes: []
                        });
                    } catch (noticeError) {
                        console.error("Failed to create welcome notice:", noticeError);
                    }
                    // --- END WELCOME NOTICE ---

                    try {
                        const today = new Date();
                        const savingsDefaults = {
                            employeeId: savedEmployeeId,
                            employeeName: dataToSave.name,
                            shop: shopName,
                            savingsProgramStatus: 'Active',
                            savingsPercentage: 5, 
                            savingsJoinDate: today.toISOString().slice(0, 10),
                            savingsEffectiveMonth: today.toISOString().slice(0, 7), 
                            currentBalance: 0,
                            mySavingCredit: 0,
                            mySavingWithdrawalTotal: 0,
                            lastUpdated: serverTimestamp()
                        };
                        await setDoc(doc(db, 'savingprogram', savedEmployeeId), savingsDefaults);
                    } catch (savingsError) {
                        console.error("Failed to auto-enroll:", savingsError);
                    }
                    Utils.logUserActivity(db, auth, 'Add Employee (Quick Action)', {
                        id: savedEmployeeId,
                        name: dataToSave.name,
                        updatedData: dataToSave
                    });
                    alert("New staff member added successfully!");
                    setIsEmployeeModalOpen(false);
                } catch (error) {
                    console.error("Error saving employee:", error);
                    alert("Failed to add employee.");
                }
            };

            const canAddStaff = userProfile?.role === 'Admin' || userProfile?.role === 'CEO' || userProfile?.role === 'Shop Manager';

            return (
                <div className="fixed inset-0 z-50 flex flex-col animate-fade-in bg-[#0f172a]"> {/* Dark Slate 950/Black */}
                    {/* Header Section */}
                    <header className="px-6 py-5 flex justify-between items-center z-30 relative shrink-0">
                        {/* Branding */}
                        <div className="flex items-center gap-3">
                            <div className="w-10 h-10 rounded-xl bg-gradient-to-br from-blue-600 to-indigo-600 flex items-center justify-center shadow-lg shadow-blue-500/30">
                                <i className="fas fa-layer-group text-white text-lg"></i>
                            </div>
                            <div>
                                <h1 className="text-xl font-bold text-white tracking-tight leading-none">HR System</h1>
                                <p className="text-[10px] text-slate-400 font-medium tracking-wide mt-0.5 uppercase">{userProfile?.role || 'Manager'}</p>
                            </div>
                        </div>

                        {/* Profile / Clock */}
                        <div className="flex items-center gap-4">
                            {/* MODIFIED: Removed 'hidden sm:flex' to show clock on mobile */}
                            <div className="flex flex-col items-end">
                                <span className="text-xs font-bold text-slate-200 font-mono">
                                    {currentTime?.toLocaleTimeString([], { hour12: false, hour: '2-digit', minute: '2-digit' })}
                                </span>
                                <span className="text-[9px] text-slate-400 font-medium uppercase tracking-wide leading-none mt-0.5">
                                    {currentTime.toLocaleDateString(undefined, { month: 'short', day: 'numeric' })}
                                </span>
                            </div>
                            
                            {/* FIX: Replaced CSS-hover group with React state toggle for mobile compatibility */}
                            <div className="relative">
                                <button 
                                    onClick={() => setIsProfileOpen(!isProfileOpen)}
                                    className="w-10 h-10 rounded-full bg-slate-800 border border-slate-700 flex items-center justify-center text-slate-300 hover:text-white hover:border-slate-500 transition-all shadow-md focus:outline-none focus:ring-2 focus:ring-slate-600 overflow-hidden"
                                >
                                    {userProfile?.photo ? (
                                        <img src={userProfile.photo} alt={userProfile.name} className="w-full h-full object-cover" />
                                    ) : (
                                        userProfile?.name?.charAt(0)
                                    )}
                                </button>
                                {/* Logout Dropdown */}
                                {isProfileOpen && (
                                    <div className="absolute right-0 mt-2 w-48 bg-slate-800 rounded-xl shadow-xl py-1 border border-slate-700 z-50 animate-fade-in">
                                        <div className="px-4 py-2 border-b border-slate-700 mb-1">
                                            <p className="text-xs text-slate-400">Signed in as</p>
                                            <p className="text-sm font-bold text-white truncate">{userProfile?.name}</p>
                                        </div>
                                        <a 
                                            href="#" 
                                            onClick={(e) => { 
                                                e.preventDefault(); 
                                                window.firebaseSDK.signOut(auth); 
                                                setIsProfileOpen(false); 
                                            }} 
                                            className="block px-4 py-3 text-sm text-red-400 hover:bg-slate-700/50 font-medium rounded-b-xl"
                                        >
                                            <i className="fas fa-sign-out-alt mr-2"></i> Sign out
                                        </a>
                                    </div>
                                )}
                            </div>
                        </div>
                    </header>
                    
                    {/* Scrollable Content */}
                    <div className="flex-1 overflow-y-auto px-6 pb-20">
                        <div className="max-w-md mx-auto sm:max-w-5xl">
                            
                            {/* APP GRID (3 Columns) */}
                            <div className="grid grid-cols-3 sm:grid-cols-4 md:grid-cols-5 lg:grid-cols-6 gap-4 mb-8">
                                {/* OPTIMIZATION: Map over APP_MODULES instead of props */}
                                {APP_MODULES.map(module => {
                                    // FIX: Compare against activeBasePage instead of the raw string
                                    const isActive = activeBasePage === module.key;
                                    const isLocked = allowedLinkKeys && !allowedLinkKeys.has(module.key);
                                    
                                    return (
                                        <button 
                                            key={module.key}
                                            onClick={() => { 
                                                if (isLocked) return; 
                                                onNavigate(module.key); 
                                                // FIX: Explicitly reset the CheckInMe tab to default when navigating via the main icon.
                                                if (module.key === 'checkinme') {
                                                    setInitialCheckInMeTab('checkInOut');
                                                }
                                                onClose(); 
                                            }}
                                            className={`group flex flex-col items-center justify-center gap-3 aspect-[4/5] w-full relative 
                                                ${isLocked ? 'cursor-not-allowed' : 'cursor-pointer'}
                                            `}
                                        >
                                            <div className={`
                                                w-full aspect-square rounded-[28px] flex items-center justify-center relative
                                                bg-[#1E293B] border border-slate-700/50
                                                shadow-lg transition-all duration-300
                                                ${!isLocked ? 'group-active:scale-95 group-hover:bg-[#253045]' : 'opacity-90'} 
                                            `}>
                                                {/* OPTIMIZATION: Use color/bg from global config directly */}
                                                <i className={`fas ${module.icon} text-3xl sm:text-4xl ${module.color} drop-shadow-md`}></i>

                                                {/* NEW: Company Hub Notification Badge */}
                                                {module.key === 'companyHub' && companyHubUnreadCount > 0 && (
                                                    <div className="absolute -top-1 -right-1 w-6 h-6 bg-red-500 rounded-full flex items-center justify-center border-2 border-[#0f172a] shadow-sm z-20 animate-bounce-short">
                                                        <span className="text-[10px] font-bold text-white leading-none">
                                                            {companyHubUnreadCount > 99 ? '99+' : companyHubUnreadCount}
                                                        </span>
                                                    </div>
                                                )}

                                                {isLocked && (
                                                    <div className="absolute top-2 right-2 w-6 h-6 bg-slate-900/90 border border-slate-700 rounded-full flex items-center justify-center shadow-md z-10">
                                                        <i className="fas fa-lock text-[10px] text-slate-400"></i>
                                                    </div>
                                                )}
                                            </div>
                                            
                                            <span className={`
                                                text-[11px] font-semibold tracking-wide text-center leading-tight
                                                ${isActive ? 'text-white' : 'text-slate-400 group-hover:text-slate-200'}
                                                ${isLocked ? 'text-slate-500' : ''}
                                            `}>
                                                {module.label.replace(' Report', '').replace('Revise', '').replace('Management', '')} 
                                            </span>
                                        </button>
                                    );
                                })}
                            </div>

                            {/* QUICK ACTIONS HEADER */}
                            <div className="mb-4 mt-2">
                                <h3 className="text-xs font-bold text-slate-500 uppercase tracking-widest pl-1">Quick Actions</h3>
                            </div>

                            {/* QUICK ACTION CARDS */}
                            <div className="space-y-4">
                                <button 
                                    onClick={() => handleQuickAction('checkInOut')}
                                    className="w-full relative overflow-hidden rounded-[24px] bg-gradient-to-r from-orange-500 to-amber-500 p-6 flex justify-between items-center shadow-lg shadow-orange-500/20 group active:scale-[0.98] transition-transform"
                                >
                                    <div className="text-left z-10">
                                        <h3 className="text-lg font-bold text-white mb-1">Check In / Out</h3>
                                        <p className="text-orange-100 text-xs font-medium">Daily Attendance Log</p>
                                    </div>
                                    <div className="w-12 h-12 rounded-full bg-white/20 backdrop-blur-sm flex items-center justify-center z-10">
                                        <i className="fas fa-user-clock text-white text-xl"></i>
                                    </div>
                                    <div className="absolute -left-4 -bottom-4 w-24 h-24 bg-white/10 rounded-full blur-xl"></div>
                                </button>

                                <div className="grid grid-cols-2 gap-4">
                                    <button 
                                        onClick={() => handleQuickAction('leaveRequest')}
                                        className="relative overflow-hidden rounded-[24px] bg-gradient-to-br from-pink-600 to-rose-500 p-5 flex flex-col justify-between h-32 shadow-lg shadow-pink-500/20 group active:scale-[0.98] transition-transform"
                                    >
                                        <div className="w-10 h-10 rounded-full bg-white/20 flex items-center justify-center mb-2">
                                            <i className="fas fa-calendar-minus text-white"></i>
                                        </div>
                                        <div className="text-left">
                                            <h3 className="text-md font-bold text-white leading-tight">Request<br/>Leave</h3>
                                        </div>
                                    </button>

                                    <button 
                                        onClick={() => handleQuickAction('otRequest')}
                                        className="relative overflow-hidden rounded-[24px] bg-gradient-to-br from-violet-600 to-purple-600 p-5 flex flex-col justify-between h-32 shadow-lg shadow-purple-500/20 group active:scale-[0.98] transition-transform"
                                    >
                                        <div className="w-10 h-10 rounded-full bg-white/20 flex items-center justify-center mb-2">
                                            <i className="fas fa-clock text-white"></i>
                                        </div>
                                        <div className="text-left">
                                            <h3 className="text-md font-bold text-white leading-tight">Request<br/>Overtime</h3>
                                        </div>
                                    </button>
                                </div>

                                {canAddStaff && (
                                    <button 
                                        onClick={() => handleQuickAction('addStaff')}
                                        className="w-full relative overflow-hidden rounded-[24px] bg-[#1E293B] border border-slate-700/50 p-5 flex justify-between items-center shadow-lg group active:scale-[0.98] transition-transform"
                                    >
                                        <div className="flex items-center gap-4">
                                            <div className="w-12 h-12 rounded-2xl bg-emerald-500/10 text-emerald-500 flex items-center justify-center">
                                                <i className="fas fa-user-plus text-xl"></i>
                                            </div>
                                            <div className="text-left">
                                                <h3 className="text-md font-bold text-white">Add New Staff</h3>
                                                <p className="text-slate-400 text-xs">Create employee profile</p>
                                            </div>
                                        </div>
                                        <div className="w-8 h-8 rounded-full bg-slate-800 flex items-center justify-center">
                                            <i className="fas fa-chevron-right text-slate-500 text-xs"></i>
                                        </div>
                                    </button>
                                )}
                            </div>

                        </div>
                    </div>
                    
                    <EmployeeModal
                        isOpen={isEmployeeModalOpen}
                        onClose={() => setIsEmployeeModalOpen(false)}
                        onSave={handleSaveEmployee}
                        userProfile={userProfile}
                        isViewOnly={false}
                    />
                </div>
            );
        };

        // --- START MAIN APP COMPONENT ---
        const AppContent = () => {
            // FIX: Added 'db' to the destructuring here so it is available for the effects below
            const { userProfile, loading, auth, db } = useFirebase();
            const [activePage, setActivePage] = useState('dashboard');
            
            // FIX: Destructure 'where' from firebaseSDK so it is available for notificationConstraints
            const { where } = window.firebaseSDK;
            
            // MODIFIED: Get global data for Birthday Logic
            const { employees, shops } = useAppData(); 

            // --- NEW: Fetch Data for Company Hub Badge (Notices & Policies) ---
            const { data: allNotices } = useCollection('memoAlerts');
            const { data: allPolicies } = useCollection('policies');

            const companyHubUnreadCount = useMemo(() => {
                if (!userProfile) return 0;

                // 1. Calculate Unread Notices (Active & Relevant Shop)
                const unreadNoticesCount = (allNotices || []).filter(n => {
                    // Filter: Must be Active for Staff
                    if (userProfile.role === 'Staff' && n.status !== 'Active') return false;

                    // Filter: Must match user's shop (if targetShops is defined)
                    if (n.targetShops && n.targetShops.length > 0) {
                        const userShops = Array.isArray(userProfile.shop) ? userProfile.shop : [userProfile.shop];
                        // If user has no shops (e.g., brand new admin), they might see everything or nothing. Let's assume see if admin.
                        if (userProfile.role !== 'Admin' && userProfile.role !== 'CEO' && !userShops.some(s => n.targetShops.includes(s))) {
                            return false;
                        }
                    }

                    // Count if user ID is NOT in readBy array
                    return !(n.readBy || []).includes(userProfile.id);
                }).length;

                // 2. Calculate Unread Policies
                const unreadPoliciesCount = (allPolicies || []).filter(p => {
                    return !(p.readBy || []).includes(userProfile.id);
                }).length;

                return unreadNoticesCount + unreadPoliciesCount;
            }, [allNotices, allPolicies, userProfile]);
            // --- END NEW BADGE LOGIC ---

            // ... (existing state)
            const [isLaunchPadOpen, setIsLaunchPadOpen] = useState(true);
            const [isHeaderProfileOpen, setIsHeaderProfileOpen] = useState(false);
            const [initialCheckInMeTab, setInitialCheckInMeTab] = useState('checkInOut');
            const { isOnline } = useConnectivity();
            const [currentTime, setCurrentTime] = useState(new Date());

            // --- NEW: State for Pending Meeting Alert ---
            const [pendingMeetingInvites, setPendingMeetingInvites] = useState([]);
            const [isMeetingAlertOpen, setIsMeetingAlertOpen] = useState(false);
            // State to ensure we don't annoy the user if they manually close it once per session
            const [hasViewedAlert, setHasViewedAlert] = useState(false);
            
            // --- NEW: State for Birthday Celebration Pop-up ---
            const [isBirthdayPopupOpen, setIsBirthdayPopupOpen] = useState(false);
            const [hasViewedBirthday, setHasViewedBirthday] = useState(false);

            useEffect(() => {
                const timer = setInterval(() => setCurrentTime(new Date()), 1000);
                return () => clearInterval(timer);
            }, []);

            // --- STEP 1 RE-EXECUTION: BIRTHDAY NOTIFICATION LOGIC ---
            // Calculates birthdays for today based on SHOP TIMEZONE
            const birthdayNotifications = useMemo(() => {
                if (!employees || !shops || !userProfile) return [];
                
                return employees.filter(emp => {
                    // Basic checks
                    if (emp.status !== 'Active' || !emp.dob) return false;

                    // 1. Determine Employee's Shop Timezone
                    const empShopName = Array.isArray(emp.shop) ? emp.shop[0] : emp.shop;
                    const shop = shops.find(s => s.name === empShopName);
                    const timezone = shop?.timezone;

                    // 2. Get Today's Date String in THAT timezone (e.g., "-12-25")
                    const { localDate: todayStr } = Utils.formatDateInTimezone({ toDate: () => new Date() }, timezone);
                    // Extract MM-DD from YYYY-MM-DD
                    const todaySuffix = todayStr.substring(4); // gets "-MM-DD"

                    // 3. Date Check
                    if (!emp.dob.endsWith(todaySuffix)) return false;

                    // 4. Role-based visibility check
                    if (userProfile.role === 'Admin' || userProfile.role === 'CEO') return true;
                    
                    // Logic for Staff and Managers to see shop colleagues
                    if (userProfile.role === 'Shop Manager' || userProfile.role === 'Staff') {
                        const myShops = Array.isArray(userProfile.shop) ? userProfile.shop : [userProfile.shop];
                        const empShops = Array.isArray(emp.shop) ? emp.shop : [emp.shop];
                        
                        // Employee must be in one of the user's shops
                        const isColleague = empShops.some(s => myShops.includes(s));
                        return isColleague;
                    }
                    
                    return false;
                });
            }, [employees, shops, userProfile]);
            
            // --- NEW: Trigger Birthday Pop-up automatically ---
            useEffect(() => {
                // If there are birthdays today, we haven't seen the popup yet, and we aren't loading
                if (birthdayNotifications.length > 0 && !hasViewedBirthday && !loading) {
                    // Wait a moment for the dashboard to render, then show pop-up
                    const timer = setTimeout(() => {
                        setIsBirthdayPopupOpen(true);
                        setHasViewedBirthday(true); // Mark as viewed so it doesn't open again this session
                    }, 2000);
                    return () => clearTimeout(timer);
                }
            }, [birthdayNotifications, hasViewedBirthday, loading]);
            
            // --- END STEP 1 ---

            // --- NEW: Effect to fetch Pending Meetings for Alert ---
            useEffect(() => {
                if (!userProfile || !db) return;
                
                const { collection, query, where, onSnapshot } = window.firebaseSDK;
                const now = new Date();
                // Filter out past meetings (older than yesterday to allow some buffer)
                const yesterday = new Date(now);
                yesterday.setDate(yesterday.getDate() - 1);
                const dateFilterStr = yesterday.toISOString().slice(0, 10);

                // Query for meetings where the user is invited
                // Note: We filter 'status' in JS because Firestore map queries are limited
                const q = query(
                    collection(db, 'meetings'),
                    where('invitedStaffIds', 'array-contains', userProfile.id),
                    where('date', '>=', dateFilterStr)
                );

                const unsubscribe = onSnapshot(q, (snapshot) => {
                    const meetings = snapshot.docs.map(doc => ({id: doc.id, ...doc.data()}));
                    
                    const pending = meetings.filter(m => {
                        const myResponse = m.responses?.[userProfile.id];
                        // Show if no response object exists OR status is 'pending'
                        // Also ensure meeting isn't cancelled/completed
                        return (!myResponse || myResponse.status === 'pending') && m.status !== 'Cancelled';
                    });
                    
                    // Sort by date/time (soonest first)
                    pending.sort((a, b) => {
                        const dateA = new Date(`${a.date}T${a.startTime}`);
                        const dateB = new Date(`${b.date}T${b.startTime}`);
                        return dateA - dateB;
                    });

                    setPendingMeetingInvites(pending);

                    // Auto-open logic: Only if we haven't dismissed it yet and there are items
                    if (pending.length > 0 && !hasViewedAlert) {
                        setIsMeetingAlertOpen(true);
                    }
                }, (error) => {
                    console.error("Error fetching meeting alerts:", error);
                });

                return () => unsubscribe();
            }, [userProfile, db, hasViewedAlert]);

            // --- NEW: Handler for Meeting Alert Response ---
            const handleAlertRespond = async (meeting, type, reason) => {
                const { doc, updateDoc } = window.firebaseSDK;
                try {
                    const meetingRef = doc(db, 'meetings', meeting.id);
                    const fieldPath = `responses.${userProfile.id}`;
                    
                    await updateDoc(meetingRef, {
                        [fieldPath]: {
                            status: type,
                            reason: reason || '',
                            timestamp: new Date().toISOString()
                        }
                    });
                    
                    // If that was the last one, close the modal
                    if (pendingMeetingInvites.length <= 1) {
                        setIsMeetingAlertOpen(false);
                    }
                } catch (error) {
                    console.error("Error saving response from alert:", error);
                    alert("Failed to update status. Please try again.");
                }
            };

            const handleCloseAlert = () => {
                setIsMeetingAlertOpen(false);
                setHasViewedAlert(true); // Don't auto-open again this session
            };

            // Fetch pending requests for notifications
            const { db: dbInstance } = useFirebase(); // Renamed to avoid conflict if any, though scope is fine here
            // Note: We already use 'db' from useFirebase at top of component, so line above is redundant but harmless.
            
            const notificationConstraints = useMemo(() => {
                if (!userProfile) return [where("status", "==", "ImpossibleValue")]; 
                const { role, shop, id } = userProfile;
                if (role === 'Admin' || role === 'CEO') return [where("status", "==", "Pending")];
                if (role === 'Shop Manager') {
                    const managedShops = Array.isArray(shop) ? shop : (shop ? [shop] : []);
                    if (managedShops.length > 0) return [where("status", "==", "Pending"), where("shop", "in", managedShops)];
                }
                return [where("status", "==", "ImpossibleValue")]; 
            }, [userProfile]);

            const { data: pendingLeaves } = useCollection('leaveRequests', notificationConstraints);
            const { data: pendingOTs } = useCollection('otRequests', notificationConstraints);

            useEffect(() => {
                if (!loading && !userProfile && auth && !auth.currentUser) {
                    // console.log("No user, stay on login");
                }
            }, [userProfile, loading, auth]);

            const handleNotificationClick = (type) => {
                setActivePage('checkinme');
                setInitialCheckInMeTab(type); 
            };

            // OPTIMIZATION: Replaced large useMemo array with global APP_MODULES constant lookup
            // MODIFIED: Logic to parse "page:params" format
            const [activePageKey, activePageParams] = useMemo(() => {
                const parts = activePage.split(':');
                return [parts[0], parts.slice(1).join(':')];
            }, [activePage]);

            const currentPageTitle = useMemo(() => {
                const module = APP_MODULES.find(m => m.key === activePageKey);
                return module ? module.label : '';
            }, [activePageKey]);

            // OPTIMIZATION: Streamlined permission logic using APP_MODULES
            const availableLinks = useMemo(() => {
                if (userProfile?.role === 'Admin' || userProfile?.role === 'CEO') return APP_MODULES;
                
                const allowedPages = new Set(userProfile?.permissions || []);
                allowedPages.add('companyHub'); // MERGED: Allow access to the hub globally (like notices/policy before)
                allowedPages.add('dashboard');
                allowedPages.add('tasks'); // Grant Task Manager access to everyone
        
                return APP_MODULES.filter(link => allowedPages.has(link.key));
            }, [userProfile]);
            
            // Generate allowed keys set for Launch Pad locking
            const allowedLinkKeys = useMemo(() => {
                return new Set(availableLinks.map(link => link.key));
            }, [availableLinks]);

            // Renders the component for the currently active page
            const renderActivePage = useCallback(() => {
                // MODIFIED: Use activePageKey for permission checks
                // Added 'tasks' and 'notices' to the global allowance list
                const hasPermission = (userProfile?.role === 'Admin') || (userProfile?.role === 'CEO' && activePageKey !== 'sysConfig') || userProfile?.permissions?.includes(activePageKey) || activePageKey === 'companyHub' || activePageKey === 'dashboard' || activePageKey === 'tasks';
                
                if (!activePageKey) return null;
                if (!hasPermission) return <Card><CardTitle>Access Denied</CardTitle><p>You do not have permission to view this page.</p></Card>;
                
                switch(activePageKey) {
                    case 'dashboard': return <DashboardSummaryPage userProfile={userProfile} setActivePage={setActivePage} onNavigateWithTab={handleNotificationClick} />;
                    case 'companyHub': return <CompanyHubPage userProfile={userProfile} />; // MERGED: New Route
                    case 'employees': return <EmployeesPage userProfile={userProfile} pageParams={activePageParams} />;
                    case 'checkinme': return <CheckInMePage userProfile={userProfile} initialTab={initialCheckInMeTab} />;
                    case 'attendanceReport': return <AttendanceReportPage userProfile={userProfile} />;
                    case 'payroll': return <PayrollPage userProfile={userProfile} />;
                    case 'hrBanking': return <HRBankingPage userProfile={userProfile} />;
                    case 'expenseReport': return <ExpenseReportPage userProfile={userProfile} />;
                    case 'assets': return <AssetManagerPage userProfile={userProfile} />;
                    case 'tasks': return <TaskBoardPage userProfile={userProfile} />;
                    case 'policy': return <PolicyBoardPage userProfile={userProfile} />;
                    case 'userActivity': return <UserActivityPage />;
                    case 'settings': return <SettingsPage />;
                    default: return <UnderConstructionPage title="Page Not Found" />;
                }
            }, [activePageKey, activePageParams, userProfile, initialCheckInMeTab]);

            if (loading) return <div className="flex items-center justify-center min-h-screen bg-slate-900 text-white"><i className="fas fa-spinner fa-spin text-4xl mr-3"></i> Loading System...</div>;
            if (!userProfile) return <LoginPage />;

            return (
                <div className="flex h-screen bg-slate-900 overflow-hidden flex-col">
                    {/* Unified System Launch Pad (Overlay) */}
                    <SystemLaunchPad 
                        isOpen={isLaunchPadOpen} 
                        onClose={() => setIsLaunchPadOpen(false)} 
                        activePage={activePage}
                        onNavigate={setActivePage}
                        userProfile={userProfile}
                        currentTime={currentTime}
                        pendingLeaves={pendingLeaves}
                        pendingOTs={pendingOTs}
                        onNotificationClick={handleNotificationClick}
                        auth={auth}
                        setInitialCheckInMeTab={setInitialCheckInMeTab}
                        allowedLinkKeys={allowedLinkKeys}
                        companyHubUnreadCount={companyHubUnreadCount} // PASS PROP HERE
                    />

                    {/* Unified Header (Used for both Desktop & Mobile) */}
                    <header className="bg-slate-800 shadow-md p-4 flex justify-between items-center z-30 relative shrink-0">
                        <div className="flex items-center">
                            {/* Branding is now the "Home" trigger. */}
                            <button 
                                onClick={() => setIsLaunchPadOpen(true)} 
                                className="flex items-center gap-3 p-2 rounded-lg hover:bg-slate-700/50 transition-colors group focus:outline-none focus:ring-2 focus:ring-blue-500/50"
                                title="Go to Home / Launch Pad"
                            >
                                <div className="w-8 h-8 rounded-lg bg-blue-600 flex items-center justify-center shadow-lg shadow-blue-900/50 group-hover:scale-105 transition-transform duration-200">
                                    <i className="fas fa-building-user text-white text-sm"></i>
                                </div>
                                <h2 className="text-lg font-bold text-white tracking-tight group-hover:text-blue-100 transition-colors hidden xs:block">HR System</h2>
                            </button>

                            {/* Header Breadcrumb / Page Name Display */}
                            <div className="flex items-center animate-fade-in ml-1">
                                <i className="fas fa-chevron-right text-slate-600 mx-2 sm:mx-3 text-[10px] sm:text-xs"></i>
                                <h2 className="text-sm sm:text-base font-semibold text-blue-400 tracking-wide truncate max-w-[120px] sm:max-w-none">
                                    {currentPageTitle}
                                </h2>
                            </div>
                        </div>

                        <div className="flex items-center gap-3">
                            {/* Live Clock (Compact) */}
                            {/* MODIFIED: Removed 'hidden sm:flex' to show clock on mobile */}
                            <div className="flex flex-col items-end mr-1">
                                <span className="text-xs font-bold text-slate-200 font-mono leading-none">
                                    {currentTime.toLocaleTimeString([], { hour12: false, hour: '2-digit', minute: '2-digit' })}
                                </span>
                                <span className="text-[9px] text-slate-400 font-medium uppercase tracking-wide leading-none mt-0.5">
                                    {currentTime.toLocaleDateString(undefined, { month: 'short', day: 'numeric' })}
                                </span>
                            </div>

                            {/* MODIFIED: Pass birthdayNotifications to NotificationBell */}
                            <NotificationBell 
                                pendingLeaves={pendingLeaves} 
                                pendingOTs={pendingOTs} 
                                birthdayNotifications={birthdayNotifications}
                                onNotificationClick={handleNotificationClick} 
                            />
                            
                            {/* FIX: Replaced CSS-hover group with React state toggle for mobile compatibility */}
                            <div className="relative">
                                <button 
                                    onClick={() => setIsHeaderProfileOpen(!isHeaderProfileOpen)}
                                    className="flex items-center text-sm font-medium text-slate-300 hover:text-white focus:outline-none"
                                >
                                    {userProfile?.photo ? (
                                        <img src={userProfile.photo} alt={userProfile.name} className="w-8 h-8 rounded-full object-cover shadow-md border border-blue-400" />
                                    ) : (
                                        <div className="w-8 h-8 rounded-full bg-blue-500 flex items-center justify-center text-white font-bold shadow-md border border-blue-400">
                                            {userProfile.name.charAt(0)}
                                        </div>
                                    )}
                                </button>
                                {isHeaderProfileOpen && (
                                    <div className="absolute right-0 mt-2 w-48 bg-slate-800 rounded-md shadow-lg py-1 border border-slate-700 z-50 animate-fade-in">
                                        <div className="px-4 py-2 border-b border-slate-700 mb-1">
                                            <p className="text-xs text-slate-400">Signed in as</p>
                                            <p className="text-sm font-bold text-white truncate">{userProfile?.name}</p>
                                        </div>
                                        <a 
                                            href="#" 
                                            onClick={(e) => { 
                                                e.preventDefault(); 
                                                window.firebaseSDK.signOut(auth);
                                                setIsHeaderProfileOpen(false); 
                                            }} 
                                            className="block px-4 py-2 text-sm text-red-400 hover:bg-slate-700"
                                        >
                                            <i className="fas fa-sign-out-alt mr-2"></i> Sign out
                                        </a>
                                    </div>
                                )}
                            </div>
                        </div>
                    </header>

                    {/* Main Content Area */}
                    <main className="flex-1 overflow-y-auto p-4 sm:p-6 pb-24 relative scroll-smooth w-full max-w-7xl mx-auto">
                        {renderActivePage()}
                    </main>

                    {/* NEW: Render the Pending Meetings Alert Modal */}
                    <PendingMeetingsModal 
                        isOpen={isMeetingAlertOpen} 
                        onClose={handleCloseAlert} 
                        meetings={pendingMeetingInvites} 
                        onRespond={handleAlertRespond} 
                    />
                    
                    {/* NEW: Render the Birthday Celebration Pop-up */}
                    <BirthdayCelebrationModal 
                        isOpen={isBirthdayPopupOpen}
                        onClose={() => setIsBirthdayPopupOpen(false)}
                        celebrants={birthdayNotifications}
                    />
                </div>
            );
        };

        const App = () => (
            <ConnectivityProvider>
                <FirebaseProvider>
                    <AppDataProvider>
                        <AppContent />
                    </AppDataProvider>
                </FirebaseProvider>
            </ConnectivityProvider>
        );

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
