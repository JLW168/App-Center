<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CheckInMe</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" xintegrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        @import url('https://rsms.me/inter/inter.css');
        html, body { 
            font-family: 'Inter', sans-serif;
            overflow-x: hidden;
        }
        .input, .select {
            margin-top: 0.25rem; display: block; width: 100%; padding: 0.5rem 0.75rem;
            border-width: 1px; border-color: #475569; border-radius: 0.375rem;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); line-height: 1.5;
            background-color: #334155; color: #f1f5f9;
        }
        .input:focus, .select:focus {
            outline: 2px solid transparent; outline-offset: 2px;
            --tw-ring-color: #2563eb; border-color: #2563eb;
        }
        .input[disabled], .select[disabled] {
            background-color: #475569;
            cursor: not-allowed;
            opacity: 0.7;
        }
    </style>
</head>
<body class="bg-slate-900 text-slate-300">
    <div id="root"></div>

    <script type="module">
        // Firebase SDK imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, doc, addDoc, updateDoc, deleteDoc, query, where, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Make Firebase SDK available globally
        window.firebaseSDK = {
            initializeApp, getAuth, getFirestore, collection, onSnapshot,
            doc, addDoc, updateDoc, deleteDoc, query, where, serverTimestamp,
            signInWithEmailAndPassword, onAuthStateChanged, signOut
        };
    </script>
    
    <script type="text/babel">
        const { useState, useEffect, useMemo, useCallback } = React;

        // --- FIREBASE CONFIGURATION ---
        const firebaseConfig = {
            apiKey: "AIzaSyB7_pnmwHj6aOeZRTykPvNusNFYReaTY6Q",
            authDomain: "hrsm-j.firebaseapp.com",
            projectId: "hrsm-j",
            storageBucket: "hrsm-j.appspot.com",
            messagingSenderId: "45063715478",
            appId: "1:45063715478:web:cc2dd21b83dd195771e0b7",
            measurementId: "G-8HQDG2LTKP"
        };
        
        // --- CUSTOM HOOK FOR DATA FETCHING ---
        const useCollection = (db, collectionName, queryConstraints = []) => {
            const [data, setData] = useState([]);
            useEffect(() => {
                if (!db) return;
                const { collection, onSnapshot, query } = window.firebaseSDK;
                const q = query(collection(db, collectionName), ...queryConstraints);
                const unsubscribe = onSnapshot(q, (querySnapshot) => {
                    const items = [];
                    querySnapshot.forEach((doc) => {
                        items.push({ id: doc.id, ...doc.data() });
                    });
                    setData(items);
                }, (error) => {
                    console.error(`Error fetching collection ${collectionName}:`, error);
                });
                return () => unsubscribe();
            }, [db, collectionName, JSON.stringify(queryConstraints)]);
            return { data };
        };
        
        // --- UTILITY FUNCTIONS ---
        const formatISOToDisplay = (isoDate) => {
            if (!isoDate || typeof isoDate !== 'string' || !isoDate.includes('-')) return isoDate || '';
            const parts = isoDate.split('-');
            if (parts.length !== 3) return isoDate;
            const [year, month, day] = parts;
            return `${day}-${month}-${year}`;
        };

        const formatRequestDate = (timestamp) => {
            if (!timestamp || !timestamp.toDate) return 'N/A';
            const date = timestamp.toDate();
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const year = String(date.getFullYear()).slice(-2);
            const formattedDate = `${day}-${month}-${year}`;
            const formattedTime = date.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: true });
            return `${formattedDate} | ${formattedTime}`;
        };

        const getDistance = (lat1, lon1, lat2, lon2) => {
            const R = 6371e3; // metres
            const φ1 = lat1 * Math.PI/180;
            const φ2 = lat2 * Math.PI/180;
            const Δφ = (lat2-lat1) * Math.PI/180;
            const Δλ = (lon2-lon1) * Math.PI/180;
            const a = Math.sin(Δφ/2) * Math.sin(Δφ/2) + Math.cos(φ1) * Math.cos(φ2) * Math.sin(Δλ/2) * Math.sin(Δλ/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c; // in metres
        };

        // --- REUSABLE UI & PAGE COMPONENTS ---
        const Card = ({ children, className = '' }) => (
            <div className={`bg-slate-800/50 p-4 sm:p-6 rounded-lg shadow-lg border border-slate-700 ${className}`}>
                {children}
            </div>
        );

        const Modal = ({ isOpen, onClose, children, maxWidth = "max-w-4xl" }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 bg-black bg-opacity-70 z-50 flex justify-center items-start sm:items-center p-4 overflow-y-auto overflow-x-hidden">
                    <div className={`bg-slate-800 rounded-lg shadow-2xl w-full ${maxWidth} flex flex-col border border-slate-600 my-auto`}>
                        {children}
                    </div>
                </div>
            );
        };

        const ModalHeader = ({ title, onClose }) => (
            <div className="p-5 border-b border-slate-700 flex justify-between items-center flex-shrink-0">
                <h3 className="text-xl font-semibold text-slate-100">{title}</h3>
                <button onClick={onClose} className="text-slate-400 hover:text-white text-2xl p-1">&times;</button>
            </div>
        );

        const ModalBody = ({ children }) => (
            <div className="p-6 flex-grow overflow-y-auto max-h-[calc(90vh-140px)]">
                {children}
            </div>
        );

        const ModalFooter = ({ children }) => (
            <div className="p-4 bg-slate-900/50 border-t border-slate-700 flex justify-end gap-4 rounded-b-lg flex-shrink-0">
                {children}
            </div>
        );
        
        const ConfirmationModal = ({ isOpen, onClose, onConfirm, title, message }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 bg-black bg-opacity-70 z-50 flex justify-center items-center p-4">
                    <div className="bg-slate-800 rounded-lg shadow-2xl w-full max-w-sm border border-slate-600">
                        <div className="p-6">
                            <h3 className="text-lg font-bold text-slate-100">{title}</h3>
                            <p className="mt-2 text-sm text-slate-400">{message}</p>
                        </div>
                        <div className="p-4 bg-slate-900/50 border-t border-slate-700 flex justify-end gap-4 rounded-b-lg">
                            <button onClick={onClose} className="bg-slate-600 text-slate-200 px-4 py-2 rounded-lg hover:bg-slate-500">Cancel</button>
                            <button onClick={onConfirm} className="bg-red-600 text-white px-4 py-2 rounded-lg shadow hover:bg-red-700">Confirm</button>
                        </div>
                    </div>
                </div>
            );
        };

        const TabbedPage = ({ tabs, activeTab, setActiveTab, children }) => {
            const renderContent = () => React.Children.toArray(children).find(child => child.props.id === activeTab);
            return (
                <div>
                    <div className="mb-6 overflow-x-auto">
                        <nav className="flex space-x-2 sm:space-x-4" aria-label="Tabs">
                            {Object.entries(tabs).map(([key, title]) => (
                                <a href="#" key={key} onClick={(e) => { e.preventDefault(); setActiveTab(key); }} className={`whitespace-nowrap rounded-md px-3 py-2 text-sm font-medium transition-colors ${activeTab === key ? 'bg-blue-600 text-white shadow' : 'text-slate-400 hover:bg-slate-700/50 hover:text-slate-200'}`}>{title}</a>
                            ))}
                        </nav>
                    </div>
                    {renderContent()}
                </div>
            );
        };

        // --- LOGIN PAGE COMPONENT ---
        const LoginPage = ({ auth }) => {
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [error, setError] = useState('');
            const [loading, setLoading] = useState(false);
            const [showPassword, setShowPassword] = useState(false);

            const handleLogin = async (e) => {
                e.preventDefault();
                setLoading(true);
                setError('');
                try {
                    const { signInWithEmailAndPassword } = window.firebaseSDK;
                    await signInWithEmailAndPassword(auth, email, password);
                } catch (err) {
                    setError('Failed to login. Please check your credentials.');
                    console.error(err);
                }
                setLoading(false);
            };

            return (
                <div className="flex items-center justify-center min-h-screen bg-slate-900">
                    <div className="w-full max-w-md p-8 space-y-8 bg-slate-800 rounded-2xl shadow-lg border border-slate-700">
                        <div className="text-center">
                             <i className="fas fa-user-clock text-5xl text-blue-500"></i>
                            <h2 className="mt-6 text-3xl font-bold text-white">CheckInMe</h2>
                            <p className="mt-2 text-sm text-slate-400">Sign in to your account</p>
                        </div>
                        <form className="mt-8 space-y-6" onSubmit={handleLogin}>
                            <div className="rounded-md shadow-sm -space-y-px">
                                <div><input id="email-address" name="email" type="email" autoComplete="email" required className="appearance-none rounded-none relative block w-full px-3 py-3 border border-slate-600 bg-slate-700 text-white placeholder-slate-400 rounded-t-md focus:outline-none focus:ring-blue-500 focus:border-blue-500 focus:z-10 sm:text-sm" placeholder="Email address" value={email} onChange={(e) => setEmail(e.target.value)} /></div>
                                <div className="relative"><input id="password" name="password" type={showPassword ? "text" : "password"} autoComplete="current-password" required className="appearance-none rounded-none relative block w-full px-3 py-3 border border-slate-600 bg-slate-700 text-white placeholder-slate-400 rounded-b-md focus:outline-none focus:ring-blue-500 focus:border-blue-500 focus:z-10 sm:text-sm" placeholder="Password" value={password} onChange={(e) => setPassword(e.target.value)} /><button type="button" onClick={() => setShowPassword(!showPassword)} className="absolute inset-y-0 right-0 pr-3 flex items-center text-sm leading-5"><i className={`fas ${showPassword ? 'fa-eye-slash' : 'fa-eye'} text-slate-400 hover:text-slate-200`}></i></button></div>
                            </div>
                            {error && <p className="text-red-500 text-sm text-center">{error}</p>}
                            <div><button type="submit" disabled={loading} className="group relative w-full flex justify-center py-3 px-4 border border-transparent text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 focus:ring-offset-slate-800 disabled:bg-blue-800 disabled:cursor-not-allowed">{loading ? <i className="fas fa-spinner fa-spin"></i> : 'Sign in'}</button></div>
                        </form>
                    </div>
                </div>
            );
        };

        // --- CHECK-IN/OUT SPECIFIC COMPONENTS ---
        const LeaveRequestModal = ({ isOpen, onClose, onSave, db, request, userProfile }) => {
            const { data: employees } = useCollection(db, 'employees');
            const [formData, setFormData] = useState({});

            useEffect(() => {
                let initialData;
                if (request) {
                    initialData = { ...request };
                } else if (userProfile) {
                    initialData = {
                        shop: userProfile.shop || '',
                        staffId: userProfile.id || '',
                        supervisor: userProfile.supervisor || '',
                        leaveType: 'Full Day',
                        leaveDate: '',
                        returnDate: '',
                        numberOfDays: 0,
                        reason: ''
                    };
                }
                setFormData(initialData);
            }, [request, userProfile, isOpen]);

            useEffect(() => {
                if (formData.leaveDate && formData.returnDate) {
                    const start = new Date(formData.leaveDate);
                    const end = new Date(formData.returnDate);
                    if (end >= start) {
                        if (formData.leaveType?.startsWith('Half Day')) {
                             setFormData(prev => ({ ...prev, numberOfDays: 0.5 }));
                             return;
                        }
                        const startUTC = Date.UTC(start.getFullYear(), start.getMonth(), start.getDate());
                        const endUTC = Date.UTC(end.getFullYear(), end.getMonth(), end.getDate());
                        const diffDays = (endUTC - startUTC) / (1000 * 60 * 60 * 24);
                        setFormData(prev => ({ ...prev, numberOfDays: diffDays === 0 ? 1 : diffDays }));
                    } else {
                        setFormData(prev => ({ ...prev, numberOfDays: 0 }));
                    }
                }
            }, [formData.leaveDate, formData.returnDate, formData.leaveType]);

            const handleChange = (e) => {
                const { name, value } = e.target;
                setFormData(prev => ({ ...prev, [name]: value }));
            };

            const handleSubmit = (e) => {
                e.preventDefault();
                onSave(formData);
            };

            return (
                <Modal isOpen={isOpen} onClose={onClose} maxWidth="max-w-4xl">
                    <form onSubmit={handleSubmit}>
                        <ModalHeader title={request ? "Edit Leave Request" : "New Leave Request"} onClose={onClose} />
                        <ModalBody>
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div><label className="text-sm">Shop</label><input value={formData.shop || ''} className="input" disabled /></div>
                                <div><label className="text-sm">Staff Name</label><input value={userProfile?.name || ''} className="input" disabled /></div>
                                <div><label className="text-sm">Supervisor</label><input value={formData.supervisor || ''} className="input" disabled /></div>
                                <div><label className="text-sm">Leave Type</label><select name="leaveType" value={formData.leaveType || 'Full Day'} onChange={handleChange} className="select"><option>Full Day</option><option>Half Day (AM)</option><option>Half Day (PM)</option></select></div>
                                <div><label className="text-sm">Leave Date</label><input type="date" name="leaveDate" value={formData.leaveDate || ''} onChange={handleChange} className="input" required /></div>
                                <div><label className="text-sm">Return Date</label><input type="date" name="returnDate" value={formData.returnDate || ''} onChange={handleChange} className="input" required /></div>
                                <div><label className="text-sm">Number of Days</label><input type="number" name="numberOfDays" value={formData.numberOfDays || 0} className="input" disabled /></div>
                                <div className="md:col-span-2"><label className="text-sm">Reason</label><textarea name="reason" value={formData.reason || ''} onChange={handleChange} className="input" rows="3" required></textarea></div>
                            </div>
                        </ModalBody>
                        <ModalFooter>
                            <button type="button" onClick={onClose} className="bg-slate-600 text-slate-200 px-4 py-2 rounded-lg hover:bg-slate-500">Cancel</button>
                            <button type="submit" className="bg-blue-600 text-white px-6 py-2 rounded-lg shadow hover:bg-blue-700">Submit Request</button>
                        </ModalFooter>
                    </form>
                </Modal>
            );
        };

        const OTRequestModal = ({ isOpen, onClose, onSave, db, request, userProfile }) => {
            const { data: employees } = useCollection(db, 'employees');
            const [formData, setFormData] = useState({});

            const supervisors = useMemo(() => {
                return employees.filter(e => e.role === 'Admin' || e.role === 'Shop Manager');
            }, [employees]);

            useEffect(() => {
                let initialData;
                if (request) {
                    initialData = { ...request };
                } else if (userProfile) {
                    initialData = {
                        reqDate: new Date().toISOString().substring(0, 10),
                        shop: userProfile.shop || '', 
                        staffId: userProfile.id || '', 
                        supervisor: userProfile.supervisor || '',
                        numberOfOTDays: 1,
                        reason: ''
                    };
                }
                 setFormData(initialData);
            }, [request, userProfile, isOpen]);

            const handleChange = (e) => {
                const { name, value } = e.target;
                setFormData(prev => ({ ...prev, [name]: value }));
            };

            const handleSubmit = (e) => {
                e.preventDefault();
                onSave(formData);
            };

            return (
                <Modal isOpen={isOpen} onClose={onClose} maxWidth="max-w-4xl">
                    <form onSubmit={handleSubmit}>
                        <ModalHeader title={request ? "Edit OT Request" : "New OT Request"} onClose={onClose} />
                        <ModalBody>
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div><label className="text-sm">Req. Date</label><input type="date" name="reqDate" value={formData.reqDate || ''} onChange={handleChange} className="input" required /></div>
                                <div><label className="text-sm">Shop Name</label><input value={formData.shop || ''} className="input" disabled /></div>
                                <div><label className="text-sm">Staff Name</label><input value={userProfile?.name || ''} className="input" disabled /></div>
                                <div><label className="text-sm">Supervisor</label><input value={formData.supervisor || ''} className="input" disabled /></div>
                                <div><label className="text-sm">No. OT Day</label><input type="number" name="numberOfOTDays" value={formData.numberOfOTDays || ''} onChange={handleChange} className="input" required min="0.5" step="0.5" /></div>
                                <div className="md:col-span-2"><label className="text-sm">Reason</label><textarea name="reason" value={formData.reason || ''} onChange={handleChange} className="input" rows="3" required></textarea></div>
                            </div>
                        </ModalBody>
                        <ModalFooter>
                            <button type="button" onClick={onClose} className="bg-slate-600 text-slate-200 px-4 py-2 rounded-lg hover:bg-slate-500">Cancel</button>
                            <button type="submit" className="bg-blue-600 text-white px-6 py-2 rounded-lg shadow hover:bg-blue-700">Submit Request</button>
                        </ModalFooter>
                    </form>
                </Modal>
            );
        };

        const LeaveRequestTab = ({ db, userProfile }) => {
            const [isModalOpen, setModalOpen] = useState(false);
            const [editingRequest, setEditingRequest] = useState(null);
            const [isConfirmOpen, setConfirmOpen] = useState(false);
            const [requestToDelete, setRequestToDelete] = useState(null);
            const { where } = window.firebaseSDK;

            const queryConstraints = useMemo(() => {
                if (!userProfile) return [where("staffId", "==", "null")];
                if (userProfile.role === 'Admin') return [];
                if (userProfile.role === 'Shop Manager') {
                    return [where("shop", "==", userProfile.shop)];
                }
                return [where("staffId", "==", userProfile.id)];
            }, [userProfile]);

            const { data: leaveRequests } = useCollection(db, 'leaveRequests', queryConstraints);
            const { data: employees } = useCollection(db, 'employees');
            
            const handleOpenModal = (request = null) => {
                setEditingRequest(request);
                setModalOpen(true);
            };

            const handleCloseModal = () => {
                setEditingRequest(null);
                setModalOpen(false);
            };

            const handleSaveRequest = async (formData) => {
                const { doc, addDoc, updateDoc, collection, serverTimestamp } = window.firebaseSDK;
                const staffName = employees.find(e => e.id === formData.staffId)?.name || '';
                
                try {
                    if (formData.id) {
                        const { id, ...dataToUpdate } = formData;
                        await updateDoc(doc(db, 'leaveRequests', id), { ...dataToUpdate, staffName });
                    } else {
                        await addDoc(collection(db, 'leaveRequests'), {
                            ...formData,
                            staffName,
                            requestDate: serverTimestamp(),
                            status: 'Pending',
                        });
                    }
                    handleCloseModal();
                } catch (error) {
                    console.error("Error saving leave request:", error);
                }
            };

            const handleUpdateRequestStatus = async (id, status) => {
                const { doc, updateDoc } = window.firebaseSDK;
                try {
                    await updateDoc(doc(db, 'leaveRequests', id), { status });
                } catch (error) {
                    console.error(`Error updating status for request ${id}:`, error);
                }
            };
            
            const handleDeleteRequest = (id) => {
                setRequestToDelete(id);
                setConfirmOpen(true);
            };
            
            const confirmDelete = async () => {
                if (requestToDelete) {
                    const { doc, deleteDoc } = window.firebaseSDK;
                    try {
                        await deleteDoc(doc(db, 'leaveRequests', requestToDelete));
                    } catch (error) {
                        console.error(`Error deleting request ${requestToDelete}:`, error);
                    } finally {
                        setConfirmOpen(false);
                        setRequestToDelete(null);
                    }
                }
            };
            
            return (
                <Card>
                    <div className="flex flex-wrap gap-4 justify-between items-center mb-6">
                        <h3 className="text-xl font-semibold text-slate-100">Leave Requests</h3>
                        <button onClick={() => handleOpenModal()} className="bg-blue-600 text-white px-4 py-2 rounded-lg shadow hover:bg-blue-700 transition-colors flex items-center gap-2">
                            <i className="fas fa-plus"></i> New Request
                        </button>
                    </div>

                    <div className="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-4">
                        {leaveRequests.map(req => (
                            <div key={req.id} className="bg-slate-700/50 rounded-lg p-4 space-y-3 flex flex-col">
                                <div className="flex justify-between items-start">
                                    <div>
                                        <p className="font-bold text-lg text-slate-100">{req.staffName}</p>
                                        <p className="text-sm text-slate-300">{req.leaveType}</p>
                                    </div>
                                    <span className={`px-2 py-1 text-xs font-semibold rounded-full ${
                                        req.status === 'Approved' ? 'bg-green-200 text-green-900' :
                                        req.status === 'Rejected' ? 'bg-red-200 text-red-900' :
                                        'bg-yellow-200 text-yellow-900'
                                    }`}>
                                        {req.status}
                                    </span>
                                </div>
                                <div className="grid grid-cols-2 gap-x-4 gap-y-2 text-sm pt-2 border-t border-slate-600 flex-grow">
                                    <div><p className="text-slate-400">Leave Date</p><p className="text-slate-200 font-medium">{formatISOToDisplay(req.leaveDate)}</p></div>
                                    <div><p className="text-slate-400">Return Date</p><p className="text-slate-200 font-medium">{formatISOToDisplay(req.returnDate)}</p></div>
                                    <div><p className="text-slate-400">Days</p><p className="text-slate-200 font-medium">{req.numberOfDays}</p></div>
                                    <div><p className="text-slate-400">Requested</p><p className="text-slate-200 font-medium">{formatRequestDate(req.requestDate)}</p></div>
                                    <div className="col-span-2"><p className="text-slate-400">Supervisor</p><p className="text-slate-200 font-medium">{req.supervisor}</p></div>
                                    <div className="col-span-2"><p className="text-slate-400">Reason</p><p className="text-slate-200 font-medium">{req.reason}</p></div>
                                </div>
                                <div className="flex justify-end space-x-3 pt-2">
                                    {userProfile?.name === req.supervisor && req.status === 'Pending' && (
                                        <>
                                            <button onClick={() => handleUpdateRequestStatus(req.id, 'Approved')} className="text-green-400 hover:text-green-300" title="Approve"><i className="fas fa-check-circle fa-lg"></i></button>
                                            <button onClick={() => handleUpdateRequestStatus(req.id, 'Rejected')} className="text-orange-400 hover:text-orange-300" title="Reject"><i className="fas fa-times-circle fa-lg"></i></button>
                                        </>
                                    )}
                                    <button onClick={() => handleOpenModal(req)} className="text-indigo-400 hover:text-indigo-300" title="Edit"><i className="fas fa-edit fa-lg"></i></button>
                                    <button onClick={() => handleDeleteRequest(req.id)} className="text-red-400 hover:text-red-300" title="Delete"><i className="fas fa-trash fa-lg"></i></button>
                                </div>
                            </div>
                        ))}
                    </div>
                    <LeaveRequestModal isOpen={isModalOpen} onClose={handleCloseModal} onSave={handleSaveRequest} db={db} request={editingRequest} userProfile={userProfile} />
                    <ConfirmationModal 
                        isOpen={isConfirmOpen}
                        onClose={() => setConfirmOpen(false)}
                        onConfirm={confirmDelete}
                        title="Delete Leave Request"
                        message="Are you sure you want to permanently delete this leave request?"
                    />
                </Card>
            );
        };

        const OTRequestTab = ({ db, userProfile }) => {
            const [isModalOpen, setModalOpen] = useState(false);
            const [editingRequest, setEditingRequest] = useState(null);
            const [isConfirmOpen, setConfirmOpen] = useState(false);
            const [requestToDelete, setRequestToDelete] = useState(null);
            const { where } = window.firebaseSDK;

            const queryConstraints = useMemo(() => {
                if (!userProfile) return [where("staffId", "==", "null")];
                if (userProfile.role === 'Admin') return [];
                if (userProfile.role === 'Shop Manager') {
                    return [where("shop", "==", userProfile.shop)];
                }
                return [where("staffId", "==", userProfile.id)];
            }, [userProfile]);

            const { data: otRequests } = useCollection(db, 'otRequests', queryConstraints);
            const { data: employees } = useCollection(db, 'employees');
            
            const handleOpenModal = (request = null) => {
                setEditingRequest(request);
                setModalOpen(true);
            };

            const handleCloseModal = () => {
                setEditingRequest(null);
                setModalOpen(false);
            };

            const handleSaveRequest = async (formData) => {
                const { doc, addDoc, updateDoc, collection, serverTimestamp } = window.firebaseSDK;
                const staffName = employees.find(e => e.id === formData.staffId)?.name || '';
                
                try {
                    if (formData.id) {
                        const { id, ...dataToUpdate } = formData;
                        await updateDoc(doc(db, 'otRequests', id), { ...dataToUpdate, staffName });
                    } else {
                        await addDoc(collection(db, 'otRequests'), {
                            ...formData,
                            staffName,
                            submissionDate: serverTimestamp(),
                            status: 'Pending',
                        });
                    }
                    handleCloseModal();
                } catch (error) {
                    console.error("Error saving OT request:", error);
                }
            };

            const handleUpdateRequestStatus = async (id, status) => {
                const { doc, updateDoc } = window.firebaseSDK;
                try {
                    await updateDoc(doc(db, 'otRequests', id), { status });
                } catch (error) {
                    console.error(`Error updating status for OT request ${id}:`, error);
                }
            };
            
            const handleDeleteRequest = (id) => {
                setRequestToDelete(id);
                setConfirmOpen(true);
            };
            
            const confirmDelete = async () => {
                if (requestToDelete) {
                    const { doc, deleteDoc } = window.firebaseSDK;
                    try {
                        await deleteDoc(doc(db, 'otRequests', requestToDelete));
                    } catch (error) {
                        console.error(`Error deleting OT request ${requestToDelete}:`, error);
                    } finally {
                        setConfirmOpen(false);
                        setRequestToDelete(null);
                    }
                }
            };
            
            return (
                <Card>
                    <div className="flex flex-wrap gap-4 justify-between items-center mb-6">
                        <h3 className="text-xl font-semibold text-slate-100">Overtime Requests</h3>
                        <button onClick={() => handleOpenModal()} className="bg-blue-600 text-white px-4 py-2 rounded-lg shadow hover:bg-blue-700 transition-colors flex items-center gap-2">
                            <i className="fas fa-plus"></i> New OT Request
                        </button>
                    </div>
                    <div className="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-4">
                        {otRequests.map(req => (
                            <div key={req.id} className="bg-slate-700/50 rounded-lg p-4 space-y-3 flex flex-col">
                                <div className="flex justify-between items-start">
                                    <div>
                                        <p className="font-bold text-lg text-slate-100">{req.staffName}</p>
                                        <p className="text-sm text-slate-300">{req.shop}</p>
                                    </div>
                                    <span className={`px-2 py-1 text-xs font-semibold rounded-full ${
                                        req.status === 'Approved' ? 'bg-green-200 text-green-900' :
                                        req.status === 'Rejected' ? 'bg-red-200 text-red-900' :
                                        'bg-yellow-200 text-yellow-900'
                                    }`}>
                                        {req.status}
                                    </span>
                                </div>
                                <div className="grid grid-cols-2 gap-x-4 gap-y-2 text-sm pt-2 border-t border-slate-600 flex-grow">
                                    <div><p className="text-slate-400">OT Date</p><p className="text-slate-200 font-medium">{formatISOToDisplay(req.reqDate)}</p></div>
                                    <div><p className="text-slate-400">Days</p><p className="text-slate-200 font-medium">{req.numberOfOTDays}</p></div>
                                    <div className="col-span-2"><p className="text-slate-400">Supervisor</p><p className="text-slate-200 font-medium">{req.supervisor}</p></div>
                                    <div className="col-span-2"><p className="text-slate-400">Submitted</p><p className="text-slate-200 font-medium">{formatRequestDate(req.submissionDate)}</p></div>
                                </div>
                                <div className="flex justify-end space-x-3 pt-2">
                                    {userProfile?.name === req.supervisor && req.status === 'Pending' && (
                                        <>
                                            <button onClick={() => handleUpdateRequestStatus(req.id, 'Approved')} className="text-green-400 hover:text-green-300" title="Approve"><i className="fas fa-check-circle fa-lg"></i></button>
                                            <button onClick={() => handleUpdateRequestStatus(req.id, 'Rejected')} className="text-orange-400 hover:text-orange-300" title="Reject"><i className="fas fa-times-circle fa-lg"></i></button>
                                        </>
                                    )}
                                    <button onClick={() => handleOpenModal(req)} className="text-indigo-400 hover:text-indigo-300" title="Edit"><i className="fas fa-edit fa-lg"></i></button>
                                    <button onClick={() => handleDeleteRequest(req.id)} className="text-red-400 hover:text-red-300" title="Delete"><i className="fas fa-trash fa-lg"></i></button>
                                </div>
                            </div>
                        ))}
                    </div>
                    <OTRequestModal isOpen={isModalOpen} onClose={handleCloseModal} onSave={handleSaveRequest} db={db} request={editingRequest} userProfile={userProfile} />
                    <ConfirmationModal 
                        isOpen={isConfirmOpen}
                        onClose={() => setConfirmOpen(false)}
                        onConfirm={confirmDelete}
                        title="Delete OT Request"
                        message="Are you sure you want to permanently delete this OT request?"
                    />
                </Card>
            );
        };

        const CheckInOutTab = ({ db, userProfile }) => {
            const [currentTime, setCurrentTime] = useState(new Date());
            const [location, setLocation] = useState(null);
            const [status, setStatus] = useState('Getting your location...');
            const [loading, setLoading] = useState(false);
            const [distance, setDistance] = useState(null);
            const [lateStatusMessage, setLateStatusMessage] = useState('');
            
            const { data: shops } = useCollection(db, 'shops');
            const { data: attendance } = useCollection(db, 'attendance');

            const userShop = useMemo(() => {
                if (!userProfile || !shops.length) return null;
                return shops.find(s => s.name === userProfile.shop);
            }, [userProfile, shops]);

            const today = new Date().toISOString().split('T')[0];
            const userAttendanceToday = useMemo(() => {
                if (!userProfile || !attendance.length) return [];
                return attendance
                    .filter(a => a.employeeId === userProfile.id && a.timestamp?.toDate().toISOString().startsWith(today))
                    .sort((a, b) => b.timestamp?.toDate() - a.timestamp?.toDate());
            }, [userProfile, attendance, today]);
            
            const lastAction = userAttendanceToday.length > 0 ? userAttendanceToday[0] : null;

            useEffect(() => {
                const timerId = setInterval(() => setCurrentTime(new Date()), 1000);
                return () => clearInterval(timerId);
            }, []);

            useEffect(() => {
                if (lastAction && lastAction.type === 'in' && userProfile?.shift) {
                    const checkInTime = lastAction.timestamp.toDate();
                    const todayForShift = new Date(checkInTime.getFullYear(), checkInTime.getMonth(), checkInTime.getDate());

                    let shiftStartTime;
                    if (userProfile.shift === 'AM' || userProfile.shift === 'APM') {
                        shiftStartTime = new Date(todayForShift.setHours(7, 30, 0, 0));
                    } else if (userProfile.shift === 'PM') {
                        shiftStartTime = new Date(todayForShift.setHours(12, 30, 0, 0));
                    }

                    if (shiftStartTime && checkInTime > shiftStartTime) {
                        const diffMilliseconds = checkInTime.getTime() - shiftStartTime.getTime();
                        const totalMinutes = Math.floor(diffMilliseconds / (1000 * 60));
                        const hours = Math.floor(totalMinutes / 60);
                        const minutes = totalMinutes % 60;

                        let lateMessage = "You are late for ";
                        if (hours > 0) {
                            lateMessage += `${hours} hour${hours > 1 ? 's' : ''} `;
                        }
                        if (minutes > 0) {
                            lateMessage += `${minutes} minute${minutes > 1 ? 's' : ''}`;
                        }
                        
                        // Handle case where it's less than a minute but still late
                        if (hours === 0 && minutes === 0) {
                           const seconds = Math.floor(diffMilliseconds / 1000) % 60;
                           if (seconds > 0) {
                               lateMessage += `${seconds} second${seconds > 1 ? 's' : ''}`;
                           }
                        }

                        setLateStatusMessage(lateMessage.trim());
                    } else {
                        setLateStatusMessage('');
                    }
                } else {
                    setLateStatusMessage('');
                }
            }, [lastAction, userProfile]);

            const getLocation = useCallback(() => {
                if (!userShop) {
                    setStatus("Your assigned shop could not be found.");
                    return;
                }
                
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const { latitude, longitude } = position.coords;
                        setLocation({ latitude, longitude });
                        const dist = getDistance(latitude, longitude, parseFloat(userShop.latitude), parseFloat(userShop.longitude));
                        setDistance(dist);
                        if (dist > (parseFloat(userShop.radius) || 500)) {
                            setStatus(`You are too far from the shop (${Math.round(dist)}m). Check-in disabled.`);
                        } else {
                            setStatus(`You are within the shop area (${Math.round(dist)}m). Ready to check in/out.`);
                        }
                    },
                    (error) => {
                        console.error(`Geolocation error: ${error.message} (Code: ${error.code})`);
                        let errorMessage = "Could not get your location. Please try again.";
                        switch(error.code) {
                            case error.PERMISSION_DENIED: errorMessage = "Location permission denied. Please enable it in your browser settings."; break;
                            case error.POSITION_UNAVAILABLE: errorMessage = "Location information is currently unavailable."; break;
                            case error.TIMEOUT: errorMessage = "The request to get user location timed out."; break;
                        }
                        setStatus(errorMessage);
                    },
                    { enableHighAccuracy: true }
                );

            }, [userShop]);

            useEffect(() => {
                getLocation();
                const interval = setInterval(getLocation, 30000);
                return () => clearInterval(interval);
            }, [getLocation]);

            const handleCheckAction = async () => {
                if (!location || !userShop || distance > (userShop.radius || 500)) {
                    setStatus("Cannot check-in. You are not within the allowed radius.");
                    return;
                }
                setLoading(true);

                const { addDoc, collection, serverTimestamp } = window.firebaseSDK;
                const nextActionType = lastAction?.type === 'in' ? 'out' : 'in';

                try {
                    await addDoc(collection(db, 'attendance'), {
                        employeeId: userProfile.id,
                        employeeName: userProfile.name,
                        shop: userProfile.shop,
                        timestamp: serverTimestamp(),
                        type: nextActionType,
                        location
                    });
                    setStatus(`Successfully checked ${nextActionType} at ${new Date().toLocaleTimeString()}`);
                } catch (error) {
                    console.error("Error recording attendance:", error);
                    setStatus("Failed to record attendance. Please try again.");
                }
                setLoading(false);
            };

            const canCheck = distance !== null && userShop && distance <= (parseFloat(userShop.radius) || 500);

            return (
                <Card className="max-w-2xl mx-auto">
                    <div className="flex flex-col items-center justify-center p-4 sm:p-8 space-y-8">
                        <div className="text-center">
                            <p className="text-4xl sm:text-7xl font-bold text-slate-100 tracking-wider">
                                {currentTime.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: true })}
                            </p>
                            <p className="text-xl text-slate-400 mt-2">
                                {currentTime.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}
                            </p>
                        </div>

                        <div className="flex gap-4">
                            <button onClick={handleCheckAction} disabled={lastAction?.type === 'in' || !canCheck || loading} className={`px-8 py-3 text-lg font-semibold rounded-lg shadow-md transition-colors transform hover:scale-105 ${lastAction?.type === 'in' || !canCheck || loading ? 'bg-slate-700 text-slate-500 cursor-not-allowed' : 'bg-green-600 text-white hover:bg-green-700'}`}>
                                {loading && lastAction?.type !== 'in' ? <i className="fas fa-spinner fa-spin"></i> : 'Check In'}
                            </button>
                            <button onClick={handleCheckAction} disabled={lastAction?.type !== 'in' || !canCheck || loading} className={`px-8 py-3 text-lg font-semibold rounded-lg shadow-md transition-colors transform hover:scale-105 ${lastAction?.type !== 'in' || !canCheck || loading ? 'bg-slate-700 text-slate-500 cursor-not-allowed' : 'bg-slate-600 text-white hover:bg-slate-500'}`}>
                                {loading && lastAction?.type === 'in' ? <i className="fas fa-spinner fa-spin"></i> : 'Check Out'}
                            </button>
                        </div>
                        
                        <div className={`p-4 rounded-lg text-center w-full max-w-md ${canCheck ? 'bg-green-900/50 border-green-700' : 'bg-red-900/50 border-red-700'} border`}>
                            <p className="font-medium text-lg text-slate-100">{status}</p>
                        </div>

                        <div className="text-center text-sm text-slate-400">
                            <p>Welcome, <span className="font-bold text-slate-200">{userProfile?.name}</span></p>
                            <p>Your assigned shop is <span className="font-bold text-slate-200">{userProfile?.shop}</span></p>
                            {lastAction && (
                                <p className="mt-2">Last action: Checked <span className="font-semibold text-slate-200">{lastAction.type}</span> at <span className="font-semibold text-slate-200">{lastAction.timestamp?.toDate().toLocaleTimeString()}</span></p>
                            )}
                            {lateStatusMessage && (
                                <p className="mt-1 text-yellow-400 font-semibold">{lateStatusMessage}</p>
                            )}
                        </div>
                    </div>
                </Card>
            );
        };

        // --- MAIN PAGE COMPONENT ---
        const CheckInMePage = ({ db, userProfile }) => {
            const [activeTab, setActiveTab] = useState('checkInOut');
            return (
                <TabbedPage tabs={{ checkInOut: 'Check In/Out', leaveRequest: 'Leave Request', otRequest: 'OT Request' }} activeTab={activeTab} setActiveTab={setActiveTab}>
                    <div id="checkInOut"><CheckInOutTab db={db} userProfile={userProfile} /></div>
                    <div id="leaveRequest"><LeaveRequestTab db={db} userProfile={userProfile}/></div>
                    <div id="otRequest"><OTRequestTab db={db} userProfile={userProfile}/></div>
                </TabbedPage>
            );
        };

        const AppHeader = ({ auth, userProfile }) => {
            const handleLogout = async () => {
                try { await window.firebaseSDK.signOut(auth); } 
                catch (error) { console.error("Error signing out: ", error); }
            };
            return (
                <header className="bg-slate-800/80 backdrop-blur-sm shadow-md p-4 flex justify-between items-center z-30 border-b border-slate-700 sticky top-0">
                    <div className="flex items-center">
                        <i className="fas fa-user-clock text-3xl text-blue-500 mr-3"></i>
                        <h1 className="text-2xl font-bold text-white">CheckInMe</h1>
                    </div>
                    <div className="flex items-center gap-4">
                        {userProfile && (
                            <div className="text-right hidden sm:block">
                                <span className="text-sm text-slate-400">Welcome, </span>
                                <span className="font-medium text-slate-200">{userProfile.name}</span>
                            </div>
                        )}
                        <button onClick={handleLogout} title="Logout" className="bg-slate-700 text-slate-300 w-10 h-10 rounded-full hover:bg-slate-600 hover:text-white transition duration-150 flex items-center justify-center flex-shrink-0">
                            <i className="fas fa-sign-out-alt"></i>
                        </button>
                    </div>
                </header>
            );
        };

        // --- ROOT APP COMPONENT ---
        function App() {
            const [db, setDb] = useState(null);
            const [auth, setAuth] = useState(null);
            const [currentUser, setCurrentUser] = useState(null);
            const [userProfile, setUserProfile] = useState(null);
            const [loading, setLoading] = useState(true);

            useEffect(() => {
                try {
                    const { initializeApp, getFirestore, getAuth, onAuthStateChanged } = window.firebaseSDK;
                    const app = initializeApp(firebaseConfig);
                    const authInstance = getAuth(app);
                    const dbInstance = getFirestore(app);
                    setAuth(authInstance);
                    setDb(dbInstance);

                    const unsubscribe = onAuthStateChanged(authInstance, (user) => {
                        setCurrentUser(user);
                        if (!user) {
                             setUserProfile(null);
                            setLoading(false);
                        }
                    });
                    return () => unsubscribe();
                } catch (error) { 
                    console.error("Firebase initialization error:", error); 
                    setLoading(false);
                } 
            }, []);

            useEffect(() => {
                if (!db || !currentUser) {
                    setUserProfile(null);
                    return;
                };

                const { collection, query, where, onSnapshot } = window.firebaseSDK;
                const q = query(collection(db, "employees"), where("uid", "==", currentUser.uid));
                
                const unsubscribe = onSnapshot(q, (snapshot) => {
                    if (!snapshot.empty) {
                        const userDoc = snapshot.docs[0];
                        setUserProfile({ id: userDoc.id, ...userDoc.data() });
                    } else {
                        setUserProfile({ name: currentUser.email, permissions: [], role: 'Staff' });
                    }
                    setLoading(false);
                }, (error) => {
                    console.error("Error fetching user profile:", error);
                    setLoading(false);
                });

                return () => unsubscribe();
            }, [db, currentUser]);

            if (loading) { return <div className="flex items-center justify-center h-screen text-lg text-slate-300">Loading Application...</div>; }
            
            if (!currentUser) {
                return <LoginPage auth={auth} />;
            }

            return (
                <div className="flex flex-col h-screen">
                    <AppHeader auth={auth} userProfile={userProfile} />
                    <main className="flex-1 overflow-y-auto p-4 sm:p-6">
                        <CheckInMePage db={db} userProfile={userProfile} />
                    </main>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
