<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HR Management System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        @import url('https://rsms.me/inter/inter.css');
        html { font-family: 'Inter', sans-serif; }
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-content {
            background-color: white;
            padding: 2rem;
            border-radius: 0.5rem;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }
        .input {
            margin-top: 0.25rem;
            display: block;
            width: 100%;
            padding-left: 0.75rem;
            padding-right: 0.75rem;
            padding-top: 0.6rem;
            padding-bottom: 0.6rem;
            border-width: 1px;
            border-color: #D1D5DB;
            border-radius: 0.375rem;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
        }
        .input:focus {
            outline: 2px solid transparent;
            outline-offset: 2px;
            --tw-ring-color: #2563EB;
            border-color: #2563EB;
        }
        .checkbox-group {
            max-height: 150px;
            overflow-y: auto;
            border: 1px solid #D1D5DB;
            border-radius: 0.375rem;
            padding: 0.5rem;
            margin-top: 0.25rem;
        }
        .search-results {
            position: absolute;
            background: white;
            border: 1px solid #ddd;
            border-radius: 0.375rem;
            width: 100%;
            max-height: 200px;
            overflow-y: auto;
            z-index: 10;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .search-item {
            padding: 0.5rem 0.75rem;
            cursor: pointer;
        }
        .search-item:hover {
            background-color: #f3f4f6;
        }
        select.input {
            text-align-last: center;
        }
    </style>
</head>
<body class="bg-gray-100">
    <div id="root"></div>

    <script type="module">
        // Make Firebase SDK functions available on the window object
        // so they can be accessed by the React component.
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, doc, addDoc, updateDoc, deleteDoc, setLogLevel, getDocs, serverTimestamp, writeBatch, query, where, runTransaction } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        window.firebaseSDK = {
            initializeApp,
            getAuth,
            onAuthStateChanged,
            signInWithEmailAndPassword,
            signOut,
            getFirestore,
            collection,
            onSnapshot,
            doc,
            addDoc,
            updateDoc,
            deleteDoc,
            setLogLevel,
            getDocs,
            serverTimestamp,
            writeBatch,
            query,
            where,
            runTransaction
        };
    </script>
    
    <script type="text/babel">
        const { useState, useEffect, useMemo, useCallback, useRef } = React;

        // --- PASTE YOUR FIREBASE CONFIGURATION HERE ---
        const firebaseConfig = {
            apiKey: "AIzaSyBNb5ZI9XIWWSpxGD-FeV94K5FMc2a8udU",
            authDomain: "hr-manager-84ada.firebaseapp.com",
            projectId: "hr-manager-84ada",
            storageBucket: "hr-manager-84ada.firebasestorage.app",
            messagingSenderId: "365563456537",
            appId: "1:365563456537:web:9c5a6fbce7710b4c72ce88",
            measurementId: "G-51R9KT7LC1"
        };
        // ---------------------------------------------

        // --- HELPER FUNCTIONS ---
        const formatDate = (dateString) => {
            if (!dateString) return '';
            const date = new Date(dateString);
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const year = date.getFullYear();
            return `${day}-${month}-${year}`;
        };
        
        const formatTimestamp = (timestamp) => {
            if (!timestamp || !timestamp.toDate) return 'N/A';
            return timestamp.toDate().toLocaleString('en-GB');
        };

        const formatCurrency = (number) => {
            if (number === null || number === undefined || number === '' || isNaN(number)) return '';
            return Number(number).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        };
        
        const calculateWorkedDuration = (joinDate) => {
            if (!joinDate) return 'N/A';
            const start = new Date(joinDate);
            const end = new Date();
            
            let years = end.getFullYear() - start.getFullYear();
            let months = end.getMonth() - start.getMonth();
            let days = end.getDate() - start.getDate();

            if (days < 0) {
                months--;
                days += new Date(end.getFullYear(), end.getMonth(), 0).getDate();
            }
            if (months < 0) {
                years--;
                months += 12;
            }

            const totalMonths = years * 12 + months;
            return `${totalMonths}M-${days}D`;
        };
        
        function showConfirmation(message) {
            return new Promise((resolve) => {
                const confirmationBox = document.createElement('div');
                confirmationBox.className = 'modal-overlay';
                confirmationBox.innerHTML = `
                    <div class="modal-content text-center">
                        <p class="mb-4">${message}</p>
                        <div class="flex justify-center space-x-4">
                            <button id="confirm-yes" class="bg-red-600 text-white px-4 py-2 rounded-lg shadow hover:bg-red-700">Yes, delete</button>
                            <button id="confirm-no" class="bg-white px-4 py-2 border border-gray-300 rounded-md shadow-sm text-gray-700 hover:bg-gray-50">Cancel</button>
                        </div>
                    </div>
                `;
                document.body.appendChild(confirmationBox);

                document.getElementById('confirm-yes').onclick = () => {
                    document.body.removeChild(confirmationBox);
                    resolve(true);
                };

                document.getElementById('confirm-no').onclick = () => {
                    document.body.removeChild(confirmationBox);
                    resolve(false);
                };
            });
        }
        
        // Custom hook to fetch a collection from Firestore
        const useCollection = (db, collectionName) => {
            const [data, setData] = useState([]);
            const [loading, setLoading] = useState(true);

            useEffect(() => {
                if (!db) {
                    setLoading(false);
                    return;
                };

                const { collection, onSnapshot, query } = window.firebaseSDK;
                const q = query(collection(db, collectionName));
                const unsubscribe = onSnapshot(q, (querySnapshot) => {
                    const items = [];
                    querySnapshot.forEach((doc) => {
                        items.push({ id: doc.id, ...doc.data() });
                    });
                    setData(items);
                    setLoading(false);
                }, (error) => {
                    console.error(`Error fetching ${collectionName}:`, error);
                    setLoading(false);
                });

                return () => unsubscribe();
            }, [db, collectionName]);

            return { data, loading };
        };

        // --- AUTHENTICATION COMPONENT ---
        function LoginPage({ auth }) {
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [error, setError] = useState('');
            const [loading, setLoading] = useState(false);
            const [showPassword, setShowPassword] = useState(false);
            const { signInWithEmailAndPassword } = window.firebaseSDK;

            const handleLogin = async (e) => {
                e.preventDefault();
                setLoading(true);
                setError('');
                try {
                    await signInWithEmailAndPassword(auth, email, password);
                } catch (err) {
                    setError(err.message);
                } finally {
                    setLoading(false);
                }
            };

            return (
                <div className="min-h-screen bg-gray-100 flex flex-col justify-center sm:py-12">
                    <div className="p-10 xs:p-0 mx-auto md:w-full md:max-w-md">
                        <h1 className="font-bold text-center text-2xl mb-5">HR Manager</h1>  
                        <div className="bg-white shadow w-full rounded-lg divide-y divide-gray-200">
                            <form onSubmit={handleLogin} className="px-5 py-7">
                                <label className="font-semibold text-sm text-gray-600 pb-1 block">E-mail</label>
                                <input type="email" value={email} onChange={e => setEmail(e.target.value)} className="border rounded-lg px-3 py-2 mt-1 mb-5 text-sm w-full" required />
                                <label className="font-semibold text-sm text-gray-600 pb-1 block">Password</label>
                                <div className="relative">
                                    <input type={showPassword ? "text" : "password"} value={password} onChange={e => setPassword(e.target.value)} className="border rounded-lg px-3 py-2 mt-1 mb-5 text-sm w-full" required />
                                    <div className="absolute inset-y-0 right-0 pr-3 flex items-center text-sm leading-5">
                                        <svg onClick={() => setShowPassword(!showPassword)} className="h-6 w-6 text-gray-700 cursor-pointer" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            {showPassword ? (
                                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                                            ) : (
                                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242" />
                                            )}
                                        </svg>
                                    </div>
                                </div>
                                {error && <p className="text-red-500 text-xs mb-4">{error}</p>}
                                <button type="submit" disabled={loading} className="transition duration-200 bg-blue-500 hover:bg-blue-600 focus:bg-blue-700 focus:shadow-sm focus:ring-4 focus:ring-blue-500 focus:ring-opacity-50 text-white w-full py-2.5 rounded-lg text-sm shadow-sm hover:shadow-md font-semibold text-center inline-block">
                                    <span className="inline-block mr-2">{loading ? 'Logging in...' : 'Login'}</span>
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
            );
        }

        // --- CORE APPLICATION COMPONENTS ---

        function App() {
            const [db, setDb] = useState(null);
            const [auth, setAuth] = useState(null);
            const [initStatus, setInitStatus] = useState('pending');
            const [errorMsg, setErrorMsg] = useState('');
            const [currentUser, setCurrentUser] = useState(null);
            const [userPermissions, setUserPermissions] = useState(null);
            const [authLoading, setAuthLoading] = useState(true);

            useEffect(() => {
                const initializeFirebase = async () => {
                    if (!firebaseConfig || !firebaseConfig.apiKey.startsWith('AIza')) {
                        setErrorMsg('Firebase is not configured. Please edit the firebaseConfig object in the HTML file.');
                        setInitStatus('error');
                        return;
                    }

                    try {
                        const { initializeApp, getFirestore, getAuth, setLogLevel, onAuthStateChanged, collection, query, where, getDocs } = window.firebaseSDK;
                        const app = initializeApp(firebaseConfig);
                        const firestore = getFirestore(app);
                        const authInstance = getAuth(app);
                        
                        setLogLevel('debug');
                        
                        setDb(firestore);
                        setAuth(authInstance);

                        onAuthStateChanged(authInstance, async (user) => {
                            if (user) {
                                setCurrentUser(user);
                                const supervisorsRef = collection(firestore, "supervisors");
                                const q = query(supervisorsRef, where("uid", "==", user.uid));
                                const querySnapshot = await getDocs(q);
                                if (!querySnapshot.empty) {
                                    setUserPermissions({ id: querySnapshot.docs[0].id, ...querySnapshot.docs[0].data() });
                                } else {
                                    setUserPermissions(null); // No permissions found
                                }
                            } else {
                                setCurrentUser(null);
                                setUserPermissions(null);
                            }
                            setAuthLoading(false);
                        });

                        setInitStatus('success');
                    } catch (error) {
                        console.error("Firebase initialization failed:", error);
                        setErrorMsg(`Firebase initialization failed: ${error.message}. Check your config.`);
                        setInitStatus('error');
                    }
                };

                initializeFirebase();
            }, []);

            if (initStatus === 'pending' || authLoading) {
                return <div className="flex justify-center items-center h-screen"><div className="text-xl font-semibold">Initializing...</div></div>;
            }

            if (initStatus === 'error') {
                return (
                    <div className="flex items-center justify-center h-screen p-8">
                        <div className="bg-red-100 border-l-4 border-red-500 text-red-700 p-6 rounded-lg shadow-md max-w-2xl">
                            <p className="font-bold text-xl mb-2">Configuration Error</p>
                            <p>{errorMsg}</p>
                        </div>
                    </div>
                );
            }

            if (!currentUser || !userPermissions) {
                return <LoginPage auth={auth} />;
            }
            
            return <MainApp db={db} auth={auth} userPermissions={userPermissions} />;
        }
        
        function MainApp({ db, auth, userPermissions }) {
            const [currentPage, setCurrentPage] = useState(userPermissions.pagePermissions[0] || 'employees');
            const [isSidebarOpen, setIsSidebarOpen] = useState(false);

            const { data: employees, loading: employeesLoading } = useCollection(db, 'employees');
            const { data: shops, loading: shopsLoading } = useCollection(db, 'shops');
            const { data: positions, loading: positionsLoading } = useCollection(db, 'positions');
            const { data: supervisors, loading: supervisorsLoading } = useCollection(db, 'supervisors');
            const { data: employeeStates, loading: employeeStatesLoading } = useCollection(db, 'employeeStates');
            const { data: staffLoans, loading: staffLoansLoading } = useCollection(db, 'staffLoans');
            const { data: allPayments, loading: allPaymentsLoading } = useCollection(db, 'loanPayments');
            const { data: payrolls, loading: payrollsLoading } = useCollection(db, 'payrolls');
            const { data: otReports, loading: otReportsLoading } = useCollection(db, 'otReports');
            const { data: salaryRevisions, loading: salaryRevisionsLoading } = useCollection(db, 'salaryRevisions');

            const isLoading = employeesLoading || shopsLoading || positionsLoading || supervisorsLoading || employeeStatesLoading || staffLoansLoading || allPaymentsLoading || payrollsLoading || otReportsLoading || salaryRevisionsLoading;
            
            // --- Data Filtering based on User Permissions ---
            const filteredShops = useMemo(() => {
                if (userPermissions.role === 'Admin') return shops;
                return shops.filter(shop => userPermissions.shops.includes(shop.id));
            }, [shops, userPermissions]);

            const filteredEmployees = useMemo(() => {
                if (userPermissions.role === 'Admin') return employees;
                return employees.filter(emp => userPermissions.shops.includes(emp.shop));
            }, [employees, userPermissions]);

            const allowedEmployeeIds = useMemo(() => {
                return new Set(filteredEmployees.map(e => e.id));
            }, [filteredEmployees]);

            const filteredEmployeeStates = useMemo(() => {
                 if (userPermissions.role === 'Admin') return employeeStates;
                return employeeStates.filter(state => userPermissions.shops.includes(state.shopId));
            }, [employeeStates, userPermissions]);

            const filteredStaffLoans = useMemo(() => {
                if (userPermissions.role === 'Admin') return staffLoans;
                return staffLoans.filter(loan => allowedEmployeeIds.has(loan.employeeId));
            }, [staffLoans, allowedEmployeeIds]);

            const filteredAllPayments = useMemo(() => {
                if (userPermissions.role === 'Admin') return allPayments;
                return allPayments.filter(payment => allowedEmployeeIds.has(payment.employeeId));
            }, [allPayments, allowedEmployeeIds]);

            const filteredPayrolls = useMemo(() => {
                if (userPermissions.role === 'Admin') return payrolls;
                return payrolls.filter(p => userPermissions.shops.includes(p.shopId));
            }, [payrolls, userPermissions]);

            const filteredOtReports = useMemo(() => {
                if (userPermissions.role === 'Admin') return otReports;
                return otReports.filter(ot => userPermissions.shops.includes(ot.shopId));
            }, [otReports, userPermissions]);
            
            const filteredSalaryRevisions = useMemo(() => {
                if (userPermissions.role === 'Admin') return salaryRevisions;
                return salaryRevisions.filter(sr => userPermissions.shops.includes(sr.shopId));
            }, [salaryRevisions, userPermissions]);


            const renderPage = () => {
                if (isLoading) {
                    return <div className="flex justify-center items-center h-screen"><div className="text-xl font-semibold">Loading Data...</div></div>;
                }

                if (!userPermissions.pagePermissions.includes(currentPage)) {
                    return <AccessDeniedPage />;
                }

                switch (currentPage) {
                    case 'employees':
                        return <EmployeePage db={db} employees={filteredEmployees} shops={filteredShops} positions={positions} supervisors={supervisors} salaryRevisions={filteredSalaryRevisions} userPermissions={userPermissions} />;
                    case 'employeeState':
                        return <EmployeeStatePage db={db} employeeStates={filteredEmployeeStates} employees={filteredEmployees} shops={filteredShops} />;
                    case 'loanManager':
                        return <LoanManagerPage db={db} auth={auth} staffLoans={filteredStaffLoans} allPayments={filteredAllPayments} employees={filteredEmployees} shops={filteredShops} />;
                    case 'payroll':
                        return <PayrollPage db={db} employees={filteredEmployees} shops={filteredShops} staffLoans={filteredStaffLoans} employeeStates={filteredEmployeeStates} payrolls={filteredPayrolls} otReports={filteredOtReports} />;
                    case 'expenseReport':
                        return <ExpenseReportPage payrolls={filteredPayrolls} shops={filteredShops} />;
                    case 'settings':
                        return <SettingsPage db={db} shops={shops} supervisors={supervisors} positions={positions} />;
                    default:
                        // Fallback to the first permitted page if the current one is somehow invalid
                        const firstPermittedPage = userPermissions.pagePermissions[0] || 'employees';
                        if (currentPage !== firstPermittedPage) {
                           setCurrentPage(firstPermittedPage);
                        }
                        return <AccessDeniedPage />;
                }
            };
            
            return (
                <div className="flex min-h-screen">
                    <Sidebar currentPage={currentPage} setCurrentPage={setCurrentPage} isSidebarOpen={isSidebarOpen} setIsSidebarOpen={setIsSidebarOpen} userPermissions={userPermissions} auth={auth} />
                    <div className="flex-1 md:ml-64">
                         <button onClick={() => setIsSidebarOpen(!isSidebarOpen)} className="md:hidden fixed top-4 right-4 z-40 bg-blue-600 text-white p-2 rounded-full shadow-lg">
                            <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M4 6h16M4 12h16m-7 6h7"></path></svg>
                        </button>
                        <main className="p-4 sm:p-6 lg:p-8">
                            {renderPage()}
                        </main>
                    </div>
                </div>
            );
        }

        function Sidebar({ currentPage, setCurrentPage, isSidebarOpen, setIsSidebarOpen, userPermissions, auth }) {
            const { signOut } = window.firebaseSDK;
            const handleLogout = () => {
                signOut(auth).catch(error => console.error("Logout failed:", error));
            };

            const NavItem = ({ pageName, title, icon }) => {
                if (!userPermissions.pagePermissions.includes(pageName)) {
                    return null;
                }
                return (
                    <button
                        onClick={() => {
                            setCurrentPage(pageName);
                            if (window.innerWidth < 768) {
                               setIsSidebarOpen(false);
                            }
                        }}
                        className={`flex items-center w-full px-4 py-3 text-left transition-colors duration-200 rounded-lg ${
                            currentPage === pageName ? 'bg-blue-600 text-white' : 'text-gray-600 hover:bg-gray-200'
                        }`}
                    >
                        {icon}
                        <span className="font-medium">{title}</span>
                    </button>
                );
            };

            return (
                <>
                    <div
                        className={`fixed inset-0 bg-black bg-opacity-50 z-20 transition-opacity md:hidden ${
                            isSidebarOpen ? 'opacity-100' : 'opacity-0 pointer-events-none'
                        }`}
                        onClick={() => setIsSidebarOpen(false)}
                    ></div>
                    <div className={`fixed top-0 left-0 h-full w-64 bg-white shadow-lg p-4 flex flex-col z-30 transform transition-transform md:translate-x-0 ${isSidebarOpen ? 'translate-x-0' : '-translate-x-full'}`}>
                        <div>
                            <div className="text-2xl font-bold text-gray-800 mb-2">HR Manager</div>
                            <div className="text-sm text-gray-500 mb-8">Welcome, {userPermissions.name}</div>
                        </div>
                        <nav className="flex flex-col space-y-2 flex-grow">
                            <NavItem pageName="employees" title="Employees" icon={<svg className="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M15 21a6 6 0 00-9-5.197M15 11a3 3 0 11-6 0 3 3 0 016 0z" /></svg>} />
                            <NavItem pageName="employeeState" title="Employee State" icon={<svg className="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z" /></svg>} />
                            <NavItem pageName="loanManager" title="Loan Manager" icon={<svg className="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm-1-4h.01M12 16h.01" /></svg>} />
                            <NavItem pageName="payroll" title="Payroll" icon={<svg className="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M9 7h6m0 10v-3.25a3.25 3.25 0 00-3.25-3.25H6.25A3.25 3.25 0 003 16.75V20h12V9.25a3.25 3.25 0 00-3.25-3.25H9.25A3.25 3.25 0 006 9.25V10" /></svg>} />
                            <NavItem pageName="expenseReport" title="Expense Report" icon={<svg className="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>} />
                            <NavItem pageName="settings" title="Settings" icon={<svg className="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" /><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>} />
                        </nav>
                        <div className="mt-auto">
                            <button onClick={handleLogout} className="flex items-center w-full px-4 py-3 text-left text-red-600 hover:bg-red-100 rounded-lg">
                                <svg className="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path></svg>
                                <span>Logout</span>
                            </button>
                        </div>
                    </div>
                </>
            );
        }

        function AccessDeniedPage() {
            return (
                <div className="flex flex-col items-center justify-center h-[calc(100vh-4rem)] text-center p-8">
                    <svg className="w-24 h-24 text-red-500 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636"></path></svg>
                    <h1 className="text-4xl font-bold text-gray-800">Access Denied</h1>
                    <p className="text-gray-500 mt-2">You do not have the necessary permissions to view this page.</p>
                    <p className="text-gray-500 mt-1">Please contact your administrator if you believe this is an error.</p>
                </div>
            );
        }

        // --- PAGE COMPONENTS ---
        function EmployeePage({ db, employees, shops, positions, supervisors, salaryRevisions, userPermissions }) {
            const [isModalOpen, setIsModalOpen] = useState(false);
            const [editingEmployee, setEditingEmployee] = useState(null);
            const [filters, setFilters] = useState({ shop: '', name: '', joinDate: '', status: 'Active' });
            const [activeTab, setActiveTab] = useState('active');

            const TabButton = ({ tabName, title }) => (
                <button
                    onClick={() => setActiveTab(tabName)}
                    className={`px-4 py-2 text-sm font-medium rounded-md transition-colors duration-200 ${
                        activeTab === tabName ? 'bg-blue-600 text-white shadow-md' : 'bg-white text-gray-700 hover:bg-gray-200'
                    }`}
                >
                    {title}
                </button>
            );

            const openModal = useCallback((employee = null) => {
                setEditingEmployee(employee);
                setIsModalOpen(true);
            }, []);
            
            const closeModal = useCallback(() => {
                setIsModalOpen(false);
                setEditingEmployee(null);
            }, []);

            const handleFilterChange = useCallback((e) => {
                const { name, value } = e.target;
                setFilters(prev => ({ ...prev, [name]: value }));
            }, []);
            
            const filteredEmployees = useMemo(() => {
                const listToFilter = activeTab === 'active' 
                    ? employees.filter(e => e.staffStatus === 'Active')
                    : employees.filter(e => e.staffStatus === 'Resigned' || e.staffStatus === 'Terminated');

                return listToFilter.filter(emp => 
                    (!filters.shop || emp.shop === filters.shop) &&
                    (!filters.name || emp.name.toLowerCase().includes(filters.name.toLowerCase())) &&
                    (!filters.joinDate || emp.joinDate === filters.joinDate)
                );
            }, [employees, filters, activeTab]);

            return (
                <div>
                    <header className="mb-8">
                        <h1 className="text-3xl md:text-4xl font-bold text-gray-800">Employee Management</h1>
                        <p className="text-gray-500 mt-1">Add, edit, and manage your employee records.</p>
                    </header>
                    
                    <div className="mb-6">
                        <div className="flex space-x-2 bg-gray-200 p-1 rounded-lg">
                            <TabButton tabName="active" title="Active Employees" />
                            <TabButton tabName="resignedTerminated" title="Resigned/Terminated" />
                            <TabButton tabName="salaryRevise" title="Salary Revise Report" />
                        </div>
                    </div>

                    {activeTab === 'active' && (
                        <>
                            <div className="flex justify-between items-center mb-4">
                                <h2 className="text-2xl font-semibold text-gray-700">Active Employees</h2>
                                <button onClick={() => openModal()} className="bg-blue-600 text-white px-4 py-2 rounded-lg shadow hover:bg-blue-700 transition-colors">
                                    Add Employee
                                </button>
                            </div>
                            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6 p-4 bg-white rounded-lg shadow">
                                <select name="shop" value={filters.shop} onChange={handleFilterChange} className="input">
                                    <option value="">All Shops</option>
                                    {shops.map(s => <option key={s.id} value={s.id}>{s.name}</option>)}
                                </select>
                                <input type="text" name="name" placeholder="Filter by Name..." value={filters.name} onChange={handleFilterChange} className="input" />
                                <input type="date" name="joinDate" value={filters.joinDate} onChange={handleFilterChange} className="input" />
                            </div>
                            <EmployeeHistoryTable db={db} employees={filteredEmployees} onEdit={openModal} shops={shops} positions={positions} supervisors={supervisors} />
                        </>
                    )}

                    {activeTab === 'resignedTerminated' && (
                        <>
                            <h2 className="text-2xl font-semibold text-gray-700 mb-4">Resigned/Terminated Employees</h2>
                            <ResignedTerminatedTable employees={filteredEmployees} shops={shops} />
                        </>
                    )}

                    {activeTab === 'salaryRevise' && (
                        <SalaryReviseTab db={db} employees={employees} shops={shops} salaryRevisions={salaryRevisions} userPermissions={userPermissions} />
                    )}

                    {isModalOpen && <EmployeeModal db={db} employee={editingEmployee} onClose={closeModal} shops={shops} positions={positions} supervisors={supervisors} />}
                </div>
            );
        }

        function EmployeeHistoryTable({ db, employees, onEdit, shops, positions, supervisors }) {
            const handleDelete = async (id) => {
                if (await showConfirmation("Are you sure you want to delete this employee?")) {
                    try {
                        const { doc, deleteDoc } = window.firebaseSDK;
                        await deleteDoc(doc(db, "employees", id));
                    } catch (e) {
                        console.error("Error deleting document: ", e);
                    }
                }
            };
            
            const getNameById = (id, list) => list.find(item => item.id === id)?.name || 'N/A';

            return (
                <div className="bg-white shadow-md rounded-lg overflow-hidden">
                    <div className="overflow-x-auto">
                        <table className="min-w-full divide-y divide-gray-200">
                            <thead className="bg-gray-50">
                                <tr>
                                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
                                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Shop</th>
                                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Position</th>
                                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tel No.</th>
                                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">DOB</th>
                                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Join Date</th>
                                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Salary</th>
                                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Supervisor</th>
                                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                    <th className="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                </tr>
                            </thead>
                            <tbody className="bg-white divide-y divide-gray-200">
                                {employees.length > 0 ? employees.map(emp => (
                                    <tr key={emp.id}>
                                        <td className="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">{emp.name}</td>
                                        <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{getNameById(emp.shop, shops)}</td>
                                        <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{getNameById(emp.position, positions)}</td>
                                        <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{emp.telNo}</td>
                                        <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{formatDate(emp.dob)}</td>
                                        <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{formatDate(emp.joinDate)}</td>
                                        <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{formatCurrency(emp.baseSalary)}</td>
                                        <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{getNameById(emp.supervisor, supervisors)}</td>
                                        <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{emp.staffStatus}</td>
                                        <td className="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                                            <button onClick={() => onEdit(emp)} className="text-indigo-600 hover:text-indigo-900 mr-4">Edit</button>
                                            <button onClick={() => handleDelete(emp.id)} className="text-red-600 hover:text-red-900">Delete</button>
                                        </td>
                                    </tr>
                                )) : (
                                    <tr><td colSpan="10" className="text-center py-10 text-gray-500">No employees found.</td></tr>
                                )}
                            </tbody>
                        </table>
                    </div>
                </div>
            );
        }
        
        function ResignedTerminatedTable({ employees, shops }) {
            const getNameById = (id, list) => list.find(item => item.id === id)?.name || 'N/A';

            return (
                <div className="bg-white shadow-md rounded-lg overflow-hidden">
                    <div className="overflow-x-auto">
                        <table className="min-w-full divide-y divide-gray-200">
                            <thead className="bg-gray-50">
                                <tr>
                                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
                                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Shop</th>
                                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Join Date</th>
                                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Staff Status</th>
                                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Time Log</th>
                                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Reason</th>
                                </tr>
                            </thead>
                            <tbody className="bg-white divide-y divide-gray-200">
                                {employees.length > 0 ? employees.map(emp => (
                                    <tr key={emp.id}>
                                        <td className="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">{emp.name}</td>
                                        <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{getNameById(emp.shop, shops)}</td>
                                        <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{formatDate(emp.joinDate)}</td>
                                        <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{emp.staffStatus}</td>
                                        <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{formatDate(emp.statusChangeDate)}</td>
                                        <td className="px-6 py-4 text-sm text-gray-500">{emp.reason}</td>
                                    </tr>
                                )) : (
                                    <tr><td colSpan="6" className="text-center py-10 text-gray-500">No resigned or terminated employees found.</td></tr>
                                )}
                            </tbody>
                        </table>
                    </div>
                </div>
            )
        }

        function EmployeeModal({ db, employee, onClose, shops, positions, supervisors }) {
            const [formData, setFormData] = useState({
                name: '', sex: 'Male', dob: '', nationalId: '', telNo: '', shop: '', position: '',
                shift: 'AM', joinDate: '', baseSalary: '', supervisor: '', staffStatus: 'Active',
                address: '', note: '', statusChangeDate: null, reason: '',
                ...employee
            });
            const [isSaving, setIsSaving] = useState(false);

            const handleChange = (e) => {
                const { name, value } = e.target;
                setFormData(prev => ({ ...prev, [name]: value }));
            };

            const handleSubmit = async (e) => {
                e.preventDefault();
                setIsSaving(true);
                
                let dataToSave = { ...formData };
                
                if ((dataToSave.staffStatus === 'Resigned' || dataToSave.staffStatus === 'Terminated') && employee?.staffStatus === 'Active') {
                    dataToSave.statusChangeDate = new Date().toISOString().slice(0, 10);
                }

                try {
                    const { doc, updateDoc, addDoc, collection } = window.firebaseSDK;
                    if (employee) {
                        await updateDoc(doc(db, "employees", employee.id), dataToSave);
                    } else {
                        await addDoc(collection(db, "employees"), dataToSave);
                    }
                    onClose();
                } catch (err) {
                    console.error("Error saving employee:", err);
                } finally {
                    setIsSaving(false);
                }
            };

            return (
                <div className="modal-overlay">
                    <div className="modal-content">
                        <h3 className="text-xl font-semibold mb-4">{employee ? 'Edit Employee' : 'Add New Employee'}</h3>
                        <form onSubmit={handleSubmit} className="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div><label className="block text-sm font-medium text-gray-700">Name</label><input type="text" name="name" value={formData.name} onChange={handleChange} className="input" required /></div>
                            <div><label className="block text-sm font-medium text-gray-700">Sex</label><select name="sex" value={formData.sex} onChange={handleChange} className="input"><option>Male</option><option>Female</option></select></div>
                            <div><label className="block text-sm font-medium text-gray-700">Date of Birth</label><input type="date" name="dob" value={formData.dob} onChange={handleChange} className="input" /></div>
                            <div><label className="block text-sm font-medium text-gray-700">National ID</label><input type="text" name="nationalId" value={formData.nationalId} onChange={handleChange} className="input" /></div>
                            <div><label className="block text-sm font-medium text-gray-700">Tel No.</label><input type="text" name="telNo" value={formData.telNo} onChange={handleChange} className="input" required /></div>
                            <div><label className="block text-sm font-medium text-gray-700">Shop</label><select name="shop" value={formData.shop} onChange={handleChange} className="input" required><option value="">Select Shop</option>{shops.map(s => <option key={s.id} value={s.id}>{s.name}</option>)}</select></div>
                            <div><label className="block text-sm font-medium text-gray-700">Position</label><select name="position" value={formData.position} onChange={handleChange} className="input" required><option value="">Select Position</option>{positions.map(p => <option key={p.id} value={p.id}>{p.name}</option>)}</select></div>
                            <div><label className="block text-sm font-medium text-gray-700">Shift</label><select name="shift" value={formData.shift} onChange={handleChange} className="input"><option>AM</option><option>PM</option><option>APM</option></select></div>
                            <div><label className="block text-sm font-medium text-gray-700">Join Date</label><input type="date" name="joinDate" value={formData.joinDate} onChange={handleChange} className="input" required /></div>
                            <div><label className="block text-sm font-medium text-gray-700">Base Salary</label><input type="number" name="baseSalary" value={formData.baseSalary} onChange={handleChange} className="input" /></div>
                            <div><label className="block text-sm font-medium text-gray-700">Supervisor</label><select name="supervisor" value={formData.supervisor} onChange={handleChange} className="input"><option value="">Select Supervisor</option>{supervisors.map(s => <option key={s.id} value={s.id}>{s.name}</option>)}</select></div>
                            <div><label className="block text-sm font-medium text-gray-700">Staff Status</label><select name="staffStatus" value={formData.staffStatus} onChange={handleChange} className="input"><option>Active</option><option>Resigned</option><option>Terminated</option></select></div>
                            
                            {(formData.staffStatus === 'Resigned' || formData.staffStatus === 'Terminated') && (
                                <div className="md:col-span-2"><label className="block text-sm font-medium text-gray-700">Reason</label><textarea name="reason" value={formData.reason} onChange={handleChange} rows="2" className="input"></textarea></div>
                            )}

                            <div className="md:col-span-2"><label className="block text-sm font-medium text-gray-700">Address</label><textarea name="address" value={formData.address} onChange={handleChange} rows="2" className="input"></textarea></div>
                            <div className="md:col-span-2"><label className="block text-sm font-medium text-gray-700">Note</label><textarea name="note" value={formData.note} onChange={handleChange} rows="2" className="input"></textarea></div>
                            
                            <div className="md:col-span-2 mt-6 flex justify-end space-x-3">
                                <button type="button" onClick={onClose} className="bg-white py-2 px-4 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 hover:bg-gray-50">Cancel</button>
                                <button type="submit" disabled={isSaving} className="bg-blue-600 py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white hover:bg-blue-700 disabled:bg-blue-300">{isSaving ? 'Saving...' : 'Save'}</button>
                            </div>
                        </form>
                    </div>
                </div>
            );
        }

        function EmployeeStatePage({ db, employeeStates, employees, shops }) {
            return (
                <div>
                    <header className="mb-8">
                        <h1 className="text-3xl md:text-4xl font-bold text-gray-800">Employee State</h1>
                        <p className="text-gray-500 mt-1">Track employee deductions and engagements.</p>
                    </header>
                    <DeductionEngagementTab db={db} employeeStates={employeeStates} employees={employees} shops={shops} />
                </div>
            );
        }

        function DeductionEngagementTab({ db, employeeStates, employees, shops }) {
            const [isModalOpen, setIsModalOpen] = useState(false);
            const [editingState, setEditingState] = useState(null);
            const [filters, setFilters] = useState({ shopId: '', employeeId: '', month: '', statusState: '' });

            const handleFilterChange = (e) => {
                const { name, value } = e.target;
                setFilters(prev => ({ ...prev, [name]: value }));
            };

            const filteredEmployeeStates = useMemo(() => {
                return employeeStates.filter(state => {
                    if (!state.date) return false;
                    const [year, month] = state.date.split('-');
                    const stateMonth = `${year}-${month}`;

                    const shopMatch = !filters.shopId || state.shopId === filters.shopId;
                    const employeeMatch = !filters.employeeId || state.employeeId === filters.employeeId;
                    const monthMatch = !filters.month || stateMonth === filters.month;
                    const statusMatch = !filters.statusState || state.statusState === filters.statusState;

                    return shopMatch && employeeMatch && monthMatch && statusMatch;
                });
            }, [employeeStates, filters]);
            
            const openModal = (state = null) => {
                setEditingState(state);
                setIsModalOpen(true);
            };

            const closeModal = () => {
                setEditingState(null);
                setIsModalOpen(false);
            };

            const handleDelete = async (id) => {
                if (await showConfirmation("Are you sure you want to delete this record?")) {
                    try {
                        const { doc, deleteDoc } = window.firebaseSDK;
                        await deleteDoc(doc(db, "employeeStates", id));
                    } catch (e) {
                        console.error("Error deleting document: ", e);
                    }
                }
            };
            
            const getNameById = (id, list) => list.find(item => item.id === id)?.name || 'N/A';

            return (
                <div>
                    <div className="flex justify-end mb-4">
                        <button onClick={() => openModal()} className="bg-blue-600 text-white px-4 py-2 rounded-lg shadow hover:bg-blue-700 transition-colors">
                            Add New Record
                        </button>
                    </div>

                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6 p-4 bg-white rounded-lg shadow">
                        <select name="shopId" value={filters.shopId} onChange={handleFilterChange} className="input">
                            <option value="">Filter by Shop</option>
                            {shops.map(s => <option key={s.id} value={s.id}>{s.name}</option>)}
                        </select>
                        <select name="employeeId" value={filters.employeeId} onChange={handleFilterChange} className="input">
                            <option value="">Filter by Employee</option>
                            {employees
                                .filter(e => !filters.shopId || e.shop === filters.shopId)
                                .map(e => <option key={e.id} value={e.id}>{e.name}</option>)}
                        </select>
                        <input type="month" name="month" value={filters.month} onChange={handleFilterChange} className="input" />
                        <select name="statusState" value={filters.statusState} onChange={handleFilterChange} className="input">
                            <option value="">All Statuses</option>
                            <option value="Deduction">Deduction</option>
                            <option value="Engagement">Engagement</option>
                        </select>
                    </div>

                    {isModalOpen && <DeductionEngagementModal db={db} state={editingState} onClose={closeModal} employees={employees} shops={shops} />}

                    <div className="bg-white shadow-md rounded-lg overflow-hidden">
                        <div className="overflow-x-auto">
                            <table className="min-w-full divide-y divide-gray-200">
                                <thead className="bg-gray-50">
                                    <tr>
                                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Staff Name</th>
                                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Shop</th>
                                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status State</th>
                                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Amount (KHR)</th>
                                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Note</th>
                                        <th className="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                    </tr>
                                </thead>
                                <tbody className="bg-white divide-y divide-gray-200">
                                    {filteredEmployeeStates.map(state => (
                                        <tr key={state.id}>
                                            <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{formatDate(state.date)}</td>
                                            <td className="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">{getNameById(state.employeeId, employees)}</td>
                                            <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{getNameById(state.shopId, shops)}</td>
                                            <td className={`px-6 py-4 whitespace-nowrap text-sm font-semibold ${state.statusState === 'Deduction' ? 'text-red-600' : 'text-blue-600'}`}>{state.statusState}</td>
                                            <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{formatCurrency(state.amount)}</td>
                                            <td className="px-6 py-4 text-sm text-gray-500">{state.note}</td>
                                            <td className="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                                                <button onClick={() => openModal(state)} className="text-indigo-600 hover:text-indigo-900 mr-4">Edit</button>
                                                <button onClick={() => handleDelete(state.id)} className="text-red-600 hover:text-red-900">Delete</button>
                                            </td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            )
        }
        
        function DeductionEngagementModal({ db, state, onClose, employees, shops }) {
            const initialFormState = {
                date: new Date().toISOString().slice(0, 10),
                shopId: '', employeeId: '', statusState: 'Deduction', amount: '', note: ''
            };
            const [formData, setFormData] = useState(state || initialFormState);
            const [filteredEmployees, setFilteredEmployees] = useState([]);
            const [isSaving, setIsSaving] = useState(false);

            useEffect(() => {
                if(formData.shopId) {
                    setFilteredEmployees(employees.filter(emp => emp.shop === formData.shopId && emp.staffStatus === 'Active'));
                }
            }, [formData.shopId, employees]);

            const handleShopChange = (e) => {
                const shopId = e.target.value;
                setFormData(prev => ({ ...prev, shopId, employeeId: '' }));
            };

            const handleChange = (e) => {
                const { name, value } = e.target;
                setFormData(prev => ({ ...prev, [name]: value }));
            };

            const handleSubmit = async (e) => {
                e.preventDefault();
                if (!formData.employeeId || !formData.shopId) {
                    alert("Please select a shop and employee.");
                    return;
                }
                setIsSaving(true);
                try {
                    const { doc, updateDoc, addDoc, collection } = window.firebaseSDK;
                    if (state) {
                        const { id, ...dataToUpdate } = formData;
                        await updateDoc(doc(db, "employeeStates", id), dataToUpdate);
                    } else {
                        await addDoc(collection(db, "employeeStates"), formData);
                    }
                    onClose();
                } catch (error) {
                    console.error("Error saving employee state: ", error);
                } finally {
                    setIsSaving(false);
                }
            };

            return (
                <div className="modal-overlay">
                    <div className="modal-content">
                        <h3 className="text-xl font-semibold mb-4">{state ? 'Edit Record' : 'Add New Record'}</h3>
                        <form onSubmit={handleSubmit} className="space-y-4">
                            <div><label className="block text-sm font-medium text-gray-700">Date</label><input type="date" name="date" value={formData.date} onChange={handleChange} className="input" required /></div>
                            <div>
                                <label className="block text-sm font-medium text-gray-700">Shop</label>
                                <select name="shopId" value={formData.shopId} onChange={handleShopChange} className="input" required>
                                    <option value="">Select Shop</option>
                                    {shops.map(shop => <option key={shop.id} value={shop.id}>{shop.name}</option>)}
                                </select>
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-gray-700">Staff Name</label>
                                <select name="employeeId" value={formData.employeeId} onChange={handleChange} className="input" required disabled={!formData.shopId}>
                                    <option value="">Select Staff</option>
                                    {filteredEmployees.map(emp => <option key={emp.id} value={emp.id}>{emp.name}</option>)}
                                </select>
                            </div>
                            <div><label className="block text-sm font-medium text-gray-700">Status State</label><select name="statusState" value={formData.statusState} onChange={handleChange} className="input"><option>Deduction</option><option>Engagement</option></select></div>
                            <div><label className="block text-sm font-medium text-gray-700">Amount (KHR)</label><input type="number" name="amount" value={formData.amount} onChange={handleChange} className="input" required /></div>
                            <div><label className="block text-sm font-medium text-gray-700">Note</label><textarea name="note" value={formData.note} onChange={handleChange} rows="3" className="input"></textarea></div>
                            <div className="flex justify-end space-x-3 pt-4">
                                <button type="button" onClick={onClose} className="bg-white py-2 px-4 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 hover:bg-gray-50">Cancel</button>
                                <button type="submit" disabled={isSaving} className="bg-blue-600 text-white px-4 py-2 rounded-lg shadow hover:bg-blue-700">{isSaving ? 'Saving...' : 'Save'}</button>
                            </div>
                        </form>
                    </div>
                </div>
            );
        }
        
        // --- LOAN MANAGER COMPONENTS ---
        
        function LoanPaymentModal({ db, loan, onClose }) {
            const [paymentAmount, setPaymentAmount] = useState('');
            const [paymentDate, setPaymentDate] = useState(new Date().toISOString().slice(0, 10));
            const [note, setNote] = useState('');
            const [isSaving, setIsSaving] = useState(false);

            const handleSubmit = async (e) => {
                e.preventDefault();
                const amount = parseFloat(paymentAmount);
                if (isNaN(amount) || amount <= 0) {
                    alert("Please enter a valid payment amount.");
                    return;
                }
                
                setIsSaving(true);
                try {
                    const { runTransaction, doc, collection } = window.firebaseSDK;
                    await runTransaction(db, async (transaction) => {
                        const loanRef = doc(db, "staffLoans", loan.id);
                        const loanDoc = await transaction.get(loanRef);

                        if (!loanDoc.exists()) {
                            throw "Loan document does not exist!";
                        }

                        const currentTotalPaid = loanDoc.data().totalPaid || 0;
                        const newTotalPaid = currentTotalPaid + amount;
                        const newStatus = newTotalPaid >= loanDoc.data().loanAmount ? "Paid Off" : "Active";
                        
                        transaction.update(loanRef, { 
                            totalPaid: newTotalPaid,
                            status: newStatus
                        });

                        const paymentRef = doc(collection(db, "loanPayments"));
                        transaction.set(paymentRef, {
                            loanId: loan.id,
                            employeeId: loan.employeeId,
                            paymentAmount: amount,
                            paymentDate,
                            note
                        });
                    });
                    onClose();
                } catch (error) {
                    console.error("Transaction failed: ", error);
                    alert("Failed to save payment. Please try again.");
                } finally {
                    setIsSaving(false);
                }
            };

            return (
                <div className="modal-overlay">
                    <div className="modal-content">
                        <h3 className="text-xl font-semibold mb-4">Make a Payment</h3>
                        <form onSubmit={handleSubmit}>
                            <div className="mb-4">
                                <label className="block text-sm font-medium text-gray-700">Payment Date</label>
                                <input type="date" value={paymentDate} onChange={e => setPaymentDate(e.target.value)} className="input" required />
                            </div>
                             <div className="mb-4">
                                <label className="block text-sm font-medium text-gray-700">Payment Amount (KHR)</label>
                                <input type="number" value={paymentAmount} onChange={e => setPaymentAmount(e.target.value)} className="input" placeholder="0.00" required />
                            </div>
                             <div className="mb-4">
                                <label className="block text-sm font-medium text-gray-700">Note</label>
                                <textarea value={note} onChange={e => setNote(e.target.value)} rows="3" className="input"></textarea>
                            </div>
                            <div className="mt-6 flex justify-end space-x-3">
                                <button type="button" onClick={onClose} className="bg-white py-2 px-4 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 hover:bg-gray-50">Cancel</button>
                                <button type="submit" disabled={isSaving} className="bg-blue-600 py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white hover:bg-blue-700 disabled:bg-blue-300">{isSaving ? 'Saving...' : 'Save Payment'}</button>
                            </div>
                        </form>
                    </div>
                </div>
            );
        }

        function ActiveLoansTab({ db, staffLoans, employees, shops }) {
            const [isAddLoanModalOpen, setAddLoanModalOpen] = useState(false);
            const [isPaymentModalOpen, setPaymentModalOpen] = useState(false);
            const [isEditLoanModalOpen, setEditLoanModalOpen] = useState(false);
            const [selectedLoan, setSelectedLoan] = useState(null);
            const [filteredEmployees, setFilteredEmployees] = useState([]);
            const initialFormState = { shopId: '', employeeId: '', loanAmount: '', agreedMonthlyDeduction: '', loanDate: new Date().toISOString().slice(0, 10), reason: '' };
            const [formData, setFormData] = useState(initialFormState);

            const getNameById = (id, list) => list.find(item => item.id === id)?.name || 'N/A';

            const handleShopChange = (e) => {
                const shopId = e.target.value;
                setFormData({ ...formData, shopId, employeeId: '' });
                setFilteredEmployees(employees.filter(emp => emp.shop === shopId && emp.staffStatus === 'Active'));
            };

            const handleChange = (e) => {
                const { name, value } = e.target;
                setFormData({ ...formData, [name]: value });
            };

            const handleAddLoan = async (e) => {
                e.preventDefault();
                
                const { collection, addDoc } = window.firebaseSDK;
                const loansRef = collection(db, "staffLoans");
                
                // For simplicity, this implementation adds a new loan record instead of updating an existing one.
                // A more complex implementation could check for existing active loans and merge them.
                const dataToSave = {
                    ...formData,
                    loanAmount: parseFloat(formData.loanAmount),
                    agreedMonthlyDeduction: parseFloat(formData.agreedMonthlyDeduction) || 0,
                    totalPaid: 0,
                    status: 'Active'
                };
                await addDoc(loansRef, dataToSave);

                setFormData(initialFormState);
                setFilteredEmployees([]);
                setAddLoanModalOpen(false);
            };

            const handleEditLoan = (loan) => {
                setSelectedLoan(loan);
                setEditLoanModalOpen(true);
            };
            
            const handleUpdateLoan = async (e) => {
                e.preventDefault();
                const { id, ...dataToUpdate } = selectedLoan;
                dataToUpdate.agreedMonthlyDeduction = parseFloat(dataToUpdate.agreedMonthlyDeduction) || 0;
                const { doc, updateDoc } = window.firebaseSDK;
                await updateDoc(doc(db, "staffLoans", id), dataToUpdate);
                setEditLoanModalOpen(false);
                setSelectedLoan(null);
            };

            const handleDeleteLoan = async (loanId) => {
                 if (await showConfirmation("Are you sure you want to delete this loan? This will also delete all associated payment history.")) {
                    try {
                        const { collection, query, where, getDocs, writeBatch, doc } = window.firebaseSDK;
                        const paymentsRef = collection(db, "loanPayments");
                        const q = query(paymentsRef, where("loanId", "==", loanId));
                        const querySnapshot = await getDocs(q);
                        
                        const batch = writeBatch(db);
                        querySnapshot.forEach(docSnapshot => {
                            batch.delete(docSnapshot.ref);
                        });
                        
                        const loanRef = doc(db, "staffLoans", loanId);
                        batch.delete(loanRef);

                        await batch.commit();
                    } catch (e) {
                        console.error("Error deleting loan and payments:", e);
                    }
                }
            };
            
            const openPaymentModal = (loan) => {
                setSelectedLoan(loan);
                setPaymentModalOpen(true);
            };

            const activeLoans = useMemo(() => staffLoans.filter(loan => loan.status === 'Active'), [staffLoans]);

            return (
                <div>
                    <div className="flex justify-end mb-4">
                        <button onClick={() => setAddLoanModalOpen(true)} className="bg-blue-600 text-white px-4 py-2 rounded-lg shadow hover:bg-blue-700">Add New Loan</button>
                    </div>

                    {isAddLoanModalOpen && (
                        <div className="modal-overlay">
                            <div className="modal-content">
                                <h3 className="text-xl font-semibold mb-4">Add New Loan</h3>
                                <form onSubmit={handleAddLoan} className="space-y-4">
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700">Shop</label>
                                        <select name="shopId" value={formData.shopId} onChange={handleShopChange} className="input" required>
                                            <option value="">Select Shop</option>
                                            {shops.map(shop => <option key={shop.id} value={shop.id}>{shop.name}</option>)}
                                        </select>
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700">Employee</label>
                                        <select name="employeeId" value={formData.employeeId} onChange={handleChange} className="input" required disabled={!formData.shopId}>
                                            <option value="">Select Employee</option>
                                            {filteredEmployees.map(emp => <option key={emp.id} value={emp.id}>{emp.name}</option>)}
                                        </select>
                                    </div>
                                    <div><label className="block text-sm font-medium text-gray-700">Loan Date</label><input type="date" name="loanDate" value={formData.loanDate} onChange={handleChange} className="input" required /></div>
                                    <div><label className="block text-sm font-medium text-gray-700">Loan Amount (KHR)</label><input type="number" name="loanAmount" value={formData.loanAmount} onChange={handleChange} className="input" required /></div>
                                    <div><label className="block text-sm font-medium text-gray-700">Agreed Monthly Deduction (KHR)</label><input type="number" name="agreedMonthlyDeduction" value={formData.agreedMonthlyDeduction} onChange={handleChange} className="input" /></div>
                                    <div><label className="block text-sm font-medium text-gray-700">Reason</label><textarea name="reason" value={formData.reason} onChange={handleChange} rows="3" className="input"></textarea></div>
                                    <div className="flex justify-end space-x-3 pt-4">
                                        <button type="button" onClick={() => setAddLoanModalOpen(false)} className="bg-white py-2 px-4 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 hover:bg-gray-50">Cancel</button>
                                        <button type="submit" className="bg-blue-600 text-white px-4 py-2 rounded-lg shadow hover:bg-blue-700">Save Loan</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    )}

                    {isEditLoanModalOpen && selectedLoan && (
                        <div className="modal-overlay">
                            <div className="modal-content">
                                <h3 className="text-xl font-semibold mb-4">Edit Loan</h3>
                                <form onSubmit={handleUpdateLoan} className="space-y-4">
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700">Employee</label>
                                        <input type="text" value={getNameById(selectedLoan.employeeId, employees)} className="input bg-gray-100" readOnly />
                                    </div>
                                    <div><label className="block text-sm font-medium text-gray-700">Loan Date</label><input type="date" value={selectedLoan.loanDate} onChange={(e) => setSelectedLoan({...selectedLoan, loanDate: e.target.value})} className="input" required /></div>
                                    <div><label className="block text-sm font-medium text-gray-700">Loan Amount (KHR)</label><input type="number" value={selectedLoan.loanAmount} onChange={(e) => setSelectedLoan({...selectedLoan, loanAmount: parseFloat(e.target.value)})} className="input" required /></div>
                                    <div><label className="block text-sm font-medium text-gray-700">Agreed Monthly Deduction (KHR)</label><input type="number" value={selectedLoan.agreedMonthlyDeduction || ''} onChange={(e) => setSelectedLoan({...selectedLoan, agreedMonthlyDeduction: e.target.value})} className="input" /></div>
                                    <div><label className="block text-sm font-medium text-gray-700">Reason</label><textarea value={selectedLoan.reason} onChange={(e) => setSelectedLoan({...selectedLoan, reason: e.target.value})} rows="3" className="input"></textarea></div>
                                    <div className="flex justify-end space-x-3 pt-4">
                                        <button type="button" onClick={() => setEditLoanModalOpen(false)} className="bg-white py-2 px-4 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 hover:bg-gray-50">Cancel</button>
                                        <button type="submit" className="bg-blue-600 text-white px-4 py-2 rounded-lg shadow hover:bg-blue-700">Update Loan</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    )}
                    
                    {isPaymentModalOpen && <LoanPaymentModal db={db} loan={selectedLoan} onClose={() => setPaymentModalOpen(false)} />}

                    <div className="bg-white shadow-md rounded-lg overflow-hidden">
                        <div className="overflow-x-auto">
                            <table className="min-w-full divide-y divide-gray-200">
                                <thead className="bg-gray-50">
                                    <tr>
                                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Employee</th>
                                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Shop</th>
                                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Loan Date</th>
                                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Loan Amount</th>
                                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Monthly Ded.</th>
                                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Paid</th>
                                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Balance</th>
                                        <th className="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">Action</th>
                                    </tr>
                                </thead>
                                <tbody className="bg-white divide-y divide-gray-200">
                                    {activeLoans.map(loan => {
                                        const balance = loan.loanAmount - (loan.totalPaid || 0);
                                        return (
                                        <tr key={loan.id}>
                                            <td className="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">{getNameById(loan.employeeId, employees)}</td>
                                            <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{getNameById(employees.find(e => e.id === loan.employeeId)?.shop, shops)}</td>
                                            <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{formatDate(loan.loanDate)}</td>
                                            <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{formatCurrency(loan.loanAmount)}</td>
                                            <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{formatCurrency(loan.agreedMonthlyDeduction)}</td>
                                            <td className="px-6 py-4 whitespace-nowrap text-sm text-green-600">{formatCurrency(loan.totalPaid)}</td>
                                            <td className="px-6 py-4 whitespace-nowrap text-sm text-red-600">{formatCurrency(balance)}</td>
                                            <td className="px-6 py-4 whitespace-nowrap text-right text-sm font-medium space-x-4">
                                                <button onClick={() => openPaymentModal(loan)} className="text-green-600 hover:text-green-900">Payment</button>
                                                <button onClick={() => handleEditLoan(loan)} className="text-indigo-600 hover:text-indigo-900">Edit</button>
                                                <button onClick={() => handleDeleteLoan(loan.id)} className="text-red-600 hover:text-red-900">Delete</button>
                                            </td>
                                        </tr>
                                    )})}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            )
        }
        
        function HistoryReportTab({ allPayments, employees, shops, staffLoans }) {
            const [filters, setFilters] = useState({ employeeId: '', shopId: '' });

            const handleFilterChange = (e) => {
                const { name, value } = e.target;
                setFilters(prev => ({ ...prev, [name]: value }));
            };

            const getNameById = (id, list) => list.find(item => item.id === id)?.name || 'N/A';
            
            const paymentsWithBalance = useMemo(() => {
                if (!allPayments || !staffLoans) return [];

                const loanMap = new Map(staffLoans.map(loan => [loan.id, loan]));
                
                const paymentsByLoan = allPayments.reduce((acc, p) => {
                    if (!acc[p.loanId]) acc[p.loanId] = [];
                    acc[p.loanId].push(p);
                    return acc;
                }, {});

                const finalPayments = [];
                for (const loanId in paymentsByLoan) {
                    const loan = loanMap.get(loanId);
                    if (!loan) continue;

                    const loanPayments = paymentsByLoan[loanId];
                    loanPayments.sort((a, b) => new Date(a.paymentDate) - new Date(b.paymentDate));
                    
                    let totalPaidSoFar = 0;
                    for (const payment of loanPayments) {
                        totalPaidSoFar += payment.paymentAmount;
                        finalPayments.push({
                            ...payment,
                            remainingBalance: loan.loanAmount - totalPaidSoFar,
                        });
                    }
                }
                
                return finalPayments.sort((a, b) => new Date(b.paymentDate) - new Date(a.paymentDate));

            }, [allPayments, staffLoans]);

            const filteredPayments = useMemo(() => {
                return paymentsWithBalance.filter(payment => {
                    const employee = employees.find(e => e.id === payment.employeeId);
                    const employeeMatch = !filters.employeeId || payment.employeeId === filters.employeeId;
                    const shopMatch = !filters.shopId || (employee && employee.shop === filters.shopId);
                    return employeeMatch && shopMatch;
                });
            }, [paymentsWithBalance, employees, filters]);

            return (
                <div>
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6 p-4 bg-white rounded-lg shadow">
                         <select name="shopId" value={filters.shopId} onChange={handleFilterChange} className="input">
                            <option value="">Filter by Shop</option>
                            {shops.map(s => <option key={s.id} value={s.id}>{s.name}</option>)}
                        </select>
                        <select name="employeeId" value={filters.employeeId} onChange={handleFilterChange} className="input">
                            <option value="">Filter by Employee</option>
                            {employees.map(e => <option key={e.id} value={e.id}>{e.name}</option>)}
                        </select>
                    </div>
                    <div className="bg-white shadow-md rounded-lg overflow-hidden">
                        <div className="overflow-x-auto">
                            <table className="min-w-full divide-y divide-gray-200">
                                <thead className="bg-gray-50">
                                    <tr>
                                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Payment Date</th>
                                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Employee</th>
                                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Shop</th>
                                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Amount Paid</th>
                                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Remain Balance</th>
                                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Note</th>
                                    </tr>
                                </thead>
                                <tbody className="bg-white divide-y divide-gray-200">
                                    {filteredPayments.map(payment => (
                                        <tr key={payment.id}>
                                            <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{formatDate(payment.paymentDate)}</td>
                                            <td className="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">{getNameById(payment.employeeId, employees)}</td>
                                            <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{getNameById(employees.find(e => e.id === payment.employeeId)?.shop, shops)}</td>
                                            <td className="px-6 py-4 whitespace-nowrap text-sm text-green-600">{formatCurrency(payment.paymentAmount)}</td>
                                            <td className="px-6 py-4 whitespace-nowrap text-sm text-red-600">{formatCurrency(payment.remainingBalance)}</td>
                                            <td className="px-6 py-4 text-sm text-gray-500">{payment.note}</td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            );
        }

        function LoanManagerPage({ db, auth, staffLoans, allPayments, employees, shops }) {
            const [activeTab, setActiveTab] = useState('activeLoans');

            const TabButton = ({ tabName, title }) => (
                <button
                    onClick={() => setActiveTab(tabName)}
                    className={`px-4 py-2 text-sm font-medium rounded-md transition-colors duration-200 ${
                        activeTab === tabName ? 'bg-blue-600 text-white shadow-md' : 'bg-white text-gray-700 hover:bg-gray-200'
                    }`}
                >
                    {title}
                </button>
            );

            return (
                 <div>
                    <header className="mb-8">
                        <h1 className="text-3xl md:text-4xl font-bold text-gray-800">Loan Manager</h1>
                        <p className="text-gray-500 mt-1">Manage and track employee loans.</p>
                    </header>
                    <div className="mb-6">
                        <div className="flex space-x-2 bg-gray-200 p-1 rounded-lg">
                            <TabButton tabName="activeLoans" title="Active Loans" />
                            <TabButton tabName="historyReport" title="History Report" />
                        </div>
                    </div>
                    {activeTab === 'activeLoans' && <ActiveLoansTab db={db} staffLoans={staffLoans} employees={employees} shops={shops} />}
                    {activeTab === 'historyReport' && <HistoryReportTab allPayments={allPayments} employees={employees} shops={shops} staffLoans={staffLoans} />}
                </div>
            );
        }

        function PayrollPage({ db, employees, shops, staffLoans, employeeStates, payrolls, otReports }) {
            const [activeTab, setActiveTab] = useState('calculator');
            const [payrollToEdit, setPayrollToEdit] = useState(null);

            const handleEdit = (payrollRecord) => {
                setPayrollToEdit(payrollRecord);
                setActiveTab('calculator');
            };

            const TabButton = ({ tabName, title }) => (
                <button
                    onClick={() => setActiveTab(tabName)}
                    className={`px-4 py-2 text-sm font-medium rounded-md transition-colors duration-200 ${
                        activeTab === tabName ? 'bg-blue-600 text-white shadow-md' : 'bg-white text-gray-700 hover:bg-gray-200'
                    }`}
                >
                    {title}
                </button>
            );

            return (
                <div>
                     <header className="mb-8">
                        <h1 className="text-3xl md:text-4xl font-bold text-gray-800">Payroll</h1>
                        <p className="text-gray-500 mt-1">Calculate and manage employee payroll.</p>
                    </header>
                    <div className="mb-6">
                        <div className="flex space-x-2 bg-gray-200 p-1 rounded-lg">
                            <TabButton tabName="calculator" title="Payroll Calculator" />
                            <TabButton tabName="history" title="Payroll History" />
                            <TabButton tabName="otReport" title="OT Report" />
                        </div>
                    </div>
                    {activeTab === 'calculator' && <PayrollCalculator db={db} employees={employees} shops={shops} staffLoans={staffLoans} employeeStates={employeeStates} payrollToEdit={payrollToEdit} setPayrollToEdit={setPayrollToEdit} otReports={otReports} />}
                    {activeTab === 'history' && <PayrollHistory db={db} payrolls={payrolls} employees={employees} shops={shops} onEdit={handleEdit} />}
                    {activeTab === 'otReport' && <OTReportTab db={db} otReports={otReports} employees={employees} shops={shops} />}
                </div>
            );
        }

        function PayrollCalculator({ db, employees, shops, staffLoans, employeeStates, payrollToEdit, setPayrollToEdit, otReports }) {
            const [currentDate, setCurrentDate] = useState('');
            const [selectedShop, setSelectedShop] = useState('');
            const [selectedEmployeeId, setSelectedEmployeeId] = useState('');
            const [payrollInput, setPayrollInput] = useState({ workDay: '', givenOff: '', leaveNo: '', loanDed: '', note: '' });
            const [isSaving, setIsSaving] = useState(false);
            const [editingPayrollId, setEditingPayrollId] = useState(null);
            const payrollRef = useRef(null);
            
            useEffect(() => {
                const today = new Date();
                const year = today.getFullYear();
                const month = String(today.getMonth() + 1).padStart(2, '0');
                setCurrentDate(`${year}-${month}`);
            }, []);
            
            useEffect(() => {
                if (payrollToEdit) {
                    setCurrentDate(payrollToEdit.payrollMonth);
                    setSelectedShop(payrollToEdit.shopId);
                    setEditingPayrollId(payrollToEdit.id);
                    setTimeout(() => {
                        setSelectedEmployeeId(payrollToEdit.employeeId);
                        setPayrollInput({
                            workDay: payrollToEdit.workDay || '',
                            givenOff: payrollToEdit.givenOff || '',
                            leaveNo: payrollToEdit.leaveNo || '',
                            loanDed: payrollToEdit.loanDed || '',
                            note: payrollToEdit.note || '',
                        });
                    }, 0);
                    
                    setPayrollToEdit(null);
                }
            }, [payrollToEdit, setPayrollToEdit]);


            const selectedEmployee = useMemo(() => {
                return employees.find(emp => emp.id === selectedEmployeeId) || null;
            }, [selectedEmployeeId, employees]);
            
            useEffect(() => {
                if (selectedEmployee && !editingPayrollId) {
                    const activeLoan = staffLoans.find(loan => loan.employeeId === selectedEmployee.id && loan.status === 'Active');
                    if (activeLoan && activeLoan.agreedMonthlyDeduction) {
                        setPayrollInput(prev => ({ ...prev, loanDed: activeLoan.agreedMonthlyDeduction }));
                    } else {
                        setPayrollInput(prev => ({ ...prev, loanDed: '' }));
                    }
                }
            }, [selectedEmployee, staffLoans, editingPayrollId]);


            const calculatedData = useMemo(() => {
                if (selectedEmployee && currentDate) {
                    const { baseSalary } = selectedEmployee;
                    const { workDay, givenOff, leaveNo, loanDed } = payrollInput;
                    
                    const [year, month] = currentDate.split('-').map(Number);
                    const daysInMonth = new Date(year, month, 0).getDate();
                    const startOfMonth = `${year}-${String(month).padStart(2, '0')}-01`;
                    const endOfMonth = `${year}-${String(month).padStart(2, '0')}-${String(daysInMonth).padStart(2, '0')}`;

                    const monthlyStates = employeeStates.filter(state => 
                        state.employeeId === selectedEmployee.id &&
                        state.date >= startOfMonth &&
                        state.date <= endOfMonth
                    );
                    const monthlyOT = otReports.filter(ot => 
                        ot.employeeId === selectedEmployee.id &&
                        ot.date >= startOfMonth &&
                        ot.date <= endOfMonth
                    );
                    
                    const engage = monthlyStates.filter(s => s.statusState === 'Engagement').reduce((sum, s) => sum + parseFloat(s.amount || 0), 0);
                    const otherDed = monthlyStates.filter(s => s.statusState === 'Deduction').reduce((sum, s) => sum + parseFloat(s.amount || 0), 0);
                    const otDays = monthlyOT.reduce((sum, ot) => sum + parseFloat(ot.otDays || 0), 0);

                    const salaryPerDay = (parseFloat(baseSalary) || 0) / daysInMonth;
                    const baseSalaryEarned = salaryPerDay * ((parseFloat(workDay) || 0) + (parseFloat(givenOff) || 0));
                    const otSalary = salaryPerDay * otDays;

                    const grossSalary = baseSalaryEarned + otSalary + engage;
                    const totalDeductions = (parseFloat(loanDed) || 0) + otherDed;
                    const finalSalary = grossSalary - totalDeductions;
                    
                    const activeLoan = staffLoans.find(loan => loan.employeeId === selectedEmployee.id && loan.status === 'Active');
                    const loanRemains = activeLoan ? activeLoan.loanAmount - (activeLoan.totalPaid || 0) - (parseFloat(payrollInput.loanDed) || 0) : 0;

                    return { 
                        loanRemains, 
                        engage, 
                        otherDed, 
                        finalSalary: isNaN(finalSalary) ? 0 : finalSalary, 
                        otDays, 
                        baseSalaryEarned, 
                        otSalary, 
                        grossSalary, 
                        totalDeductions 
                    };
                }
                return { loanRemains: 0, engage: 0, otherDed: 0, finalSalary: 0, otDays: 0, baseSalaryEarned: 0, otSalary: 0, grossSalary: 0, totalDeductions: 0 };
            }, [selectedEmployee, staffLoans, employeeStates, payrollInput, currentDate, otReports]);

            const handleShopChange = (e) => {
                setSelectedShop(e.target.value);
                setSelectedEmployeeId('');
                setPayrollInput({ workDay: '', givenOff: '', leaveNo: '', loanDed: '', note: '' });
            };
            
            const handleEmployeeChange = (e) => {
                setSelectedEmployeeId(e.target.value);
            };

            const handlePayrollInputChange = (e) => {
                const { name, value } = e.target;
                setPayrollInput(prev => ({...prev, [name]: value}));
            };

            const employeesInShop = useMemo(() => {
                if (!selectedShop) return [];
                return employees.filter(emp => emp.shop === selectedShop && emp.staffStatus === 'Active');
            }, [employees, selectedShop]);
            
            const resetForm = () => {
                setSelectedShop('');
                setSelectedEmployeeId('');
                setPayrollInput({ workDay: '', givenOff: '', leaveNo: '', loanDed: '', note: '' });
                setEditingPayrollId(null);
            };

            const handleSavePayroll = async () => {
                if (!selectedEmployee) {
                    alert("Please select an employee first.");
                    return;
                }
                setIsSaving(true);

                const { runTransaction, doc, collection, query, where, getDocs } = window.firebaseSDK;

                // Find the active loan for the employee first, outside the transaction.
                let activeLoanRef = null;
                let activeLoanId = null;
                const loansRef = collection(db, "staffLoans");
                const loanQuery = query(loansRef, where("employeeId", "==", selectedEmployee.id), where("status", "==", "Active"));
                const loanQuerySnapshot = await getDocs(loanQuery);
                if (!loanQuerySnapshot.empty) {
                    activeLoanRef = loanQuerySnapshot.docs[0].ref;
                    activeLoanId = loanQuerySnapshot.docs[0].id;
                }

                const payrollData = {
                    employeeId: selectedEmployee.id,
                    shopId: selectedEmployee.shop,
                    payrollMonth: currentDate,
                    baseSalary: selectedEmployee.baseSalary,
                    workDay: parseFloat(payrollInput.workDay) || 0,
                    givenOff: parseFloat(payrollInput.givenOff) || 0,
                    leaveNo: parseFloat(payrollInput.leaveNo) || 0,
                    otDays: calculatedData.otDays,
                    engage: calculatedData.engage,
                    otherDed: calculatedData.otherDed,
                    loanDed: parseFloat(payrollInput.loanDed) || 0,
                    finalSalary: calculatedData.finalSalary,
                    loanRemains: calculatedData.loanRemains,
                    note: payrollInput.note,
                    createdAt: new Date().toISOString(),
                    loanId: activeLoanId // Store the loanId with the payroll for easier reference
                };

                try {
                    if (editingPayrollId) {
                        // --- UPDATE LOGIC ---
                        const paymentsRef = collection(db, "loanPayments");
                        const paymentQuery = query(paymentsRef, where("payrollId", "==", editingPayrollId));
                        const paymentQuerySnapshot = await getDocs(paymentQuery);
                        let existingPaymentRef = null;
                        if (!paymentQuerySnapshot.empty) {
                            existingPaymentRef = paymentQuerySnapshot.docs[0].ref;
                        }

                        await runTransaction(db, async (transaction) => {
                            // --- ALL READS FIRST ---
                            const payrollRef = doc(db, "payrolls", editingPayrollId);
                            const originalPayrollDoc = await transaction.get(payrollRef);
                            
                            let loanDoc = null;
                            if (activeLoanRef) {
                                loanDoc = await transaction.get(activeLoanRef);
                            }

                            // --- LOGIC & CALCULATIONS ---
                            if (!originalPayrollDoc.exists()) {
                                throw "Original payroll document not found!";
                            }
                            
                            const oldLoanDed = originalPayrollDoc.data().loanDed || 0;
                            const newLoanDed = payrollData.loanDed;
                            const loanDedDifference = newLoanDed - oldLoanDed;

                            // --- ALL WRITES LAST ---
                            if (loanDedDifference !== 0 && activeLoanRef && loanDoc && loanDoc.exists()) {
                                const loanData = loanDoc.data();
                                const newTotalPaid = (loanData.totalPaid || 0) + loanDedDifference;
                                transaction.update(activeLoanRef, { 
                                    totalPaid: newTotalPaid,
                                    status: newTotalPaid >= loanData.loanAmount ? "Paid Off" : "Active"
                                });
                            }

                            if (newLoanDed > 0) {
                                if (existingPaymentRef) {
                                    transaction.update(existingPaymentRef, { paymentAmount: newLoanDed, paymentDate: payrollData.createdAt.slice(0, 10) });
                                } else if (activeLoanRef) {
                                    const newPaymentRef = doc(collection(db, "loanPayments"));
                                    transaction.set(newPaymentRef, {
                                        loanId: activeLoanId,
                                        payrollId: editingPayrollId,
                                        employeeId: selectedEmployee.id,
                                        paymentAmount: newLoanDed,
                                        paymentDate: payrollData.createdAt.slice(0, 10),
                                        note: `Payroll Deduction for ${payrollData.payrollMonth}`
                                    });
                                }
                            } else if (oldLoanDed > 0 && newLoanDed <= 0 && existingPaymentRef) {
                                transaction.delete(existingPaymentRef);
                            }
                            
                            transaction.update(payrollRef, payrollData);
                        });
                        alert("Payroll updated successfully!");

                    } else {
                        // --- ADD NEW LOGIC ---
                        await runTransaction(db, async (transaction) => {
                            // --- READ FIRST ---
                            let loanDoc = null;
                            if (activeLoanRef) {
                                loanDoc = await transaction.get(activeLoanRef);
                            }
                            
                            // --- LOGIC & WRITES ---
                            const payrollRef = doc(collection(db, "payrolls"));
                            transaction.set(payrollRef, { ...payrollData, id: payrollRef.id });
                            
                            if (payrollData.loanDed > 0 && activeLoanRef) {
                                if (!loanDoc || !loanDoc.exists()) {
                                     throw "Active loan not found in transaction. Please try again.";
                                }
                                
                                const loanData = loanDoc.data();
                                const newTotalPaid = (loanData.totalPaid || 0) + payrollData.loanDed;
                                transaction.update(activeLoanRef, {
                                    totalPaid: newTotalPaid,
                                    status: newTotalPaid >= loanData.loanAmount ? "Paid Off" : "Active"
                                });

                                const paymentRef = doc(collection(db, "loanPayments"));
                                transaction.set(paymentRef, {
                                    loanId: activeLoanId,
                                    payrollId: payrollRef.id,
                                    employeeId: selectedEmployee.id,
                                    paymentAmount: payrollData.loanDed,
                                    paymentDate: payrollData.createdAt.slice(0, 10),
                                    note: `Payroll Deduction for ${payrollData.payrollMonth}`
                                });
                            }
                        });
                        alert("Payroll saved successfully!");
                    }

                    if (payrollRef.current) {
                        html2canvas(payrollRef.current, { scale: 2, backgroundColor: '#ffffff', useCORS: true }).then(canvas => {
                            const link = document.createElement('a');
                            link.download = `${selectedEmployee.name}-${currentDate}.png`;
                            link.href = canvas.toDataURL('image/png');
                            link.click();
                        });
                    }
                    resetForm();
                } catch (error) {
                    console.error("Error saving payroll:", error);
                    alert(`Failed to save payroll: ${error.message}`);
                } finally {
                    setIsSaving(false);
                }
            };

            const PayslipRow = ({ label, value, isBold = false, isCurrency = true, colorClass = 'text-gray-800' }) => (
                <div className="flex justify-between items-center py-2">
                    <span className={isBold ? 'font-semibold' : 'text-gray-600'}>{label}</span>
                    <span className={`${isBold ? 'font-bold' : 'font-medium'} ${colorClass}`}>
                        {isCurrency ? formatCurrency(value) : value}
                    </span>
                </div>
            );

            return (
                <div>
                    <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        {/* --- Input Column --- */}
                        <div className="lg:col-span-1 space-y-4 p-6 bg-white rounded-lg shadow-md">
                            <div>
                                <label className="block text-sm font-medium text-gray-700">Payroll Month</label>
                                <input type="month" value={currentDate} onChange={e => setCurrentDate(e.target.value)} className="input" />
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-gray-700">Shop Name</label>
                                <select value={selectedShop} onChange={handleShopChange} className="input">
                                    <option value="">Select a shop</option>
                                    {shops.map(shop => <option key={shop.id} value={shop.id}>{shop.name}</option>)}
                                </select>
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-gray-700">Staff Name</label>
                                <select value={selectedEmployeeId} onChange={handleEmployeeChange} className="input" disabled={!selectedShop}>
                                    <option value="">Select an employee</option>
                                    {employeesInShop.map(emp => <option key={emp.id} value={emp.id}>{emp.name}</option>)}
                                </select>
                            </div>
                             <hr className="my-4"/>
                             <div>
                                <label className="block text-sm font-medium text-gray-700">No. Work Day</label>
                                <input type="number" name="workDay" value={payrollInput.workDay} onChange={handlePayrollInputChange} className="input" disabled={!selectedEmployee} />
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-gray-700">Given Off</label>
                                <input type="number" name="givenOff" value={payrollInput.givenOff} onChange={handlePayrollInputChange} className="input" disabled={!selectedEmployee} />
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-gray-700">Leave No</label>
                                <input type="number" name="leaveNo" value={payrollInput.leaveNo} onChange={handlePayrollInputChange} className="input" disabled={!selectedEmployee} />
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-gray-700">Loan Ded</label>
                                <input type="number" name="loanDed" value={payrollInput.loanDed} onChange={handlePayrollInputChange} className="input" disabled={!selectedEmployee} />
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-gray-700">Note</label>
                                <input type="text" name="note" value={payrollInput.note} onChange={handlePayrollInputChange} className="input" disabled={!selectedEmployee}/>
                            </div>
                        </div>

                        {/* --- Payslip Column --- */}
                        <div className="lg:col-span-2">
                           <div ref={payrollRef} className="p-8 bg-white rounded-lg shadow-md border border-gray-200">
                                <div className="text-center mb-6">
                                    <h2 className="text-2xl font-bold text-gray-800">Payslip</h2>
                                    <p className="text-gray-500">For the period of {currentDate}</p>
                                </div>

                                <div className="border-t border-b border-gray-200 py-4 mb-6">
                                    <div className="grid grid-cols-2 gap-4">
                                        <div><span className="font-semibold text-gray-700">Employee:</span> <span className="text-gray-900">{selectedEmployee?.name || 'N/A'}</span></div>
                                        <div><span className="font-semibold text-gray-700">Shop:</span> <span className="text-gray-900">{shops.find(s => s.id === selectedEmployee?.shop)?.name || 'N/A'}</span></div>
                                        <div><span className="font-semibold text-gray-700">Base Salary:</span> <span className="text-gray-900">{formatCurrency(selectedEmployee?.baseSalary)}</span></div>
                                        <div><span className="font-semibold text-gray-700">Worked Duration:</span> <span className="text-gray-900">{selectedEmployee ? calculateWorkedDuration(selectedEmployee.joinDate) : 'N/A'}</span></div>
                                    </div>
                                </div>

                                <div className="grid grid-cols-1 md:grid-cols-2 gap-8 mb-6">
                                    {/* Earnings */}
                                    <div>
                                        <h3 className="text-lg font-semibold text-gray-700 border-b-2 border-green-500 pb-2 mb-3">Earnings</h3>
                                        <div className="space-y-1">
                                            <PayslipRow label="Base Salary Earned" value={calculatedData.baseSalaryEarned} />
                                            <PayslipRow label="OT Salary" value={calculatedData.otSalary} />
                                            <PayslipRow label="Engagements" value={calculatedData.engage} />
                                            <div className="border-t pt-2 mt-2">
                                                <PayslipRow label="Gross Salary" value={calculatedData.grossSalary} isBold={true} />
                                            </div>
                                        </div>
                                    </div>
                                    {/* Deductions */}
                                    <div>
                                        <h3 className="text-lg font-semibold text-gray-700 border-b-2 border-red-500 pb-2 mb-3">Deductions</h3>
                                        <div className="space-y-1">
                                            <PayslipRow label="Loan Deduction" value={payrollInput.loanDed} />
                                            <PayslipRow label="Other Deductions" value={calculatedData.otherDed} />
                                            <div className="border-t pt-2 mt-2">
                                                <PayslipRow label="Total Deductions" value={calculatedData.totalDeductions} isBold={true} colorClass="text-red-600" />
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div className="bg-gray-100 rounded-lg p-4">
                                    <div className="flex justify-between items-center">
                                        <span className="text-xl font-bold text-gray-800">Net Salary</span>
                                        <span className="text-2xl font-bold text-blue-600">{formatCurrency(calculatedData.finalSalary)}</span>
                                    </div>
                                </div>
                                
                                <div className="text-center mt-6 text-xs text-gray-400">
                                    Generated on {new Date().toLocaleDateString('en-GB')}
                                </div>
                           </div>
                        </div>
                    </div>
                    <div className="mt-6 flex justify-end space-x-4">
                        <button onClick={handleSavePayroll} disabled={!selectedEmployee || isSaving} className="bg-green-600 text-white px-6 py-2 rounded-lg shadow hover:bg-green-700 disabled:bg-gray-400 transition-colors">
                            {isSaving ? 'Saving...' : (editingPayrollId ? 'Update & Download' : 'Save & Download')}
                        </button>
                    </div>
                </div>
            );
        }

        function PayrollHistory({ db, payrolls, employees, shops, onEdit }) {
            const [filters, setFilters] = useState({ shopId: '', employeeId: '', month: '' });

            const handleFilterChange = (e) => {
                const { name, value } = e.target;
                setFilters(prev => ({ ...prev, [name]: value }));
            };

            const filteredPayrolls = useMemo(() => {
                return payrolls.filter(p => {
                    const shopMatch = !filters.shopId || p.shopId === filters.shopId;
                    const employeeMatch = !filters.employeeId || p.employeeId === filters.employeeId;
                    const monthMatch = !filters.month || p.payrollMonth === filters.month;
                    return shopMatch && employeeMatch && monthMatch;
                });
            }, [payrolls, filters]);

            const totals = useMemo(() => {
                return filteredPayrolls.reduce((acc, p) => {
                    acc.finalSalary += p.finalSalary || 0;
                    acc.loanDed += p.loanDed || 0;
                    acc.otherDed += p.otherDed || 0;
                    acc.engage += p.engage || 0;
                    acc.leaveNo += p.leaveNo || 0;
                    acc.otDays += p.otDays || 0;
                    return acc;
                }, { finalSalary: 0, loanDed: 0, otherDed: 0, engage: 0, leaveNo: 0, otDays: 0 });
            }, [filteredPayrolls]);
            
            const getNameById = (id, list) => list.find(item => item.id === id)?.name || 'N/A';
            
            const sortedPayrolls = useMemo(() => {
                return [...filteredPayrolls].sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
            }, [filteredPayrolls]);

            const handleDelete = async (payroll) => {
                if (await showConfirmation("Are you sure you want to delete this payroll record? This will also reverse any loan deduction made.")) {
                    const { runTransaction, doc, collection, query, where, getDocs } = window.firebaseSDK;

                    const paymentsRef = collection(db, "loanPayments");
                    const paymentQuery = query(paymentsRef, where("payrollId", "==", payroll.id));
                    const paymentQuerySnapshot = await getDocs(paymentQuery);
                    let paymentToDeleteRef = null;
                    if (!paymentQuerySnapshot.empty) {
                        paymentToDeleteRef = paymentQuerySnapshot.docs[0].ref;
                    }

                    try {
                        await runTransaction(db, async (transaction) => {
                            // --- READS FIRST ---
                            let loanDoc = null;
                            const loanRef = payroll.loanId ? doc(db, "staffLoans", payroll.loanId) : null;
                            if (loanRef) {
                                loanDoc = await transaction.get(loanRef);
                            }

                            // --- LOGIC & WRITES ---
                            const payrollRef = doc(db, "payrolls", payroll.id);
                            
                            if (payroll.loanDed > 0 && loanRef && loanDoc && loanDoc.exists()) {
                                const loanData = loanDoc.data();
                                const newTotalPaid = (loanData.totalPaid || 0) - payroll.loanDed;
                                transaction.update(loanRef, { 
                                    totalPaid: newTotalPaid < 0 ? 0 : newTotalPaid,
                                    status: "Active"
                                });
                            }

                            if (paymentToDeleteRef) {
                                transaction.delete(paymentToDeleteRef);
                            }

                            transaction.delete(payrollRef);
                        });
                        alert("Payroll record deleted successfully.");
                    } catch (error) {
                        console.error("Error deleting payroll:", error);
                        alert(`Failed to delete payroll: ${error.message}`);
                    }
                }
            };

            return (
                <div className="bg-white shadow-md rounded-lg overflow-hidden">
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6 p-4">
                        <select name="shopId" value={filters.shopId} onChange={handleFilterChange} className="input">
                            <option value="">All Shops</option>
                            {shops.map(s => <option key={s.id} value={s.id}>{s.name}</option>)}
                        </select>
                        <select name="employeeId" value={filters.employeeId} onChange={handleFilterChange} className="input">
                            <option value="">All Employees</option>
                            {employees.map(e => <option key={e.id} value={e.id}>{e.name}</option>)}
                        </select>
                        <input type="month" name="month" value={filters.month} onChange={handleFilterChange} className="input" />
                    </div>
                    <div className="overflow-x-auto">
                        <table className="min-w-full divide-y divide-gray-200">
                            <thead className="bg-gray-50">
                                <tr>
                                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Date</th>
                                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Employee</th>
                                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Base Salary</th>
                                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Leave No.</th>
                                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">OT Days</th>
                                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Loan Ded.</th>
                                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Loan Remains</th>
                                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Other Ded.</th>
                                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Engage</th>
                                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Final Salary</th>
                                    <th className="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">Actions</th>
                                </tr>
                            </thead>
                            <tbody className="bg-white divide-y divide-gray-200">
                                {sortedPayrolls.map(p => (
                                    <tr key={p.id}>
                                        <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{p.payrollMonth}</td>
                                        <td className="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">{getNameById(p.employeeId, employees)}</td>
                                        <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{formatCurrency(p.baseSalary)}</td>
                                        <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{p.leaveNo}</td>
                                        <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{p.otDays}</td>
                                        <td className="px-6 py-4 whitespace-nowrap text-sm text-red-600">{formatCurrency(p.loanDed)}</td>
                                        <td className="px-6 py-4 whitespace-nowrap text-sm text-red-600">{formatCurrency(p.loanRemains)}</td>
                                        <td className="px-6 py-4 whitespace-nowrap text-sm text-red-600">{formatCurrency(p.otherDed)}</td>
                                        <td className="px-6 py-4 whitespace-nowrap text-sm text-green-600">{formatCurrency(p.engage)}</td>
                                        <td className="px-6 py-4 whitespace-nowrap text-sm font-semibold text-blue-600">{formatCurrency(p.finalSalary)}</td>
                                        <td className="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                                            <button onClick={() => onEdit(p)} className="text-indigo-600 hover:text-indigo-900 mr-4">Edit</button>
                                            <button onClick={() => handleDelete(p)} className="text-red-600 hover:text-red-900">Delete</button>
                                        </td>
                                    </tr>
                                ))}
                            </tbody>
                            <tfoot className="bg-gray-100">
                                <tr>
                                    <td colSpan="3" className="px-6 py-4 text-right font-bold text-gray-600">Sub-Total:</td>
                                    <td className="px-6 py-4 font-bold text-gray-700">{totals.leaveNo}</td>
                                    <td className="px-6 py-4 font-bold text-gray-700">{totals.otDays}</td>
                                    <td className="px-6 py-4 font-bold text-red-700">{formatCurrency(totals.loanDed)}</td>
                                    <td className="px-6 py-4"></td>
                                    <td className="px-6 py-4 font-bold text-red-700">{formatCurrency(totals.otherDed)}</td>
                                    <td className="px-6 py-4 font-bold text-green-700">{formatCurrency(totals.engage)}</td>
                                    <td className="px-6 py-4 font-bold text-blue-700">{formatCurrency(totals.finalSalary)}</td>
                                    <td colSpan="1"></td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
            );
        }

        function OTReportModal({ db, report, onClose, employees, shops }) {
            const initialFormState = {
                date: new Date().toISOString().slice(0, 10),
                shopId: '',
                employeeId: '',
                otDays: '',
                note: ''
            };
            const [formData, setFormData] = useState(report || initialFormState);
            const [filteredEmployees, setFilteredEmployees] = useState([]);
            const [isSaving, setIsSaving] = useState(false);

            useEffect(() => {
                if (formData.shopId) {
                    setFilteredEmployees(employees.filter(emp => emp.shop === formData.shopId && emp.staffStatus === 'Active'));
                }
            }, [formData.shopId, employees]);
            
            useEffect(() => {
                if(report && report.shopId) {
                     setFilteredEmployees(employees.filter(emp => emp.shop === report.shopId && emp.staffStatus === 'Active'));
                }
            }, [report, employees]);

            const handleShopChange = (e) => {
                const shopId = e.target.value;
                setFormData(prev => ({ ...prev, shopId, employeeId: '' }));
            };

            const handleChange = (e) => {
                const { name, value } = e.target;
                setFormData(prev => ({ ...prev, [name]: value }));
            };

            const handleSubmit = async (e) => {
                e.preventDefault();
                if (!formData.employeeId || !formData.shopId) {
                    alert("Please select a shop and employee.");
                    return;
                }
                setIsSaving(true);
                try {
                    const { doc, updateDoc, addDoc, collection } = window.firebaseSDK;
                    const dataToSave = {
                        ...formData,
                        otDays: parseFloat(formData.otDays) || 0,
                    };

                    if (report) {
                        const { id, ...dataToUpdate } = dataToSave;
                        await updateDoc(doc(db, "otReports", id), dataToUpdate);
                    } else {
                        await addDoc(collection(db, "otReports"), dataToSave);
                    }
                    onClose();
                } catch (error) {
                    console.error("Error saving OT report: ", error);
                } finally {
                    setIsSaving(false);
                }
            };

            return (
                <div className="modal-overlay">
                    <div className="modal-content">
                        <h3 className="text-xl font-semibold mb-4">{report ? 'Edit OT Report' : 'Add New OT Report'}</h3>
                        <form onSubmit={handleSubmit} className="space-y-4">
                            <div><label className="block text-sm font-medium text-gray-700">Date</label><input type="date" name="date" value={formData.date} onChange={handleChange} className="input" required /></div>
                            <div>
                                <label className="block text-sm font-medium text-gray-700">Shop</label>
                                <select name="shopId" value={formData.shopId} onChange={handleShopChange} className="input" required>
                                    <option value="">Select Shop</option>
                                    {shops.map(shop => <option key={shop.id} value={shop.id}>{shop.name}</option>)}
                                </select>
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-gray-700">Staff Name</label>
                                <select name="employeeId" value={formData.employeeId} onChange={handleChange} className="input" required disabled={!formData.shopId}>
                                    <option value="">Select Staff</option>
                                    {filteredEmployees.map(emp => <option key={emp.id} value={emp.id}>{emp.name}</option>)}
                                </select>
                            </div>
                            <div><label className="block text-sm font-medium text-gray-700">OT Days</label><input type="number" step="0.5" name="otDays" value={formData.otDays} onChange={handleChange} className="input" required /></div>
                            <div><label className="block text-sm font-medium text-gray-700">Note</label><textarea name="note" value={formData.note} onChange={handleChange} rows="3" className="input"></textarea></div>
                            <div className="flex justify-end space-x-3 pt-4">
                                <button type="button" onClick={onClose} className="bg-white py-2 px-4 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 hover:bg-gray-50">Cancel</button>
                                <button type="submit" disabled={isSaving} className="bg-blue-600 text-white px-4 py-2 rounded-lg shadow hover:bg-blue-700">{isSaving ? 'Saving...' : 'Save'}</button>
                            </div>
                        </form>
                    </div>
                </div>
            );
        }

        function OTReportTab({ db, otReports, employees, shops }) {
            const [isModalOpen, setIsModalOpen] = useState(false);
            const [editingReport, setEditingReport] = useState(null);
            const [filters, setFilters] = useState({ shopId: '', employeeId: '', month: '' });

            const handleFilterChange = (e) => {
                const { name, value } = e.target;
                setFilters(prev => ({ ...prev, [name]: value }));
            };
            
            const openModal = (report = null) => {
                setEditingReport(report);
                setIsModalOpen(true);
            };

            const closeModal = () => {
                setEditingReport(null);
                setIsModalOpen(false);
            };

            const handleDelete = async (id) => {
                if (await showConfirmation("Are you sure you want to delete this OT record?")) {
                    try {
                        const { doc, deleteDoc } = window.firebaseSDK;
                        await deleteDoc(doc(db, "otReports", id));
                    } catch (e) {
                        console.error("Error deleting OT report: ", e);
                    }
                }
            };
            
            const getNameById = (id, list) => list.find(item => item.id === id)?.name || 'N/A';
            
            const filteredReports = useMemo(() => {
                return otReports.filter(r => {
                    const [year, month] = r.date.split('-');
                    const reportMonth = `${year}-${month}`;
                    
                    const shopMatch = !filters.shopId || r.shopId === filters.shopId;
                    const employeeMatch = !filters.employeeId || r.employeeId === filters.employeeId;
                    const monthMatch = !filters.month || reportMonth === filters.month;
                    return shopMatch && employeeMatch && monthMatch;
                });
            }, [otReports, filters]);

            return (
                <div>
                    <div className="flex justify-end mb-4">
                        <button onClick={() => openModal()} className="bg-blue-600 text-white px-4 py-2 rounded-lg shadow hover:bg-blue-700 transition-colors">
                            Add New OT Report
                        </button>
                    </div>
                    
                    {isModalOpen && <OTReportModal db={db} report={editingReport} onClose={closeModal} employees={employees} shops={shops} />}

                    <div className="bg-white shadow-md rounded-lg overflow-hidden">
                         <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6 p-4">
                            <select name="shopId" value={filters.shopId} onChange={handleFilterChange} className="input">
                                <option value="">All Shops</option>
                                {shops.map(s => <option key={s.id} value={s.id}>{s.name}</option>)}
                            </select>
                            <select name="employeeId" value={filters.employeeId} onChange={handleFilterChange} className="input">
                                <option value="">All Employees</option>
                                {employees.map(e => <option key={e.id} value={e.id}>{e.name}</option>)}
                            </select>
                            <input type="month" name="month" value={filters.month} onChange={handleFilterChange} className="input" />
                        </div>
                        <div className="overflow-x-auto">
                            <table className="min-w-full divide-y divide-gray-200">
                                <thead className="bg-gray-50">
                                    <tr>
                                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Staff Name</th>
                                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Shop</th>
                                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">OT Days</th>
                                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Note</th>
                                        <th className="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                    </tr>
                                </thead>
                                <tbody className="bg-white divide-y divide-gray-200">
                                    {filteredReports.map(report => (
                                        <tr key={report.id}>
                                            <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{formatDate(report.date)}</td>
                                            <td className="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">{getNameById(report.employeeId, employees)}</td>
                                            <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{getNameById(report.shopId, shops)}</td>
                                            <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{report.otDays}</td>
                                            <td className="px-6 py-4 text-sm text-gray-500">{report.note}</td>
                                            <td className="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                                                <button onClick={() => openModal(report)} className="text-indigo-600 hover:text-indigo-900 mr-4">Edit</button>
                                                <button onClick={() => handleDelete(report.id)} className="text-red-600 hover:text-red-900">Delete</button>
                                            </td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            )
        }
        
        function ExpenseReportPage({ payrolls, shops }) {
            const [filters, setFilters] = useState({ shopId: '', month: '' });

            const handleFilterChange = (e) => {
                const { name, value } = e.target;
                setFilters(prev => ({ ...prev, [name]: value }));
            };

            const getNameById = (id, list) => list.find(item => item.id === id)?.name || 'N/A';
            
            const reportData = useMemo(() => {
                const filtered = payrolls.filter(p => {
                    const shopMatch = !filters.shopId || p.shopId === filters.shopId;
                    const monthMatch = !filters.month || p.payrollMonth === filters.month;
                    return shopMatch && monthMatch;
                });

                const grouped = filtered.reduce((acc, p) => {
                    const key = `${p.payrollMonth}-${p.shopId}`;
                    if (!acc[key]) {
                        acc[key] = {
                            month: p.payrollMonth,
                            shopId: p.shopId,
                            totalLoanDed: 0,
                            totalOtherDed: 0,
                            totalEngage: 0,
                            totalFinalSalary: 0,
                            totalAccSalary: 0,
                            count: 0
                        };
                    }
                    acc[key].totalLoanDed += p.loanDed || 0;
                    acc[key].totalOtherDed += p.otherDed || 0;
                    acc[key].totalEngage += p.engage || 0;
                    acc[key].totalFinalSalary += p.finalSalary || 0;
                    acc[key].totalAccSalary += (p.loanDed || 0) + (p.finalSalary || 0);
                    acc[key].count += 1;
                    return acc;
                }, {});

                return Object.values(grouped).sort((a, b) => b.month.localeCompare(a.month));
            }, [payrolls, filters]);

            const totals = useMemo(() => {
                return reportData.reduce((acc, row) => {
                    acc.totalLoanDed += row.totalLoanDed;
                    acc.totalOtherDed += row.totalOtherDed;
                    acc.totalEngage += row.totalEngage;
                    acc.totalFinalSalary += row.totalFinalSalary;
                    acc.totalAccSalary += row.totalAccSalary;
                    return acc;
                }, { totalLoanDed: 0, totalOtherDed: 0, totalEngage: 0, totalFinalSalary: 0, totalAccSalary: 0 });
            }, [reportData]);

            return (
                <div>
                    <header className="mb-8">
                        <h1 className="text-3xl md:text-4xl font-bold text-gray-800">Expense Report</h1>
                        <p className="text-gray-500 mt-1">A summary of payroll expenses by shop and month.</p>
                    </header>
                     <div className="bg-white shadow-md rounded-lg overflow-hidden">
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6 p-4">
                            <select name="shopId" value={filters.shopId} onChange={handleFilterChange} className="input">
                                <option value="">All Shops</option>
                                {shops.map(s => <option key={s.id} value={s.id}>{s.name}</option>)}
                            </select>
                            <input type="month" name="month" value={filters.month} onChange={handleFilterChange} className="input" />
                        </div>
                        <div className="overflow-x-auto">
                            <table className="min-w-full divide-y divide-gray-200">
                                <thead className="bg-gray-50">
                                    <tr>
                                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">No.</th>
                                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Month</th>
                                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Shop Name</th>
                                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Total Loan Ded.</th>
                                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Total Other Ded.</th>
                                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Total Engage</th>
                                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Acc Salary</th>
                                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Total Final Salary</th>
                                    </tr>
                                </thead>
                                <tbody className="bg-white divide-y divide-gray-200">
                                    {reportData.map((row, index) => (
                                        <tr key={`${row.month}-${row.shopId}`}>
                                            <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{index + 1}</td>
                                            <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{row.month}</td>
                                            <td className="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">{getNameById(row.shopId, shops)}</td>
                                            <td className="px-6 py-4 whitespace-nowrap text-sm text-red-600">{formatCurrency(row.totalLoanDed)}</td>
                                            <td className="px-6 py-4 whitespace-nowrap text-sm text-red-600">{formatCurrency(row.totalOtherDed)}</td>
                                            <td className="px-6 py-4 whitespace-nowrap text-sm text-green-600">{formatCurrency(row.totalEngage)}</td>
                                            <td className="px-6 py-4 whitespace-nowrap text-sm font-semibold text-gray-800">{formatCurrency(row.totalAccSalary)}</td>
                                            <td className="px-6 py-4 whitespace-nowrap text-sm font-semibold text-blue-600">{formatCurrency(row.totalFinalSalary)}</td>
                                        </tr>
                                    ))}
                                </tbody>
                                <tfoot className="bg-gray-100">
                                    <tr>
                                        <td colSpan="3" className="px-6 py-4 text-right font-bold text-gray-600">Sub-Total:</td>
                                        <td className="px-6 py-4 font-bold text-red-700">{formatCurrency(totals.totalLoanDed)}</td>
                                        <td className="px-6 py-4 font-bold text-red-700">{formatCurrency(totals.totalOtherDed)}</td>
                                        <td className="px-6 py-4 font-bold text-green-700">{formatCurrency(totals.totalEngage)}</td>
                                        <td className="px-6 py-4 font-bold text-gray-800">{formatCurrency(totals.totalAccSalary)}</td>
                                        <td className="px-6 py-4 font-bold text-blue-700">{formatCurrency(totals.totalFinalSalary)}</td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                    </div>
                </div>
            );
        }
        
        function SalaryReviseTab({ db, employees, shops, salaryRevisions, userPermissions }) {
            const initialFormState = {
                date: new Date().toISOString().slice(0, 10),
                shopId: '',
                employeeId: '',
                baseSalary: '',
                amountRequest: '',
                note: ''
            };
            const [formData, setFormData] = useState(initialFormState);
            const [filteredEmployees, setFilteredEmployees] = useState([]);
            const [isSubmitting, setIsSubmitting] = useState(false);
            
            const selectedEmployee = useMemo(() => {
                return employees.find(emp => emp.id === formData.employeeId) || null;
            }, [formData.employeeId, employees]);

            useEffect(() => {
                if (selectedEmployee) {
                    setFormData(prev => ({ ...prev, baseSalary: selectedEmployee.baseSalary || '' }));
                } else {
                     setFormData(prev => ({ ...prev, baseSalary: '' }));
                }
            }, [selectedEmployee]);

            const handleShopChange = (e) => {
                const shopId = e.target.value;
                setFormData(prev => ({ ...prev, shopId, employeeId: '', baseSalary: '' }));
                setFilteredEmployees(employees.filter(emp => emp.shop === shopId && emp.staffStatus === 'Active'));
            };

            const handleChange = (e) => {
                const { name, value } = e.target;
                setFormData(prev => ({ ...prev, [name]: value }));
            };

            const updatedSalary = useMemo(() => {
                const base = parseFloat(formData.baseSalary) || 0;
                const request = parseFloat(formData.amountRequest) || 0;
                return base + request;
            }, [formData.baseSalary, formData.amountRequest]);
            
            const handleSubmitRevise = async () => {
                if (!formData.employeeId || !formData.amountRequest) {
                    alert("Please select an employee and enter a requested amount.");
                    return;
                }
                setIsSubmitting(true);
                try {
                    const { addDoc, collection } = window.firebaseSDK;
                    await addDoc(collection(db, "salaryRevisions"), {
                        ...formData,
                        baseSalary: parseFloat(formData.baseSalary) || 0,
                        amountRequest: parseFloat(formData.amountRequest) || 0,
                        updatedSalary: updatedSalary,
                        status: 'Pending' // Initial status
                    });
                    alert("Salary revise request submitted successfully!");
                    setFormData(initialFormState); // Reset form
                } catch (error) {
                    console.error("Error submitting salary revise request: ", error);
                    alert("Failed to submit request.");
                } finally {
                    setIsSubmitting(false);
                }
            };
            
            return (
                <div>
                    <div className="bg-white p-6 rounded-lg shadow-md mt-6">
                        <h2 className="text-2xl font-semibold mb-4">Revise Form</h2>
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div><label className="block text-sm font-medium text-gray-700">Date</label><input type="date" name="date" value={formData.date} onChange={handleChange} className="input" /></div>
                            <div>
                                <label className="block text-sm font-medium text-gray-700">Shop Name</label>
                                <select name="shopId" value={formData.shopId} onChange={handleShopChange} className="input">
                                    <option value="">Select Shop</option>
                                    {shops.map(shop => <option key={shop.id} value={shop.id}>{shop.name}</option>)}
                                </select>
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-gray-700">Staff Name</label>
                                <select name="employeeId" value={formData.employeeId} onChange={handleChange} className="input" disabled={!formData.shopId}>
                                    <option value="">Select Staff</option>
                                    {filteredEmployees.map(emp => <option key={emp.id} value={emp.id}>{emp.name}</option>)}
                                </select>
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-gray-700">Base Salary</label>
                                <input type="text" name="baseSalary" value={formatCurrency(formData.baseSalary)} className="input bg-gray-100" readOnly />
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-gray-700">Amount Request</label>
                                <input type="number" name="amountRequest" value={formData.amountRequest} onChange={handleChange} className="input" />
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-gray-700">Updated Salary</label>
                                <input type="text" value={formatCurrency(updatedSalary)} className="input bg-gray-100" readOnly />
                            </div>
                            <div className="md:col-span-2">
                                <label className="block text-sm font-medium text-gray-700">Note</label>
                                <textarea name="note" value={formData.note} onChange={handleChange} rows="3" className="input"></textarea>
                            </div>
                        </div>
                        <div className="mt-6 flex justify-end">
                            <button 
                                onClick={handleSubmitRevise} 
                                disabled={isSubmitting}
                                className="bg-blue-600 text-white px-6 py-2 rounded-lg shadow hover:bg-blue-700 disabled:bg-gray-400 transition-colors"
                            >
                                {isSubmitting ? 'Submitting...' : 'Submit Revise'}
                            </button>
                        </div>
                    </div>
                    <ReviseTrackingReport db={db} salaryRevisions={salaryRevisions} employees={employees} shops={shops} userPermissions={userPermissions} />
                </div>
            );
        }

        function ReviseTrackingReport({ db, salaryRevisions, employees, shops, userPermissions }) {
            const getNameById = (id, list) => list.find(item => item.id === id)?.name || 'N/A';

            const handleStatusChange = async (revision, newStatus) => {
                const { doc, updateDoc, runTransaction } = window.firebaseSDK;
                const revisionRef = doc(db, "salaryRevisions", revision.id);

                if (newStatus === 'Approved') {
                    if (await showConfirmation("Are you sure you want to approve this salary revision? This will update the employee's base salary.")) {
                        try {
                            await runTransaction(db, async (transaction) => {
                                const employeeRef = doc(db, "employees", revision.employeeId);
                                transaction.update(employeeRef, { baseSalary: revision.updatedSalary });
                                transaction.update(revisionRef, { status: newStatus });
                            });
                            alert("Salary revision approved and employee updated.");
                        } catch (error) {
                            console.error("Error approving revision: ", error);
                            alert("Failed to approve revision.");
                        }
                    }
                } else { // Rejected
                     if (await showConfirmation("Are you sure you want to reject this salary revision?")) {
                        await updateDoc(revisionRef, { status: newStatus });
                     }
                }
            };

            const handleDelete = async (id) => {
                if (await showConfirmation("Are you sure you want to delete this revision request?")) {
                    try {
                        const { doc, deleteDoc } = window.firebaseSDK;
                        await deleteDoc(doc(db, "salaryRevisions", id));
                    } catch (e) {
                        console.error("Error deleting revision: ", e);
                    }
                }
            };
            
            const isAdmin = userPermissions.role === 'Admin';

            return (
                <div className="bg-white shadow-md rounded-lg overflow-hidden mt-8">
                    <h2 className="text-2xl font-semibold p-6">Revise Tracking Report</h2>
                    <div className="overflow-x-auto">
                        <table className="min-w-full divide-y divide-gray-200">
                            <thead className="bg-gray-50">
                                <tr>
                                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Date</th>
                                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Shop</th>
                                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Staff Name</th>
                                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Base Salary</th>
                                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Amount Request</th>
                                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Updated Salary</th>
                                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Note</th>
                                    <th className="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">Action</th>
                                </tr>
                            </thead>
                            <tbody className="bg-white divide-y divide-gray-200">
                                {salaryRevisions.map(rev => (
                                    <tr key={rev.id}>
                                        <td className="px-6 py-4 whitespace-nowrap text-sm">{formatDate(rev.date)}</td>
                                        <td className="px-6 py-4 whitespace-nowrap text-sm">{getNameById(rev.shopId, shops)}</td>
                                        <td className="px-6 py-4 whitespace-nowrap text-sm font-medium">{getNameById(rev.employeeId, employees)}</td>
                                        <td className="px-6 py-4 whitespace-nowrap text-sm">{formatCurrency(rev.baseSalary)}</td>
                                        <td className="px-6 py-4 whitespace-nowrap text-sm text-green-600">{formatCurrency(rev.amountRequest)}</td>
                                        <td className="px-6 py-4 whitespace-nowrap text-sm font-bold">{formatCurrency(rev.updatedSalary)}</td>
                                        <td className="px-6 py-4 whitespace-nowrap text-sm">
                                            {isAdmin && rev.status === 'Pending' ? (
                                                <div className="flex space-x-2">
                                                    <button onClick={() => handleStatusChange(rev, 'Approved')} className="bg-green-500 text-white px-2 py-1 text-xs rounded hover:bg-green-600">Yes</button>
                                                    <button onClick={() => handleStatusChange(rev, 'Rejected')} className="bg-red-500 text-white px-2 py-1 text-xs rounded hover:bg-red-600">No</button>
                                                </div>
                                            ) : (
                                                <span className={`px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${
                                                    rev.status === 'Approved' ? 'bg-green-100 text-green-800' : 
                                                    rev.status === 'Rejected' ? 'bg-red-100 text-red-800' : 'bg-yellow-100 text-yellow-800'
                                                }`}>
                                                    {rev.status}
                                                </span>
                                            )}
                                        </td>
                                        <td className="px-6 py-4 text-sm">{rev.note}</td>
                                        <td className="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                                            {isAdmin && rev.status === 'Pending' && (
                                                <>
                                                    <button className="text-indigo-600 hover:text-indigo-900 mr-4">Edit</button>
                                                    <button onClick={() => handleDelete(rev.id)} className="text-red-600 hover:text-red-900">Delete</button>
                                                </>
                                            )}
                                        </td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                </div>
            );
        }

        // --- SETTINGS PAGE & COMPONENTS ---

        function SettingsCRUD({ db, title, collectionName, items, formFields, listColumns }) {
            const [editingItem, setEditingItem] = useState(null);
            const [newItem, setNewItem] = useState({});

            const getInitialState = useCallback(() => {
                return formFields.reduce((acc, field) => {
                    acc[field.name] = (field.type === 'multiselect' || field.type === 'checkbox-group') ? [] : '';
                    return acc;
                }, {});
            }, [formFields]);

            useEffect(() => {
                setNewItem(getInitialState());
            }, [getInitialState]);

            const handleSave = async (item) => {
                const { doc, updateDoc, addDoc, collection } = window.firebaseSDK;
                const dataToSave = { ...item };
                try {
                    if (item.id) {
                        const { id, ...data } = dataToSave;
                        await updateDoc(doc(db, collectionName, id), data);
                    } else {
                        await addDoc(collection(db, collectionName), dataToSave);
                    }
                    setEditingItem(null);
                    setNewItem(getInitialState());
                } catch (e) {
                    console.error(`Error saving ${collectionName}:`, e);
                }
            };
            
            const handleDelete = async (id) => {
                if (await showConfirmation(`Are you sure you want to delete this item?`)) {
                    try {
                        const { doc, deleteDoc } = window.firebaseSDK;
                        await deleteDoc(doc(db, collectionName, id));
                    } catch (e) {
                        console.error(`Error deleting ${collectionName}:`, e);
                    }
                }
            };

            const handleInputChange = (e, item, setItem) => {
                const { name, type, value, checked } = e.target;
                
                if (type === 'checkbox') {
                    const currentValues = item[name] || [];
                    if (checked) {
                        setItem({ ...item, [name]: [...currentValues, value] });
                    } else {
                        setItem({ ...item, [name]: currentValues.filter(val => val !== value) });
                    }
                } else {
                    setItem({ ...item, [name]: value });
                }
            };

            const renderForm = (item, setItem, isNew = false) => (
                 <form onSubmit={(e) => { e.preventDefault(); handleSave(item); }} className="grid grid-cols-1 md:grid-cols-3 gap-4 items-start p-4 bg-gray-50 rounded-lg mb-6">
                    {formFields.map(field => (
                        <div key={field.name}>
                            <label className="block text-sm font-medium text-gray-700">{field.label}</label>
                            {field.type === 'select' ? (
                                <select name={field.name} value={item[field.name] || ''} onChange={(e) => handleInputChange(e, item, setItem)} className="input" required={field.required}>
                                    <option value="">{field.placeholder}</option>
                                    {field.options.map(opt => <option key={opt.id} value={opt.id}>{opt.name}</option>)}
                                </select>
                            ) : field.type === 'checkbox-group' ? (
                                <div className="checkbox-group">
                                    {field.options.map(opt => (
                                        <div key={opt.id} className="flex items-center">
                                            <input
                                                id={`${field.name}-${opt.id}`}
                                                name={field.name}
                                                type="checkbox"
                                                value={opt.id}
                                                checked={(item[field.name] || []).includes(opt.id)}
                                                onChange={(e) => handleInputChange(e, item, setItem)}
                                                className="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500"
                                            />
                                            <label htmlFor={`${field.name}-${opt.id}`} className="ml-2 block text-sm text-gray-900">{opt.name}</label>
                                        </div>
                                    ))}
                                </div>
                            ) : (
                                <input type={field.type} name={field.name} value={item[field.name] || ''} onChange={(e) => handleInputChange(e, item, setItem)} className="input" required={field.required} />
                            )}
                        </div>
                    ))}
                    <div className="self-end">
                        <button type="submit" className="w-full bg-blue-600 text-white px-4 py-2 rounded-lg shadow hover:bg-blue-700 transition-colors">
                            {isNew ? `Add ${title}` : 'Save Changes'}
                        </button>
                        {!isNew && <button type="button" onClick={() => setEditingItem(null)} className="w-full mt-2 bg-gray-200 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-300">Cancel</button>}
                    </div>
                </form>
            );

            return (
                <div className="bg-white p-6 rounded-lg shadow-md">
                    <h2 className="text-2xl font-semibold mb-4">{title} Management</h2>
                    {renderForm(newItem, setNewItem, true)}
                    <div className="overflow-x-auto">
                        <table className="min-w-full divide-y divide-gray-200">
                             <thead className="bg-gray-50">
                                <tr>
                                    {listColumns.map(col => <th key={col.header} className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">{col.header}</th>)}
                                    <th className="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                </tr>
                            </thead>
                            <tbody className="bg-white divide-y divide-gray-200">
                                {items.map(item => (
                                    <tr key={item.id}>
                                        {editingItem?.id === item.id ? (
                                            <td colSpan={listColumns.length + 1}>
                                                {renderForm(editingItem, setEditingItem)}
                                            </td>
                                        ) : (
                                            <>
                                                {listColumns.map(col => (
                                                    <td key={col.header} className="px-6 py-4 whitespace-nowrap text-sm text-gray-600">
                                                        {col.render ? col.render(item) : item[col.accessor]}
                                                    </td>
                                                ))}
                                                <td className="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                                                    <button onClick={() => setEditingItem({ ...item, shops: item.shops || [] })} className="text-indigo-600 hover:text-indigo-900 mr-4">Edit</button>
                                                    <button onClick={() => handleDelete(item.id)} className="text-red-600 hover:text-red-900">Delete</button>
                                                </td>
                                            </>
                                        )}
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                </div>
            );
        }

        function SettingsPage({ db, shops, supervisors, positions }) {
            const [activeTab, setActiveTab] = useState('shops');
            
            const TabButton = ({ tabName, title }) => (
                <button
                    onClick={() => setActiveTab(tabName)}
                    className={`px-4 py-2 text-sm font-medium rounded-md transition-colors duration-200 ${
                        activeTab === tabName ? 'bg-blue-600 text-white shadow-md' : 'bg-white text-gray-700 hover:bg-gray-200'
                    }`}
                >
                    {title}
                </button>
            );

            const shopFormFields = [
                { name: 'name', label: 'Shop Name', type: 'text', required: true },
                { name: 'contact', label: 'Contact', type: 'text', required: false },
                { name: 'address', label: 'Address', type: 'text', required: false }
            ];
            const shopListColumns = [
                { header: 'Shop Name', accessor: 'name' },
                { header: 'Contact', accessor: 'contact' },
                { header: 'Address', accessor: 'address' }
            ];

            const pagePermissions = [
                { id: 'employees', name: 'Employees' },
                { id: 'employeeState', name: 'Employee State' },
                { id: 'loanManager', name: 'Loan Manager' },
                { id: 'payroll', name: 'Payroll' },
                { id: 'expenseReport', name: 'Expense Report' },
                { id: 'settings', name: 'Settings' }
            ];

            const supervisorFormFields = [
                { name: 'name', label: 'Supervisor Name', type: 'text', required: true },
                { name: 'email', label: 'Email', type: 'email', required: false },
                { name: 'uid', label: 'UID', type: 'text', required: false },
                { name: 'role', label: 'Role', type: 'select', options: [{id: 'Admin', name: 'Admin'}, {id: 'Shop Manager', name: 'Shop Manager'}, {id: 'Staff', name: 'Staff'}], placeholder: 'Select Role', required: true },
                { name: 'shops', label: 'Assigned Shops', type: 'checkbox-group', options: shops, required: false },
                { name: 'pagePermissions', label: 'Page Permissions', type: 'checkbox-group', options: pagePermissions, required: true }
            ];
            const supervisorListColumns = [
                { header: 'Supervisor Name', accessor: 'name' },
                { header: 'Email', accessor: 'email' },
                { header: 'UID', accessor: 'uid' },
                { header: 'Role', accessor: 'role' },
                { 
                    header: 'Assigned Shops', 
                    render: (item) => 
                        item.shops && Array.isArray(item.shops) 
                        ? item.shops
                            .map(shopId => shops.find(s => s.id === shopId)?.name || 'N/A')
                            .join(', ') 
                        : 'N/A' 
                }
            ];

            const positionFormFields = [{ name: 'name', label: 'Position Name', type: 'text', required: true }];
            const positionListColumns = [{ header: 'Position Name', accessor: 'name' }];

            return (
                <div>
                     <header className="mb-8">
                        <h1 className="text-3xl md:text-4xl font-bold text-gray-800">Settings</h1>
                        <p className="text-gray-500 mt-1">Manage your shop, supervisor, and position details.</p>
                    </header>
                    <div className="mb-6">
                        <div className="flex space-x-2 bg-gray-200 p-1 rounded-lg">
                            <TabButton tabName="shops" title="Shop List" />
                            <TabButton tabName="supervisors" title="Supervisors" />
                            <TabButton tabName="positions" title="Positions" />
                        </div>
                    </div>
                    <div>
                        {activeTab === 'shops' && <SettingsCRUD db={db} title="Shop" collectionName="shops" items={shops} formFields={shopFormFields} listColumns={shopListColumns} />}
                        {activeTab === 'supervisors' && <SettingsCRUD db={db} title="Supervisor" collectionName="supervisors" items={supervisors} formFields={supervisorFormFields} listColumns={supervisorListColumns} />}
                        {activeTab === 'positions' && <SettingsCRUD db={db} title="Position" collectionName="positions" items={positions} formFields={positionFormFields} listColumns={positionListColumns} />}
                    </div>
                </div>
            )
        }
        
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
