<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Future Plan Management</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        @import url('https://rsms.me/inter/inter.css');
        html { font-family: 'Inter', sans-serif; }
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-content {
            background-color: white;
            padding: 2rem;
            border-radius: 0.5rem;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }
        .input {
            margin-top: 0.25rem;
            display: block;
            width: 100%;
            padding-left: 0.75rem;
            padding-right: 0.75rem;
            padding-top: 0.5rem;
            padding-bottom: 0.5rem;
            border-width: 1px;
            border-color: #D1D5DB;
            border-radius: 0.375rem;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
        }
        .input:focus {
            outline: 2px solid transparent;
            outline-offset: 2px;
            --tw-ring-color: #2563EB;
            border-color: #2563EB;
        }
        .checkbox-group {
            max-height: 150px;
            overflow-y: auto;
            border: 1px solid #D1D5DB;
            border-radius: 0.375rem;
            padding: 0.5rem;
            margin-top: 0.25rem;
        }
        .search-results {
            position: absolute;
            background: white;
            border: 1px solid #ddd;
            border-radius: 0.375rem;
            width: 100%;
            max-height: 200px;
            overflow-y: auto;
            z-index: 10;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .search-item {
            padding: 0.5rem 0.75rem;
            cursor: pointer;
        }
        .search-item:hover {
            background-color: #f3f4f6;
        }
    </style>
</head>
<body class="bg-gray-100">
    <div id="root"></div>

    <script type="module">
        // Make Firebase SDK functions available on the window object
        // so they can be accessed by the React component.
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, doc, addDoc, updateDoc, deleteDoc, setLogLevel, getDocs, serverTimestamp, writeBatch, query, where, runTransaction } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        window.firebaseSDK = {
            initializeApp,
            getAuth,
            signInAnonymously,
            onAuthStateChanged,
            getFirestore,
            collection,
            onSnapshot,
            doc,
            addDoc,
            updateDoc,
            deleteDoc,
            setLogLevel,
            getDocs,
            serverTimestamp,
            writeBatch,
            query,
            where,
            runTransaction
        };
    </script>
    
    <script type="text/babel">
        const { useState, useEffect, useMemo, useCallback } = React;

        // --- PASTE YOUR FIREBASE CONFIGURATION HERE ---
        const firebaseConfig = {
            apiKey: "AIzaSyBNb5ZI9XIWWSpxGD-FeV94K5FMc2a8udU",
            authDomain: "hr-manager-84ada.firebaseapp.com",
            projectId: "hr-manager-84ada",
            storageBucket: "hr-manager-84ada.firebasestorage.app",
            messagingSenderId: "365563456537",
            appId: "1:365563456537:web:9c5a6fbce7710b4c72ce88",
            measurementId: "G-51R9KT7LC1"
        };
        // ---------------------------------------------

        // --- HELPER FUNCTIONS ---
        const formatDate = (dateString) => {
            if (!dateString) return '';
            const date = new Date(dateString);
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const year = date.getFullYear();
            return `${day}-${month}-${year}`;
        };
        
        const formatTimestamp = (timestamp) => {
            if (!timestamp || !timestamp.toDate) return 'N/A';
            return timestamp.toDate().toLocaleString('en-GB');
        };

        const formatCurrency = (number) => {
            if (number === null || number === undefined || number === '' || isNaN(number)) return '';
            return Number(number).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        };
        
        const calculateWorkedDuration = (joinDate) => {
            if (!joinDate) return 'N/A';
            const start = new Date(joinDate);
            const end = new Date();
            
            let years = end.getFullYear() - start.getFullYear();
            let months = end.getMonth() - start.getMonth();
            let days = end.getDate() - start.getDate();

            if (days < 0) {
                months--;
                days += new Date(end.getFullYear(), end.getMonth(), 0).getDate();
            }
            if (months < 0) {
                years--;
                months += 12;
            }

            const totalMonths = years * 12 + months;
            return `${totalMonths}M-${days}D`;
        };
        
        function showConfirmation(message) {
            return new Promise((resolve) => {
                const confirmationBox = document.createElement('div');
                confirmationBox.className = 'modal-overlay';
                confirmationBox.innerHTML = `
                    <div class="modal-content text-center">
                        <p class="mb-4">${message}</p>
                        <div class="flex justify-center space-x-4">
                            <button id="confirm-yes" class="bg-red-600 text-white px-4 py-2 rounded-lg shadow hover:bg-red-700">Yes, delete</button>
                            <button id="confirm-no" class="bg-white px-4 py-2 border border-gray-300 rounded-md shadow-sm text-gray-700 hover:bg-gray-50">Cancel</button>
                        </div>
                    </div>
                `;
                document.body.appendChild(confirmationBox);

                document.getElementById('confirm-yes').onclick = () => {
                    document.body.removeChild(confirmationBox);
                    resolve(true);
                };

                document.getElementById('confirm-no').onclick = () => {
                    document.body.removeChild(confirmationBox);
                    resolve(false);
                };
            });
        }
        
        // Custom hook to fetch a collection from Firestore
        const useCollection = (db, collectionName) => {
            const [data, setData] = useState([]);
            const [loading, setLoading] = useState(true);

            useEffect(() => {
                if (!db) {
                    setLoading(false);
                    return;
                };

                const { collection, onSnapshot, query } = window.firebaseSDK;
                const q = query(collection(db, collectionName));
                const unsubscribe = onSnapshot(q, (querySnapshot) => {
                    const items = [];
                    querySnapshot.forEach((doc) => {
                        items.push({ id: doc.id, ...doc.data() });
                    });
                    setData(items);
                    setLoading(false);
                }, (error) => {
                    console.error(`Error fetching ${collectionName}:`, error);
                    setLoading(false);
                });

                return () => unsubscribe();
            }, [db, collectionName]);

            return { data, loading };
        };

        // --- CORE APPLICATION COMPONENTS ---

        function App() {
            const [db, setDb] = useState(null);
            const [auth, setAuth] = useState(null);
            const [initStatus, setInitStatus] = useState('pending');
            const [errorMsg, setErrorMsg] = useState('');

            useEffect(() => {
                const initializeFirebase = async () => {
                    if (!firebaseConfig || !firebaseConfig.apiKey.startsWith('AIza')) {
                        setErrorMsg('Firebase is not configured. Please edit the firebaseConfig object in the HTML file.');
                        setInitStatus('error');
                        return;
                    }

                    try {
                        const { initializeApp, getFirestore, getAuth, signInAnonymously, setLogLevel } = window.firebaseSDK;
                        const app = initializeApp(firebaseConfig);
                        const firestore = getFirestore(app);
                        const authInstance = getAuth(app);
                        
                        setLogLevel('debug');
                        await signInAnonymously(authInstance);
                        
                        setDb(firestore);
                        setAuth(authInstance);
                        setInitStatus('success');
                    } catch (error) {
                        console.error("Firebase initialization failed:", error);
                        setErrorMsg(`Firebase initialization failed: ${error.message}. Check your config.`);
                        setInitStatus('error');
                    }
                };

                initializeFirebase();
            }, []);

            if (initStatus === 'pending') {
                return <div className="flex justify-center items-center h-screen"><div className="text-xl font-semibold">Initializing...</div></div>;
            }

            if (initStatus === 'error') {
                return (
                    <div className="flex items-center justify-center h-screen p-8">
                        <div className="bg-red-100 border-l-4 border-red-500 text-red-700 p-6 rounded-lg shadow-md max-w-2xl">
                            <p className="font-bold text-xl mb-2">Configuration Error</p>
                            <p>{errorMsg}</p>
                        </div>
                    </div>
                );
            }

            if (initStatus === 'success' && db && auth) {
                return <MainApp db={db} auth={auth} />;
            }

            return null;
        }
        
        function MainApp({ db, auth }) {
            const [currentPage, setCurrentPage] = useState('employees');
            const [isSidebarOpen, setIsSidebarOpen] = useState(false);
            const [user, setUser] = useState(null);

            const { data: employees, loading: employeesLoading } = useCollection(db, 'employees');
            const { data: shops, loading: shopsLoading } = useCollection(db, 'shops');
            const { data: positions, loading: positionsLoading } = useCollection(db, 'positions');
            const { data: supervisors, loading: supervisorsLoading } = useCollection(db, 'supervisors');
            const { data: employeeStates, loading: employeeStatesLoading } = useCollection(db, 'employeeStates');
            const { data: staffLoans, loading: staffLoansLoading } = useCollection(db, 'staffLoans');
            const { data: allPayments, loading: allPaymentsLoading } = useCollection(db, 'loanPayments');
            const { data: payrolls, loading: payrollsLoading } = useCollection(db, 'payrolls');


            const isLoading = employeesLoading || shopsLoading || positionsLoading || supervisorsLoading || employeeStatesLoading || staffLoansLoading || allPaymentsLoading || payrollsLoading;
            
            useEffect(() => {
                const { onAuthStateChanged } = window.firebaseSDK;
                const unsubscribe = onAuthStateChanged(auth, (user) => {
                    setUser(user);
                });
                return () => unsubscribe();
            }, [auth]);

            const renderPage = () => {
                if (isLoading) {
                    return <div className="flex justify-center items-center h-screen"><div className="text-xl font-semibold">Loading Data...</div></div>;
                }
                switch (currentPage) {
                    case 'employees':
                        return <EmployeePage db={db} employees={employees} shops={shops} positions={positions} supervisors={supervisors} />;
                    case 'employeeState':
                        return <EmployeeStatePage db={db} employeeStates={employeeStates} employees={employees} shops={shops} />;
                    case 'loanManager':
                        return <LoanManagerPage db={db} auth={auth} staffLoans={staffLoans} allPayments={allPayments} employees={employees} shops={shops} />;
                    case 'payroll':
                        return <PayrollPage db={db} employees={employees} shops={shops} staffLoans={staffLoans} employeeStates={employeeStates} payrolls={payrolls} />;
                    case 'expenseReport':
                        return <ExpenseReportPage payrolls={payrolls} shops={shops} />;
                    case 'settings':
                        return <SettingsPage db={db} shops={shops} supervisors={supervisors} positions={positions} />;
                    default:
                        return <EmployeePage db={db} employees={employees} shops={shops} positions={positions} supervisors={supervisors} />;
                }
            };
            
            return (
                <div className="flex min-h-screen">
                    <Sidebar currentPage={currentPage} setCurrentPage={setCurrentPage} isSidebarOpen={isSidebarOpen} setIsSidebarOpen={setIsSidebarOpen} />
                    <div className="flex-1 md:ml-64">
                         <button onClick={() => setIsSidebarOpen(!isSidebarOpen)} className="md:hidden fixed top-4 right-4 z-40 bg-blue-600 text-white p-2 rounded-full shadow-lg">
                            <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M4 6h16M4 12h16m-7 6h7"></path></svg>
                        </button>
                        <main className="p-4 sm:p-6 lg:p-8">
                            {renderPage()}
                        </main>
                    </div>
                </div>
            );
        }

        function Sidebar({ currentPage, setCurrentPage, isSidebarOpen, setIsSidebarOpen }) {
            const NavItem = ({ pageName, title, icon }) => (
                <button
                    onClick={() => {
                        setCurrentPage(pageName);
                        if (window.innerWidth < 768) {
                           setIsSidebarOpen(false);
                        }
                    }}
                    className={`flex items-center w-full px-4 py-3 text-left transition-colors duration-200 rounded-lg ${
                        currentPage === pageName ? 'bg-blue-600 text-white' : 'text-gray-600 hover:bg-gray-200'
                    }`}
                >
                    {icon}
                    <span className="font-medium">{title}</span>
                </button>
            );

            return (
                <>
                    <div
                        className={`fixed inset-0 bg-black bg-opacity-50 z-20 transition-opacity md:hidden ${
                            isSidebarOpen ? 'opacity-100' : 'opacity-0 pointer-events-none'
                        }`}
                        onClick={() => setIsSidebarOpen(false)}
                    ></div>
                    <div className={`fixed top-0 left-0 h-full w-64 bg-white shadow-lg p-4 flex flex-col z-30 transform transition-transform md:translate-x-0 ${isSidebarOpen ? 'translate-x-0' : '-translate-x-full'}`}>
                        <div className="text-2xl font-bold text-gray-800 mb-10">HR Manager</div>
                        <nav className="flex flex-col space-y-2">
                            <NavItem pageName="employees" title="Employees" icon={<svg className="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M15 21a6 6 0 00-9-5.197M15 11a3 3 0 11-6 0 3 3 0 016 0z" /></svg>} />
                            <NavItem pageName="employeeState" title="Employee State" icon={<svg className="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z" /></svg>} />
                            <NavItem pageName="loanManager" title="Loan Manager" icon={<svg className="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm-1-4h.01M12 16h.01" /></svg>} />
                            <NavItem pageName="payroll" title="Payroll" icon={<svg className="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M9 7h6m0 10v-3.25a3.25 3.25 0 00-3.25-3.25H6.25A3.25 3.25 0 003 16.75V20h12V9.25a3.25 3.25 0 00-3.25-3.25H9.25A3.25 3.25 0 006 9.25V10" /></svg>} />
                            <NavItem pageName="expenseReport" title="Expense Report" icon={<svg className="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>} />
                            <NavItem pageName="settings" title="Settings" icon={<svg className="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" /><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>} />
                        </nav>
                    </div>
                </>
            );
        }

        // --- PAGE COMPONENTS ---
        function EmployeePage({ db, employees, shops, positions, supervisors }) {
            const [isModalOpen, setIsModalOpen] = useState(false);
            const [editingEmployee, setEditingEmployee] = useState(null);
            const [filters, setFilters] = useState({ shop: '', name: '', joinDate: '', status: 'Active' });
            const [activeTab, setActiveTab] = useState('active');

            const TabButton = ({ tabName, title }) => (
                <button
                    onClick={() => setActiveTab(tabName)}
                    className={`px-4 py-2 text-sm font-medium rounded-md transition-colors duration-200 ${
                        activeTab === tabName ? 'bg-blue-600 text-white shadow-md' : 'bg-white text-gray-700 hover:bg-gray-200'
                    }`}
                >
                    {title}
                </button>
            );

            const openModal = useCallback((employee = null) => {
                setEditingEmployee(employee);
                setIsModalOpen(true);
            }, []);
            
            const closeModal = useCallback(() => {
                setIsModalOpen(false);
                setEditingEmployee(null);
            }, []);

            const handleFilterChange = useCallback((e) => {
                const { name, value } = e.target;
                setFilters(prev => ({ ...prev, [name]: value }));
            }, []);
            
            const filteredEmployees = useMemo(() => {
                const listToFilter = activeTab === 'active' 
                    ? employees.filter(e => e.staffStatus === 'Active')
                    : employees.filter(e => e.staffStatus === 'Resigned' || e.staffStatus === 'Terminated');

                return listToFilter.filter(emp => 
                    (!filters.shop || emp.shop === filters.shop) &&
                    (!filters.name || emp.name.toLowerCase().includes(filters.name.toLowerCase())) &&
                    (!filters.joinDate || emp.joinDate === filters.joinDate)
                );
            }, [employees, filters, activeTab]);

            return (
                <div>
                    <header className="mb-8">
                        <h1 className="text-3xl md:text-4xl font-bold text-gray-800">Employee Management</h1>
                        <p className="text-gray-500 mt-1">Add, edit, and manage your employee records.</p>
                    </header>
                    
                    <div className="mb-6">
                        <div className="flex space-x-2 bg-gray-200 p-1 rounded-lg">
                            <TabButton tabName="active" title="Active Employees" />
                            <TabButton tabName="resignedTerminated" title="Resigned/Terminated" />
                        </div>
                    </div>

                    {activeTab === 'active' && (
                        <>
                            <div className="flex justify-between items-center mb-4">
                                <h2 className="text-2xl font-semibold text-gray-700">Active Employees</h2>
                                <button onClick={() => openModal()} className="bg-blue-600 text-white px-4 py-2 rounded-lg shadow hover:bg-blue-700 transition-colors">
                                    Add Employee
                                </button>
                            </div>
                            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6 p-4 bg-white rounded-lg shadow">
                                <select name="shop" value={filters.shop} onChange={handleFilterChange} className="input">
                                    <option value="">All Shops</option>
                                    {shops.map(s => <option key={s.id} value={s.id}>{s.name}</option>)}
                                </select>
                                <input type="text" name="name" placeholder="Filter by Name..." value={filters.name} onChange={handleFilterChange} className="input" />
                                <input type="date" name="joinDate" value={filters.joinDate} onChange={handleFilterChange} className="input" />
                            </div>
                            <EmployeeHistoryTable db={db} employees={filteredEmployees} onEdit={openModal} shops={shops} positions={positions} supervisors={supervisors} />
                        </>
                    )}

                    {activeTab === 'resignedTerminated' && (
                        <>
                            <h2 className="text-2xl font-semibold text-gray-700 mb-4">Resigned/Terminated Employees</h2>
                            <ResignedTerminatedTable employees={filteredEmployees} shops={shops} />
                        </>
                    )}

                    {isModalOpen && <EmployeeModal db={db} employee={editingEmployee} onClose={closeModal} shops={shops} positions={positions} supervisors={supervisors} />}
                </div>
            );
        }

        function EmployeeHistoryTable({ db, employees, onEdit, shops, positions, supervisors }) {
            const handleDelete = async (id) => {
                if (await showConfirmation("Are you sure you want to delete this employee?")) {
                    try {
                        const { doc, deleteDoc } = window.firebaseSDK;
                        await deleteDoc(doc(db, "employees", id));
                    } catch (e) {
                        console.error("Error deleting document: ", e);
                    }
                }
            };
            
            const getNameById = (id, list) => list.find(item => item.id === id)?.name || 'N/A';

            return (
                <div className="bg-white shadow-md rounded-lg overflow-hidden">
                    <div className="overflow-x-auto">
                        <table className="min-w-full divide-y divide-gray-200">
                            <thead className="bg-gray-50">
                                <tr>
                                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
                                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Shop</th>
                                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Position</th>
                                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tel No.</th>
                                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">DOB</th>
                                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Join Date</th>
                                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Salary</th>
                                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Supervisor</th>
                                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                    <th className="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                </tr>
                            </thead>
                            <tbody className="bg-white divide-y divide-gray-200">
                                {employees.length > 0 ? employees.map(emp => (
                                    <tr key={emp.id}>
                                        <td className="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">{emp.name}</td>
                                        <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{getNameById(emp.shop, shops)}</td>
                                        <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{getNameById(emp.position, positions)}</td>
                                        <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{emp.telNo}</td>
                                        <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{formatDate(emp.dob)}</td>
                                        <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{formatDate(emp.joinDate)}</td>
                                        <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{formatCurrency(emp.baseSalary)}</td>
                                        <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{getNameById(emp.supervisor, supervisors)}</td>
                                        <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{emp.staffStatus}</td>
                                        <td className="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                                            <button onClick={() => onEdit(emp)} className="text-indigo-600 hover:text-indigo-900 mr-4">Edit</button>
                                            <button onClick={() => handleDelete(emp.id)} className="text-red-600 hover:text-red-900">Delete</button>
                                        </td>
                                    </tr>
                                )) : (
                                    <tr><td colSpan="10" className="text-center py-10 text-gray-500">No employees found.</td></tr>
                                )}
                            </tbody>
                        </table>
                    </div>
                </div>
            );
        }
        
        function ResignedTerminatedTable({ employees, shops }) {
            const getNameById = (id, list) => list.find(item => item.id === id)?.name || 'N/A';

            return (
                <div className="bg-white shadow-md rounded-lg overflow-hidden">
                    <div className="overflow-x-auto">
                        <table className="min-w-full divide-y divide-gray-200">
                            <thead className="bg-gray-50">
                                <tr>
                                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
                                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Shop</th>
                                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Join Date</th>
                                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Staff Status</th>
                                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Time Log</th>
                                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Reason</th>
                                </tr>
                            </thead>
                            <tbody className="bg-white divide-y divide-gray-200">
                                {employees.length > 0 ? employees.map(emp => (
                                    <tr key={emp.id}>
                                        <td className="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">{emp.name}</td>
                                        <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{getNameById(emp.shop, shops)}</td>
                                        <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{formatDate(emp.joinDate)}</td>
                                        <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{emp.staffStatus}</td>
                                        <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{formatDate(emp.statusChangeDate)}</td>
                                        <td className="px-6 py-4 text-sm text-gray-500">{emp.reason}</td>
                                    </tr>
                                )) : (
                                    <tr><td colSpan="6" className="text-center py-10 text-gray-500">No resigned or terminated employees found.</td></tr>
                                )}
                            </tbody>
                        </table>
                    </div>
                </div>
            )
        }

        function EmployeeModal({ db, employee, onClose, shops, positions, supervisors }) {
            const [formData, setFormData] = useState({
                name: '', sex: 'Male', dob: '', nationalId: '', telNo: '', shop: '', position: '',
                shift: 'AM', joinDate: '', baseSalary: '', supervisor: '', staffStatus: 'Active',
                address: '', note: '', statusChangeDate: null, reason: '',
                ...employee
            });
            const [isSaving, setIsSaving] = useState(false);

            const handleChange = (e) => {
                const { name, value } = e.target;
                setFormData(prev => ({ ...prev, [name]: value }));
            };

            const handleSubmit = async (e) => {
                e.preventDefault();
                setIsSaving(true);
                
                let dataToSave = { ...formData };
                
                if ((dataToSave.staffStatus === 'Resigned' || dataToSave.staffStatus === 'Terminated') && employee?.staffStatus === 'Active') {
                    dataToSave.statusChangeDate = new Date().toISOString().slice(0, 10);
                }

                try {
                    const { doc, updateDoc, addDoc, collection } = window.firebaseSDK;
                    if (employee) {
                        await updateDoc(doc(db, "employees", employee.id), dataToSave);
                    } else {
                        await addDoc(collection(db, "employees"), dataToSave);
                    }
                    onClose();
                } catch (err) {
                    console.error("Error saving employee:", err);
                } finally {
                    setIsSaving(false);
                }
            };

            return (
                <div className="modal-overlay">
                    <div className="modal-content">
                        <h3 className="text-xl font-semibold mb-4">{employee ? 'Edit Employee' : 'Add New Employee'}</h3>
                        <form onSubmit={handleSubmit} className="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div><label className="block text-sm font-medium text-gray-700">Name</label><input type="text" name="name" value={formData.name} onChange={handleChange} className="input" required /></div>
                            <div><label className="block text-sm font-medium text-gray-700">Sex</label><select name="sex" value={formData.sex} onChange={handleChange} className="input"><option>Male</option><option>Female</option></select></div>
                            <div><label className="block text-sm font-medium text-gray-700">Date of Birth</label><input type="date" name="dob" value={formData.dob} onChange={handleChange} className="input" /></div>
                            <div><label className="block text-sm font-medium text-gray-700">National ID</label><input type="text" name="nationalId" value={formData.nationalId} onChange={handleChange} className="input" /></div>
                            <div><label className="block text-sm font-medium text-gray-700">Tel No.</label><input type="text" name="telNo" value={formData.telNo} onChange={handleChange} className="input" required /></div>
                            <div><label className="block text-sm font-medium text-gray-700">Shop</label><select name="shop" value={formData.shop} onChange={handleChange} className="input" required><option value="">Select Shop</option>{shops.map(s => <option key={s.id} value={s.id}>{s.name}</option>)}</select></div>
                            <div><label className="block text-sm font-medium text-gray-700">Position</label><select name="position" value={formData.position} onChange={handleChange} className="input" required><option value="">Select Position</option>{positions.map(p => <option key={p.id} value={p.id}>{p.name}</option>)}</select></div>
                            <div><label className="block text-sm font-medium text-gray-700">Shift</label><select name="shift" value={formData.shift} onChange={handleChange} className="input"><option>AM</option><option>PM</option></select></div>
                            <div><label className="block text-sm font-medium text-gray-700">Join Date</label><input type="date" name="joinDate" value={formData.joinDate} onChange={handleChange} className="input" required /></div>
                            <div><label className="block text-sm font-medium text-gray-700">Base Salary</label><input type="number" name="baseSalary" value={formData.baseSalary} onChange={handleChange} className="input" /></div>
                            <div><label className="block text-sm font-medium text-gray-700">Supervisor</label><select name="supervisor" value={formData.supervisor} onChange={handleChange} className="input"><option value="">Select Supervisor</option>{supervisors.map(s => <option key={s.id} value={s.id}>{s.name}</option>)}</select></div>
                            <div><label className="block text-sm font-medium text-gray-700">Staff Status</label><select name="staffStatus" value={formData.staffStatus} onChange={handleChange} className="input"><option>Active</option><option>Resigned</option><option>Terminated</option></select></div>
                            
                            {(formData.staffStatus === 'Resigned' || formData.staffStatus === 'Terminated') && (
                                <div className="md:col-span-2"><label className="block text-sm font-medium text-gray-700">Reason</label><textarea name="reason" value={formData.reason} onChange={handleChange} rows="2" className="input"></textarea></div>
                            )}

                            <div className="md:col-span-2"><label className="block text-sm font-medium text-gray-700">Address</label><textarea name="address" value={formData.address} onChange={handleChange} rows="2" className="input"></textarea></div>
                            <div className="md:col-span-2"><label className="block text-sm font-medium text-gray-700">Note</label><textarea name="note" value={formData.note} onChange={handleChange} rows="2" className="input"></textarea></div>
                            
                            <div className="md:col-span-2 mt-6 flex justify-end space-x-3">
                                <button type="button" onClick={onClose} className="bg-white py-2 px-4 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 hover:bg-gray-50">Cancel</button>
                                <button type="submit" disabled={isSaving} className="bg-blue-600 py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white hover:bg-blue-700 disabled:bg-blue-300">{isSaving ? 'Saving...' : 'Save'}</button>
                            </div>
                        </form>
                    </div>
                </div>
            );
        }

        function EmployeeStatePage({ db, employeeStates, employees, shops }) {
            return (
                <div>
                    <header className="mb-8">
                        <h1 className="text-3xl md:text-4xl font-bold text-gray-800">Employee State</h1>
                        <p className="text-gray-500 mt-1">Track employee deductions and engagements.</p>
                    </header>
                    <DeductionEngagementTab db={db} employeeStates={employeeStates} employees={employees} shops={shops} />
                </div>
            );
        }

        function DeductionEngagementTab({ db, employeeStates, employees, shops }) {
            const [isModalOpen, setIsModalOpen] = useState(false);
            const [editingState, setEditingState] = useState(null);
            
            const openModal = (state = null) => {
                setEditingState(state);
                setIsModalOpen(true);
            };

            const closeModal = () => {
                setEditingState(null);
                setIsModalOpen(false);
            };

            const handleDelete = async (id) => {
                if (await showConfirmation("Are you sure you want to delete this record?")) {
                    try {
                        const { doc, deleteDoc } = window.firebaseSDK;
                        await deleteDoc(doc(db, "employeeStates", id));
                    } catch (e) {
                        console.error("Error deleting document: ", e);
                    }
                }
            };
            
            const getNameById = (id, list) => list.find(item => item.id === id)?.name || 'N/A';

            return (
                <div>
                    <div className="flex justify-end mb-4">
                        <button onClick={() => openModal()} className="bg-blue-600 text-white px-4 py-2 rounded-lg shadow hover:bg-blue-700 transition-colors">
                            Add New Record
                        </button>
                    </div>

                    {isModalOpen && <DeductionEngagementModal db={db} state={editingState} onClose={closeModal} employees={employees} shops={shops} />}

                    <div className="bg-white shadow-md rounded-lg overflow-hidden">
                        <div className="overflow-x-auto">
                            <table className="min-w-full divide-y divide-gray-200">
                                <thead className="bg-gray-50">
                                    <tr>
                                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Staff Name</th>
                                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Shop</th>
                                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status State</th>
                                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Amount (KHR)</th>
                                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Note</th>
                                        <th className="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                    </tr>
                                </thead>
                                <tbody className="bg-white divide-y divide-gray-200">
                                    {employeeStates.map(state => (
                                        <tr key={state.id}>
                                            <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{formatDate(state.date)}</td>
                                            <td className="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">{getNameById(state.employeeId, employees)}</td>
                                            <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{getNameById(state.shopId, shops)}</td>
                                            <td className={`px-6 py-4 whitespace-nowrap text-sm font-semibold ${state.statusState === 'Deduction' ? 'text-red-600' : 'text-blue-600'}`}>{state.statusState}</td>
                                            <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{formatCurrency(state.amount)}</td>
                                            <td className="px-6 py-4 text-sm text-gray-500">{state.note}</td>
                                            <td className="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                                                <button onClick={() => openModal(state)} className="text-indigo-600 hover:text-indigo-900 mr-4">Edit</button>
                                                <button onClick={() => handleDelete(state.id)} className="text-red-600 hover:text-red-900">Delete</button>
                                            </td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            )
        }
        
        function DeductionEngagementModal({ db, state, onClose, employees, shops }) {
            const initialFormState = {
                date: new Date().toISOString().slice(0, 10),
                shopId: '', employeeId: '', statusState: 'Deduction', amount: '', note: ''
            };
            const [formData, setFormData] = useState(state || initialFormState);
            const [filteredEmployees, setFilteredEmployees] = useState([]);
            const [isSaving, setIsSaving] = useState(false);

            useEffect(() => {
                if(formData.shopId) {
                    setFilteredEmployees(employees.filter(emp => emp.shop === formData.shopId && emp.staffStatus === 'Active'));
                }
            }, [formData.shopId, employees]);

            const handleShopChange = (e) => {
                const shopId = e.target.value;
                setFormData(prev => ({ ...prev, shopId, employeeId: '' }));
            };

            const handleChange = (e) => {
                const { name, value } = e.target;
                setFormData(prev => ({ ...prev, [name]: value }));
            };

            const handleSubmit = async (e) => {
                e.preventDefault();
                if (!formData.employeeId || !formData.shopId) {
                    alert("Please select a shop and employee.");
                    return;
                }
                setIsSaving(true);
                try {
                    const { doc, updateDoc, addDoc, collection } = window.firebaseSDK;
                    if (state) {
                        const { id, ...dataToUpdate } = formData;
                        await updateDoc(doc(db, "employeeStates", id), dataToUpdate);
                    } else {
                        await addDoc(collection(db, "employeeStates"), formData);
                    }
                    onClose();
                } catch (error) {
                    console.error("Error saving employee state: ", error);
                } finally {
                    setIsSaving(false);
                }
            };

            return (
                <div className="modal-overlay">
                    <div className="modal-content">
                        <h3 className="text-xl font-semibold mb-4">{state ? 'Edit Record' : 'Add New Record'}</h3>
                        <form onSubmit={handleSubmit} className="space-y-4">
                            <div><label className="block text-sm font-medium text-gray-700">Date</label><input type="date" name="date" value={formData.date} onChange={handleChange} className="input" required /></div>
                            <div>
                                <label className="block text-sm font-medium text-gray-700">Shop</label>
                                <select name="shopId" value={formData.shopId} onChange={handleShopChange} className="input" required>
                                    <option value="">Select Shop</option>
                                    {shops.map(shop => <option key={shop.id} value={shop.id}>{shop.name}</option>)}
                                </select>
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-gray-700">Staff Name</label>
                                <select name="employeeId" value={formData.employeeId} onChange={handleChange} className="input" required disabled={!formData.shopId}>
                                    <option value="">Select Staff</option>
                                    {filteredEmployees.map(emp => <option key={emp.id} value={emp.id}>{emp.name}</option>)}
                                </select>
                            </div>
                            <div><label className="block text-sm font-medium text-gray-700">Status State</label><select name="statusState" value={formData.statusState} onChange={handleChange} className="input"><option>Deduction</option><option>Engagement</option></select></div>
                            <div><label className="block text-sm font-medium text-gray-700">Amount (KHR)</label><input type="number" name="amount" value={formData.amount} onChange={handleChange} className="input" required /></div>
                            <div><label className="block text-sm font-medium text-gray-700">Note</label><textarea name="note" value={formData.note} onChange={handleChange} rows="3" className="input"></textarea></div>
                            <div className="flex justify-end space-x-3 pt-4">
                                <button type="button" onClick={onClose} className="bg-white py-2 px-4 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 hover:bg-gray-50">Cancel</button>
                                <button type="submit" disabled={isSaving} className="bg-blue-600 text-white px-4 py-2 rounded-lg shadow hover:bg-blue-700">{isSaving ? 'Saving...' : 'Save'}</button>
                            </div>
                        </form>
                    </div>
                </div>
            );
        }
        
        // --- LOAN MANAGER COMPONENTS ---
        
        function LoanPaymentModal({ db, loan, onClose }) {
            const [paymentAmount, setPaymentAmount] = useState('');
            const [paymentDate, setPaymentDate] = useState(new Date().toISOString().slice(0, 10));
            const [note, setNote] = useState('');
            const [isSaving, setIsSaving] = useState(false);

            const handleSubmit = async (e) => {
                e.preventDefault();
                const amount = parseFloat(paymentAmount);
                if (isNaN(amount) || amount <= 0) {
                    alert("Please enter a valid payment amount.");
                    return;
                }
                
                setIsSaving(true);
                try {
                    const { runTransaction, doc, collection } = window.firebaseSDK;
                    await runTransaction(db, async (transaction) => {
                        const loanRef = doc(db, "staffLoans", loan.id);
                        const loanDoc = await transaction.get(loanRef);

                        if (!loanDoc.exists()) {
                            throw "Loan document does not exist!";
                        }

                        const currentTotalPaid = loanDoc.data().totalPaid || 0;
                        const newTotalPaid = currentTotalPaid + amount;
                        const newStatus = newTotalPaid >= loanDoc.data().loanAmount ? "Paid Off" : "Active";
                        
                        transaction.update(loanRef, { 
                            totalPaid: newTotalPaid,
                            status: newStatus
                        });

                        const paymentRef = doc(collection(db, "loanPayments"));
                        transaction.set(paymentRef, {
                            loanId: loan.id,
                            employeeId: loan.employeeId,
                            paymentAmount: amount,
                            paymentDate,
                            note
                        });
                    });
                    onClose();
                } catch (error) {
                    console.error("Transaction failed: ", error);
                    alert("Failed to save payment. Please try again.");
                } finally {
                    setIsSaving(false);
                }
            };

            return (
                <div className="modal-overlay">
                    <div className="modal-content">
                        <h3 className="text-xl font-semibold mb-4">Make a Payment</h3>
                        <form onSubmit={handleSubmit}>
                            <div className="mb-4">
                                <label className="block text-sm font-medium text-gray-700">Payment Date</label>
                                <input type="date" value={paymentDate} onChange={e => setPaymentDate(e.target.value)} className="input" required />
                            </div>
                             <div className="mb-4">
                                <label className="block text-sm font-medium text-gray-700">Payment Amount (KHR)</label>
                                <input type="number" value={paymentAmount} onChange={e => setPaymentAmount(e.target.value)} className="input" placeholder="0.00" required />
                            </div>
                             <div className="mb-4">
                                <label className="block text-sm font-medium text-gray-700">Note</label>
                                <textarea value={note} onChange={e => setNote(e.target.value)} rows="3" className="input"></textarea>
                            </div>
                            <div className="mt-6 flex justify-end space-x-3">
                                <button type="button" onClick={onClose} className="bg-white py-2 px-4 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 hover:bg-gray-50">Cancel</button>
                                <button type="submit" disabled={isSaving} className="bg-blue-600 py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white hover:bg-blue-700 disabled:bg-blue-300">{isSaving ? 'Saving...' : 'Save Payment'}</button>
                            </div>
                        </form>
                    </div>
                </div>
            );
        }

        function ActiveLoansTab({ db, staffLoans, employees, shops }) {
            const [isAddLoanModalOpen, setAddLoanModalOpen] = useState(false);
            const [isPaymentModalOpen, setPaymentModalOpen] = useState(false);
            const [isEditLoanModalOpen, setEditLoanModalOpen] = useState(false);
            const [selectedLoan, setSelectedLoan] = useState(null);
            const [filteredEmployees, setFilteredEmployees] = useState([]);
            const initialFormState = { shopId: '', employeeId: '', loanAmount: '', agreedMonthlyDeduction: '', loanDate: new Date().toISOString().slice(0, 10), reason: '' };
            const [formData, setFormData] = useState(initialFormState);

            const getNameById = (id, list) => list.find(item => item.id === id)?.name || 'N/A';

            const handleShopChange = (e) => {
                const shopId = e.target.value;
                setFormData({ ...formData, shopId, employeeId: '' });
                setFilteredEmployees(employees.filter(emp => emp.shop === shopId && emp.staffStatus === 'Active'));
            };

            const handleChange = (e) => {
                const { name, value } = e.target;
                setFormData({ ...formData, [name]: value });
            };

            const handleAddLoan = async (e) => {
                e.preventDefault();
                
                const { collection, addDoc } = window.firebaseSDK;
                const loansRef = collection(db, "staffLoans");
                
                // For simplicity, this implementation adds a new loan record instead of updating an existing one.
                // A more complex implementation could check for existing active loans and merge them.
                const dataToSave = {
                    ...formData,
                    loanAmount: parseFloat(formData.loanAmount),
                    agreedMonthlyDeduction: parseFloat(formData.agreedMonthlyDeduction) || 0,
                    totalPaid: 0,
                    status: 'Active'
                };
                await addDoc(loansRef, dataToSave);

                setFormData(initialFormState);
                setFilteredEmployees([]);
                setAddLoanModalOpen(false);
            };

            const handleEditLoan = (loan) => {
                setSelectedLoan(loan);
                setEditLoanModalOpen(true);
            };
            
            const handleUpdateLoan = async (e) => {
                e.preventDefault();
                const { id, ...dataToUpdate } = selectedLoan;
                dataToUpdate.agreedMonthlyDeduction = parseFloat(dataToUpdate.agreedMonthlyDeduction) || 0;
                const { doc, updateDoc } = window.firebaseSDK;
                await updateDoc(doc(db, "staffLoans", id), dataToUpdate);
                setEditLoanModalOpen(false);
                setSelectedLoan(null);
            };

            const handleDeleteLoan = async (loanId) => {
                 if (await showConfirmation("Are you sure you want to delete this loan? This will also delete all associated payment history.")) {
                    try {
                        const { collection, query, where, getDocs, writeBatch, doc } = window.firebaseSDK;
                        const paymentsRef = collection(db, "loanPayments");
                        const q = query(paymentsRef, where("loanId", "==", loanId));
                        const querySnapshot = await getDocs(q);
                        
                        const batch = writeBatch(db);
                        querySnapshot.forEach(docSnapshot => {
                            batch.delete(docSnapshot.ref);
                        });
                        
                        const loanRef = doc(db, "staffLoans", loanId);
                        batch.delete(loanRef);

                        await batch.commit();
                    } catch (e) {
                        console.error("Error deleting loan and payments:", e);
                    }
                }
            };
            
            const openPaymentModal = (loan) => {
                setSelectedLoan(loan);
                setPaymentModalOpen(true);
            };

            const activeLoans = useMemo(() => staffLoans.filter(loan => loan.status === 'Active'), [staffLoans]);

            return (
                <div>
                    <div className="flex justify-end mb-4">
                        <button onClick={() => setAddLoanModalOpen(true)} className="bg-blue-600 text-white px-4 py-2 rounded-lg shadow hover:bg-blue-700">Add New Loan</button>
                    </div>

                    {isAddLoanModalOpen && (
                        <div className="modal-overlay">
                            <div className="modal-content">
                                <h3 className="text-xl font-semibold mb-4">Add New Loan</h3>
                                <form onSubmit={handleAddLoan} className="space-y-4">
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700">Shop</label>
                                        <select name="shopId" value={formData.shopId} onChange={handleShopChange} className="input" required>
                                            <option value="">Select Shop</option>
                                            {shops.map(shop => <option key={shop.id} value={shop.id}>{shop.name}</option>)}
                                        </select>
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700">Employee</label>
                                        <select name="employeeId" value={formData.employeeId} onChange={handleChange} className="input" required disabled={!formData.shopId}>
                                            <option value="">Select Employee</option>
                                            {filteredEmployees.map(emp => <option key={emp.id} value={emp.id}>{emp.name}</option>)}
                                        </select>
                                    </div>
                                    <div><label className="block text-sm font-medium text-gray-700">Loan Date</label><input type="date" name="loanDate" value={formData.loanDate} onChange={handleChange} className="input" required /></div>
                                    <div><label className="block text-sm font-medium text-gray-700">Loan Amount (KHR)</label><input type="number" name="loanAmount" value={formData.loanAmount} onChange={handleChange} className="input" required /></div>
                                    <div><label className="block text-sm font-medium text-gray-700">Agreed Monthly Deduction (KHR)</label><input type="number" name="agreedMonthlyDeduction" value={formData.agreedMonthlyDeduction} onChange={handleChange} className="input" /></div>
                                    <div><label className="block text-sm font-medium text-gray-700">Reason</label><textarea name="reason" value={formData.reason} onChange={handleChange} rows="3" className="input"></textarea></div>
                                    <div className="flex justify-end space-x-3 pt-4">
                                        <button type="button" onClick={() => setAddLoanModalOpen(false)} className="bg-white py-2 px-4 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 hover:bg-gray-50">Cancel</button>
                                        <button type="submit" className="bg-blue-600 text-white px-4 py-2 rounded-lg shadow hover:bg-blue-700">Save Loan</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    )}

                    {isEditLoanModalOpen && selectedLoan && (
                        <div className="modal-overlay">
                            <div className="modal-content">
                                <h3 className="text-xl font-semibold mb-4">Edit Loan</h3>
                                <form onSubmit={handleUpdateLoan} className="space-y-4">
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700">Employee</label>
                                        <input type="text" value={getNameById(selectedLoan.employeeId, employees)} className="input bg-gray-100" readOnly />
                                    </div>
                                    <div><label className="block text-sm font-medium text-gray-700">Loan Date</label><input type="date" value={selectedLoan.loanDate} onChange={(e) => setSelectedLoan({...selectedLoan, loanDate: e.target.value})} className="input" required /></div>
                                    <div><label className="block text-sm font-medium text-gray-700">Loan Amount (KHR)</label><input type="number" value={selectedLoan.loanAmount} onChange={(e) => setSelectedLoan({...selectedLoan, loanAmount: parseFloat(e.target.value)})} className="input" required /></div>
                                    <div><label className="block text-sm font-medium text-gray-700">Agreed Monthly Deduction (KHR)</label><input type="number" value={selectedLoan.agreedMonthlyDeduction || ''} onChange={(e) => setSelectedLoan({...selectedLoan, agreedMonthlyDeduction: e.target.value})} className="input" /></div>
                                    <div><label className="block text-sm font-medium text-gray-700">Reason</label><textarea value={selectedLoan.reason} onChange={(e) => setSelectedLoan({...selectedLoan, reason: e.target.value})} rows="3" className="input"></textarea></div>
                                    <div className="flex justify-end space-x-3 pt-4">
                                        <button type="button" onClick={() => setEditLoanModalOpen(false)} className="bg-white py-2 px-4 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 hover:bg-gray-50">Cancel</button>
                                        <button type="submit" className="bg-blue-600 text-white px-4 py-2 rounded-lg shadow hover:bg-blue-700">Update Loan</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    )}
                    
                    {isPaymentModalOpen && <LoanPaymentModal db={db} loan={selectedLoan} onClose={() => setPaymentModalOpen(false)} />}

                    <div className="bg-white shadow-md rounded-lg overflow-hidden">
                        <div className="overflow-x-auto">
                            <table className="min-w-full divide-y divide-gray-200">
                                <thead className="bg-gray-50">
                                    <tr>
                                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Employee</th>
                                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Shop</th>
                                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Loan Date</th>
                                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Loan Amount</th>
                                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Monthly Ded.</th>
                                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Paid</th>
                                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Balance</th>
                                        <th className="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">Action</th>
                                    </tr>
                                </thead>
                                <tbody className="bg-white divide-y divide-gray-200">
                                    {activeLoans.map(loan => {
                                        const balance = loan.loanAmount - (loan.totalPaid || 0);
                                        return (
                                        <tr key={loan.id}>
                                            <td className="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">{getNameById(loan.employeeId, employees)}</td>
                                            <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{getNameById(employees.find(e => e.id === loan.employeeId)?.shop, shops)}</td>
                                            <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{formatDate(loan.loanDate)}</td>
                                            <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{formatCurrency(loan.loanAmount)}</td>
                                            <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{formatCurrency(loan.agreedMonthlyDeduction)}</td>
                                            <td className="px-6 py-4 whitespace-nowrap text-sm text-green-600">{formatCurrency(loan.totalPaid)}</td>
                                            <td className="px-6 py-4 whitespace-nowrap text-sm text-red-600">{formatCurrency(balance)}</td>
                                            <td className="px-6 py-4 whitespace-nowrap text-right text-sm font-medium space-x-4">
                                                <button onClick={() => openPaymentModal(loan)} className="text-green-600 hover:text-green-900">Payment</button>
                                                <button onClick={() => handleEditLoan(loan)} className="text-indigo-600 hover:text-indigo-900">Edit</button>
                                                <button onClick={() => handleDeleteLoan(loan.id)} className="text-red-600 hover:text-red-900">Delete</button>
                                            </td>
                                        </tr>
                                    )})}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            )
        }
        
        function HistoryReportTab({ allPayments, employees, shops, staffLoans }) {
            const [filters, setFilters] = useState({ employeeId: '', shopId: '' });

            const handleFilterChange = (e) => {
                const { name, value } = e.target;
                setFilters(prev => ({ ...prev, [name]: value }));
            };

            const getNameById = (id, list) => list.find(item => item.id === id)?.name || 'N/A';
            
            const paymentsWithBalance = useMemo(() => {
                if (!allPayments || !staffLoans) return [];

                const loanMap = new Map(staffLoans.map(loan => [loan.id, loan]));
                
                const paymentsByLoan = allPayments.reduce((acc, p) => {
                    if (!acc[p.loanId]) acc[p.loanId] = [];
                    acc[p.loanId].push(p);
                    return acc;
                }, {});

                const finalPayments = [];
                for (const loanId in paymentsByLoan) {
                    const loan = loanMap.get(loanId);
                    if (!loan) continue;

                    const loanPayments = paymentsByLoan[loanId];
                    loanPayments.sort((a, b) => new Date(a.paymentDate) - new Date(b.paymentDate));
                    
                    let totalPaidSoFar = 0;
                    for (const payment of loanPayments) {
                        totalPaidSoFar += payment.paymentAmount;
                        finalPayments.push({
                            ...payment,
                            remainingBalance: loan.loanAmount - totalPaidSoFar,
                        });
                    }
                }
                
                return finalPayments.sort((a, b) => new Date(b.paymentDate) - new Date(a.paymentDate));

            }, [allPayments, staffLoans]);

            const filteredPayments = useMemo(() => {
                return paymentsWithBalance.filter(payment => {
                    const employee = employees.find(e => e.id === payment.employeeId);
                    const employeeMatch = !filters.employeeId || payment.employeeId === filters.employeeId;
                    const shopMatch = !filters.shopId || (employee && employee.shop === filters.shopId);
                    return employeeMatch && shopMatch;
                });
            }, [paymentsWithBalance, employees, filters]);

            return (
                <div>
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6 p-4 bg-white rounded-lg shadow">
                         <select name="shopId" value={filters.shopId} onChange={handleFilterChange} className="input">
                            <option value="">Filter by Shop</option>
                            {shops.map(s => <option key={s.id} value={s.id}>{s.name}</option>)}
                        </select>
                        <select name="employeeId" value={filters.employeeId} onChange={handleFilterChange} className="input">
                            <option value="">Filter by Employee</option>
                            {employees.map(e => <option key={e.id} value={e.id}>{e.name}</option>)}
                        </select>
                    </div>
                    <div className="bg-white shadow-md rounded-lg overflow-hidden">
                        <div className="overflow-x-auto">
                            <table className="min-w-full divide-y divide-gray-200">
                                <thead className="bg-gray-50">
                                    <tr>
                                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Payment Date</th>
                                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Employee</th>
                                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Shop</th>
                                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Amount Paid</th>
                                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Remain Balance</th>
                                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Note</th>
                                    </tr>
                                </thead>
                                <tbody className="bg-white divide-y divide-gray-200">
                                    {filteredPayments.map(payment => (
                                        <tr key={payment.id}>
                                            <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{formatDate(payment.paymentDate)}</td>
                                            <td className="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">{getNameById(payment.employeeId, employees)}</td>
                                            <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{getNameById(employees.find(e => e.id === payment.employeeId)?.shop, shops)}</td>
                                            <td className="px-6 py-4 whitespace-nowrap text-sm text-green-600">{formatCurrency(payment.paymentAmount)}</td>
                                            <td className="px-6 py-4 whitespace-nowrap text-sm text-red-600">{formatCurrency(payment.remainingBalance)}</td>
                                            <td className="px-6 py-4 text-sm text-gray-500">{payment.note}</td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            );
        }

        function LoanManagerPage({ db, auth, staffLoans, allPayments, employees, shops }) {
            const [activeTab, setActiveTab] = useState('activeLoans');

            const TabButton = ({ tabName, title }) => (
                <button
                    onClick={() => setActiveTab(tabName)}
                    className={`px-4 py-2 text-sm font-medium rounded-md transition-colors duration-200 ${
                        activeTab === tabName ? 'bg-blue-600 text-white shadow-md' : 'bg-white text-gray-700 hover:bg-gray-200'
                    }`}
                >
                    {title}
                </button>
            );

            return (
                 <div>
                    <header className="mb-8">
                        <h1 className="text-3xl md:text-4xl font-bold text-gray-800">Loan Manager</h1>
                        <p className="text-gray-500 mt-1">Manage and track employee loans.</p>
                    </header>
                    <div className="mb-6">
                        <div className="flex space-x-2 bg-gray-200 p-1 rounded-lg">
                            <TabButton tabName="activeLoans" title="Active Loans" />
                            <TabButton tabName="historyReport" title="History Report" />
                        </div>
                    </div>
                    {activeTab === 'activeLoans' && <ActiveLoansTab db={db} staffLoans={staffLoans} employees={employees} shops={shops} />}
                    {activeTab === 'historyReport' && <HistoryReportTab allPayments={allPayments} employees={employees} shops={shops} staffLoans={staffLoans} />}
                </div>
            );
        }

        function PayrollPage({ db, employees, shops, staffLoans, employeeStates, payrolls }) {
            const [activeTab, setActiveTab] = useState('calculator');
            const [payrollToEdit, setPayrollToEdit] = useState(null);

            const handleEdit = (payrollRecord) => {
                setPayrollToEdit(payrollRecord);
                setActiveTab('calculator');
            };

            const TabButton = ({ tabName, title }) => (
                <button
                    onClick={() => setActiveTab(tabName)}
                    className={`px-4 py-2 text-sm font-medium rounded-md transition-colors duration-200 ${
                        activeTab === tabName ? 'bg-blue-600 text-white shadow-md' : 'bg-white text-gray-700 hover:bg-gray-200'
                    }`}
                >
                    {title}
                </button>
            );

            return (
                <div>
                     <header className="mb-8">
                        <h1 className="text-3xl md:text-4xl font-bold text-gray-800">Payroll</h1>
                        <p className="text-gray-500 mt-1">Calculate and manage employee payroll.</p>
                    </header>
                    <div className="mb-6">
                        <div className="flex space-x-2 bg-gray-200 p-1 rounded-lg">
                            <TabButton tabName="calculator" title="Payroll Calculator" />
                            <TabButton tabName="history" title="Payroll History" />
                        </div>
                    </div>
                    {activeTab === 'calculator' && <PayrollCalculator db={db} employees={employees} shops={shops} staffLoans={staffLoans} employeeStates={employeeStates} payrollToEdit={payrollToEdit} setPayrollToEdit={setPayrollToEdit} />}
                    {activeTab === 'history' && <PayrollHistory db={db} payrolls={payrolls} employees={employees} shops={shops} onEdit={handleEdit} />}
                </div>
            );
        }

        function PayrollCalculator({ db, employees, shops, staffLoans, employeeStates, payrollToEdit, setPayrollToEdit }) {
            const [currentDate, setCurrentDate] = useState('');
            const [selectedShop, setSelectedShop] = useState('');
            const [selectedEmployeeId, setSelectedEmployeeId] = useState('');
            const [payrollInput, setPayrollInput] = useState({ workDay: '', givenOff: '', leaveNo: '', loanDed: '', note: '' });
            const [isSaving, setIsSaving] = useState(false);
            const [editingPayrollId, setEditingPayrollId] = useState(null);
            
            useEffect(() => {
                const today = new Date();
                const year = today.getFullYear();
                const month = String(today.getMonth() + 1).padStart(2, '0');
                setCurrentDate(`${year}-${month}`);
            }, []);
            
            useEffect(() => {
                if (payrollToEdit) {
                    setCurrentDate(payrollToEdit.payrollMonth);
                    setSelectedShop(payrollToEdit.shopId);
                    setEditingPayrollId(payrollToEdit.id);
                    setTimeout(() => {
                        setSelectedEmployeeId(payrollToEdit.employeeId);
                        setPayrollInput({
                            workDay: payrollToEdit.workDay || '',
                            givenOff: payrollToEdit.givenOff || '',
                            leaveNo: payrollToEdit.leaveNo || '',
                            loanDed: payrollToEdit.loanDed || '',
                            note: payrollToEdit.note || '',
                        });
                    }, 0);
                    
                    setPayrollToEdit(null);
                }
            }, [payrollToEdit, setPayrollToEdit]);


            const selectedEmployee = useMemo(() => {
                return employees.find(emp => emp.id === selectedEmployeeId) || null;
            }, [selectedEmployeeId, employees]);
            
            useEffect(() => {
                if (selectedEmployee && !editingPayrollId) {
                    const activeLoan = staffLoans.find(loan => loan.employeeId === selectedEmployee.id && loan.status === 'Active');
                    if (activeLoan && activeLoan.agreedMonthlyDeduction) {
                        setPayrollInput(prev => ({ ...prev, loanDed: activeLoan.agreedMonthlyDeduction }));
                    } else {
                        setPayrollInput(prev => ({ ...prev, loanDed: '' }));
                    }
                }
            }, [selectedEmployee, staffLoans, editingPayrollId]);


            const calculatedData = useMemo(() => {
                if (selectedEmployee && currentDate) {
                    const { baseSalary } = selectedEmployee;
                    const { workDay, givenOff, leaveNo, loanDed } = payrollInput;
                    
                    const activeLoan = staffLoans.find(loan => loan.employeeId === selectedEmployee.id && loan.status === 'Active');
                    const loanRemains = activeLoan ? activeLoan.loanAmount - (activeLoan.totalPaid || 0) : 0;
                    
                    const [year, month] = currentDate.split('-').map(Number);

                    const startOfMonth = `${year}-${String(month).padStart(2, '0')}-01`;
                    const daysInMonth = new Date(year, month, 0).getDate();
                    const endOfMonth = `${year}-${String(month).padStart(2, '0')}-${String(daysInMonth).padStart(2, '0')}`;

                    const monthlyStates = employeeStates.filter(state => 
                        state.employeeId === selectedEmployee.id &&
                        state.date >= startOfMonth &&
                        state.date <= endOfMonth
                    );
                    
                    const engage = monthlyStates.filter(s => s.statusState === 'Engagement').reduce((sum, s) => sum + parseFloat(s.amount || 0), 0);
                    const otherDed = monthlyStates.filter(s => s.statusState === 'Deduction').reduce((sum, s) => sum + parseFloat(s.amount || 0), 0);

                    const numWorkDay = parseFloat(workDay) || 0;
                    const numGivenOff = parseFloat(givenOff) || 0;
                    const numLeaveNo = parseFloat(leaveNo) || 0;
                    const numLoanDed = parseFloat(loanDed) || 0;

                    const finalSalary = ((parseFloat(baseSalary) / daysInMonth) * (numWorkDay + numGivenOff - numLeaveNo)) + engage - (numLoanDed + otherDed);

                    return { loanRemains, engage, otherDed, finalSalary: isNaN(finalSalary) ? 0 : finalSalary };
                }
                return { loanRemains: 0, engage: 0, otherDed: 0, finalSalary: 0 };
            }, [selectedEmployee, staffLoans, employeeStates, payrollInput, currentDate]);

            const handleShopChange = (e) => {
                setSelectedShop(e.target.value);
                setSelectedEmployeeId('');
                setPayrollInput({ workDay: '', givenOff: '', leaveNo: '', loanDed: '', note: '' });
            };
            
            const handleEmployeeChange = (e) => {
                setSelectedEmployeeId(e.target.value);
            };

            const handlePayrollInputChange = (e) => {
                const { name, value } = e.target;
                setPayrollInput(prev => ({...prev, [name]: value}));
            };

            const employeesInShop = useMemo(() => {
                if (!selectedShop) return [];
                return employees.filter(emp => emp.shop === selectedShop && emp.staffStatus === 'Active');
            }, [employees, selectedShop]);
            
            const resetForm = () => {
                setSelectedShop('');
                setSelectedEmployeeId('');
                setPayrollInput({ workDay: '', givenOff: '', leaveNo: '', loanDed: '', note: '' });
                setEditingPayrollId(null);
            };

            const handleSavePayroll = async () => {
                if (!selectedEmployee) {
                    alert("Please select an employee first.");
                    return;
                }
                setIsSaving(true);
                
                const payrollData = {
                    employeeId: selectedEmployee.id,
                    shopId: selectedEmployee.shop,
                    payrollMonth: currentDate,
                    baseSalary: selectedEmployee.baseSalary,
                    workDay: parseFloat(payrollInput.workDay) || 0,
                    givenOff: parseFloat(payrollInput.givenOff) || 0,
                    leaveNo: parseFloat(payrollInput.leaveNo) || 0,
                    engage: calculatedData.engage,
                    otherDed: calculatedData.otherDed,
                    loanDed: parseFloat(payrollInput.loanDed) || 0,
                    finalSalary: calculatedData.finalSalary,
                    loanRemains: calculatedData.loanRemains,
                    note: payrollInput.note,
                    createdAt: new Date().toISOString()
                };

                const { runTransaction, doc, collection, query, where, getDocs } = window.firebaseSDK;

                try {
                    if (editingPayrollId) {
                        // --- UPDATE LOGIC ---
                        await runTransaction(db, async (transaction) => {
                            const payrollRef = doc(db, "payrolls", editingPayrollId);
                            const originalPayrollDoc = await transaction.get(payrollRef);
                            if (!originalPayrollDoc.exists()) {
                                throw "Original payroll document not found!";
                            }
                            const oldLoanDed = originalPayrollDoc.data().loanDed || 0;
                            const newLoanDed = payrollData.loanDed;
                            const loanDedDifference = newLoanDed - oldLoanDed;

                            if (loanDedDifference !== 0) {
                                const loansRef = collection(db, "staffLoans");
                                const q = query(loansRef, where("employeeId", "==", selectedEmployee.id), where("status", "==", "Active"));
                                const loanQuerySnapshot = await getDocs(q);
                                if (!loanQuerySnapshot.empty) {
                                    const loanDoc = loanQuerySnapshot.docs[0];
                                    const loanData = loanDoc.data();
                                    const newTotalPaid = (loanData.totalPaid || 0) + loanDedDifference;
                                    transaction.update(loanDoc.ref, { 
                                        totalPaid: newTotalPaid,
                                        status: newTotalPaid >= loanData.loanAmount ? "Paid Off" : "Active"
                                    });
                                }
                            }
                            transaction.update(payrollRef, payrollData);
                        });
                        alert("Payroll updated successfully!");
                    } else {
                        // --- ADD NEW LOGIC ---
                        await runTransaction(db, async (transaction) => {
                            const payrollRef = doc(collection(db, "payrolls"));
                            transaction.set(payrollRef, payrollData);
                            
                            if (payrollData.loanDed > 0) {
                                const loansRef = collection(db, "staffLoans");
                                const q = query(loansRef, where("employeeId", "==", selectedEmployee.id), where("status", "==", "Active"));
                                const loanQuerySnapshot = await getDocs(q);
                                
                                if (!loanQuerySnapshot.empty) {
                                    const loanDoc = loanQuerySnapshot.docs[0];
                                    const loanData = loanDoc.data();
                                    const newTotalPaid = (loanData.totalPaid || 0) + payrollData.loanDed;
                                    transaction.update(loanDoc.ref, {
                                        totalPaid: newTotalPaid,
                                        status: newTotalPaid >= loanData.loanAmount ? "Paid Off" : "Active"
                                    });
                                }
                            }
                        });
                        alert("Payroll saved successfully!");
                    }
                    resetForm();
                } catch (error) {
                    console.error("Error saving payroll:", error);
                    alert(`Failed to save payroll: ${error.message}`);
                } finally {
                    setIsSaving(false);
                }
            };

            return (
                <div className="p-6 bg-white rounded-lg shadow-md">
                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                        {/* Column 1 */}
                        <div className="space-y-4">
                            <div>
                                <label className="block text-sm font-medium text-gray-700">Payroll Month</label>
                                <input type="month" value={currentDate} onChange={e => setCurrentDate(e.target.value)} className="input" />
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-gray-700">Shop Name</label>
                                <select value={selectedShop} onChange={handleShopChange} className="input">
                                    <option value="">Select a shop</option>
                                    {shops.map(shop => <option key={shop.id} value={shop.id}>{shop.name}</option>)}
                                </select>
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-gray-700">Staff Name</label>
                                <select value={selectedEmployeeId} onChange={handleEmployeeChange} className="input" disabled={!selectedShop}>
                                    <option value="">Select an employee</option>
                                    {employeesInShop.map(emp => <option key={emp.id} value={emp.id}>{emp.name}</option>)}
                                </select>
                            </div>
                             <div>
                                <label className="block text-sm font-medium text-gray-700">Sex</label>
                                <input type="text" value={selectedEmployee ? selectedEmployee.sex : ''} className="input bg-gray-100" readOnly />
                            </div>
                        </div>
                        {/* Column 2 */}
                        <div className="space-y-4">
                            <div>
                                <label className="block text-sm font-medium text-gray-700">Base Salary</label>
                                <input type="text" value={selectedEmployee ? formatCurrency(selectedEmployee.baseSalary) : ''} className="input bg-gray-100" readOnly />
                            </div>
                             <div>
                                <label className="block text-sm font-medium text-gray-700">Worked Dur.</label>
                                <input type="text" value={selectedEmployee ? calculateWorkedDuration(selectedEmployee.joinDate) : ''} className="input bg-gray-100" readOnly />
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-gray-700">No. Work Day</label>
                                <input type="number" name="workDay" value={payrollInput.workDay} onChange={handlePayrollInputChange} className="input" disabled={!selectedEmployee} />
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-gray-700">Given Off</label>
                                <input type="number" name="givenOff" value={payrollInput.givenOff} onChange={handlePayrollInputChange} className="input" disabled={!selectedEmployee} />
                            </div>
                        </div>
                         {/* Column 3 */}
                        <div className="space-y-4">
                            <div>
                                <label className="block text-sm font-medium text-gray-700">Leave No</label>
                                <input type="number" name="leaveNo" value={payrollInput.leaveNo} onChange={handlePayrollInputChange} className="input" disabled={!selectedEmployee} />
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-gray-700">Loan Ded</label>
                                <input type="number" name="loanDed" value={payrollInput.loanDed} onChange={handlePayrollInputChange} className="input" disabled={!selectedEmployee} />
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-gray-700">Loan Remains</label>
                                <input type="text" value={formatCurrency(calculatedData.loanRemains)} className="input bg-gray-100" readOnly />
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-gray-700">Note</label>
                                <input type="text" name="note" value={payrollInput.note} onChange={handlePayrollInputChange} className="input" disabled={!selectedEmployee}/>
                            </div>
                        </div>
                         {/* Column 4 */}
                        <div className="space-y-4">
                            <div>
                                <label className="block text-sm font-medium text-gray-700">Engage</label>
                                <input type="text" value={formatCurrency(calculatedData.engage)} className="input bg-gray-100" readOnly />
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-gray-700">Other Ded</label>
                                <input type="text" value={formatCurrency(calculatedData.otherDed)} className="input bg-gray-100" readOnly />
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-gray-700 text-blue-600">Final Salary</label>
                                <input type="text" value={formatCurrency(calculatedData.finalSalary)} className="input bg-blue-50 border-blue-300 font-bold text-blue-600" readOnly />
                            </div>
                        </div>
                    </div>
                    <div className="mt-6 flex justify-end">
                        <button onClick={handleSavePayroll} disabled={!selectedEmployee || isSaving} className="bg-green-600 text-white px-6 py-2 rounded-lg shadow hover:bg-green-700 disabled:bg-gray-400 transition-colors">
                            {isSaving ? 'Saving...' : (editingPayrollId ? 'Update Payroll' : 'Save Payroll')}
                        </button>
                    </div>
                </div>
            );
        }

        function PayrollHistory({ db, payrolls, employees, shops, onEdit }) {
            const [filters, setFilters] = useState({ shopId: '', employeeId: '', month: '' });

            const handleFilterChange = (e) => {
                const { name, value } = e.target;
                setFilters(prev => ({ ...prev, [name]: value }));
            };

            const filteredPayrolls = useMemo(() => {
                return payrolls.filter(p => {
                    const shopMatch = !filters.shopId || p.shopId === filters.shopId;
                    const employeeMatch = !filters.employeeId || p.employeeId === filters.employeeId;
                    const monthMatch = !filters.month || p.payrollMonth === filters.month;
                    return shopMatch && employeeMatch && monthMatch;
                });
            }, [payrolls, filters]);

            const totals = useMemo(() => {
                return filteredPayrolls.reduce((acc, p) => {
                    acc.finalSalary += p.finalSalary || 0;
                    acc.loanDed += p.loanDed || 0;
                    acc.otherDed += p.otherDed || 0;
                    acc.engage += p.engage || 0;
                    acc.leaveNo += p.leaveNo || 0;
                    return acc;
                }, { finalSalary: 0, loanDed: 0, otherDed: 0, engage: 0, leaveNo: 0 });
            }, [filteredPayrolls]);
            
            const getNameById = (id, list) => list.find(item => item.id === id)?.name || 'N/A';
            
            const sortedPayrolls = useMemo(() => {
                return [...filteredPayrolls].sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
            }, [filteredPayrolls]);

            const handleDelete = async (payroll) => {
                if (await showConfirmation("Are you sure you want to delete this payroll record? This will also reverse any loan deduction made.")) {
                    const { runTransaction, doc, collection, query, where, getDocs } = window.firebaseSDK;
                    try {
                        await runTransaction(db, async (transaction) => {
                            const payrollRef = doc(db, "payrolls", payroll.id);
                            
                            if (payroll.loanDed > 0) {
                                const loansRef = collection(db, "staffLoans");
                                const q = query(loansRef, where("employeeId", "==", payroll.employeeId));
                                const loanQuerySnapshot = await getDocs(q);
                                
                                if (!loanQuerySnapshot.empty) {
                                    const loanDoc = loanQuerySnapshot.docs[0];
                                    const loanData = loanDoc.data();
                                    const newTotalPaid = (loanData.totalPaid || 0) - payroll.loanDed;
                                    transaction.update(loanDoc.ref, { 
                                        totalPaid: newTotalPaid < 0 ? 0 : newTotalPaid,
                                        status: "Active"
                                    });
                                }
                            }
                            
                            transaction.delete(payrollRef);
                        });
                        alert("Payroll record deleted successfully.");
                    } catch (error) {
                        console.error("Error deleting payroll:", error);
                        alert(`Failed to delete payroll: ${error.message}`);
                    }
                }
            };

            return (
                <div className="bg-white shadow-md rounded-lg overflow-hidden">
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6 p-4">
                        <select name="shopId" value={filters.shopId} onChange={handleFilterChange} className="input">
                            <option value="">All Shops</option>
                            {shops.map(s => <option key={s.id} value={s.id}>{s.name}</option>)}
                        </select>
                        <select name="employeeId" value={filters.employeeId} onChange={handleFilterChange} className="input">
                            <option value="">All Employees</option>
                            {employees.map(e => <option key={e.id} value={e.id}>{e.name}</option>)}
                        </select>
                        <input type="month" name="month" value={filters.month} onChange={handleFilterChange} className="input" />
                    </div>
                    <div className="overflow-x-auto">
                        <table className="min-w-full divide-y divide-gray-200">
                            <thead className="bg-gray-50">
                                <tr>
                                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Date</th>
                                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Employee</th>
                                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Base Salary</th>
                                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Leave No.</th>
                                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Loan Ded.</th>
                                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Loan Remains</th>
                                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Other Ded.</th>
                                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Engage</th>
                                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Final Salary</th>
                                    <th className="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">Actions</th>
                                </tr>
                            </thead>
                            <tbody className="bg-white divide-y divide-gray-200">
                                {sortedPayrolls.map(p => (
                                    <tr key={p.id}>
                                        <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{p.payrollMonth}</td>
                                        <td className="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">{getNameById(p.employeeId, employees)}</td>
                                        <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{formatCurrency(p.baseSalary)}</td>
                                        <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{p.leaveNo}</td>
                                        <td className="px-6 py-4 whitespace-nowrap text-sm text-red-600">{formatCurrency(p.loanDed)}</td>
                                        <td className="px-6 py-4 whitespace-nowrap text-sm text-red-600">{formatCurrency(p.loanRemains)}</td>
                                        <td className="px-6 py-4 whitespace-nowrap text-sm text-red-600">{formatCurrency(p.otherDed)}</td>
                                        <td className="px-6 py-4 whitespace-nowrap text-sm text-green-600">{formatCurrency(p.engage)}</td>
                                        <td className="px-6 py-4 whitespace-nowrap text-sm font-semibold text-blue-600">{formatCurrency(p.finalSalary)}</td>
                                        <td className="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                                            <button onClick={() => onEdit(p)} className="text-indigo-600 hover:text-indigo-900 mr-4">Edit</button>
                                            <button onClick={() => handleDelete(p)} className="text-red-600 hover:text-red-900">Delete</button>
                                        </td>
                                    </tr>
                                ))}
                            </tbody>
                            <tfoot className="bg-gray-100">
                                <tr>
                                    <td colSpan="3" className="px-6 py-4 text-right font-bold text-gray-600">Sub-Total:</td>
                                    <td className="px-6 py-4 font-bold text-gray-700">{totals.leaveNo}</td>
                                    <td className="px-6 py-4 font-bold text-red-700">{formatCurrency(totals.loanDed)}</td>
                                    <td className="px-6 py-4"></td>
                                    <td className="px-6 py-4 font-bold text-red-700">{formatCurrency(totals.otherDed)}</td>
                                    <td className="px-6 py-4 font-bold text-green-700">{formatCurrency(totals.engage)}</td>
                                    <td className="px-6 py-4 font-bold text-blue-700">{formatCurrency(totals.finalSalary)}</td>
                                    <td colSpan="1"></td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
            );
        }
        
        function ExpenseReportPage({ payrolls, shops }) {
            const getNameById = (id, list) => list.find(item => item.id === id)?.name || 'N/A';
            
            const reportData = useMemo(() => {
                const grouped = payrolls.reduce((acc, p) => {
                    const key = `${p.payrollMonth}-${p.shopId}`;
                    if (!acc[key]) {
                        acc[key] = {
                            month: p.payrollMonth,
                            shopId: p.shopId,
                            totalLoanDed: 0,
                            totalOtherDed: 0,
                            totalEngage: 0,
                            totalFinalSalary: 0,
                            count: 0
                        };
                    }
                    acc[key].totalLoanDed += p.loanDed || 0;
                    acc[key].totalOtherDed += p.otherDed || 0;
                    acc[key].totalEngage += p.engage || 0;
                    acc[key].totalFinalSalary += p.finalSalary || 0;
                    acc[key].count += 1;
                    return acc;
                }, {});

                return Object.values(grouped).sort((a, b) => b.month.localeCompare(a.month));
            }, [payrolls]);

            return (
                <div>
                    <header className="mb-8">
                        <h1 className="text-3xl md:text-4xl font-bold text-gray-800">Expense Report</h1>
                        <p className="text-gray-500 mt-1">A summary of payroll expenses by shop and month.</p>
                    </header>
                     <div className="bg-white shadow-md rounded-lg overflow-hidden">
                        <div className="overflow-x-auto">
                            <table className="min-w-full divide-y divide-gray-200">
                                <thead className="bg-gray-50">
                                    <tr>
                                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">No.</th>
                                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Month</th>
                                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Shop Name</th>
                                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Total Loan Ded.</th>
                                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Total Other Ded.</th>
                                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Total Engage</th>
                                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Total Final Salary</th>
                                    </tr>
                                </thead>
                                <tbody className="bg-white divide-y divide-gray-200">
                                    {reportData.map((row, index) => (
                                        <tr key={`${row.month}-${row.shopId}`}>
                                            <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{index + 1}</td>
                                            <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{row.month}</td>
                                            <td className="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">{getNameById(row.shopId, shops)}</td>
                                            <td className="px-6 py-4 whitespace-nowrap text-sm text-red-600">{formatCurrency(row.totalLoanDed)}</td>
                                            <td className="px-6 py-4 whitespace-nowrap text-sm text-red-600">{formatCurrency(row.totalOtherDed)}</td>
                                            <td className="px-6 py-4 whitespace-nowrap text-sm text-green-600">{formatCurrency(row.totalEngage)}</td>
                                            <td className="px-6 py-4 whitespace-nowrap text-sm font-semibold text-blue-600">{formatCurrency(row.totalFinalSalary)}</td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            );
        }
        
        // --- SETTINGS PAGE & COMPONENTS ---

        function SettingsCRUD({ db, title, collectionName, items, formFields, listColumns }) {
            const [editingItem, setEditingItem] = useState(null);
            const [newItem, setNewItem] = useState({});

            const getInitialState = useCallback(() => {
                return formFields.reduce((acc, field) => {
                    acc[field.name] = (field.type === 'multiselect' || field.type === 'checkbox-group') ? [] : '';
                    return acc;
                }, {});
            }, [formFields]);

            useEffect(() => {
                setNewItem(getInitialState());
            }, [getInitialState]);

            const handleSave = async (item) => {
                const { doc, updateDoc, addDoc, collection } = window.firebaseSDK;
                const dataToSave = { ...item };
                try {
                    if (item.id) {
                        const { id, ...data } = dataToSave;
                        await updateDoc(doc(db, collectionName, id), data);
                    } else {
                        await addDoc(collection(db, collectionName), dataToSave);
                    }
                    setEditingItem(null);
                    setNewItem(getInitialState());
                } catch (e) {
                    console.error(`Error saving ${collectionName}:`, e);
                }
            };
            
            const handleDelete = async (id) => {
                if (await showConfirmation(`Are you sure you want to delete this item?`)) {
                    try {
                        const { doc, deleteDoc } = window.firebaseSDK;
                        await deleteDoc(doc(db, collectionName, id));
                    } catch (e) {
                        console.error(`Error deleting ${collectionName}:`, e);
                    }
                }
            };

            const handleInputChange = (e, item, setItem) => {
                const { name, type, value, checked } = e.target;
                
                if (type === 'checkbox') {
                    const currentValues = item[name] || [];
                    if (checked) {
                        setItem({ ...item, [name]: [...currentValues, value] });
                    } else {
                        setItem({ ...item, [name]: currentValues.filter(val => val !== value) });
                    }
                } else {
                    setItem({ ...item, [name]: value });
                }
            };

            const renderForm = (item, setItem, isNew = false) => (
                 <form onSubmit={(e) => { e.preventDefault(); handleSave(item); }} className="grid grid-cols-1 md:grid-cols-3 gap-4 items-start p-4 bg-gray-50 rounded-lg mb-6">
                    {formFields.map(field => (
                        <div key={field.name}>
                            <label className="block text-sm font-medium text-gray-700">{field.label}</label>
                            {field.type === 'select' ? (
                                <select name={field.name} value={item[field.name] || ''} onChange={(e) => handleInputChange(e, item, setItem)} className="input" required={field.required}>
                                    <option value="">{field.placeholder}</option>
                                    {field.options.map(opt => <option key={opt.id} value={opt.id}>{opt.name}</option>)}
                                </select>
                            ) : field.type === 'checkbox-group' ? (
                                <div className="checkbox-group">
                                    {field.options.map(opt => (
                                        <div key={opt.id} className="flex items-center">
                                            <input
                                                id={`${field.name}-${opt.id}`}
                                                name={field.name}
                                                type="checkbox"
                                                value={opt.id}
                                                checked={(item[field.name] || []).includes(opt.id)}
                                                onChange={(e) => handleInputChange(e, item, setItem)}
                                                className="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500"
                                            />
                                            <label htmlFor={`${field.name}-${opt.id}`} className="ml-2 block text-sm text-gray-900">{opt.name}</label>
                                        </div>
                                    ))}
                                </div>
                            ) : (
                                <input type={field.type} name={field.name} value={item[field.name] || ''} onChange={(e) => handleInputChange(e, item, setItem)} className="input" required={field.required} />
                            )}
                        </div>
                    ))}
                    <div className="self-end">
                        <button type="submit" className="w-full bg-blue-600 text-white px-4 py-2 rounded-lg shadow hover:bg-blue-700 transition-colors">
                            {isNew ? `Add ${title}` : 'Save Changes'}
                        </button>
                        {!isNew && <button type="button" onClick={() => setEditingItem(null)} className="w-full mt-2 bg-gray-200 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-300">Cancel</button>}
                    </div>
                </form>
            );

            return (
                <div className="bg-white p-6 rounded-lg shadow-md">
                    <h2 className="text-2xl font-semibold mb-4">{title} Management</h2>
                    {renderForm(newItem, setNewItem, true)}
                    <div className="overflow-x-auto">
                        <table className="min-w-full divide-y divide-gray-200">
                             <thead className="bg-gray-50">
                                <tr>
                                    {listColumns.map(col => <th key={col.header} className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">{col.header}</th>)}
                                    <th className="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                </tr>
                            </thead>
                            <tbody className="bg-white divide-y divide-gray-200">
                                {items.map(item => (
                                    <tr key={item.id}>
                                        {editingItem?.id === item.id ? (
                                            <td colSpan={listColumns.length + 1}>
                                                {renderForm(editingItem, setEditingItem)}
                                            </td>
                                        ) : (
                                            <>
                                                {listColumns.map(col => (
                                                    <td key={col.header} className="px-6 py-4 whitespace-nowrap text-sm text-gray-600">
                                                        {col.render ? col.render(item) : item[col.accessor]}
                                                    </td>
                                                ))}
                                                <td className="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                                                    <button onClick={() => setEditingItem({ ...item, shops: item.shops || [] })} className="text-indigo-600 hover:text-indigo-900 mr-4">Edit</button>
                                                    <button onClick={() => handleDelete(item.id)} className="text-red-600 hover:text-red-900">Delete</button>
                                                </td>
                                            </>
                                        )}
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                </div>
            );
        }

        function SettingsPage({ db, shops, supervisors, positions }) {
            const [activeTab, setActiveTab] = useState('shops');
            
            const TabButton = ({ tabName, title }) => (
                <button
                    onClick={() => setActiveTab(tabName)}
                    className={`px-4 py-2 text-sm font-medium rounded-md transition-colors duration-200 ${
                        activeTab === tabName ? 'bg-blue-600 text-white shadow-md' : 'bg-white text-gray-700 hover:bg-gray-200'
                    }`}
                >
                    {title}
                </button>
            );

            const shopFormFields = [
                { name: 'name', label: 'Shop Name', type: 'text', required: true },
                { name: 'contact', label: 'Contact', type: 'text', required: false },
                { name: 'address', label: 'Address', type: 'text', required: false }
            ];
            const shopListColumns = [
                { header: 'Shop Name', accessor: 'name' },
                { header: 'Contact', accessor: 'contact' },
                { header: 'Address', accessor: 'address' }
            ];

            const supervisorFormFields = [
                { name: 'name', label: 'Supervisor Name', type: 'text', required: true },
                { name: 'contactNo', label: 'Contact No', type: 'text', required: false },
                { name: 'shops', label: 'Assigned Shops', type: 'checkbox-group', options: shops, required: true }
            ];
            const supervisorListColumns = [
                { header: 'Supervisor Name', accessor: 'name' },
                { header: 'Contact No', accessor: 'contactNo' },
                { 
                    header: 'Assigned Shops', 
                    render: (item) => 
                        item.shops && Array.isArray(item.shops) 
                        ? item.shops
                            .map(shopId => shops.find(s => s.id === shopId)?.name || 'N/A')
                            .join(', ') 
                        : 'N/A' 
                }
            ];

            const positionFormFields = [{ name: 'name', label: 'Position Name', type: 'text', required: true }];
            const positionListColumns = [{ header: 'Position Name', accessor: 'name' }];

            return (
                <div>
                     <header className="mb-8">
                        <h1 className="text-3xl md:text-4xl font-bold text-gray-800">Settings</h1>
                        <p className="text-gray-500 mt-1">Manage your shop, supervisor, and position details.</p>
                    </header>
                    <div className="mb-6">
                        <div className="flex space-x-2 bg-gray-200 p-1 rounded-lg">
                            <TabButton tabName="shops" title="Shop List" />
                            <TabButton tabName="supervisors" title="Supervisors" />
                            <TabButton tabName="positions" title="Positions" />
                        </div>
                    </div>
                    <div>
                        {activeTab === 'shops' && <SettingsCRUD db={db} title="Shop" collectionName="shops" items={shops} formFields={shopFormFields} listColumns={shopListColumns} />}
                        {activeTab === 'supervisors' && <SettingsCRUD db={db} title="Supervisor" collectionName="supervisors" items={supervisors} formFields={supervisorFormFields} listColumns={supervisorListColumns} />}
                        {activeTab === 'positions' && <SettingsCRUD db={db} title="Position" collectionName="positions" items={positions} formFields={positionFormFields} listColumns={positionListColumns} />}
                    </div>
                </div>
            )
        }
        
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
