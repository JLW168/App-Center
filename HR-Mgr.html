<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HR Management System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        @import url('https://rsms.me/inter/inter.css');
        html { font-family: 'Inter', sans-serif; }
        /* A more robust modal overlay for all screen sizes */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 50; /* Ensure it's on top */
            padding: 1rem;
        }
        /* Modal content optimized for responsiveness */
        .modal-content {
            background-color: white;
            padding: 1.5rem;
            border-radius: 0.5rem;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            width: 100%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
        }
        @media (min-width: 640px) {
            .modal-content {
                padding: 2rem;
            }
        }
        /* General input styling */
        .input {
            margin-top: 0.25rem;
            display: block;
            width: 100%;
            padding: 0.75rem 0.75rem;
            border-width: 1px;
            border-color: #D1D5DB;
            border-radius: 0.375rem;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        .input:focus {
            outline: 2px solid transparent;
            outline-offset: 2px;
            border-color: #3B82F6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.3);
        }
        /* Styling for checkbox groups */
        .checkbox-group {
            max-height: 150px;
            overflow-y: auto;
            border: 1px solid #D1D5DB;
            border-radius: 0.375rem;
            padding: 0.75rem;
            margin-top: 0.25rem;
            background-color: #F9FAFB;
        }
        /* Centering select text on all browsers */
        select.input {
            text-align: center;
            -moz-text-align-last: center;
            text-align-last: center;
        }
        /* Custom scrollbar for better aesthetics */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
    </style>
</head>
<body class="bg-gray-100 antialiased">
    <div id="root"></div>

    <script type="module">
        // Make Firebase SDK functions available on the window object
        // so they can be accessed by the React component.
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, doc, addDoc, updateDoc, deleteDoc, setLogLevel, getDocs, serverTimestamp, writeBatch, query, where, runTransaction, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        window.firebaseSDK = {
            initializeApp,
            getAuth,
            onAuthStateChanged,
            signInWithEmailAndPassword,
            signOut,
            getFirestore,
            collection,
            onSnapshot,
            doc,
            addDoc,
            updateDoc,
            deleteDoc,
            setLogLevel,
            getDocs,
            serverTimestamp,
            writeBatch,
            query,
            where,
            runTransaction,
            getDoc
        };
    </script>
    
    <script type="text/babel">
        const { useState, useEffect, useMemo, useCallback, useRef } = React;

        // --- PASTE YOUR FIREBASE CONFIGURATION HERE ---
        const firebaseConfig = {
            apiKey: "AIzaSyBNb5ZI9XIWWSpxGD-FeV94K5FMc2a8udU",
            authDomain: "hr-manager-84ada.firebaseapp.com",
            projectId: "hr-manager-84ada",
            storageBucket: "hr-manager-84ada.firebasestorage.app",
            messagingSenderId: "365563456537",
            appId: "1:365563456537:web:9c5a6fbce7710b4c72ce88",
            measurementId: "G-51R9KT7LC1"
        };
        // ---------------------------------------------

        // --- CENTRALIZED PAGE CONFIGURATION ---
        const PAGES = {
            employees: {
                id: 'employees',
                title: 'Employees',
                icon: <svg className="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M15 21a6 6 0 00-9-5.197M15 11a3 3 0 11-6 0 3 3 0 016 0z" /></svg>,
            },
            employeeState: {
                id: 'employeeState',
                title: 'Employee State',
                icon: <svg className="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z" /></svg>,
            },
            loanManager: {
                id: 'loanManager',
                title: 'Loan Manager',
                icon: <svg className="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm-1-4h.01M12 16h.01" /></svg>,
            },
            payroll: {
                id: 'payroll',
                title: 'Payroll',
                icon: <svg className="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M9 7h6m0 10v-3.25a3.25 3.25 0 00-3.25-3.25H6.25A3.25 3.25 0 003 16.75V20h12V9.25a3.25 3.25 0 00-3.25-3.25H9.25A3.25 3.25 0 006 9.25V10" /></svg>,
            },
            expenseReport: {
                id: 'expenseReport',
                title: 'Expense Report',
                icon: <svg className="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>,
            },
            userActivity: {
                id: 'userActivity',
                title: 'User Activity',
                icon: <svg className="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>,
            },
            settings: {
                id: 'settings',
                title: 'Settings',
                icon: <svg className="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" /><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>,
            },
        };

        // --- PERMISSION HELPER ---
        const hasPermission = (userPermissions, pageId) => {
            if (!userPermissions || !PAGES[pageId]) return false;
            if (userPermissions.role === 'Admin') return true;
            if (Array.isArray(userPermissions.pagePermissions)) {
                return userPermissions.pagePermissions.includes(pageId);
            }
            return false;
        };

        // --- HELPER FUNCTIONS ---
        const formatDate = (dateString) => {
            if (!dateString) return '';
            const date = new Date(dateString);
            const day = String(date.getUTCDate()).padStart(2, '0');
            const month = String(date.getUTCMonth() + 1).padStart(2, '0');
            const year = date.getUTCFullYear();
            return `${day}-${month}-${year}`;
        };
        
        const formatTimestamp = (timestamp) => {
            if (!timestamp || !timestamp.toDate) return 'N/A';
            return timestamp.toDate().toLocaleString('en-GB');
        };

        const formatCurrency = (number) => {
            if (number === null || number === undefined || number === '' || isNaN(number)) return '';
            return Number(number).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        };
        
        const calculateWorkedDuration = (joinDate) => {
            if (!joinDate) return 'N/A';
            const start = new Date(joinDate);
            const end = new Date();
            let years = end.getFullYear() - start.getFullYear();
            let months = end.getMonth() - start.getMonth();
            let days = end.getDate() - start.getDate();
            if (days < 0) {
                months--;
                days += new Date(end.getFullYear(), end.getMonth(), 0).getDate();
            }
            if (months < 0) {
                years--;
                months += 12;
            }
            const totalMonths = years * 12 + months;
            return `${totalMonths}M-${days}D`;
        };
        
        function showConfirmation(message) {
            return new Promise((resolve) => {
                const confirmationBox = document.createElement('div');
                confirmationBox.className = 'modal-overlay';
                confirmationBox.innerHTML = `
                    <div class="modal-content text-center">
                        <p class="mb-4 text-lg">${message}</p>
                        <div class="flex justify-center space-x-4">
                            <button id="confirm-yes" class="bg-red-600 text-white px-6 py-2 rounded-lg shadow hover:bg-red-700 transition-transform transform hover:scale-105">Yes, delete</button>
                            <button id="confirm-no" class="bg-white px-6 py-2 border border-gray-300 rounded-lg shadow-sm text-gray-700 hover:bg-gray-50 transition-transform transform hover:scale-105">Cancel</button>
                        </div>
                    </div>
                `;
                document.body.appendChild(confirmationBox);
                document.getElementById('confirm-yes').onclick = () => {
                    document.body.removeChild(confirmationBox);
                    resolve(true);
                };
                document.getElementById('confirm-no').onclick = () => {
                    document.body.removeChild(confirmationBox);
                    resolve(false);
                };
            });
        }
        
        const useCollection = (db, collectionName) => {
            const [data, setData] = useState([]);
            const [loading, setLoading] = useState(true);

            useEffect(() => {
                if (!db) {
                    setLoading(false);
                    return;
                };
                const { collection, onSnapshot, query } = window.firebaseSDK;
                const q = query(collection(db, collectionName));
                const unsubscribe = onSnapshot(q, (querySnapshot) => {
                    const items = [];
                    querySnapshot.forEach((doc) => {
                        items.push({ id: doc.id, ...doc.data() });
                    });
                    setData(items);
                    setLoading(false);
                }, (error) => {
                    console.error(`Error fetching ${collectionName}:`, error);
                    setLoading(false);
                });
                return () => unsubscribe();
            }, [db, collectionName]);

            return { data, loading };
        };

        function LoginPage({ auth }) {
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [error, setError] = useState('');
            const [loading, setLoading] = useState(false);
            const [showPassword, setShowPassword] = useState(false);
            const [rememberMe, setRememberMe] = useState(false);
            const { signInWithEmailAndPassword } = window.firebaseSDK;

            const handleLogin = async (e) => {
                e.preventDefault();
                setLoading(true);
                setError('');
                try {
                    await signInWithEmailAndPassword(auth, email, password);
                } catch (err) {
                    setError("Failed to sign in. Please check your credentials.");
                } finally {
                    setLoading(false);
                }
            };

            return (
                <div className="min-h-screen bg-gray-100 text-gray-900 flex justify-center items-center p-4">
                    <div className="max-w-screen-xl m-0 sm:m-10 bg-white shadow sm:rounded-lg flex justify-center flex-1">
                        <div className="lg:w-1/2 xl:w-5/12 p-6 sm:p-12">
                            <div className="mt-12 flex flex-col items-center">
                                <h1 className="text-2xl xl:text-3xl font-extrabold">HR Manager</h1>
                                <p className="text-center text-sm text-gray-500 mt-2">Internal Human Resources Portal</p>
                                <div className="w-full flex-1 mt-8">
                                    <form onSubmit={handleLogin} className="mx-auto max-w-xs">
                                        <input
                                            className="w-full px-8 py-4 rounded-lg font-medium bg-gray-100 border border-gray-200 placeholder-gray-500 text-sm focus:outline-none focus:border-gray-400 focus:bg-white"
                                            type="email"
                                            placeholder="Email"
                                            value={email}
                                            onChange={e => setEmail(e.target.value)}
                                            required
                                        />
                                        <div className="relative mt-5">
                                            <input
                                                className="w-full px-8 py-4 rounded-lg font-medium bg-gray-100 border border-gray-200 placeholder-gray-500 text-sm focus:outline-none focus:border-gray-400 focus:bg-white"
                                                type={showPassword ? "text" : "password"}
                                                placeholder="Password"
                                                value={password}
                                                onChange={e => setPassword(e.target.value)}
                                                required
                                            />
                                            <div className="absolute inset-y-0 right-0 pr-3 flex items-center text-sm leading-5">
                                                 <svg onClick={() => setShowPassword(!showPassword)} className="h-6 w-6 text-gray-700 cursor-pointer" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d={showPassword ? "M15 12a3 3 0 11-6 0 3 3 0 016 0z" : "M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242"} />
                                                    {showPassword && <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242" />}
                                                </svg>
                                            </div>
                                        </div>
                                        <div className="flex justify-between items-center mt-4">
                                            <label className="flex items-center text-xs">
                                                <input type="checkbox" name="remember" className="mr-2" checked={rememberMe} onChange={() => setRememberMe(!rememberMe)} />
                                                <span className="text-gray-800 font-semibold">Remember me</span>
                                            </label>
                                            <a href="#" className="text-xs font-semibold text-blue-600 hover:text-blue-800">Forgot Password?</a>
                                        </div>
                                        {error && <p className="text-red-500 text-xs mt-4 text-center">{error}</p>}
                                        <button
                                            type="submit"
                                            disabled={loading}
                                            className="mt-5 tracking-wide font-semibold bg-blue-600 text-gray-100 w-full py-4 rounded-lg hover:bg-blue-700 transition-all duration-300 ease-in-out flex items-center justify-center focus:shadow-outline focus:outline-none disabled:bg-blue-400"
                                        >
                                            {loading ? (
                                                <svg className="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                                    <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                                                    <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                                </svg>
                                            ) : (
                                                <svg className="w-6 h-6 -ml-2" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                                                    <path d="M16 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2" />
                                                    <circle cx="8.5" cy="7" r="4" />
                                                    <path d="M20 8v6M23 11h-6" />
                                                </svg>
                                            )}
                                            <span className="ml-3">{loading ? 'Signing In...' : 'Sign In'}</span>
                                        </button>
                                    </form>
                                </div>
                            </div>
                        </div>
                        <div className="flex-1 bg-blue-100 text-center hidden lg:flex">
                            <div
                                className="m-12 xl:m-16 w-full bg-contain bg-center bg-no-repeat"
                                style={{ backgroundImage: "url('https://storage.googleapis.com/devitary-image-host.appspot.com/15848031292911696601-undraw_designer_life_w96d.svg')" }}
                            ></div>
                        </div>
                    </div>
                </div>
            );
        }

        function App() {
            const [db, setDb] = useState(null);
            const [auth, setAuth] = useState(null);
            const [initStatus, setInitStatus] = useState('pending');
            const [errorMsg, setErrorMsg] = useState('');
            const [currentUser, setCurrentUser] = useState(null);
            const [userPermissions, setUserPermissions] = useState(null);
            const [authLoading, setAuthLoading] = useState(true);

            useEffect(() => {
                const { initializeApp, getFirestore, getAuth, setLogLevel, onAuthStateChanged, collection, query, where, getDocs } = window.firebaseSDK;
                try {
                    const app = initializeApp(firebaseConfig);
                    const firestore = getFirestore(app);
                    const authInstance = getAuth(app);
                    setLogLevel('debug');
                    setDb(firestore);
                    setAuth(authInstance);

                    const unsubscribe = onAuthStateChanged(authInstance, async (user) => {
                        if (user) {
                            setCurrentUser(user);
                            try {
                                const supervisorsRef = collection(firestore, "supervisors");
                                const q = query(supervisorsRef, where("uid", "==", user.uid));
                                const querySnapshot = await getDocs(q);
                                if (!querySnapshot.empty) {
                                    setUserPermissions({ id: querySnapshot.docs[0].id, ...querySnapshot.docs[0].data() });
                                } else {
                                    setUserPermissions(null);
                                }
                            } catch (e) {
                                console.error("Error fetching user permissions:", e);
                                setUserPermissions(null);
                                setErrorMsg("Could not fetch user permissions.");
                                setInitStatus('error');
                            }
                        } else {
                            setCurrentUser(null);
                            setUserPermissions(null);
                        }
                        setAuthLoading(false);
                    });
                    setInitStatus('success');
                    return () => unsubscribe();

                } catch (e) {
                    console.error("Firebase initialization error:", e);
                    setErrorMsg("Failed to initialize. Please check Firebase config.");
                    setInitStatus('error');
                    setAuthLoading(false);
                }
            }, []);

            if (initStatus === 'pending' || authLoading) {
                return <div className="flex justify-center items-center h-screen"><div className="text-xl font-semibold">Initializing...</div></div>;
            }

            if (initStatus === 'error') {
                return (
                    <div className="flex items-center justify-center h-screen p-8">
                        <div className="bg-red-100 border-l-4 border-red-500 text-red-700 p-6 rounded-lg shadow-md max-w-2xl">
                            <p className="font-bold text-xl mb-2">Application Error</p>
                            <p>{errorMsg}</p>
                        </div>
                    </div>
                );
            }

            if (!currentUser || !userPermissions) {
                return <LoginPage auth={auth} />;
            }
            
            return <MainApp db={db} auth={auth} userPermissions={userPermissions} />;
        }
        
        function MainApp({ db, auth, userPermissions }) {
            const [currentPage, setCurrentPage] = useState(userPermissions.pagePermissions?.[0] || 'employees');
            const [isSidebarOpen, setIsSidebarOpen] = useState(false);

            const { data: employees, loading: employeesLoading } = useCollection(db, 'employees');
            const { data: shops, loading: shopsLoading } = useCollection(db, 'shops');
            const { data: positions, loading: positionsLoading } = useCollection(db, 'positions');
            const { data: supervisors, loading: supervisorsLoading } = useCollection(db, 'supervisors');
            const { data: employeeStates, loading: employeeStatesLoading } = useCollection(db, 'employeeStates');
            const { data: staffLoans, loading: staffLoansLoading } = useCollection(db, 'staffLoans');
            const { data: allPayments, loading: allPaymentsLoading } = useCollection(db, 'loanPayments');
            const { data: payrolls, loading: payrollsLoading } = useCollection(db, 'payrolls');
            const { data: otReports, loading: otReportsLoading } = useCollection(db, 'otReports');
            const { data: salaryRevisions, loading: salaryRevisionsLoading } = useCollection(db, 'salaryRevisions');
            const { data: userLogs, loading: userLogsLoading } = useCollection(db, 'userLogs');
            const { data: leaveRequests, loading: leaveRequestsLoading } = useCollection(db, 'leaveRequests');

            const isLoading = employeesLoading || shopsLoading || positionsLoading || supervisorsLoading || employeeStatesLoading || staffLoansLoading || allPaymentsLoading || payrollsLoading || otReportsLoading || salaryRevisionsLoading || userLogsLoading || leaveRequestsLoading;
            
            const filteredShops = useMemo(() => {
                if (userPermissions.role === 'Admin') return shops;
                if (!userPermissions.shops) return [];
                return shops.filter(shop => userPermissions.shops.includes(shop.id));
            }, [shops, userPermissions]);

            const filteredEmployees = useMemo(() => {
                if (userPermissions.role === 'Admin') return employees;
                if (!userPermissions.shops) return [];
                return employees.filter(emp => userPermissions.shops.includes(emp.shop));
            }, [employees, userPermissions]);

            const allowedEmployeeIds = useMemo(() => new Set(filteredEmployees.map(e => e.id)), [filteredEmployees]);
            const filteredEmployeeStates = useMemo(() => employeeStates.filter(state => allowedEmployeeIds.has(state.employeeId)), [employeeStates, allowedEmployeeIds]);
            const filteredStaffLoans = useMemo(() => staffLoans.filter(loan => allowedEmployeeIds.has(loan.employeeId)), [staffLoans, allowedEmployeeIds]);
            const filteredAllPayments = useMemo(() => allPayments.filter(payment => allowedEmployeeIds.has(payment.employeeId)), [allPayments, allowedEmployeeIds]);
            const filteredPayrolls = useMemo(() => payrolls.filter(p => allowedEmployeeIds.has(p.employeeId)), [payrolls, allowedEmployeeIds]);
            const filteredOtReports = useMemo(() => otReports.filter(ot => allowedEmployeeIds.has(ot.employeeId)), [otReports, allowedEmployeeIds]);
            const filteredSalaryRevisions = useMemo(() => salaryRevisions.filter(sr => allowedEmployeeIds.has(sr.employeeId)), [salaryRevisions, allowedEmployeeIds]);
            const filteredLeaveRequests = useMemo(() => leaveRequests.filter(lr => allowedEmployeeIds.has(lr.employeeId)), [leaveRequests, allowedEmployeeIds]);

            const renderPage = () => {
                if (isLoading) {
                    return <div className="flex justify-center items-center h-full"><div className="text-xl font-semibold">Loading Data...</div></div>;
                }

                if (!hasPermission(userPermissions, currentPage)) {
                    const firstPermittedPage = Object.keys(PAGES).find(pageId => hasPermission(userPermissions, pageId));
                    if(firstPermittedPage && currentPage !== firstPermittedPage) {
                        setCurrentPage(firstPermittedPage);
                    }
                    return <AccessDeniedPage />;
                }

                switch (currentPage) {
                    case 'employees':
                        return <EmployeePage db={db} auth={auth} employees={filteredEmployees} shops={filteredShops} positions={positions} supervisors={supervisors} salaryRevisions={filteredSalaryRevisions} userPermissions={userPermissions} />;
                    case 'employeeState':
                        return <EmployeeStatePage db={db} auth={auth} employeeStates={filteredEmployeeStates} employees={filteredEmployees} shops={filteredShops} />;
                    case 'loanManager':
                        return <LoanManagerPage db={db} auth={auth} staffLoans={filteredStaffLoans} allPayments={filteredAllPayments} employees={filteredEmployees} shops={filteredShops} />;
                    case 'payroll':
                        return <PayrollPage db={db} auth={auth} employees={filteredEmployees} shops={filteredShops} staffLoans={filteredStaffLoans} employeeStates={filteredEmployeeStates} payrolls={filteredPayrolls} otReports={filteredOtReports} leaveRequests={filteredLeaveRequests} supervisors={supervisors} userPermissions={userPermissions}/>;
                    case 'expenseReport':
                        return <ExpenseReportPage payrolls={filteredPayrolls} shops={filteredShops} />;
                    case 'userActivity':
                        return <UserActivityPage userLogs={userLogs} supervisors={supervisors} shops={shops} />;
                    case 'settings':
                        return <SettingsPage db={db} auth={auth} shops={shops} supervisors={supervisors} positions={positions} />;
                    default:
                        return <AccessDeniedPage />;
                }
            };
            
            return (
                <div className="flex min-h-screen bg-gray-50">
                    <Sidebar currentPage={currentPage} setCurrentPage={setCurrentPage} isSidebarOpen={isSidebarOpen} setIsSidebarOpen={setIsSidebarOpen} userPermissions={userPermissions} auth={auth} />
                    <div className="flex-1 flex flex-col md:ml-64">
                         <button onClick={() => setIsSidebarOpen(!isSidebarOpen)} className="md:hidden fixed top-4 right-4 z-40 bg-blue-600 text-white p-2 rounded-full shadow-lg">
                            <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M4 6h16M4 12h16m-7 6h7"></path></svg>
                        </button>
                        <main className="flex-grow p-4 sm:p-6 lg:p-8">
                            {renderPage()}
                        </main>
                    </div>
                </div>
            );
        }

        function Sidebar({ currentPage, setCurrentPage, isSidebarOpen, setIsSidebarOpen, userPermissions, auth }) {
            const { signOut } = window.firebaseSDK;
            const handleLogout = () => {
                signOut(auth).catch(error => console.error("Logout failed:", error));
            };

            return (
                <>
                    <div
                        className={`fixed inset-0 bg-black bg-opacity-50 z-40 transition-opacity md:hidden ${
                            isSidebarOpen ? 'opacity-100' : 'opacity-0 pointer-events-none'
                        }`}
                        onClick={() => setIsSidebarOpen(false)}
                    ></div>
                    <aside className={`fixed top-0 left-0 h-full w-64 bg-white shadow-xl p-4 flex flex-col z-50 transform transition-transform md:translate-x-0 ${isSidebarOpen ? 'translate-x-0' : '-translate-x-full'}`}>
                        <div>
                            <div className="text-2xl font-bold text-gray-800 mb-2">HR Manager</div>
                            <div className="text-sm text-gray-500 mb-8">Welcome, {userPermissions.name}</div>
                        </div>
                        <nav className="flex flex-col space-y-2 flex-grow">
                           {Object.values(PAGES).map(page => {
                                if (hasPermission(userPermissions, page.id)) {
                                    return (
                                        <button
                                            key={page.id}
                                            onClick={() => {
                                                setCurrentPage(page.id);
                                                if (window.innerWidth < 768) {
                                                   setIsSidebarOpen(false);
                                                }
                                            }}
                                            className={`flex items-center w-full px-4 py-3 text-left transition-all duration-200 rounded-lg transform hover:scale-105 ${
                                                currentPage === page.id ? 'bg-blue-600 text-white shadow-md' : 'text-gray-600 hover:bg-gray-200 hover:text-gray-800'
                                            }`}
                                        >
                                            {page.icon}
                                            <span className="font-medium">{page.title}</span>
                                        </button>
                                    );
                                }
                                return null;
                            })}
                        </nav>
                        <div className="mt-auto">
                            <button onClick={handleLogout} className="flex items-center w-full px-4 py-3 text-left text-red-600 hover:bg-red-100 rounded-lg transition-colors">
                                <svg className="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path></svg>
                                <span>Logout</span>
                            </button>
                        </div>
                    </aside>
                </>
            );
        }

        function AccessDeniedPage() {
            return (
                <div className="flex flex-col items-center justify-center h-[calc(100vh-4rem)] text-center p-8">
                    <svg className="w-24 h-24 text-red-500 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636"></path></svg>
                    <h1 className="text-4xl font-bold text-gray-800">Access Denied</h1>
                    <p className="text-gray-500 mt-2">You do not have the necessary permissions to view this page.</p>
                    <p className="text-gray-500 mt-1">Please contact your administrator if you believe this is an error.</p>
                </div>
            );
        }

        function EmployeePage({ db, auth, employees, shops, positions, supervisors, salaryRevisions, userPermissions }) {
            const [isModalOpen, setIsModalOpen] = useState(false);
            const [editingEmployee, setEditingEmployee] = useState(null);
            const [filters, setFilters] = useState({ shop: '', name: '', joinDate: '', status: 'Active' });
            const [activeTab, setActiveTab] = useState('active');

            const TabButton = ({ tabName, title }) => (
                <button
                    onClick={() => setActiveTab(tabName)}
                    className={`px-3 py-2 text-sm font-medium rounded-md transition-colors duration-200 flex-grow text-center sm:flex-grow-0 ${
                        activeTab === tabName ? 'bg-blue-600 text-white shadow-md' : 'bg-white text-gray-700 hover:bg-gray-200'
                    }`}
                >
                    {title}
                </button>
            );

            const openModal = useCallback((employee = null) => {
                setEditingEmployee(employee);
                setIsModalOpen(true);
            }, []);
            
            const closeModal = useCallback(() => {
                setIsModalOpen(false);
                setEditingEmployee(null);
            }, []);

            const handleFilterChange = useCallback((e) => {
                const { name, value } = e.target;
                setFilters(prev => ({ ...prev, [name]: value }));
            }, []);
            
            const filteredEmployees = useMemo(() => {
                const listToFilter = activeTab === 'active' 
                    ? employees.filter(e => e.staffStatus === 'Active')
                    : employees.filter(e => e.staffStatus === 'Resigned' || e.staffStatus === 'Terminated');

                return listToFilter.filter(emp => 
                    (!filters.shop || emp.shop === filters.shop) &&
                    (!filters.name || emp.name.toLowerCase().includes(filters.name.toLowerCase())) &&
                    (!filters.joinDate || emp.joinDate === filters.joinDate)
                );
            }, [employees, filters, activeTab]);

            return (
                <div className="space-y-6">
                    <header>
                        <h1 className="text-3xl md:text-4xl font-bold text-gray-800">Employee Management</h1>
                        <p className="text-gray-500 mt-1">Add, edit, and manage your employee records.</p>
                    </header>
                    
                    <div className="flex flex-wrap gap-2 bg-gray-200 p-1 rounded-lg">
                        <TabButton tabName="active" title="Active Employees" />
                        <TabButton tabName="resignedTerminated" title="Resigned/Terminated" />
                        <TabButton tabName="salaryRevise" title="Salary Revise Report" />
                    </div>

                    {activeTab === 'active' && (
                        <>
                            <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                                <h2 className="text-2xl font-semibold text-gray-700">Active Employees</h2>
                                <button onClick={() => openModal()} className="bg-blue-600 text-white px-4 py-2 rounded-lg shadow hover:bg-blue-700 transition-colors w-full sm:w-auto">
                                    Add Employee
                                </button>
                            </div>
                            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 p-4 bg-white rounded-lg shadow">
                                <select name="shop" value={filters.shop} onChange={handleFilterChange} className="input">
                                    <option value="">All Shops</option>
                                    {shops.map(s => <option key={s.id} value={s.id}>{s.name}</option>)}
                                </select>
                                <input type="text" name="name" placeholder="Filter by Name..." value={filters.name} onChange={handleFilterChange} className="input" />
                                <input type="date" name="joinDate" value={filters.joinDate} onChange={handleFilterChange} className="input" />
                            </div>
                            <EmployeeHistoryTable db={db} employees={filteredEmployees} onEdit={openModal} shops={shops} positions={positions} supervisors={supervisors} />
                        </>
                    )}

                    {activeTab === 'resignedTerminated' && (
                        <>
                            <h2 className="text-2xl font-semibold text-gray-700">Resigned/Terminated Employees</h2>
                            <ResignedTerminatedTable employees={filteredEmployees} shops={shops} />
                        </>
                    )}

                    {activeTab === 'salaryRevise' && (
                        <SalaryReviseTab db={db} auth={auth} employees={employees} shops={shops} salaryRevisions={salaryRevisions} userPermissions={userPermissions} />
                    )}

                    {isModalOpen && <EmployeeModal db={db} auth={auth} employee={editingEmployee} onClose={closeModal} shops={shops} positions={positions} supervisors={supervisors} />}
                </div>
            );
        }

        function EmployeeHistoryTable({ db, employees, onEdit, shops, positions, supervisors }) {
            const handleDelete = async (id) => {
                if (await showConfirmation("Are you sure you want to delete this employee?")) {
                    try {
                        const { doc, deleteDoc } = window.firebaseSDK;
                        await deleteDoc(doc(db, "employees", id));
                    } catch (e) {
                        console.error("Error deleting document: ", e);
                    }
                }
            };
            
            const getNameById = (id, list) => list.find(item => item.id === id)?.name || 'N/A';

            return (
                <div className="bg-white shadow-md rounded-lg overflow-hidden">
                    <div className="overflow-x-auto">
                        <table className="min-w-full divide-y divide-gray-200">
                            <thead className="bg-gray-50">
                                <tr>
                                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
                                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Shop</th>
                                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider hidden md:table-cell">Position</th>
                                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider hidden lg:table-cell">Join Date</th>
                                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Salary</th>
                                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider hidden lg:table-cell">Status</th>
                                    <th className="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                </tr>
                            </thead>
                            <tbody className="bg-white divide-y divide-gray-200">
                                {employees.length > 0 ? employees.map(emp => (
                                    <tr key={emp.id}>
                                        <td className="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">{emp.name}</td>
                                        <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{getNameById(emp.shop, shops)}</td>
                                        <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500 hidden md:table-cell">{getNameById(emp.position, positions)}</td>
                                        <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500 hidden lg:table-cell">{formatDate(emp.joinDate)}</td>
                                        <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{formatCurrency(emp.baseSalary)}</td>
                                        <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500 hidden lg:table-cell">{emp.staffStatus}</td>
                                        <td className="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                                            <button onClick={() => onEdit(emp)} className="text-indigo-600 hover:text-indigo-900 mr-4">Edit</button>
                                            <button onClick={() => handleDelete(emp.id)} className="text-red-600 hover:text-red-900">Delete</button>
                                        </td>
                                    </tr>
                                )) : (
                                    <tr><td colSpan="10" className="text-center py-10 text-gray-500">No employees found.</td></tr>
                                )}
                            </tbody>
                        </table>
                    </div>
                </div>
            );
        }
        
        function ResignedTerminatedTable({ employees, shops }) {
            const getNameById = (id, list) => list.find(item => item.id === id)?.name || 'N/A';

            return (
                <div className="bg-white shadow-md rounded-lg overflow-hidden">
                    <div className="overflow-x-auto">
                        <table className="min-w-full divide-y divide-gray-200">
                            <thead className="bg-gray-50">
                                <tr>
                                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
                                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Shop</th>
                                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Join Date</th>
                                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Staff Status</th>
                                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Time Log</th>
                                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Reason</th>
                                </tr>
                            </thead>
                            <tbody className="bg-white divide-y divide-gray-200">
                                {employees.length > 0 ? employees.map(emp => (
                                    <tr key={emp.id}>
                                        <td className="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">{emp.name}</td>
                                        <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{getNameById(emp.shop, shops)}</td>
                                        <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{formatDate(emp.joinDate)}</td>
                                        <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{emp.staffStatus}</td>
                                        <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{formatDate(emp.statusChangeDate)}</td>
                                        <td className="px-6 py-4 text-sm text-gray-500 break-words min-w-[200px]">{emp.reason}</td>
                                    </tr>
                                )) : (
                                    <tr><td colSpan="6" className="text-center py-10 text-gray-500">No resigned or terminated employees found.</td></tr>
                                )}
                            </tbody>
                        </table>
                    </div>
                </div>
            )
        }

        function EmployeeModal({ db, auth, employee, onClose, shops, positions, supervisors }) {
            const [formData, setFormData] = useState({
                name: '', sex: 'Male', dob: '', nationalId: '', telNo: '', shop: '', position: '',
                shift: 'AM', joinDate: '', baseSalary: '', supervisor: '', staffStatus: 'Active',
                address: '', note: '', statusChangeDate: null, reason: '',
                ...employee
            });
            const [isSaving, setIsSaving] = useState(false);

            const handleChange = (e) => {
                const { name, value } = e.target;
                setFormData(prev => ({ ...prev, [name]: value }));
            };

            const handleSubmit = async (e) => {
                e.preventDefault();
                setIsSaving(true);
                
                let dataToSave = { ...formData };
                
                if ((dataToSave.staffStatus === 'Resigned' || dataToSave.staffStatus === 'Terminated') && employee?.staffStatus === 'Active') {
                    dataToSave.statusChangeDate = new Date().toISOString().slice(0, 10);
                }

                try {
                    const { doc, updateDoc, addDoc, collection, serverTimestamp } = window.firebaseSDK;
                    if (employee) {
                        await updateDoc(doc(db, "employees", employee.id), dataToSave);
                        await addDoc(collection(db, "userLogs"), {
                            userId: auth.currentUser.uid,
                            activity: `Updated employee: ${employee.name}`,
                            timestamp: serverTimestamp(),
                            originalData: employee,
                            updatedData: dataToSave
                        });
                    } else {
                        const newDocRef = await addDoc(collection(db, "employees"), dataToSave);
                        await addDoc(collection(db, "userLogs"), {
                            userId: auth.currentUser.uid,
                            activity: `Added new employee: ${dataToSave.name}`,
                            timestamp: serverTimestamp(),
                            originalData: {},
                            updatedData: { id: newDocRef.id, ...dataToSave }
                        });
                    }
                    onClose();
                } catch (err) {
                    console.error("Error saving employee:", err);
                } finally {
                    setIsSaving(false);
                }
            };

            return (
                <div className="modal-overlay">
                    <div className="modal-content">
                        <h3 className="text-xl font-semibold mb-4">{employee ? 'Edit Employee' : 'Add New Employee'}</h3>
                        <form onSubmit={handleSubmit} className="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div><label className="block text-sm font-medium text-gray-700">Name</label><input type="text" name="name" value={formData.name} onChange={handleChange} className="input" required /></div>
                            <div><label className="block text-sm font-medium text-gray-700">Sex</label><select name="sex" value={formData.sex} onChange={handleChange} className="input"><option>Male</option><option>Female</option></select></div>
                            <div><label className="block text-sm font-medium text-gray-700">Date of Birth</label><input type="date" name="dob" value={formData.dob} onChange={handleChange} className="input" /></div>
                            <div><label className="block text-sm font-medium text-gray-700">National ID</label><input type="text" name="nationalId" value={formData.nationalId} onChange={handleChange} className="input" /></div>
                            <div><label className="block text-sm font-medium text-gray-700">Tel No.</label><input type="text" name="telNo" value={formData.telNo} onChange={handleChange} className="input" required /></div>
                            <div><label className="block text-sm font-medium text-gray-700">Shop</label><select name="shop" value={formData.shop} onChange={handleChange} className="input" required><option value="">Select Shop</option>{shops.map(s => <option key={s.id} value={s.id}>{s.name}</option>)}</select></div>
                            <div><label className="block text-sm font-medium text-gray-700">Position</label><select name="position" value={formData.position} onChange={handleChange} className="input" required><option value="">Select Position</option>{positions.map(p => <option key={p.id} value={p.id}>{p.name}</option>)}</select></div>
                            <div><label className="block text-sm font-medium text-gray-700">Shift</label><select name="shift" value={formData.shift} onChange={handleChange} className="input"><option>AM</option><option>PM</option><option>APM</option></select></div>
                            <div><label className="block text-sm font-medium text-gray-700">Join Date</label><input type="date" name="joinDate" value={formData.joinDate} onChange={handleChange} className="input" required /></div>
                            <div><label className="block text-sm font-medium text-gray-700">Base Salary</label><input type="number" name="baseSalary" value={formData.baseSalary} onChange={handleChange} className="input" /></div>
                            <div><label className="block text-sm font-medium text-gray-700">Supervisor</label><select name="supervisor" value={formData.supervisor} onChange={handleChange} className="input"><option value="">Select Supervisor</option>{supervisors.map(s => <option key={s.id} value={s.id}>{s.name}</option>)}</select></div>
                            <div><label className="block text-sm font-medium text-gray-700">Staff Status</label><select name="staffStatus" value={formData.staffStatus} onChange={handleChange} className="input"><option>Active</option><option>Resigned</option><option>Terminated</option></select></div>
                            
                            {(formData.staffStatus === 'Resigned' || formData.staffStatus === 'Terminated') && (
                                <div className="md:col-span-2"><label className="block text-sm font-medium text-gray-700">Reason</label><textarea name="reason" value={formData.reason} onChange={handleChange} rows="2" className="input"></textarea></div>
                            )}

                            <div className="md:col-span-2"><label className="block text-sm font-medium text-gray-700">Address</label><textarea name="address" value={formData.address} onChange={handleChange} rows="2" className="input"></textarea></div>
                            <div className="md:col-span-2"><label className="block text-sm font-medium text-gray-700">Note</label><textarea name="note" value={formData.note} onChange={handleChange} rows="2" className="input"></textarea></div>
                            
                            <div className="md:col-span-2 mt-6 flex justify-end space-x-3">
                                <button type="button" onClick={onClose} className="bg-white py-2 px-4 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 hover:bg-gray-50">Cancel</button>
                                <button type="submit" disabled={isSaving} className="bg-blue-600 py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white hover:bg-blue-700 disabled:bg-blue-300">{isSaving ? 'Saving...' : 'Save'}</button>
                            </div>
                        </form>
                    </div>
                </div>
            );
        }

        function EmployeeStatePage({ db, auth, employeeStates, employees, shops }) {
            return (
                <div>
                    <header className="mb-8">
                        <h1 className="text-3xl md:text-4xl font-bold text-gray-800">Employee State</h1>
                        <p className="text-gray-500 mt-1">Track employee deductions and engagements.</p>
                    </header>
                    <DeductionEngagementTab db={db} auth={auth} employeeStates={employeeStates} employees={employees} shops={shops} />
                </div>
            );
        }

        function DeductionEngagementTab({ db, auth, employeeStates, employees, shops }) {
            const [isModalOpen, setIsModalOpen] = useState(false);
            const [editingState, setEditingState] = useState(null);
            const [filters, setFilters] = useState({ shopId: '', employeeId: '', month: '', statusState: '' });

            const handleFilterChange = (e) => {
                const { name, value } = e.target;
                setFilters(prev => ({ ...prev, [name]: value }));
            };

            const filteredEmployeeStates = useMemo(() => {
                return employeeStates.filter(state => {
                    if (!state.date) return false;
                    const [year, month] = state.date.split('-');
                    const stateMonth = `${year}-${month}`;

                    const shopMatch = !filters.shopId || state.shopId === filters.shopId;
                    const employeeMatch = !filters.employeeId || state.employeeId === filters.employeeId;
                    const monthMatch = !filters.month || stateMonth === filters.month;
                    const statusMatch = !filters.statusState || state.statusState === filters.statusState;

                    return shopMatch && employeeMatch && monthMatch && statusMatch;
                });
            }, [employeeStates, filters]);
            
            const openModal = (state = null) => {
                setEditingState(state);
                setIsModalOpen(true);
            };

            const closeModal = () => {
                setEditingState(null);
                setIsModalOpen(false);
            };

            const handleDelete = async (stateId) => {
                const stateToDelete = employeeStates.find(s => s.id === stateId);
                if (await showConfirmation("Are you sure you want to delete this record?")) {
                    try {
                        const { doc, deleteDoc, addDoc, collection, serverTimestamp } = window.firebaseSDK;
                        await deleteDoc(doc(db, "employeeStates", stateId));
                        await addDoc(collection(db, "userLogs"), {
                            userId: auth.currentUser.uid,
                            activity: `Deleted employee state for ${getNameById(stateToDelete.employeeId, employees)}`,
                            timestamp: serverTimestamp(),
                            originalData: stateToDelete,
                            updatedData: {}
                        });
                    } catch (e) {
                        console.error("Error deleting document: ", e);
                    }
                }
            };
            
            const getNameById = (id, list) => list.find(item => item.id === id)?.name || 'N/A';

            return (
                <div className="space-y-6">
                    <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                        <h2 className="text-2xl font-semibold text-gray-700">Deduction & Engagement</h2>
                        <button onClick={() => openModal()} className="bg-blue-600 text-white px-4 py-2 rounded-lg shadow hover:bg-blue-700 transition-colors w-full sm:w-auto">
                            Add New Record
                        </button>
                    </div>

                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 p-4 bg-white rounded-lg shadow">
                        <select name="shopId" value={filters.shopId} onChange={handleFilterChange} className="input">
                            <option value="">Filter by Shop</option>
                            {shops.map(s => <option key={s.id} value={s.id}>{s.name}</option>)}
                        </select>
                        <select name="employeeId" value={filters.employeeId} onChange={handleFilterChange} className="input">
                            <option value="">Filter by Employee</option>
                            {employees
                                .filter(e => !filters.shopId || e.shop === filters.shopId)
                                .map(e => <option key={e.id} value={e.id}>{e.name}</option>)}
                        </select>
                        <input type="month" name="month" value={filters.month} onChange={handleFilterChange} className="input" />
                        <select name="statusState" value={filters.statusState} onChange={handleFilterChange} className="input">
                            <option value="">All Statuses</option>
                            <option value="Deduction">Deduction</option>
                            <option value="Engagement">Engagement</option>
                        </select>
                    </div>

                    {isModalOpen && <DeductionEngagementModal db={db} auth={auth} state={editingState} onClose={closeModal} employees={employees} shops={shops} />}

                    <div className="bg-white shadow-md rounded-lg overflow-hidden">
                        <div className="overflow-x-auto">
                            <table className="min-w-full divide-y divide-gray-200">
                                <thead className="bg-gray-50">
                                    <tr>
                                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Staff Name</th>
                                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider hidden md:table-cell">Shop</th>
                                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Amount (KHR)</th>
                                        <th className="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                    </tr>
                                </thead>
                                <tbody className="bg-white divide-y divide-gray-200">
                                    {filteredEmployeeStates.map(state => (
                                        <tr key={state.id}>
                                            <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{formatDate(state.date)}</td>
                                            <td className="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">{getNameById(state.employeeId, employees)}</td>
                                            <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500 hidden md:table-cell">{getNameById(state.shopId, shops)}</td>
                                            <td className={`px-6 py-4 whitespace-nowrap text-sm font-semibold ${state.statusState === 'Deduction' ? 'text-red-600' : 'text-blue-600'}`}>{state.statusState}</td>
                                            <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{formatCurrency(state.amount)}</td>
                                            <td className="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                                                <button onClick={() => openModal(state)} className="text-indigo-600 hover:text-indigo-900 mr-4">Edit</button>
                                                <button onClick={() => handleDelete(state.id)} className="text-red-600 hover:text-red-900">Delete</button>
                                            </td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            )
        }
        
        function DeductionEngagementModal({ db, auth, state, onClose, employees, shops }) {
            const initialFormState = {
                date: new Date().toISOString().slice(0, 10),
                shopId: '', employeeId: '', statusState: 'Deduction', amount: '', note: ''
            };
            const [formData, setFormData] = useState(state || initialFormState);
            const [filteredEmployees, setFilteredEmployees] = useState([]);
            const [isSaving, setIsSaving] = useState(false);

            useEffect(() => {
                if(formData.shopId) {
                    setFilteredEmployees(employees.filter(emp => emp.shop === formData.shopId && emp.staffStatus === 'Active'));
                } else {
                    setFilteredEmployees([]);
                }
            }, [formData.shopId, employees]);

            const handleShopChange = (e) => {
                const shopId = e.target.value;
                setFormData(prev => ({ ...prev, shopId, employeeId: '' }));
            };

            const handleChange = (e) => {
                const { name, value } = e.target;
                setFormData(prev => ({ ...prev, [name]: value }));
            };

            const handleSubmit = async (e) => {
                e.preventDefault();
                if (!formData.employeeId || !formData.shopId) {
                    alert("Please select a shop and employee.");
                    return;
                }
                setIsSaving(true);
                try {
                    const { doc, updateDoc, addDoc, collection, serverTimestamp } = window.firebaseSDK;
                    const employeeName = employees.find(emp => emp.id === formData.employeeId)?.name || 'N/A';
                    if (state) {
                        const { id, ...dataToUpdate } = formData;
                        await updateDoc(doc(db, "employeeStates", id), dataToUpdate);
                        await addDoc(collection(db, "userLogs"), {
                            userId: auth.currentUser.uid,
                            activity: `Updated employee state for ${employeeName}`,
                            timestamp: serverTimestamp(),
                            originalData: state,
                            updatedData: formData
                        });
                    } else {
                        const newDocRef = await addDoc(collection(db, "employeeStates"), formData);
                         await addDoc(collection(db, "userLogs"), {
                            userId: auth.currentUser.uid,
                            activity: `Added employee state for ${employeeName}`,
                            timestamp: serverTimestamp(),
                            originalData: {},
                            updatedData: {id: newDocRef.id, ...formData}
                        });
                    }
                    onClose();
                } catch (error) {
                    console.error("Error saving employee state: ", error);
                } finally {
                    setIsSaving(false);
                }
            };

            return (
                <div className="modal-overlay">
                    <div className="modal-content">
                        <h3 className="text-xl font-semibold mb-4">{state ? 'Edit Record' : 'Add New Record'}</h3>
                        <form onSubmit={handleSubmit} className="space-y-4">
                            <div><label className="block text-sm font-medium text-gray-700">Date</label><input type="date" name="date" value={formData.date} onChange={handleChange} className="input" required /></div>
                            <div>
                                <label className="block text-sm font-medium text-gray-700">Shop</label>
                                <select name="shopId" value={formData.shopId} onChange={handleShopChange} className="input" required>
                                    <option value="">Select Shop</option>
                                    {shops.map(shop => <option key={shop.id} value={shop.id}>{shop.name}</option>)}
                                </select>
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-gray-700">Staff Name</label>
                                <select name="employeeId" value={formData.employeeId} onChange={handleChange} className="input" required disabled={!formData.shopId}>
                                    <option value="">Select Staff</option>
                                    {filteredEmployees.map(emp => <option key={emp.id} value={emp.id}>{emp.name}</option>)}
                                </select>
                            </div>
                            <div><label className="block text-sm font-medium text-gray-700">Status State</label><select name="statusState" value={formData.statusState} onChange={handleChange} className="input"><option>Deduction</option><option>Engagement</option></select></div>
                            <div><label className="block text-sm font-medium text-gray-700">Amount (KHR)</label><input type="number" name="amount" value={formData.amount} onChange={handleChange} className="input" required /></div>
                            <div><label className="block text-sm font-medium text-gray-700">Note</label><textarea name="note" value={formData.note} onChange={handleChange} rows="3" className="input"></textarea></div>
                            <div className="flex justify-end space-x-3 pt-4">
                                <button type="button" onClick={onClose} className="bg-white py-2 px-4 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 hover:bg-gray-50">Cancel</button>
                                <button type="submit" disabled={isSaving} className="bg-blue-600 text-white px-4 py-2 rounded-lg shadow hover:bg-blue-700">{isSaving ? 'Saving...' : 'Save'}</button>
                            </div>
                        </form>
                    </div>
                </div>
            );
        }
        
        function LoanPaymentModal({ db, auth, loan, onClose, employees }) {
            const [paymentAmount, setPaymentAmount] = useState('');
            const [paymentDate, setPaymentDate] = useState(new Date().toISOString().slice(0, 10));
            const [note, setNote] = useState('');
            const [isSaving, setIsSaving] = useState(false);

            const handleSubmit = async (e) => {
                e.preventDefault();
                const amount = parseFloat(paymentAmount);
                if (isNaN(amount) || amount <= 0) {
                    alert("Please enter a valid payment amount.");
                    return;
                }
                
                setIsSaving(true);
                try {
                    const { runTransaction, doc, collection, serverTimestamp, addDoc } = window.firebaseSDK;
                    await runTransaction(db, async (transaction) => {
                        const loanRef = doc(db, "staffLoans", loan.id);
                        const loanDoc = await transaction.get(loanRef);

                        if (!loanDoc.exists()) {
                            throw "Loan document does not exist!";
                        }

                        const currentTotalPaid = loanDoc.data().totalPaid || 0;
                        const newTotalPaid = currentTotalPaid + amount;
                        const newStatus = newTotalPaid >= loanDoc.data().loanAmount ? "Paid Off" : "Active";
                        
                        transaction.update(loanRef, { 
                            totalPaid: newTotalPaid,
                            status: newStatus
                        });

                        const paymentRef = doc(collection(db, "loanPayments"));
                        transaction.set(paymentRef, {
                            loanId: loan.id,
                            employeeId: loan.employeeId,
                            paymentAmount: amount,
                            paymentDate,
                            note
                        });
                    });

                    const employeeName = employees.find(emp => emp.id === loan.employeeId)?.name || 'N/A';
                    await addDoc(collection(db, "userLogs"), {
                        userId: auth.currentUser.uid,
                        activity: `Added loan payment for ${employeeName}`,
                        timestamp: serverTimestamp(),
                        originalData: {},
                        updatedData: { loanId: loan.id, paymentAmount: amount, paymentDate, note }
                    });

                    onClose();
                } catch (error) {
                    console.error("Transaction failed: ", error);
                    alert("Failed to save payment. Please try again.");
                } finally {
                    setIsSaving(false);
                }
            };

            return (
                <div className="modal-overlay">
                    <div className="modal-content">
                        <h3 className="text-xl font-semibold mb-4">Make a Payment</h3>
                        <form onSubmit={handleSubmit}>
                            <div className="mb-4">
                                <label className="block text-sm font-medium text-gray-700">Payment Date</label>
                                <input type="date" value={paymentDate} onChange={e => setPaymentDate(e.target.value)} className="input" required />
                            </div>
                             <div className="mb-4">
                                <label className="block text-sm font-medium text-gray-700">Payment Amount (KHR)</label>
                                <input type="number" value={paymentAmount} onChange={e => setPaymentAmount(e.target.value)} className="input" placeholder="0.00" required />
                            </div>
                             <div className="mb-4">
                                <label className="block text-sm font-medium text-gray-700">Note</label>
                                <textarea value={note} onChange={e => setNote(e.target.value)} rows="3" className="input"></textarea>
                            </div>
                            <div className="mt-6 flex justify-end space-x-3">
                                <button type="button" onClick={onClose} className="bg-white py-2 px-4 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 hover:bg-gray-50">Cancel</button>
                                <button type="submit" disabled={isSaving} className="bg-blue-600 py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white hover:bg-blue-700 disabled:bg-blue-300">{isSaving ? 'Saving...' : 'Save Payment'}</button>
                            </div>
                        </form>
                    </div>
                </div>
            );
        }

        function ActiveLoansTab({ db, auth, staffLoans, employees, shops }) {
            const [isAddLoanModalOpen, setAddLoanModalOpen] = useState(false);
            const [isPaymentModalOpen, setPaymentModalOpen] = useState(false);
            const [isEditLoanModalOpen, setEditLoanModalOpen] = useState(false);
            const [selectedLoan, setSelectedLoan] = useState(null);
            const [filteredEmployees, setFilteredEmployees] = useState([]);
            const initialFormState = { shopId: '', employeeId: '', loanAmount: '', agreedMonthlyDeduction: '', loanDate: new Date().toISOString().slice(0, 10), reason: '' };
            const [formData, setFormData] = useState(initialFormState);

            const getNameById = (id, list) => list.find(item => item.id === id)?.name || 'N/A';

            const handleShopChange = (e) => {
                const shopId = e.target.value;
                setFormData({ ...formData, shopId, employeeId: '' });
                setFilteredEmployees(employees.filter(emp => emp.shop === shopId && emp.staffStatus === 'Active'));
            };

            const handleChange = (e) => {
                const { name, value } = e.target;
                setFormData({ ...formData, [name]: value });
            };

            const handleAddLoan = async (e) => {
                e.preventDefault();
                
                const { collection, addDoc, serverTimestamp } = window.firebaseSDK;
                const loansRef = collection(db, "staffLoans");
                
                const dataToSave = {
                    ...formData,
                    loanAmount: parseFloat(formData.loanAmount),
                    agreedMonthlyDeduction: parseFloat(formData.agreedMonthlyDeduction) || 0,
                    totalPaid: 0,
                    status: 'Active'
                };
                const newDocRef = await addDoc(loansRef, dataToSave);
                
                await addDoc(collection(db, "userLogs"), {
                    userId: auth.currentUser.uid,
                    activity: `Added new loan for ${getNameById(formData.employeeId, employees)}`,
                    timestamp: serverTimestamp(),
                    originalData: {},
                    updatedData: {id: newDocRef.id, ...dataToSave}
                });

                setFormData(initialFormState);
                setFilteredEmployees([]);
                setAddLoanModalOpen(false);
            };

            const handleEditLoan = (loan) => {
                setSelectedLoan(loan);
                setEditLoanModalOpen(true);
            };
            
            const handleUpdateLoan = async (e) => {
                e.preventDefault();
                const { id, ...dataToUpdate } = selectedLoan;
                dataToUpdate.agreedMonthlyDeduction = parseFloat(dataToUpdate.agreedMonthlyDeduction) || 0;
                const { doc, updateDoc, addDoc, collection, serverTimestamp } = window.firebaseSDK;
                const originalLoan = staffLoans.find(l => l.id === id);

                await updateDoc(doc(db, "staffLoans", id), dataToUpdate);
                
                await addDoc(collection(db, "userLogs"), {
                    userId: auth.currentUser.uid,
                    activity: `Updated loan for ${getNameById(dataToUpdate.employeeId, employees)}`,
                    timestamp: serverTimestamp(),
                    originalData: originalLoan,
                    updatedData: dataToUpdate
                });

                setEditLoanModalOpen(false);
                setSelectedLoan(null);
            };

            const handleDeleteLoan = async (loanId) => {
                 if (await showConfirmation("Are you sure you want to delete this loan? This will also delete all associated payment history.")) {
                    try {
                        const { collection, query, where, getDocs, writeBatch, doc, addDoc, serverTimestamp } = window.firebaseSDK;
                        const loanToDelete = staffLoans.find(l => l.id === loanId);
                        const paymentsRef = collection(db, "loanPayments");
                        const q = query(paymentsRef, where("loanId", "==", loanId));
                        const querySnapshot = await getDocs(q);
                        
                        const batch = writeBatch(db);
                        querySnapshot.forEach(docSnapshot => {
                            batch.delete(docSnapshot.ref);
                        });
                        
                        const loanRef = doc(db, "staffLoans", loanId);
                        batch.delete(loanRef);

                        await batch.commit();

                        await addDoc(collection(db, "userLogs"), {
                            userId: auth.currentUser.uid,
                            activity: `Deleted loan for ${getNameById(loanToDelete.employeeId, employees)}`,
                            timestamp: serverTimestamp(),
                            originalData: loanToDelete,
                            updatedData: {}
                        });

                    } catch (e) {
                        console.error("Error deleting loan and payments:", e);
                    }
                }
            };
            
            const openPaymentModal = (loan) => {
                setSelectedLoan(loan);
                setPaymentModalOpen(true);
            };

            const activeLoans = useMemo(() => staffLoans.filter(loan => loan.status === 'Active'), [staffLoans]);

            return (
                <div>
                    <div className="flex justify-end mb-4">
                        <button onClick={() => setAddLoanModalOpen(true)} className="bg-blue-600 text-white px-4 py-2 rounded-lg shadow hover:bg-blue-700">Add New Loan</button>
                    </div>

                    {isAddLoanModalOpen && (
                        <div className="modal-overlay">
                            <div className="modal-content">
                                <h3 className="text-xl font-semibold mb-4">Add New Loan</h3>
                                <form onSubmit={handleAddLoan} className="space-y-4">
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700">Shop</label>
                                        <select name="shopId" value={formData.shopId} onChange={handleShopChange} className="input" required>
                                            <option value="">Select Shop</option>
                                            {shops.map(shop => <option key={shop.id} value={shop.id}>{shop.name}</option>)}
                                        </select>
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700">Employee</label>
                                        <select name="employeeId" value={formData.employeeId} onChange={handleChange} className="input" required disabled={!formData.shopId}>
                                            <option value="">Select Employee</option>
                                            {filteredEmployees.map(emp => <option key={emp.id} value={emp.id}>{emp.name}</option>)}
                                        </select>
                                    </div>
                                    <div><label className="block text-sm font-medium text-gray-700">Loan Date</label><input type="date" name="loanDate" value={formData.loanDate} onChange={handleChange} className="input" required /></div>
                                    <div><label className="block text-sm font-medium text-gray-700">Loan Amount (KHR)</label><input type="number" name="loanAmount" value={formData.loanAmount} onChange={handleChange} className="input" required /></div>
                                    <div><label className="block text-sm font-medium text-gray-700">Agreed Monthly Deduction (KHR)</label><input type="number" name="agreedMonthlyDeduction" value={formData.agreedMonthlyDeduction} onChange={handleChange} className="input" /></div>
                                    <div><label className="block text-sm font-medium text-gray-700">Reason</label><textarea name="reason" value={formData.reason} onChange={handleChange} rows="3" className="input"></textarea></div>
                                    <div className="flex justify-end space-x-3 pt-4">
                                        <button type="button" onClick={() => setAddLoanModalOpen(false)} className="bg-white py-2 px-4 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 hover:bg-gray-50">Cancel</button>
                                        <button type="submit" className="bg-blue-600 text-white px-4 py-2 rounded-lg shadow hover:bg-blue-700">Save Loan</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    )}

                    {isEditLoanModalOpen && selectedLoan && (
                        <div className="modal-overlay">
                            <div className="modal-content">
                                <h3 className="text-xl font-semibold mb-4">Edit Loan</h3>
                                <form onSubmit={handleUpdateLoan} className="space-y-4">
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700">Employee</label>
                                        <input type="text" value={getNameById(selectedLoan.employeeId, employees)} className="input bg-gray-100" readOnly />
                                    </div>
                                    <div><label className="block text-sm font-medium text-gray-700">Loan Date</label><input type="date" value={selectedLoan.loanDate} onChange={(e) => setSelectedLoan({...selectedLoan, loanDate: e.target.value})} className="input" required /></div>
                                    <div><label className="block text-sm font-medium text-gray-700">Loan Amount (KHR)</label><input type="number" value={selectedLoan.loanAmount} onChange={(e) => setSelectedLoan({...selectedLoan, loanAmount: parseFloat(e.target.value)})} className="input" required /></div>
                                    <div><label className="block text-sm font-medium text-gray-700">Agreed Monthly Deduction (KHR)</label><input type="number" value={selectedLoan.agreedMonthlyDeduction || ''} onChange={(e) => setSelectedLoan({...selectedLoan, agreedMonthlyDeduction: e.target.value})} className="input" /></div>
                                    <div><label className="block text-sm font-medium text-gray-700">Reason</label><textarea value={selectedLoan.reason} onChange={(e) => setSelectedLoan({...selectedLoan, reason: e.target.value})} rows="3" className="input"></textarea></div>
                                    <div className="flex justify-end space-x-3 pt-4">
                                        <button type="button" onClick={() => setEditLoanModalOpen(false)} className="bg-white py-2 px-4 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 hover:bg-gray-50">Cancel</button>
                                        <button type="submit" className="bg-blue-600 text-white px-4 py-2 rounded-lg shadow hover:bg-blue-700">Update Loan</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    )}
                    
                    {isPaymentModalOpen && <LoanPaymentModal db={db} auth={auth} loan={selectedLoan} onClose={() => setPaymentModalOpen(false)} employees={employees} />}

                    <div className="bg-white shadow-md rounded-lg overflow-hidden">
                        <div className="overflow-x-auto">
                            <table className="min-w-full divide-y divide-gray-200">
                                <thead className="bg-gray-50">
                                    <tr>
                                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Employee</th>
                                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase hidden sm:table-cell">Shop</th>
                                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Loan Amount</th>
                                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase hidden md:table-cell">Paid</th>
                                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Balance</th>
                                        <th className="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">Action</th>
                                    </tr>
                                </thead>
                                <tbody className="bg-white divide-y divide-gray-200">
                                    {activeLoans.map(loan => {
                                        const balance = loan.loanAmount - (loan.totalPaid || 0);
                                        return (
                                        <tr key={loan.id}>
                                            <td className="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">{getNameById(loan.employeeId, employees)}</td>
                                            <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500 hidden sm:table-cell">{getNameById(employees.find(e => e.id === loan.employeeId)?.shop, shops)}</td>
                                            <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{formatCurrency(loan.loanAmount)}</td>
                                            <td className="px-6 py-4 whitespace-nowrap text-sm text-green-600 hidden md:table-cell">{formatCurrency(loan.totalPaid)}</td>
                                            <td className="px-6 py-4 whitespace-nowrap text-sm text-red-600">{formatCurrency(balance)}</td>
                                            <td className="px-6 py-4 whitespace-nowrap text-right text-sm font-medium space-x-2 sm:space-x-4">
                                                <button onClick={() => openPaymentModal(loan)} className="text-green-600 hover:text-green-900">Payment</button>
                                                <button onClick={() => handleEditLoan(loan)} className="text-indigo-600 hover:text-indigo-900">Edit</button>
                                                <button onClick={() => handleDeleteLoan(loan.id)} className="text-red-600 hover:text-red-900">Delete</button>
                                            </td>
                                        </tr>
                                    )})}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            )
        }
        
        function HistoryReportTab({ allPayments, employees, shops, staffLoans }) {
            const [filters, setFilters] = useState({ employeeId: '', shopId: '' });

            const handleFilterChange = (e) => {
                const { name, value } = e.target;
                setFilters(prev => ({ ...prev, [name]: value }));
            };

            const getNameById = (id, list) => list.find(item => item.id === id)?.name || 'N/A';
            
            const paymentsWithBalance = useMemo(() => {
                if (!allPayments || !staffLoans) return [];

                const loanMap = new Map(staffLoans.map(loan => [loan.id, loan]));
                
                const paymentsByLoan = allPayments.reduce((acc, p) => {
                    if (!acc[p.loanId]) acc[p.loanId] = [];
                    acc[p.loanId].push(p);
                    return acc;
                }, {});

                const finalPayments = [];
                for (const loanId in paymentsByLoan) {
                    const loan = loanMap.get(loanId);
                    if (!loan) continue;

                    const loanPayments = paymentsByLoan[loanId];
                    loanPayments.sort((a, b) => new Date(a.paymentDate) - new Date(b.paymentDate));
                    
                    let totalPaidSoFar = 0;
                    for (const payment of loanPayments) {
                        totalPaidSoFar += payment.paymentAmount;
                        finalPayments.push({
                            ...payment,
                            remainingBalance: loan.loanAmount - totalPaidSoFar,
                        });
                    }
                }
                
                return finalPayments.sort((a, b) => new Date(b.paymentDate) - new Date(a.paymentDate));

            }, [allPayments, staffLoans]);

            const filteredPayments = useMemo(() => {
                return paymentsWithBalance.filter(payment => {
                    const employee = employees.find(e => e.id === payment.employeeId);
                    const employeeMatch = !filters.employeeId || payment.employeeId === filters.employeeId;
                    const shopMatch = !filters.shopId || (employee && employee.shop === filters.shopId);
                    return employeeMatch && shopMatch;
                });
            }, [paymentsWithBalance, employees, filters]);

            return (
                <div>
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6 p-4 bg-white rounded-lg shadow">
                         <select name="shopId" value={filters.shopId} onChange={handleFilterChange} className="input">
                            <option value="">Filter by Shop</option>
                            {shops.map(s => <option key={s.id} value={s.id}>{s.name}</option>)}
                        </select>
                        <select name="employeeId" value={filters.employeeId} onChange={handleFilterChange} className="input">
                            <option value="">Filter by Employee</option>
                            {employees.map(e => <option key={e.id} value={e.id}>{e.name}</option>)}
                        </select>
                    </div>
                    <div className="bg-white shadow-md rounded-lg overflow-hidden">
                        <div className="overflow-x-auto">
                            <table className="min-w-full divide-y divide-gray-200">
                                <thead className="bg-gray-50">
                                    <tr>
                                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Payment Date</th>
                                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Employee</th>
                                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Amount Paid</th>
                                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Remain Balance</th>
                                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase hidden md:table-cell">Note</th>
                                    </tr>
                                </thead>
                                <tbody className="bg-white divide-y divide-gray-200">
                                    {filteredPayments.map(payment => (
                                        <tr key={payment.id}>
                                            <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{formatDate(payment.paymentDate)}</td>
                                            <td className="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">{getNameById(payment.employeeId, employees)}</td>
                                            <td className="px-6 py-4 whitespace-nowrap text-sm text-green-600">{formatCurrency(payment.paymentAmount)}</td>
                                            <td className="px-6 py-4 whitespace-nowrap text-sm text-red-600">{formatCurrency(payment.remainingBalance)}</td>
                                            <td className="px-6 py-4 text-sm text-gray-500 hidden md:table-cell">{payment.note}</td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            );
        }

        function LoanManagerPage({ db, auth, staffLoans, allPayments, employees, shops }) {
            const [activeTab, setActiveTab] = useState('activeLoans');

            const TabButton = ({ tabName, title }) => (
                <button
                    onClick={() => setActiveTab(tabName)}
                    className={`px-3 py-2 text-sm font-medium rounded-md transition-colors duration-200 flex-grow text-center sm:flex-grow-0 ${
                        activeTab === tabName ? 'bg-blue-600 text-white shadow-md' : 'bg-white text-gray-700 hover:bg-gray-200'
                    }`}
                >
                    {title}
                </button>
            );

            return (
                 <div className="space-y-6">
                    <header>
                        <h1 className="text-3xl md:text-4xl font-bold text-gray-800">Loan Manager</h1>
                        <p className="text-gray-500 mt-1">Manage and track employee loans.</p>
                    </header>
                    <div className="flex flex-wrap gap-2 bg-gray-200 p-1 rounded-lg">
                        <TabButton tabName="activeLoans" title="Active Loans" />
                        <TabButton tabName="historyReport" title="History Report" />
                    </div>
                    {activeTab === 'activeLoans' && <ActiveLoansTab db={db} auth={auth} staffLoans={staffLoans} employees={employees} shops={shops} />}
                    {activeTab === 'historyReport' && <HistoryReportTab allPayments={allPayments} employees={employees} shops={shops} staffLoans={staffLoans} />}
                </div>
            );
        }

        function PayrollPage({ db, auth, employees, shops, staffLoans, employeeStates, payrolls, otReports, leaveRequests, supervisors, userPermissions }) {
            const [activeTab, setActiveTab] = useState('calculator');
            const [payrollToEdit, setPayrollToEdit] = useState(null);

            const handleEdit = (payrollRecord) => {
                setPayrollToEdit(payrollRecord);
                setActiveTab('calculator');
            };

            const TabButton = ({ tabName, title }) => (
                 <button
                    onClick={() => setActiveTab(tabName)}
                    className={`px-3 py-2 text-sm font-medium rounded-md transition-colors duration-200 flex-grow text-center sm:flex-grow-0 ${
                        activeTab === tabName ? 'bg-blue-600 text-white shadow-md' : 'bg-white text-gray-700 hover:bg-gray-200'
                    }`}
                >
                    {title}
                </button>
            );

            return (
                <div className="space-y-6">
                     <header>
                        <h1 className="text-3xl md:text-4xl font-bold text-gray-800">Payroll</h1>
                        <p className="text-gray-500 mt-1">Calculate and manage employee payroll.</p>
                    </header>
                    <div className="flex flex-wrap gap-2 bg-gray-200 p-1 rounded-lg">
                        <TabButton tabName="calculator" title="Payroll Calculator" />
                        <TabButton tabName="history" title="Payroll History" />
                        <TabButton tabName="leaveReport" title="Leave Report" />
                        <TabButton tabName="otReport" title="OT Report" />
                    </div>
                    {activeTab === 'calculator' && <PayrollCalculator db={db} auth={auth} employees={employees} shops={shops} staffLoans={staffLoans} employeeStates={employeeStates} payrollToEdit={payrollToEdit} setPayrollToEdit={setPayrollToEdit} otReports={otReports} leaveRequests={leaveRequests} />}
                    {activeTab === 'history' && <PayrollHistory db={db} auth={auth} payrolls={payrolls} employees={employees} shops={shops} onEdit={handleEdit} />}
                    {activeTab === 'leaveReport' && <LeaveReportTab db={db} leaveRequests={leaveRequests} employees={employees} shops={shops} supervisors={supervisors} userPermissions={userPermissions} />}
                    {activeTab === 'otReport' && <OTReportTab db={db} auth={auth} otReports={otReports} employees={employees} shops={shops} />}
                </div>
            );
        }

        function LeaveReportTab({ db, leaveRequests, employees, shops, supervisors, userPermissions }) {
            const [filters, setFilters] = useState({ shopId: '', employeeId: '', date: '' });

            const handleFilterChange = (e) => {
                const { name, value } = e.target;
                setFilters(prev => ({ ...prev, [name]: value }));
            };

            const getNameById = (id, list) => list.find(item => item.id === id)?.name || 'N/A';

            const filteredLeaveRequests = useMemo(() => {
                return leaveRequests.filter(req => {
                    const shopMatch = !filters.shopId || req.shopId === filters.shopId;
                    const employeeMatch = !filters.employeeId || req.employeeId === filters.employeeId;
                    const dateMatch = !filters.date || req.date === filters.date;
                    return shopMatch && employeeMatch && dateMatch;
                });
            }, [leaveRequests, filters]);

            return (
                <div className="bg-white p-4 sm:p-6 rounded-lg shadow-md space-y-4">
                    <h2 className="text-2xl font-semibold">Leave Report</h2>
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-4 p-4 bg-gray-50 rounded-lg border">
                        <select name="shopId" value={filters.shopId} onChange={handleFilterChange} className="input">
                            <option value="">All Shops</option>
                            {shops.map(s => <option key={s.id} value={s.id}>{s.name}</option>)}
                        </select>
                        <select name="employeeId" value={filters.employeeId} onChange={handleFilterChange} className="input">
                            <option value="">All Employees</option>
                            {employees.map(e => <option key={e.id} value={e.id}>{e.name}</option>)}
                        </select>
                        <input type="date" name="date" value={filters.date} onChange={handleFilterChange} className="input" />
                    </div>
                    <div className="overflow-x-auto">
                        <table className="min-w-full divide-y divide-gray-200">
                            <thead className="bg-gray-50">
                                <tr>
                                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Date</th>
                                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Staff Name</th>
                                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Leave No.</th>
                                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase hidden md:table-cell">Approved By</th>
                                </tr>
                            </thead>
                            <tbody className="bg-white divide-y divide-gray-200">
                                {filteredLeaveRequests.map(req => (
                                    <tr key={req.id}>
                                        <td className="px-6 py-4 whitespace-nowrap">{formatDate(req.date)}</td>
                                        <td className="px-6 py-4 whitespace-nowrap">{getNameById(req.employeeId, employees)}</td>
                                        <td className="px-6 py-4 whitespace-nowrap">{req.leaveNo}</td>
                                        <td className="px-6 py-4 whitespace-nowrap">
                                             <span className={`px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${
                                                 req.status === 'Approved' ? 'bg-green-100 text-green-800' : 
                                                 req.status === 'Rejected' ? 'bg-red-100 text-red-800' : 'bg-yellow-100 text-yellow-800'
                                             }`}>
                                                {req.status}
                                            </span>
                                        </td>
                                        <td className="px-6 py-4 whitespace-nowrap hidden md:table-cell">{req.approvedBy || 'N/A'}</td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                </div>
            );
        }


        function PayrollCalculator({ db, auth, employees, shops, staffLoans, employeeStates, payrollToEdit, setPayrollToEdit, otReports, leaveRequests }) {
            const [currentDate, setCurrentDate] = useState('');
            const [selectedShop, setSelectedShop] = useState('');
            const [selectedEmployeeId, setSelectedEmployeeId] = useState('');
            const [payrollInput, setPayrollInput] = useState({ workDay: '', givenOff: '', leaveNo: '', loanDed: '', note: '' });
            const [isSaving, setIsSaving] = useState(false);
            const [editingPayrollId, setEditingPayrollId] = useState(null);
            const payrollRef = useRef(null);
            
            useEffect(() => {
                const today = new Date();
                const year = today.getFullYear();
                const month = String(today.getMonth() + 1).padStart(2, '0');
                setCurrentDate(`${year}-${month}`);
            }, []);
            
            useEffect(() => {
                if (payrollToEdit) {
                    setCurrentDate(payrollToEdit.payrollMonth);
                    setSelectedShop(payrollToEdit.shopId);
                    setEditingPayrollId(payrollToEdit.id);
                    setTimeout(() => {
                        setSelectedEmployeeId(payrollToEdit.employeeId);
                        setPayrollInput({
                            workDay: payrollToEdit.workDay || '',
                            givenOff: payrollToEdit.givenOff || '',
                            leaveNo: payrollToEdit.leaveNo || '',
                            loanDed: payrollToEdit.loanDed || '',
                            note: payrollToEdit.note || '',
                        });
                    }, 0);
                    
                    setPayrollToEdit(null);
                }
            }, [payrollToEdit, setPayrollToEdit]);


            const selectedEmployee = useMemo(() => {
                return employees.find(emp => emp.id === selectedEmployeeId) || null;
            }, [selectedEmployeeId, employees]);
            
            useEffect(() => {
                if (selectedEmployee && currentDate) {
                    const [year, month] = currentDate.split('-');
                    const approvedLeaveDays = leaveRequests
                        .filter(req => 
                            req.employeeId === selectedEmployee.id && 
                            req.status === 'Approved' &&
                            req.date.startsWith(currentDate)
                        )
                        .reduce((total, req) => total + parseFloat(req.leaveNo || 0), 0);

                    const activeLoan = staffLoans.find(loan => loan.employeeId === selectedEmployee.id && loan.status === 'Active');
                    
                    setPayrollInput(prev => ({ 
                        ...prev, 
                        leaveNo: approvedLeaveDays,
                        loanDed: activeLoan?.agreedMonthlyDeduction || ''
                    }));
                } else {
                    setPayrollInput(prev => ({ ...prev, leaveNo: '', loanDed: '' }));
                }
            }, [selectedEmployee, currentDate, leaveRequests, staffLoans]);


            const calculatedData = useMemo(() => {
                if (selectedEmployee && currentDate) {
                    const { baseSalary } = selectedEmployee;
                    const { workDay, givenOff, leaveNo, loanDed } = payrollInput;
                    
                    const [year, month] = currentDate.split('-').map(Number);
                    const daysInMonth = new Date(year, month, 0).getDate();
                    const startOfMonth = `${year}-${String(month).padStart(2, '0')}-01`;
                    const endOfMonth = `${year}-${String(month).padStart(2, '0')}-${String(daysInMonth).padStart(2, '0')}`;

                    const monthlyStates = employeeStates.filter(state => 
                        state.employeeId === selectedEmployee.id &&
                        state.date >= startOfMonth &&
                        state.date <= endOfMonth
                    );
                    const monthlyOT = otReports.filter(ot => 
                        ot.employeeId === selectedEmployee.id &&
                        ot.date >= startOfMonth &&
                        ot.date <= endOfMonth
                    );
                    
                    const engage = monthlyStates.filter(s => s.statusState === 'Engagement').reduce((sum, s) => sum + parseFloat(s.amount || 0), 0);
                    const otherDed = monthlyStates.filter(s => s.statusState === 'Deduction').reduce((sum, s) => sum + parseFloat(s.amount || 0), 0);
                    const otDays = monthlyOT.reduce((sum, ot) => sum + parseFloat(ot.otDays || 0), 0);

                    const salaryPerDay = (parseFloat(baseSalary) || 0) / daysInMonth;
                    
                    const numWorkDay = parseFloat(workDay) || 0;
                    const numGivenOff = parseFloat(givenOff) || 0;
                    const numLeaveNo = parseFloat(leaveNo) || 0;
                    const numLoanDed = parseFloat(loanDed) || 0;

                    const earnedSalaryFromDays = salaryPerDay * (numWorkDay + numGivenOff - numLeaveNo + otDays);
                    const leaveDeduction = salaryPerDay * numLeaveNo;
                    
                    const grossSalary = (salaryPerDay * (numWorkDay + numGivenOff + otDays)) + engage;
                    const totalDeductions = numLoanDed + otherDed + leaveDeduction;
                    const finalSalary = grossSalary - totalDeductions;
                    
                    const activeLoan = staffLoans.find(loan => loan.employeeId === selectedEmployee.id && loan.status === 'Active');
                    const loanRemains = activeLoan ? activeLoan.loanAmount - (activeLoan.totalPaid || 0) - numLoanDed : 0;

                    return { 
                        loanRemains, 
                        engage, 
                        otherDed, 
                        finalSalary: isNaN(finalSalary) ? 0 : finalSalary, 
                        otDays, 
                        baseSalaryEarned: salaryPerDay * (numWorkDay + numGivenOff), 
                        otSalary: salaryPerDay * otDays, 
                        grossSalary, 
                        totalDeductions,
                        leaveDeduction
                    };
                }
                return { loanRemains: 0, engage: 0, otherDed: 0, finalSalary: 0, otDays: 0, baseSalaryEarned: 0, otSalary: 0, grossSalary: 0, totalDeductions: 0, leaveDeduction: 0 };
            }, [selectedEmployee, staffLoans, employeeStates, payrollInput, currentDate, otReports]);

            const handleShopChange = (e) => {
                setSelectedShop(e.target.value);
                setSelectedEmployeeId('');
                setPayrollInput({ workDay: '', givenOff: '', leaveNo: '', loanDed: '', note: '' });
            };
            
            const handleEmployeeChange = (e) => {
                setSelectedEmployeeId(e.target.value);
            };

            const handlePayrollInputChange = (e) => {
                const { name, value } = e.target;
                setPayrollInput(prev => ({...prev, [name]: value}));
            };

            const employeesInShop = useMemo(() => {
                if (!selectedShop) return [];
                return employees.filter(emp => emp.shop === selectedShop && emp.staffStatus === 'Active');
            }, [employees, selectedShop]);
            
            const resetForm = () => {
                setSelectedShop('');
                setSelectedEmployeeId('');
                setPayrollInput({ workDay: '', givenOff: '', leaveNo: '', loanDed: '', note: '' });
                setEditingPayrollId(null);
            };

            const handleSavePayroll = async () => {
                if (!selectedEmployee) {
                    alert("Please select an employee first.");
                    return;
                }
                setIsSaving(true);

                const { runTransaction, doc, collection, query, where, getDocs, addDoc, serverTimestamp, getDoc } = window.firebaseSDK;

                let activeLoanRef = null;
                let activeLoanId = null;
                const loansRef = collection(db, "staffLoans");
                const loanQuery = query(loansRef, where("employeeId", "==", selectedEmployee.id), where("status", "==", "Active"));
                const loanQuerySnapshot = await getDocs(loanQuery);
                if (!loanQuerySnapshot.empty) {
                    activeLoanRef = loanQuerySnapshot.docs[0].ref;
                    activeLoanId = loanQuerySnapshot.docs[0].id;
                }

                const payrollData = {
                    employeeId: selectedEmployee.id,
                    shopId: selectedEmployee.shop,
                    payrollMonth: currentDate,
                    baseSalary: selectedEmployee.baseSalary,
                    workDay: parseFloat(payrollInput.workDay) || 0,
                    givenOff: parseFloat(payrollInput.givenOff) || 0,
                    leaveNo: parseFloat(payrollInput.leaveNo) || 0,
                    otDays: calculatedData.otDays,
                    engage: calculatedData.engage,
                    otherDed: calculatedData.otherDed,
                    loanDed: parseFloat(payrollInput.loanDed) || 0,
                    finalSalary: calculatedData.finalSalary,
                    loanRemains: calculatedData.loanRemains,
                    note: payrollInput.note,
                    createdAt: new Date().toISOString(),
                    loanId: activeLoanId
                };

                try {
                    if (editingPayrollId) {
                        const payrollRef = doc(db, "payrolls", editingPayrollId);
                        const originalPayrollDoc = await getDoc(payrollRef);

                        const paymentsRef = collection(db, "loanPayments");
                        const paymentQuery = query(paymentsRef, where("payrollId", "==", editingPayrollId));
                        const paymentQuerySnapshot = await getDocs(paymentQuery);
                        let existingPaymentRef = null;
                        if (!paymentQuerySnapshot.empty) {
                            existingPaymentRef = paymentQuerySnapshot.docs[0].ref;
                        }

                        await runTransaction(db, async (transaction) => {
                            let loanDoc = null;
                            if (activeLoanRef) {
                                loanDoc = await transaction.get(activeLoanRef);
                            }
                            
                            const oldLoanDed = originalPayrollDoc.data().loanDed || 0;
                            const newLoanDed = payrollData.loanDed;
                            const loanDedDifference = newLoanDed - oldLoanDed;

                            if (loanDedDifference !== 0 && activeLoanRef && loanDoc && loanDoc.exists()) {
                                const loanData = loanDoc.data();
                                const newTotalPaid = (loanData.totalPaid || 0) + loanDedDifference;
                                transaction.update(activeLoanRef, { 
                                    totalPaid: newTotalPaid,
                                    status: newTotalPaid >= loanData.loanAmount ? "Paid Off" : "Active"
                                });
                            }

                            if (newLoanDed > 0) {
                                if (existingPaymentRef) {
                                    transaction.update(existingPaymentRef, { paymentAmount: newLoanDed, paymentDate: payrollData.createdAt.slice(0, 10) });
                                } else if (activeLoanRef) {
                                    const newPaymentRef = doc(collection(db, "loanPayments"));
                                    transaction.set(newPaymentRef, {
                                        loanId: activeLoanId,
                                        payrollId: editingPayrollId,
                                        employeeId: selectedEmployee.id,
                                        paymentAmount: newLoanDed,
                                        paymentDate: payrollData.createdAt.slice(0, 10),
                                        note: `Payroll Deduction for ${payrollData.payrollMonth}`
                                    });
                                }
                            } else if (oldLoanDed > 0 && newLoanDed <= 0 && existingPaymentRef) {
                                transaction.delete(existingPaymentRef);
                            }
                            
                            transaction.update(payrollRef, payrollData);
                        });
                        
                        await addDoc(collection(db, "userLogs"), {
                            userId: auth.currentUser.uid,
                            activity: `Updated payroll for ${selectedEmployee.name}`,
                            timestamp: serverTimestamp(),
                            originalData: originalPayrollDoc.data(),
                            updatedData: payrollData
                        });

                        alert("Payroll updated successfully!");

                    } else {
                        const newPayrollRef = doc(collection(db, "payrolls"));
                        await runTransaction(db, async (transaction) => {
                            let loanDoc = null;
                            if (activeLoanRef) {
                                loanDoc = await transaction.get(activeLoanRef);
                            }
                            
                            transaction.set(newPayrollRef, { ...payrollData, id: newPayrollRef.id });
                            
                            if (payrollData.loanDed > 0 && activeLoanRef) {
                                if (!loanDoc || !loanDoc.exists()) {
                                     throw "Active loan not found in transaction. Please try again.";
                                }
                                
                                const loanData = loanDoc.data();
                                const newTotalPaid = (loanData.totalPaid || 0) + payrollData.loanDed;
                                transaction.update(activeLoanRef, {
                                    totalPaid: newTotalPaid,
                                    status: newTotalPaid >= loanData.loanAmount ? "Paid Off" : "Active"
                                });

                                const paymentRef = doc(collection(db, "loanPayments"));
                                transaction.set(paymentRef, {
                                    loanId: activeLoanId,
                                    payrollId: newPayrollRef.id,
                                    employeeId: selectedEmployee.id,
                                    paymentAmount: payrollData.loanDed,
                                    paymentDate: payrollData.createdAt.slice(0, 10),
                                    note: `Payroll Deduction for ${payrollData.payrollMonth}`
                                });
                            }
                        });
                        
                        await addDoc(collection(db, "userLogs"), {
                            userId: auth.currentUser.uid,
                            activity: `Added payroll for ${selectedEmployee.name}`,
                            timestamp: serverTimestamp(),
                            originalData: {},
                            updatedData: { id: newPayrollRef.id, ...payrollData }
                        });

                        alert("Payroll saved successfully!");
                    }

                    if (payrollRef.current) {
                        html2canvas(payrollRef.current, { scale: 2, backgroundColor: '#ffffff', useCORS: true }).then(canvas => {
                            const link = document.createElement('a');
                            link.download = `${selectedEmployee.name}-${currentDate}.png`;
                            link.href = canvas.toDataURL('image/png');
                            link.click();
                        });
                    }
                    resetForm();
                } catch (error) {
                    console.error("Error saving payroll:", error);
                    alert(`Failed to save payroll: ${error.message}`);
                } finally {
                    setIsSaving(false);
                }
            };

            const PayslipRow = ({ label, value, isBold = false, isCurrency = true, colorClass = 'text-gray-800' }) => (
                <div className="flex justify-between items-center py-2">
                    <span className={isBold ? 'font-semibold' : 'text-gray-600'}>{label}</span>
                    <span className={`${isBold ? 'font-bold' : 'font-medium'} ${colorClass}`}>
                        {isCurrency ? formatCurrency(value) : value}
                    </span>
                </div>
            );

            return (
                <div>
                    <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <div className="lg:col-span-1 space-y-4 p-6 bg-white rounded-lg shadow-md">
                            <div>
                                <label className="block text-sm font-medium text-gray-700">Payroll Month</label>
                                <input type="month" value={currentDate} onChange={e => setCurrentDate(e.target.value)} className="input" />
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-gray-700">Shop Name</label>
                                <select value={selectedShop} onChange={handleShopChange} className="input">
                                    <option value="">Select a shop</option>
                                    {shops.map(shop => <option key={shop.id} value={shop.id}>{shop.name}</option>)}
                                </select>
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-gray-700">Staff Name</label>
                                <select value={selectedEmployeeId} onChange={handleEmployeeChange} className="input" disabled={!selectedShop}>
                                    <option value="">Select an employee</option>
                                    {employeesInShop.map(emp => <option key={emp.id} value={emp.id}>{emp.name}</option>)}
                                </select>
                            </div>
                             <hr className="my-4"/>
                             <div>
                                <label className="block text-sm font-medium text-gray-700">No. Work Day</label>
                                <input type="number" name="workDay" value={payrollInput.workDay} onChange={handlePayrollInputChange} className="input" disabled={!selectedEmployee} />
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-gray-700">Given Off</label>
                                <input type="number" name="givenOff" value={payrollInput.givenOff} onChange={handlePayrollInputChange} className="input" disabled={!selectedEmployee} />
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-gray-700">Leave No</label>
                                <input type="number" name="leaveNo" value={payrollInput.leaveNo} onChange={handlePayrollInputChange} className="input bg-gray-100" disabled={!selectedEmployee} readOnly />
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-gray-700">Loan Ded</label>
                                <input type="number" name="loanDed" value={payrollInput.loanDed} onChange={handlePayrollInputChange} className="input" disabled={!selectedEmployee} />
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-gray-700">Note</label>
                                <input type="text" name="note" value={payrollInput.note} onChange={handlePayrollInputChange} className="input" disabled={!selectedEmployee}/>
                            </div>
                        </div>

                        <div className="lg:col-span-2">
                           <div ref={payrollRef} className="p-4 sm:p-8 bg-white rounded-lg shadow-md border border-gray-200">
                                <div className="text-center mb-6">
                                    <h2 className="text-2xl font-bold text-gray-800">Payslip</h2>
                                    <p className="text-gray-500">For the period of {currentDate}</p>
                                </div>

                                <div className="border-t border-b border-gray-200 py-4 mb-6">
                                    <div className="grid grid-cols-1 sm:grid-cols-2 gap-4 text-sm">
                                        <div><span className="font-semibold text-gray-700">Employee:</span> <span className="text-gray-900">{selectedEmployee?.name || 'N/A'}</span></div>
                                        <div><span className="font-semibold text-gray-700">Shop:</span> <span className="text-gray-900">{shops.find(s => s.id === selectedEmployee?.shop)?.name || 'N/A'}</span></div>
                                        <div><span className="font-semibold text-gray-700">Base Salary:</span> <span className="text-gray-900">{formatCurrency(selectedEmployee?.baseSalary)}</span></div>
                                        <div><span className="font-semibold text-gray-700">Worked Duration:</span> <span className="text-gray-900">{selectedEmployee ? calculateWorkedDuration(selectedEmployee.joinDate) : 'N/A'}</span></div>
                                    </div>
                                </div>

                                <div className="grid grid-cols-1 md:grid-cols-2 gap-8 mb-6">
                                    <div>
                                        <h3 className="text-lg font-semibold text-gray-700 border-b-2 border-green-500 pb-2 mb-3">Earnings</h3>
                                        <div className="space-y-1">
                                            <PayslipRow label="Base Salary Earned" value={calculatedData.baseSalaryEarned} />
                                            <PayslipRow label="OT Salary" value={calculatedData.otSalary} />
                                            <PayslipRow label="Engagements" value={calculatedData.engage} />
                                            <div className="border-t pt-2 mt-2">
                                                <PayslipRow label="Gross Salary" value={calculatedData.grossSalary} isBold={true} />
                                            </div>
                                        </div>
                                    </div>
                                    <div>
                                        <h3 className="text-lg font-semibold text-gray-700 border-b-2 border-red-500 pb-2 mb-3">Deductions</h3>
                                        <div className="space-y-1">
                                            <PayslipRow label="Leave Deduction" value={calculatedData.leaveDeduction} />
                                            <PayslipRow label="Loan Deduction" value={payrollInput.loanDed} />
                                            <PayslipRow label="Other Deductions" value={calculatedData.otherDed} />
                                            <div className="border-t pt-2 mt-2">
                                                <PayslipRow label="Total Deductions" value={calculatedData.totalDeductions} isBold={true} colorClass="text-red-600" />
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div className="bg-gray-100 rounded-lg p-4">
                                    <div className="flex justify-between items-center">
                                        <span className="text-xl font-bold text-gray-800">Net Salary</span>
                                        <span className="text-2xl font-bold text-blue-600">{formatCurrency(calculatedData.finalSalary)}</span>
                                    </div>
                                </div>
                                
                                <div className="text-center mt-6 text-xs text-gray-400">
                                    Generated on {new Date().toLocaleDateString('en-GB')}
                                </div>
                           </div>
                        </div>
                    </div>
                    <div className="mt-6 flex justify-end space-x-4">
                        <button onClick={handleSavePayroll} disabled={!selectedEmployee || isSaving} className="bg-green-600 text-white px-6 py-2 rounded-lg shadow hover:bg-green-700 disabled:bg-gray-400 transition-colors">
                            {isSaving ? 'Saving...' : (editingPayrollId ? 'Update & Download' : 'Save & Download')}
                        </button>
                    </div>
                </div>
            );
        }

        function PayrollHistory({ db, auth, payrolls, employees, shops, onEdit }) {
            const [filters, setFilters] = useState({ shopId: '', employeeId: '', month: '' });

            const handleFilterChange = (e) => {
                const { name, value } = e.target;
                setFilters(prev => ({ ...prev, [name]: value }));
            };

            const filteredPayrolls = useMemo(() => {
                return payrolls.filter(p => {
                    const shopMatch = !filters.shopId || p.shopId === filters.shopId;
                    const employeeMatch = !filters.employeeId || p.employeeId === filters.employeeId;
                    const monthMatch = !filters.month || p.payrollMonth === filters.month;
                    return shopMatch && employeeMatch && monthMatch;
                });
            }, [payrolls, filters]);

            const totals = useMemo(() => {
                return filteredPayrolls.reduce((acc, p) => {
                    acc.finalSalary += p.finalSalary || 0;
                    acc.loanDed += p.loanDed || 0;
                    acc.otherDed += p.otherDed || 0;
                    acc.engage += p.engage || 0;
                    acc.leaveNo += p.leaveNo || 0;
                    acc.otDays += p.otDays || 0;
                    return acc;
                }, { finalSalary: 0, loanDed: 0, otherDed: 0, engage: 0, leaveNo: 0, otDays: 0 });
            }, [filteredPayrolls]);
            
            const getNameById = (id, list) => list.find(item => item.id === id)?.name || 'N/A';
            
            const sortedPayrolls = useMemo(() => {
                return [...filteredPayrolls].sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
            }, [filteredPayrolls]);

            const handleDelete = async (payroll) => {
                if (await showConfirmation("Are you sure you want to delete this payroll record? This will also reverse any loan deduction made.")) {
                    const { runTransaction, doc, collection, query, where, getDocs, addDoc, serverTimestamp } = window.firebaseSDK;

                    const paymentsRef = collection(db, "loanPayments");
                    const paymentQuery = query(paymentsRef, where("payrollId", "==", payroll.id));
                    const paymentQuerySnapshot = await getDocs(paymentQuery);
                    let paymentToDeleteRef = null;
                    if (!paymentQuerySnapshot.empty) {
                        paymentToDeleteRef = paymentQuerySnapshot.docs[0].ref;
                    }

                    try {
                        await runTransaction(db, async (transaction) => {
                            let loanDoc = null;
                            const loanRef = payroll.loanId ? doc(db, "staffLoans", payroll.loanId) : null;
                            if (loanRef) {
                                loanDoc = await transaction.get(loanRef);
                            }

                            const payrollRef = doc(db, "payrolls", payroll.id);
                            
                            if (payroll.loanDed > 0 && loanRef && loanDoc && loanDoc.exists()) {
                                const loanData = loanDoc.data();
                                const newTotalPaid = (loanData.totalPaid || 0) - payroll.loanDed;
                                transaction.update(loanRef, { 
                                    totalPaid: newTotalPaid < 0 ? 0 : newTotalPaid,
                                    status: "Active"
                                });
                            }

                            if (paymentToDeleteRef) {
                                transaction.delete(paymentToDeleteRef);
                            }

                            transaction.delete(payrollRef);
                        });

                        await addDoc(collection(db, "userLogs"), {
                            userId: auth.currentUser.uid,
                            activity: `Deleted payroll for ${getNameById(payroll.employeeId, employees)}`,
                            timestamp: serverTimestamp(),
                            originalData: payroll,
                            updatedData: {}
                        });

                        alert("Payroll record deleted successfully.");
                    } catch (error) {
                        console.error("Error deleting payroll:", error);
                        alert(`Failed to delete payroll: ${error.message}`);
                    }
                }
            };

            return (
                <div className="bg-white shadow-md rounded-lg overflow-hidden">
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-4 p-4">
                        <select name="shopId" value={filters.shopId} onChange={handleFilterChange} className="input">
                            <option value="">All Shops</option>
                            {shops.map(s => <option key={s.id} value={s.id}>{s.name}</option>)}
                        </select>
                        <select name="employeeId" value={filters.employeeId} onChange={handleFilterChange} className="input">
                            <option value="">All Employees</option>
                            {employees.map(e => <option key={e.id} value={e.id}>{e.name}</option>)}
                        </select>
                        <input type="month" name="month" value={filters.month} onChange={handleFilterChange} className="input" />
                    </div>
                    <div className="overflow-x-auto">
                        <table className="min-w-full divide-y divide-gray-200">
                            <thead className="bg-gray-50">
                                <tr>
                                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Date</th>
                                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Employee</th>
                                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase hidden lg:table-cell">Base Salary</th>
                                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase hidden md:table-cell">Loan Ded.</th>
                                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Final Salary</th>
                                    <th className="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">Actions</th>
                                </tr>
                            </thead>
                            <tbody className="bg-white divide-y divide-gray-200">
                                {sortedPayrolls.map(p => (
                                    <tr key={p.id}>
                                        <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{p.payrollMonth}</td>
                                        <td className="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">{getNameById(p.employeeId, employees)}</td>
                                        <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500 hidden lg:table-cell">{formatCurrency(p.baseSalary)}</td>
                                        <td className="px-6 py-4 whitespace-nowrap text-sm text-red-600 hidden md:table-cell">{formatCurrency(p.loanDed)}</td>
                                        <td className="px-6 py-4 whitespace-nowrap text-sm font-semibold text-blue-600">{formatCurrency(p.finalSalary)}</td>
                                        <td className="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                                            <button onClick={() => onEdit(p)} className="text-indigo-600 hover:text-indigo-900 mr-4">Edit</button>
                                            <button onClick={() => handleDelete(p)} className="text-red-600 hover:text-red-900">Delete</button>
                                        </td>
                                    </tr>
                                ))}
                            </tbody>
                            <tfoot className="bg-gray-100">
                                <tr>
                                    <td colSpan="4" className="px-6 py-4 text-right font-bold text-gray-600 hidden md:table-cell">Sub-Total:</td>
                                    <td colSpan="2" className="px-6 py-4 text-right font-bold text-gray-600 md:hidden">Sub-Total:</td>
                                    <td className="px-6 py-4 font-bold text-blue-700">{formatCurrency(totals.finalSalary)}</td>
                                    <td colSpan="1"></td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
            );
        }

        function OTReportModal({ db, auth, report, onClose, employees, shops }) {
            const initialFormState = {
                date: new Date().toISOString().slice(0, 10),
                shopId: '',
                employeeId: '',
                otDays: '',
                note: ''
            };
            const [formData, setFormData] = useState(report || initialFormState);
            const [filteredEmployees, setFilteredEmployees] = useState([]);
            const [isSaving, setIsSaving] = useState(false);

            useEffect(() => {
                if (formData.shopId) {
                    setFilteredEmployees(employees.filter(emp => emp.shop === formData.shopId && emp.staffStatus === 'Active'));
                }
            }, [formData.shopId, employees]);
            
            useEffect(() => {
                if(report && report.shopId) {
                     setFilteredEmployees(employees.filter(emp => emp.shop === report.shopId && emp.staffStatus === 'Active'));
                }
            }, [report, employees]);

            const handleShopChange = (e) => {
                const shopId = e.target.value;
                setFormData(prev => ({ ...prev, shopId, employeeId: '' }));
            };

            const handleChange = (e) => {
                const { name, value } = e.target;
                setFormData(prev => ({ ...prev, [name]: value }));
            };

            const handleSubmit = async (e) => {
                e.preventDefault();
                if (!formData.employeeId || !formData.shopId) {
                    alert("Please select a shop and employee.");
                    return;
                }
                setIsSaving(true);
                try {
                    const { doc, updateDoc, addDoc, collection, serverTimestamp } = window.firebaseSDK;
                    const dataToSave = {
                        ...formData,
                        otDays: parseFloat(formData.otDays) || 0,
                    };
                    const employeeName = employees.find(emp => emp.id === formData.employeeId)?.name || 'N/A';

                    if (report) {
                        const { id, ...dataToUpdate } = dataToSave;
                        await updateDoc(doc(db, "otReports", id), dataToUpdate);
                        await addDoc(collection(db, "userLogs"), {
                            userId: auth.currentUser.uid,
                            activity: `Updated OT report for ${employeeName}`,
                            timestamp: serverTimestamp(),
                            originalData: report,
                            updatedData: dataToSave
                        });
                    } else {
                        const newDocRef = await addDoc(collection(db, "otReports"), dataToSave);
                        await addDoc(collection(db, "userLogs"), {
                            userId: auth.currentUser.uid,
                            activity: `Added OT report for ${employeeName}`,
                            timestamp: serverTimestamp(),
                            originalData: {},
                            updatedData: {id: newDocRef.id, ...dataToSave}
                        });
                    }
                    onClose();
                } catch (error) {
                    console.error("Error saving OT report: ", error);
                } finally {
                    setIsSaving(false);
                }
            };

            return (
                <div className="modal-overlay">
                    <div className="modal-content">
                        <h3 className="text-xl font-semibold mb-4">{report ? 'Edit OT Report' : 'Add New OT Report'}</h3>
                        <form onSubmit={handleSubmit} className="space-y-4">
                            <div><label className="block text-sm font-medium text-gray-700">Date</label><input type="date" name="date" value={formData.date} onChange={handleChange} className="input" required /></div>
                            <div>
                                <label className="block text-sm font-medium text-gray-700">Shop</label>
                                <select name="shopId" value={formData.shopId} onChange={handleShopChange} className="input" required>
                                    <option value="">Select Shop</option>
                                    {shops.map(shop => <option key={shop.id} value={shop.id}>{shop.name}</option>)}
                                </select>
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-gray-700">Staff Name</label>
                                <select name="employeeId" value={formData.employeeId} onChange={handleChange} className="input" required disabled={!formData.shopId}>
                                    <option value="">Select Staff</option>
                                    {filteredEmployees.map(emp => <option key={emp.id} value={emp.id}>{emp.name}</option>)}
                                </select>
                            </div>
                            <div><label className="block text-sm font-medium text-gray-700">OT Days</label><input type="number" step="0.5" name="otDays" value={formData.otDays} onChange={handleChange} className="input" required /></div>
                            <div><label className="block text-sm font-medium text-gray-700">Note</label><textarea name="note" value={formData.note} onChange={handleChange} rows="3" className="input"></textarea></div>
                            <div className="flex justify-end space-x-3 pt-4">
                                <button type="button" onClick={onClose} className="bg-white py-2 px-4 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 hover:bg-gray-50">Cancel</button>
                                <button type="submit" disabled={isSaving} className="bg-blue-600 text-white px-4 py-2 rounded-lg shadow hover:bg-blue-700">{isSaving ? 'Saving...' : 'Save'}</button>
                            </div>
                        </form>
                    </div>
                </div>
            );
        }

        function OTReportTab({ db, auth, otReports, employees, shops }) {
            const [isModalOpen, setIsModalOpen] = useState(false);
            const [editingReport, setEditingReport] = useState(null);
            const [filters, setFilters] = useState({ shopId: '', employeeId: '', month: '' });

            const handleFilterChange = (e) => {
                const { name, value } = e.target;
                setFilters(prev => ({ ...prev, [name]: value }));
            };
            
            const openModal = (report = null) => {
                setEditingReport(report);
                setIsModalOpen(true);
            };

            const closeModal = () => {
                setEditingReport(null);
                setIsModalOpen(false);
            };

            const handleDelete = async (reportId) => {
                const reportToDelete = otReports.find(r => r.id === reportId);
                if (await showConfirmation("Are you sure you want to delete this OT record?")) {
                    try {
                        const { doc, deleteDoc, addDoc, collection, serverTimestamp } = window.firebaseSDK;
                        await deleteDoc(doc(db, "otReports", reportId));
                        await addDoc(collection(db, "userLogs"), {
                            userId: auth.currentUser.uid,
                            activity: `Deleted OT report for ${getNameById(reportToDelete.employeeId, employees)}`,
                            timestamp: serverTimestamp(),
                            originalData: reportToDelete,
                            updatedData: {}
                        });
                    } catch (e) {
                        console.error("Error deleting OT report: ", e);
                    }
                }
            };
            
            const getNameById = (id, list) => list.find(item => item.id === id)?.name || 'N/A';
            
            const filteredReports = useMemo(() => {
                return otReports.filter(r => {
                    const [year, month] = r.date.split('-');
                    const reportMonth = `${year}-${month}`;
                    
                    const shopMatch = !filters.shopId || r.shopId === filters.shopId;
                    const employeeMatch = !filters.employeeId || r.employeeId === filters.employeeId;
                    const monthMatch = !filters.month || reportMonth === filters.month;
                    return shopMatch && employeeMatch && monthMatch;
                });
            }, [otReports, filters]);

            return (
                <div className="space-y-6">
                    <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                        <h2 className="text-2xl font-semibold text-gray-700">Overtime Reports</h2>
                        <button onClick={() => openModal()} className="bg-blue-600 text-white px-4 py-2 rounded-lg shadow hover:bg-blue-700 transition-colors w-full sm:w-auto">
                            Add New OT Report
                        </button>
                    </div>
                    
                    {isModalOpen && <OTReportModal db={db} auth={auth} report={editingReport} onClose={closeModal} employees={employees} shops={shops} />}

                    <div className="bg-white shadow-md rounded-lg overflow-hidden">
                         <div className="grid grid-cols-1 md:grid-cols-3 gap-4 p-4">
                            <select name="shopId" value={filters.shopId} onChange={handleFilterChange} className="input">
                                <option value="">All Shops</option>
                                {shops.map(s => <option key={s.id} value={s.id}>{s.name}</option>)}
                            </select>
                            <select name="employeeId" value={filters.employeeId} onChange={handleFilterChange} className="input">
                                <option value="">All Employees</option>
                                {employees.map(e => <option key={e.id} value={e.id}>{e.name}</option>)}
                            </select>
                            <input type="month" name="month" value={filters.month} onChange={handleFilterChange} className="input" />
                        </div>
                        <div className="overflow-x-auto">
                            <table className="min-w-full divide-y divide-gray-200">
                                <thead className="bg-gray-50">
                                    <tr>
                                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Staff Name</th>
                                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider hidden sm:table-cell">Shop</th>
                                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">OT Days</th>
                                        <th className="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                    </tr>
                                </thead>
                                <tbody className="bg-white divide-y divide-gray-200">
                                    {filteredReports.map(report => (
                                        <tr key={report.id}>
                                            <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{formatDate(report.date)}</td>
                                            <td className="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">{getNameById(report.employeeId, employees)}</td>
                                            <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500 hidden sm:table-cell">{getNameById(report.shopId, shops)}</td>
                                            <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{report.otDays}</td>
                                            <td className="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                                                <button onClick={() => openModal(report)} className="text-indigo-600 hover:text-indigo-900 mr-4">Edit</button>
                                                <button onClick={() => handleDelete(report.id)} className="text-red-600 hover:text-red-900">Delete</button>
                                            </td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            )
        }
        
        function ExpenseReportPage({ payrolls, shops }) {
            const [filters, setFilters] = useState({ shopId: '', month: '' });

            const handleFilterChange = (e) => {
                const { name, value } = e.target;
                setFilters(prev => ({ ...prev, [name]: value }));
            };

            const getNameById = (id, list) => list.find(item => item.id === id)?.name || 'N/A';
            
            const reportData = useMemo(() => {
                const filtered = payrolls.filter(p => {
                    const shopMatch = !filters.shopId || p.shopId === filters.shopId;
                    const monthMatch = !filters.month || p.payrollMonth === filters.month;
                    return shopMatch && monthMatch;
                });

                const grouped = filtered.reduce((acc, p) => {
                    const key = `${p.payrollMonth}-${p.shopId}`;
                    if (!acc[key]) {
                        acc[key] = {
                            month: p.payrollMonth,
                            shopId: p.shopId,
                            totalLoanDed: 0,
                            totalOtherDed: 0,
                            totalEngage: 0,
                            totalFinalSalary: 0,
                            totalAccSalary: 0,
                            count: 0
                        };
                    }
                    acc[key].totalLoanDed += p.loanDed || 0;
                    acc[key].totalOtherDed += p.otherDed || 0;
                    acc[key].totalEngage += p.engage || 0;
                    acc[key].totalFinalSalary += p.finalSalary || 0;
                    acc[key].totalAccSalary += (p.loanDed || 0) + (p.finalSalary || 0);
                    acc[key].count += 1;
                    return acc;
                }, {});

                return Object.values(grouped).sort((a, b) => b.month.localeCompare(a.month));
            }, [payrolls, filters]);

            const totals = useMemo(() => {
                return reportData.reduce((acc, row) => {
                    acc.totalLoanDed += row.totalLoanDed;
                    acc.totalOtherDed += row.totalOtherDed;
                    acc.totalEngage += row.totalEngage;
                    acc.totalFinalSalary += row.totalFinalSalary;
                    acc.totalAccSalary += row.totalAccSalary;
                    return acc;
                }, { totalLoanDed: 0, totalOtherDed: 0, totalEngage: 0, totalFinalSalary: 0, totalAccSalary: 0 });
            }, [reportData]);

            return (
                <div className="space-y-6">
                    <header>
                        <h1 className="text-3xl md:text-4xl font-bold text-gray-800">Expense Report</h1>
                        <p className="text-gray-500 mt-1">A summary of payroll expenses by shop and month.</p>
                    </header>
                     <div className="bg-white shadow-md rounded-lg overflow-hidden">
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4 p-4">
                            <select name="shopId" value={filters.shopId} onChange={handleFilterChange} className="input">
                                <option value="">All Shops</option>
                                {shops.map(s => <option key={s.id} value={s.id}>{s.name}</option>)}
                            </select>
                            <input type="month" name="month" value={filters.month} onChange={handleFilterChange} className="input" />
                        </div>
                        <div className="overflow-x-auto">
                            <table className="min-w-full divide-y divide-gray-200">
                                <thead className="bg-gray-50">
                                    <tr>
                                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Month</th>
                                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Shop Name</th>
                                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase hidden md:table-cell">Total Loan Ded.</th>
                                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase hidden lg:table-cell">Total Other Ded.</th>
                                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Total Final Salary</th>
                                    </tr>
                                </thead>
                                <tbody className="bg-white divide-y divide-gray-200">
                                    {reportData.map((row, index) => (
                                        <tr key={`${row.month}-${row.shopId}`}>
                                            <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{row.month}</td>
                                            <td className="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">{getNameById(row.shopId, shops)}</td>
                                            <td className="px-6 py-4 whitespace-nowrap text-sm text-red-600 hidden md:table-cell">{formatCurrency(row.totalLoanDed)}</td>
                                            <td className="px-6 py-4 whitespace-nowrap text-sm text-red-600 hidden lg:table-cell">{formatCurrency(row.totalOtherDed)}</td>
                                            <td className="px-6 py-4 whitespace-nowrap text-sm font-semibold text-blue-600">{formatCurrency(row.totalFinalSalary)}</td>
                                        </tr>
                                    ))}
                                </tbody>
                                <tfoot className="bg-gray-100">
                                    <tr>
                                        <td colSpan="4" className="px-6 py-4 text-right font-bold text-gray-600 hidden lg:table-cell">Sub-Total:</td>
                                        <td colSpan="2" className="px-6 py-4 text-right font-bold text-gray-600 lg:hidden">Sub-Total:</td>
                                        <td className="px-6 py-4 font-bold text-blue-700">{formatCurrency(totals.totalFinalSalary)}</td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                    </div>
                </div>
            );
        }
        
        const LogDetail = ({ title, data }) => {
            if (!data || Object.keys(data).length === 0) {
                return null;
            }
            return (
                <div>
                    <h4 className="font-semibold text-gray-700">{title}</h4>
                    <pre className="text-xs whitespace-pre-wrap break-all bg-gray-100 p-2 rounded-md mt-1">
                        {JSON.stringify(data, null, 2)}
                    </pre>
                </div>
            );
        };

        const DiffView = ({ originalData, updatedData }) => {
            const formatLogValue = (value) => {
                if (value === null || value === undefined || value === "") {
                    return "";
                }
                if (Array.isArray(value)) {
                     if (value.length === 0) return "";
                    return `[${value.join(', ')}]`;
                }
                return String(value);
            };

            const diff = useMemo(() => {
                const changes = {};
                const allKeys = new Set([...Object.keys(originalData || {}), ...Object.keys(updatedData || {})]);
                
                allKeys.forEach(key => {
                    if (key === 'id' || key === 'createdAt') return; 
                    const originalValue = originalData?.[key];
                    const updatedValue = updatedData?.[key];
                    
                    const normOriginal = (originalValue === null || originalValue === undefined) ? "" : originalValue;
                    const normUpdated = (updatedValue === null || updatedValue === undefined) ? "" : updatedValue;

                    if (JSON.stringify(normOriginal) !== JSON.stringify(normUpdated)) {
                        changes[key] = {
                            from: originalValue,
                            to: updatedValue,
                        };
                    }
                });
                return changes;
            }, [originalData, updatedData]);

            if (Object.keys(diff).length === 0) {
                return <LogDetail title="Details" data={updatedData} />;
            }
            
            return (
                 <div>
                    <h4 className="font-semibold text-gray-700">Changes</h4>
                    <div className="text-xs mt-1 space-y-1">
                        {Object.entries(diff).map(([key, values]) => (
                            <div key={key} className="flex flex-wrap">
                                <span className="font-medium text-gray-600 mr-2">{key}:</span>
                                <span className="text-red-600 line-through mr-2">{formatLogValue(values.from)}</span>
                                <span className="text-green-600">{formatLogValue(values.to)}</span>
                            </div>
                        ))}
                    </div>
                </div>
            )
        };


        function UserActivityPage({ userLogs, supervisors, shops }) {
            const [filters, setFilters] = useState({ userId: '', action: '', date: '' });

            const handleFilterChange = (e) => {
                const { name, value } = e.target;
                setFilters(prev => ({ ...prev, [name]: value }));
            };

            const getUserNameByUid = (uid, supervisorList) => {
                const supervisor = supervisorList.find(s => s.uid === uid);
                return supervisor ? supervisor.name : 'N/A';
            };
            
            const getActionStatus = (log) => {
                const hasOriginalData = log.originalData && Object.keys(log.originalData).length > 0;
                const hasUpdatedData = log.updatedData && Object.keys(log.updatedData).length > 0;

                if (!hasOriginalData && hasUpdatedData) {
                    return { text: 'Add', class: 'bg-green-100 text-green-800' };
                }
                if (hasOriginalData && hasUpdatedData) {
                    return { text: 'Edit', class: 'bg-yellow-100 text-yellow-800' };
                }
                if (hasOriginalData && !hasUpdatedData) {
                    return { text: 'Delete', class: 'bg-red-100 text-red-800' };
                }
                return { text: 'Info', class: 'bg-blue-100 text-blue-800' };
            };

            const sortedLogs = useMemo(() => {
                return [...userLogs].sort((a,b) => (b.timestamp?.toDate() || 0) - (a.timestamp?.toDate() || 0));
            }, [userLogs]);

            const filteredLogs = useMemo(() => {
                return sortedLogs.filter(log => {
                    const actionStatus = getActionStatus(log).text;
                    const logDate = log.timestamp?.toDate().toISOString().slice(0, 10);

                    const userMatch = !filters.userId || log.userId === filters.userId;
                    const actionMatch = !filters.action || actionStatus === filters.action;
                    const dateMatch = !filters.date || logDate === filters.date;

                    return userMatch && actionMatch && dateMatch;
                });
            }, [sortedLogs, filters]);

            return (
                <div className="space-y-6">
                    <header>
                        <h1 className="text-3xl md:text-4xl font-bold text-gray-800">User Activity Log</h1>
                        <p className="text-gray-500 mt-1">A record of all user activities within the system.</p>
                    </header>

                    <div className="grid grid-cols-1 md:grid-cols-3 gap-4 p-4 bg-white rounded-lg shadow">
                        <select name="userId" value={filters.userId} onChange={handleFilterChange} className="input">
                            <option value="">All Users</option>
                            {supervisors.map(s => <option key={s.uid} value={s.uid}>{s.name}</option>)}
                        </select>
                        <select name="action" value={filters.action} onChange={handleFilterChange} className="input">
                            <option value="">All Actions</option>
                            <option value="Add">Add</option>
                            <option value="Edit">Edit</option>
                            <option value="Delete">Delete</option>
                        </select>
                        <input type="date" name="date" value={filters.date} onChange={handleFilterChange} className="input" />
                    </div>

                    <div className="bg-white shadow-md rounded-lg overflow-hidden">
                        <div className="overflow-x-auto">
                            <table className="min-w-full divide-y divide-gray-200">
                                <thead className="bg-gray-50">
                                    <tr>
                                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Timestamp</th>
                                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">User</th>
                                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Action</th>
                                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Activity</th>
                                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Details</th>
                                    </tr>
                                </thead>
                                <tbody className="bg-white divide-y divide-gray-200">
                                    {filteredLogs.map(log => {
                                        const status = getActionStatus(log);
                                        return (
                                        <tr key={log.id}>
                                            <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{formatTimestamp(log.timestamp)}</td>
                                            <td className="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">{getUserNameByUid(log.userId, supervisors)}</td>
                                            <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                                <span className={`px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${status.class}`}>
                                                    {status.text}
                                                </span>
                                            </td>
                                            <td className="px-6 py-4 text-sm text-gray-500 min-w-[250px]">{log.activity}</td>
                                            <td className="px-6 py-4 text-sm text-gray-500 min-w-[300px]">
                                                <DiffView originalData={log.originalData} updatedData={log.updatedData} />
                                            </td>
                                        </tr>
                                    )})}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            );
        }

        function SalaryReviseTab({ db, auth, employees, shops, salaryRevisions, userPermissions }) {
            const initialFormState = {
                date: new Date().toISOString().slice(0, 10),
                shopId: '',
                employeeId: '',
                baseSalary: '',
                amountRequest: '',
                note: ''
            };
            const [formData, setFormData] = useState(initialFormState);
            const [filteredEmployees, setFilteredEmployees] = useState([]);
            const [isSubmitting, setIsSubmitting] = useState(false);
            
            const selectedEmployee = useMemo(() => {
                return employees.find(emp => emp.id === formData.employeeId) || null;
            }, [formData.employeeId, employees]);

            useEffect(() => {
                if (selectedEmployee) {
                    setFormData(prev => ({ ...prev, baseSalary: selectedEmployee.baseSalary || '' }));
                } else {
                     setFormData(prev => ({ ...prev, baseSalary: '' }));
                }
            }, [selectedEmployee]);

            const handleShopChange = (e) => {
                const shopId = e.target.value;
                setFormData(prev => ({ ...prev, shopId, employeeId: '', baseSalary: '' }));
                setFilteredEmployees(employees.filter(emp => emp.shop === shopId && emp.staffStatus === 'Active'));
            };

            const handleChange = (e) => {
                const { name, value } = e.target;
                setFormData(prev => ({ ...prev, [name]: value }));
            };

            const updatedSalary = useMemo(() => {
                const base = parseFloat(formData.baseSalary) || 0;
                const request = parseFloat(formData.amountRequest) || 0;
                return base + request;
            }, [formData.baseSalary, formData.amountRequest]);
            
            const handleSubmitRevise = async () => {
                if (!formData.employeeId || !formData.amountRequest) {
                    alert("Please select an employee and enter a requested amount.");
                    return;
                }
                setIsSubmitting(true);
                try {
                    const { addDoc, collection, serverTimestamp } = window.firebaseSDK;
                    const dataToSave = {
                        ...formData,
                        baseSalary: parseFloat(formData.baseSalary) || 0,
                        amountRequest: parseFloat(formData.amountRequest) || 0,
                        updatedSalary: updatedSalary,
                        status: 'Pending'
                    };
                    const newDocRef = await addDoc(collection(db, "salaryRevisions"), dataToSave);
                    await addDoc(collection(db, "userLogs"), {
                        userId: auth.currentUser.uid,
                        activity: `Submitted salary revision for ${selectedEmployee.name}`,
                        timestamp: serverTimestamp(),
                        originalData: {},
                        updatedData: {id: newDocRef.id, ...dataToSave}
                    });

                    alert("Salary revise request submitted successfully!");
                    setFormData(initialFormState);
                } catch (error) {
                    console.error("Error submitting salary revise request: ", error);
                    alert("Failed to submit request.");
                } finally {
                    setIsSubmitting(false);
                }
            };
            
            return (
                <div className="space-y-6">
                    <div className="bg-white p-6 rounded-lg shadow-md">
                        <h2 className="text-2xl font-semibold mb-4">Revise Form</h2>
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div><label className="block text-sm font-medium text-gray-700">Date</label><input type="date" name="date" value={formData.date} onChange={handleChange} className="input" /></div>
                            <div>
                                <label className="block text-sm font-medium text-gray-700">Shop Name</label>
                                <select name="shopId" value={formData.shopId} onChange={handleShopChange} className="input">
                                    <option value="">Select Shop</option>
                                    {shops.map(shop => <option key={shop.id} value={shop.id}>{shop.name}</option>)}
                                </select>
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-gray-700">Staff Name</label>
                                <select name="employeeId" value={formData.employeeId} onChange={handleChange} className="input" disabled={!formData.shopId}>
                                    <option value="">Select Staff</option>
                                    {filteredEmployees.map(emp => <option key={emp.id} value={emp.id}>{emp.name}</option>)}
                                </select>
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-gray-700">Base Salary</label>
                                <input type="text" name="baseSalary" value={formatCurrency(formData.baseSalary)} className="input bg-gray-100" readOnly />
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-gray-700">Amount Request</label>
                                <input type="number" name="amountRequest" value={formData.amountRequest} onChange={handleChange} className="input" />
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-gray-700">Updated Salary</label>
                                <input type="text" value={formatCurrency(updatedSalary)} className="input bg-gray-100" readOnly />
                            </div>
                            <div className="md:col-span-2">
                                <label className="block text-sm font-medium text-gray-700">Note</label>
                                <textarea name="note" value={formData.note} onChange={handleChange} rows="3" className="input"></textarea>
                            </div>
                        </div>
                        <div className="mt-6 flex justify-end">
                            <button 
                                onClick={handleSubmitRevise} 
                                disabled={isSubmitting}
                                className="bg-blue-600 text-white px-6 py-2 rounded-lg shadow hover:bg-blue-700 disabled:bg-gray-400 transition-colors"
                            >
                                {isSubmitting ? 'Submitting...' : 'Submit Revise'}
                            </button>
                        </div>
                    </div>
                    <ReviseTrackingReport db={db} auth={auth} salaryRevisions={salaryRevisions} employees={employees} shops={shops} userPermissions={userPermissions} />
                </div>
            );
        }

        function ReviseTrackingReport({ db, auth, salaryRevisions, employees, shops, userPermissions }) {
            const getNameById = (id, list) => list.find(item => item.id === id)?.name || 'N/A';

            const handleStatusChange = async (revision, newStatus) => {
                const { doc, updateDoc, runTransaction, addDoc, collection, serverTimestamp } = window.firebaseSDK;
                const revisionRef = doc(db, "salaryRevisions", revision.id);
                const employeeName = getNameById(revision.employeeId, employees);

                if (newStatus === 'Approved') {
                    if (await showConfirmation("Are you sure you want to approve this salary revision? This will update the employee's base salary.")) {
                        try {
                            await runTransaction(db, async (transaction) => {
                                const employeeRef = doc(db, "employees", revision.employeeId);
                                transaction.update(employeeRef, { baseSalary: revision.updatedSalary });
                                transaction.update(revisionRef, { status: newStatus });
                            });
                            
                            await addDoc(collection(db, "userLogs"), {
                                userId: auth.currentUser.uid,
                                activity: `Approved salary revision for ${employeeName}`,
                                timestamp: serverTimestamp(),
                                originalData: { status: revision.status },
                                updatedData: { status: newStatus }
                            });

                            alert("Salary revision approved and employee updated.");
                        } catch (error) {
                            console.error("Error approving revision: ", error);
                            alert("Failed to approve revision.");
                        }
                    }
                } else {
                     if (await showConfirmation("Are you sure you want to reject this salary revision?")) {
                        await updateDoc(revisionRef, { status: newStatus });
                        await addDoc(collection(db, "userLogs"), {
                            userId: auth.currentUser.uid,
                            activity: `Rejected salary revision for ${employeeName}`,
                            timestamp: serverTimestamp(),
                            originalData: { status: revision.status },
                            updatedData: { status: newStatus }
                        });
                     }
                }
            };

            const handleDelete = async (revisionId) => {
                const revisionToDelete = salaryRevisions.find(r => r.id === revisionId);
                if (await showConfirmation("Are you sure you want to delete this revision request?")) {
                    try {
                        const { doc, deleteDoc, addDoc, collection, serverTimestamp } = window.firebaseSDK;
                        await deleteDoc(doc(db, "salaryRevisions", revisionId));
                        await addDoc(collection(db, "userLogs"), {
                            userId: auth.currentUser.uid,
                            activity: `Deleted salary revision for ${getNameById(revisionToDelete.employeeId, employees)}`,
                            timestamp: serverTimestamp(),
                            originalData: revisionToDelete,
                            updatedData: {}
                        });
                    } catch (e) {
                        console.error("Error deleting revision: ", e);
                    }
                }
            };
            
            const isAdmin = userPermissions.role === 'Admin';

            return (
                <div className="bg-white shadow-md rounded-lg overflow-hidden mt-8">
                    <h2 className="text-2xl font-semibold p-6">Revise Tracking Report</h2>
                    <div className="overflow-x-auto">
                        <table className="min-w-full divide-y divide-gray-200">
                            <thead className="bg-gray-50">
                                <tr>
                                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Date</th>
                                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Staff Name</th>
                                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Amount Request</th>
                                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Updated Salary</th>
                                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                                    <th className="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">Action</th>
                                </tr>
                            </thead>
                            <tbody className="bg-white divide-y divide-gray-200">
                                {salaryRevisions.map(rev => (
                                    <tr key={rev.id}>
                                        <td className="px-6 py-4 whitespace-nowrap text-sm">{formatDate(rev.date)}</td>
                                        <td className="px-6 py-4 whitespace-nowrap text-sm font-medium">{getNameById(rev.employeeId, employees)}</td>
                                        <td className="px-6 py-4 whitespace-nowrap text-sm text-green-600">{formatCurrency(rev.amountRequest)}</td>
                                        <td className="px-6 py-4 whitespace-nowrap text-sm font-bold">{formatCurrency(rev.updatedSalary)}</td>
                                        <td className="px-6 py-4 whitespace-nowrap text-sm">
                                            {isAdmin && rev.status === 'Pending' ? (
                                                <div className="flex space-x-2">
                                                    <button onClick={() => handleStatusChange(rev, 'Approved')} className="bg-green-500 text-white px-2 py-1 text-xs rounded hover:bg-green-600">Yes</button>
                                                    <button onClick={() => handleStatusChange(rev, 'Rejected')} className="bg-red-500 text-white px-2 py-1 text-xs rounded hover:bg-red-600">No</button>
                                                </div>
                                            ) : (
                                                <span className={`px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${
                                                    rev.status === 'Approved' ? 'bg-green-100 text-green-800' : 
                                                    rev.status === 'Rejected' ? 'bg-red-100 text-red-800' : 'bg-yellow-100 text-yellow-800'
                                                }`}>
                                                    {rev.status}
                                                </span>
                                            )}
                                        </td>
                                        <td className="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                                            {isAdmin && rev.status === 'Pending' && (
                                                <button onClick={() => handleDelete(rev.id)} className="text-red-600 hover:text-red-900">Delete</button>
                                            )}
                                        </td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                </div>
            );
        }

        function SettingsCRUD({ db, auth, title, collectionName, items, formFields, listColumns }) {
            const [editingItem, setEditingItem] = useState(null);
            const [newItem, setNewItem] = useState({});

            const getInitialState = useCallback(() => {
                return formFields.reduce((acc, field) => {
                    acc[field.name] = (field.type === 'multiselect' || field.type === 'checkbox-group') ? [] : '';
                    return acc;
                }, {});
            }, [formFields]);

            useEffect(() => {
                setNewItem(getInitialState());
            }, [getInitialState]);

            const handleSave = async (item) => {
                const { doc, updateDoc, addDoc, collection, serverTimestamp } = window.firebaseSDK;
                const dataToSave = { ...item };
                try {
                    if (item.id) {
                        const { id, ...data } = dataToSave;
                        const originalItem = items.find(i => i.id === id);
                        await updateDoc(doc(db, collectionName, id), data);
                        await addDoc(collection(db, "userLogs"), {
                            userId: auth.currentUser.uid,
                            activity: `Updated ${title}: ${data.name || item.id}`,
                            timestamp: serverTimestamp(),
                            originalData: originalItem,
                            updatedData: data
                        });
                    } else {
                        const newDocRef = await addDoc(collection(db, collectionName), dataToSave);
                        await addDoc(collection(db, "userLogs"), {
                            userId: auth.currentUser.uid,
                            activity: `Added new ${title}: ${dataToSave.name}`,
                            timestamp: serverTimestamp(),
                            originalData: {},
                            updatedData: {id: newDocRef.id, ...dataToSave}
                        });
                    }
                    setEditingItem(null);
                    setNewItem(getInitialState());
                } catch (e) {
                    console.error(`Error saving ${collectionName}:`, e);
                }
            };
            
            const handleDelete = async (id) => {
                if (await showConfirmation(`Are you sure you want to delete this item?`)) {
                    try {
                        const { doc, deleteDoc, addDoc, collection, serverTimestamp } = window.firebaseSDK;
                        const itemToDelete = items.find(i => i.id === id);
                        await deleteDoc(doc(db, collectionName, id));
                        await addDoc(collection(db, "userLogs"), {
                            userId: auth.currentUser.uid,
                            activity: `Deleted ${title}: ${itemToDelete.name || id}`,
                            timestamp: serverTimestamp(),
                            originalData: itemToDelete,
                            updatedData: {}
                        });
                    } catch (e) {
                        console.error(`Error deleting ${collectionName}:`, e);
                    }
                }
            };

            const handleInputChange = (e, item, setItem) => {
                const { name, type, value, checked } = e.target;
                
                if (type === 'checkbox') {
                    const currentValues = item[name] || [];
                    if (checked) {
                        setItem({ ...item, [name]: [...currentValues, value] });
                    } else {
                        setItem({ ...item, [name]: currentValues.filter(val => val !== value) });
                    }
                } else {
                    setItem({ ...item, [name]: value });
                }
            };

            const renderForm = (item, setItem, isNew = false) => (
                 <form onSubmit={(e) => { e.preventDefault(); handleSave(item); }} className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 items-start p-4 bg-gray-50 rounded-lg mb-6">
                    {formFields.map(field => (
                        <div key={field.name} className={field.type === 'checkbox-group' ? 'md:col-span-2 lg:col-span-1' : ''}>
                            <label className="block text-sm font-medium text-gray-700">{field.label}</label>
                            {field.type === 'select' ? (
                                <select name={field.name} value={item[field.name] || ''} onChange={(e) => handleInputChange(e, item, setItem)} className="input" required={field.required}>
                                    <option value="">{field.placeholder}</option>
                                    {field.options.map(opt => <option key={opt.id} value={opt.id}>{opt.name}</option>)}
                                </select>
                            ) : field.type === 'checkbox-group' ? (
                                <div className="checkbox-group">
                                    {field.options.map(opt => (
                                        <div key={opt.id} className="flex items-center">
                                            <input
                                                id={`${field.name}-${opt.id}`}
                                                name={field.name}
                                                type="checkbox"
                                                value={opt.id}
                                                checked={(item[field.name] || []).includes(opt.id)}
                                                onChange={(e) => handleInputChange(e, item, setItem)}
                                                className="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500"
                                            />
                                            <label htmlFor={`${field.name}-${opt.id}`} className="ml-2 block text-sm text-gray-900">{opt.name}</label>
                                        </div>
                                    ))}
                                </div>
                            ) : (
                                <input type={field.type} name={field.name} value={item[field.name] || ''} onChange={(e) => handleInputChange(e, item, setItem)} className="input" required={field.required} />
                            )}
                        </div>
                    ))}
                    <div className="self-end mt-4 md:mt-0">
                        <button type="submit" className="w-full bg-blue-600 text-white px-4 py-2 rounded-lg shadow hover:bg-blue-700 transition-colors">
                            {isNew ? `Add ${title}` : 'Save Changes'}
                        </button>
                        {!isNew && <button type="button" onClick={() => setEditingItem(null)} className="w-full mt-2 bg-gray-200 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-300">Cancel</button>}
                    </div>
                </form>
            );

            return (
                <div className="bg-white p-4 sm:p-6 rounded-lg shadow-md">
                    <h2 className="text-2xl font-semibold mb-4">{title} Management</h2>
                    {renderForm(newItem, setNewItem, true)}
                    <div className="overflow-x-auto">
                        <table className="min-w-full divide-y divide-gray-200">
                             <thead className="bg-gray-50">
                                <tr>
                                    {listColumns.map(col => <th key={col.header} className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">{col.header}</th>)}
                                    <th className="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                </tr>
                            </thead>
                            <tbody className="bg-white divide-y divide-gray-200">
                                {items.map(item => (
                                    <tr key={item.id}>
                                        {editingItem?.id === item.id ? (
                                            <td colSpan={listColumns.length + 1} className="p-0">
                                                {renderForm(editingItem, setEditingItem)}
                                            </td>
                                        ) : (
                                            <>
                                                {listColumns.map(col => (
                                                    <td key={col.header} className="px-6 py-4 whitespace-nowrap text-sm text-gray-600">
                                                        {col.render ? col.render(item) : item[col.accessor]}
                                                    </td>
                                                ))}
                                                <td className="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                                                    <button onClick={() => setEditingItem({ ...item, shops: item.shops || [], pagePermissions: item.pagePermissions || [] })} className="text-indigo-600 hover:text-indigo-900 mr-4">Edit</button>
                                                    <button onClick={() => handleDelete(item.id)} className="text-red-600 hover:text-red-900">Delete</button>
                                                </td>
                                            </>
                                        )}
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                </div>
            );
        }

        function SettingsPage({ db, auth, shops, supervisors, positions }) {
            const [activeTab, setActiveTab] = useState('shops');
            
            const TabButton = ({ tabName, title }) => (
                <button
                    onClick={() => setActiveTab(tabName)}
                    className={`px-3 py-2 text-sm font-medium rounded-md transition-colors duration-200 flex-grow text-center sm:flex-grow-0 ${
                        activeTab === tabName ? 'bg-blue-600 text-white shadow-md' : 'bg-white text-gray-700 hover:bg-gray-200'
                    }`}
                >
                    {title}
                </button>
            );

            const shopFormFields = [
                { name: 'name', label: 'Shop Name', type: 'text', required: true },
                { name: 'contact', label: 'Contact', type: 'text', required: false },
                { name: 'address', label: 'Address', type: 'text', required: false }
            ];
            const shopListColumns = [
                { header: 'Shop Name', accessor: 'name' },
                { header: 'Contact', accessor: 'contact' },
                { header: 'Address', accessor: 'address' }
            ];

            const pagePermissionOptions = Object.values(PAGES).map(p => ({ id: p.id, name: p.title }));

            const supervisorFormFields = [
                { name: 'name', label: 'Supervisor Name', type: 'text', required: true },
                { name: 'email', label: 'Email', type: 'email', required: false },
                { name: 'uid', label: 'UID', type: 'text', required: false },
                { name: 'role', label: 'Role', type: 'select', options: [{id: 'Admin', name: 'Admin'}, {id: 'Shop Manager', name: 'Shop Manager'}, {id: 'Staff', name: 'Staff'}], placeholder: 'Select Role', required: true },
                { name: 'shops', label: 'Assigned Shops', type: 'checkbox-group', options: shops, required: false },
                { name: 'pagePermissions', label: 'Page Permissions', type: 'checkbox-group', options: pagePermissionOptions, required: true }
            ];
            const supervisorListColumns = [
                { header: 'Supervisor Name', accessor: 'name' },
                { header: 'Email', accessor: 'email' },
                { header: 'Role', accessor: 'role' },
                { 
                    header: 'Assigned Shops', 
                    render: (item) => 
                        item.shops && Array.isArray(item.shops) 
                        ? item.shops
                            .map(shopId => shops.find(s => s.id === shopId)?.name || 'N/A')
                            .join(', ') 
                        : 'N/A' 
                }
            ];

            const positionFormFields = [{ name: 'name', label: 'Position Name', type: 'text', required: true }];
            const positionListColumns = [{ header: 'Position Name', accessor: 'name' }];

            return (
                <div className="space-y-6">
                     <header>
                        <h1 className="text-3xl md:text-4xl font-bold text-gray-800">Settings</h1>
                        <p className="text-gray-500 mt-1">Manage your shop, supervisor, and position details.</p>
                    </header>
                    <div className="flex flex-wrap gap-2 bg-gray-200 p-1 rounded-lg">
                        <TabButton tabName="shops" title="Shop List" />
                        <TabButton tabName="supervisors" title="Supervisors" />
                        <TabButton tabName="positions" title="Positions" />
                    </div>
                    <div>
                        {activeTab === 'shops' && <SettingsCRUD db={db} auth={auth} title="Shop" collectionName="shops" items={shops} formFields={shopFormFields} listColumns={shopListColumns} />}
                        {activeTab === 'supervisors' && <SettingsCRUD db={db} auth={auth} title="Supervisor" collectionName="supervisors" items={supervisors} formFields={supervisorFormFields} listColumns={supervisorListColumns} />}
                        {activeTab === 'positions' && <SettingsCRUD db={db} auth={auth} title="Position" collectionName="positions" items={positions} formFields={positionFormFields} listColumns={positionListColumns} />}
                    </div>
                </div>
            )
        }
        
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
