<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>JLW-VAT</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" xintegrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- SheetJS library for Excel export -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
    <style>
        @import url('https://rsms.me/inter/inter.css');
        html, body { 
            font-family: 'Inter', sans-serif;
            overflow-x: hidden;
        }
        .input, .select {
            margin-top: 0.25rem; display: block; width: 100%; padding: 0.5rem 0.75rem;
            border-width: 1px; border-color: #475569; border-radius: 0.375rem;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); line-height: 1.5;
            background-color: #334155; color: #f1f5f9;
        }
        .input:focus, .select:focus {
            outline: 2px solid transparent; outline-offset: 2px;
            --tw-ring-color: #2563eb; border-color: #2563eb;
        }
        .input[disabled], .select[disabled] {
            background-color: #475569;
            cursor: not-allowed;
            opacity: 0.7;
        }
        .tab-btn { border-bottom: 2px solid transparent; }
        .tab-btn.active { border-color: #3b82f6; color: #3b82f6; }
         /* Disabled input style */
        .input:disabled, .input:read-only {
            background-color: #4b5563;
            cursor: not-allowed;
        }
    </style>
</head>
<body class="bg-slate-900 text-slate-300">
    <div id="root"></div>

    <script type="module">
        // Firebase SDK imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, doc, addDoc, updateDoc, deleteDoc, query, where, serverTimestamp, setDoc, getDocs, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Make Firebase SDK available globally
        window.firebaseSDK = {
            initializeApp, getAuth, getFirestore, collection, onSnapshot,
            doc, addDoc, updateDoc, deleteDoc, query, where, serverTimestamp,
            signInWithEmailAndPassword, onAuthStateChanged, signOut, setDoc, getDocs, orderBy
        };
    </script>
    
    <script type="text/babel">
        const { useState, useEffect, useMemo, useCallback } = React;

        // --- FIREBASE CONFIGURATION ---
        const firebaseConfig = {
            apiKey: "AIzaSyB6bREGjwLkU75VtN59EKHE_u6_urBuefY",
            authDomain: "auto-invoice-no.firebaseapp.com",
            projectId: "auto-invoice-no",
            storageBucket: "auto-invoice-no.firebasestorage.app",
            messagingSenderId: "117630876218",
            appId: "1:117630876218:web:f31804057aa209bb52d303",
            measurementId: "G-7BYJGBGGY4"
        };
        
        // --- CUSTOM HOOK FOR DATA FETCHING ---
        const useCollection = (db, collectionName, queryConstraints = []) => {
            const [data, setData] = useState([]);
            useEffect(() => {
                if (!db || !collectionName) return;
                const { collection, onSnapshot, query } = window.firebaseSDK;
                const q = query(collection(db, collectionName), ...queryConstraints);
                const unsubscribe = onSnapshot(q, (querySnapshot) => {
                    const items = [];
                    querySnapshot.forEach((doc) => {
                        items.push({ id: doc.id, ...doc.data() });
                    });
                    setData(items);
                }, (error) => {
                    console.error(`Error fetching collection ${collectionName}:`, error);
                });
                return () => unsubscribe();
            }, [db, collectionName, JSON.stringify(queryConstraints)]);
            return { data };
        };
        
        // --- UTILITY FUNCTIONS ---
        const formatRequestDate = (timestamp) => {
            if (!timestamp || !timestamp.toDate) return 'N/A';
            const date = timestamp.toDate();
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const year = date.getFullYear();
            return `${day}-${month}-${year}`;
        };

        // --- REUSABLE UI & PAGE COMPONENTS ---
        const Card = ({ children, className = '' }) => (
            <div className={`bg-slate-800/50 p-4 sm:p-6 rounded-lg shadow-lg border border-slate-700 ${className}`}>
                {children}
            </div>
        );

        const Modal = ({ isOpen, onClose, children, maxWidth = "max-w-2xl" }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 bg-black bg-opacity-70 z-50 flex justify-center items-start sm:items-center p-4 overflow-y-auto overflow-x-hidden">
                    <div className={`bg-slate-800 rounded-lg shadow-2xl w-full ${maxWidth} flex flex-col border border-slate-600 my-auto`}>
                        {children}
                    </div>
                </div>
            );
        };

        const ModalHeader = ({ title, onClose }) => (
            <div className="p-5 border-b border-slate-700 flex justify-between items-center flex-shrink-0">
                <h3 className="text-xl font-semibold text-slate-100">{title}</h3>
                <button onClick={onClose} className="text-slate-400 hover:text-white text-2xl p-1">&times;</button>
            </div>
        );

        const ModalBody = ({ children }) => (
            <div className="p-6 flex-grow overflow-y-auto max-h-[calc(90vh-140px)]">
                {children}
            </div>
        );

        const ModalFooter = ({ children }) => (
            <div className="p-4 bg-slate-900/50 border-t border-slate-700 flex justify-end gap-4 rounded-b-lg flex-shrink-0">
                {children}
            </div>
        );
        
        const ConfirmationModal = ({ isOpen, onClose, onConfirm, title, message }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 bg-black bg-opacity-70 z-50 flex justify-center items-center p-4">
                    <div className="bg-slate-800 rounded-lg shadow-2xl w-full max-w-sm border border-slate-600">
                        <div className="p-6">
                            <h3 className="text-lg font-bold text-slate-100">{title}</h3>
                            <p className="mt-2 text-sm text-slate-400">{message}</p>
                        </div>
                        <div className="p-4 bg-slate-900/50 border-t border-slate-700 flex justify-end gap-4 rounded-b-lg">
                            <button onClick={onClose} className="bg-slate-600 text-slate-200 px-4 py-2 rounded-lg hover:bg-slate-500">Cancel</button>
                            <button onClick={onConfirm} className="bg-red-600 text-white px-4 py-2 rounded-lg shadow hover:bg-red-700">Confirm</button>
                        </div>
                    </div>
                </div>
            );
        };
        
        const Toast = ({ message, type, show, onDismiss }) => {
            useEffect(() => {
                if(show) {
                    const timer = setTimeout(() => {
                        onDismiss();
                    }, 3000);
                    return () => clearTimeout(timer);
                }
            }, [show]);

            const bgColor = type === 'error' ? 'bg-red-600' : 'bg-green-600';

            return (
                <div className={`fixed top-5 right-5 ${bgColor} text-white py-2 px-4 rounded-lg shadow-lg transition-transform duration-300 z-50 ${show ? 'translate-x-0' : 'translate-x-full'}`}>
                    {message}
                </div>
            )
        }

        // --- LOGIN PAGE COMPONENT ---
        const LoginPage = ({ auth }) => {
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [error, setError] = useState('');
            const [loading, setLoading] = useState(false);
            const [showPassword, setShowPassword] = useState(false);

            const handleLogin = async (e) => {
                e.preventDefault();
                setLoading(true);
                setError('');
                try {
                    const { signInWithEmailAndPassword } = window.firebaseSDK;
                    await signInWithEmailAndPassword(auth, email, password);
                } catch (err) {
                    setError('Failed to login. Please check your credentials.');
                    console.error(err);
                }
                setLoading(false);
            };

            return (
                <div className="flex items-center justify-center min-h-screen bg-slate-900">
                    <div className="w-full max-w-md p-8 space-y-8 bg-slate-800 rounded-2xl shadow-lg border border-slate-700">
                        <div className="text-center">
                             <i className="fas fa-file-invoice text-5xl text-blue-500"></i>
                            <h2 className="mt-6 text-3xl font-bold text-white">Invoice System</h2>
                            <p className="mt-2 text-sm text-slate-400">Sign in to your account</p>
                        </div>
                        <form className="mt-8 space-y-6" onSubmit={handleLogin}>
                            <div className="rounded-md shadow-sm -space-y-px">
                                <div><input id="email-address" name="email" type="email" autoComplete="email" required className="appearance-none rounded-none relative block w-full px-3 py-3 border border-slate-600 bg-slate-700 text-white placeholder-slate-400 rounded-t-md focus:outline-none focus:ring-blue-500 focus:border-blue-500 focus:z-10 sm:text-sm" placeholder="Email address" value={email} onChange={(e) => setEmail(e.target.value)} /></div>
                                <div className="relative"><input id="password" name="password" type={showPassword ? "text" : "password"} autoComplete="current-password" required className="appearance-none rounded-none relative block w-full px-3 py-3 border border-slate-600 bg-slate-700 text-white placeholder-slate-400 rounded-b-md focus:outline-none focus:ring-blue-500 focus:border-blue-500 focus:z-10 sm:text-sm" placeholder="Password" value={password} onChange={(e) => setPassword(e.target.value)} /><button type="button" onClick={() => setShowPassword(!showPassword)} className="absolute inset-y-0 right-0 pr-3 flex items-center text-sm leading-5"><i className={`fas ${showPassword ? 'fa-eye-slash' : 'fa-eye'} text-slate-400 hover:text-slate-200`}></i></button></div>
                            </div>
                            {error && <p className="text-red-500 text-sm text-center">{error}</p>}
                            <div><button type="submit" disabled={loading} className="group relative w-full flex justify-center py-3 px-4 border border-transparent text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 focus:ring-offset-slate-800 disabled:bg-blue-800 disabled:cursor-not-allowed">{loading ? <i className="fas fa-spinner fa-spin"></i> : 'Sign in'}</button></div>
                        </form>
                    </div>
                </div>
            );
        };

        // --- INVOICE PAGE ---
        const GenerateInvoiceModal = ({isOpen, onClose, onSave, vendors, showToast}) => {
            const [searchQuery, setSearchQuery] = useState('');
            const [selectedVendor, setSelectedVendor] = useState(null);
            const [showResults, setShowResults] = useState(false);
            const [invoiceData, setInvoiceData] = useState({
                date: new Date().toISOString().split('T')[0],
                invoiceNumber: '',
                description: '',
                amount: ''
            });

            const handleInputChange = (e) => {
                const { id, value } = e.target;
                setInvoiceData(prev => ({...prev, [id]: value }));
            };

            const handleAmountChange = (e) => {
                let value = e.target.value.replace(/[^0-9.]/g, '');
                let parts = value.split('.');
                parts[0] = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, ',');
                if (parts.length > 1) {
                    parts[1] = parts[1].substring(0, 2);
                }
                setInvoiceData(prev => ({...prev, amount: parts.join('.') }));
            };

            const handleSearchChange = (e) => {
                setSearchQuery(e.target.value);
                setSelectedVendor(null);
                setInvoiceData(prev => ({...prev, description: '', invoiceNumber: ''}));
                if (e.target.value) {
                    setShowResults(true);
                } else {
                    setShowResults(false);
                }
            };
            
            const handleSelectVendor = (vendor) => {
                setSelectedVendor(vendor);
                setSearchQuery(vendor.id);
                setShowResults(false);
                setInvoiceData(prev => ({
                    ...prev, 
                    description: vendor.description || '',
                    invoiceNumber: generateInvoiceNumber(vendor.digits)
                }));
            };
            
            const generateInvoiceNumber = (digits = 8) => {
                let randomNumber = '';
                for (let i = 0; i < digits; i++) {
                    randomNumber += Math.floor(Math.random() * 10);
                }
                return randomNumber;
            };

            const handleSubmit = () => {
                if (!selectedVendor) { showToast("Please select a vendor.", "error"); return; }
                if (!invoiceData.invoiceNumber) { showToast("Invoice number cannot be empty.", "error"); return; }
                const amount = parseFloat(invoiceData.amount.replace(/,/g, ''));
                if (isNaN(amount) || amount <= 0) { showToast("Please enter a valid amount.", "error"); return; }
                
                onSave({
                    ...invoiceData,
                    vendor: selectedVendor.id,
                    amount: String(amount)
                });
            };

            const searchResults = useMemo(() => {
                if (!searchQuery) return [];
                return vendors.filter(v => v.id.toLowerCase().includes(searchQuery.toLowerCase()));
            }, [searchQuery, vendors]);

             return (
                <Modal isOpen={isOpen} onClose={onClose} maxWidth="max-w-xl">
                    <ModalHeader title="Create New Invoice" onClose={onClose} />
                    <ModalBody>
                        <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            <div className="sm:col-span-2 relative">
                                <label htmlFor="invoiceVendorSearch" className="block text-sm font-medium text-slate-300">Vendor</label>
                                <input type="text" id="invoiceVendorSearch" value={searchQuery} onChange={handleSearchChange} onFocus={() => setShowResults(true)} placeholder="Search and select a vendor..." className="input" />
                                {showResults && searchResults.length > 0 && (
                                    <div className="absolute z-20 w-full bg-slate-700 border border-slate-600 rounded-lg mt-1 shadow-lg max-h-40 overflow-y-auto">
                                        {searchResults.map(vendor => (
                                            <div key={vendor.id} onClick={() => handleSelectVendor(vendor)} className="p-3 hover:bg-slate-600 cursor-pointer text-white">
                                                {vendor.id}
                                            </div>
                                        ))}
                                    </div>
                                )}
                            </div>
                            <div>
                                <label htmlFor="date" className="block text-sm font-medium text-slate-300">Date</label>
                                <input type="date" id="date" value={invoiceData.date} onChange={handleInputChange} className="input"/>
                            </div>
                            <div>
                                <label htmlFor="invoiceNumber" className="block text-sm font-medium text-slate-300">Invoice No.</label>
                                <input type="text" id="invoiceNumber" value={invoiceData.invoiceNumber} onChange={handleInputChange} placeholder="Auto-generated or custom" className="input"/>
                            </div>
                            <div className="sm:col-span-2">
                                <label htmlFor="description" className="block text-sm font-medium text-slate-300">Description</label>
                                <input type="text" id="description" value={invoiceData.description} readOnly placeholder="Select a vendor to see description" className="input"/>
                            </div>
                            <div className="sm:col-span-2">
                                <label htmlFor="amount" className="block text-sm font-medium text-slate-300">Amount (KHR)</label>
                                <input type="text" id="amount" value={invoiceData.amount} onChange={handleAmountChange} placeholder="0.00" className="input"/>
                            </div>
                        </div>
                    </ModalBody>
                    <ModalFooter>
                         <button onClick={onClose} className="bg-slate-600 text-slate-200 px-4 py-2 rounded-lg hover:bg-slate-500">Cancel</button>
                         <button onClick={handleSubmit} className="bg-blue-600 text-white px-4 py-2 rounded-lg shadow hover:bg-blue-700">Save Invoice</button>
                    </ModalFooter>
                </Modal>
             );
        }

        const InvoicePage = ({ db, auth, showToast }) => {
            const userId = auth.currentUser.uid;
            const historyCollectionPath = `users/${userId}/history`;
            const vendorsCollectionPath = `users/${userId}/vendors`;
            
            const { data: fullHistory } = useCollection(db, historyCollectionPath, [window.firebaseSDK.orderBy('timestamp', 'desc')]);
            const { data: vendors } = useCollection(db, vendorsCollectionPath);
            
            const [isModalOpen, setIsModalOpen] = useState(false);
            const [filters, setFilters] = useState({ vendor: 'all', month: '' });
            
            const filteredHistory = useMemo(() => {
                return fullHistory.filter(item => {
                    const vendorMatch = filters.vendor === 'all' || item.vendor === filters.vendor;
                    const monthMatch = !filters.month || (item.date && item.date.startsWith(filters.month));
                    return vendorMatch && monthMatch;
                });
            }, [fullHistory, filters]);

            const subtotal = useMemo(() => {
                return filteredHistory.reduce((acc, item) => acc + (parseFloat(item.amount) || 0), 0);
            }, [filteredHistory]);

            const handleSaveInvoice = async (invoiceData) => {
                const { collection, addDoc, serverTimestamp, getDocs, query, where } = window.firebaseSDK;
                const historyRef = collection(db, historyCollectionPath);
                const q = query(historyRef, where("vendor", "==", invoiceData.vendor), where("invoiceNumber", "==", invoiceData.invoiceNumber));

                const querySnapshot = await getDocs(q);
                if (!querySnapshot.empty) {
                    showToast('This invoice number already exists for this vendor.', 'error');
                    return;
                }

                await addDoc(historyRef, { ...invoiceData, timestamp: serverTimestamp() });
                showToast('Invoice saved successfully!', 'success');
                setIsModalOpen(false);
            };

            const downloadExcel = () => {
                if (filteredHistory.length === 0) {
                    showToast('No data to export.', 'error');
                    return;
                }
                const headers = ['Date', 'Invoice No.', 'Vendor', 'Description', 'Amount (KHR)'];
                const dataForExcel = filteredHistory.map(item => [
                    formatRequestDate(item.timestamp),
                    item.invoiceNumber,
                    item.vendor,
                    item.description,
                    parseFloat(item.amount) || 0
                ]);
                dataForExcel.unshift(headers);
                const worksheet = XLSX.utils.aoa_to_sheet(dataForExcel);
                worksheet['!cols'] = [ { wch: 12 }, { wch: 20 }, { wch: 25 }, { wch: 40 }, { wch: 18 }];
                const workbook = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(workbook, worksheet, 'Invoice History');
                XLSX.writeFile(workbook, 'Invoice_History.xlsx');
            };

            const clearFilters = () => {
                setFilters({ vendor: 'all', month: '' });
            };
            
            return (
                 <div className="max-w-7xl mx-auto">
                    <Card>
                         <div className="flex flex-wrap justify-between items-center mb-6 gap-4">
                            <h2 className="text-2xl font-bold text-slate-100">Invoice Generation</h2>
                            <button onClick={() => setIsModalOpen(true)} className="bg-blue-600 text-white font-semibold px-5 py-2 rounded-lg shadow-sm hover:bg-blue-700 flex items-center gap-2">
                               <i className="fas fa-plus"></i> Create New Invoice
                            </button>
                         </div>

                        <div className="flex flex-wrap gap-4 items-center p-4 bg-slate-900/50 rounded-lg mb-4 border border-slate-700">
                             <div className="flex-grow">
                                 <label htmlFor="vendorFilter" className="block text-sm font-medium text-slate-300">Filter by Vendor</label>
                                 <select id="vendorFilter" value={filters.vendor} onChange={e => setFilters({...filters, vendor: e.target.value})} className="select">
                                     <option value="all">All Vendors</option>
                                     {vendors.map(v => <option key={v.id} value={v.id}>{v.id}</option>)}
                                 </select>
                             </div>
                             <div className="flex-grow">
                                 <label htmlFor="monthFilter" className="block text-sm font-medium text-slate-300">Filter by Month</label>
                                 <input type="month" id="monthFilter" value={filters.month} onChange={e => setFilters({...filters, month: e.target.value})} className="input" />
                             </div>
                             <div className="self-end flex gap-2 pt-2">
                                <button onClick={clearFilters} className="bg-slate-600 hover:bg-slate-500 text-slate-200 font-medium px-4 py-2 rounded-lg text-sm">Clear</button>
                                <button onClick={downloadExcel} className="bg-green-600 hover:bg-green-700 text-white font-medium px-4 py-2 rounded-lg text-sm flex items-center gap-2">
                                    <i className="fas fa-file-excel"></i> Download
                                </button>
                             </div>
                        </div>

                        <div className="overflow-x-auto bg-slate-900/50 rounded-lg border border-slate-700">
                            <table className="min-w-full divide-y divide-slate-700">
                                <thead className="bg-slate-800">
                                    <tr>
                                        <th scope="col" className="px-6 py-3 text-left text-xs font-medium text-slate-300 uppercase tracking-wider">Date</th>
                                        <th scope="col" className="px-6 py-3 text-left text-xs font-medium text-slate-300 uppercase tracking-wider">Invoice No.</th>
                                        <th scope="col" className="px-6 py-3 text-left text-xs font-medium text-slate-300 uppercase tracking-wider">Vendor</th>
                                        <th scope="col" className="px-6 py-3 text-left text-xs font-medium text-slate-300 uppercase tracking-wider">Description</th>
                                        <th scope="col" className="px-6 py-3 text-right text-xs font-medium text-slate-300 uppercase tracking-wider">Amount</th>
                                    </tr>
                                </thead>
                                <tbody className="bg-slate-800/50 divide-y divide-slate-700">
                                    {filteredHistory.length > 0 ? filteredHistory.map(item => (
                                        <tr key={item.id}>
                                            <td className="px-6 py-4 whitespace-nowrap text-sm text-slate-400">{formatRequestDate(item.timestamp)}</td>
                                            <td className="px-6 py-4 whitespace-nowrap text-sm font-medium text-white">{item.invoiceNumber}</td>
                                            <td className="px-6 py-4 whitespace-nowrap text-sm text-slate-300">{item.vendor}</td>
                                            <td className="px-6 py-4 whitespace-nowrap text-sm text-slate-400 truncate max-w-xs" title={item.description}>{item.description}</td>
                                            <td className="px-6 py-4 whitespace-nowrap text-sm text-slate-200 font-semibold text-right">{parseFloat(item.amount).toLocaleString('en-US', { style: 'currency', currency: 'KHR' })}</td>
                                        </tr>
                                    )) : (
                                        <tr>
                                            <td colSpan="5" className="text-center py-10 text-slate-400">No invoices match the current filters.</td>
                                        </tr>
                                    )}
                                </tbody>
                                <tfoot className="bg-slate-800">
                                    <tr>
                                        <td colSpan="4" className="px-6 py-3 text-right text-sm font-bold text-slate-200 uppercase">Subtotal</td>
                                        <td className="px-6 py-3 whitespace-nowrap text-sm text-white font-bold text-right">{subtotal.toLocaleString('en-US', { style: 'currency', currency: 'KHR' })}</td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                    </Card>
                    {isModalOpen && (
                        <GenerateInvoiceModal 
                            isOpen={isModalOpen}
                            onClose={() => setIsModalOpen(false)}
                            onSave={handleSaveInvoice}
                            vendors={vendors}
                            showToast={showToast}
                        />
                    )}
                 </div>
            );
        };
        
        // --- SETTINGS PAGE ---
        const SettingsPage = ({ db, auth, showToast }) => {
            const userId = auth.currentUser.uid;
            const vendorsCollectionPath = `users/${userId}/vendors`;
            const { data: vendors } = useCollection(db, vendorsCollectionPath);
            
            const [isAddModalOpen, setAddModalOpen] = useState(false);
            const [isEditModalOpen, setEditModalOpen] = useState(false);
            const [isDeleteModalOpen, setDeleteModalOpen] = useState(false);
            const [selectedVendor, setSelectedVendor] = useState(null);

            const handleAddVendor = async (name, description, digits) => {
                const { doc, setDoc } = window.firebaseSDK;
                const vendorName = name.trim();
                 if (!vendorName || isNaN(digits) || digits < 1 || digits > 16) {
                    showToast('Invalid vendor name or digit count.', 'error'); return;
                }
                if (vendors.some(v => v.id === vendorName)) {
                    showToast('This vendor already exists.', 'error'); return;
                }
                await setDoc(doc(db, vendorsCollectionPath, vendorName), { description, digits: Number(digits) });
                showToast('Vendor added successfully!', 'success');
                setAddModalOpen(false);
            };

            const handleUpdateVendor = async (name, description, digits) => {
                const { doc, updateDoc } = window.firebaseSDK;
                await updateDoc(doc(db, vendorsCollectionPath, name), { description, digits: Number(digits) });
                showToast('Vendor updated successfully!', 'success');
                setEditModalOpen(false);
                setSelectedVendor(null);
            };

            const handleDeleteVendor = async () => {
                const { doc, deleteDoc } = window.firebaseSDK;
                await deleteDoc(doc(db, vendorsCollectionPath, selectedVendor.id));
                showToast('Vendor deleted.', 'success');
                setDeleteModalOpen(false);
                setSelectedVendor(null);
            };

            return (
                <div className="max-w-7xl mx-auto">
                    <Card>
                        <div className="flex justify-between items-center mb-4">
                            <h2 className="text-xl font-semibold text-slate-200">Manage Vendors</h2>
                            <button onClick={() => setAddModalOpen(true)} className="bg-blue-600 text-white font-semibold px-5 py-2 rounded-lg shadow-sm hover:bg-blue-700">Add New Vendor</button>
                        </div>
                         <div className="overflow-x-auto bg-slate-900/50 rounded-lg border border-slate-700 mt-4">
                             <table className="min-w-full divide-y divide-slate-700">
                                <thead className="bg-slate-800">
                                    <tr>
                                        <th scope="col" className="px-6 py-3 text-left text-xs font-medium text-slate-300 uppercase tracking-wider">Name</th>
                                        <th scope="col" className="px-6 py-3 text-left text-xs font-medium text-slate-300 uppercase tracking-wider">Description</th>
                                        <th scope="col" className="px-6 py-3 text-left text-xs font-medium text-slate-300 uppercase tracking-wider">Digits</th>
                                        <th scope="col" className="px-6 py-3 text-left text-xs font-medium text-slate-300 uppercase tracking-wider">Actions</th>
                                    </tr>
                                </thead>
                                <tbody className="bg-slate-800/50 divide-y divide-slate-700">
                                {vendors.length > 0 ? vendors.map(vendor => (
                                    <tr key={vendor.id}>
                                        <td className="px-6 py-4 whitespace-nowrap text-sm font-medium text-white">{vendor.id}</td>
                                        <td className="px-6 py-4 whitespace-nowrap text-sm text-slate-300">{vendor.description}</td>
                                        <td className="px-6 py-4 whitespace-nowrap text-sm text-slate-300">{vendor.digits}</td>
                                        <td className="px-6 py-4 whitespace-nowrap text-sm font-medium space-x-4">
                                            <button onClick={() => { setSelectedVendor(vendor); setEditModalOpen(true); }} className="text-indigo-400 hover:text-indigo-300">Edit</button>
                                            <button onClick={() => { setSelectedVendor(vendor); setDeleteModalOpen(true); }} className="text-red-500 hover:text-red-400">Delete</button>
                                        </td>
                                    </tr>
                                )) : (
                                    <tr>
                                        <td colSpan="4" className="text-center py-10 text-slate-400">No vendors configured.</td>
                                    </tr>
                                )}
                                </tbody>
                            </table>
                        </div>
                    </Card>

                    {isAddModalOpen && <VendorModal isOpen={isAddModalOpen} onClose={() => setAddModalOpen(false)} onSave={handleAddVendor} title="Add New Vendor" />}
                    {isEditModalOpen && selectedVendor && <VendorModal isOpen={isEditModalOpen} onClose={() => setEditModalOpen(false)} onSave={handleUpdateVendor} vendor={selectedVendor} title="Edit Vendor" />}
                    {isDeleteModalOpen && selectedVendor && <ConfirmationModal isOpen={isDeleteModalOpen} onClose={() => setDeleteModalOpen(false)} onConfirm={handleDeleteVendor} title={`Delete ${selectedVendor.id}`} message="Are you sure you want to delete this vendor? This action cannot be undone." />}
                </div>
            );
        };
        
        const VendorModal = ({ isOpen, onClose, onSave, vendor, title }) => {
            const [name, setName] = useState(vendor?.id || '');
            const [description, setDescription] = useState(vendor?.description || '');
            const [digits, setDigits] = useState(vendor?.digits || 6);

            const handleSubmit = () => {
                onSave(name, description, digits);
            };

            return (
                <Modal isOpen={isOpen} onClose={onClose} maxWidth="max-w-md">
                    <ModalHeader title={title} onClose={onClose} />
                    <ModalBody>
                        <div className="space-y-4">
                            <div>
                                <label className="block text-sm font-medium text-slate-300">Vendor Name</label>
                                <input type="text" value={name} onChange={e => setName(e.target.value)} disabled={!!vendor} placeholder="e.g., Acme Corp" className="input" />
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-slate-300">Description</label>
                                <input type="text" value={description} onChange={e => setDescription(e.target.value)} placeholder="e.g., Main Supplier" className="input" />
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-slate-300">Invoice Digits</label>
                                <input type="number" value={digits} onChange={e => setDigits(e.target.value)} min="1" max="16" className="input" />
                            </div>
                        </div>
                    </ModalBody>
                    <ModalFooter>
                         <button onClick={onClose} className="bg-slate-600 text-slate-200 px-4 py-2 rounded-lg hover:bg-slate-500">Cancel</button>
                         <button onClick={handleSubmit} className="bg-blue-600 text-white px-4 py-2 rounded-lg shadow hover:bg-blue-700">Save</button>
                    </ModalFooter>
                </Modal>
            );
        };

        const Sidebar = ({ auth, userProfile, onNavigate, currentPage, sidebarOpen, setSidebarOpen }) => {
            const handleLogout = async () => {
                try { await window.firebaseSDK.signOut(auth); } 
                catch (error) { console.error("Error signing out: ", error); }
            };

            const isAdmin = userProfile?.role === 'Admin';
            
            const navigate = (page) => {
                onNavigate(page);
                setSidebarOpen(false);
            };

            const navigationContent = (
                <div className="flex flex-col h-full bg-slate-800 border-r border-slate-700">
                    <div className="flex items-center justify-center h-20 border-b border-slate-700 flex-shrink-0 px-4">
                         <i className="fas fa-file-invoice-dollar text-3xl text-blue-500 mr-3"></i>
                        <h1 className="text-2xl font-bold text-white">Invoice System</h1>
                    </div>
                    <nav className="flex-1 px-2 py-4 space-y-2">
                        {isAdmin && (
                            <a href="#" onClick={() => navigate('invoice')} className={`flex items-center px-4 py-3 text-lg font-medium rounded-md transition-colors ${currentPage === 'invoice' ? 'bg-blue-600 text-white' : 'text-slate-300 hover:bg-slate-700 hover:text-white'}`}>
                                <i className="fas fa-file-invoice-dollar w-6 mr-3"></i>
                                Invoice
                            </a>
                        )}
                        {isAdmin && (
                            <a href="#" onClick={() => navigate('settings')} className={`flex items-center px-4 py-3 text-lg font-medium rounded-md transition-colors ${currentPage === 'settings' ? 'bg-blue-600 text-white' : 'text-slate-300 hover:bg-slate-700 hover:text-white'}`}>
                                <i className="fas fa-cogs w-6 mr-3"></i>
                                Settings
                            </a>
                        )}
                    </nav>
                    <div className="p-4 border-t border-slate-700">
                        <div className="flex items-center">
                             <div className="w-10 h-10 rounded-full bg-slate-700 flex items-center justify-center mr-3">
                                <span className="font-bold text-blue-400">{userProfile.name.charAt(0)}</span>
                            </div>
                            <div>
                                <p className="font-semibold text-white">{userProfile.name}</p>
                                <p className="text-xs text-slate-400">{userProfile.role}</p>
                            </div>
                            <button onClick={handleLogout} title="Logout" className="ml-auto bg-slate-700 text-slate-300 w-10 h-10 rounded-full hover:bg-red-600 hover:text-white transition-colors flex items-center justify-center flex-shrink-0">
                                <i className="fas fa-sign-out-alt"></i>
                            </button>
                        </div>
                    </div>
                </div>
            );

            return (
                <>
                    <div className={`fixed inset-0 bg-black bg-opacity-50 z-30 md:hidden transition-opacity ${sidebarOpen ? 'opacity-100' : 'opacity-0 pointer-events-none'}`} onClick={() => setSidebarOpen(false)}></div>
                    <div className={`fixed inset-y-0 left-0 w-64 transform ${sidebarOpen ? 'translate-x-0' : '-translate-x-full'} transition-transform duration-300 ease-in-out z-40 md:hidden`}>
                        {navigationContent}
                    </div>
                    <div className="hidden md:flex md:w-64 md:flex-col md:fixed md:inset-y-0">
                        {navigationContent}
                    </div>
                </>
            );
        };


        // --- ROOT APP COMPONENT ---
        function App() {
            const [db, setDb] = useState(null);
            const [auth, setAuth] = useState(null);
            const [currentUser, setCurrentUser] = useState(null);
            const [userProfile, setUserProfile] = useState(null);
            const [loading, setLoading] = useState(true);
            const [currentPage, setCurrentPage] = useState('invoice');
            const [sidebarOpen, setSidebarOpen] = useState(false);
            const [toast, setToast] = useState({ show: false, message: '', type: 'success' });
            
            const showToast = (message, type = 'success') => {
                setToast({ show: true, message, type });
            };

            useEffect(() => {
                try {
                    const { initializeApp, getFirestore, getAuth, onAuthStateChanged } = window.firebaseSDK;
                    const app = initializeApp(firebaseConfig);
                    const authInstance = getAuth(app);
                    const dbInstance = getFirestore(app);
                    setAuth(authInstance);
                    setDb(dbInstance);

                    const unsubscribe = onAuthStateChanged(authInstance, (user) => {
                        setCurrentUser(user);
                        if (!user) {
                             setUserProfile(null);
                            setLoading(false);
                        }
                    });
                    return () => unsubscribe();
                } catch (error) { 
                    console.error("Firebase initialization error:", error); 
                    setLoading(false);
                } 
            }, []);

            useEffect(() => {
                if (!db || !currentUser) {
                    setUserProfile(null);
                    return;
                };

                const { collection, query, where, onSnapshot } = window.firebaseSDK;
                const q = query(collection(db, "employees"), where("uid", "==", currentUser.uid));
                
                const unsubscribe = onSnapshot(q, (snapshot) => {
                    if (!snapshot.empty) {
                        const userDoc = snapshot.docs[0];
                        const profile = { id: userDoc.id, ...userDoc.data() };
                        setUserProfile(profile);
                    } else {
                        setUserProfile({ name: currentUser.email, role: 'Staff' });
                    }
                    setLoading(false);
                }, (error) => {
                    console.error("Error fetching user profile:", error);
                    setLoading(false);
                });

                return () => unsubscribe();
            }, [db, currentUser]);
            
            const handleNavigation = (page) => {
                if ((page === 'invoice' || page === 'settings') && userProfile?.role !== 'Admin') return;
                setCurrentPage(page);
            };

            if (loading) { return <div className="flex items-center justify-center h-screen text-lg text-slate-300">Loading Application...</div>; }
            if (!currentUser || !userProfile) { return <LoginPage auth={auth} />; }

            return (
                 <div className="relative min-h-screen">
                    <Toast {...toast} onDismiss={() => setToast({ ...toast, show: false })}/>
                    <Sidebar 
                        auth={auth} 
                        userProfile={userProfile} 
                        onNavigate={handleNavigation} 
                        currentPage={currentPage}
                        sidebarOpen={sidebarOpen}
                        setSidebarOpen={setSidebarOpen}
                    />
                    <div className="md:pl-64 flex flex-col flex-1">
                         <div className="sticky top-0 z-10 md:hidden p-2 bg-slate-800 border-b border-slate-700 flex items-center justify-between">
                             <button onClick={() => setSidebarOpen(true)} className="text-slate-300 hover:text-white text-xl p-2">
                                 <i className="fas fa-bars"></i>
                             </button>
                            <h2 className="text-xl font-bold text-white">
                                {currentPage.charAt(0).toUpperCase() + currentPage.slice(1)}
                            </h2>
                            <div className="w-10"></div>
                        </div>
                        <main className="flex-1 p-4 sm:p-6">
                            {currentPage === 'invoice' && userProfile.role === 'Admin' && <InvoicePage db={db} auth={auth} showToast={showToast} />}
                            {currentPage === 'settings' && userProfile.role === 'Admin' && <SettingsPage db={db} auth={auth} showToast={showToast} />}
                            {userProfile.role !== 'Admin' && (
                                <div className="text-center mt-10">
                                    <h2 className="text-2xl font-bold text-white">Access Denied</h2>
                                    <p className="text-slate-400 mt-2">You do not have permission to view any pages.</p>
                                </div>
                            )}
                        </main>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>

