<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CheckInMe - Attendance App</title>
    
    <!-- PWA Manifest Link -->
    <link rel="manifest" href="./manifest.json">
    <meta name="theme-color" content="#0f172a">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-title" content="CheckInMe">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="https://i.imgur.com/EvYU0AK.jpeg">

    <!-- External Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                }
            }
        }
    </script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    
    <!-- Optimization: React & Babel -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js" crossorigin="anonymous"></script>

    <!-- Scanner & Location Utils -->
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript" defer></script>

    <!-- Custom Styles -->
    <style>
        @import url('https://rsms.me/inter/inter.css');
        html, body { 
            font-family: 'Inter', sans-serif;
            overflow-x: hidden; 
            background-color: #0f172a;
            margin: 0; padding: 0;
            -webkit-tap-highlight-color: transparent;
        }

        /* Splash Screen */
        #splash-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: #0f172a; z-index: 9999;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            transition: opacity 0.5s ease-out, visibility 0.5s;
        }
        .splash-loader {
            width: 48px; height: 48px;
            border: 5px solid #3b82f6; border-bottom-color: transparent;
            border-radius: 50%; display: inline-block;
            box-sizing: border-box; animation: rotation 1s linear infinite;
            margin-bottom: 20px;
        }
        @keyframes rotation { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* UI Elements */
        .input, .select {
            margin-top: 0.25rem; display: block; width: 100%; padding: 0.75rem;
            border: 1px solid #475569; border-radius: 0.75rem;
            background-color: #1e293b; color: #f1f5f9; outline: none;
            transition: border-color 0.2s;
        }
        .input:focus, .select:focus { border-color: #3b82f6; ring: 2px solid #3b82f6; }
        .input[disabled] { opacity: 0.6; cursor: not-allowed; }
        
        .scanner-box { border-radius: 1rem; overflow: hidden; border: 2px solid #334155; background: #000; min-height: 300px; width: 100%; }
        
        /* Animations */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fadeIn 0.6s ease-out forwards; }
    </style>
</head>
<body class="bg-slate-900 text-slate-300">

    <div id="splash-screen">
        <span class="splash-loader"></span>
        <h2 style="color: white; font-weight: 600;">CheckInMe</h2>
        <p style="color: #64748b; font-size: 0.85rem; margin-top: 5px;">Standalone Attendance</p>
    </div>

    <div id="root"></div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, doc, getDoc, addDoc, updateDoc, query, where, serverTimestamp, getDocs, enableIndexedDbPersistence, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        window.firebaseSDK = {
            initializeApp, getAuth, getFirestore, collection, onSnapshot, doc, getDoc, addDoc, updateDoc, 
            query, where, serverTimestamp, getDocs, enableIndexedDbPersistence, setDoc, signInWithEmailAndPassword, signOut, onAuthStateChanged
        };
    </script>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useCallback, createContext, useContext, memo, useRef } = React;

        // === CONFIGURATION ===
        const firebaseConfig = {
            apiKey: "AIzaSyB7_pnmwHj6aOeZRTykPvNusNFYReaTY6Q",
            authDomain: "hrsm-j.firebaseapp.com",
            projectId: "hrsm-j",
            storageBucket: "hrsm-j.appspot.com",
            messagingSenderId: "45063715478",
            appId: "1:45063715478:web:cc2dd21b83dd195771e0b7",
            measurementId: "G-8HQDG2LTKP"
        };

        // --- UTILS ---
        const Utils = {
            formatCurrency: (val) => new Intl.NumberFormat('km-KH', { style: 'currency', currency: 'KHR', minimumFractionDigits: 0 }).format(parseFloat(val) || 0).replace('KHR', '៛'),
            formatDateInTimezone: (timestamp, timezone) => {
                if (!timestamp || !timestamp.toDate) return { localDate: 'N/A', localTime: 'N/A' };
                const date = timestamp.toDate();
                const tz = timezone || Intl.DateTimeFormat().resolvedOptions().timeZone;
                const localDate = date.toLocaleDateString('sv-SE', { timeZone: tz }); // YYYY-MM-DD
                const localTime = date.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: true, timeZone: tz });
                return { localDate, localTime };
            },
            getDistance: (lat1, lon1, lat2, lon2) => {
                const R = 6371e3; 
                const φ1 = lat1 * Math.PI/180, φ2 = lat2 * Math.PI/180, Δφ = (lat2-lat1) * Math.PI/180, Δλ = (lon2-lon1) * Math.PI/180;
                const a = Math.sin(Δφ/2) * Math.sin(Δφ/2) + Math.cos(φ1) * Math.cos(φ2) * Math.sin(Δλ/2) * Math.sin(Δλ/2);
                return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            },
            formatISOToDisplay: (isoDate) => {
                if (!isoDate || typeof isoDate !== 'string' || !isoDate.includes('-')) return isoDate || '';
                const [year, month, day] = isoDate.split('-');
                return `${day}-${month}-${year}`;
            },
            LIBS: { HTML5QR: "https://unpkg.com/html5-qrcode" },
            loadScript: (src) => new Promise((res) => { const s = document.createElement('script'); s.src = src; s.onload = res; document.head.appendChild(s); })
        };

        // --- CONTEXTS ---
        const FirebaseContext = createContext(null);
        const useFirebase = () => useContext(FirebaseContext);
        
        const FirebaseProvider = ({ children }) => {
            const [db, setDb] = useState(null);
            const [auth, setAuth] = useState(null);
            const [currentUser, setCurrentUser] = useState(null); // Added state to track auth user
            const [userProfile, setUserProfile] = useState(() => {
                try { return JSON.parse(localStorage.getItem('hr_user_profile')); } catch { return null; }
            });
            const [loading, setLoading] = useState(!userProfile);

            useEffect(() => {
                const init = async () => {
                    let attempts = 0;
                    while (!window.firebaseSDK && attempts < 20) await new Promise(r => setTimeout(r, 100));
                    if (!window.firebaseSDK) return;

                    const { initializeApp, getFirestore, getAuth, onAuthStateChanged, enableIndexedDbPersistence } = window.firebaseSDK;
                    const app = initializeApp(firebaseConfig);
                    const dbInstance = getFirestore(app);
                    enableIndexedDbPersistence(dbInstance).catch(() => {});
                    const authInstance = getAuth(app);
                    
                    setDb(dbInstance);
                    setAuth(authInstance);

                    onAuthStateChanged(authInstance, (user) => {
                        setCurrentUser(user); // Set current user state
                        if (!user) {
                            setUserProfile(null);
                            localStorage.removeItem('hr_user_profile');
                            setLoading(false);
                        } else if (!userProfile) {
                            setLoading(true); // Fetch profile
                        }
                    });
                };
                init();
            }, []);

            useEffect(() => {
                if (!db || !currentUser) return; // Depend on currentUser state
                const { collection, query, where, onSnapshot } = window.firebaseSDK;
                const q = query(collection(db, "employees"), where("uid", "==", currentUser.uid));
                return onSnapshot(q, (snap) => {
                    if (!snap.empty) {
                        const data = { id: snap.docs[0].id, ...snap.docs[0].data() };
                        if (JSON.stringify(data) !== JSON.stringify(userProfile)) {
                            setUserProfile(data);
                            localStorage.setItem('hr_user_profile', JSON.stringify(data));
                        }
                    } else if (userProfile) { setUserProfile(null); }
                    setLoading(false);
                });
            }, [db, currentUser]); // Updated dependency

            return <FirebaseContext.Provider value={{ db, auth, currentUser, userProfile, loading }}>{children}</FirebaseContext.Provider>;
        };

        const AppDataContext = createContext(null);
        const useAppData = () => useContext(AppDataContext);
        const AppDataProvider = ({ children }) => {
            const { db, currentUser } = useFirebase(); // Use currentUser instead of userProfile
            const [shops, setShops] = useState([]);
            const [shifts, setShifts] = useState([]);

            useEffect(() => {
                if (!db || !currentUser) return; // Wait for auth before fetching data
                const { collection, getDocs } = window.firebaseSDK;
                // Fetch Shops (Static)
                getDocs(collection(db, 'shops'))
                    .then(snap => setShops(snap.docs.map(d => d.data())))
                    .catch(err => console.error("Error fetching shops:", err));
                // Fetch Shifts (Static)
                getDocs(collection(db, 'shifts'))
                    .then(snap => setShifts(snap.docs.map(d => d.data())))
                    .catch(err => console.error("Error fetching shifts:", err));
            }, [db, currentUser]);

            return <AppDataContext.Provider value={{ shops, shifts }}>{children}</AppDataContext.Provider>;
        };

        // --- COMPONENTS ---
        const Modal = ({ isOpen, children, title, onClose }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/80 backdrop-blur-sm animate-fade-in">
                    <div className="bg-slate-800 rounded-2xl w-full max-w-md border border-slate-700 shadow-2xl overflow-hidden flex flex-col max-h-[90vh]">
                        <div className="p-4 border-b border-slate-700 flex justify-between items-center bg-slate-800">
                            <h3 className="text-lg font-bold text-white">{title}</h3>
                            <button onClick={onClose} className="text-slate-400 hover:text-white text-xl">&times;</button>
                        </div>
                        <div className="p-4 overflow-y-auto">{children}</div>
                    </div>
                </div>
            );
        };

        // NEW: Leave Request Modal
        const LeaveRequestModal = ({ isOpen, onClose, userProfile }) => {
            const { db } = useFirebase();
            const [formData, setFormData] = useState({
                leaveType: 'Relaxing Leave', // Updated default
                leaveDate: '',
                returnDate: '',
                session: 'Full Day', // Added session state
                reason: ''
            });
            const [isSubmitting, setIsSubmitting] = useState(false);

            const calculateDays = () => {
                // If session is AM or PM, it's always 0.5 days
                if (formData.session !== 'Full Day') return 0.5;

                if (!formData.leaveDate || !formData.returnDate) return 0;
                const start = new Date(formData.leaveDate);
                const end = new Date(formData.returnDate);
                
                // FIX: If return date is same or before start date, 0 days (for Full Day)
                if (end <= start) return 0;
                
                const diffTime = Math.abs(end - start);
                // FIX: Removed "+ 1" to make Return Date exclusive (Day back to work)
                return Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 
            };

            const handleSubmit = async (e) => {
                e.preventDefault();
                setIsSubmitting(true);
                try {
                    const { addDoc, collection, serverTimestamp } = window.firebaseSDK;
                    await addDoc(collection(db, 'leaveRequests'), {
                        staffId: userProfile.id,
                        staffName: userProfile.name,
                        shop: userProfile.shop,
                        leaveType: formData.leaveType,
                        leaveDate: formData.leaveDate,
                        // If AM/PM, force return date to equal start date
                        returnDate: formData.session !== 'Full Day' ? formData.leaveDate : formData.returnDate,
                        session: formData.session,
                        numberOfDays: calculateDays(),
                        reason: formData.reason,
                        status: 'Pending',
                        requestDate: serverTimestamp()
                    });
                    onClose();
                    setFormData({ leaveType: 'Relaxing Leave', leaveDate: '', returnDate: '', session: 'Full Day', reason: '' });
                    alert("Leave request submitted!");
                } catch (error) {
                    alert("Error: " + error.message);
                }
                setIsSubmitting(false);
            };

            const handleSessionChange = (e) => {
                const newSession = e.target.value;
                setFormData(prev => ({
                    ...prev,
                    session: newSession,
                    // If switching to half-day, sync return date to start date automatically
                    returnDate: newSession !== 'Full Day' ? prev.leaveDate : prev.returnDate
                }));
            };

            const handleStartDateChange = (e) => {
                const newDate = e.target.value;
                setFormData(prev => ({
                    ...prev,
                    leaveDate: newDate,
                    // If half-day mode is active, keep return date synced
                    returnDate: prev.session !== 'Full Day' ? newDate : prev.returnDate
                }));
            };

            return (
                <Modal isOpen={isOpen} title="Request Leave" onClose={onClose}>
                    <form onSubmit={handleSubmit} className="space-y-4">
                        <div>
                            <label className="text-sm text-slate-400 block mb-1">Leave Type</label>
                            <select className="select" value={formData.leaveType} onChange={e => setFormData({...formData, leaveType: e.target.value})}>
                                <option>Relaxing Leave</option>
                                <option>Sick Leave</option>
                                <option>Emergency Leave</option>
                            </select>
                        </div>

                        <div>
                            <label className="text-sm text-slate-400 block mb-1">Session</label>
                            <select className="select" value={formData.session} onChange={handleSessionChange}>
                                <option value="Full Day">Full Day</option>
                                <option value="AM">AM (Morning)</option>
                                <option value="PM">PM (Afternoon)</option>
                            </select>
                        </div>

                        <div className="grid grid-cols-2 gap-3">
                            <div>
                                <label className="text-sm text-slate-400 block mb-1">Leave Date</label>
                                <input type="date" className="input" required value={formData.leaveDate} onChange={handleStartDateChange} />
                            </div>
                            <div>
                                <label className="text-sm text-slate-400 block mb-1">Return Date</label>
                                <input 
                                    type="date" 
                                    className="input" 
                                    required 
                                    value={formData.returnDate} 
                                    onChange={e => setFormData({...formData, returnDate: e.target.value})} 
                                    disabled={formData.session !== 'Full Day'}
                                />
                            </div>
                        </div>
                        <div className="text-right text-xs text-blue-400 font-bold">
                            Total: {calculateDays()} Day(s)
                        </div>
                        <div>
                            <label className="text-sm text-slate-400 block mb-1">Reason</label>
                            <textarea className="input" rows="3" required value={formData.reason} onChange={e => setFormData({...formData, reason: e.target.value})} placeholder="Why do you need leave?"></textarea>
                        </div>
                        <button className="w-full py-3 bg-blue-600 hover:bg-blue-500 text-white font-bold rounded-xl shadow-lg disabled:opacity-50" disabled={isSubmitting || calculateDays() <= 0}>
                            {isSubmitting ? 'Submitting...' : 'Submit Request'}
                        </button>
                    </form>
                </Modal>
            );
        };

        // NEW: OT Request Modal (Revised logic)
        const OTRequestModal = ({ isOpen, onClose, userProfile }) => {
            const { db } = useFirebase();
            
            // FIX: Helper to get local date string YYYY-MM-DD
            const getToday = () => {
                const now = new Date();
                const year = now.getFullYear();
                const month = String(now.getMonth() + 1).padStart(2, '0');
                const day = String(now.getDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            };

            const [formData, setFormData] = useState({
                reqDate: getToday(),
                session: 'Full Day',
                reason: ''
            });
            const [isSubmitting, setIsSubmitting] = useState(false);

            // Logic: Full Day = 1, AM/PM = 0.5
            const otDays = formData.session === 'Full Day' ? 1 : 0.5;

            const handleSubmit = async (e) => {
                e.preventDefault();
                setIsSubmitting(true);
                try {
                    const { addDoc, collection, serverTimestamp } = window.firebaseSDK;
                    await addDoc(collection(db, 'otRequests'), {
                        staffId: userProfile.id,
                        staffName: userProfile.name,
                        shop: userProfile.shop,
                        reqDate: formData.reqDate,
                        session: formData.session,
                        numberOfOTDays: otDays,
                        reason: formData.reason,
                        status: 'Pending',
                        submissionDate: serverTimestamp()
                    });
                    onClose();
                    setFormData({ reqDate: getToday(), session: 'Full Day', reason: '' });
                    alert("OT request submitted!");
                } catch (error) {
                    alert("Error: " + error.message);
                }
                setIsSubmitting(false);
            };

            return (
                <Modal isOpen={isOpen} title="Request Overtime" onClose={onClose}>
                    <form onSubmit={handleSubmit} className="space-y-4">
                        <div>
                            <label className="text-sm text-slate-400 block mb-1">OT Date</label>
                            <input type="date" className="input" required value={formData.reqDate} onChange={e => setFormData({...formData, reqDate: e.target.value})} />
                        </div>
                        <div>
                            <label className="text-sm text-slate-400 block mb-1">Session</label>
                            <select className="select" value={formData.session} onChange={e => setFormData({...formData, session: e.target.value})}>
                                <option value="Full Day">Full Day (1 Day)</option>
                                <option value="AM">AM (0.5 Day)</option>
                                <option value="PM">PM (0.5 Day)</option>
                            </select>
                        </div>
                        <div className="text-right text-xs text-blue-400 font-bold">
                            Count: {otDays} Day(s)
                        </div>
                        <div>
                            <label className="text-sm text-slate-400 block mb-1">Reason</label>
                            <textarea className="input" rows="3" required value={formData.reason} onChange={e => setFormData({...formData, reason: e.target.value})} placeholder="Reason for overtime..."></textarea>
                        </div>
                        <button className="w-full py-3 bg-blue-600 hover:bg-blue-500 text-white font-bold rounded-xl shadow-lg disabled:opacity-50" disabled={isSubmitting || !formData.reqDate}>
                            {isSubmitting ? 'Submitting...' : 'Submit Request'}
                        </button>
                    </form>
                </Modal>
            );
        };

        // NEW: Profile View Component
        const ProfileView = ({ userProfile }) => {
            const { auth } = useFirebase();
            const [showSalary, setShowSalary] = useState(false);

            if (!userProfile) return null;

            return (
                <div className="space-y-6 animate-fade-in pb-20">
                    {/* Header Card */}
                    <div className="bg-gradient-to-br from-slate-800 to-slate-900 p-6 rounded-2xl border border-slate-700 shadow-lg text-center relative overflow-hidden">
                        <div className="absolute top-0 left-0 w-full h-1 bg-blue-600"></div>
                        <div className="w-24 h-24 bg-slate-700 rounded-full mx-auto flex items-center justify-center text-4xl font-bold text-white shadow-xl border-4 border-slate-800 mb-4 overflow-hidden relative">
                            {userProfile.photo ? (
                                <img src={userProfile.photo} alt="Profile" className="w-full h-full object-cover" />
                            ) : (
                                <span>{userProfile.name.charAt(0)}</span>
                            )}
                        </div>
                        <h2 className="text-2xl font-bold text-white">{userProfile.name}</h2>
                        <p className="text-blue-400 font-medium">{userProfile.position}</p>
                        <div className="mt-4 inline-flex items-center px-3 py-1 rounded-full bg-slate-700/50 border border-slate-600 text-xs text-slate-300">
                            <i className="fas fa-id-badge mr-2 text-slate-400"></i> {userProfile.role}
                        </div>
                    </div>

                    {/* Info Grid */}
                    <div className="grid grid-cols-1 gap-4">
                        {/* Work Info */}
                        <div className="bg-slate-800 p-4 rounded-xl border border-slate-700">
                            <h3 className="text-xs font-bold text-slate-500 uppercase tracking-wider mb-3">Work Details</h3>
                            <div className="space-y-3">
                                <div className="flex justify-between">
                                    <span className="text-slate-400">Shop Location</span>
                                    <span className="text-slate-200 font-medium">{userProfile.shop}</span>
                                </div>
                                <div className="flex justify-between">
                                    <span className="text-slate-400">Shift</span>
                                    <span className="text-slate-200 font-medium">{userProfile.shift || 'N/A'}</span>
                                </div>
                                <div className="flex justify-between">
                                    <span className="text-slate-400">Joined Date</span>
                                    <span className="text-slate-200 font-medium">{userProfile.joinedDate}</span>
                                </div>
                                <div className="flex justify-between">
                                    <span className="text-slate-400">Supervisor</span>
                                    <span className="text-slate-200 font-medium">{userProfile.supervisor || 'N/A'}</span>
                                </div>
                            </div>
                        </div>

                        {/* Personal Info */}
                        <div className="bg-slate-800 p-4 rounded-xl border border-slate-700">
                            <h3 className="text-xs font-bold text-slate-500 uppercase tracking-wider mb-3">Personal Info</h3>
                            <div className="space-y-3">
                                <div className="flex justify-between items-center">
                                    <span className="text-slate-400"><i className="fas fa-phone mr-2 text-slate-500 w-4"></i>Phone</span>
                                    <span className="text-slate-200 text-sm">{userProfile.tel}</span>
                                </div>
                                <div className="flex justify-between items-center">
                                    <span className="text-slate-400"><i className="fas fa-envelope mr-2 text-slate-500 w-4"></i>Email</span>
                                    <span className="text-slate-200 text-sm truncate max-w-[180px]">{userProfile.email}</span>
                                </div>
                                <div className="flex justify-between items-center">
                                    <span className="text-slate-400"><i className="fas fa-birthday-cake mr-2 text-slate-500 w-4"></i>DOB</span>
                                    <span className="text-slate-200 text-sm">{userProfile.dob}</span>
                                </div>
                            </div>
                        </div>

                        {/* Salary (Collapsible) */}
                        <div className="bg-slate-800 p-4 rounded-xl border border-slate-700">
                            <div className="flex justify-between items-center cursor-pointer" onClick={() => setShowSalary(!showSalary)}>
                                <h3 className="text-xs font-bold text-slate-500 uppercase tracking-wider">Base Salary</h3>
                                <button className="text-slate-400 hover:text-white">
                                    <i className={`fas ${showSalary ? 'fa-eye-slash' : 'fa-eye'}`}></i>
                                </button>
                            </div>
                            {showSalary ? (
                                <div className="mt-3 text-2xl font-bold text-green-400 tracking-tight">
                                    {Utils.formatCurrency(userProfile.salary)}
                                </div>
                            ) : (
                                <div className="mt-3 text-xl font-bold text-slate-600 tracking-widest">••••••</div>
                            )}
                        </div>
                    </div>

                    {/* Logout Button */}
                    <button 
                        onClick={() => window.firebaseSDK.signOut(auth)} 
                        className="w-full py-4 rounded-xl bg-red-600/10 text-red-500 border border-red-600/20 font-bold hover:bg-red-600 hover:text-white transition-all flex items-center justify-center gap-2"
                    >
                        <i className="fas fa-sign-out-alt"></i> Sign Out
                    </button>
                    
                    <div className="text-center text-xs text-slate-600 pt-4">
                        CheckInMe v2.0 Standalone
                    </div>
                </div>
            );
        };

        // NEW: Requests List View
        const RequestsView = ({ userProfile }) => {
            const { db } = useFirebase();
            const [activeType, setActiveType] = useState('leave'); // 'leave' or 'ot'
            const [requests, setRequests] = useState([]);
            const [isLeaveModalOpen, setLeaveModalOpen] = useState(false);
            const [isOTModalOpen, setOTModalOpen] = useState(false);

            useEffect(() => {
                if (!db || !userProfile) return;
                
                // MODIFIED: Hide Leave History, only show OT history
                if (activeType === 'leave') {
                    setRequests([]);
                    return;
                }

                const { collection, query, where, onSnapshot } = window.firebaseSDK;
                const colName = 'otRequests'; // Only fetch OT requests
                
                const q = query(collection(db, colName), where('staffId', '==', userProfile.id));
                const unsub = onSnapshot(q, (snap) => {
                    const data = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                    // Client-side sort to avoid index requirements for standalone app
                    data.sort((a, b) => {
                        const da = a.requestDate?.seconds || a.submissionDate?.seconds || 0;
                        const db = b.requestDate?.seconds || b.submissionDate?.seconds || 0;
                        return db - da; // Descending
                    });
                    setRequests(data);
                });
                return () => unsub();
            }, [db, userProfile, activeType]);

            return (
                <div className="h-full flex flex-col relative">
                    {/* Toggle */}
                    <div className="flex p-1 bg-slate-800 rounded-xl mb-4 border border-slate-700 shrink-0">
                        <button onClick={() => setActiveType('leave')} className={`flex-1 py-2 rounded-lg text-sm font-bold transition-all ${activeType === 'leave' ? 'bg-blue-600 text-white shadow' : 'text-slate-400'}`}>Leave</button>
                        <button onClick={() => setActiveType('ot')} className={`flex-1 py-2 rounded-lg text-sm font-bold transition-all ${activeType === 'ot' ? 'bg-blue-600 text-white shadow' : 'text-slate-400'}`}>Overtime</button>
                    </div>

                    {/* List */}
                    <div className="flex-1 overflow-y-auto space-y-3 pb-20 custom-scrollbar">
                        {activeType === 'leave' ? (
                            <div className="flex flex-col items-center justify-center h-64 text-slate-500">
                                <div className="w-16 h-16 bg-slate-800 rounded-2xl flex items-center justify-center mb-4 shadow-sm border border-slate-700">
                                    <i className="fas fa-calendar-plus text-3xl text-blue-500"></i>
                                </div>
                                <p className="text-slate-400 font-medium">Submit New Leave Request</p>
                                <p className="text-xs mt-2 opacity-50">Tap the + button below</p>
                            </div>
                        ) : (
                            <>
                                {requests.length === 0 && (
                                    <div className="text-center text-slate-500 mt-10 flex flex-col items-center">
                                        <i className="fas fa-clipboard-list text-4xl mb-3 opacity-30"></i>
                                        <p>No OT requests found.</p>
                                    </div>
                                )}
                                {requests.map(req => (
                                    <div key={req.id} className="bg-slate-800 p-4 rounded-xl border border-slate-700 shadow-sm">
                                        <div className="flex justify-between items-start mb-2">
                                            <span className={`px-2 py-1 rounded text-xs font-bold ${req.status === 'Approved' ? 'bg-green-500/20 text-green-400' : req.status === 'Rejected' ? 'bg-red-500/20 text-red-400' : 'bg-yellow-500/20 text-yellow-400'}`}>
                                                {req.status}
                                            </span>
                                            <span className="text-xs text-slate-500">
                                                {new Date((req.requestDate?.seconds || req.submissionDate?.seconds) * 1000).toLocaleDateString()}
                                            </span>
                                        </div>
                                        <h4 className="font-bold text-white">{req.session || 'OT'}</h4>
                                        <div className="flex justify-between items-end mt-1">
                                            <p className="text-sm text-slate-400">{req.reqDate}</p>
                                            <span className="text-xs font-mono bg-slate-700 px-2 py-0.5 rounded text-blue-300">{req.numberOfOTDays}d</span>
                                        </div>
                                        {req.reason && <p className="text-xs text-slate-500 mt-2 border-t border-slate-700/50 pt-2 italic line-clamp-1">{req.reason}</p>}
                                    </div>
                                ))}
                            </>
                        )}
                    </div>

                    {/* Floating Action Button */}
                    <button 
                        onClick={() => activeType === 'leave' ? setLeaveModalOpen(true) : setOTModalOpen(true)}
                        className="absolute bottom-4 right-4 w-14 h-14 bg-blue-600 rounded-full flex items-center justify-center text-white shadow-xl shadow-blue-600/40 active:scale-95 transition-transform z-10"
                    >
                        <i className="fas fa-plus text-xl"></i>
                    </button>

                    <LeaveRequestModal isOpen={isLeaveModalOpen} onClose={() => setLeaveModalOpen(false)} userProfile={userProfile} />
                    <OTRequestModal isOpen={isOTModalOpen} onClose={() => setOTModalOpen(false)} userProfile={userProfile} />
                </div>
            );
        };

        const ScannerModal = ({ isOpen, onClose, onScan }) => {
            const scannerRef = useRef(null);
            useEffect(() => {
                if (isOpen && !scannerRef.current) {
                    Utils.loadScript(Utils.LIBS.HTML5QR).then(() => {
                        const html5QrCode = new window.Html5Qrcode("reader");
                        scannerRef.current = html5QrCode;
                        html5QrCode.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 }, 
                            (text) => { html5QrCode.stop().then(() => { onScan(text); }); }
                        ).catch(() => { alert("Camera failed."); onClose(); });
                    });
                }
                return () => { if (scannerRef.current) scannerRef.current.stop().catch(() => {}); };
            }, [isOpen]);
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 z-[60] bg-black flex flex-col items-center justify-center p-4">
                    <div className="w-full max-w-sm bg-slate-900 rounded-2xl p-4 border border-slate-700 relative">
                        <button onClick={onClose} className="absolute top-4 right-4 text-white z-10 bg-slate-800 rounded-full w-8 h-8 flex items-center justify-center"><i className="fas fa-times"></i></button>
                        <h3 className="text-center text-white font-bold mb-4">Scan Shop QR</h3>
                        <div id="reader" className="scanner-box rounded-lg overflow-hidden"></div>
                    </div>
                </div>
            );
        };

        const LoginPage = () => {
            const { auth } = useFirebase();
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [loading, setLoading] = useState(false);

            const handleLogin = (e) => {
                e.preventDefault();
                setLoading(true);
                window.firebaseSDK.signInWithEmailAndPassword(auth, email, password)
                    .catch(err => alert(err.message))
                    .finally(() => setLoading(false));
            };

            return (
                <div className="flex items-center justify-center min-h-screen bg-slate-900 p-4">
                    <form onSubmit={handleLogin} className="w-full max-w-sm bg-slate-800 p-8 rounded-2xl border border-slate-700 shadow-xl">
                        <div className="text-center mb-8">
                            <div className="w-16 h-16 bg-blue-600 rounded-2xl mx-auto flex items-center justify-center mb-4 shadow-lg shadow-blue-500/30">
                                <i className="fas fa-fingerprint text-3xl text-white"></i>
                            </div>
                            <h1 className="text-2xl font-bold text-white">CheckInMe</h1>
                            <p className="text-slate-400 text-sm">Staff Attendance Portal</p>
                        </div>
                        <div className="space-y-4">
                            <input className="input w-full" type="email" placeholder="Email" value={email} onChange={e => setEmail(e.target.value)} required />
                            <input className="input w-full" type="password" placeholder="Password" value={password} onChange={e => setPassword(e.target.value)} required />
                            <button className="w-full py-3 bg-blue-600 hover:bg-blue-500 text-white font-bold rounded-xl shadow-lg transition-transform active:scale-95 disabled:opacity-50" disabled={loading}>
                                {loading ? 'Verifying...' : 'Sign In'}
                            </button>
                        </div>
                    </form>
                </div>
            );
        };

        const CheckInMeApp = () => {
            const { db, auth, userProfile, loading } = useFirebase();
            const { shops, shifts } = useAppData();
            const [activeTab, setActiveTab] = useState('checkin'); // checkin, requests, profile
            const [status, setStatus] = useState('');
            const [geoLoc, setGeoLoc] = useState(null);
            const [distance, setDistance] = useState(null);
            const [scannerOpen, setScannerOpen] = useState(false);
            const [isLoadingAction, setIsLoadingAction] = useState(false);
            
            // Remove splash screen
            useEffect(() => {
                if (!loading) {
                    const splash = document.getElementById('splash-screen');
                    if(splash) { splash.style.opacity = '0'; setTimeout(() => splash.remove(), 500); }
                }
            }, [loading]);

            // GPS Logic
            const userShop = useMemo(() => shops.find(s => s.name === userProfile?.shop) || shops[0], [shops, userProfile]);
            
            const getLocation = useCallback(() => {
                if (!userShop) return;
                setStatus("Locating...");
                setIsLoadingAction(true);
                navigator.geolocation.getCurrentPosition(
                    (pos) => {
                        const loc = { latitude: pos.coords.latitude, longitude: pos.coords.longitude };
                        setGeoLoc(loc);
                        const dist = Utils.getDistance(loc.latitude, loc.longitude, userShop.latitude, userShop.longitude);
                        setDistance(dist);
                        setStatus(dist <= (userShop.radius || 500) ? "You are in range" : `Too far (${Math.round(dist)}m)`);
                        setIsLoadingAction(false);
                    },
                    (err) => { setStatus("GPS Error"); setIsLoadingAction(false); },
                    { enableHighAccuracy: true }
                );
            }, [userShop]);

            useEffect(() => { if (userProfile && activeTab === 'checkin') getLocation(); }, [userProfile, activeTab]);

            const handleCheckAction = async (type) => {
                if (!userShop || !geoLoc) return;
                setIsLoadingAction(true);
                try {
                    const { addDoc, collection, serverTimestamp } = window.firebaseSDK;
                    await addDoc(collection(db, 'attendance'), {
                        employeeId: userProfile.id,
                        employeeName: userProfile.name,
                        shop: userShop.name,
                        timestamp: serverTimestamp(),
                        type: type, // 'in' or 'out'
                        location: geoLoc,
                        verificationMethod: 'gps'
                    });
                    alert(`Checked ${type.toUpperCase()} Successfully!`);
                } catch (e) { alert("Error: " + e.message); }
                setIsLoadingAction(false);
            };

            const handleScan = async (text) => {
                setScannerOpen(false);
                if (text !== userShop?.name) { alert("Wrong Shop QR Code"); return; }
                // Proceed with QR Check In logic (simplified for standalone)
                handleCheckAction('in'); // Assuming scan is mostly for IN
            };

            if (loading) return null;
            if (!userProfile) return <LoginPage />;

            return (
                <div className="flex flex-col h-screen max-w-md mx-auto bg-slate-900 border-x border-slate-800 shadow-2xl">
                    {/* Header */}
                    <div className="p-4 bg-slate-800 border-b border-slate-700 flex justify-between items-center">
                        <div className="flex items-center gap-3">
                            <div className="w-10 h-10 rounded-full bg-blue-600 flex items-center justify-center text-white font-bold text-lg shadow-md">
                                {userProfile.name.charAt(0)}
                            </div>
                            <div>
                                <h2 className="font-bold text-white leading-none">{userProfile.name}</h2>
                                <p className="text-xs text-slate-400 mt-1">{userProfile.position} • {userProfile.shop}</p>
                            </div>
                        </div>
                        <button onClick={() => window.firebaseSDK.signOut(auth)} className="text-red-400 hover:text-white p-2">
                            <i className="fas fa-sign-out-alt"></i>
                        </button>
                    </div>

                    {/* Content Area */}
                    <div className="flex-1 overflow-y-auto p-4 space-y-6">
                        {activeTab === 'checkin' && (
                            <div className="flex flex-col items-center justify-center h-full space-y-8 animate-fade-in">
                                <div className="text-center">
                                    <p className="text-6xl font-bold text-white tracking-wider mb-2">
                                        {new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}
                                    </p>
                                    <p className="text-slate-400 text-sm uppercase tracking-wide">
                                        {new Date().toLocaleDateString(undefined, { weekday: 'long', month: 'long', day: 'numeric' })}
                                    </p>
                                </div>

                                <div className="flex flex-col items-center gap-2">
                                    <div className={`px-4 py-2 rounded-full border ${distance <= 500 ? 'bg-green-500/10 border-green-500/30 text-green-400' : 'bg-red-500/10 border-red-500/30 text-red-400'} text-xs font-bold flex items-center gap-2`}>
                                        <div className={`w-2 h-2 rounded-full ${distance <= 500 ? 'bg-green-500 animate-pulse' : 'bg-red-500'}`}></div>
                                        {status || 'Waiting for GPS...'}
                                    </div>
                                    <button 
                                        onClick={getLocation} 
                                        disabled={isLoadingAction}
                                        className="text-xs text-slate-500 hover:text-white flex items-center gap-1 transition-colors p-2"
                                    >
                                        <i className={`fas fa-sync-alt ${isLoadingAction ? 'fa-spin' : ''}`}></i> Refresh Location
                                    </button>
                                </div>

                                <div className="grid grid-cols-2 gap-4 w-full">
                                    <button 
                                        onClick={() => handleCheckAction('in')} 
                                        disabled={isLoadingAction || !geoLoc}
                                        className="p-6 bg-gradient-to-br from-green-600 to-emerald-700 rounded-2xl shadow-lg shadow-green-900/30 active:scale-95 transition-transform disabled:opacity-50 disabled:scale-100 flex flex-col items-center gap-2"
                                    >
                                        <i className="fas fa-sign-in-alt text-3xl text-white"></i>
                                        <span className="text-white font-bold">Check IN</span>
                                    </button>
                                    <button 
                                        onClick={() => handleCheckAction('out')} 
                                        disabled={isLoadingAction || !geoLoc}
                                        className="p-6 bg-gradient-to-br from-red-600 to-rose-700 rounded-2xl shadow-lg shadow-red-900/30 active:scale-95 transition-transform disabled:opacity-50 disabled:scale-100 flex flex-col items-center gap-2"
                                    >
                                        <i className="fas fa-sign-out-alt text-3xl text-white"></i>
                                        <span className="text-white font-bold">Check OUT</span>
                                    </button>
                                </div>

                                <button onClick={() => setScannerOpen(true)} className="w-full py-4 bg-slate-800 border border-slate-700 rounded-xl text-slate-300 font-medium flex items-center justify-center gap-2 active:bg-slate-700">
                                    <i className="fas fa-qrcode"></i> Scan QR Code
                                </button>
                            </div>
                        )}

                        {activeTab === 'requests' && (
                            <RequestsView userProfile={userProfile} />
                        )}
                        
                        {/* MODIFIED: Render ProfileView */}
                        {activeTab === 'profile' && (
                             <ProfileView userProfile={userProfile} />
                        )}
                    </div>

                    {/* Bottom Nav */}
                    <div className="bg-slate-800 border-t border-slate-700 p-2 grid grid-cols-3 gap-1">
                        <button onClick={() => setActiveTab('checkin')} className={`flex flex-col items-center justify-center p-2 rounded-xl transition-colors ${activeTab === 'checkin' ? 'bg-blue-600 text-white shadow-lg' : 'text-slate-400 hover:text-slate-200'}`}>
                            <i className="fas fa-clock text-xl mb-1"></i>
                            <span className="text-[10px] font-bold">Clock</span>
                        </button>
                        <button onClick={() => setActiveTab('requests')} className={`flex flex-col items-center justify-center p-2 rounded-xl transition-colors ${activeTab === 'requests' ? 'bg-blue-600 text-white shadow-lg' : 'text-slate-400 hover:text-slate-200'}`}>
                            <i className="fas fa-file-signature text-xl mb-1"></i>
                            <span className="text-[10px] font-bold">Requests</span>
                        </button>
                        <button onClick={() => setActiveTab('profile')} className={`flex flex-col items-center justify-center p-2 rounded-xl transition-colors ${activeTab === 'profile' ? 'bg-blue-600 text-white shadow-lg' : 'text-slate-400 hover:text-slate-200'}`}>
                            <i className="fas fa-user text-xl mb-1"></i>
                            <span className="text-[10px] font-bold">Profile</span>
                        </button>
                    </div>

                    <ScannerModal isOpen={scannerOpen} onClose={() => setScannerOpen(false)} onScan={handleScan} />
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(
            <FirebaseProvider>
                <AppDataProvider>
                    <CheckInMeApp />
                </AppDataProvider>
            </FirebaseProvider>
        );
    </script>
</body>
</html>
