<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Connect HR Lite</title>
    
    <!-- PWA Manifest for Android -->
    <link rel="manifest" href="./manifest.json">
    
    <!-- Android Theme Props -->
    <meta name="theme-color" content="#0f172a">
    <meta name="mobile-web-app-capable" content="yes">
    
    <!-- iOS / Apple PWA Meta Tags (CRITICAL FOR iOS) -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-title" content="ConnectHR">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="https://i.imgur.com/EvYU0AK.jpeg">
    
    <!-- Core UI -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    
    <!-- React & Babel -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
    
    <!-- QR Scanner -->
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

    <style>
        body { 
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif; 
            background-color: #0f172a; 
            color: #e2e8f0; 
            -webkit-tap-highlight-color: transparent;
            overflow: hidden; /* Prevent pull-to-refresh on mobile */
            /* Handle iOS Safe Areas */
            padding-top: env(safe-area-inset-top);
            padding-bottom: env(safe-area-inset-bottom);
        }
        
        /* Modern Glass Effect */
        .glass {
            background: rgba(30, 41, 59, 0.6);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
        }
        
        .glass-strong {
            background: rgba(15, 23, 42, 0.85);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border-top: 1px solid rgba(255, 255, 255, 0.08);
        }

        /* Ambient Background */
        .ambient-light {
            position: fixed;
            width: 300px;
            height: 300px;
            background: radial-gradient(circle, rgba(59,130,246,0.15) 0%, rgba(0,0,0,0) 70%);
            border-radius: 50%;
            pointer-events: none;
            z-index: -1;
            animation: float 10s infinite ease-in-out;
        }

        @keyframes float {
            0%, 100% { transform: translate(0, 0) scale(1); }
            50% { transform: translate(20px, -20px) scale(1.1); }
        }

        /* Animations */
        .fade-in-up { animation: fadeInUp 0.5s ease-out forwards; opacity: 0; transform: translateY(10px); }
        @keyframes fadeInUp { to { opacity: 1; transform: translateY(0); } }
        
        .pulse-ring {
            position: absolute;
            border-radius: 50%;
            animation: pulsate 2s infinite;
        }
        @keyframes pulsate {
            0% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.7); }
            70% { transform: scale(1); box-shadow: 0 0 0 10px rgba(34, 197, 94, 0); }
            100% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(34, 197, 94, 0); }
        }
        
        /* Toast Animation */
        @keyframes bounceIn {
            0% { opacity: 0; transform: translate(-50%, -20px); }
            50% { opacity: 1; transform: translate(-50%, 5px); }
            100% { opacity: 1; transform: translate(-50%, 0); }
        }
        .animate-bounce-in { animation: bounceIn 0.5s cubic-bezier(0.68, -0.55, 0.27, 1.55) forwards; }

        /* Custom Scrollbar for list */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body class="h-screen w-screen relative">
    
    <!-- Background Ambience -->
    <div class="ambient-light top-[-50px] left-[-50px]"></div>
    <div class="ambient-light bottom-[-50px] right-[-50px]" style="background: radial-gradient(circle, rgba(168,85,247,0.15) 0%, rgba(0,0,0,0) 70%); animation-delay: 2s;"></div>

    <div id="root" class="h-full w-full"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, query, where, getDocs, addDoc, serverTimestamp, orderBy, limit, enableIndexedDbPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        window.firebaseSDK = { initializeApp, getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut, getFirestore, collection, query, where, getDocs, addDoc, serverTimestamp, orderBy, limit, enableIndexedDbPersistence };
    </script>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        // --- CONFIGURATION ---
        const firebaseConfig = {
            apiKey: "AIzaSyB7_pnmwHj6aOeZRTykPvNusNFYReaTY6Q",
            authDomain: "hrsm-j.firebaseapp.com",
            projectId: "hrsm-j",
            storageBucket: "hrsm-j.appspot.com",
            messagingSenderId: "45063715478",
            appId: "1:45063715478:web:cc2dd21b83dd195771e0b7"
        };

        // --- TOAST NOTIFICATION COMPONENT ---
        const Toast = ({ message, type, onClose }) => {
            useEffect(() => {
                const timer = setTimeout(onClose, 3000);
                return () => clearTimeout(timer);
            }, [onClose]);

            const bgClass = type === 'error' ? 'bg-red-500/90' : (type === 'success' ? 'bg-emerald-500/90' : 'bg-slate-700/90');
            const icon = type === 'error' ? 'fa-exclamation-circle' : (type === 'success' ? 'fa-check-circle' : 'fa-info-circle');

            return (
                <div className={`fixed top-4 left-1/2 transform -translate-x-1/2 z-50 flex items-center gap-3 px-4 py-3 rounded-full shadow-xl backdrop-blur-md text-white text-sm font-medium transition-all duration-300 animate-bounce-in ${bgClass}`}>
                    <i className={`fas ${icon}`}></i>
                    <span>{message}</span>
                </div>
            );
        };

        // --- UTILS ---
        const getDistance = (lat1, lon1, lat2, lon2) => {
            const R = 6371e3; 
            const φ1 = lat1 * Math.PI/180, φ2 = lat2 * Math.PI/180;
            const Δφ = (lat2-lat1) * Math.PI/180, Δλ = (lon2-lon1) * Math.PI/180;
            const a = Math.sin(Δφ/2) * Math.sin(Δφ/2) + Math.cos(φ1) * Math.cos(φ2) * Math.sin(Δλ/2) * Math.sin(Δλ/2);
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        };

        // --- COMPONENTS ---

        const LoadingScreen = () => (
            <div className="h-full w-full flex flex-col items-center justify-center">
                <div className="relative w-16 h-16 mb-4">
                    <div className="absolute inset-0 border-4 border-blue-500/30 rounded-full"></div>
                    <div className="absolute inset-0 border-4 border-t-blue-500 rounded-full animate-spin"></div>
                </div>
                <p className="text-slate-500 text-sm tracking-widest uppercase animate-pulse">Loading...</p>
            </div>
        );

        const LoginPage = ({ onLogin, loading, error }) => {
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');

            const handleSubmit = (e) => {
                e.preventDefault();
                onLogin(email, password);
            };

            return (
                <div className="h-full w-full flex flex-col items-center justify-center p-6 relative">
                    <div className="w-full max-w-sm z-10 glass rounded-3xl p-8 shadow-2xl">
                        <div className="text-center mb-8">
                            <div className="w-16 h-16 bg-gradient-to-tr from-blue-600 to-indigo-600 rounded-2xl mx-auto flex items-center justify-center shadow-lg shadow-blue-500/30 mb-4 transform rotate-3">
                                <i className="fas fa-fingerprint text-3xl text-white"></i>
                            </div>
                            <h1 className="text-2xl font-bold text-white tracking-tight">Welcome Back</h1>
                            <p className="text-slate-400 text-xs mt-1">HR Check-In Lite</p>
                        </div>
                        
                        <form onSubmit={handleSubmit} className="space-y-4">
                            <div className="space-y-3">
                                <div className="relative group">
                                    <i className="fas fa-envelope absolute left-4 top-3.5 text-slate-500 group-focus-within:text-blue-400 transition-colors"></i>
                                    <input 
                                        type="email" 
                                        placeholder="Email Address" 
                                        className="w-full bg-slate-800/50 border border-slate-700/50 rounded-xl py-3 pl-11 pr-4 text-sm text-white placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-blue-500/50 transition-all"
                                        value={email}
                                        onChange={e => setEmail(e.target.value)}
                                        required
                                    />
                                </div>
                                <div className="relative group">
                                    <i className="fas fa-lock absolute left-4 top-3.5 text-slate-500 group-focus-within:text-blue-400 transition-colors"></i>
                                    <input 
                                        type="password" 
                                        placeholder="Password" 
                                        className="w-full bg-slate-800/50 border border-slate-700/50 rounded-xl py-3 pl-11 pr-4 text-sm text-white placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-blue-500/50 transition-all"
                                        value={password}
                                        onChange={e => setPassword(e.target.value)}
                                        required
                                    />
                                </div>
                            </div>
                            
                            {error && <div className="p-3 bg-red-500/10 border border-red-500/20 rounded-lg text-red-400 text-xs text-center flex items-center justify-center gap-2"><i className="fas fa-exclamation-circle"></i>{error}</div>}
                            
                            <button 
                                type="submit" 
                                disabled={loading}
                                className="w-full py-3.5 bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-500 hover:to-indigo-500 text-white font-bold rounded-xl shadow-lg shadow-blue-500/20 active:scale-95 transition-all flex items-center justify-center"
                            >
                                {loading ? <span className="w-5 h-5 border-2 border-white/30 border-t-white rounded-full animate-spin"></span> : "Sign In"}
                            </button>
                        </form>
                    </div>
                    
                    <p className="absolute bottom-6 text-slate-500 text-[10px] uppercase tracking-widest">Secure Connection</p>
                </div>
            );
        };

        const MainApp = () => {
            const [user, setUser] = useState(null);
            const [profile, setProfile] = useState(null);
            const [shop, setShop] = useState(null);
            const [db, setDb] = useState(null);
            const [auth, setAuth] = useState(null);
            
            const [loading, setLoading] = useState(true);
            const [actionLoading, setActionLoading] = useState(false);
            const [isLocating, setIsLocating] = useState(false); // NEW STATE for Refresh
            const [toast, setToast] = useState(null); 
            
            const [currentTime, setCurrentTime] = useState(new Date());
            const [lastAction, setLastAction] = useState(null); 
            const [isScannerOpen, setIsScannerOpen] = useState(false);

            // Clock Timer
            useEffect(() => {
                const timer = setInterval(() => setCurrentTime(new Date()), 1000);
                return () => clearInterval(timer);
            }, []);

            // 1. Initialize Firebase
            useEffect(() => {
                const init = async () => {
                    let attempts = 0;
                    while(!window.firebaseSDK && attempts < 20) await new Promise(r => setTimeout(r, 100));
                    
                    if (!window.firebaseSDK) {
                        setToast({ msg: "Failed to load system. Refresh page.", type: 'error' });
                        return;
                    }

                    const { initializeApp, getFirestore, getAuth, onAuthStateChanged, enableIndexedDbPersistence } = window.firebaseSDK;
                    const app = initializeApp(firebaseConfig);
                    const db = getFirestore(app);
                    const auth = getAuth(app);
                    
                    enableIndexedDbPersistence(db).catch(() => {});
                    
                    setDb(db);
                    setAuth(auth);

                    onAuthStateChanged(auth, async (u) => {
                        if (u) {
                            setUser(u);
                            await fetchUserData(db, u);
                        } else {
                            setUser(null);
                            setProfile(null);
                            setLoading(false);
                        }
                    });
                };
                init();
            }, []);

            // 2. Fetch User Data
            const fetchUserData = async (database, firebaseUser) => {
                setLoading(true);
                try {
                    const { collection, query, where, getDocs, orderBy, limit } = window.firebaseSDK;
                    
                    // Profile
                    const empQ = query(collection(database, 'employees'), where('uid', '==', firebaseUser.uid));
                    const empSnap = await getDocs(empQ);
                    
                    if (empSnap.empty) {
                        setToast({ msg: "Account not found.", type: 'error' });
                        setLoading(false);
                        return;
                    }
                    
                    const p = { id: empSnap.docs[0].id, ...empSnap.docs[0].data() };
                    setProfile(p);

                    // Shop
                    const shopName = Array.isArray(p.shop) ? p.shop[0] : p.shop;
                    if (shopName) {
                        const shopQ = query(collection(database, 'shops'), where('name', '==', shopName));
                        const shopSnap = await getDocs(shopQ);
                        if (!shopSnap.empty) setShop(shopSnap.docs[0].data());
                    }

                    // Last Action (Today)
                    const today = new Date();
                    today.setHours(0,0,0,0);
                    const attQ = query(
                        collection(database, 'attendance'), 
                        where('employeeId', '==', p.id),
                        where('timestamp', '>=', today),
                        orderBy('timestamp', 'desc'),
                        limit(1)
                    );
                    const attSnap = await getDocs(attQ);
                    if (!attSnap.empty) {
                        const data = attSnap.docs[0].data();
                        setLastAction({ type: data.type, time: data.timestamp.toDate() });
                    } else {
                        setLastAction(null);
                    }

                } catch (err) {
                    console.error(err);
                    setToast({ msg: "Connection error. Please retry.", type: 'error' });
                } finally {
                    setLoading(false);
                }
            };

            const handleLogin = async (email, password) => {
                setLoading(true);
                try {
                    await window.firebaseSDK.signInWithEmailAndPassword(auth, email, password);
                } catch (e) {
                    setToast({ msg: "Invalid credentials.", type: 'error' });
                    setLoading(false);
                }
            };

            // 3. GPS Logic
            const getLoc = () => {
                return new Promise((resolve, reject) => {
                    if (!navigator.geolocation) reject("No GPS support");
                    navigator.geolocation.getCurrentPosition(resolve, reject, { enableHighAccuracy: true, timeout: 10000 });
                });
            };

            // NEW: Feature to Refresh Location Status without submitting
            const handleRefreshLocation = async () => {
                if (!shop) { setToast({ msg: "No shop assigned.", type: 'error' }); return; }
                setIsLocating(true);
                
                try {
                    const pos = await getLoc();
                    const { latitude, longitude } = pos.coords;
                    const dist = getDistance(latitude, longitude, parseFloat(shop.latitude), parseFloat(shop.longitude));
                    const radius = parseFloat(shop.radius) || 500;
                    
                    if (dist <= radius) {
                        setToast({ msg: `Signal Strong: ${Math.round(dist)}m away`, type: 'success' });
                    } else {
                        setToast({ msg: `Signal Weak: ${Math.round(dist)}m away`, type: 'error' });
                    }
                } catch (err) {
                    setToast({ msg: "GPS signal lost.", type: 'error' });
                } finally {
                    setIsLocating(false);
                }
            };

            const handleCheck = async (type) => {
                if (!shop) { setToast({ msg: "No shop assigned.", type: 'error' }); return; }
                
                setActionLoading(true);
                
                try {
                    const pos = await getLoc();
                    const { latitude, longitude } = pos.coords;
                    const dist = getDistance(latitude, longitude, parseFloat(shop.latitude), parseFloat(shop.longitude));
                    
                    const radius = parseFloat(shop.radius) || 500;
                    if (dist > radius) {
                        setToast({ msg: `Too far! You are ${Math.round(dist)}m away.`, type: 'error' });
                        setActionLoading(false);
                        return;
                    }

                    // Write to DB
                    const { addDoc, collection, serverTimestamp } = window.firebaseSDK;
                    await addDoc(collection(db, 'attendance'), {
                        employeeId: profile.id,
                        employeeName: profile.name,
                        shop: shop.name,
                        timestamp: serverTimestamp(),
                        type: type,
                        location: { latitude, longitude },
                        verificationMethod: 'gps-lite'
                    });

                    setLastAction({ type, time: new Date() });
                    setToast({ msg: `Successfully checked ${type.toUpperCase()}`, type: 'success' });

                } catch (err) {
                    console.error(err);
                    setToast({ msg: "GPS Check failed. Enable Location.", type: 'error' });
                } finally {
                    setActionLoading(false);
                }
            };
            
            // 4. Scanner Component
            const Scanner = ({ onClose }) => {
                useEffect(() => {
                    const scanner = new Html5Qrcode("reader");
                    scanner.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 }, 
                        async (text) => {
                            scanner.stop();
                            if (text === shop?.name) {
                                setActionLoading(true);
                                onClose();
                                try {
                                    const type = lastAction?.type === 'in' ? 'out' : 'in';
                                    const { addDoc, collection, serverTimestamp } = window.firebaseSDK;
                                    await addDoc(collection(db, 'attendance'), {
                                        employeeId: profile.id,
                                        employeeName: profile.name,
                                        shop: shop.name,
                                        timestamp: serverTimestamp(),
                                        type: type,
                                        verificationMethod: 'qr-lite'
                                    });
                                    setLastAction({ type, time: new Date() });
                                    setToast({ msg: `QR Verified! Checked ${type.toUpperCase()}`, type: 'success' });
                                } catch (e) { setToast({ msg: "Save failed.", type: 'error' }); }
                                setActionLoading(false);
                            } else {
                                setToast({ msg: "Wrong Shop QR.", type: 'error' });
                                onClose();
                            }
                        }, 
                        () => {}
                    ).catch(err => { setToast({ msg: "Camera error.", type: 'error' }); onClose(); });
                    return () => { try { scanner.stop(); } catch(e){} };
                }, []);
                
                return (
                    <div className="fixed inset-0 bg-black z-50 flex flex-col items-center justify-center p-6 animate-fade-in">
                        <div className="w-full max-w-sm relative">
                            <button onClick={onClose} className="absolute -top-12 right-0 text-white p-2 bg-white/10 rounded-full"><i className="fas fa-times"></i></button>
                            <div id="reader" className="w-full bg-black border-2 border-blue-500 rounded-2xl overflow-hidden shadow-2xl shadow-blue-500/20"></div>
                            <p className="text-center text-slate-400 text-sm mt-6">Align QR code within the frame</p>
                        </div>
                    </div>
                );
            };

            // --- RENDER ---
            
            if (loading) return <LoadingScreen />;
            if (!user) return <LoginPage onLogin={handleLogin} loading={loading} error={toast?.type === 'error' ? toast.msg : ''} />;
            if (!profile) return <div className="h-full flex items-center justify-center text-slate-500">Loading Profile...</div>;

            const isCheckedIn = lastAction?.type === 'in';
            
            return (
                <div className="h-full w-full flex flex-col relative overflow-hidden">
                    {toast && <Toast message={toast.msg} type={toast.type} onClose={() => setToast(null)} />}

                    {/* Header */}
                    <div className="pt-6 pb-4 px-6 flex justify-between items-center z-10">
                        <div className="flex items-center gap-3">
                            <div className="w-10 h-10 rounded-full bg-gradient-to-br from-slate-700 to-slate-800 border border-slate-600 flex items-center justify-center text-sm font-bold text-white shadow-md">
                                {profile.name.charAt(0)}
                            </div>
                            <div>
                                <h2 className="font-bold text-slate-100 leading-tight">{profile.name}</h2>
                                <div className="flex items-center gap-1.5 mt-0.5">
                                    <div className="w-1.5 h-1.5 rounded-full bg-blue-400"></div>
                                    <p className="text-[10px] text-blue-200 uppercase tracking-wide font-medium">{shop ? shop.name : "No Shop"}</p>
                                </div>
                            </div>
                        </div>
                        <button onClick={() => window.firebaseSDK.signOut(auth)} className="w-8 h-8 rounded-full bg-slate-800/50 flex items-center justify-center text-slate-400 hover:text-white border border-slate-700/50 active:scale-90 transition-all">
                            <i className="fas fa-power-off text-xs"></i>
                        </button>
                    </div>

                    {/* Main Content */}
                    <div className="flex-1 px-6 flex flex-col justify-center space-y-8 z-10 pb-12">
                        
                        {/* Clock Card */}
                        <div className="glass rounded-3xl p-6 text-center relative overflow-hidden fade-in-up" style={{animationDelay: '0.1s'}}>
                            <div className="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-transparent via-blue-500/50 to-transparent opacity-50"></div>
                            {/* UPDATED: Added seconds and tabular-nums for stable ticking */}
                            <div className="text-5xl sm:text-6xl font-bold tracking-tight text-transparent bg-clip-text bg-gradient-to-b from-white to-slate-400 font-mono tabular-nums">
                                {currentTime.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit', second: '2-digit', hour12: false})}
                            </div>
                            <div className="text-blue-400/80 text-xs font-bold uppercase tracking-[0.2em] mt-2">
                                {currentTime.toLocaleDateString(undefined, {weekday:'long', month:'short', day:'numeric'})}
                            </div>
                        </div>

                        {/* Status Indicator */}
                        <div className={`fade-in-up mx-auto ${isCheckedIn ? 'bg-emerald-500/10 border-emerald-500/20' : 'bg-slate-800/50 border-slate-700/50'} border backdrop-blur-sm px-6 py-2 rounded-full flex items-center gap-3 shadow-lg`} style={{animationDelay: '0.2s'}}>
                            <span className="relative flex h-3 w-3">
                              {isCheckedIn && <span className="animate-ping absolute inline-flex h-full w-full rounded-full bg-emerald-400 opacity-75"></span>}
                              <span className={`relative inline-flex rounded-full h-3 w-3 ${isCheckedIn ? 'bg-emerald-500' : 'bg-slate-500'}`}></span>
                            </span>
                            <span className={`text-xs font-bold uppercase tracking-wide ${isCheckedIn ? 'text-emerald-400' : 'text-slate-400'}`}>
                                {isCheckedIn ? "Checked In" : "Checked Out"}
                            </span>
                        </div>

                        {/* NEW: Refresh Location Button */}
                        <div className="fade-in-up text-center" style={{animationDelay: '0.25s'}}>
                            <button 
                                onClick={handleRefreshLocation} 
                                disabled={isLocating || actionLoading}
                                className="inline-flex items-center gap-2 px-4 py-2 rounded-full bg-blue-500/10 border border-blue-500/20 text-blue-400 text-xs font-bold uppercase tracking-wider hover:bg-blue-500/20 active:scale-95 transition-all"
                            >
                                <i className={`fas fa-location-crosshairs ${isLocating ? 'animate-spin' : ''}`}></i>
                                <span>{isLocating ? "Locating..." : "Refresh Location"}</span>
                            </button>
                        </div>

                        {/* Action Buttons */}
                        <div className="grid grid-cols-2 gap-4 w-full max-w-sm mx-auto fade-in-up" style={{animationDelay: '0.3s'}}>
                            <button 
                                onClick={() => handleCheck('in')}
                                disabled={isCheckedIn || actionLoading}
                                className={`relative h-40 rounded-3xl flex flex-col items-center justify-center gap-3 border transition-all duration-300 active:scale-95 group ${
                                    isCheckedIn 
                                        ? 'bg-slate-800/30 border-slate-700/30 opacity-40 cursor-not-allowed' 
                                        : 'bg-gradient-to-br from-emerald-600 to-teal-700 border-emerald-500/50 shadow-lg shadow-emerald-900/30 hover:shadow-emerald-900/50'
                                }`}
                            >
                                <div className="w-12 h-12 rounded-2xl bg-white/20 flex items-center justify-center text-white backdrop-blur-sm group-active:scale-110 transition-transform">
                                    <i className="fas fa-sign-in-alt text-2xl"></i>
                                </div>
                                <span className="font-bold text-white text-lg tracking-wide">Check In</span>
                                {!isCheckedIn && !actionLoading && <div className="absolute top-4 right-4 w-2 h-2 bg-white rounded-full animate-ping"></div>}
                            </button>

                            <button 
                                onClick={() => handleCheck('out')}
                                disabled={!isCheckedIn || actionLoading}
                                className={`relative h-40 rounded-3xl flex flex-col items-center justify-center gap-3 border transition-all duration-300 active:scale-95 group ${
                                    !isCheckedIn 
                                        ? 'bg-slate-800/30 border-slate-700/30 opacity-40 cursor-not-allowed' 
                                        : 'bg-gradient-to-br from-rose-600 to-pink-700 border-rose-500/50 shadow-lg shadow-rose-900/30 hover:shadow-rose-900/50'
                                }`}
                            >
                                <div className="w-12 h-12 rounded-2xl bg-white/20 flex items-center justify-center text-white backdrop-blur-sm group-active:scale-110 transition-transform">
                                    <i className="fas fa-sign-out-alt text-2xl"></i>
                                </div>
                                <span className="font-bold text-white text-lg tracking-wide">Check Out</span>
                                {isCheckedIn && !actionLoading && <div className="absolute top-4 right-4 w-2 h-2 bg-white rounded-full animate-ping"></div>}
                            </button>
                        </div>

                        {/* QR Trigger */}
                        <div className="text-center fade-in-up" style={{animationDelay: '0.4s'}}>
                            <button onClick={() => setIsScannerOpen(true)} className="inline-flex items-center gap-2 px-5 py-2.5 rounded-xl bg-slate-800/80 border border-slate-700 text-slate-400 hover:text-white hover:bg-slate-700 transition-colors text-xs font-bold uppercase tracking-wider shadow-sm active:scale-95">
                                <i className="fas fa-qrcode text-sm"></i> Scan QR Code
                            </button>
                        </div>
                        
                    </div>

                    {isScannerOpen && <Scanner onClose={() => setIsScannerOpen(false)} />}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<MainApp />);
    </script>

    <!-- NEW: Service Worker Registration -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./service-worker.js')
                    .then(registration => {
                        console.log('SW registered: ', registration);
                    })
                    .catch(registrationError => {
                        console.log('SW registration failed: ', registrationError);
                    });
            });
        }
    </script>
</body>
</html>
