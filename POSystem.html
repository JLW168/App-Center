<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Purchase Order Application - React</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- React Libraries -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- External Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <!-- Firebase Libraries -->
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f1f5f9; /* slate-100 */
        }
        /* Custom scrollbar for better aesthetics */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f5f9;
        }
        ::-webkit-scrollbar-thumb {
            background: #94a3b8;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #64748b;
        }
        
        /* Styles for responsive tables (mobile view) */
        @media (max-width: 768px) {
            .responsive-table thead {
                display: none;
            }
            .responsive-table tr {
                display: block;
                margin-bottom: 1rem;
                border: 1px solid #e2e8f0;
                border-radius: 0.5rem;
                box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
                padding: 1rem;
            }
            .responsive-table td {
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 0.75rem 0.25rem;
                border-bottom: 1px solid #f1f5f9;
                text-align: right;
            }
            .responsive-table td:last-child {
                border-bottom: none;
            }
            .responsive-table td::before {
                content: attr(data-label);
                font-weight: 600;
                margin-right: 1rem;
                color: #475569;
                text-align: left;
                flex-grow: 1;
            }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, createContext, useContext, useMemo, useCallback } = React;

        // --- Context for Authentication and Data ---
        const AppContext = createContext();

        // --- Main App Component ---
        function App() {
            // Start: State Management
            const [user, setUser] = useState(null);
            const [userProfile, setUserProfile] = useState(null);
            const [loading, setLoading] = useState(true);
            const [isSidebarOpen, setSidebarOpen] = useState(false);
            const [currentPage, setCurrentPage] = useState('po-request-form');
            const [firebaseInitialized, setFirebaseInitialized] = useState(false);
            const [db, setDb] = useState(null);
            // End: State Management

            // Start: Firebase Initialization
            useEffect(() => {
                try {
                    const firebaseConfig = {
                        apiKey: "AIzaSyBsSA-iUiXFhYmkZQc9sMdkK7FW5HEu9p0",
                        authDomain: "po-report-cd3fc.firebaseapp.com",
                        projectId: "po-report-cd3fc",
                        storageBucket: "po-report-cd3fc.appspot.com",
                        messagingSenderId: "115437177983",
                        appId: "1:115437177983:web:a0dc6b1046babcff6a034a",
                        measurementId: "G-NWFTBZ7F2L"
                    };
                    if (!firebase.apps.length) {
                        firebase.initializeApp(firebaseConfig);
                    }
                    setDb(firebase.firestore());
                    setFirebaseInitialized(true);
                } catch (e) {
                    console.error("Firebase initialization failed:", e);
                }
            }, []);
            // End: Firebase Initialization

            // Start: Authentication Listener
            useEffect(() => {
                if (!firebaseInitialized) return;

                const auth = firebase.auth();
                
                const unsubscribe = auth.onAuthStateChanged(async (firebaseUser) => {
                    if (firebaseUser) {
                        const employeesRef = db.collection('employees');
                        const q = employeesRef.where('uid', '==', firebaseUser.uid).limit(1);
                        const querySnapshot = await q.get();

                        if (querySnapshot.empty) {
                            console.log("User authenticated but not authorized. Signing out.");
                            await auth.signOut();
                            setUser(null);
                            setUserProfile(null);
                        } else {
                            const profile = { id: querySnapshot.docs[0].id, ...querySnapshot.docs[0].data() };
                            setUser(firebaseUser);
                            setUserProfile(profile);
                            // Set initial page based on permissions
                            const firstAllowedPage = profile.permissions?.[0] || 'po-request-form';
                            setCurrentPage(firstAllowedPage);
                        }
                    } else {
                        setUser(null);
                        setUserProfile(null);
                    }
                    setLoading(false);
                });

                return () => unsubscribe();
            }, [firebaseInitialized, db]);
            // End: Authentication Listener

            // Start: Render Logic
            if (loading) {
                return <LoadingScreen message="Initializing Application..." />;
            }

            if (!user) {
                return <LoginScreen />;
            }
            
            const contextValue = { user, userProfile, firebaseInitialized, db, setCurrentPage };

            return (
                <AppContext.Provider value={contextValue}>
                    <div className="flex h-screen bg-slate-100">
                        <Sidebar 
                            isOpen={isSidebarOpen} 
                            setOpen={setSidebarOpen} 
                            currentPage={currentPage}
                            setCurrentPage={setCurrentPage}
                            userProfile={userProfile}
                        />
                        <div className="flex-1 flex flex-col overflow-hidden">
                            <Header setSidebarOpen={setSidebarOpen} userProfile={userProfile} currentPage={currentPage} />
                            <main className="flex-1 overflow-x-hidden overflow-y-auto bg-slate-100 p-4 md:p-6 lg:p-8">
                                <PageContent currentPage={currentPage} />
                            </main>
                        </div>
                    </div>
                </AppContext.Provider>
            );
            // End: Render Logic
        }

        // --- Loading Component ---
        function LoadingScreen({ message }) {
            return (
                <div className="flex items-center justify-center min-h-screen bg-slate-900 text-white">
                    <div className="flex flex-col items-center gap-4">
                        <i className="fas fa-spinner fa-spin text-4xl text-red-500"></i>
                        <p className="text-lg">{message}</p>
                    </div>
                </div>
            );
        }

        // --- Login Screen Component ---
        function LoginScreen() {
            // Start: State and Handlers
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [showPassword, setShowPassword] = useState(false);
            const [error, setError] = useState('');
            const [loading, setLoading] = useState(false);

            const handleLogin = async (e) => {
                e.preventDefault();
                setError('');
                setLoading(true);
                try {
                    await firebase.auth().signInWithEmailAndPassword(email, password);
                    // onAuthStateChanged will handle the rest
                } catch (err) {
                    // Provide more specific feedback based on the error code
                    switch (err.code) {
                        case 'auth/invalid-email':
                            setError('The email address is not valid.');
                            break;
                        case 'auth/user-disabled':
                            setError('This user account has been disabled.');
                            break;
                        case 'auth/user-not-found':
                        case 'auth/wrong-password':
                        case 'auth/invalid-credential':
                            setError('Invalid email or password combination.');
                            break;
                        default:
                            setError('An unexpected error occurred during login.');
                            break;
                    }
                    console.error("Login failed:", err);
                } finally {
                    setLoading(false);
                }
            };
            // End: State and Handlers

            // Start: Render Logic
            return (
                <div className="flex items-center justify-center min-h-screen bg-slate-900 p-4">
                    <div className="w-full max-w-md p-8 space-y-8 bg-slate-800 rounded-2xl shadow-2xl">
                        <div>
                            <h2 className="mt-6 text-center text-3xl font-extrabold text-gray-100">
                                Sign in to your account
                            </h2>
                            <p className="mt-2 text-center text-sm text-slate-400">
                                Internal Purchase Order System
                            </p>
                        </div>
                        <form onSubmit={handleLogin} className="mt-8 space-y-6">
                            <div className="rounded-md shadow-sm space-y-4">
                                <div>
                                    <label htmlFor="email-address" className="sr-only">Email address</label>
                                    <input id="email-address" type="email" value={email} onChange={(e) => setEmail(e.target.value)} required className="relative block w-full px-3 py-2 border border-slate-600 bg-slate-700 placeholder-slate-400 text-white rounded-md focus:outline-none focus:ring-red-500 focus:border-red-500 sm:text-sm" placeholder="Email address" />
                                </div>
                                <div className="relative">
                                    <label htmlFor="password" className="sr-only">Password</label>
                                    <input id="password" type={showPassword ? 'text' : 'password'} value={password} onChange={(e) => setPassword(e.target.value)} required className="relative block w-full px-3 py-2 border border-slate-600 bg-slate-700 placeholder-slate-400 text-white rounded-md focus:outline-none focus:ring-red-500 focus:border-red-500 sm:text-sm" placeholder="Password" />
                                    <button type="button" onClick={() => setShowPassword(!showPassword)} className="absolute inset-y-0 right-0 px-3 flex items-center text-slate-400 hover:text-slate-200">
                                        <i className={`fa ${showPassword ? 'fa-eye-slash' : 'fa-eye'}`}></i>
                                    </button>
                                </div>
                            </div>
                            {error && <p className="text-sm text-red-400 bg-red-900/50 p-3 rounded-md">{error}</p>}
                            <div>
                                <button type="submit" disabled={loading} className="group relative w-full flex justify-center py-2 px-4 border border-transparent text-sm font-medium rounded-md text-white bg-red-700 hover:bg-red-800 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-slate-800 focus:ring-red-500 disabled:bg-red-900 disabled:cursor-not-allowed">
                                    {loading ? (
                                        <i className="fas fa-spinner fa-spin"></i>
                                    ) : (
                                        <>
                                            <span className="absolute left-0 inset-y-0 flex items-center pl-3">
                                                <i className="fa fa-lock text-red-400 group-hover:text-red-300"></i>
                                            </span>
                                            Sign in
                                        </>
                                    )}
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            );
            // End: Render Logic
        }
        
        // --- Reusable Hooks ---
        // Start: useFirestoreCollection Hook
        function useFirestoreCollection(collectionName) {
            const { db } = useContext(AppContext);
            const [data, setData] = useState([]);
            const [loading, setLoading] = useState(true);

            useEffect(() => {
                if (!db) return;

                const unsubscribe = db.collection(collectionName).onSnapshot(
                    (snapshot) => {
                        const items = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        setData(items);
                        setLoading(false);
                    },
                    (error) => {
                        console.error(`Error fetching ${collectionName}:`, error);
                        setLoading(false);
                    }
                );

                return () => unsubscribe();
            }, [db, collectionName]);

            return { data, loading };
        }
        // End: useFirestoreCollection Hook

        // --- UI Components ---
        // Start: Sidebar Component
        function Sidebar({ isOpen, setOpen, currentPage, setCurrentPage, userProfile }) {
            const navItems = [
                { id: 'po-request-form', name: 'PO Request', icon: 'fa-file-invoice' },
                { id: 'drafts-page', name: 'Drafts', icon: 'fa-edit' },
                { id: 'purchase-order', name: 'POs Center', icon: 'fa-box-archive' },
                { id: 'product-data-page', name: 'Product Data', icon: 'fa-database' },
                { id: 'setting-page', name: 'Settings', icon: 'fa-cog' },
            ];

            const allowedPages = useMemo(() => {
                if (!userProfile) return [];
                if (userProfile.role === 'Admin') return navItems.map(item => item.id);
                return userProfile.permissions || [];
            }, [userProfile]);

            return (
                <>
                    {/* Overlay for mobile */}
                    <div onClick={() => setOpen(false)} className={`fixed inset-0 bg-black opacity-50 z-20 lg:hidden transition-opacity ${isOpen ? 'block' : 'hidden'}`}></div>
                    
                    {/* Sidebar */}
                    <div className={`fixed lg:relative inset-y-0 left-0 bg-slate-800 text-slate-300 w-64 p-4 transform ${isOpen ? 'translate-x-0' : '-translate-x-full'} lg:translate-x-0 transition-transform duration-300 ease-in-out z-30 flex flex-col`}>
                        <div className="text-white text-2xl font-bold mb-10 flex items-center gap-3 px-2">
                            <i className="fa fa-cubes text-red-500"></i>
                            <span>PO System</span>
                        </div>
                        <nav className="flex-grow">
                            <ul>
                                {navItems.filter(item => allowedPages.includes(item.id)).map(item => (
                                    <li key={item.id} className="mb-2">
                                        <a
                                            href="#"
                                            onClick={(e) => {
                                                e.preventDefault();
                                                setCurrentPage(item.id);
                                                setOpen(false);
                                            }}
                                            className={`flex items-center p-3 rounded-lg transition-colors ${currentPage === item.id ? 'bg-red-700 text-white' : 'hover:bg-slate-700 hover:text-white'}`}
                                        >
                                            <i className={`fa ${item.icon} w-6 text-lg`}></i>
                                            <span className="ml-3 font-medium">{item.name}</span>
                                        </a>
                                    </li>
                                ))}
                            </ul>
                        </nav>
                        <div className="mt-auto">
                             <button onClick={() => firebase.auth().signOut()} className="flex items-center p-3 w-full rounded-lg transition-colors hover:bg-slate-700 hover:text-white">
                                <i className="fa fa-sign-out-alt w-6 text-lg"></i>
                                <span className="ml-3 font-medium">Logout</span>
                            </button>
                        </div>
                    </div>
                </>
            );
        }
        // End: Sidebar Component

        // Start: Header Component
        function Header({ setSidebarOpen, userProfile, currentPage }) {
            const pageTitles = {
                'po-request-form': 'PO Request',
                'drafts-page': 'Drafts',
                'purchase-order': 'POs Center',
                'product-data-page': 'Product Data',
                'setting-page': 'Settings',
            };
            
            return (
                <header className="bg-white shadow-sm p-4 flex justify-between items-center">
                    <div className="flex items-center gap-4">
                        <button onClick={() => setSidebarOpen(true)} className="text-slate-600 lg:hidden">
                            <i className="fas fa-bars text-xl"></i>
                        </button>
                        <h1 className="text-xl font-semibold text-slate-800 hidden md:block">
                            {pageTitles[currentPage] || 'Dashboard'}
                        </h1>
                    </div>
                    <div className="flex items-center gap-4">
                        <span className="font-medium text-slate-700 hidden sm:block">{userProfile?.name || 'User'}</span>
                        <div className="w-10 h-10 rounded-full bg-red-500 flex items-center justify-center text-white font-bold border-2 border-white shadow-sm">
                            {userProfile?.name?.charAt(0).toUpperCase() || 'U'}
                        </div>
                    </div>
                </header>
            );
        }
        // End: Header Component

        // Start: Generic Modal Component
        function Modal({ show, onClose, title, children, maxWidth = 'max-w-md' }) {
            if (!show) return null;

            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 z-40 flex items-center justify-center p-4">
                    <div className={`bg-white rounded-lg shadow-xl w-full ${maxWidth}`} onClick={e => e.stopPropagation()}>
                        <div className="p-4 border-b flex justify-between items-center">
                            <h3 className="text-lg font-semibold text-slate-800">{title}</h3>
                            <button onClick={onClose} className="text-slate-400 hover:text-slate-600">
                                <i className="fas fa-times"></i>
                            </button>
                        </div>
                        {children}
                    </div>
                </div>
            );
        }
        // End: Generic Modal Component

        // Start: Confirmation Modal Component
        function ConfirmationModal({ show, onClose, onConfirm, title, message }) {
            return (
                <Modal show={show} onClose={onClose} title={title}>
                    <div className="p-6">
                        <p className="text-slate-600">{message}</p>
                    </div>
                    <div className="bg-slate-50 p-4 flex justify-end gap-3 rounded-b-lg">
                        <button type="button" onClick={onClose} className="px-4 py-2 bg-slate-200 text-slate-800 rounded-lg hover:bg-slate-300 font-semibold">
                            Cancel
                        </button>
                        <button type="button" onClick={onConfirm} className="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 font-semibold">
                            Confirm
                        </button>
                    </div>
                </Modal>
            );
        }
        // End: Confirmation Modal Component

        // Start: Page Content Router
        function PageContent({ currentPage }) {
            // This component acts as a router to display the correct page
            switch (currentPage) {
                case 'po-request-form':
                    return <PORequestPage />;
                case 'drafts-page':
                    return <DraftsPage />;
                case 'purchase-order':
                    return <POCenterPage />;
                case 'product-data-page':
                    return <ProductDataPage />;
                case 'setting-page':
                    return <SettingsPage />;
                default:
                    return <div className="text-center p-8">
                        <h1 className="text-2xl font-bold text-slate-700">Page Not Found</h1>
                        <p className="text-slate-500">You do not have permission to view this page or it does not exist.</p>
                    </div>;
            }
        }
        // End: Page Content Router
        
        // Start: Pagination Component
        function Pagination({ currentPage, totalItems, itemsPerPage, onPageChange }) {
            const totalPages = Math.ceil(totalItems / itemsPerPage);
            if (totalPages <= 1) return null;

            const startItem = (currentPage - 1) * itemsPerPage + 1;
            const endItem = Math.min(currentPage * itemsPerPage, totalItems);

            return (
                <div className="mt-4 flex flex-col sm:flex-row justify-between items-center text-sm text-slate-600">
                    <p>
                        Showing <span className="font-semibold">{startItem}</span> to <span className="font-semibold">{endItem}</span> of <span className="font-semibold">{totalItems}</span> results
                    </p>
                    <div className="flex items-center gap-2 mt-2 sm:mt-0">
                        <button 
                            onClick={() => onPageChange(currentPage - 1)} 
                            disabled={currentPage === 1}
                            className="px-3 py-1 border rounded-lg hover:bg-slate-100 disabled:opacity-50 disabled:cursor-not-allowed"
                        >
                            Previous
                        </button>
                        <span>Page {currentPage} of {totalPages}</span>
                        <button 
                            onClick={() => onPageChange(currentPage + 1)} 
                            disabled={currentPage === totalPages}
                            className="px-3 py-1 border rounded-lg hover:bg-slate-100 disabled:opacity-50 disabled:cursor-not-allowed"
                        >
                            Next
                        </button>
                    </div>
                </div>
            );
        }
        // End: Pagination Component

        // --- Page Components ---
        // Start: PO Request Page
        function PORequestPage() {
            return (
                <div className="space-y-6">
                    <div className="bg-white p-4 sm:p-6 rounded-lg shadow">
                      <h2 className="text-xl font-bold text-slate-800 mb-4">Create Purchase Order</h2>
                      <p className="text-slate-600">The form for creating a new Purchase Order will be implemented here, following responsive design patterns for all fields and tables.</p>
                    </div>
                </div>
            );
        }
        // End: PO Request Page

        // Start: Drafts Page
        function DraftsPage() {
            return (
                <div className="space-y-6">
                     <div className="bg-white p-4 sm:p-6 rounded-lg shadow">
                      <h2 className="text-xl font-bold text-slate-800 mb-4">Drafts</h2>
                      <p className="text-slate-600">A responsive table listing all saved drafts will be implemented here.</p>
                    </div>
                </div>
            );
        }
        // End: Drafts Page

        // Start: PO Center Page
        function POCenterPage() {
            return (
                <div className="space-y-6">
                     <div className="bg-white p-4 sm:p-6 rounded-lg shadow">
                      <h2 className="text-xl font-bold text-slate-800 mb-4">Purchase Order Center</h2>
                      <p className="text-slate-600">Filters and a responsive table for all submitted Purchase Orders will be implemented here.</p>
                    </div>
                </div>
            );
        }
        // End: PO Center Page
        
        // Start: Vendor Settings Component (now part of ProductDataPage)
        function VendorSettings() {
            // Start: State and Hooks
            const { db } = useContext(AppContext);
            const { data: vendors, loading } = useFirestoreCollection('vendors');
            const [isModalOpen, setModalOpen] = useState(false);
            const [currentVendor, setCurrentVendor] = useState(null);
            const [isConfirmOpen, setConfirmOpen] = useState(false);
            const [vendorToDelete, setVendorToDelete] = useState(null);
            // End: State and Hooks

            // Start: Handlers
            const handleOpenModal = (vendor = null) => {
                setCurrentVendor(vendor);
                setModalOpen(true);
            };
            const handleCloseModal = () => {
                setModalOpen(false);
                setCurrentVendor(null);
            };
            const handleSaveVendor = async (vendorData) => {
                try {
                    if (currentVendor?.id) {
                        await db.collection('vendors').doc(currentVendor.id).update(vendorData);
                    } else {
                        await db.collection('vendors').add(vendorData);
                    }
                    handleCloseModal();
                } catch (error) {
                    console.error("Error saving vendor:", error);
                }
            };
            const handleDeleteClick = (vendor) => {
                setVendorToDelete(vendor);
                setConfirmOpen(true);
            };
            const handleConfirmDelete = async () => {
                if (!vendorToDelete) return;
                try {
                    await db.collection('vendors').doc(vendorToDelete.id).delete();
                    setConfirmOpen(false);
                    setVendorToDelete(null);
                } catch (error) {
                    console.error("Error deleting vendor:", error);
                }
            };
            // End: Handlers

            // Start: Render Logic
            return (
                <div>
                    <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 gap-4">
                        <h2 className="text-xl font-semibold text-slate-700">Manage Vendors</h2>
                        <button onClick={() => handleOpenModal()} className="w-full sm:w-auto px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 flex items-center justify-center gap-2">
                            <i className="fas fa-plus"></i> Add Vendor
                        </button>
                    </div>
                    <div className="bg-white rounded-lg shadow overflow-hidden">
                        <div className="overflow-x-auto">
                            <table className="w-full responsive-table">
                                <thead className="bg-slate-50">
                                    <tr>
                                        <th className="p-4 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">Vendor Name</th>
                                        <th className="p-4 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">Contact</th>
                                        <th className="p-4 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">Address</th>
                                        <th className="p-4 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">Actions</th>
                                    </tr>
                                </thead>
                                <tbody className="divide-y divide-slate-200">
                                    {loading ? (
                                        <tr><td colSpan="4" className="p-4 text-center text-slate-500">Loading...</td></tr>
                                    ) : vendors.map(vendor => (
                                        <tr key={vendor.id}>
                                            <td data-label="Vendor Name" className="p-4 whitespace-nowrap font-medium text-slate-900">{vendor.name}</td>
                                            <td data-label="Contact" className="p-4 whitespace-nowrap text-slate-600">{vendor.contact}</td>
                                            <td data-label="Address" className="p-4 whitespace-nowrap text-slate-600">{vendor.address}</td>
                                            <td data-label="Actions" className="p-4 whitespace-nowrap text-sm font-medium space-x-4">
                                                <button onClick={() => handleOpenModal(vendor)} className="text-indigo-600 hover:text-indigo-900">Edit</button>
                                                <button onClick={() => handleDeleteClick(vendor)} className="text-red-600 hover:text-red-900">Delete</button>
                                            </td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <VendorFormModal show={isModalOpen} onClose={handleCloseModal} onSave={handleSaveVendor} vendor={currentVendor} />
                    <ConfirmationModal show={isConfirmOpen} onClose={() => setConfirmOpen(false)} onConfirm={handleConfirmDelete} title="Delete Vendor" message={`Are you sure you want to delete vendor "${vendorToDelete?.name}"?`} />
                </div>
            );
            // End: Render Logic
        }
        // End: Vendor Settings Component

        // Start: Vendor Form Modal Component
        function VendorFormModal({ show, onClose, onSave, vendor }) {
            const [formData, setFormData] = useState({ name: '', contact: '', address: '' });
            useEffect(() => {
                if (show) {
                    setFormData({
                        name: vendor?.name || '',
                        contact: vendor?.contact || '',
                        address: vendor?.address || '',
                    });
                }
            }, [vendor, show]);

            const handleChange = (e) => {
                const { name, value } = e.target;
                setFormData(prev => ({ ...prev, [name]: value }));
            };

            const handleSubmit = (e) => {
                e.preventDefault();
                if (!formData.name) {
                    alert('Vendor name is required.');
                    return;
                }
                onSave(formData);
            };

            return (
                <Modal show={show} onClose={onClose} title={vendor ? 'Edit Vendor' : 'Add New Vendor'}>
                    <form onSubmit={handleSubmit}>
                        <div className="p-6 space-y-4">
                            <div>
                                <label className="block text-sm font-medium text-slate-700">Vendor Name</label>
                                <input type="text" name="name" value={formData.name} onChange={handleChange} required className="mt-1 block w-full border-slate-300 rounded-md shadow-sm" />
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-slate-700">Contact</label>
                                <input type="text" name="contact" value={formData.contact} onChange={handleChange} className="mt-1 block w-full border-slate-300 rounded-md shadow-sm" />
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-slate-700">Address</label>
                                <input type="text" name="address" value={formData.address} onChange={handleChange} className="mt-1 block w-full border-slate-300 rounded-md shadow-sm" />
                            </div>
                        </div>
                        <div className="bg-slate-50 p-4 flex justify-end gap-3 rounded-b-lg">
                            <button type="button" onClick={onClose} className="px-4 py-2 bg-slate-200 text-slate-800 rounded-lg hover:bg-slate-300 font-semibold">Cancel</button>
                            <button type="submit" className="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 font-semibold">Save</button>
                        </div>
                    </form>
                </Modal>
            );
        }
        // End: Vendor Form Modal Component

        // Start: Product Data Page
        function ProductDataPage() {
            const [currentTab, setCurrentTab] = useState('products');

            const renderTabContent = () => {
                switch(currentTab) {
                    case 'products': return <ProductList />;
                    case 'vendors': return <VendorSettings />;
                    default: return null;
                }
            }

            return (
                <div className="space-y-6">
                    <div className="bg-white rounded-lg shadow">
                        <div className="border-b border-slate-200">
                            <nav className="-mb-px flex space-x-4 sm:space-x-8 px-4 sm:px-6" aria-label="Tabs">
                                <button onClick={() => setCurrentTab('products')} className={`whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm ${currentTab === 'products' ? 'border-red-500 text-red-600' : 'border-transparent text-slate-500 hover:text-slate-700 hover:border-slate-300'}`}>
                                    Product List
                                </button>
                                <button onClick={() => setCurrentTab('vendors')} className={`whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm ${currentTab === 'vendors' ? 'border-red-500 text-red-600' : 'border-transparent text-slate-500 hover:text-slate-700 hover:border-slate-300'}`}>
                                    Vendor List
                                </button>
                            </nav>
                        </div>
                        <div className="p-4 sm:p-6">
                            {renderTabContent()}
                        </div>
                    </div>
                </div>
            );
        }
        // End: Product Data Page
        
        // Start: Product List Component (formerly ProductDataPage content)
        function ProductList() {
            // Start: State and Hooks
            const { db } = useContext(AppContext);
            const { data: products, loading: productsLoading } = useFirestoreCollection('products');
            const { data: vendors, loading: vendorsLoading } = useFirestoreCollection('vendors');
            const [isModalOpen, setModalOpen] = useState(false);
            const [currentProduct, setCurrentProduct] = useState(null);
            const [isConfirmOpen, setConfirmOpen] = useState(false);
            const [productToDelete, setProductToDelete] = useState(null);
            const [importStatus, setImportStatus] = useState('');
            const [importFile, setImportFile] = useState(null);
            const [currentPage, setCurrentPage] = useState(1);
            const [searchTerm, setSearchTerm] = useState('');
            const [selectedVendor, setSelectedVendor] = useState('');
            const itemsPerPage = 50;
            // End: State and Hooks
            
            // Start: Memoized Filtered and Paginated Data
            const filteredProducts = useMemo(() => {
                let filtered = products;
                const lowercasedSearch = searchTerm.toLowerCase();

                if (lowercasedSearch) {
                    filtered = filtered.filter(p => 
                        p['Product Code']?.toLowerCase().includes(lowercasedSearch) ||
                        p.Barcode?.toLowerCase().includes(lowercasedSearch) ||
                        p.Name?.toLowerCase().includes(lowercasedSearch)
                    );
                }

                if (selectedVendor) {
                    filtered = filtered.filter(p => p['Product Category'] === selectedVendor);
                }

                return filtered;
            }, [products, searchTerm, selectedVendor]);

            const paginatedProducts = useMemo(() => {
                const startIndex = (currentPage - 1) * itemsPerPage;
                return filteredProducts.slice(startIndex, startIndex + itemsPerPage);
            }, [filteredProducts, currentPage, itemsPerPage]);
            
            // Reset page to 1 when filters change
            useEffect(() => {
                setCurrentPage(1);
            }, [searchTerm, selectedVendor]);
            // End: Memoized Filtered and Paginated Data

            // Start: Handlers
            const handleOpenModal = (product = null) => {
                setCurrentProduct(product);
                setModalOpen(true);
            };

            const handleCloseModal = () => {
                setModalOpen(false);
                setCurrentProduct(null);
            };

            const handleSaveProduct = async (productData) => {
                try {
                    if (currentProduct?.id) {
                        await db.collection('products').doc(currentProduct.id).update(productData);
                    } else {
                        await db.collection('products').add(productData);
                    }
                    handleCloseModal();
                } catch (error) {
                    console.error("Error saving product:", error);
                    alert("Failed to save product. Check console for details.");
                }
            };

            const handleDeleteClick = (product) => {
                setProductToDelete(product);
                setConfirmOpen(true);
            };

            const handleConfirmDelete = async () => {
                if (!productToDelete) return;
                try {
                    await db.collection('products').doc(productToDelete.id).delete();
                    setConfirmOpen(false);
                    setProductToDelete(null);
                } catch (error) {
                    console.error("Error deleting product:", error);
                    alert("Failed to delete product. Check console for details.");
                }
            };
            
            const handleDownloadTemplate = () => {
                const templateData = [{
                    "Product Code": "SKU001",
                    "Barcode": "1234567890123",
                    "Name": "Sample Product",
                    "Product Category": "Sample Vendor",
                    "Cost": 10.50,
                    "Price": 19.99
                }];
                const worksheet = XLSX.utils.json_to_sheet(templateData);
                const workbook = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(workbook, worksheet, "Product Template");
                XLSX.writeFile(workbook, "Product_Import_Template.xlsx");
            };

            const handleImportProducts = () => {
                if (!importFile) {
                    setImportStatus({ message: 'Please select a file first.', type: 'error' });
                    return;
                }
                const reader = new FileReader();
                reader.onload = async (e) => {
                    try {
                        setImportStatus({ message: 'Reading file...', type: 'info' });
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        const worksheet = workbook.Sheets[workbook.SheetNames[0]];
                        const productsFromFile = XLSX.utils.sheet_to_json(worksheet);

                        if (productsFromFile.length === 0) {
                             setImportStatus({ message: 'No products found in the file.', type: 'warning' });
                             return;
                        }

                        setImportStatus({ message: `Found ${productsFromFile.length} products. Checking against database...`, type: 'info' });
                        
                        const productsRef = db.collection('products');
                        const existingProductsSnapshot = await productsRef.get();
                        const existingProductsMap = new Map();
                        existingProductsSnapshot.forEach(doc => {
                            existingProductsMap.set(doc.data()['Product Code'], doc.id);
                        });

                        const batch = db.batch();
                        let updatedCount = 0;
                        let newCount = 0;

                        productsFromFile.forEach(product => {
                            const productCode = product['Product Code']?.toString().trim();
                            if (!productCode) return; // Skip rows without a product code

                            const productData = {
                                'Product Code': productCode,
                                'Barcode': product['Barcode']?.toString() || '',
                                'Name': product['Name'] || '',
                                'Product Category': product['Product Category'] || '',
                                'Cost': parseFloat(product['Cost']) || 0,
                                'Price': parseFloat(product['Price']) || 0,
                            };

                            const existingId = existingProductsMap.get(productCode);
                            if (existingId) {
                                batch.update(productsRef.doc(existingId), productData);
                                updatedCount++;
                            } else {
                                batch.set(productsRef.doc(), productData);
                                newCount++;
                            }
                        });

                        await batch.commit();
                        setImportStatus({ message: `Import complete! ${newCount} added, ${updatedCount} updated.`, type: 'success' });
                        setImportFile(null);
                        document.getElementById('import-file-input').value = ''; // Reset file input
                    } catch (error) {
                        console.error("Error importing products:", error);
                        setImportStatus({ message: `Error: ${error.message}`, type: 'error' });
                    }
                };
                reader.readAsArrayBuffer(importFile);
            };

            const handleExport = () => {
                const dataToExport = products.map(p => ({
                    'Product Code': p['Product Code'],
                    'Barcode': p.Barcode,
                    'Name': p.Name,
                    'Product Category': p['Product Category'],
                    'Cost': p.Cost,
                    'Price': p.Price
                }));
                const worksheet = XLSX.utils.json_to_sheet(dataToExport);
                const workbook = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(workbook, worksheet, "Products");
                XLSX.writeFile(workbook, "Products_Export.xlsx");
            };
            // End: Handlers

            // Start: Render Logic
            return (
                <div className="space-y-6">
                    <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 gap-4">
                        <h2 className="text-xl font-semibold text-slate-700">Product List</h2>
                        <div className="w-full sm:w-auto flex flex-col sm:flex-row gap-2">
                            <button onClick={() => handleOpenModal()} className="w-full sm:w-auto px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 flex items-center justify-center gap-2">
                                <i className="fas fa-plus"></i> Add Product
                            </button>
                            <button onClick={handleExport} className="w-full sm:w-auto px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 flex items-center justify-center gap-2">
                                <i className="fas fa-file-export"></i> Export
                            </button>
                        </div>
                    </div>
                    
                    <div className="bg-slate-50 p-4 rounded-lg border border-slate-200 mb-6">
                        <h3 className="font-semibold text-slate-700 mb-2">Filters & Search</h3>
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <input 
                                type="text" 
                                placeholder="Search by code, barcode, or name..."
                                value={searchTerm}
                                onChange={(e) => setSearchTerm(e.target.value)}
                                className="w-full border-slate-300 rounded-md shadow-sm"
                            />
                            <select
                                value={selectedVendor}
                                onChange={(e) => setSelectedVendor(e.target.value)}
                                className="w-full border-slate-300 rounded-md shadow-sm"
                            >
                                <option value="">All Vendors</option>
                                {vendors.map(v => <option key={v.id} value={v.name}>{v.name}</option>)}
                            </select>
                        </div>
                    </div>

                    <div className="bg-slate-50 p-4 rounded-lg border border-slate-200 mb-6">
                        <h3 className="font-semibold text-slate-700 mb-2">Bulk Import</h3>
                        <div className="flex flex-col md:flex-row items-center gap-4">
                            <input id="import-file-input" type="file" onChange={(e) => setImportFile(e.target.files[0])} accept=".xlsx, .xls, .csv" className="w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-red-50 file:text-red-700 hover:file:bg-red-100"/>
                            <div className="w-full md:w-auto flex gap-2">
                                <button onClick={handleImportProducts} className="flex-1 px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">Import</button>
                                <button onClick={handleDownloadTemplate} className="flex-1 px-4 py-2 bg-slate-200 text-slate-800 rounded-lg hover:bg-slate-300">Template</button>
                            </div>
                        </div>
                        {importStatus && (
                            <p className={`mt-2 text-sm ${
                                importStatus.type === 'error' ? 'text-red-600' :
                                importStatus.type === 'success' ? 'text-green-600' : 'text-slate-600'
                            }`}>{importStatus.message}</p>
                        )}
                    </div>

                    <div className="overflow-x-auto">
                        <table className="w-full responsive-table">
                            <thead className="bg-slate-50">
                                <tr>
                                    <th className="p-4 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">Product Code</th>
                                    <th className="p-4 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">Barcode</th>
                                    <th className="p-4 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">Product Name</th>
                                    <th className="p-4 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">Vendor</th>
                                    <th className="p-4 text-right text-xs font-semibold text-slate-500 uppercase tracking-wider">Cost</th>
                                    <th className="p-4 text-right text-xs font-semibold text-slate-500 uppercase tracking-wider">Price</th>
                                    <th className="p-4 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">Actions</th>
                                </tr>
                            </thead>
                            <tbody className="divide-y divide-slate-200">
                                {productsLoading ? (
                                    <tr><td colSpan="7" className="p-4 text-center text-slate-500">Loading Products...</td></tr>
                                ) : paginatedProducts.map(product => (
                                    <tr key={product.id}>
                                        <td data-label="Product Code" className="p-4 whitespace-nowrap text-slate-600">{product['Product Code']}</td>
                                        <td data-label="Barcode" className="p-4 whitespace-nowrap text-slate-600">{product.Barcode}</td>
                                        <td data-label="Product Name" className="p-4 whitespace-nowrap font-medium text-slate-900">{product.Name}</td>
                                        <td data-label="Vendor" className="p-4 whitespace-nowrap text-slate-600">{product['Product Category']}</td>
                                        <td data-label="Cost" className="p-4 whitespace-nowrap text-right text-slate-600">{product.Cost?.toFixed(2)}</td>
                                        <td data-label="Price" className="p-4 whitespace-nowrap text-right text-slate-600">{product.Price?.toFixed(2)}</td>
                                        <td data-label="Actions" className="p-4 whitespace-nowrap text-sm font-medium space-x-4">
                                            <button onClick={() => handleOpenModal(product)} className="text-indigo-600 hover:text-indigo-900">Edit</button>
                                            <button onClick={() => handleDeleteClick(product)} className="text-red-600 hover:text-red-900">Delete</button>
                                        </td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                    <Pagination 
                        currentPage={currentPage}
                        totalItems={filteredProducts.length}
                        itemsPerPage={itemsPerPage}
                        onPageChange={setCurrentPage}
                    />
                    <ProductFormModal
                        show={isModalOpen}
                        onClose={handleCloseModal}
                        onSave={handleSaveProduct}
                        product={currentProduct}
                        allVendors={vendors}
                    />
                    <ConfirmationModal
                        show={isConfirmOpen}
                        onClose={() => setConfirmOpen(false)}
                        onConfirm={handleConfirmDelete}
                        title="Delete Product"
                        message={`Are you sure you want to delete the product "${productToDelete?.Name}"? This action cannot be undone.`}
                    />
                </div>
            );
            // End: Render Logic
        }
        // End: Product List Component
        
        // Start: Product Form Modal Component
        function ProductFormModal({ show, onClose, onSave, product, allVendors }) {
            // Start: State and Effect
            const [formData, setFormData] = useState({
                'Product Code': '',
                'Barcode': '',
                'Name': '',
                'Product Category': '',
                'Cost': 0,
                'Price': 0,
            });

            useEffect(() => {
                if (show) {
                    setFormData({
                        'Product Code': product?.['Product Code'] || '',
                        'Barcode': product?.['Barcode'] || '',
                        'Name': product?.['Name'] || '',
                        'Product Category': product?.['Product Category'] || '',
                        'Cost': product?.['Cost'] || 0,
                        'Price': product?.['Price'] || 0,
                    });
                }
            }, [product, show]);
            // End: State and Effect

            // Start: Handlers
            const handleChange = (e) => {
                const { name, value, type } = e.target;
                setFormData(prev => ({
                    ...prev,
                    [name]: type === 'number' ? parseFloat(value) || 0 : value
                }));
            };

            const handleSubmit = (e) => {
                e.preventDefault();
                if (!formData['Product Code'] || !formData.Name) {
                    alert('Product Code and Name are required.');
                    return;
                }
                onSave(formData);
            };
            // End: Handlers
            
            // Start: Render Logic
            return (
                <Modal show={show} onClose={onClose} title={product ? 'Edit Product' : 'Add New Product'} maxWidth="max-w-2xl">
                    <form onSubmit={handleSubmit}>
                        <div className="p-6 grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label className="block text-sm font-medium text-slate-700">Product Code</label>
                                <input type="text" name="Product Code" value={formData['Product Code']} onChange={handleChange} required className="mt-1 block w-full border-slate-300 rounded-md shadow-sm" />
                            </div>
                             <div>
                                <label className="block text-sm font-medium text-slate-700">Barcode</label>
                                <input type="text" name="Barcode" value={formData.Barcode} onChange={handleChange} className="mt-1 block w-full border-slate-300 rounded-md shadow-sm" />
                            </div>
                            <div className="md:col-span-2">
                                <label className="block text-sm font-medium text-slate-700">Product Name</label>
                                <input type="text" name="Name" value={formData.Name} onChange={handleChange} required className="mt-1 block w-full border-slate-300 rounded-md shadow-sm" />
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-slate-700">Vendor</label>
                                <select name="Product Category" value={formData['Product Category']} onChange={handleChange} className="mt-1 block w-full border-slate-300 rounded-md shadow-sm">
                                    <option value="">Select a vendor</option>
                                    {allVendors.map(vendor => (
                                        <option key={vendor.id} value={vendor.name}>{vendor.name}</option>
                                    ))}
                                </select>
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-slate-700">Cost</label>
                                <input type="number" step="0.01" name="Cost" value={formData.Cost} onChange={handleChange} className="mt-1 block w-full border-slate-300 rounded-md shadow-sm" />
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-slate-700">Price</label>
                                <input type="number" step="0.01" name="Price" value={formData.Price} onChange={handleChange} className="mt-1 block w-full border-slate-300 rounded-md shadow-sm" />
                            </div>
                        </div>
                        <div className="bg-slate-50 p-4 flex justify-end gap-3 rounded-b-lg">
                            <button type="button" onClick={onClose} className="px-4 py-2 bg-slate-200 text-slate-800 rounded-lg hover:bg-slate-300 font-semibold">
                                Cancel
                            </button>
                            <button type="submit" className="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 font-semibold">
                                Save
                            </button>
                        </div>
                    </form>
                </Modal>
            );
            // End: Render Logic
        }
        // End: Product Form Modal Component

        // Start: Shop Settings Component
        function ShopSettings() {
            // Start: State and Hooks
            const { db } = useContext(AppContext);
            const { data: shops, loading } = useFirestoreCollection('shops');
            const [isModalOpen, setModalOpen] = useState(false);
            const [currentShop, setCurrentShop] = useState(null); // null for new, object for edit
            const [isConfirmOpen, setConfirmOpen] = useState(false);
            const [shopToDelete, setShopToDelete] = useState(null);
            // End: State and Hooks

            // Start: Handlers
            const handleOpenModal = (shop = null) => {
                setCurrentShop(shop);
                setModalOpen(true);
            };

            const handleCloseModal = () => {
                setModalOpen(false);
                setCurrentShop(null);
            };

            const handleSaveShop = async (shopData) => {
                try {
                    if (currentShop?.id) {
                        // Update existing shop
                        await db.collection('shops').doc(currentShop.id).update(shopData);
                    } else {
                        // Add new shop
                        await db.collection('shops').add(shopData);
                    }
                    handleCloseModal();
                } catch (error) {
                    console.error("Error saving shop:", error);
                    alert("Failed to save shop. Check console for details.");
                }
            };

            const handleDeleteClick = (shop) => {
                setShopToDelete(shop);
                setConfirmOpen(true);
            };

            const handleConfirmDelete = async () => {
                if (!shopToDelete) return;
                try {
                    await db.collection('shops').doc(shopToDelete.id).delete();
                    setConfirmOpen(false);
                    setShopToDelete(null);
                } catch (error) {
                    console.error("Error deleting shop:", error);
                    alert("Failed to delete shop. Check console for details.");
                }
            };
            // End: Handlers

            // Start: Render Logic
            return (
                <div>
                    <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 gap-4">
                        <h2 className="text-xl font-semibold text-slate-700">Manage Shops</h2>
                        <button onClick={() => handleOpenModal()} className="w-full sm:w-auto px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 flex items-center justify-center gap-2">
                            <i className="fas fa-plus"></i> Add Shop
                        </button>
                    </div>
                    <div className="bg-white rounded-lg shadow overflow-hidden">
                        <div className="overflow-x-auto">
                            <table className="w-full responsive-table">
                                <thead className="bg-slate-50">
                                    <tr>
                                        <th className="p-4 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">Shop Name</th>
                                        <th className="p-4 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">Address</th>
                                        <th className="p-4 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">Contact</th>
                                        <th className="p-4 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">Actions</th>
                                    </tr>
                                </thead>
                                <tbody className="divide-y divide-slate-200">
                                    {loading ? (
                                        <tr><td colSpan="4" className="p-4 text-center text-slate-500">Loading...</td></tr>
                                    ) : shops.length === 0 ? (
                                        <tr><td colSpan="4" className="p-4 text-center text-slate-500">No shops found.</td></tr>
                                    ) : (
                                        shops.map(shop => (
                                            <tr key={shop.id}>
                                                <td data-label="Shop Name" className="p-4 whitespace-nowrap font-medium text-slate-900">{shop.name}</td>
                                                <td data-label="Address" className="p-4 whitespace-nowrap text-slate-600">{shop.address}</td>
                                                <td data-label="Contact" className="p-4 whitespace-nowrap text-slate-600">{shop.contact}</td>
                                                <td data-label="Actions" className="p-4 whitespace-nowrap text-sm font-medium space-x-4">
                                                    <button onClick={() => handleOpenModal(shop)} className="text-indigo-600 hover:text-indigo-900">Edit</button>
                                                    <button onClick={() => handleDeleteClick(shop)} className="text-red-600 hover:text-red-900">Delete</button>
                                                </td>
                                            </tr>
                                        ))
                                    )}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <ShopFormModal
                        show={isModalOpen}
                        onClose={handleCloseModal}
                        onSave={handleSaveShop}
                        shop={currentShop}
                    />
                    <ConfirmationModal
                        show={isConfirmOpen}
                        onClose={() => setConfirmOpen(false)}
                        onConfirm={handleConfirmDelete}
                        title="Delete Shop"
                        message={`Are you sure you want to delete the shop "${shopToDelete?.name}"? This action cannot be undone.`}
                    />
                </div>
            );
            // End: Render Logic
        }
        // End: Shop Settings Component

        // Start: Shop Form Modal Component
        function ShopFormModal({ show, onClose, onSave, shop }) {
            // Start: State and Effect
            const [name, setName] = useState('');
            const [address, setAddress] = useState('');
            const [contact, setContact] = useState('');

            useEffect(() => {
                if (show) {
                    setName(shop?.name || '');
                    setAddress(shop?.address || '');
                    setContact(shop?.contact || '');
                }
            }, [shop, show]);
            // End: State and Effect

            // Start: Handler
            const handleSubmit = (e) => {
                e.preventDefault();
                if (!name) {
                    alert('Shop name is required.');
                    return;
                }
                onSave({ name, address, contact });
            };
            // End: Handler

            // Start: Render Logic
            return (
                <Modal show={show} onClose={onClose} title={shop ? 'Edit Shop' : 'Add New Shop'}>
                    <form onSubmit={handleSubmit}>
                        <div className="p-6 space-y-4">
                            <div>
                                <label htmlFor="shop-name" className="block text-sm font-medium text-slate-700">Shop Name</label>
                                <input type="text" id="shop-name" value={name} onChange={e => setName(e.target.value)} required className="mt-1 block w-full border-slate-300 rounded-md shadow-sm focus:ring-red-500 focus:border-red-500" />
                            </div>
                            <div>
                                <label htmlFor="shop-address" className="block text-sm font-medium text-slate-700">Address</label>
                                <input type="text" id="shop-address" value={address} onChange={e => setAddress(e.target.value)} className="mt-1 block w-full border-slate-300 rounded-md shadow-sm focus:ring-red-500 focus:border-red-500" />
                            </div>
                            <div>
                                <label htmlFor="shop-contact" className="block text-sm font-medium text-slate-700">Contact</label>
                                <input type="text" id="shop-contact" value={contact} onChange={e => setContact(e.target.value)} className="mt-1 block w-full border-slate-300 rounded-md shadow-sm focus:ring-red-500 focus:border-red-500" />
                            </div>
                        </div>
                        <div className="bg-slate-50 p-4 flex justify-end gap-3 rounded-b-lg">
                            <button type="button" onClick={onClose} className="px-4 py-2 bg-slate-200 text-slate-800 rounded-lg hover:bg-slate-300 font-semibold">
                                Cancel
                            </button>
                            <button type="submit" className="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 font-semibold">
                                Save
                            </button>
                        </div>
                    </form>
                </Modal>
            );
            // End: Render Logic
        }
        // End: Shop Form Modal Component

        // Start: Employee Settings Component
        function EmployeeSettings() {
            // Start: State and Hooks
            const { db } = useContext(AppContext);
            const { data: employees, loading: employeesLoading } = useFirestoreCollection('employees');
            const { data: shops, loading: shopsLoading } = useFirestoreCollection('shops');
            const [isModalOpen, setModalOpen] = useState(false);
            const [currentEmployee, setCurrentEmployee] = useState(null);
            const [isConfirmOpen, setConfirmOpen] = useState(false);
            const [employeeToDelete, setEmployeeToDelete] = useState(null);
            // End: State and Hooks

            // Start: Handlers
            const handleOpenModal = (employee = null) => {
                setCurrentEmployee(employee);
                setModalOpen(true);
            };

            const handleCloseModal = () => {
                setModalOpen(false);
                setCurrentEmployee(null);
            };

            const handleSaveEmployee = async (employeeData) => {
                try {
                    if (currentEmployee?.id) {
                        await db.collection('employees').doc(currentEmployee.id).update(employeeData);
                    } else {
                        await db.collection('employees').add(employeeData);
                    }
                    handleCloseModal();
                } catch (error) {
                    console.error("Error saving employee:", error);
                    alert("Failed to save employee. Check console for details.");
                }
            };
            
            const handleDeleteClick = (employee) => {
                setEmployeeToDelete(employee);
                setConfirmOpen(true);
            };

            const handleConfirmDelete = async () => {
                if (!employeeToDelete) return;
                try {
                    await db.collection('employees').doc(employeeToDelete.id).delete();
                    setConfirmOpen(false);
                    setEmployeeToDelete(null);
                } catch (error) {
                    console.error("Error deleting employee:", error);
                    alert("Failed to delete employee. Check console for details.");
                }
            };
            // End: Handlers

            // Start: Render Logic
            return (
                <div>
                    <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 gap-4">
                        <h2 className="text-xl font-semibold text-slate-700">Manage Employees</h2>
                        <button onClick={() => handleOpenModal()} className="w-full sm:w-auto px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 flex items-center justify-center gap-2">
                            <i className="fas fa-user-plus"></i> Add Employee
                        </button>
                    </div>
                    <div className="bg-white rounded-lg shadow overflow-hidden">
                        <div className="overflow-x-auto">
                            <table className="w-full responsive-table">
                                <thead className="bg-slate-50">
                                    <tr>
                                        <th className="p-4 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">Name</th>
                                        <th className="p-4 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">Email</th>
                                        <th className="p-4 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">Role</th>
                                        <th className="p-4 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">Assigned Shops</th>
                                        <th className="p-4 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">Actions</th>
                                    </tr>
                                </thead>
                                <tbody className="divide-y divide-slate-200">
                                    {employeesLoading ? (
                                        <tr><td colSpan="5" className="p-4 text-center text-slate-500">Loading...</td></tr>
                                    ) : employees.length === 0 ? (
                                        <tr><td colSpan="5" className="p-4 text-center text-slate-500">No employees found.</td></tr>
                                    ) : (
                                        employees.map(employee => (
                                            <tr key={employee.id}>
                                                <td data-label="Name" className="p-4 whitespace-nowrap font-medium text-slate-900">{employee.name}</td>
                                                <td data-label="Email" className="p-4 whitespace-nowrap text-slate-600">{employee.email}</td>
                                                <td data-label="Role" className="p-4 whitespace-nowrap text-slate-600">{employee.role}</td>
                                                <td data-label="Assigned Shops" className="p-4 whitespace-nowrap text-slate-600">
                                                    {employee.assignedShops?.join(', ') || 'None'}
                                                </td>
                                                <td data-label="Actions" className="p-4 whitespace-nowrap text-sm font-medium space-x-4">
                                                    <button onClick={() => handleOpenModal(employee)} className="text-indigo-600 hover:text-indigo-900">Edit</button>
                                                    <button onClick={() => handleDeleteClick(employee)} className="text-red-600 hover:text-red-900">Delete</button>
                                                </td>
                                            </tr>
                                        ))
                                    )}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <EmployeeFormModal
                        show={isModalOpen}
                        onClose={handleCloseModal}
                        onSave={handleSaveEmployee}
                        employee={currentEmployee}
                        allShops={shops}
                    />
                    <ConfirmationModal
                        show={isConfirmOpen}
                        onClose={() => setConfirmOpen(false)}
                        onConfirm={handleConfirmDelete}
                        title="Delete Employee"
                        message={`Are you sure you want to delete the employee "${employeeToDelete?.name}"? This action cannot be undone.`}
                    />
                </div>
            );
            // End: Render Logic
        }
        // End: Employee Settings Component
        
        // Start: Employee Form Modal Component
        function EmployeeFormModal({ show, onClose, onSave, employee, allShops }) {
            // Start: State and Effect
            const [formData, setFormData] = useState({
                uid: '',
                name: '',
                position: '',
                email: '',
                role: 'Staff',
                assignedShops: [],
                permissions: [],
            });
            
            const pagePermissionsList = [
                { id: 'po-request-form', name: 'PO Request' },
                { id: 'drafts-page', name: 'Drafts' },
                { id: 'purchase-order', name: 'POs Center' },
                { id: 'product-data-page', name: 'Product Data' },
                { id: 'setting-page', name: 'Settings' },
            ];

            useEffect(() => {
                if (show) {
                    setFormData({
                        uid: employee?.uid || '',
                        name: employee?.name || '',
                        position: employee?.position || '',
                        email: employee?.email || '',
                        role: employee?.role || 'Staff',
                        assignedShops: employee?.assignedShops || [],
                        permissions: employee?.permissions || [],
                    });
                }
            }, [employee, show]);
            // End: State and Effect

            // Start: Handlers
            const handleChange = (e) => {
                const { name, value } = e.target;
                setFormData(prev => ({ ...prev, [name]: value }));
            };

            const handleCheckboxChange = (e) => {
                const { name, value, checked } = e.target;
                setFormData(prev => {
                    const currentValues = prev[name] || [];
                    if (checked) {
                        return { ...prev, [name]: [...currentValues, value] };
                    } else {
                        return { ...prev, [name]: currentValues.filter(item => item !== value) };
                    }
                });
            };

            const generateUid = () => {
                const uid = `temp_${new Date().getTime()}_${Math.random().toString(36).substr(2, 9)}`;
                setFormData(prev => ({ ...prev, uid }));
            };

            const handleSubmit = (e) => {
                e.preventDefault();
                if (!formData.name || !formData.email || !formData.uid) {
                    alert('UID, Name, and Email are required.');
                    return;
                }
                onSave(formData);
            };
            // End: Handlers

            // Start: Render Logic
            return (
                <Modal show={show} onClose={onClose} title={employee ? 'Edit Employee' : 'Add New Employee'} maxWidth="max-w-2xl">
                    <form onSubmit={handleSubmit}>
                        <div className="p-6 space-y-4 max-h-[70vh] overflow-y-auto">
                            <div>
                                <label className="block text-sm font-medium text-slate-700">User ID (UID)</label>
                                <div className="mt-1 flex rounded-md shadow-sm">
                                    <input type="text" name="uid" value={formData.uid} onChange={handleChange} required className="block w-full rounded-none rounded-l-md border-slate-300 focus:ring-red-500 focus:border-red-500" />
                                    <button type="button" onClick={generateUid} className="relative -ml-px inline-flex items-center space-x-2 rounded-r-md border border-slate-300 bg-slate-50 px-4 py-2 text-sm font-medium text-slate-700 hover:bg-slate-100">
                                        <span>Generate</span>
                                    </button>
                                </div>
                            </div>
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label className="block text-sm font-medium text-slate-700">Name</label>
                                    <input type="text" name="name" value={formData.name} onChange={handleChange} required className="mt-1 block w-full border-slate-300 rounded-md shadow-sm" />
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-slate-700">Position</label>
                                    <input type="text" name="position" value={formData.position} onChange={handleChange} className="mt-1 block w-full border-slate-300 rounded-md shadow-sm" />
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-slate-700">Email</label>
                                    <input type="email" name="email" value={formData.email} onChange={handleChange} required className="mt-1 block w-full border-slate-300 rounded-md shadow-sm" />
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-slate-700">Role</label>
                                    <select name="role" value={formData.role} onChange={handleChange} className="mt-1 block w-full border-slate-300 rounded-md shadow-sm">
                                        <option>Staff</option>
                                        <option>Manager</option>
                                        <option>Admin</option>
                                    </select>
                                </div>
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-slate-700">Assigned Shops</label>
                                <div className="mt-2 grid grid-cols-2 sm:grid-cols-3 gap-2 border border-slate-200 p-3 rounded-lg max-h-32 overflow-y-auto">
                                    {allShops.map(shop => (
                                        <label key={shop.id} className="flex items-center space-x-2">
                                            <input type="checkbox" name="assignedShops" value={shop.name} checked={formData.assignedShops.includes(shop.name)} onChange={handleCheckboxChange} className="rounded border-slate-300 text-red-600 shadow-sm" />
                                            <span className="text-sm text-slate-700">{shop.name}</span>
                                        </label>
                                    ))}
                                </div>
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-slate-700">Page Permissions</label>
                                <div className="mt-2 grid grid-cols-2 sm:grid-cols-3 gap-2 border border-slate-200 p-3 rounded-lg">
                                    {pagePermissionsList.map(page => (
                                         <label key={page.id} className="flex items-center space-x-2">
                                            <input type="checkbox" name="permissions" value={page.id} checked={formData.permissions.includes(page.id)} onChange={handleCheckboxChange} className="rounded border-slate-300 text-red-600 shadow-sm" />
                                            <span className="text-sm text-slate-700">{page.name}</span>
                                        </label>
                                    ))}
                                </div>
                            </div>
                        </div>
                        <div className="bg-slate-50 p-4 flex justify-end gap-3 rounded-b-lg">
                            <button type="button" onClick={onClose} className="px-4 py-2 bg-slate-200 text-slate-800 rounded-lg hover:bg-slate-300 font-semibold">
                                Cancel
                            </button>
                            <button type="submit" className="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 font-semibold">
                                Save
                            </button>
                        </div>
                    </form>
                </Modal>
            );
            // End: Render Logic
        }
        // End: Employee Form Modal Component

        // Start: Settings Page
        function SettingsPage() {
            const [currentTab, setCurrentTab] = useState('shops');
            
            const renderTabContent = () => {
                switch(currentTab) {
                    case 'shops': return <ShopSettings />;
                    case 'employees': return <EmployeeSettings />;
                    default: return null;
                }
            }

            return (
                <div className="space-y-6">
                    <div className="bg-white rounded-lg shadow">
                        <div className="border-b border-slate-200">
                            <nav className="-mb-px flex space-x-4 sm:space-x-8 px-4 sm:px-6" aria-label="Tabs">
                                <button onClick={() => setCurrentTab('shops')} className={`whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm ${currentTab === 'shops' ? 'border-red-500 text-red-600' : 'border-transparent text-slate-500 hover:text-slate-700 hover:border-slate-300'}`}>
                                    Shop List
                                </button>
                                <button onClick={() => setCurrentTab('employees')} className={`whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm ${currentTab === 'employees' ? 'border-red-500 text-red-600' : 'border-transparent text-slate-500 hover:text-slate-700 hover:border-slate-300'}`}>
                                    Employees
                                </button>
                            </nav>
                        </div>
                        <div className="p-4 sm:p-6">
                            {renderTabContent()}
                        </div>
                    </div>
                </div>
            );
        }
        // End: Settings Page

        // --- Render the App ---
        const container = document.getElementById('root');
        const root = ReactDOM.createRoot(container);
        root.render(<App />);

    </script>
</body>
</html>
