<!DOCTYPE html>
<html lang="en" class="h-full bg-slate-900"
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JLW Management System</title>
    
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#2563eb">
    <link rel="manifest" id="manifest">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="CashFlow">
    <link rel="apple-touch-icon" href="https://i.imgur.com/Ahdcb2w.png">
    
    <!-- External Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@17/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@17/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <!-- App Styles -->
    <style>
        body { background-color: #0f172a; font-family: 'Inter', sans-serif; }
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');
        
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .animate-spin { animation: spin 1s linear infinite; }

        .modal-enter { animation: modal-enter 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94) both; }
        @keyframes modal-enter {
            0% { opacity: 0; transform: translateY(20px) scale(0.95); }
            100% { opacity: 1; transform: translateY(0) scale(1); }
        }

        .notification-enter { animation: notification-enter 0.4s ease-out; }
        @keyframes notification-enter {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1e293b; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #64748b; }
    </style>
</head>
<body class="h-full">
    <div id="root" class="h-full"></div>

    <script type="module">
        // Firebase v9 Modular Imports
        import { initializeApp, deleteApp } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-app.js";
        import { getFirestore, collection, onSnapshot, doc, addDoc, updateDoc, deleteDoc, Timestamp, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore.js";
        import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut, setPersistence, browserSessionPersistence, browserLocalPersistence, createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyA4upjtl0UFToWSfRZEiEQvwz9ieFLfqhI",
            authDomain: "cashflow-mgr.firebaseapp.com",
            projectId: "cashflow-mgr",
            storageBucket: "cashflow-mgr.appspot.com",
            messagingSenderId: "873891130920",
            appId: "1:873891130920:web:b6b8f0432943c33a930f1d",
            measurementId: "G-LVLMJ8ZY0B"
        };

        // Initialize Firebase and make services globally available for Babel
        const app = initializeApp(firebaseConfig);
        window.db = getFirestore(app);
        window.auth = getAuth(app);
        window.Firebase = {
            Timestamp, onAuthStateChanged, signInWithEmailAndPassword, signOut,
            collection, onSnapshot, doc, addDoc, updateDoc, deleteDoc, setDoc, getDoc,
            setPersistence, browserSessionPersistence, browserLocalPersistence,
            createUserWithEmailAndPassword,
            initializeApp, deleteApp, // <-- ADDED for temp auth
            getAuth // <-- FIX: Added getAuth here
        };
    </script>
    
    <script type="text/babel">
        const { useState, useEffect, useMemo, useCallback, createContext, useContext, useRef } = React;
        
        // =================================================================================
        // #region 1. CONSTANTS & HELPERS
        // =================================================================================
        const CONSTANTS = {
            NAV_ITEMS: [
                { id: 'dashboard', label: 'Dashboard', icon: 'PieChart' }, // <--- NEW DASHBOARD
                { id: 'cashDrop', label: 'Cash Drop Report', icon: 'Droplets' },
                { id: 'saleReport', label: 'Sale Report', icon: 'BarChart3' }, 
                { id: 'purchaseOrder', label: 'Purchase Order', icon: 'ShoppingCart' },
                { id: 'expenseReport', label: 'Expense Report', icon: 'CreditCard' },
                { id: 'cashflowReport', label: 'CashFlow Report', icon: 'Landmark' }, // Changed Icon to distinguish
                { id: 'settings', label: 'Settings', icon: 'Settings' },
            ],
            ALL_PAGES: [
                { id: 'dashboard', label: 'Dashboard' }, // <--- NEW
                { id: 'cashDrop', label: 'Cash Drop Report' }, 
                { id: 'saleReport', label: 'Sale Report' },
                { id: 'purchaseOrder', label: 'Purchase Order' },
                { id: 'expenseReport', label: 'Expense Report' }, 
                { id: 'cashflowReport', label: 'CashFlow Report' }, 
                { id: 'settings', label: 'Settings' },
            ],
            MAKE_WEBHOOK_URL: 'https://hook.eu2.make.com/zdwmgoi1rnj2n5u1c74uzw93zhx4mvxe'
        };

        const getCambodiaISODate = (date = new Date()) => date.toLocaleDateString('en-CA', { timeZone: 'Asia/Phnom_Penh' });
        const formatInCambodiaTime = (ts) => ts?.toDate ? ts.toDate().toLocaleString('en-GB', { timeZone: 'Asia/Phnom_Penh', year: '2-digit', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit', hour12: true }).replace(',', '') : 'N/A';
        const formatInCambodiaDateOnly = (ts) => ts?.toDate ? ts.toDate().toLocaleDateString('en-GB', { timeZone: 'Asia/Phnom_Penh' }).split('/').reverse().join('-') : 'N/A';
        const createTimestampFromDateAndCurrentTime = (dateString) => {
            const now = new Date();
            const [year, month, day] = dateString.split('-').map(Number);
            const combinedDate = new Date(year, month - 1, day, now.getHours(), now.getMinutes(), now.getSeconds());
            return window.Firebase.Timestamp.fromDate(combinedDate);
        };
        const parseFormattedNumber = (val) => parseFloat(String(val).replace(/,/g, '')) || 0;
        const formatCurrency = (val, currency = 'KHR') => {
            const num = parseFormattedNumber(val);
            if (currency === 'KHR') {
                return `${num.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}៛`;
            }
            return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', minimumFractionDigits: 2 }).format(num);
        };
        
        const exportToExcel = (data, filename, sheetName = 'Sheet1') => {
            if (!window.XLSX) {
                console.error("Excel library not loaded yet.");
                return false;
            }
            const ws = window.XLSX.utils.json_to_sheet(data);
            const wb = window.XLSX.utils.book_new();
            window.XLSX.utils.book_append_sheet(wb, ws, sheetName);
            window.XLSX.writeFile(wb, filename);
            return true;
        };
        // #endregion

        // =================================================================================
        // #region CUSTOM HOOKS
        // =================================================================================
        const useFirestoreMutation = ({ onSuccess, onError }) => {
            const [isMutating, setIsMutating] = useState(false);
            const { showNotification } = useNotification();

            const execute = useCallback(async (mutationFn, successMessage) => {
                setIsMutating(true);
                try {
                    await mutationFn();
                    if (successMessage) showNotification(successMessage, 'success');
                    if (onSuccess) onSuccess();
                } catch (error) {
                    console.error("Firestore Mutation Error:", error);
                    showNotification(error.message || "An error occurred.", "error");
                    if (onError) onError(error);
                } finally {
                    setIsMutating(false);
                }
            }, [onSuccess, onError, showNotification]);

            return { execute, isMutating };
        };
        
        const useDataTable = (initialData, initialConfig = {}) => {
            const {
                initialFilters = {},
                initialRowsPerPage = 10,
                filterFn,
                sortFn,
            } = initialConfig;

            const [filters, setFilters] = useState(initialFilters);
            const [currentPage, setCurrentPage] = useState(1);
            const [rowsPerPage, setRowsPerPage] = useState(initialRowsPerPage);

            const handleFilterChange = useCallback((e) => {
                const { name, value } = e.target;
                setFilters(prev => ({ ...prev, [name]: value }));
                setCurrentPage(1);
            }, []);
            
            const processedData = useMemo(() => {
                let items = Array.isArray(initialData) ? [...initialData] : [];
                if (filterFn) items = filterFn(items, filters);
                if (sortFn) items = sortFn(items);
                return items;
            }, [initialData, filters, filterFn, sortFn]);

            const totalPages = useMemo(() => (rowsPerPage === 'All' ? 1 : Math.ceil(processedData.length / rowsPerPage)), [processedData, rowsPerPage]);
            
            const paginatedData = useMemo(() => {
                if (rowsPerPage === 'All') return processedData;
                const startIndex = (currentPage - 1) * Number(rowsPerPage);
                return processedData.slice(startIndex, startIndex + Number(rowsPerPage));
            }, [processedData, currentPage, rowsPerPage]);

            const paginationProps = { currentPage, totalPages, totalResults: processedData.length, rowsPerPage, onPageChange: setCurrentPage, onRowsPerPageChange: (newRows) => { setRowsPerPage(newRows); setCurrentPage(1); }, };

            return { filters, handleFilterChange, setFilters, paginatedData, paginationProps, processedData };
        };
        // #endregion
        
        // =================================================================================
        // #region 2. CONTEXT & PROVIDERS (AUTH, DATA, NOTIFICATION)
        // =================================================================================
        const AuthContext = createContext();
        const DataContext = createContext();
        const NotificationContext = createContext();

        const useAuth = () => useContext(AuthContext);
        const useData = () => useContext(DataContext);
        const useNotification = () => useContext(NotificationContext);

        const NotificationProvider = ({ children }) => {
            const [notification, setNotification] = useState(null);
            const timeoutRef = useRef(null);

            useEffect(() => {
                // Cleanup timeout on component unmount to prevent memory leaks
                return () => {
                    if (timeoutRef.current) {
                        clearTimeout(timeoutRef.current);
                    }
                };
            }, []);

            const showNotification = useCallback((message, type = 'success', duration = 3000) => {
                if (timeoutRef.current) clearTimeout(timeoutRef.current);
                setNotification({ message, type, id: Date.now() });
                timeoutRef.current = setTimeout(() => setNotification(null), duration);
            }, []);

            return (
                <NotificationContext.Provider value={{ showNotification }}>
                    {children}
                    {notification && <Notification message={notification.message} type={notification.type} onClose={() => setNotification(null)} />}
                </NotificationContext.Provider>
            );
        };
        
        const AuthProvider = ({ children }) => {
            const [user, setUser] = useState(null);
            const [userData, setUserData] = useState(null);
            const [isLoading, setIsLoading] = useState(true);
            const { showNotification } = useNotification();

            useEffect(() => {
                const { onAuthStateChanged, signOut, doc, getDoc } = window.Firebase;
                const unsubscribe = onAuthStateChanged(window.auth, async (firebaseUser) => {
                    if (firebaseUser) {
                        const userDocRef = doc(window.db, "employees", firebaseUser.uid);
                        try {
                            const userDocSnap = await getDoc(userDocRef);
                            if (userDocSnap.exists()) {
                                const userDataFromDb = userDocSnap.data();
                                // --- NEW: Check if user is active ---
                                if (userDataFromDb.status === 'Inactive') {
                                    showNotification("Account is Inactive. Please contact admin.", "error");
                                    await signOut(window.auth);
                                } else {
                                    // User is active (or status is not set, default to active)
                                    setUser(firebaseUser);
                                    setUserData({ uid: firebaseUser.uid, ...userDataFromDb });
                                }
                                // --- END: Check ---
                            } else {
                                showNotification("Access denied. User profile not found.", "error");
                                await signOut(window.auth);
                            }
                        } catch (error) {
                            console.error("Auth state change error:", error);
                            showNotification("Error fetching user profile.", "error");
                            await signOut(window.auth);
                        }
                    } else {
                        setUser(null);
                        setUserData(null);
                    }
                    setIsLoading(false);
                });
                return () => unsubscribe();
            }, [showNotification]);

            const value = { user, userData, isLoading };
            return <AuthContext.Provider value={value}>{children}</AuthContext.Provider>;
        };

        const DataProvider = ({ children }) => {
            const { user, userData } = useAuth();
            
            const useCollection = (collectionName) => {
                const [data, setData] = useState([]);
                useEffect(() => {
                    if (!user) {
                        setData([]);
                        return;
                    };
                    const { collection, onSnapshot } = window.Firebase;
                    const unsubscribe = onSnapshot(collection(window.db, collectionName), (snapshot) => {
                        const items = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        setData(items);
                    }, (error) => console.error(`Error fetching ${collectionName}:`, error));
                    return () => unsubscribe();
                }, [user, collectionName]);
                return data;
            };
            
            const useDocument = (collectionName, docId) => {
                const [data, setData] = useState(null);
                useEffect(() => {
                    if (!user) {
                        setData(null);
                        return;
                    }
                    const { doc, onSnapshot } = window.Firebase;
                    const unsubscribe = onSnapshot(doc(window.db, collectionName, docId), (docSnap) => {
                        if (docSnap.exists()) setData(docSnap.data());
                        else setData(null);
                    });
                    return () => unsubscribe();
                }, [user, collectionName, docId]);
                return data;
            }

            const collections = {
                shops: useCollection('shops'),
                employees: useCollection('employees'),
                vendors: useCollection('vendors'),
                businessExpenseCategories: useCollection('businessExpenseCategories'),
                familyExpenseCategories: useCollection('familyExpenseCategories'),
                cashDrops: useCollection('cashDrops'),
                purchaseOrders: useCollection('purchaseOrders'),
                internalTransfers: useCollection('internalTransfers'),
                businessExpenses: useCollection('businessExpenses'),
                familyExpenses: useCollection('familyExpenses'),
                bankStatements: useCollection('bankStatements'),
                personalCashflowStatements: useCollection('personalCashflowStatements'),
                saleMarginHistory: useCollection('saleMarginHistory'), // <-- ADDED
                // invitations: useCollection('invitations'), // <-- REMOVED
            };

            const appSettings = useDocument("settings", "app") || { exchangeRate: 4000 };

            const value = { 
                ...collections, 
                appSettings,
                userData,
                businessCategories: collections.businessExpenseCategories,
                familyCategories: collections.familyExpenseCategories,
                staffList: collections.employees,
                reports: collections.cashDrops,
                saleMarginHistory: collections.saleMarginHistory, // <-- ADDED
            };
            return <DataContext.Provider value={value}>{children}</DataContext.Provider>;
        };
        // #endregion

        // =================================================================================
        // #region 3. REUSABLE UI COMPONENTS
        // =================================================================================
        const Icon = React.memo(({ name, size = 16, className = '' }) => {
            const Svg = ({ children, ...props }) => (
                <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} {...props}>{children}</svg>
            );
            const iconMap = {
                LoaderCircle: <Svg className={`animate-spin ${className}`}><path d="M21 12a9 9 0 1 1-6.219-8.56" /></Svg>,
                PieChart: <Svg><path d="M21.21 15.89A10 10 0 1 1 8 2.83"/><path d="M22 12A10 10 0 0 0 12 2v10z"/></Svg>,
                BarChart3: <Svg><path d="M3 3v18h18"/><path d="M18 17V9"/><path d="M13 17V5"/><path d="M8 17v-3"/></Svg>,
                Droplets: <Svg><path d="M7 16.3c2.2 0 4-1.83 4-4.05 0-1.16-.57-2.26-1.7-3.29C8.93 8.4 7.59 7.5 7.59 6.4c0-.55.45-1 1-1s1 .45 1 1c0 .55.45 1 1 1s1-.45 1-1c0-1.66-1.34-3-3-3s-3 1.34-3 3c0 1.76-1.27 2.75-2.38 3.66C3.57 10.97 3 12.06 3 13.25c0 2.22 1.8 4.05 4 4.05z"/><path d="M12.56 6.6A10.97 10.97 0 0 0 14 3.02c.54 1.53 1 3.23 1 4.98 0 2.22 1.8 4.05 4 4.05s4-1.83 4-4.05c0-1.16-.57-2.26-1.7-3.29C20.93 8.4 19.59 7.5 19.59 6.4c0-.55.45-1 1-1s1 .45 1 1c0 .55.45 1 1 1s1-.45 1-1c0-1.66-1.34-3-3-3s-3 1.34-3 3c0 .46.1.9.27 1.34"/></Svg>,
                ShoppingCart: <Svg><circle cx="8" cy="21" r="1"/><circle cx="19" cy="21" r="1"/><path d="M2.05 2.05h2l2.66 12.42a2 2 0 0 0 2 1.58h9.78a2 2 0 0 0 1.95-1.57l1.65-7.43H5.16"/></Svg>,
                CreditCard: <Svg><rect width="20" height="14" x="2" y="5" rx="2"/><line x1="2" x2="22" y1="10" y2="10"/></Svg>,
                Settings: <Svg><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 0 2l-.15.08a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l-.22-.38a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1 0-2l.15-.08a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></Svg>,
                Landmark: <Svg><line x1="3" x2="21" y1="22" y2="22"/><line x1="6" x2="6" y1="18" y2="11"/><line x1="10" x2="10" y1="18" y2="11"/><line x1="14" x2="14" y1="18" y2="11"/><line x1="18" x2="18" y1="18" y2="11"/><polygon points="12 2 20 7 4 7"/></Svg>,
                Users: <Svg><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></Svg>,
                List: <Svg><line x1="8" x2="21" y1="6" y2="6"/><line x1="8" x2="21" y1="12" y2="12"/><line x1="8" x2="21" y1="18" y2="18"/><line x1="3" x2="3.01" y1="6" y2="6"/><line x1="3" x2="3.01" y1="12" y2="12"/><line x1="3" x2="3.01" y1="18" y2="18"/></Svg>,
                X: <Svg><path d="M18 6 6 18"/><path d="m6 6 12 12"/></Svg>,
                PenSquare: <Svg><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></Svg>,
                Trash2: <Svg><path d="M3 6h18"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></Svg>,
                Download: <Svg><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></Svg>,
                Menu: <Svg><line x1="4" x2="20" y1="12" y2="12"/><line x1="4" x2="20" y1="6" y2="6"/><line x1="4" x2="20" y1="18" y2="18"/></Svg>,
                CheckCircle: <Svg><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></Svg>,
                XCircle: <Svg><circle cx="12" cy="12" r="10"/><path d="m15 9-6 6"/><path d="m9 9 6 6"/></Svg>,
                Info: <Svg><circle cx="12" cy="12" r="10"/><line x1="12" x2="12" y1="16" y2="12"/><line x1="12" x2="12.01" y1="8" y2="8"/></Svg>,
                Plus: <Svg><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></Svg>,
                Eye: <Svg><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7z"/><circle cx="12" cy="12" r="3"/></Svg>,
                EyeOff: <Svg><path d="M9.88 9.88a3 3 0 1 0 4.24 4.24"/><path d="M10.73 5.08A10.43 10.43 0 0 1 12 5c7 0 10 7 10 7a13.16 13.16 0 0 1-1.67 2.68"/><path d="M6.61 6.61A13.526 13.526 0 0 0 2 12s3 7 10 7a9.74 9.74 0 0 0 5.39-1.61"/><line x1="2" x2="22" y1="2" y2="22"/></Svg>,
                LogOut: <Svg><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" x2="9" y1="12" y2="12"/></Svg>,
                FileText: <Svg><path d="M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z"/><path d="M14 2v4a2 2 0 0 0 2 2h4"/><path d="M16 13H8"/><path d="M16 17H8"/><path d="M10 9H8"/></Svg>,
                ExternalLink: <Svg><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" x2="21" y1="14" y2="3"/></Svg>, // <--- ADDED
            };
            return iconMap[name] || null;
        });

        const Card = ({ children, className = "", ...props }) => (
            <div className={`bg-slate-800/50 border border-slate-700 rounded-lg shadow-lg p-6 ${className}`} {...props}>
                {children}
            </div>
        );
        
        const PageHeader = ({ title, subtitle, children }) => (
            <header className="mb-8 flex flex-col sm:flex-row justify-between sm:items-center gap-4">
                <div>
                    <h1 className="text-2xl font-bold text-slate-100">{title}</h1>
                    {subtitle && <p className="mt-1 text-md text-slate-300">{subtitle}</p>}
                </div>
                <div className="flex-shrink-0 flex items-center gap-2">{children}</div>
            </header>
        );
        
        const Button = ({ children, onClick, variant = 'primary', disabled = false, className = '', icon: IconName, ...props }) => {
            const baseStyles = 'px-4 py-2 rounded-lg font-semibold flex items-center justify-center gap-2 transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-slate-900';
            const variants = {
                primary: 'bg-blue-600 text-white hover:bg-blue-500 disabled:bg-blue-800 focus:ring-blue-500',
                secondary: 'bg-slate-600 text-slate-100 hover:bg-slate-500 disabled:bg-slate-700 focus:ring-slate-500',
                danger: 'bg-red-600 text-white hover:bg-red-500 disabled:bg-red-800 focus:ring-red-500',
                ghost: 'bg-transparent text-slate-300 hover:bg-slate-700 focus:ring-blue-500'
            };
            return (
                <button onClick={onClick} disabled={disabled} className={`${baseStyles} ${variants[variant]} ${className}`} {...props}>
                    {IconName && <Icon name={IconName} size={16} />}
                    {children}
                </button>
            );
        };
        
        const FormInput = React.memo(({ label, name, ...props }) => (
            <div className="w-full">
                {label && <label htmlFor={name} className="block text-sm font-medium text-slate-300 mb-1.5">{label}</label>}
                <input name={name} id={name} {...props} className="block w-full px-3 py-2 bg-slate-700 border-transparent text-slate-200 rounded-md shadow-sm placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-blue-500 sm:text-sm ring-1 ring-inset ring-slate-600" />
            </div>
        ));
        
        const FormTextarea = React.memo(({ label, name, ...props }) => (
            <div>
                {label && <label htmlFor={name} className="block text-sm font-medium text-slate-300 mb-1.5">{label}</label>}
                <textarea name={name} id={name} {...props} rows="3" className="block w-full px-3 py-2 bg-slate-700 border-transparent text-slate-200 rounded-md shadow-sm placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-blue-500 sm:text-sm ring-1 ring-inset ring-slate-600" />
            </div>
        ));

        const FormSelect = React.memo(({ label, name, options, ...props }) => (
            <div>
                {label && <label htmlFor={name} className="block text-sm font-medium text-slate-300 mb-1.5">{label}</label>}
                <select name={name} id={name} {...props} className="block w-full px-3 py-2 bg-slate-700 border-transparent text-slate-200 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 sm:text-sm ring-1 ring-inset ring-slate-600">
                    {options.map((opt, index) => <option key={`${opt.value}-${index}`} value={opt.value}>{opt.label}</option>)}
                </select>
            </div>
        ));
        
        const LiveFormatInput = React.memo(({ value, onChange, name, label, ...props }) => {
            const handleChange = useCallback((e) => {
                const rawValue = e.target.value;
                let sanitized = rawValue.replace(/[^0-9.]/g, '');
                const parts = sanitized.split('.');
                if (parts.length > 2) sanitized = parts[0] + '.' + parts.slice(1).join('');
                onChange({ target: { name, value: sanitized } });
            }, [onChange, name]);

            const formatForDisplay = (val) => {
                if (val === null || val === undefined || val === '') return '';
                const stringVal = String(val);
                const [integerPart, decimalPart] = stringVal.split('.');
                const formattedIntegerPart = integerPart ? new Intl.NumberFormat('en-US').format(integerPart) : '';
                if (decimalPart !== undefined) return `${formattedIntegerPart}.${decimalPart}`;
                if (stringVal.endsWith('.')) return `${formattedIntegerPart}.`;
                return formattedIntegerPart;
            };

            return <FormInput label={label} name={name} value={formatForDisplay(value)} onChange={handleChange} placeholder="0.00" {...props}/>;
        });

        const Modal = ({ children, onClose, title, size = 'xl' }) => {
            const sizeClasses = { sm: 'max-w-sm', md: 'max-w-md', lg: 'max-w-lg', xl: 'max-w-xl', '2xl': 'max-w-2xl', '4xl': 'max-w-4xl' };
            return (
                <div className="fixed inset-0 bg-black/70 flex items-center justify-center z-50 p-4 backdrop-blur-sm">
                    <div className={`bg-slate-800 rounded-lg shadow-xl w-full ${sizeClasses[size]} max-h-[90vh] flex flex-col modal-enter border border-slate-700`}>
                        <header className="flex justify-between items-center p-4 border-b border-slate-700">
                            {typeof title === 'string' ? <h3 className="text-lg font-semibold text-slate-100">{title}</h3> : title}
                            <Button variant="ghost" onClick={onClose} className="p-1 rounded-full !text-slate-400 hover:!text-slate-100" icon="X" />
                        </header>
                        <div className="p-6 overflow-y-auto">{children}</div>
                    </div>
                </div>
            );
        };
        
        const ConfirmationModal = React.memo(({ title, message, onConfirm, onClose, isSubmitting, confirmVariant = 'primary', confirmText = 'Confirm' }) => (
            <Modal title={title} onClose={onClose} size="sm">
                <div className="space-y-4">
                    <p className="text-sm text-slate-300">{message}</p>
                    <div className="flex justify-end gap-4">
                        <Button onClick={onClose} variant="secondary">Cancel</Button>
                        <Button onClick={onConfirm} disabled={isSubmitting} variant={confirmVariant} className="w-28" icon={isSubmitting ? "LoaderCircle" : null}>
                            {isSubmitting ? '' : confirmText}
                        </Button>
                    </div>
                </div>
            </Modal>
        ));

        const PaginationControls = React.memo(({ paginationProps }) => {
            const { currentPage, totalPages, totalResults, rowsPerPage, onPageChange, onRowsPerPageChange, } = paginationProps;
            const startResult = totalResults === 0 ? 0 : Math.min((currentPage - 1) * Number(rowsPerPage) + 1, totalResults);
            const endResult = Math.min(currentPage * Number(rowsPerPage), totalResults);

            return (
                <div className="flex flex-col sm:flex-row justify-between items-center pt-4 gap-4">
                    <div className="text-sm text-slate-400">
                        Showing <span className="font-semibold text-slate-200">{startResult}</span> to <span className="font-semibold text-slate-200">{endResult}</span> of <span className="font-semibold text-slate-200">{totalResults}</span> results
                    </div>
                    <div className="flex items-center gap-2">
                         <FormSelect name="rowsPerPage" value={rowsPerPage} onChange={e => onRowsPerPageChange(e.target.value)} options={[{value:10, label:'10 rows'}, {value:30, label:'30 rows'}, {value:50, label:'50 rows'}, {value:'All', label:'All'}]} />
                        <Button onClick={() => onPageChange(p => Math.max(1, p - 1))} disabled={currentPage === 1} variant="secondary">Prev</Button>
                        <span className="text-sm font-medium px-2">{currentPage} / {totalPages}</span>
                        <Button onClick={() => onPageChange(p => Math.min(totalPages, p + 1))} disabled={currentPage === totalPages || totalPages === 0} variant="secondary">Next</Button>
                    </div>
                </div>
            );
        });

        const Notification = ({ message, type, onClose }) => {
            const baseClasses = "fixed top-5 right-5 z-[100] flex items-center w-full max-w-xs p-4 space-x-4 rounded-lg shadow-lg space-x border";
            const typeClasses = { 
                success: 'text-green-200 bg-slate-800 border-green-500', 
                error: 'text-red-200 bg-slate-800 border-red-500' 
            };
            const icons = { 
                success: <Icon name="CheckCircle" className="text-green-400" />, 
                error: <Icon name="XCircle" className="text-red-400" /> 
            };

            return (
                <div className={`${baseClasses} ${typeClasses[type]} notification-enter`} role="alert">
                    <div className="flex-shrink-0">{icons[type]}</div>
                    <div className="pl-4 text-sm font-medium">{message}</div>
                    <button onClick={onClose} className="ml-auto -mx-1.5 -my-1.5 text-slate-400 hover:text-slate-100 rounded-lg focus:ring-2 focus:ring-slate-500 p-1.5 hover:bg-slate-700 inline-flex h-8 w-8">
                        <span className="sr-only">Close</span>
                        <Icon name="X" size={20} />
                    </button>
                </div>
            );
        };
        
        // #endregion
        
        // =================================================================================
        // #region 4. PAGE COMPONENTS
        // =================================================================================
        
        // --- NEW PAGE: Dashboard Page ---
        const DashboardPage = () => {
            const { shops, userData, cashDrops, purchaseOrders, internalTransfers, businessExpenses, appSettings, saleMarginHistory } = useData();
            const { showNotification } = useNotification();

            // 1. Filter Shops based on Permissions
            const availableShops = useMemo(() => {
                if (!userData) return [];
                const normalizedRole = userData.role ? String(userData.role).trim() : '';
                if (normalizedRole === 'Admin' || normalizedRole === 'Management') return shops;
                return shops.filter(s => userData.shopIds?.includes(s.id));
            }, [shops, userData]);

            // 2. Prepare Data Metrics (OPTIMIZED)
            const { dashboardData, globalStats } = useMemo(() => {
                if (!availableShops.length) return { dashboardData: [], globalStats: {} };

                const exchangeRate = appSettings.exchangeRate || 4100;
                const now = new Date();
                const timeZone = 'Asia/Phnom_Penh';

                // Formatters
                const monthFmt = new Intl.DateTimeFormat('en-CA', { timeZone, year: 'numeric', month: '2-digit' });
                const dateFmt = new Intl.DateTimeFormat('en-CA', { timeZone, year: 'numeric', month: '2-digit', day: '2-digit' });

                const getCambodiaDateStr = (dateObj) => dateObj ? dateFmt.format(dateObj) : '';
                const getMonthKey = (dateObj) => dateObj ? monthFmt.format(dateObj).slice(0, 7) : '';

                // Keys
                const todayStr = getCambodiaDateStr(now);
                const yesterdayStr = getCambodiaDateStr(new Date(now.getTime() - 86400000));
                const thisMonthKey = getMonthKey(now);
                const lastMonthDate = new Date(now.getFullYear(), now.getMonth() - 1, 1);
                const lastMonthKey = getMonthKey(lastMonthDate);

                // Initialize Stats
                const stats = {};
                const shopConfig = {}; 
                
                // Initialize Global Aggregators
                let globalGCA = 0;
                let globalSalesToday = 0;
                let globalSalesMonth = 0;
                let globalExpenseMonth = 0;
                
                availableShops.forEach(s => {
                    stats[s.name] = {
                        salesToday: 0, salesYesterday: 0,
                        salesThisMonth: 0, salesLastMonth: 0,
                        expThisMonth: 0, expLastMonth: 0,
                        poThisMonth: 0, poAllTime: 0,
                        transInThisMonth: 0, transInAllTime: 0,
                        transOutThisMonth: 0, transOutAllTime: 0,
                        salesContributionAllTime: 0,
                        gcaAdjustment: 0 
                    };
                    shopConfig[s.name] = { 
                        defaultMargin: s.saleMargin || 0,
                        openingGCA: s.gca || 0
                    };
                });

                const add = (shop, field, val) => { if (stats[shop]) stats[shop][field] += val; };

                // Margin Map
                const marginHistoryMap = new Map();
                if (saleMarginHistory) {
                    saleMarginHistory.forEach(h => marginHistoryMap.set(`${h.shop}|${h.month}`, h.margin));
                }

                // 1. Cash Drops
                cashDrops.forEach(cd => {
                    if (!stats[cd.shop]) return;
                    const dateObj = cd.createdAt?.toDate ? cd.createdAt.toDate() : new Date(cd.createdAt);
                    const dateStr = getCambodiaDateStr(dateObj);
                    const monthKey = dateStr.slice(0, 7);
                    const amount = cd.grandTotalKhr || 0;

                    if (dateStr === todayStr) add(cd.shop, 'salesToday', amount);
                    if (dateStr === yesterdayStr) add(cd.shop, 'salesYesterday', amount);
                    if (monthKey === thisMonthKey) add(cd.shop, 'salesThisMonth', amount);
                    if (monthKey === lastMonthKey) add(cd.shop, 'salesLastMonth', amount);

                    // GCA Logic
                    const historyKey = `${cd.shop}|${monthKey}`;
                    const effectiveMargin = marginHistoryMap.has(historyKey) ? marginHistoryMap.get(historyKey) : (shopConfig[cd.shop]?.defaultMargin || 0);
                    const contribution = amount * (1 - (effectiveMargin / 100));
                    add(cd.shop, 'salesContributionAllTime', contribution);
                });

                // 2. Expenses
                businessExpenses.forEach(e => {
                    if (!stats[e.shop]) return;
                    const dateObj = e.date?.toDate ? e.date.toDate() : new Date(e.date);
                    const monthKey = getMonthKey(dateObj);
                    const amount = e.totalAmountKhr || 0;
                    if (monthKey === thisMonthKey) add(e.shop, 'expThisMonth', amount);
                    if (monthKey === lastMonthKey) add(e.shop, 'expLastMonth', amount);
                });

                // 3. POs
                purchaseOrders.forEach(po => {
                    if (!stats[po.shop]) return;
                    const dateObj = po.date?.toDate ? po.date.toDate() : new Date(po.date);
                    const monthKey = getMonthKey(dateObj);
                    const amount = (po.amountKhr || 0) + ((po.amountUsd || 0) * exchangeRate);
                    add(po.shop, 'poAllTime', amount);
                    if (monthKey === thisMonthKey) add(po.shop, 'poThisMonth', amount);
                });

                // 4. Transfers
                internalTransfers.forEach(t => {
                    const amount = (t.amountKhr || 0) + ((t.amountUsd || 0) * exchangeRate);
                    const dateObj = t.date?.toDate ? t.date.toDate() : new Date(t.date);
                    const monthKey = getMonthKey(dateObj);
                    if (stats[t.fromShop]) {
                        add(t.fromShop, 'transOutAllTime', amount);
                        if (monthKey === thisMonthKey) add(t.fromShop, 'transOutThisMonth', amount);
                    }
                    if (stats[t.toShop]) {
                        add(t.toShop, 'transInAllTime', amount);
                        if (monthKey === thisMonthKey) add(t.toShop, 'transInThisMonth', amount);
                    }
                });

                // 5. Final Calculation
                const processedData = availableShops.map(shop => {
                    const s = stats[shop.name];
                    const config = shopConfig[shop.name];
                    const currentGCA = config.openingGCA + s.salesContributionAllTime - s.poAllTime - s.transInAllTime + s.transOutAllTime + s.gcaAdjustment;

                    // Update Global Stats
                    globalGCA += currentGCA;
                    globalSalesToday += s.salesToday;
                    globalSalesMonth += s.salesThisMonth;
                    globalExpenseMonth += s.expThisMonth;

                    return { ...shop, ...s, currentGCA };
                });

                return { 
                    dashboardData: processedData, 
                    globalStats: { globalGCA, globalSalesToday, globalSalesMonth, globalExpenseMonth } 
                };

            }, [availableShops, cashDrops, businessExpenses, purchaseOrders, internalTransfers, appSettings, saleMarginHistory]);

            // --- Sub-Components for Dashboard ---
            
            const StatCard = ({ title, value, icon, color, subtitle }) => (
                <div className={`p-5 rounded-xl border border-slate-700 bg-gradient-to-br from-slate-800 to-slate-900 shadow-lg relative overflow-hidden group`}>
                    <div className={`absolute top-0 right-0 p-3 opacity-10 group-hover:opacity-20 transition-opacity`}>
                        <Icon name={icon} size={64} />
                    </div>
                    <div className="flex items-center gap-3 mb-2">
                        <div className={`p-2 rounded-lg bg-${color}-500/10 text-${color}-400`}>
                            <Icon name={icon} size={20} />
                        </div>
                        <h3 className="text-sm font-medium text-slate-400 uppercase tracking-wider">{title}</h3>
                    </div>
                    <div className="text-2xl font-bold font-mono text-white mt-1">{formatCurrency(value, 'KHR')}</div>
                    {subtitle && <p className="text-xs text-slate-500 mt-2">{subtitle}</p>}
                </div>
            );

            const TrendIndicator = ({ current, previous, reverse = false }) => {
                const isUp = current > previous;
                const isNeutral = current === previous;
                // For sales: Up is Green. For expenses: Down is Green.
                const isPositive = reverse ? !isUp : isUp; 
                
                let colorClass = isNeutral ? 'text-slate-500' : (isPositive ? 'text-emerald-400' : 'text-red-400');
                let icon = isNeutral ? 'Minus' : (isUp ? 'TrendingUp' : 'TrendingDown'); // Using simpler logic for visual
                let arrow = isUp ? '↑' : '↓';

                if(isNeutral) return <span className="text-xs text-slate-600">-</span>;

                return (
                    <span className={`text-xs font-medium flex items-center gap-1 ${colorClass}`}>
                        {arrow} {previous > 0 ? Math.round(((current - previous) / previous) * 100) : 0}%
                    </span>
                );
            };

            const MiniMetric = ({ label, value, subValue, highlight = false, trendCurrent, trendPrev, reverseTrend }) => (
                <div className="flex flex-col">
                    <span className="text-[10px] uppercase tracking-wide text-slate-500 font-semibold mb-1 flex justify-between">
                        {label}
                        {(trendCurrent !== undefined && trendPrev !== undefined) && 
                            <TrendIndicator current={trendCurrent} previous={trendPrev} reverse={reverseTrend} />
                        }
                    </span>
                    <span className={`font-mono font-semibold truncate ${highlight ? 'text-white text-lg' : 'text-slate-300 text-sm'}`}>
                        {typeof value === 'number' ? formatCurrency(value, 'KHR').replace('៛', '') : value}
                        {typeof value === 'number' && <span className="text-[10px] text-slate-500 ml-0.5">៛</span>}
                    </span>
                    {subValue && <span className="text-[10px] text-slate-500 truncate">{subValue}</span>}
                </div>
            );

            return (
                <div className="space-y-8 animate-in fade-in duration-500">
                    <PageHeader title="Executive Dashboard" subtitle="Real-time financial overview across all branches." />
                    
                    {/* 1. Global Stats Row */}
                    <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
                        <StatCard title="Total GCA" value={globalStats.globalGCA} icon="Landmark" color="emerald" subtitle="Gross Current Assets (All Shops)" />
                        <StatCard title="Sales (Today)" value={globalStats.globalSalesToday} icon="BarChart3" color="blue" subtitle="Total Daily Revenue" />
                        <StatCard title="Sales (This Month)" value={globalStats.globalSalesMonth} icon="PieChart" color="indigo" subtitle="Total Monthly Revenue" />
                        <StatCard title="Expenses (Month)" value={globalStats.globalExpenseMonth} icon="CreditCard" color="red" subtitle="Total Operational Costs" />
                    </div>

                    {/* 2. Shop Cards Grid */}
                    <div className="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6">
                        {dashboardData.map(shop => (
                            <div key={shop.id} className="bg-slate-800/40 backdrop-blur-sm border border-slate-700 rounded-xl overflow-hidden hover:border-blue-500/50 hover:shadow-xl hover:shadow-blue-500/5 transition-all duration-300 group">
                                {/* Header */}
                                <div className="p-5 border-b border-slate-700/50 flex justify-between items-start bg-slate-800/30">
                                    <div className="flex items-center gap-3">
                                        <div className="w-10 h-10 rounded-full bg-gradient-to-br from-blue-600 to-indigo-600 flex items-center justify-center text-white shadow-lg">
                                            <span className="font-bold text-sm">{shop.name.substring(0, 2).toUpperCase()}</span>
                                        </div>
                                        <div>
                                            <h3 className="font-bold text-slate-100">{shop.name}</h3>
                                            <p className="text-xs text-slate-400">Branch Operations</p>
                                        </div>
                                    </div>
                                    <div className="text-right">
                                        <p className="text-[10px] uppercase text-slate-500 font-bold tracking-wider mb-0.5">Current GCA</p>
                                        <p className="text-xl font-bold font-mono text-emerald-400">{formatCurrency(shop.currentGCA, 'KHR')}</p>
                                    </div>
                                </div>

                                {/* Body - Grid Layout */}
                                <div className="p-5 grid grid-cols-2 gap-y-6 gap-x-4">
                                    
                                    {/* Sales Column */}
                                    <div className="col-span-2 sm:col-span-1 space-y-4 border-r border-slate-700/50 pr-4">
                                        <div className="flex items-center gap-2 mb-2">
                                            <Icon name="BarChart3" size={14} className="text-blue-400"/>
                                            <span className="text-xs font-bold text-blue-400">Revenue</span>
                                        </div>
                                        <MiniMetric label="Today" value={shop.salesToday} highlight trendCurrent={shop.salesToday} trendPrev={shop.salesYesterday} />
                                        <div className="w-full h-px bg-slate-700/50 my-2"></div>
                                        <MiniMetric label="This Month" value={shop.salesThisMonth} trendCurrent={shop.salesThisMonth} trendPrev={shop.salesLastMonth} />
                                    </div>

                                    {/* Operations Column */}
                                    <div className="col-span-2 sm:col-span-1 space-y-4 pl-0 sm:pl-2">
                                        <div className="flex items-center gap-2 mb-2">
                                            <Icon name="Settings" size={14} className="text-orange-400"/>
                                            <span className="text-xs font-bold text-orange-400">Operations (Month)</span>
                                        </div>
                                        
                                        <MiniMetric 
                                            label="Expenses" 
                                            value={shop.expThisMonth} 
                                            trendCurrent={shop.expThisMonth} 
                                            trendPrev={shop.expLastMonth} 
                                            reverseTrend // Up is bad
                                        />
                                        
                                        <div className="grid grid-cols-1 gap-3 pt-1">
                                            <div className="bg-slate-900/50 p-2 rounded border border-slate-700/50">
                                                <div className="flex justify-between items-center text-xs mb-1">
                                                    <span className="text-slate-500">POs</span>
                                                    <span className="text-amber-200 font-mono">{formatCurrency(shop.poThisMonth, 'KHR').replace('៛','')}</span>
                                                </div>
                                            </div>
                                            <div className="bg-slate-900/50 p-2 rounded border border-slate-700/50">
                                                <span className="text-[10px] text-slate-500 block mb-1">Transfers</span>
                                                <div className="flex justify-between items-center text-xs font-mono">
                                                    <span className="text-emerald-400">+{formatCurrency(shop.transInThisMonth, 'KHR').replace('៛','')}</span>
                                                    <span className="text-slate-600">|</span>
                                                    <span className="text-red-400">-{formatCurrency(shop.transOutThisMonth, 'KHR').replace('៛','')}</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        // --- START: Cash Drop Report Page ---
        
        // --- ADDED: Missing DailyExpenseModal ---
        const DailyExpenseModal = ({ onClose }) => {
            const { shops, businessCategories, userData } = useData();
            const { showNotification } = useNotification();
            const { addDoc, collection, Timestamp } = window.Firebase;
            const [isSubmitting, setIsSubmitting] = useState(false);
            const isMounted = useRef(true);

            useEffect(() => {
                isMounted.current = true;
                return () => { isMounted.current = false; };
            }, []);

            // Filter shops based on permission
            const availableShops = useMemo(() => {
                if (!userData) return [];
                if (userData.role === 'Admin' || userData.role === 'Management') return shops;
                return shops.filter(s => userData.shopIds?.includes(s.id));
            }, [shops, userData]);

            const [formData, setFormData] = useState({
                date: getCambodiaISODate(),
                shop: availableShops[0]?.name || '',
                itemName: '',
                category: '',
                qty: '1',
                price: '',
                note: ''
            });

            const handleChange = (e) => setFormData(prev => ({ ...prev, [e.target.name]: e.target.value }));

            const handleSubmit = async (e) => {
                e.preventDefault();
                if (!formData.shop || !formData.category || !formData.price) {
                    showNotification("Please fill in required fields.", "error");
                    return;
                }
                
                setIsSubmitting(true);
                try {
                    const qty = parseFloat(formData.qty) || 1;
                    const price = parseFloat(formData.price.replace(/,/g, '')) || 0;
                    const total = qty * price;

                    await addDoc(collection(window.db, "businessExpenses"), {
                        date: createTimestampFromDateAndCurrentTime(formData.date),
                        shop: formData.shop,
                        itemName: formData.itemName,
                        category: formData.category,
                        qty: qty,
                        price: price,
                        amountKhr: total, 
                        totalAmountKhr: total, 
                        amountUsd: 0,
                        note: formData.note,
                        type: 'Business',
                        submittedBy: userData.uid,
                        recordedBy: userData.name,
                        createdAt: Timestamp.now()
                    });
                    showNotification("Daily expense added.", "success");
                    if (isMounted.current) onClose();
                } catch (error) {
                    console.error(error);
                    showNotification("Failed to add expense.", "error");
                } finally {
                    if (isMounted.current) setIsSubmitting(false);
                }
            };

            const totalPreview = (parseFloat(formData.qty) || 0) * (parseFloat(formData.price.replace(/,/g, '')) || 0);

            return (
                <Modal title="Add Daily Operation Expense" onClose={onClose} size="lg">
                    <form onSubmit={handleSubmit} className="space-y-4">
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <FormInput label="Date" type="date" name="date" value={formData.date} onChange={handleChange} required />
                            <FormSelect 
                                label="Shop" 
                                name="shop" 
                                value={formData.shop} 
                                onChange={handleChange} 
                                options={availableShops.map(s => ({value: s.name, label: s.name}))} 
                                required 
                            />
                        </div>
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <FormInput label="Item Name / Description" name="itemName" value={formData.itemName} onChange={handleChange} required />
                            <FormSelect 
                                label="Category" 
                                name="category" 
                                value={formData.category} 
                                onChange={handleChange} 
                                options={[{value:'', label:'Select Category'}, ...businessCategories.map(c => ({value: c.name, label: c.name}))]} 
                                required 
                            />
                        </div>
                        <div className="grid grid-cols-1 md:grid-cols-3 gap-4 bg-slate-700/30 p-3 rounded-lg border border-slate-700">
                            <FormInput label="Quantity" type="number" name="qty" value={formData.qty} onChange={handleChange} required />
                            <LiveFormatInput label="Price (KHR)" name="price" value={formData.price} onChange={handleChange} required />
                            <div className="flex flex-col justify-end">
                                <span className="text-sm text-slate-400 mb-1">Total</span>
                                <div className="h-10 flex items-center px-3 font-bold text-lg text-emerald-400 font-mono bg-slate-800 rounded border border-slate-600">
                                    {formatCurrency(totalPreview, 'KHR')}
                                </div>
                            </div>
                        </div>
                        <FormTextarea label="Note" name="note" value={formData.note} onChange={handleChange} />
                        
                        <div className="flex justify-end gap-3 pt-4 border-t border-slate-700">
                            <Button type="button" variant="secondary" onClick={onClose}>Cancel</Button>
                            <Button type="submit" disabled={isSubmitting} icon={isSubmitting ? "LoaderCircle" : "Plus"}>
                                {isSubmitting ? 'Saving...' : 'Add Expense'}
                            </Button>
                        </div>
                    </form>
                </Modal>
            );
        };
        // ---------------------------------------------

        // [NEW COMPONENT] Daily Operation Expense Tab
        const DailyOperationExpenseTab = () => {
            const { businessExpenses, shops, userData } = useData();
            const { showNotification } = useNotification();
            const { deleteDoc, doc } = window.Firebase;

            const [isModalOpen, setIsModalOpen] = useState(false);
            const [searchTerm, setSearchTerm] = useState('');
            const [filterMonth, setFilterMonth] = useState(new Date().toISOString().slice(0, 7)); // Default to current month YYYY-MM
            const [filterShop, setFilterShop] = useState('');

            // Get available shops for dropdown based on permissions
            const availableShops = useMemo(() => {
                if (!userData) return [];
                return (userData.role === 'Admin' || userData.role === 'Management') 
                    ? shops 
                    : shops.filter(s => userData?.shopIds?.includes(s.id));
            }, [shops, userData]);

            // Filter expenses
            const expenseList = useMemo(() => {
                // Get list of shop names user is allowed to see
                const userShopNames = (userData?.role === 'Admin' || userData?.role === 'Management') 
                    ? null 
                    : shops.filter(s => userData?.shopIds?.includes(s.id)).map(s => s.name);

                return businessExpenses
                    .filter(e => {
                        // 1. Must be Business type
                        if (e.type !== 'Business') return false;

                        // 2. Month Filter
                        if (filterMonth) {
                            const dateObj = e.date?.toDate ? e.date.toDate() : new Date(e.date);
                            const monthStr = dateObj.toISOString().slice(0, 7); // YYYY-MM
                            if (monthStr !== filterMonth) return false;
                        }

                        // 3. Shop Filter (Dropdown)
                        if (filterShop && e.shop !== filterShop) return false;

                        // 4. Access Control (Security)
                        if (userShopNames && !userShopNames.includes(e.shop)) return false;

                        // 5. Search Term
                        if (searchTerm) {
                            const term = searchTerm.toLowerCase();
                            const matchesNote = e.note?.toLowerCase().includes(term);
                            const matchesItem = e.itemName?.toLowerCase().includes(term);
                            const matchesCategory = e.category?.toLowerCase().includes(term);
                            if (!matchesNote && !matchesItem && !matchesCategory) return false;
                        }

                        return true;
                    })
                    .sort((a,b) => (b.date?.toDate()?.getTime() || 0) - (a.date?.toDate()?.getTime() || 0));
            }, [businessExpenses, userData, shops, searchTerm, filterMonth, filterShop]);

            // Calculate Sub-Total (Grand Total for current view)
            const totalAmount = useMemo(() => {
                return expenseList.reduce((sum, item) => sum + (item.amountKhr || item.totalAmountKhr || 0), 0);
            }, [expenseList]);

            // --- NEW: Calculate Shop Totals for Cards ---
            const shopTotals = useMemo(() => {
                return expenseList.reduce((acc, item) => {
                    const shopName = item.shop || 'Unknown';
                    acc[shopName] = (acc[shopName] || 0) + (item.amountKhr || item.totalAmountKhr || 0);
                    return acc;
                }, {});
            }, [expenseList]);

            const getShopColor = (index) => {
                const colors = [
                    'bg-blue-500/10 border-blue-500/30 text-blue-400',
                    'bg-emerald-500/10 border-emerald-500/30 text-emerald-400',
                    'bg-purple-500/10 border-purple-500/30 text-purple-400',
                    'bg-amber-500/10 border-amber-500/30 text-amber-400',
                    'bg-pink-500/10 border-pink-500/30 text-pink-400',
                    'bg-cyan-500/10 border-cyan-500/30 text-cyan-400',
                ];
                return colors[index % colors.length];
            };
            // ---------------------------------------------

            // Delete Handler
            const handleDelete = async (id) => {
                if(!confirm("Are you sure you want to delete this expense?")) return;
                try {
                    await deleteDoc(doc(window.db, "businessExpenses", id));
                    showNotification("Expense deleted", "success");
                } catch (e) {
                    showNotification("Failed to delete", "error");
                }
            };

            return (
                <div className="space-y-4">
                    <Card>
                        {/* Header: Title & Total */}
                        <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-6 border-b border-slate-700 pb-4">
                            <h3 className="text-lg font-bold text-slate-100">Daily Operation Expenses</h3>
                            
                            {/* Grand Total Badge - HIDDEN FOR STAFF */}
                            {userData?.role !== 'Staff' && (
                                <div className="bg-slate-800 border border-slate-600 px-4 py-2 rounded-lg flex items-center gap-3">
                                    <span className="text-slate-400 text-sm uppercase tracking-wider font-semibold">Grand Total:</span>
                                    <span className="text-xl font-bold font-mono text-white">{formatCurrency(totalAmount, 'KHR')}</span>
                                </div>
                            )}
                        </div>

                        {/* --- NEW: Shop Sub-Total Cards --- */}
                        {Object.keys(shopTotals).length > 0 && (
                            <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 mb-6">
                                {Object.entries(shopTotals).map(([shopName, total], index) => (
                                    <div key={shopName} className={`p-4 rounded-lg border flex flex-col justify-between ${getShopColor(index)}`}>
                                        <div className="flex items-center gap-2 mb-2">
                                            <Icon name="Landmark" size={14} className="opacity-70" />
                                            <p className="text-xs font-bold uppercase opacity-90 truncate" title={shopName}>{shopName}</p>
                                        </div>
                                        <p className="text-lg font-bold font-mono">{formatCurrency(total, 'KHR')}</p>
                                    </div>
                                ))}
                            </div>
                        )}
                        {/* ---------------------------------- */}

                        {/* Filters */}
                        <div className="grid grid-cols-1 md:grid-cols-12 gap-4 mb-6 items-end p-4 bg-slate-900/50 rounded-lg">
                            <div className="md:col-span-3">
                                <FormInput 
                                    label="Month" 
                                    type="month" 
                                    value={filterMonth} 
                                    onChange={e => setFilterMonth(e.target.value)} 
                                />
                            </div>
                            <div className="md:col-span-3">
                                <FormSelect 
                                    label="Shop" 
                                    value={filterShop} 
                                    onChange={e => setFilterShop(e.target.value)} 
                                    options={[{value: '', label: 'All Shops'}, ...availableShops.map(s => ({value: s.name, label: s.name}))]} 
                                />
                            </div>
                            <div className="md:col-span-4">
                                <FormInput 
                                    label="Search"
                                    placeholder="Search item, category..." 
                                    value={searchTerm} 
                                    onChange={e => setSearchTerm(e.target.value)} 
                                />
                            </div>
                            <div className="md:col-span-2">
                                <Button onClick={() => setIsModalOpen(true)} icon="Plus" className="w-full justify-center">Add New</Button>
                            </div>
                        </div>
                        
                        <div className="overflow-x-auto">
                            <table className="w-full text-sm text-left text-slate-300">
                                <thead className="bg-slate-900/50 text-xs text-slate-400 uppercase">
                                    <tr>
                                        <th className="p-3">Date</th>
                                        <th className="p-3">Shop</th>
                                        <th className="p-3">Item Name</th>
                                        <th className="p-3">Category</th>
                                        <th className="p-3 text-right">Qty</th>
                                        <th className="p-3 text-right">Price (៛)</th>
                                        <th className="p-3 text-right">Total (៛)</th>
                                        <th className="p-3">Recorded By</th>
                                        <th className="p-3 text-center">Action</th>
                                    </tr>
                                </thead>
                                <tbody className="divide-y divide-slate-700">
                                    {expenseList.length === 0 ? (
                                        <tr><td colSpan="9" className="p-8 text-center text-slate-500">No daily expenses found for this period.</td></tr>
                                    ) : (
                                        expenseList.map(item => (
                                            <tr key={item.id} className="hover:bg-slate-700/50">
                                                <td className="p-3 whitespace-nowrap">{formatInCambodiaDateOnly(item.date)}</td>
                                                <td className="p-3">{item.shop}</td>
                                                <td className="p-3 font-medium text-slate-200">{item.itemName || item.note || '-'}</td>
                                                <td className="p-3"><span className="bg-slate-700 px-2 py-1 rounded text-xs">{item.category}</span></td>
                                                <td className="p-3 text-right font-mono">{item.qty || 1}</td>
                                                <td className="p-3 text-right font-mono">{item.price ? formatCurrency(item.price, 'KHR') : '-'}</td>
                                                <td className="p-3 text-right font-bold font-mono text-red-400">{formatCurrency(item.amountKhr || item.totalAmountKhr, 'KHR')}</td>
                                                <td className="p-3 text-xs">{item.recordedBy}</td>
                                                <td className="p-3 text-center">
                                                    <Button variant="ghost" size="sm" onClick={() => handleDelete(item.id)} className="text-red-400 hover:bg-red-900/50"><Icon name="Trash2"/></Button>
                                                </td>
                                            </tr>
                                        ))
                                    )}
                                </tbody>
                                {/* Footer Row for Print/View clarity */}
                                {expenseList.length > 0 && userData?.role !== 'Staff' && (
                                    <tfoot className="bg-slate-800 font-bold text-slate-200">
                                        <tr>
                                            <td colSpan="6" className="p-3 text-right">Grand Total:</td>
                                            <td className="p-3 text-right font-mono text-red-400">{formatCurrency(totalAmount, 'KHR')}</td>
                                            <td colSpan="2"></td>
                                        </tr>
                                    </tfoot>
                                )}
                            </table>
                        </div>
                    </Card>

                    {isModalOpen && <DailyExpenseModal onClose={() => setIsModalOpen(false)} />}
                </div>
            );
        };

        const CashDropPage = () => {
            // This page now only focuses on Input (Cash Drop & Expenses)
            const [activeTab, setActiveTab] = useState('newDrop'); 

            const TabButton = ({ tabName, label, isActive, onClick }) => (
                <button 
                    onClick={() => onClick(tabName)} 
                    className={`px-4 py-2 text-sm font-semibold rounded-t-lg transition-colors ${isActive ? 'border-b-2 border-blue-500 text-blue-400' : 'text-slate-400 hover:bg-slate-700/50'}`}
                >
                    {label}
                </button>
            );
            
            return (
                <div className="space-y-8">
                     <PageHeader 
                        title="Cash Drop Report" 
                        subtitle="Submit daily sales and operation expenses."
                    />

                    {/* Tab Navigation */}
                    <div className="border-b border-slate-700 flex space-x-1 sm:space-x-2 flex-wrap">
                        <TabButton tabName="newDrop" label="New Cash Drop" isActive={activeTab === 'newDrop'} onClick={setActiveTab} />
                        <TabButton tabName="dailyExpense" label="Daily Operation Expense" isActive={activeTab === 'dailyExpense'} onClick={setActiveTab} />
                    </div>

                    {/* Tab Content */}
                    <div className={activeTab === 'newDrop' ? '' : 'hidden'}>
                        <NewCashDropForm />
                    </div>
                    
                    <div className={activeTab === 'dailyExpense' ? '' : 'hidden'}>
                        <DailyOperationExpenseTab />
                    </div>
                </div>
            );
        };
        
        // --- NEW PAGE: Sale Report Page ---
        const SaleReportPage = () => {
            const [activeTab, setActiveTab] = useState('dashboard');
            
            const TabButton = ({ tabName, label, isActive, onClick }) => (
                <button 
                    onClick={() => onClick(tabName)} 
                    className={`px-4 py-2 text-sm font-semibold rounded-t-lg transition-colors ${isActive ? 'border-b-2 border-blue-500 text-blue-400' : 'text-slate-400 hover:bg-slate-700/50'}`}
                >
                    {label}
                </button>
            );

            return (
                <div className="space-y-8">
                    <PageHeader 
                        title="Sale Report" 
                        subtitle="View and analyze sales performance."
                    />
                    
                     <div className="border-b border-slate-700 flex space-x-1 sm:space-x-2 flex-wrap">
                        <TabButton tabName="dashboard" label="Sales Dashboard" isActive={activeTab === 'dashboard'} onClick={setActiveTab} />
                        <TabButton tabName="comparison" label="Comparison" isActive={activeTab === 'comparison'} onClick={setActiveTab} />
                    </div>

                    <div className={activeTab === 'dashboard' ? '' : 'hidden'}>
                         <ReportsDashboard />
                    </div>
                     <div className={activeTab === 'comparison' ? '' : 'hidden'}>
                        <Card>
                            <h2 className="text-xl font-semibold text-slate-100">Comparison Report</h2>
                            <p className="mt-4 text-slate-400">This section is under construction and will be available soon.</p>
                        </Card>
                    </div>
                </div>
            );
        };

        const NewCashDropForm = () => {
             const { shops, appSettings } = useData();
            const { userData } = useAuth();
            const { showNotification } = useNotification();
            const { addDoc, collection, Timestamp } = window.Firebase;

            // --- UPDATED: Added safety check ?. for shopIds ---
            const getInitialState = useCallback(() => ({
                date: new Date().toISOString().split('T')[0],
                shop: (userData?.role === 'Admin' || userData?.role === 'Management') ? (shops[0]?.name || '') : (shops.find(s => userData?.shopIds?.includes(s.id))?.name || ''),
                staff: userData?.name || '',
                shift: 'AM',
                cashUsd: '', cashKhr: '', bankUsd: '', bankKhr: '', cashExchange: '', note: '',
            }), [shops, userData]);

            const [formData, setFormData] = useState(getInitialState);
            const [isSubmitting, setIsSubmitting] = useState(false);
            const [isConfirming, setIsConfirming] = useState(false);
            const [isPreviewing, setIsPreviewing] = useState(false);
            const [lastSubmittedData, setLastSubmittedData] = useState(null);

            useEffect(() => { setFormData(getInitialState()) }, [getInitialState]);
            
            const handleFormChange = useCallback((e) => {
                const { name, value } = e.target;
                if (['cashUsd', 'cashKhr', 'bankUsd', 'bankKhr', 'cashExchange'].includes(name)) {
                    setFormData(prev => ({ ...prev, [name]: value.replace(/[^0-9.]/g, '') }));
                } else {
                    setFormData(prev => ({ ...prev, [name]: value }));
                }
            }, []);

            const grandTotal = useMemo(() => {
                const clean = (val) => parseFloat(String(val).replace(/,/g, '')) || 0;
                return (clean(formData.cashUsd) + clean(formData.bankUsd)) * appSettings.exchangeRate + clean(formData.cashKhr) + clean(formData.bankKhr);
            }, [formData, appSettings.exchangeRate]);
            
            const handleConfirmSubmit = useCallback(async () => {
                setIsConfirming(false);
                setIsSubmitting(true);
                try {
                    const clean = (val) => parseFloat(String(val).replace(/,/g, '')) || 0;
                    
                    const submissionData = {
                        ...formData,
                        cashUsd: clean(formData.cashUsd), cashKhr: clean(formData.cashKhr),
                        bankUsd: clean(formData.bankUsd), bankKhr: clean(formData.bankKhr),
                        cashExchange: clean(formData.cashExchange),
                        grandTotalKhr: grandTotal,
                        createdAt: Timestamp.fromDate(new Date(`${formData.date}T${new Date().toTimeString().split(' ')[0]}`)),
                        submittedBy: userData.uid
                    };
                    await addDoc(collection(window.db, "cashDrops"), submissionData);
                    setLastSubmittedData({ formData, grandTotal });
                    setIsPreviewing(true);
                    showNotification("Report submitted successfully!", "success");
                } catch (error) { 
                    console.error("Error submitting report:", error);
                    showNotification("Failed to submit report.", "error");
                } finally {
                    setIsSubmitting(false);
                }
            }, [formData, grandTotal, userData, addDoc, collection, Timestamp, showNotification]);

            const handleClosePreviewAndReset = useCallback(() => {
                setIsPreviewing(false);
                setFormData(getInitialState());
                setLastSubmittedData(null);
            }, [getInitialState]);

            // --- UPDATED: Added safety check ?. for shopIds ---
            const availableShops = useMemo(() => {
                if (!userData) return [];
                return (userData.role === 'Admin' || userData.role === 'Management') 
                    ? shops 
                    : shops.filter(s => userData.shopIds?.includes(s.id));
            }, [shops, userData]);
            
            const SubmitConfirmationModalKhmer = ({ onConfirm, onClose, isSubmitting }) => (
                <Modal title="បញ្ជាក់ការបញ្ជូនរបាយការណ៍" onClose={onClose} size="sm">
                    <div className="space-y-4">
                        <p className="mt-2 text-sm text-slate-400">សូមពិនិត្យមើលព័ត៌មានលម្អិតមុនពេលបញ្ជូន ត្រឹមត្រូវហើយ?</p>
                        <div className="flex justify-end items-center gap-3 pt-4">
                            <Button onClick={onClose} disabled={isSubmitting} variant="secondary">បោះបង់</Button>
                            <Button onClick={onConfirm} disabled={isSubmitting} icon={isSubmitting ? "LoaderCircle" : null}>
                                {isSubmitting ? '' : 'បាទ​/ចាស៎'}
                            </Button>
                        </div>
                    </div>
                </Modal>
            );

            return (
                <>
                    <form onSubmit={(e) => { e.preventDefault(); setIsConfirming(true); }} className="grid grid-cols-1 lg:grid-cols-3 gap-8 items-start">
                        <Card className="lg:col-span-2">
                            <h2 className="text-xl font-semibold text-slate-100 border-b border-slate-700 pb-4 mb-6">New Cash Drop Form</h2>
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <FormInput label="Date" type="date" name="date" value={formData.date} onChange={handleFormChange} required />
                                <FormSelect label="Shop" name="shop" value={formData.shop} onChange={handleFormChange} options={availableShops.map(s => ({value: s.name, label: s.name}))} required />
                                <FormInput label="Staff" name="staff" value={formData.staff} disabled />
                                <FormSelect label="Shift" name="shift" value={formData.shift} onChange={handleFormChange} options={[{value:'AM', label:'AM'}, {value:'PM', label:'PM'}]} />
                            </div>
                            <div className="space-y-4 pt-6 mt-6 border-t border-slate-700">
                                <LiveFormatInput label="Cash KHR (៛)" name="cashKhr" value={formData.cashKhr} onChange={handleFormChange} />
                                <LiveFormatInput label="Cash USD ($)" name="cashUsd" value={formData.cashUsd} onChange={handleFormChange} />
                                <LiveFormatInput label="Bank KHR (៛)" name="bankKhr" value={formData.bankKhr} onChange={handleFormChange} />
                                <LiveFormatInput label="Bank USD ($)" name="bankUsd" value={formData.bankUsd} onChange={handleFormChange} />
                                <LiveFormatInput label="Cash Exchange (៛)" name="cashExchange" value={formData.cashExchange} onChange={handleFormChange} />
                            </div>
                            <div className="pt-6 mt-6 border-t border-slate-700"><FormInput label="Note" name="note" value={formData.note} onChange={handleFormChange} placeholder="Add an optional note..."/></div>
                        </Card>
                        <SummaryCard formData={formData} grandTotal={grandTotal} isSubmitting={isSubmitting} />
                    </form>
                    {isConfirming && <SubmitConfirmationModalKhmer onClose={() => setIsConfirming(false)} onConfirm={handleConfirmSubmit} isSubmitting={isSubmitting} />}
                    {isPreviewing && lastSubmittedData && <SummaryPreviewModal 
                        isOpen={isPreviewing} 
                        onClose={handleClosePreviewAndReset} 
                        formData={lastSubmittedData.formData}
                        grandTotal={lastSubmittedData.grandTotal}
                    />}
                </>
            );
        };
        
        const SummaryCard = React.memo(({ formData, grandTotal, isSubmitting }) => {
            const { userData } = useAuth(); // <--- Get userData to check role
            const [currentTime, setCurrentTime] = useState(new Date());

            useEffect(() => {
                const timerId = setInterval(() => setCurrentTime(new Date()), 1000);
                return () => clearInterval(timerId);
            }, []);

            const formattedDate = useMemo(() => {
                if (!formData.date) return 'N/A';
                const [year, month, day] = formData.date.split('-');
                return `${day}-${month}-${year}`;
            }, [formData.date]);
            
            return (
                 <Card className="lg:col-span-1 lg:sticky top-24">
                    <div className="border-b border-slate-700 pb-4 text-center">
                        <h3 className="text-xl font-semibold text-slate-100">Summary</h3>
                        <p className="font-semibold text-red-400 text-sm mt-2">
                            <span>{formattedDate}</span>
                            <span className="mx-2 text-slate-500">|</span>
                            <span className="font-mono">{currentTime.toLocaleTimeString('en-GB', { timeZone: 'Asia/Phnom_Penh', hour: '2-digit', minute: '2-digit', second: '2-digit' })}</span>
                        </p>
                    </div>
                    <div className="space-y-2 text-sm pt-4">
                        <div className="flex justify-between items-center"><span className="text-slate-400">Shop:</span><span className="font-semibold text-slate-200">{formData.shop}</span></div>
                        <div className="flex justify-between items-center"><span className="text-slate-400">Staff:</span><span className="font-semibold text-slate-200">{formData.staff}</span></div>
                        <div className="flex justify-between items-center"><span className="text-slate-400">Shift:</span><span className="font-semibold text-slate-200">{formData.shift}</span></div>
                    </div>
                    <div className="border-t border-slate-700 my-4"></div>
                    <div className="space-y-3 text-md">
                        <div className="flex justify-between items-center"><span className="text-slate-400">Cash KHR :</span><span className="font-mono font-semibold text-slate-200">{formatCurrency(formData.cashKhr, 'KHR')}</span></div>
                        <div className="flex justify-between items-center"><span className="text-slate-400">Cash USD :</span><span className="font-mono font-semibold text-slate-200">{formatCurrency(formData.cashUsd, 'USD')}</span></div>
                        <div className="flex justify-between items-center"><span className="text-slate-400">Bank KHR :</span><span className="font-mono font-semibold text-slate-200">{formatCurrency(formData.bankKhr, 'KHR')}</span></div>
                        <div className="flex justify-between items-center"><span className="text-slate-400">Bank USD :</span><span className="font-mono font-semibold text-slate-200">{formatCurrency(formData.bankUsd, 'USD')}</span></div>
                        
                        {/* --- HIDE GRAND TOTAL FOR STAFF --- */}
                        {userData?.role !== 'Staff' && (
                            <>
                                <div className="border-t border-slate-700 !my-4"></div>
                                <div className="flex justify-between items-center"><span className="font-bold text-slate-100 text-lg">Grand Total :</span><span className="font-extrabold text-red-500 text-2xl">{formatCurrency(grandTotal, 'KHR')}</span></div>
                            </>
                        )}
                        {/* ---------------------------------- */}
                        
                        <div className="border-t border-slate-700 !my-4"></div>
                        <div className="flex justify-between items-center"><span className="text-slate-400">Cash Exchange :</span><span className="font-mono font-semibold text-slate-200">{formatCurrency(formData.cashExchange, 'KHR')}</span></div>
                    </div>
                    {formData.note && (
                        <>
                            <div className="border-t border-slate-700 my-4"></div>
                            <div>
                                <h4 className="font-semibold text-slate-300 mb-1">Note:</h4>
                                <p className="text-sm text-slate-400 bg-slate-900/50 p-3 rounded-md whitespace-pre-wrap">{formData.note}</p>
                            </div>
                        </>
                    )}
                    <Button type="submit" disabled={isSubmitting} className="w-full !mt-6 py-3" icon={isSubmitting ? "LoaderCircle" : null}>
                        {isSubmitting ? 'Submitting...' : 'Submit Report'}
                    </Button>
                </Card>
            );
        });

        const SummaryPreviewModal = ({ isOpen, onClose, formData, grandTotal }) => {
            const titleContent = (
                <div className="text-center w-full">
                    <h3 className="text-lg font-semibold text-slate-100">របាយការណ៍លក់ត្រូវបានបញ្ចូលដោយជោគជ័យ</h3>
                    <p className="mt-1 text-sm text-slate-400">សូមអ្នកធ្វើការថតរបាយការណ៍នេះដើម្បីរាយការណ៍ជូនថ្នាក់លើ!</p>
                </div>
            );
            return (
                <Modal isOpen={isOpen} onClose={onClose} title={titleContent} size="lg">
                    <div className="p-6 flex-grow overflow-y-auto bg-slate-900">
                        <SummaryCard formData={formData} grandTotal={grandTotal} isSubmitting={false}/>
                    </div>
                     <div className="flex justify-end p-4 border-t border-slate-700">
                         <Button onClick={onClose} variant="primary">Close</Button>
                    </div>
                </Modal>
            );
        };
        
        const ReportsDashboard = () => {
            const { reports, shops, appSettings } = useData();
            const { userData } = useAuth();
            const { showNotification } = useNotification();
            const { doc, deleteDoc, updateDoc } = window.Firebase;

            const [filters, setFilters] = useState({ 
                shop: '', 
                dueTime: 'Today', 
                startDate: '', 
                endDate: '',
                month: new Date().toISOString().slice(0, 7), // Added month
                week: '1' // Added week
            });
            const [isSubmitting, setIsSubmitting] = useState(false);
            const [modalState, setModalState] = useState({ edit: null, delete: null, note: null, customDate: false });
            const [isAggregated, setIsAggregated] = useState(false); // <-- NEW: State for the toggle

            const handleModalOpen = useCallback((type, data) => setModalState(prev => ({ ...prev, [type]: data })), []);
            const handleModalClose = useCallback((type) => setModalState(prev => ({ ...prev, [type]: null })), []);

            // --- UPDATED: Added safety check ?. for shopIds ---
            const availableShops = useMemo(() => {
                if (!userData) return [];
                return (userData.role === 'Admin' || userData.role === 'Management') 
                    ? shops 
                    : shops.filter(s => userData.shopIds?.includes(s.id));
            }, [shops, userData]);

            const shopColorMap = useMemo(() => {
                const colors = ['blue', 'green', 'yellow', 'pink', 'indigo', 'teal'];
                return shops.reduce((map, shop, index) => {
                    const color = colors[index % colors.length];
                    map[shop.name] = { base: `bg-${color}-900/20`, hover: `hover:bg-${color}-800/30` };
                    return map;
                }, {});
            }, [shops]);
            
            const handleConfirmDelete = useCallback(async () => {
                if (!modalState.delete) return;
                setIsSubmitting(true);
                try {
                    await deleteDoc(doc(window.db, "cashDrops", modalState.delete.id));
                    handleModalClose('delete');
                    showNotification("Report deleted.", "success");
                } catch (error) { 
                    console.error("Error deleting report:", error); 
                    showNotification("Failed to delete report.", "error");
                } 
                finally { setIsSubmitting(false); }
            }, [modalState.delete, handleModalClose, showNotification, deleteDoc, doc]);

            const handleSaveEdit = useCallback(async (editedData) => {
                if (!modalState.edit) return;
                setIsSubmitting(true);
                try {
                    const clean = (val) => parseFloat(String(val).replace(/,/g, '')) || 0;
                    const grandTotal = (clean(editedData.cashUsd) + clean(editedData.bankUsd)) * appSettings.exchangeRate + clean(editedData.cashKhr) + clean(editedData.bankKhr);
                    const reportRef = doc(window.db, "cashDrops", modalState.edit.id);
                    
                    const updatedReport = {
                      ...editedData,
                      createdAt: createTimestampFromDateAndCurrentTime(editedData.date),
                      cashUsd: clean(editedData.cashUsd), cashKhr: clean(editedData.cashKhr),
                      bankUsd: clean(editedData.bankUsd), bankKhr: clean(editedData.bankKhr),
                      cashExchange: clean(editedData.cashExchange),
                      grandTotalKhr: grandTotal,
                    };
                    delete updatedReport.id;
                    delete updatedReport.date;

                    await updateDoc(reportRef, updatedReport);
                    
                    handleModalClose('edit');
                    showNotification("Report updated.", "success");
                } catch (error) { 
                    console.error("Error updating report:", error); 
                    showNotification("Failed to update report.", "error");
                } 
                finally { setIsSubmitting(false); }
            }, [modalState.edit, appSettings.exchangeRate, handleModalClose, showNotification, updateDoc, doc]);

            const filteredAndAggregatedData = useMemo(() => {
                if (!reports || !userData) return null;
                
                const userFilteredReports = (userData.role !== 'Admin' && userData.role !== 'Management')
                    ? reports.filter(report => availableShops.map(s => s.name).includes(report.shop))
                    : reports;
                
                let filtered = userFilteredReports;
                const { dueTime, startDate, endDate, shop } = filters;
                
                // --- START: Timezone-Correct Date Logic ---
                // All date calculations must be relative to Cambodia's timezone (GMT+7)
                const timeZone = 'Asia/Phnom_Penh';
                const cambodiaOffset = 7 * 60 * 60 * 1000; // +07:00 in milliseconds
                const now = new Date(); // The current moment in time

                // Get the current Y/M/D parts *as they are in Cambodia*
                const parts = new Intl.DateTimeFormat('en-US', {
                    timeZone: timeZone,
                    year: 'numeric',
                    month: 'numeric', // 1-indexed
                    day: 'numeric'
                }).formatToParts(now).reduce((acc, part) => {
                    if (part.type !== 'literal') acc[part.type] = parseInt(part.value, 10);
                    return acc;
                }, {});
                // parts = { year: 2025, month: 11, day: 14 } (example)

                if (dueTime === 'Today') {
                    // 00:00:00 in Cambodia
                    const startOfToday = new Date(Date.UTC(parts.year, parts.month - 1, parts.day, 0, 0, 0) - cambodiaOffset);
                    // 23:59:59.999 in Cambodia
                    const endOfToday = new Date(Date.UTC(parts.year, parts.month - 1, parts.day, 23, 59, 59, 999) - cambodiaOffset);
                    
                    filtered = userFilteredReports.filter(r => {
                        const reportDate = r.createdAt?.toDate();
                        return reportDate >= startOfToday && reportDate <= endOfToday;
                    });
                } else if (dueTime === 'Yesterday') {
                    // Get parts for yesterday in Cambodia
                    const yesterday = new Date(now.getTime() - (24 * 60 * 60 * 1000));
                    const yParts = new Intl.DateTimeFormat('en-US', {
                        timeZone: timeZone,
                        year: 'numeric', month: 'numeric', day: 'numeric'
                    }).formatToParts(yesterday).reduce((acc, part) => {
                        if (part.type !== 'literal') acc[part.type] = parseInt(part.value, 10);
                        return acc;
                    }, {});
                    
                    const startOfYesterday = new Date(Date.UTC(yParts.year, yParts.month - 1, yParts.day, 0, 0, 0) - cambodiaOffset);
                    const endOfYesterday = new Date(Date.UTC(yParts.year, yParts.month - 1, yParts.day, 23, 59, 59, 999) - cambodiaOffset);
                    
                    filtered = userFilteredReports.filter(r => {
                        const reportDate = r.createdAt?.toDate();
                        return reportDate >= startOfYesterday && reportDate <= endOfYesterday;
                    });
                } else if (dueTime === 'Weekly') {
                    const [year, monthVal] = filters.month.split('-').map(Number);
                    const monthIndex = monthVal - 1; // 0-indexed month
                    let startDay, endDay;

                    if (filters.week === '1') { startDay = 1; endDay = 7; }
                    else if (filters.week === '2') { startDay = 8; endDay = 14; }
                    else if (filters.week === '3') { startDay = 15; endDay = 21; }
                    else if (filters.week === '4') { startDay = 22; endDay = 31; } // Will be capped by end of month logic

                    const start = new Date(Date.UTC(year, monthIndex, startDay, 0, 0, 0) - cambodiaOffset);
                    
                    // Get last day of the month (e.g., day 0 of *next* month)
                    const lastDayDate = new Date(Date.UTC(year, monthIndex + 1, 0));
                    // Get the numeric date (e.g., 30, 31, 28)
                    const lastDayOfMonth = lastDayDate.getUTCDate(); 
                    
                    const actualEndDay = (filters.week === '4') ? lastDayOfMonth : endDay;

                    const end = new Date(Date.UTC(year, monthIndex, actualEndDay, 23, 59, 59, 999) - cambodiaOffset);

                    filtered = userFilteredReports.filter(r => {
                        const reportDate = r.createdAt?.toDate();
                        return reportDate >= start && reportDate <= end;
                    });
                } else if (dueTime === 'This Month') {
                    const startOfMonth = new Date(Date.UTC(parts.year, parts.month - 1, 1, 0, 0, 0) - cambodiaOffset);
                    // Get end of this month (day 0 of next month)
                    const endOfMonth = new Date(Date.UTC(parts.year, parts.month, 0, 23, 59, 59, 999) - cambodiaOffset);
                    
                    filtered = userFilteredReports.filter(r => {
                        const reportDate = r.createdAt?.toDate();
                        return reportDate >= startOfMonth && reportDate <= endOfMonth;
                    });
                } else if (dueTime === 'Last Month') {
                    const startOfLastMonth = new Date(Date.UTC(parts.year, parts.month - 2, 1, 0, 0, 0) - cambodiaOffset);
                    const endOfLastMonth = new Date(Date.UTC(parts.year, parts.month - 1, 0, 23, 59, 59, 999) - cambodiaOffset);
                    filtered = userFilteredReports.filter(r => {
                        const reportDate = r.createdAt?.toDate();
                        return reportDate >= startOfLastMonth && reportDate <= endOfLastMonth;
                    });
                } else if (dueTime === 'This Year') {
                    const startOfYear = new Date(Date.UTC(parts.year, 0, 1, 0, 0, 0) - cambodiaOffset);
                    // Get end of this year
                    const endOfYear = new Date(Date.UTC(parts.year, 11, 31, 23, 59, 59, 999) - cambodiaOffset);

                    filtered = userFilteredReports.filter(r => {
                        const reportDate = r.createdAt?.toDate();
                        return reportDate >= startOfYear && reportDate <= endOfYear;
                    });
                } else if (dueTime === 'Last Year') {
                    const startOfLastYear = new Date(Date.UTC(parts.year - 1, 0, 1, 0, 0, 0) - cambodiaOffset);
                    const endOfLastYear = new Date(Date.UTC(parts.year - 1, 11, 31, 23, 59, 59, 999) - cambodiaOffset);
                    filtered = userFilteredReports.filter(r => {
                        const reportDate = r.createdAt?.toDate();
                        return reportDate >= startOfLastYear && reportDate <= endOfLastYear;
                    });
                } else if (dueTime === 'Custom') {
                    if (startDate && endDate) {
                        // Parse date strings manually as UTC and apply offset
                        const [sy, sm, sd] = startDate.split('-').map(Number);
                        const start = new Date(Date.UTC(sy, sm - 1, sd, 0, 0, 0) - cambodiaOffset);
                        
                        const [ey, em, ed] = endDate.split('-').map(Number);
                        const end = new Date(Date.UTC(ey, em - 1, ed, 23, 59, 59, 999) - cambodiaOffset);
                        
                        filtered = userFilteredReports.filter(r => r.createdAt?.toDate() >= start && r.createdAt?.toDate() <= end);
                    } else {
                        // Custom is selected but no date range is applied yet. Show no results.
                        filtered = [];
                    }
                }
                // --- END: Timezone-Correct Date Logic ---
                
                if (shop) filtered = filtered.filter(r => r.shop === shop);
                
                if (['Today', 'Yesterday', 'Custom'].includes(dueTime)) {
                    if (isAggregated) { // <-- CHECK: If user wants to aggregate the detailed view
                        const aggregated = filtered.reduce((acc, report) => {
                            const key = report.shop;
                            if (!acc[key]) acc[key] = { 
                                period: dueTime, 
                                shop: report.shop, 
                                cashUsd: 0, cashKhr: 0, bankUsd: 0, bankKhr: 0, grandTotalKhr: 0 
                            };
                            acc[key].cashUsd += report.cashUsd || 0; acc[key].cashKhr += report.cashKhr || 0;
                            acc[key].bankUsd += report.bankUsd || 0; acc[key].bankKhr += report.bankKhr || 0;
                            acc[key].grandTotalKhr += report.grandTotalKhr || 0;
                            return acc;
                        }, {});
                        const aggregatedData = Object.values(aggregated).sort((a,b) => (b.grandTotalKhr || 0) - (a.grandTotalKhr || 0));
                        return { type: 'aggregated', data: aggregatedData };
                    } else {
                        // Original detailed view
                        return { type: 'detailed', data: filtered.sort((a,b) => (b.createdAt?.toDate()?.getTime() || 0) - (a.createdAt?.toDate()?.getTime() || 0)) };
                    }
                }
                
                const aggregated = filtered.reduce((acc, report) => {
                    const date = report.createdAt.toDate();
                    let period;
                    if (['This Month', 'Last Month'].includes(dueTime)) {
                        period = date.toLocaleString('default', { month: 'short', year: 'numeric' });
                    } else if (dueTime === 'Weekly') {
                        period = filters.month; // Changed from including week number
                    } else { // This Year, Last Year
                        period = date.getFullYear().toString();
                    }
                    const key = `${period}|${report.shop}`;
                    if (!acc[key]) acc[key] = { period, shop: report.shop, cashUsd: 0, cashKhr: 0, bankUsd: 0, bankKhr: 0, grandTotalKhr: 0 };
                    acc[key].cashUsd += report.cashUsd || 0; acc[key].cashKhr += report.cashKhr || 0;
                    acc[key].bankUsd += report.bankUsd || 0; acc[key].bankKhr += report.bankKhr || 0;
                    acc[key].grandTotalKhr += report.grandTotalKhr || 0;
                    return acc;
                }, {});
                
                const aggregatedData = Object.values(aggregated);

                // Sort aggregated views (Weekly, Monthly, Yearly) by Net Sale descending
                // This addresses the user request to show top-selling shops first for "Weekly" reports.
                aggregatedData.sort((a, b) => (b.grandTotalKhr || 0) - (a.grandTotalKhr || 0));

                return { type: 'aggregated', data: aggregatedData };
            }, [reports, filters, userData, availableShops, isAggregated]); // <-- ADDED: isAggregated dependency

            const totals = useMemo(() => {
                if (!filteredAndAggregatedData?.data) return { cashUsd: 0, cashKhr: 0, bankUsd: 0, bankKhr: 0, cashExchange: 0, netSale: 0 };
                return filteredAndAggregatedData.data.reduce((acc, r) => { 
                    acc.cashUsd += r.cashUsd || 0; acc.cashKhr += r.cashKhr || 0; 
                    acc.bankUsd += r.bankUsd || 0; acc.bankKhr += r.bankKhr || 0; 
                    acc.cashExchange += r.cashExchange || 0;
                    acc.netSale += r.grandTotalKhr || 0; 
                    return acc; 
                }, { cashUsd: 0, cashKhr: 0, bankUsd: 0, bankKhr: 0, cashExchange: 0, netSale: 0 })
            }, [filteredAndAggregatedData]);
            
            const handleExport = useCallback(() => {
                if (!filteredAndAggregatedData?.data) return;
                const dataToExport = filteredAndAggregatedData.data.map(row => 
                    (filteredAndAggregatedData.type === 'detailed') ? {
                        'Date': formatInCambodiaTime(row.createdAt), 'Shop': row.shop, 'Staff': row.staff,
                        'Net Sale (KHR)': row.grandTotalKhr, 'Cash USD': row.cashUsd, 'Cash KHR': row.cashKhr,
                        'Bank USD': row.bankUsd, 'Bank KHR': row.bankKhr, 'Cash Exchange (KHR)': row.cashExchange || 0, 'Shift': row.shift
                    } : {
                        [filters.dueTime]: row.period, 'Shop': row.shop, 'Net Sale (KHR)': row.grandTotalKhr,
                        'Cash USD': row.cashUsd, 'Cash KHR': row.cashKhr, 'Bank USD': row.bankUsd, 'Bank KHR': row.bankKhr
                    }
                );
                const success = exportToExcel(dataToExport, `Cash_Drop_Report_${new Date().toISOString().split('T')[0]}.xlsx`);
                if(success) showNotification("Exported successfully!", "success");

            }, [filteredAndAggregatedData, filters.dueTime, showNotification]);
            
            const ReportFilters = React.memo(({ filters, setFilters, shops, onCustomClick, isAggregated, setIsAggregated }) => {
                const handleFilterChange = (e) => {
                    const { name, value } = e.target;
                    if (name === 'dueTime' && value === 'Custom') {
                        onCustomClick();
                        setFilters(prev => ({...prev, [name]: value, startDate: '', endDate: ''}));
                    } else {
                        setFilters(prev => ({...prev, [name]: value}));
                    }
                };
                return (
                     <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4 p-4 bg-slate-900/50 rounded-lg items-end">
                        <FormSelect label="Shop" name="shop" value={filters.shop} onChange={handleFilterChange} options={[{value:'',label:'All Shops'}, ...shops.map(s=>({value:s.name, label:s.name}))]} />
                        
                        {/* --- START: This block replaces the broken lines 1004-1006 --- */}
                        <FormSelect 
                            label="Report Type" 
                            name="dueTime" 
                            value={filters.dueTime} 
                            onChange={handleFilterChange} 
                            options={[
                                {value:'Today',label:'Today'}, 
                                {value:'Yesterday',label:'Yesterday'}, 
                                {value:'Weekly',label:'Weekly'},
                                {value:'This Month',label:'This Month'}, 
                                {value:'Last Month',label:'Last Month'},
                                {value:'This Year',label:'This Year'},
                                {value:'Last Year',label:'Last Year'}, 
                                {value:'Custom', label:'Custom'}
                            ]} 
                        />
                        {/* --- END: Replaced block --- */}
                        
                        {/* --- Aggregate Toggle Checkbox (Moved here per user request) --- */}
                        {['Today', 'Yesterday', 'Custom'].includes(filters.dueTime) ? (
                            <div className="flex items-center gap-2 h-10 mb-1"> {/* Aligned to form input height */}
                                <input
                                    type="checkbox"
                                    id="aggregate-toggle"
                                    className="h-4 w-4 rounded bg-slate-700 border-slate-600 text-blue-500 focus:ring-blue-500"
                                    checked={isAggregated}
                                    onChange={(e) => setIsAggregated(e.target.checked)}
                                />
                                <label htmlFor="aggregate-toggle" className="text-sm font-medium text-slate-300">
                                    Total {/* Original label: "Total by Shop (Aggregate)" */}
                                </label>
                            </div>
                        ) : (
                            /* Placeholder div to keep grid alignment when checkbox is hidden */
                            <div className="hidden md:block"></div>
                        )}

                        {filters.dueTime === 'Weekly' && (
                            <>
                                <FormInput label="Month" type="month" name="month" value={filters.month} onChange={handleFilterChange} />
                                <FormSelect 
                                    label="WCDR (Week)" 
                                    name="week" 
                                    value={filters.week} 
                                    onChange={handleFilterChange} 
                                    options={[ 
                                        { value: '1', label: '1st Week (1-7)' }, 
                                        { value: '2', label: '2nd Week (8-14)' }, 
                                        { value: '3', label: '3rd Week (15-21)' }, 
                                        { value: '4', label: '4th Week (22-End)' } 
                                    ]} 
                                />
                            </>
                        )}
                    </div>
                );
            });
            
            const ReportTable = React.memo(({ reports, totals, onEdit, onDelete, onViewNote, viewType, shopColorMap }) => {
                const { userData } = useAuth();
                const canModify = userData?.role === 'Admin' || userData?.role === 'Management' || userData?.role === 'Shop Manager';
                return (
                    <div className="overflow-x-auto">
                        {reports.length === 0 ? <div className="text-center py-16 text-slate-500"><p>No reports found for the selected filters.</p></div> :
                            <table className="w-full text-sm text-left">
                                <thead className="bg-slate-900/50 text-xs text-slate-400 uppercase">
                                    <tr>
                                        <th className="p-3">Date & Time</th><th className="p-3">Shop</th>
                                        <th className="p-3">Staff</th>
                                        {['Today', 'Yesterday', 'Custom'].includes(viewType) && <th className="p-3">Shift</th>}
                                        <th className="p-3 text-right">Net Sale (៛)</th><th className="p-3 text-right">Cash USD</th><th className="p-3 text-right">Cash KHR</th>
                                        <th className="p-3 text-right">Bank USD</th><th className="p-3 text-right">Bank KHR</th>
                                        <th className="p-3 text-right">Cash Exchange</th>
                                        <th className="p-3 text-center">Actions</th>
                                    </tr>
                                </thead>
                                <tbody className="divide-y divide-slate-700">
                                    {reports.map(r => (
                                        <tr key={r.id} className={`${shopColorMap[r.shop]?.base || 'bg-transparent'} ${shopColorMap[r.shop]?.hover || 'hover:bg-slate-700/50'}`}>
                                            <td className="p-3 whitespace-nowrap text-slate-400">{formatInCambodiaTime(r.createdAt)}</td>
                                            <td className="p-3 text-slate-300">{r.shop}</td>
                                            <td className="p-3 text-slate-300">{r.staff}</td>
                                            {['Today', 'Yesterday', 'Custom'].includes(viewType) && <td className="p-3 text-slate-300">{r.shift}</td>}
                                            <td className="p-3 text-right font-bold text-blue-400">{formatCurrency(r.grandTotalKhr, 'KHR')}</td>
                                            <td className="p-3 text-right font-mono text-slate-300">{formatCurrency(r.cashUsd, 'USD')}</td><td className="p-3 text-right font-mono text-slate-300">{formatCurrency(r.cashKhr, 'KHR')}</td>
                                            <td className="p-3 text-right font-mono text-slate-300">{formatCurrency(r.bankUsd, 'USD')}</td><td className="p-3 text-right font-mono text-slate-300">{formatCurrency(r.bankKhr, 'KHR')}</td>
                                            <td className="p-3 text-right font-mono text-slate-300">{formatCurrency(r.cashExchange, 'KHR')}</td>
                                            <td className="p-3 flex gap-2 justify-center">
                                                {r.note && <Button variant="ghost" onClick={() => onViewNote(r.note)} className="p-1 text-yellow-400 hover:text-yellow-300" title="View Note" icon="FileText"/>}
                                                <Button variant="ghost" onClick={() => canModify && onEdit(r)} disabled={!canModify} className="p-1 text-blue-400 hover:text-blue-300" title="Edit" icon="PenSquare" />
                                                <Button variant="ghost" onClick={() => canModify && onDelete(r)} disabled={!canModify} className="p-1 text-red-500 hover:text-red-400" title="Delete" icon="Trash2" />
                                            </td>
                                        </tr>
                                    ))}
                                </tbody>
                                <tfoot className="bg-slate-800 font-bold"><tr>
                                    <td colSpan={['Today', 'Yesterday', 'Custom'].includes(viewType) ? 4 : 3} className="p-3 text-right text-slate-300">Sub-Total</td>
                                    <td className="p-3 text-right font-mono text-blue-400">{formatCurrency(totals.netSale, 'KHR')}</td>
                                    <td className="p-3 text-right font-mono text-slate-300">{formatCurrency(totals.cashUsd, 'USD')}</td><td className="p-3 text-right font-mono text-slate-300">{formatCurrency(totals.cashKhr, 'KHR')}</td>
                                    <td className="p-3 text-right font-mono text-slate-300">{formatCurrency(totals.bankUsd, 'USD')}</td><td className="p-3 text-right font-mono text-slate-300">{formatCurrency(totals.bankKhr, 'KHR')}</td>
                                    <td className="p-3 text-right font-mono text-slate-300">{formatCurrency(totals.cashExchange, 'KHR')}</td>
                                    <td />
                                </tr></tfoot>
                            </table>
                        }
                    </div>
                )
            });

            const AggregatedReportTable = React.memo(({ reports, totals, periodType, shopColorMap }) => (
                <div className="overflow-x-auto">
                    {reports.length === 0 ? <div className="text-center py-16 text-slate-500"><p>No reports found for the selected filters.</p></div> :
                        <table className="w-full text-sm text-left">
                            <thead className="bg-slate-900/50 text-xs text-slate-400 uppercase">
                                <tr>
                                    <th className="p-3">{periodType.replace('This ', '').replace('Last ', '')}</th><th className="p-3">Shop</th><th className="p-3 text-right">Net Sale (៛)</th>
                                    <th className="p-3 text-right">Cash USD</th><th className="p-3 text-right">Cash KHR</th>
                                    <th className="p-3 text-right">Bank USD</th><th className="p-3 text-right">Bank KHR</th>
                                </tr>
                            </thead>
                            <tbody className="divide-y divide-slate-700">
                                {reports.map(r => (
                                    <tr key={`${r.period}-${r.shop}`} className={`${shopColorMap[r.shop]?.base || 'bg-transparent'} ${shopColorMap[r.shop]?.hover || 'hover:bg-slate-700/50'}`}>
                                        <td className="p-3 whitespace-nowrap text-slate-400">{r.period}</td>
                                        <td className="p-3 text-slate-300">{r.shop}</td>
                                        <td className="p-3 text-right font-bold text-blue-400">{formatCurrency(r.grandTotalKhr, 'KHR')}</td>
                                        <td className="p-3 text-right font-mono text-slate-300">{formatCurrency(r.cashUsd, 'USD')}</td><td className="p-3 text-right font-mono text-slate-300">{formatCurrency(r.cashKhr, 'KHR')}</td>
                                        <td className="p-3 text-right font-mono text-slate-300">{formatCurrency(r.bankUsd, 'USD')}</td><td className="p-3 text-right font-mono text-slate-300">{formatCurrency(r.bankKhr, 'KHR')}</td>
                                    </tr>
                                ))}
                            </tbody>
                            <tfoot className="bg-slate-800 font-bold">
                                <tr>
                                    <td colSpan={2} className="p-3 text-right text-slate-300">Sub-Total</td>
                                    <td className="p-3 text-right font-mono text-blue-400">{formatCurrency(totals.netSale, 'KHR')}</td>
                                    <td className="p-3 text-right font-mono text-slate-300">{formatCurrency(totals.cashUsd, 'USD')}</td><td className="p-3 text-right font-mono text-slate-300">{formatCurrency(totals.cashKhr, 'KHR')}</td>
                                    <td className="p-3 text-right font-mono text-slate-300">{formatCurrency(totals.bankUsd, 'USD')}</td><td className="p-3 text-right font-mono text-slate-300">{formatCurrency(totals.bankKhr, 'KHR')}</td>
                                </tr>
                            </tfoot>
                        </table>
                    }
                </div>
            ));

            return (
                <Card className="mt-8">
                    <div className="flex flex-col sm:flex-row justify-between items-center mb-4 gap-4">
                        <h2 className="text-xl font-semibold text-slate-100">Daily Cash Drop History</h2>
                        <Button onClick={handleExport} variant="secondary" icon="Download">Export to Excel</Button>
                    </div>
                    
                    <ReportFilters 
                        filters={filters} 
                        setFilters={setFilters} 
                        shops={availableShops} 
                        onCustomClick={() => handleModalOpen('customDate', true)}
                        isAggregated={isAggregated}
                        setIsAggregated={setIsAggregated}
                    />
                    
                    {/* --- Aggregate Toggle Checkbox (Renamed to "Total" per user request) --- */}
                    {/* --- This block is now moved inside the ReportFilters component --- */}
                    {/* --- END: Aggregate Toggle Checkbox --- */}
                    
                    {!filteredAndAggregatedData ? <div className="py-16 flex justify-center items-center"><Icon name="LoaderCircle" className="w-8 h-8 text-slate-400" /></div> :
                        (filteredAndAggregatedData.type === 'detailed') ? 
                            <ReportTable reports={filteredAndAggregatedData.data} totals={totals} onEdit={(r) => handleModalOpen('edit', r)} onDelete={(r) => handleModalOpen('delete', r)} onViewNote={(n) => handleModalOpen('note', n)} viewType={filters.dueTime} shopColorMap={shopColorMap} /> : 
                            <AggregatedReportTable reports={filteredAndAggregatedData.data} totals={totals} periodType={filters.dueTime} shopColorMap={shopColorMap} />
                    }
                    
                    {modalState.edit && <EditReportModal isOpen={!!modalState.edit} onClose={() => handleModalClose('edit')} onSave={handleSaveEdit} report={modalState.edit} isSubmitting={isSubmitting} shops={availableShops}/>}
                    {modalState.delete && <ConfirmationModal title="Delete Report" message="Are you sure? This action cannot be undone." onConfirm={handleConfirmDelete} onClose={() => handleModalClose('delete')} isSubmitting={isSubmitting} confirmVariant="danger" confirmText="Delete" />}
                    {modalState.customDate && <CustomDateRangeModal isOpen={modalState.customDate} onClose={() => handleModalClose('customDate')} onApply={(dates) => setFilters(prev => ({...prev, ...dates}))}/>}
                    {modalState.note && <NoteViewModal onClose={() => handleModalClose('note')} note={modalState.note}/>}
                </Card>
            );
        };

        const EditReportModal = ({ isOpen, onClose, onSave, report, isSubmitting, shops }) => {
            const [formData, setFormData] = useState({});
            
            useEffect(() => {
                if (report) {
                    setFormData({ ...report,
                        date: report.createdAt?.toDate().toISOString().split('T')[0] || '',
                        cashUsd: String(report.cashUsd || ''), cashKhr: String(report.cashKhr || ''),
                        bankUsd: String(report.bankUsd || ''), bankKhr: String(report.bankKhr || ''),
                        cashExchange: String(report.cashExchange || ''),
                        note: report.note || '',
                    });
                }
            }, [report]);

            const handleFormChange = useCallback((e) => {
                const { name, value } = e.target;
                setFormData(prev => ({ ...prev, [name]: value }));
            }, []);

            const handleSave = (e) => { e.preventDefault(); onSave(formData); };
            
            return (
                <Modal isOpen={isOpen} onClose={onClose} title="Edit Report" size="2xl">
                    <form onSubmit={handleSave} className="space-y-4">
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <FormInput label="Date" type="date" name="date" value={formData.date || ''} onChange={handleFormChange} required />
                            <FormSelect label="Shop" name="shop" value={formData.shop || ''} onChange={handleFormChange} options={shops.map(s => ({value: s.name, label: s.name}))} required />
                            <FormInput label="Staff" name="staff" value={formData.staff || ''} disabled />
                            <FormSelect label="Shift" name="shift" value={formData.shift || 'AM'} onChange={handleFormChange} options={[{value:'AM', label:'AM'}, {value:'PM', label:'PM'}]} />
                        </div>
                        <LiveFormatInput label="Cash KHR" name="cashKhr" value={formData.cashKhr} onChange={handleFormChange} />
                        <LiveFormatInput label="Cash USD" name="cashUsd" value={formData.cashUsd} onChange={handleFormChange} />
                        <LiveFormatInput label="Bank KHR" name="bankKhr" value={formData.bankKhr} onChange={handleFormChange} />
                        <LiveFormatInput label="Bank USD" name="bankUsd" value={formData.bankUsd} onChange={handleFormChange} />
                        <LiveFormatInput label="Cash Exchange" name="cashExchange" value={formData.cashExchange} onChange={handleFormChange} />
                        <FormTextarea label="Note" name="note" value={formData.note || ''} onChange={handleFormChange} />
                         <div className="flex justify-end gap-4 pt-4 border-t border-slate-700">
                            <Button type="button" variant="secondary" onClick={onClose}>Cancel</Button>
                            <Button type="submit" disabled={isSubmitting} icon={isSubmitting ? "LoaderCircle" : null}>
                                {isSubmitting ? 'Saving...' : 'Save Changes'}
                            </Button>
                        </div>
                    </form>
                </Modal>
            );
        };
        
        const NoteViewModal = ({ onClose, note, title = "Note" }) => (
            <Modal title={title} onClose={onClose} size="lg">
                <div className="space-y-4">
                    <p className="text-slate-300 whitespace-pre-wrap max-h-[60vh] overflow-y-auto">{note}</p>
                    <div className="flex justify-end gap-4 pt-4 mt-4 border-t border-slate-700">
                        <Button type="button" onClick={onClose} variant="secondary">Close</Button>
                    </div>
                </div>
            </Modal>
        );
        
        const CustomDateRangeModal = ({ isOpen, onClose, onApply }) => {
            const [dates, setDates] = useState({ startDate: '', endDate: '' });
            const handleApply = () => { onApply(dates); onClose(); };
            return (
                <Modal isOpen={isOpen} onClose={onClose} title="Select Custom Date Range">
                    <div className="space-y-4">
                        <FormInput label="Start Date" type="date" value={dates.startDate} onChange={e => setDates(d => ({...d, startDate: e.target.value}))} />
                        <FormInput label="End Date" type="date" value={dates.endDate} onChange={e => setDates(d => ({...d, endDate: e.target.value}))} />
                    </div>
                    <div className="bg-slate-900/50 px-6 py-3 flex justify-end items-center gap-3 rounded-b-lg">
                        <Button onClick={onClose} variant="secondary">Cancel</Button>
                        <Button onClick={handleApply}>Apply</Button>
                    </div>
                </Modal>
            );
        };
        // --- END: Cash Drop Report Page ---

        // --- START: Purchase Order Page ---
        const useMonthlyData = (filters) => {
            const { reports, businessExpenses, familyExpenses, shops, purchaseOrders, internalTransfers, appSettings, saleMarginHistory } = useData(); // <-- ADDED saleMarginHistory
            
            return useMemo(() => {
                const now = new Date();
                let startDate, endDate;

                switch (filters.dateRangeType) {
                    case 'last_month':
                        startDate = new Date(now.getFullYear(), now.getMonth() - 1, 1);
                        endDate = new Date(now.getFullYear(), now.getMonth(), 0, 23, 59, 59, 999);
                        break;
                    case 'this_year':
                        startDate = new Date(now.getFullYear(), 0, 1);
                        endDate = new Date(now.getFullYear(), 11, 31, 23, 59, 59, 999);
                        break;
                    case 'by_month':
                        const [year, month] = filters.month.split('-').map(Number);
                        startDate = new Date(year, month - 1, 1);
                        endDate = new Date(year, month, 0, 23, 59, 59, 999);
                        break;
                    case 'this_month':
                    default:
                        startDate = new Date(now.getFullYear(), now.getMonth(), 1);
                        endDate = new Date(now.getFullYear(), now.getMonth() + 1, 0, 23, 59, 59, 999);
                        break;
                }

                const exchangeRate = appSettings.exchangeRate || 4100;

                const filterByDate = (item) => {
                    const itemDate = item.createdAt?.toDate() || item.date?.toDate();
                    return itemDate && itemDate >= startDate && itemDate <= endDate;
                };
                
                const filteredReports = reports.filter(filterByDate);
                const filteredBusinessExpenses = businessExpenses.filter(filterByDate);
                const filteredFamilyExpenses = familyExpenses.filter(filterByDate);
                const filteredInternalTransfers = internalTransfers.filter(filterByDate);
                const filteredPurchaseOrders = purchaseOrders.filter(filterByDate);

                return { 
                    exchangeRate, shops, 
                    filteredReports, filteredBusinessExpenses, filteredFamilyExpenses, filteredInternalTransfers, filteredPurchaseOrders, 
                    allPOs: purchaseOrders, allReports: reports, allTransfers: internalTransfers,
                    saleMarginHistory // <-- PASS IT THROUGH
                };
            }, [filters, reports, businessExpenses, familyExpenses, shops, purchaseOrders, internalTransfers, appSettings, saleMarginHistory]); // <-- ADDED saleMarginHistory
        };
        
        const IitPaymentTab = ({ filters, onFilterChange, isCapturing }) => {
            const data = useMonthlyData(filters);
            const {shops} = useData();
            const { showNotification } = useNotification();
            const [payeeFilter, setPayeeFilter] = useState('All');

            const iitPaymentData = useMemo(() => {
                let filteredTransfers = data.filteredInternalTransfers;
                if (payeeFilter !== 'All') {
                    filteredTransfers = filteredTransfers.filter(t => t.toShop === payeeFilter);
                }

                return Object.values(filteredTransfers.reduce((acc, transfer) => {
                    const key = `${transfer.toShop}-${transfer.fromShop}`;
                    if (!acc[key]) {
                        acc[key] = { payee: transfer.toShop, receiver: transfer.fromShop, totalAmount: 0 };
                    }
                    acc[key].totalAmount += (transfer.amountKhr || 0) + ((transfer.amountUsd || 0) * data.exchangeRate);
                    return acc;
                }, {}));
            }, [data, payeeFilter]);

            const subtotal = useMemo(() => {
                return iitPaymentData.reduce((sum, item) => sum + item.totalAmount, 0);
            }, [iitPaymentData]);
            
            const handleExport = useCallback(() => {
                const dataToExport = iitPaymentData.map((item, index) => ({
                    "No.": index + 1,
                    "Shop Payee": item.payee,
                    "Shop Receiver": item.receiver,
                    "Total Amount (៛)": item.totalAmount
                }));
                exportToExcel(dataToExport, `IIT_Payment_Report_${filters.month}.xlsx`, "IIT_Payments");
                showNotification("Exported to Excel successfully!", "success");
            }, [iitPaymentData, filters.month, showNotification]);

            const dateRangeText = {
                'this_month': 'This Month',
                'last_month': 'Last Month',
                'this_year': 'This Year',
                'by_month': `Month: ${filters.month}`
            }[filters.dateRangeType];

            return (
                <Card>
                    <div className="flex justify-between items-center mb-4">
                        <h3 className="text-lg font-bold">IIT Payment Report</h3>
                        <Button onClick={handleExport} variant="secondary" icon="Download">Export Excel</Button>
                    </div>
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                        {isCapturing ? (
                            <>
                                <div>
                                    <label className="block text-sm font-medium text-slate-300 mb-1.5">Date Range</label>
                                    <div className="block w-full px-3 py-2 border border-slate-600 bg-slate-700 rounded-md shadow-sm sm:text-sm text-slate-200">{dateRangeText}</div>
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-slate-300 mb-1.5">Shop Payee</label>
                                    <div className="block w-full px-3 py-2 border border-slate-600 bg-slate-700 rounded-md shadow-sm sm:text-sm text-slate-200">{payeeFilter}</div>
                                </div>
                            </>
                        ) : (
                            <>
                                <FormSelect 
                                    label="Date Range"
                                    name="dateRangeType"
                                    value={filters.dateRangeType}
                                    onChange={onFilterChange}
                                    options={[
                                        {value: 'this_month', label: 'This Month'},
                                        {value: 'last_month', label: 'Last Month'},
                                        {value: 'this_year', label: 'This Year'},
                                        {value: 'by_month', label: 'Select Month'},
                                    ]}
                                />
                                {filters.dateRangeType === 'by_month' && (
                                    <FormInput 
                                        label="Select Month"
                                        type="month"
                                        name="month"
                                        value={filters.month}
                                        onChange={onFilterChange}
                                    />
                                )}
                                <FormSelect label="Filter by Shop Payee" name="payee" value={payeeFilter} onChange={(e) => setPayeeFilter(e.target.value)} options={[{value: 'All', label: 'All Shops'}, ...shops.map(s => ({value: s.name, label: s.name}))]} />
                            </>
                        )}
                    </div>
                    <div className="overflow-x-auto">
                        <table className="w-full text-sm">
                           <thead className="bg-slate-900/50 text-slate-300 uppercase text-xs">
                                <tr>
                                    <th className="p-2 text-left">No.</th><th className="p-2 text-left">Shop Payee</th>
                                    <th className="p-2 text-left">Shop Receiver</th><th className="p-2 text-right">Total Amount (៛)</th>
                                </tr>
                            </thead>
                            <tbody className="divide-y divide-slate-700 text-slate-200">
                                {iitPaymentData.map((t, index) => (
                                    <tr key={index} className="hover:bg-slate-700/50">
                                        <td className="p-2">{index + 1}</td><td className="p-2">{t.payee}</td>
                                        <td className="p-2">{t.receiver}</td><td className="p-2 text-right font-mono">{formatCurrency(t.totalAmount, 'KHR')}</td>
                                    </tr>
                                ))}
                            </tbody>
                        <tfoot className="bg-slate-900/50 font-bold text-slate-100">
                                <tr>
                                    <td colSpan="3" className="p-2 text-right">Sub-Total</td>
                                    <td className="p-2 text-right font-mono">{formatCurrency(subtotal, 'KHR')}</td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </Card>
            );
        };

        const PurchaseOrderPage = () => {
             const [activeTab, setActiveTab] = useState('pos');
             const [filters, setFilters] = useState({ 
                dateRangeType: 'this_month',
                month: new Date().toISOString().slice(0, 7) 
             });
             const printRef = useRef();
             const { showNotification } = useNotification();
             const [isCapturing, setIsCapturing] = useState(false);
             const isMounted = useRef(true);

             useEffect(() => {
                isMounted.current = true;
                return () => { isMounted.current = false; };
            }, []);
            
            const handleFilterChange = (e) => {
                const { name, value } = e.target;
                setFilters(prev => ({...prev, [name]: value}));
            };

            const handleDownloadImage = useCallback(async () => {
                if (!printRef.current || !isMounted.current) return;
                setIsCapturing(true);
                setTimeout(async () => {
                    try {
                        const canvas = await html2canvas(printRef.current, { useCORS: true, scale: 2, backgroundColor: '#0f172a' });
                        const image = canvas.toDataURL("image/png", 1.0);
                        const link = document.createElement('a');
                        link.href = image;
                        link.download = `iit-payment-report-${filters.dateRangeType}-${filters.month}.png`;
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                        showNotification("Image downloaded successfully!", "success");
                    } catch (error) {
                        console.error("Image capture error:", error);
                        showNotification("Failed to download image.", "error");
                    } finally {
                        if(isMounted.current) setIsCapturing(false);
                    }
                }, 100);
            }, [filters, showNotification]);

            const TabButton = ({ tabName, label, isActive, onClick }) => (
                <button onClick={() => onClick(tabName)} className={`px-4 py-2 text-sm font-semibold rounded-t-lg ${isActive ? 'border-b-2 border-blue-500 text-blue-400' : 'text-slate-400 hover:bg-slate-700/50'}`}>
                    {label}
                </button>
            );

            return (
                 <div className="space-y-6">
                    <PageHeader title="Purchase Orders & Transfers" subtitle="Manage purchase orders, internal transfers, and vendor tracking.">
                        {activeTab === 'iit_payment' && (
                             <Button onClick={handleDownloadImage} disabled={isCapturing} variant="secondary" icon={isCapturing ? 'LoaderCircle' : 'Download'}>
                                {isCapturing ? 'Capturing...' : 'Download as Image'}
                            </Button>
                        )}
                    </PageHeader>
                    <div className="border-b border-slate-700 flex space-x-1 sm:space-x-2 flex-wrap">
                        <TabButton tabName="pos" label="Purchase Orders" isActive={activeTab === 'pos'} onClick={setActiveTab} />
                        <TabButton tabName="internal_transfer" label="Internal Transfer" isActive={activeTab === 'internal_transfer'} onClick={setActiveTab} />
                        <TabButton tabName="iit_payment" label="IIT Payment Report" isActive={activeTab === 'iit_payment'} onClick={setActiveTab} />
                        <TabButton tabName="vendor_tracking" label="Vendor Tracking" isActive={activeTab === 'vendor_tracking'} onClick={setActiveTab} />
                        <TabButton tabName="vendors" label="Vendors" isActive={activeTab === 'vendors'} onClick={setActiveTab} />
                    </div>
                    <div className="mt-6">
                        <div className={activeTab === 'pos' ? '' : 'hidden'}><PurchaseOrdersTab /></div>
                        <div className={activeTab === 'internal_transfer' ? '' : 'hidden'}><InternalTransferTab /></div>
                        <div className={activeTab === 'vendor_tracking' ? '' : 'hidden'}><VendorTrackingTab /></div>
                        <div className={activeTab === 'vendors' ? '' : 'hidden'}><ManageVendorsSection /></div>
                        
                        {activeTab === 'iit_payment' && (
                            <div className="space-y-4">
                                <div ref={printRef} className="bg-slate-900 p-4 rounded-lg">
                                    <IitPaymentTab filters={filters} onFilterChange={handleFilterChange} isCapturing={isCapturing} />
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            )
        }
        
        const PurchaseOrderModal = ({ po, onClose }) => {
            const { userData, shops, vendors, purchaseOrders, cashDrops, internalTransfers, appSettings, staffList } = useData();
            const { showNotification } = useNotification();
            const { addDoc, collection, doc, updateDoc, Timestamp } = window.Firebase;
            const isMounted = useRef(true);

            const getInitialFormState = useCallback(() => {
                const userPrimaryShop = shops.find(s => userData?.shopIds?.includes(s.id))?.name || shops[0]?.name || '';
                return {
                    poDate: getCambodiaISODate(),
                    shop: userPrimaryShop,
                    vendor: '',
                    status: 'Unpaid',
                    amountKhr: '',
                    amountUsd: '',
                    note: '',
                    orderBy: userData?.name || ''
                }
            }, [shops, userData]);

            const [formData, setFormData] = useState(getInitialFormState);
            const [isSubmitting, setIsSubmitting] = useState(false);

            useEffect(() => {
                isMounted.current = true;
                if (po) {
                    setFormData({
                        ...po,
                        poDate: formatInCambodiaDateOnly(po.date),
                        amountKhr: String(po.amountKhr || ''),
                        amountUsd: String(po.amountUsd || ''),
                        orderBy: po.orderBy || ''
                    });
                } else {
                    setFormData(getInitialFormState());
                }
                return () => { isMounted.current = false; };
            }, [po, getInitialFormState]);
            
            const availableShops = useMemo(() => {
                if (!userData) return [];
                if (userData.role === 'Admin') return shops;
                return shops.filter(s => userData.shopIds?.includes(s.id));
            }, [shops, userData]);

            const currentGCA = useMemo(() => {
                const activeShop = formData.shop;
                if (!activeShop) return 0;

                const selectedShopData = shops.find(s => s.name === activeShop);
                const openingGCA = selectedShopData?.gca || 0;
                const saleMargin = selectedShopData?.saleMargin || 0;
                const exchangeRate = appSettings.exchangeRate || 4100;

                const netSale = cashDrops.filter(cd => cd.shop === activeShop).reduce((sum, cd) => sum + (cd.grandTotalKhr || 0), 0);
                const salesContribution = netSale * (1 - (saleMargin / 100));
                const totalPO = purchaseOrders.filter(p => p.shop === activeShop && p.id !== po?.id).reduce((sum, p) => sum + ((p.amountKhr || 0) + (p.amountUsd || 0) * exchangeRate), 0);
                const totalTransIn = internalTransfers.filter(it => it.toShop === activeShop).reduce((sum, it) => sum + (it.amountKhr || 0) + ((it.amountUsd || 0) * exchangeRate), 0);
                const totalTransOut = internalTransfers.filter(it => it.fromShop === activeShop).reduce((sum, it) => sum + (it.amountKhr || 0) + ((it.amountUsd || 0) * exchangeRate), 0);
                
                return openingGCA + salesContribution - totalPO - totalTransIn + totalTransOut;
            }, [formData.shop, shops, cashDrops, purchaseOrders, internalTransfers, appSettings, po]);

            const subTotalPOs = useMemo(() => {
                const khr = parseFormattedNumber(formData.amountKhr);
                const usd = parseFormattedNumber(formData.amountUsd);
                return (usd * (appSettings.exchangeRate || 4100)) + khr;
            }, [formData, appSettings.exchangeRate]);
            
            const handleFormChange = (e) => {
                const { name, value } = e.target;
                setFormData(prev => ({...prev, [name]: value}));
            };
            
            const handleVendorSelect = (vendorName) => {
                setFormData(prev => ({...prev, vendor: vendorName}));
            };

            const handleSubmit = async (e) => {
                e.preventDefault();
                const isVendorValid = vendors.some(v => v.name === formData.vendor);
                if (!formData.vendor || !isVendorValid) {
                    showNotification("Please select a valid vendor from the list.", "error");
                    return;
                }
                if (!isMounted.current) return;
                setIsSubmitting(true);

                const dataToSave = {
                    date: createTimestampFromDateAndCurrentTime(formData.poDate),
                    shop: formData.shop,
                    vendor: formData.vendor,
                    status: formData.status,
                    amountKhr: parseFormattedNumber(formData.amountKhr),
                    amountUsd: parseFormattedNumber(formData.amountUsd),
                    note: formData.note,
                    orderBy: formData.orderBy,
                    lastModifiedBy: userData.uid,
                    paidAt: formData.status === 'Paid' && (!po || !po.paidAt) ? Timestamp.now() : (po?.paidAt || null),
                    ...(po ? {} : { createdBy: userData.uid })
                };

                try {
                    if (po) {
                        await updateDoc(doc(window.db, "purchaseOrders", po.id), dataToSave);
                        showNotification("Purchase Order updated!", "success");
                    } else {
                        await addDoc(collection(window.db, "purchaseOrders"), dataToSave);
                        showNotification("Purchase Order created!", "success");
                    }
                    if (isMounted.current) onClose();
                } catch (error) {
                    showNotification("Failed to save Purchase Order.", "error");
                } finally {
                    if (isMounted.current) setIsSubmitting(false);
                }
            };

            return (
                <Modal title={po ? 'Edit Purchase Order' : 'Create Purchase Order'} onClose={onClose} size="4xl">
                    <form onSubmit={handleSubmit} className="space-y-4">
                        <div className="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-4 gap-4">
                            <FormInput label="PO Date" type="date" name="poDate" value={formData.poDate} onChange={handleFormChange} />
                            <FormSelect label="Shop" name="shop" value={formData.shop} onChange={handleFormChange} options={availableShops.map(s => ({value: s.name, label: s.name}))} required />
                            <FormSelect label="Order By" name="orderBy" value={formData.orderBy} onChange={handleFormChange} options={staffList.map(s => ({value: s.name, label: s.name}))} disabled={userData?.role !== 'Admin'}/>
                            <FormInput label="Current GCA (៛)" value={currentGCA.toLocaleString()} disabled readOnly />
                        </div>
                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                            <SearchableSelect label="Vendor" options={vendors} value={formData.vendor} onSelect={handleVendorSelect} />
                            <LiveFormatInput label="Amount KHR" name="amountKhr" value={formData.amountKhr} onChange={handleFormChange} />
                            <LiveFormatInput label="Amount USD" name="amountUsd" value={formData.amountUsd} onChange={handleFormChange} />
                            <FormSelect label="Status" name="status" value={formData.status} onChange={handleFormChange} options={[{value:'Unpaid', label:'Unpaid'}, {value:'Paid', label:'Paid'}]} />
                        </div>
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <FormTextarea label="Note" name="note" value={formData.note} onChange={handleFormChange} />
                            <FormInput label="Sub-Total POs (៛)" value={subTotalPOs.toLocaleString()} disabled readOnly />
                        </div>
                        <div className="flex justify-end gap-2 pt-4 border-t border-slate-700">
                            <Button type="button" variant="secondary" onClick={onClose}>Cancel</Button>
                            <Button type="submit" disabled={isSubmitting} icon={isSubmitting ? "LoaderCircle" : null}>
                                {isSubmitting ? 'Saving...' : (po ? 'Update PO' : 'Create PO')}
                            </Button>
                        </div>
                    </form>
                </Modal>
            );
        };

        const PurchaseOrdersTab = () => {
            const [isModalOpen, setIsModalOpen] = useState(false);
            const [editingPO, setEditingPO] = useState(null);
            
            const handleCreate = () => {
                setEditingPO(null);
                setIsModalOpen(true);
            };

            const handleEdit = (po) => {
                setEditingPO(po);
                setIsModalOpen(true);
            };

            return (
                <div className="space-y-6">
                    <PurchaseOrderHistory onEdit={handleEdit} onCreate={handleCreate} />
                    {isModalOpen && <PurchaseOrderModal po={editingPO} onClose={() => setIsModalOpen(false)} />}
                </div>
            );
        };

        const SearchableSelect = ({ label, options, value, onSelect }) => {
            const [searchTerm, setSearchTerm] = useState(value || '');
            const [isOpen, setIsOpen] = useState(false);
            const wrapperRef = useRef(null);

            useEffect(() => {
                if (value !== searchTerm) {
                    setSearchTerm(value || '');
                }
            }, [value]);

            const filteredOptions = useMemo(() => {
                if (!searchTerm) return options;
                return options.filter(option => 
                    option.name.toLowerCase().includes(searchTerm.toLowerCase())
                );
            }, [searchTerm, options]);

            const handleSelect = (optionName) => {
                onSelect(optionName);
                setSearchTerm(optionName);
                setIsOpen(false);
            };
            
            const handleChange = (e) => {
                const newSearchTerm = e.target.value;
                setSearchTerm(newSearchTerm);
                onSelect(newSearchTerm); // Immediately update parent state
                setIsOpen(true);
            };

            useEffect(() => {
                function handleClickOutside(event) {
                    if (wrapperRef.current && !wrapperRef.current.contains(event.target)) {
                        setIsOpen(false);
                    }
                }
                document.addEventListener("mousedown", handleClickOutside);
                return () => document.removeEventListener("mousedown", handleClickOutside);
            }, [wrapperRef]);
            
            return (
                <div className="relative" ref={wrapperRef}>
                    <FormInput 
                        label={label} 
                        value={searchTerm}
                        onChange={handleChange}
                        onFocus={() => setIsOpen(true)}
                        autoComplete="off"
                        name="vendor-search"
                    />
                    {isOpen && (
                        <ul className="absolute z-10 w-full bg-slate-700 border border-slate-600 rounded-md mt-1 max-h-60 overflow-y-auto shadow-lg">
                            {filteredOptions.length > 0 ? (
                                filteredOptions.map(option => (
                                    <li 
                                        key={option.id} 
                                        className="px-3 py-2 cursor-pointer hover:bg-blue-600 text-slate-200"
                                        onClick={() => handleSelect(option.name)}
                                    >
                                        {option.name}
                                    </li>
                                ))
                            ) : (
                                <li className="px-3 py-2 text-slate-400">No results found</li>
                            )}
                        </ul>
                    )}
                </div>
            );
        };
        
        const PurchaseOrderHistory = ({ onEdit, onCreate }) => {
            const { purchaseOrders, shops, vendors, userData, appSettings } = useData();
            const { showNotification } = useNotification();
            const { doc, deleteDoc, updateDoc, Timestamp } = window.Firebase;
            const isMounted = useRef(true);

            // --- UPDATED: Robust Role Check ---
            const normalizedRole = useMemo(() => userData?.role ? userData.role.trim() : '', [userData]);
            const isAdmin = normalizedRole === 'Admin';
            const isShopManager = normalizedRole === 'Shop Manager';
            // ----------------------------------

            const [filters, setFilters] = useState({ 
                shop: '', 
                vendor: '', 
                status: '', 
                dateRangeType: 'all',
                startDate: '',
                endDate: '',
                month: new Date().toISOString().slice(0, 7)
            });
            const [deletingPO, setDeletingPO] = useState(null);
            const [isDeleting, setIsDeleting] = useState(false);
            const [viewingNote, setViewingNote] = useState(null);
            const [currentPage, setCurrentPage] = useState(1);
            const [rowsPerPage, setRowsPerPage] = useState(15);

            useEffect(() => {
                isMounted.current = true;
                return () => { isMounted.current = false; };
            }, []);

            const availableShops = useMemo(() => {
                if (!userData) return [];
                if (isAdmin) return shops; // Use helper
                return shops.filter(s => userData.shopIds?.includes(s.id));
            }, [shops, userData, isAdmin]);

            const handleFilterChange = (e) => setFilters(prev => ({...prev, [e.target.name]: e.target.value}));

            const filteredPOs = useMemo(() => {
                const userShopNames = (isAdmin)
                    ? null
                    : shops.filter(s => userData?.shopIds?.includes(s.id)).map(s => s.name);

                let startDate = null;
                let endDate = null;

                const { dateRangeType, month, startDate: customStart, endDate: customEnd } = filters;
                // ... (date logic remains the same)
                if (dateRangeType === 'today') {
                    startDate = new Date();
                    startDate.setHours(0, 0, 0, 0);
                    endDate = new Date();
                    endDate.setHours(23, 59, 59, 999);
                } else if (dateRangeType === 'this_week') {
                    const now = new Date();
                    const dayOfWeek = now.getDay();
                    const diff = now.getDate() - dayOfWeek + (dayOfWeek === 0 ? -6 : 1); // Monday as first day
                    startDate = new Date(now.setDate(diff));
                    startDate.setHours(0, 0, 0, 0);
                    endDate = new Date(startDate);
                    endDate.setDate(startDate.getDate() + 6);
                    endDate.setHours(23, 59, 59, 999);
                } else if (dateRangeType === 'by_month' && month) {
                    const [year, monthVal] = month.split('-').map(Number);
                    startDate = new Date(year, monthVal - 1, 1);
                    endDate = new Date(year, monthVal, 0);
                    endDate.setHours(23, 59, 59, 999);
                } else if (dateRangeType === 'custom') {
                    if (customStart) { startDate = new Date(customStart); startDate.setHours(0, 0, 0, 0); }
                    if (customEnd) { endDate = new Date(customEnd); endDate.setHours(23, 59, 59, 999); }
                }

                return purchaseOrders
                    .filter(po => {
                        if(!po.date) return false;
                        
                        const isShopAllowed = userShopNames ? userShopNames.includes(po.shop) : true;
                        if (!isShopAllowed) return false;
                        
                        const poDate = po.date.toDate();
                        const dateMatch = (!startDate || poDate >= startDate) && (!endDate || poDate <= endDate);

                        return (filters.shop ? po.shop === filters.shop : true) &&
                        (filters.vendor ? po.vendor.toLowerCase().includes(filters.vendor.toLowerCase()) : true) &&
                        (filters.status ? po.status === filters.status : true) &&
                        dateMatch;
                    })
                    .sort((a,b) => {
                        if (a.status === 'Unpaid' && b.status !== 'Unpaid') return -1;
                        if (a.status !== 'Unpaid' && b.status === 'Unpaid') return 1;
                        return (b.date?.toDate()?.getTime() || 0) - (a.date?.toDate()?.getTime() || 0);
                    });
            }, [purchaseOrders, filters, userData, shops, isAdmin]); // Added isAdmin
            
            const totalPages = useMemo(() => Math.ceil(filteredPOs.length / rowsPerPage), [filteredPOs, rowsPerPage]);

            const paginatedPOs = useMemo(() => {
                const startIndex = (currentPage - 1) * rowsPerPage;
                return filteredPOs.slice(startIndex, startIndex + rowsPerPage);
            }, [filteredPOs, currentPage, rowsPerPage]);

            const footerTotals = useMemo(() => {
                const exchangeRate = appSettings.exchangeRate || 4100;
                return filteredPOs.reduce((acc, po) => {
                    const khr = po.amountKhr || 0;
                    const usd = po.amountUsd || 0;
                    acc.khr += khr;
                    acc.usd += usd;
                    acc.subTotal += khr + (usd * exchangeRate);
                    return acc;
                }, { khr: 0, usd: 0, subTotal: 0 });
            }, [filteredPOs, appSettings.exchangeRate]);

            const handleDelete = async () => {
                if (!deletingPO) return;
                setIsDeleting(true);
                try {
                    await deleteDoc(doc(window.db, "purchaseOrders", deletingPO.id));
                    showNotification("PO deleted.", "success");
                    if(isMounted.current) setDeletingPO(null);
                } catch (error) {
                    showNotification("Failed to delete PO.", "error");
                } finally {
                    if(isMounted.current) setIsDeleting(false);
                }
            };
            
            const handleMarkPaid = async (poId) => {
                try {
                    await updateDoc(doc(window.db, "purchaseOrders", poId), {
                        status: 'Paid',
                        paidAt: Timestamp.now()
                    });
                    showNotification("PO marked as Paid.", "success");
                } catch (error) {
                    showNotification("Failed to update PO status.", "error");
                }
            };

            const handleExport = useCallback(() => {
               // ... existing export logic ...
               if (!window.XLSX) { showNotification("Excel library not loaded yet.", "error"); return; }
                const exchangeRate = appSettings.exchangeRate || 4100;
                const dataToExport = filteredPOs.map(po => {
                    const subTotal = (po.amountKhr || 0) + ((po.amountUsd || 0) * exchangeRate);
                    return {
                        "PO Date": formatInCambodiaDateOnly(po.date), "Shop": po.shop, "Vendor": po.vendor, "Order By": po.orderBy,
                        "Amount KHR": po.amountKhr || 0, "Amount USD": po.amountUsd || 0, "Sub-Total (៛)": subTotal,
                        "Status": po.status, "Paid At": po.paidAt ? formatInCambodiaTime(po.paidAt) : 'N/A', "Note": po.note || ''
                    }
                });
                const ws = window.XLSX.utils.json_to_sheet(dataToExport);
                const wb = window.XLSX.utils.book_new();
                window.XLSX.utils.book_append_sheet(wb, ws, "PurchaseOrders");
                window.XLSX.writeFile(wb, "PurchaseOrder_History.xlsx");
            }, [showNotification, filteredPOs, appSettings.exchangeRate]);
            
            return (
                <Card>
                    <div className="flex justify-between items-center mb-4 border-b border-slate-700 pb-3">
                        <h2 className="text-xl font-bold text-slate-100">Purchase Order History</h2>
                        <div className="flex gap-2">
                            <Button onClick={handleExport} variant="secondary" icon="Download">Export</Button>
                            <Button onClick={onCreate} icon="Plus">Create PO</Button>
                        </div>
                    </div>
                    {/* ... Filters UI remains same ... */}
                    <div className="p-4 bg-slate-900/50 rounded-lg border border-slate-700">
                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                            <FormSelect label="Shop" name="shop" value={filters.shop} onChange={handleFilterChange} options={[{value:'', label:'All Shops'}, ...availableShops.map(s => ({value: s.name, label: s.name}))]} />
                            <FormInput label="Search Vendor" name="vendor" value={filters.vendor} onChange={handleFilterChange} placeholder="Vendor name..." />
                            <FormSelect label="Status" name="status" value={filters.status} onChange={handleFilterChange} options={[{value:'', label:'All Status'}, {value:'Paid', label:'Paid'}, {value:'Unpaid', label:'Unpaid'}]} />
                            <FormSelect label="Date Range" name="dateRangeType" value={filters.dateRangeType} onChange={handleFilterChange} options={[{ value: 'all', label: 'All' }, { value: 'today', label: 'Today' }, { value: 'this_week', label: 'This Week' }, { value: 'by_month', label: 'By Month' }, { value: 'custom', label: 'Custom' }]} />
                        </div>
                        {filters.dateRangeType === 'by_month' && ( <div className="mt-4"><FormInput label="Select Month" type="month" name="month" value={filters.month} onChange={handleFilterChange} className="max-w-xs" /></div> )}
                        {filters.dateRangeType === 'custom' && ( <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4"><FormInput label="Start Date" type="date" name="startDate" value={filters.startDate} onChange={handleFilterChange} /><FormInput label="End Date" type="date" name="endDate" value={filters.endDate} onChange={handleFilterChange} /></div> )}
                    </div>

                    <div className="overflow-x-auto">
                        <table className="w-full text-sm text-left text-slate-300">
                            <thead className="bg-slate-900/50 text-xs text-slate-400 uppercase">
                                <tr>
                                    <th className="p-3">PO Date</th><th className="p-3">Shop</th><th className="p-3">Vendor</th>
                                    <th className="p-3">Order By</th>
                                    <th className="p-3 text-right">Amount KHR</th><th className="p-3 text-right">Amount USD</th>
                                    <th className="p-3 text-right">Sub-Total (៛)</th><th className="p-3">Status</th>
                                    <th className="p-3 text-center">Actions</th>
                                </tr>
                            </thead>
                            <tbody className="divide-y divide-slate-700">
                                {paginatedPOs.map(po => {
                                    const subTotal = (po.amountKhr || 0) + ((po.amountUsd || 0) * (appSettings.exchangeRate || 4100));
                                    return (
                                    <tr key={po.id} className={`hover:bg-slate-700/50 ${po.status === 'Unpaid' ? 'bg-red-900/30' : ''}`}>
                                        <td className="p-3">{formatInCambodiaDateOnly(po.date)}</td>
                                        <td className="p-3">{po.shop}</td>
                                        <td className="p-3 font-semibold">{po.vendor}</td>
                                        <td className="p-3">{po.orderBy}</td>
                                        <td className="p-3 text-right font-mono">{(po.amountKhr || 0).toLocaleString()}</td>
                                        <td className="p-3 text-right font-mono">{(po.amountUsd || 0).toLocaleString()}</td>
                                        <td className="p-3 text-right font-mono font-bold">{subTotal.toLocaleString()}</td>
                                        <td className="p-3">
                                            <span className={`px-2 py-1 text-xs rounded-full ${po.status === 'Paid' ? 'bg-green-500/20 text-green-300' : 'bg-yellow-500/20 text-yellow-300'}`}>
                                                {po.status}
                                            </span>
                                            {po.status === 'Paid' && po.paidAt ? ` (${formatInCambodiaTime(po.paidAt)})` : ''}
                                        </td>
                                        <td className="p-3 flex gap-1 justify-center">
                                            {po.note && (
                                                <Button variant="ghost" size="sm" onClick={() => setViewingNote(po.note)} className="text-yellow-400" title="View Note">
                                                    <Icon name="FileText"/>
                                                </Button>
                                            )}
                                            {/* --- UPDATED: Use helper booleans for role checks --- */}
                                            {/* Mark as Paid: Admin & Shop Manager can mark unpaid POs as paid */}
                                            {(isAdmin || isShopManager) && po.status === 'Unpaid' && (
                                                <Button variant="ghost" size="sm" onClick={() => handleMarkPaid(po.id)} className="text-green-400" title="Mark as Paid" icon="CheckCircle" />
                                            )}

                                            {/* Edit: Admin can always edit. Shop Manager can only edit UNPAID POs. */}
                                            {(isAdmin || (isShopManager && po.status !== 'Paid')) && (
                                                <Button variant="ghost" size="sm" onClick={() => onEdit(po)} title="Edit PO">
                                                    <Icon name="PenSquare"/>
                                                </Button>
                                            )}
                                            
                                            {/* Delete: Admin can always delete. Shop Manager can only delete UNPAID POs. */}
                                            {(isAdmin || (isShopManager && po.status !== 'Paid')) && (
                                                <Button variant="ghost" size="sm" onClick={() => setDeletingPO(po)} className="text-red-400 hover:bg-red-900/50" title="Delete PO">
                                                    <Icon name="Trash2"/>
                                                </Button>
                                            )}
                                        </td>
                                    </tr>
                                )})}
                            </tbody>
                            {/* ... Footer ... */}
                             <tfoot className="bg-slate-900/50 font-bold text-slate-200 divide-y divide-slate-700">
                                <tr>
                                    <td colSpan="4" className="p-3 text-right">Filtered Totals</td>
                                    <td className="p-3 text-right font-mono">{footerTotals.khr.toLocaleString()}</td>
                                    <td className="p-3 text-right font-mono">{footerTotals.usd.toLocaleString()}</td>
                                    <td className="p-3 text-right font-mono font-bold">{footerTotals.subTotal.toLocaleString()}</td>
                                    <td colSpan="2"></td>
                                </tr>
                                <tr>
                                    <td colSpan="9" className="p-3">
                                        <div className="flex items-center justify-between">
                                            <div className="flex items-center gap-2">
                                                <span className="text-sm">Rows per page:</span>
                                                <select value={rowsPerPage} onChange={e => {setRowsPerPage(Number(e.target.value)); setCurrentPage(1);}} className="p-1 border rounded-md bg-slate-700 border-slate-600">
                                                    <option value={15}>15</option>
                                                    <option value={30}>30</option>
                                                    <option value={45}>45</option>
                                                    <option value={100}>100</option>
                                                </select>
                                            </div>
                                            <div className="flex items-center gap-2">
                                                <span className="text-sm">Page {currentPage} of {totalPages}</span>
                                                <Button onClick={() => setCurrentPage(p => Math.max(1, p - 1))} disabled={currentPage === 1} variant="secondary">&lt;</Button>
                                                <Button onClick={() => setCurrentPage(p => Math.min(totalPages, p + 1))} disabled={currentPage === totalPages} variant="secondary">&gt;</Button>
                                            </div>
                                        </div>
                                    </td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                    {deletingPO && <ConfirmationModal title="Delete Purchase Order" message="Are you sure?" onConfirm={handleDelete} onClose={() => setDeletingPO(null)} isSubmitting={isDeleting} confirmVariant="danger" confirmText="Delete" />}
                    {viewingNote && <NoteViewModal title="Purchase Order Note" onClose={() => setViewingNote(null)} note={viewingNote} />}
                </Card>
            );
        };
        
        // --- RESTORED: InternalTransferModal Component ---
        const InternalTransferModal = ({ transfer, onClose }) => {
            const { shops, userData, appSettings } = useData();
            const { showNotification } = useNotification();
            const { addDoc, collection, doc, updateDoc, Timestamp } = window.Firebase;
            const [isSubmitting, setIsSubmitting] = useState(false);
            const isMounted = useRef(true);

            // Filter shops based on user role for "From Shop"
            const availableSourceShops = useMemo(() => {
                if (!userData) return [];
                if (userData.role === 'Admin' || userData.role === 'Management') return shops;
                return shops.filter(s => userData.shopIds?.includes(s.id));
            }, [shops, userData]);

            const [formData, setFormData] = useState({
                date: getCambodiaISODate(),
                fromShop: '',
                toShop: '',
                amountKhr: '',
                amountUsd: '',
                note: ''
            });

            useEffect(() => {
                isMounted.current = true;
                if (transfer) {
                    setFormData({
                        date: formatInCambodiaDateOnly(transfer.date),
                        fromShop: transfer.fromShop,
                        toShop: transfer.toShop,
                        amountKhr: String(transfer.amountKhr || ''),
                        amountUsd: String(transfer.amountUsd || ''),
                        note: transfer.note || ''
                    });
                } else {
                    setFormData(prev => ({
                        ...prev,
                        fromShop: availableSourceShops[0]?.name || ''
                    }));
                }
                return () => { isMounted.current = false; };
            }, [transfer, availableSourceShops]);

            const handleChange = (e) => setFormData(prev => ({ ...prev, [e.target.name]: e.target.value }));

            const handleSubmit = async (e) => {
                e.preventDefault();
                if (formData.fromShop === formData.toShop) {
                    showNotification("Source and Destination shops cannot be the same.", "error");
                    return;
                }
                
                setIsSubmitting(true);
                const dataToSave = {
                    date: createTimestampFromDateAndCurrentTime(formData.date),
                    fromShop: formData.fromShop,
                    toShop: formData.toShop,
                    amountKhr: parseFormattedNumber(formData.amountKhr),
                    amountUsd: parseFormattedNumber(formData.amountUsd),
                    note: formData.note,
                    transferredBy: userData.name,
                    status: transfer?.status || 'Pending',
                    updatedAt: Timestamp.now()
                };
                
                if (!transfer) {
                    dataToSave.createdBy = userData.uid;
                    dataToSave.createdAt = Timestamp.now();
                }

                try {
                    if (transfer?.id) {
                        await updateDoc(doc(window.db, "internalTransfers", transfer.id), dataToSave);
                        showNotification("Transfer updated.", "success");
                    } else {
                        await addDoc(collection(window.db, "internalTransfers"), dataToSave);
                        showNotification("Transfer created.", "success");
                    }
                    if (isMounted.current) onClose();
                } catch (error) {
                    console.error("Transfer save error:", error);
                    showNotification("Failed to save transfer.", "error");
                } finally {
                    if (isMounted.current) setIsSubmitting(false);
                }
            };

            const subTotal = useMemo(() => {
                 const khr = parseFormattedNumber(formData.amountKhr);
                 const usd = parseFormattedNumber(formData.amountUsd);
                 return khr + (usd * (appSettings.exchangeRate || 4100));
            }, [formData, appSettings]);

            return (
                <Modal title={transfer ? 'Edit Transfer' : 'New Internal Transfer'} onClose={onClose}>
                    <form onSubmit={handleSubmit} className="space-y-4">
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <FormInput label="Date" type="date" name="date" value={formData.date} onChange={handleChange} required />
                            <div className="hidden md:block"></div> 
                            
                            <FormSelect 
                                label="From Shop" 
                                name="fromShop" 
                                value={formData.fromShop} 
                                onChange={handleChange} 
                                options={availableSourceShops.map(s => ({value: s.name, label: s.name}))} 
                                required 
                                disabled={!!transfer} 
                            />
                            <FormSelect 
                                label="To Shop" 
                                name="toShop" 
                                value={formData.toShop} 
                                onChange={handleChange} 
                                options={shops.map(s => ({value: s.name, label: s.name}))} 
                                required 
                            />
                        </div>
                        
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4 bg-slate-700/30 p-4 rounded-lg border border-slate-700">
                            <LiveFormatInput label="Amount KHR" name="amountKhr" value={formData.amountKhr} onChange={handleChange} />
                            <LiveFormatInput label="Amount USD" name="amountUsd" value={formData.amountUsd} onChange={handleChange} />
                            <div className="md:col-span-2 text-right text-sm">
                                <span className="text-slate-400 mr-2">Est. Total:</span>
                                <span className="font-mono font-bold text-emerald-400">{formatCurrency(subTotal, 'KHR')}</span>
                            </div>
                        </div>

                        <FormTextarea label="Note" name="note" value={formData.note} onChange={handleChange} />

                        <div className="flex justify-end gap-3 pt-4 border-t border-slate-700">
                            <Button type="button" variant="secondary" onClick={onClose}>Cancel</Button>
                            <Button type="submit" disabled={isSubmitting} icon={isSubmitting ? "LoaderCircle" : null}>
                                {isSubmitting ? 'Saving...' : (transfer ? 'Update Transfer' : 'Create Transfer')}
                            </Button>
                        </div>
                    </form>
                </Modal>
            );
        };
        // ----------------------------------------------------

        const InternalTransferTab = () => {
             // ... existing hooks ...
            const { showNotification } = useNotification();
            const { deleteDoc, doc, updateDoc, Timestamp } = window.Firebase;
            const { userData } = useAuth();
            
            const [isModalOpen, setIsModalOpen] = useState(false);
            const [editingTransfer, setEditingTransfer] = useState(null);
            const [deletingTransfer, setDeletingTransfer] = useState(null);
            const [isDeleting, setIsDeleting] = useState(false);
            const [confirmingTransfer, setConfirmingTransfer] = useState(null);
            const [isConfirming, setIsConfirming] = useState(false);
            const isMounted = useRef(true);
 
            useEffect(() => {
                isMounted.current = true;
                return () => { isMounted.current = false; };
            }, []);

            // ... handlers (handleCreate, handleEdit, handleConfirmReceive, handleDelete) ...
            const handleCreate = () => { setEditingTransfer(null); setIsModalOpen(true); };
            const handleEdit = (transfer) => { setEditingTransfer(transfer); setIsModalOpen(true); };
            const handleConfirmReceive = async () => {
                if (!confirmingTransfer || !isMounted.current) return;
                setIsConfirming(true);
                try {
                    await updateDoc(doc(window.db, "internalTransfers", confirmingTransfer.id), { status: "Confirmed", confirmedAt: Timestamp.now(), confirmedBy: userData.uid, confirmedByName: userData.name });
                    showNotification("Transfer confirmed successfully!", "success");
                } catch (error) { console.error("Confirmation error:", error); showNotification("Failed to confirm transfer.", "error"); } 
                finally { if (isMounted.current) { setIsConfirming(false); setConfirmingTransfer(null); } }
            };
            const handleDelete = async () => {
                if (!deletingTransfer || !isMounted.current) return;
                setIsDeleting(true);
                try { await deleteDoc(doc(window.db, "internalTransfers", deletingTransfer.id)); showNotification("Transfer deleted.", "success"); } 
                catch (error) { showNotification("Failed to delete transfer.", "error"); } 
                finally { if (isMounted.current) { setIsDeleting(false); setDeletingTransfer(null); } }
            };

            return (
                <div className="space-y-6">
                    <InternalTransferHistory 
                        onCreate={handleCreate}
                        onEdit={handleEdit} 
                        onDelete={(transfer) => setDeletingTransfer(transfer)} 
                        onConfirmReceive={(transfer) => setConfirmingTransfer(transfer)}
                    />
                    {isModalOpen && <InternalTransferModal transfer={editingTransfer} onClose={() => setIsModalOpen(false)} />}
                    {deletingTransfer && <ConfirmationModal title="Delete Transfer" message="Are you sure you want to delete this transfer record?" onConfirm={handleDelete} onClose={() => setDeletingTransfer(null)} isSubmitting={isDeleting} confirmVariant="danger" confirmText="Delete" />}
                    {confirmingTransfer && <ConfirmationModal title="Confirm Transfer Receipt" message={`Are you sure you want to confirm receipt of this transfer from ${confirmingTransfer.fromShop}? This action cannot be undone.`} onConfirm={handleConfirmReceive} onClose={() => setConfirmingTransfer(null)} isSubmitting={isConfirming} confirmVariant="primary" confirmText="Confirm" />}
                </div>
            );
        };
 
        const InternalTransferHistory = ({ onCreate, onEdit, onDelete, onConfirmReceive }) => {
            const { internalTransfers, shops, userData, appSettings } = useData();
            const { showNotification } = useNotification();
            const [filters, setFilters] = useState({ fromShop: '', toShop: '', dateRangeType: 'all', startDate: '', endDate: '', month: new Date().toISOString().slice(0, 7) });
            const [currentPage, setCurrentPage] = useState(1);
            const [rowsPerPage, setRowsPerPage] = useState(15);
            const [viewingNote, setViewingNote] = useState(null);

            // --- UPDATED: Robust Role Check ---
            const normalizedRole = useMemo(() => userData?.role ? userData.role.trim() : '', [userData]);
            const isAdmin = normalizedRole === 'Admin';
            const isShopManager = normalizedRole === 'Shop Manager';
            const isManagement = normalizedRole === 'Management';
            // ----------------------------------

            const handleFilterChange = (e) => setFilters(prev => ({...prev, [e.target.name]: e.target.value}));

            const availableShops = useMemo(() => {
                if (!userData) return [];
                if (isAdmin) return shops;
                return shops.filter(s => userData.shopIds?.includes(s.id));
            }, [shops, userData, isAdmin]);

            const filteredTransfers = useMemo(() => {
                 // ... (Filtering logic same as before, but using isAdmin helper if needed, logic is robust already)
                 let startDate = null;
                let endDate = null;

                const { dateRangeType, month, startDate: customStart, endDate: customEnd } = filters;
                // ... (date logic)
                 if (dateRangeType === 'today') { startDate = new Date(); startDate.setHours(0, 0, 0, 0); endDate = new Date(); endDate.setHours(23, 59, 59, 999); } 
                 else if (dateRangeType === 'this_week') { const now = new Date(); const dayOfWeek = now.getDay(); const diff = now.getDate() - dayOfWeek + (dayOfWeek === 0 ? -6 : 1); startDate = new Date(now.setDate(diff)); startDate.setHours(0, 0, 0, 0); endDate = new Date(startDate); endDate.setDate(startDate.getDate() + 6); endDate.setHours(23, 59, 59, 999); } 
                 else if (dateRangeType === 'by_month' && month) { const [year, monthVal] = month.split('-').map(Number); startDate = new Date(year, monthVal - 1, 1); endDate = new Date(year, monthVal, 0); endDate.setHours(23, 59, 59, 999); } 
                 else if (dateRangeType === 'custom') { if (customStart) { startDate = new Date(customStart); startDate.setHours(0, 0, 0, 0); } if (customEnd) { endDate = new Date(customEnd); endDate.setHours(23, 59, 59, 999); } }
                
                const userShopNames = (isAdmin) ? null : shops.filter(s => userData?.shopIds?.includes(s.id)).map(s => s.name);

                return internalTransfers
                    .filter(t => {
                        if (!t.date) return false;
                        if (userShopNames && !userShopNames.includes(t.fromShop) && !userShopNames.includes(t.toShop)) { return false; }
                        const tDate = t.date.toDate();
                        const dateMatch = (!startDate || tDate >= startDate) && (!endDate || tDate <= endDate);
                        return (filters.fromShop ? t.fromShop === filters.fromShop : true) && (filters.toShop ? t.toShop === filters.toShop : true) && dateMatch;
                    })
                    .sort((a,b) => (b.date?.toDate()?.getTime() || 0) - (a.date?.toDate()?.getTime() || 0));
            }, [internalTransfers, filters, userData, shops, isAdmin]);

            const totalPages = useMemo(() => Math.ceil(filteredTransfers.length / rowsPerPage), [filteredTransfers, rowsPerPage]);
            const paginatedTransfers = useMemo(() => {
                const startIndex = (currentPage - 1) * rowsPerPage;
                return filteredTransfers.slice(startIndex, startIndex + rowsPerPage);
            }, [filteredTransfers, currentPage, rowsPerPage]);

            const footerTotals = useMemo(() => {
                const exchangeRate = appSettings.exchangeRate || 4100;
                return filteredTransfers.reduce((acc, t) => {
                    acc.khr += t.amountKhr || 0;
                    acc.usd += t.amountUsd || 0;
                    acc.subTotal += (t.amountKhr || 0) + ((t.amountUsd || 0) * exchangeRate);
                    return acc;
                }, { khr: 0, usd: 0, subTotal: 0 });
            }, [filteredTransfers, appSettings.exchangeRate]);
            
            const handleExport = useCallback(() => {
                // ... (export logic)
                 const exchangeRate = appSettings.exchangeRate || 4100;
                const dataToExport = filteredTransfers.map(t => {
                    const subTotal = (t.amountKhr || 0) + ((t.amountUsd || 0) * exchangeRate);
                    return { "Date": formatInCambodiaDateOnly(t.date), "From Shop": t.fromShop, "To Shop": t.toShop, "Transferred By": t.transferredBy, "Amount KHR": t.amountKhr || 0, "Amount USD": t.amountUsd || 0, "Sub-Total (៛)": subTotal, "Note": t.note || '' };
                });
                exportToExcel(dataToExport, "Internal_Transfers.xlsx", "Transfers");
                showNotification("Exported successfully!", "success");
            }, [filteredTransfers, appSettings.exchangeRate, showNotification]);

            // --- UPDATED: Use helpers for column visibility ---
            const canEditDelete = isAdmin || isShopManager;

            return (
                <Card>
                    <div className="flex justify-between items-center mb-4 border-b border-slate-700 pb-3">
                         <h2 className="text-xl font-bold text-slate-100">Internal Transfer History</h2>
                         <div className="flex gap-2">
                             <Button onClick={handleExport} variant="secondary" icon="Download">Export</Button>
                             <Button onClick={onCreate} icon="Plus">Create Transfer</Button>
                         </div>
                    </div>
                     <div className="p-4 bg-slate-900/50 rounded-lg border border-slate-700 mb-4">
                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                            <FormSelect label="From Shop" name="fromShop" value={filters.fromShop} onChange={handleFilterChange} options={[{value:'', label:'All Shops'}, ...availableShops.map(s => ({value: s.name, label: s.name}))]} />
                            <FormSelect label="To Shop" name="toShop" value={filters.toShop} onChange={handleFilterChange} options={[{value:'', label:'All Shops'}, ...availableShops.map(s => ({value: s.name, label: s.name}))]} />
                            <FormSelect label="Date Range" name="dateRangeType" value={filters.dateRangeType} onChange={handleFilterChange} options={[{ value: 'all', label: 'All' }, { value: 'today', label: 'Today' }, { value: 'this_week', label: 'This Week' }, { value: 'by_month', label: 'By Month' }, { value: 'custom', label: 'Custom' }]} />
                        </div>
                        {filters.dateRangeType === 'by_month' && ( <div className="mt-4"><FormInput label="Select Month" type="month" name="month" value={filters.month} onChange={handleFilterChange} className="max-w-xs" /></div> )}
                        {filters.dateRangeType === 'custom' && ( <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4"><FormInput label="Start Date" type="date" name="startDate" value={filters.startDate} onChange={handleFilterChange} /><FormInput label="End Date" type="date" name="endDate" value={filters.endDate} onChange={handleFilterChange} /></div> )}
                    </div>
                    <div className="overflow-x-auto">
                        <table className="w-full text-sm text-left text-slate-300">
                            <thead className="bg-slate-900/50 text-xs text-slate-400 uppercase">
                                <tr>
                                    <th className="p-3">Date</th><th className="p-3">From</th><th className="p-3">To</th>
                                    <th className="p-3">By</th>
                                    <th className="p-3 text-right">Amount KHR</th><th className="p-3 text-right">Amount USD</th>
                                    <th className="p-3 text-right">Sub-Total (៛)</th>
                                    <th className="p-3">Status</th>
                                    {/* Action column is conditional */}
                                    {canEditDelete && <th className="p-3 text-center">Actions</th>}
                                </tr>
                            </thead>
                            <tbody className="divide-y divide-slate-700">
                                {paginatedTransfers.map(t => {
                                    const subTotal = (t.amountKhr || 0) + ((t.amountUsd || 0) * (appSettings.exchangeRate || 4100));
                                    const userShopNames = availableShops.map(s => s.name);
                                    // Use helpers here too
                                    const canConfirm = (isAdmin || isManagement || userShopNames.includes(t.toShop)) && t.status !== 'Confirmed';
                                    const isConfirmed = t.status === 'Confirmed';
                                    
                                    return (
                                    // --- UPDATED: Highlight Pending with Red ---
                                    <tr key={t.id} className={`hover:bg-slate-700/50 ${!isConfirmed ? 'bg-red-900/30' : ''}`}>
                                    {/* ----------------------------------------- */}
                                        <td className="p-3">{formatInCambodiaDateOnly(t.date)}</td>
                                        <td className="p-3 font-semibold">{t.fromShop}</td>
                                        <td className="p-3 font-semibold">{t.toShop}</td>
                                        <td className="p-3">{t.transferredBy}</td>
                                        <td className="p-3 text-right font-mono">{(t.amountKhr || 0).toLocaleString()}</td>
                                        <td className="p-3 text-right font-mono">{(t.amountUsd || 0).toLocaleString()}</td>
                                        <td className="p-3 text-right font-mono font-bold">{subTotal.toLocaleString()}</td>
                                        <td className="p-3">
                                            {isConfirmed ? (
                                                <span className="flex flex-col"><span className="px-2 py-1 text-xs rounded-full bg-green-500/20 text-green-300 w-fit">Confirmed</span>{t.confirmedAt && <span className="text-xs text-slate-400 mt-1">{formatInCambodiaTime(t.confirmedAt)}</span>}</span>
                                            ) : ( <span className="px-2 py-1 text-xs rounded-full bg-yellow-500/20 text-yellow-300 w-fit">{t.status || 'Pending'}</span> )}
                                        </td>
                                        {canEditDelete && (
                                            <td className="p-3 flex gap-1 justify-center">
                                                {t.note && (
                                                    <Button variant="ghost" size="sm" onClick={() => setViewingNote(t.note)} className="text-yellow-400" title="View Note">
                                                        <Icon name="FileText"/>
                                                    </Button>
                                                )}
                                                {canConfirm && (
                                                    <Button variant="ghost" size="sm" onClick={() => onConfirmReceive(t)} className="text-green-400 hover:bg-green-900/50" title="Confirm Receipt">
                                                        <Icon name="CheckCircle"/>
                                                    </Button>
                                                )}
                                                {!isConfirmed && (
                                                    <Button variant="ghost" size="sm" onClick={() => onEdit(t)} title="Edit"><Icon name="PenSquare"/></Button>
                                                )}
                                                {(!isConfirmed || isAdmin) && (
                                                    <Button variant="ghost" size="sm" onClick={() => onDelete(t)} className="text-red-400 hover:bg-red-900/50" title="Delete"><Icon name="Trash2"/></Button>
                                                )}
                                            </td>
                                        )}
                                    </tr>
                                )})}
                            </tbody>
                            {/* ... Footer ... */}
                             <tfoot className="bg-slate-900/50 font-bold text-slate-200">
                                <tr>
                                    <td colSpan={canEditDelete ? 9 : 8} className="p-3">
                                        {/* ... Pagination ... */}
                                         <div className="flex items-center justify-between">
                                            <span className="text-sm">Page {currentPage} of {totalPages}</span>
                                            <div className="flex items-center gap-2">
                                                <Button onClick={() => setCurrentPage(p => Math.max(1, p - 1))} disabled={currentPage === 1} variant="secondary">&lt;</Button>
                                                <Button onClick={() => setCurrentPage(p => Math.min(totalPages, p + 1))} disabled={currentPage === totalPages} variant="secondary">&gt;</Button>
                                            </div>
                                        </div>
                                    </td>
                                </tr>
                                <tr>
                                    <td colSpan="4" className="p-3 text-right">Filtered Totals</td>
                                    <td className="p-3 text-right font-mono">{footerTotals.khr.toLocaleString()}</td>
                                    <td className="p-3 text-right font-mono">{footerTotals.usd.toLocaleString()}</td>
                                    <td className="p-3 text-right font-mono">{footerTotals.subTotal.toLocaleString()}</td>
                                    <td></td>
                                    {canEditDelete && <td></td>}
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                    {viewingNote && <NoteViewModal title="Internal Transfer Note" onClose={() => setViewingNote(null)} note={viewingNote} />}
                </Card>
            );
        };

        const VendorTrackingTab = () => {
            const { purchaseOrders, vendors, shops, appSettings } = useData();
            const { userData } = useAuth();
            const { showNotification } = useNotification();
            const [filters, setFilters] = useState({ 
                shop: '', 
                dateRangeType: 'this_month',
                month: new Date().toISOString().slice(0, 7) 
            });
            const [vendorPage, setVendorPage] = useState(1);
            const vendorPageSize = 20;
            const [searchTerm, setSearchTerm] = useState('');

            const handleFilterChange = (e) => {
                setFilters(prev => ({ ...prev, [e.target.name]: e.target.value }));
                setVendorPage(1); // Reset page on filter change
            };
            
            const handleSearchChange = (e) => {
                setSearchTerm(e.target.value);
                setVendorPage(1);
            };

            const filteredPOs = useMemo(() => {
                const now = new Date();
                let startDate, endDate;

                switch (filters.dateRangeType) {
                    case 'last_month':
                        startDate = new Date(now.getFullYear(), now.getMonth() - 1, 1);
                        endDate = new Date(now.getFullYear(), now.getMonth(), 0, 23, 59, 59, 999);
                        break;
                    case 'this_year':
                        startDate = new Date(now.getFullYear(), 0, 1);
                        endDate = new Date(now.getFullYear(), 11, 31, 23, 59, 59, 999);
                        break;
                    case 'by_month':
                        const [year, month] = filters.month.split('-').map(Number);
                        startDate = new Date(year, month - 1, 1);
                        endDate = new Date(year, month, 0, 23, 59, 59, 999);
                        break;
                    case 'this_month':
                    default:
                        startDate = new Date(now.getFullYear(), now.getMonth(), 1);
                        endDate = new Date(now.getFullYear(), now.getMonth() + 1, 0, 23, 59, 59, 999);
                        break;
                }

                return purchaseOrders.filter(po => {
                    if (!po.date) return false;
                    const shopMatch = !filters.shop || po.shop === filters.shop;
                    const poDate = po.date.toDate();
                    const dateMatch = poDate >= startDate && poDate <= endDate;
                    return shopMatch && dateMatch;
                });
            }, [purchaseOrders, filters]);

            const { activeVendorsData, inactiveVendors } = useMemo(() => {
                const exchangeRate = appSettings.exchangeRate || 4100;

                const summary = filteredPOs.reduce((acc, po) => {
                    const vendorName = po.vendor;
                    if (!acc[vendorName]) {
                        acc[vendorName] = { name: vendorName, totalAmountKhr: 0, totalPaidKhr: 0, poCount: 0 };
                    }

                    const poTotalKhr = (po.amountKhr || 0) + ((po.amountUsd || 0) * exchangeRate);
                    acc[vendorName].totalAmountKhr += poTotalKhr;
                    if (po.status === 'Paid') {
                        acc[vendorName].totalPaidKhr += poTotalKhr;
                    }
                    acc[vendorName].poCount++;
                    return acc;
                }, {});
                
                let processedActiveVendors = Object.values(summary)
                    .map(v => ({...v, balanceDueKhr: v.totalAmountKhr - v.totalPaidKhr}))
                    .sort((a, b) => b.totalAmountKhr - a.totalAmountKhr);

                const allVendorNames = vendors.map(v => v.name);
                const activeVendorNames = new Set(Object.keys(summary));
                let processedInactiveVendors = allVendorNames.filter(name => !activeVendorNames.has(name));

                if (searchTerm) {
                    const lowercasedFilter = searchTerm.toLowerCase();
                    processedActiveVendors = processedActiveVendors.filter(vendor =>
                        vendor.name.toLowerCase().includes(lowercasedFilter)
                    );
                    processedInactiveVendors = processedInactiveVendors.filter(name =>
                        name.toLowerCase().includes(lowercasedFilter)
                    );
                }

                return { activeVendorsData: processedActiveVendors, inactiveVendors: processedInactiveVendors };
            }, [filteredPOs, vendors, appSettings.exchangeRate, searchTerm]);

            const totalVendorPages = Math.ceil(activeVendorsData.length / vendorPageSize);
            const paginatedActiveVendors = useMemo(() => {
                const startIndex = (vendorPage - 1) * vendorPageSize;
                return activeVendorsData.slice(startIndex, startIndex + vendorPageSize);
            }, [activeVendorsData, vendorPage, vendorPageSize]);
            
            const handleExport = useCallback(() => {
                const dataToExport = activeVendorsData.map(vendor => ({
                    "Vendor": vendor.name,
                    "POs": vendor.poCount,
                    "Total Amount (៛)": vendor.totalAmountKhr,
                    "Balance Due (៛)": vendor.balanceDueKhr
                }));
                exportToExcel(dataToExport, "Vendor_Activity.xlsx", "Active Vendors");
                showNotification("Vendor activity exported!", "success");
            }, [activeVendorsData, showNotification]);

            return (
                <div className="space-y-6">
                    <Card>
                        <h2 className="text-xl font-bold text-slate-100 mb-4 border-b border-slate-700 pb-3">Vendor Activity Report</h2>
                        <div className="flex flex-wrap gap-4 items-end">
                            <div className="flex-1 min-w-[200px]">
                                <FormInput 
                                    label="Search Vendor" 
                                    name="vendorSearch" 
                                    value={searchTerm} 
                                    onChange={handleSearchChange} 
                                    placeholder="Enter vendor name..." 
                                />
                            </div>
                            <div className="flex-1 min-w-[200px]">
                                <FormSelect label="Shop" name="shop" value={filters.shop} onChange={handleFilterChange} options={[{value: '', label: 'All Shops'}, ...shops.map(s => ({value: s.name, label: s.name}))]} />
                            </div>
                            <div className="flex-1 min-w-[200px]">
                                <FormSelect 
                                    label="Date Range"
                                    name="dateRangeType"
                                    value={filters.dateRangeType}
                                    onChange={handleFilterChange}
                                    options={[
                                        {value: 'this_month', label: 'This Month'},
                                        {value: 'last_month', label: 'Last Month'},
                                        {value: 'this_year', label: 'This Year'},
                                        {value: 'by_month', label: 'Select Month'},
                                    ]}
                                />
                            </div>
                            {filters.dateRangeType === 'by_month' && (
                                <div className="flex-1 min-w-[200px]">
                                    <FormInput 
                                        label="Select Month"
                                        type="month"
                                        name="month"
                                        value={filters.month}
                                        onChange={handleFilterChange}
                                    />
                                </div>
                            )}
                            <Button onClick={handleExport} variant="secondary" icon="Download">Export</Button>
                        </div>
                    </Card>

                    <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <Card className="lg:col-span-2">
                             <h3 className="text-lg font-bold mb-4 text-slate-100">Active Vendors</h3>
                             <div className="overflow-x-auto">
                                <table className="w-full text-sm text-left text-slate-300">
                                    <thead className="bg-slate-900/50 text-xs text-slate-400 uppercase">
                                        <tr>
                                            <th className="p-3">Vendor</th>
                                            <th className="p-3 text-center">POs</th>
                                            {userData?.role === 'Admin' && <th className="p-3 text-right">Total Amount (៛)</th>}
                                            <th className="p-3 text-right">Balance Due (៛)</th>
                                        </tr>
                                    </thead>
                                    <tbody className="divide-y divide-slate-700">
                                        {paginatedActiveVendors.map(vendor => (
                                            <tr key={vendor.name} className="hover:bg-slate-700/50">
                                                <td className="p-3 font-semibold text-blue-400">{vendor.name}</td>
                                                <td className="p-3 text-center font-mono">{vendor.poCount}</td>
                                                {userData?.role === 'Admin' && <td className="p-3 text-right font-mono">{formatCurrency(vendor.totalAmountKhr, 'KHR')}</td>}
                                                <td className={`p-3 text-right font-mono font-bold ${vendor.balanceDueKhr > 0 ? 'text-red-400' : 'text-slate-300'}`}>{formatCurrency(vendor.balanceDueKhr, 'KHR')}</td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </div>
                            <div className="flex justify-end items-center gap-2 mt-4">
                                <Button onClick={() => setVendorPage(p => Math.max(1, p - 1))} disabled={vendorPage === 1} variant="secondary">Previous</Button>
                                <span className="text-sm font-medium px-2">Page {vendorPage} of {totalVendorPages || 1}</span>
                                <Button onClick={() => setVendorPage(p => Math.min(totalVendorPages, p + 1))} disabled={vendorPage === totalVendorPages || totalVendorPages === 0} variant="secondary">Next</Button>
                            </div>
                        </Card>
                        <Card>
                            <h3 className="text-lg font-bold mb-4 text-slate-100">Inactive Vendors</h3>
                            {inactiveVendors.length > 0 ? (
                                <ul className="space-y-2 max-h-96 overflow-y-auto pr-2">
                                    {inactiveVendors.map((name, index) => (
                                        <li key={`${name}-${index}`} className="p-2 bg-slate-700/50 rounded-md text-slate-300">{name}</li>
                                    ))}
                                </ul>
                            ) : (
                                <p className="text-slate-400">All vendors have been active in this period.</p>
                            )}
                        </Card>
                    </div>
                </div>
            );
        };

        const VendorViewModal = ({ vendor, onClose }) => {
            if (!vendor) return null;

            const DetailItem = ({ label, value, fullWidth = false }) => (
                <div className={fullWidth ? 'col-span-1 md:col-span-2' : ''}>
                    <p className="text-sm font-medium text-slate-400 mb-1">{label}</p>
                    <p className="text-md text-slate-200 bg-slate-700/50 p-2 rounded-md min-h-[40px] whitespace-pre-wrap">{value || 'N/A'}</p>
                </div>
            );

            return (
                <Modal title="Vendor Details" onClose={onClose} size="2xl">
                    <div className="space-y-6">
                        <div className="pb-4 border-b border-slate-700">
                             <DetailItem label="Vendor Name" value={vendor.name} fullWidth />
                        </div>
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <DetailItem label="Contact Person" value={vendor.contactPerson} />
                            <DetailItem label="Phone Number" value={vendor.phone} />
                        </div>
                        <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <DetailItem label="Bank Name" value={vendor.bankName} />
                            <DetailItem label="Acc No (៛)" value={vendor.accNoKhr} />
                            <DetailItem label="Acc. No ($)" value={vendor.accNoUsd} />
                        </div>
                        <div>
                             <DetailItem label="Address" value={vendor.address} fullWidth />
                        </div>
                    </div>
                    <div className="flex justify-end gap-4 pt-6 mt-6 border-t border-slate-700">
                        <Button type="button" onClick={onClose} variant="secondary">Close</Button>
                    </div>
                </Modal>
            );
        };

        const ManageVendorsSection = () => {
            const { vendors } = useData();
            const { showNotification } = useNotification();
            const { doc, addDoc, updateDoc, deleteDoc, collection } = window.Firebase;
            
            const [isModalOpen, setIsModalOpen] = useState(false);
            const [editingVendor, setEditingVendor] = useState(null);
            const [deletingVendor, setDeletingVendor] = useState(null);
            const [isDeleting, setIsDeleting] = useState(false);
            const [searchTerm, setSearchTerm] = useState('');
            const [viewingVendor, setViewingVendor] = useState(null);

            const openModal = (vendor = null) => {
                setEditingVendor(vendor);
                setIsModalOpen(true);
            };

            const handleDelete = async () => {
                if (!deletingVendor) return;
                setIsDeleting(true);
                try {
                    await deleteDoc(doc(window.db, "vendors", deletingVendor.id));
                    showNotification("Vendor deleted.", "success");
                } catch (error) {
                    showNotification("Failed to delete vendor.", "error");
                } finally {
                    setIsDeleting(false);
                    setDeletingVendor(null);
                }
            };

            const filteredVendors = useMemo(() => {
                if (!searchTerm) {
                    return vendors;
                }
                return vendors.filter(vendor => 
                    vendor.name.toLowerCase().includes(searchTerm.toLowerCase())
                );
            }, [vendors, searchTerm]);
            
            const handleExport = useCallback(() => {
                const dataToExport = filteredVendors.map(vendor => ({
                    "Name": vendor.name,
                    "Contact Person": vendor.contactPerson || '',
                    "Phone": vendor.phone || '',
                    "Address": vendor.address || '',
                    "Bank Name": vendor.bankName || '',
                    "Account No (KHR)": vendor.accNoKhr || '',
                    "Account No (USD)": vendor.accNoUsd || ''
                }));
                exportToExcel(dataToExport, "Vendors_List.xlsx", "Vendors");
                showNotification("Vendors list exported!", "success");
            }, [filteredVendors, showNotification]);

            return (
                <Card>
                    <div className="flex justify-between items-center mb-4 border-b border-slate-700 pb-3">
                        <h2 className="text-xl font-bold text-slate-100">Manage Vendors</h2>
                        <div className="flex items-center gap-2">
                            <Button onClick={handleExport} variant="secondary" icon="Download">Export</Button>
                            <Button onClick={() => openModal()} icon="Plus">Add Vendor</Button>
                        </div>
                    </div>
                    <div className="mb-4">
                        <FormInput 
                            placeholder="Search by vendor name..."
                            value={searchTerm}
                            onChange={(e) => setSearchTerm(e.target.value)}
                        />
                    </div>
                    <div className="overflow-x-auto">
                        <table className="w-full text-left text-sm">
                            <thead className="text-xs text-slate-400 uppercase bg-slate-900/50">
                                <tr>
                                    <th className="p-3">Name</th>
                                    <th className="p-3">Contact Person</th>
                                    <th className="p-3">Phone</th>
                                    <th className="p-3">Bank Name</th>
                                    <th className="p-3 text-center">Actions</th>
                                </tr>
                            </thead>
                            <tbody className="text-sm text-slate-300 divide-y divide-slate-700">
                                {filteredVendors.map(vendor => (
                                    <tr key={vendor.id} className="hover:bg-slate-700/50">
                                        <td className="p-3 font-semibold text-slate-200">{vendor.name}</td>
                                        <td className="p-3">{vendor.contactPerson || 'N/A'}</td>
                                        <td className="p-3">{vendor.phone || 'N/A'}</td>
                                        <td className="p-3">{vendor.bankName || 'N/A'}</td>
                                        <td className="p-3 flex gap-1 justify-center">
                                            <Button variant="ghost" onClick={() => setViewingVendor(vendor)} title="View Details"><Icon name="Eye"/></Button>
                                            <Button variant="ghost" onClick={() => openModal(vendor)} title="Edit Vendor"><Icon name="PenSquare"/></Button>
                                            <Button variant="ghost" onClick={() => setDeletingVendor(vendor)} className="text-red-400 hover:bg-red-900/50" title="Delete Vendor"><Icon name="Trash2"/></Button>
                                        </td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                    {isModalOpen && <VendorFormModal vendor={editingVendor} onClose={() => setIsModalOpen(false)} />}
                    {deletingVendor && <ConfirmationModal title="Delete Vendor" message={`Are you sure you want to delete ${deletingVendor.name}?`} onConfirm={handleDelete} onClose={() => setDeletingVendor(null)} isSubmitting={isDeleting} confirmVariant="danger" confirmText="Delete" />}
                    {viewingVendor && <VendorViewModal vendor={viewingVendor} onClose={() => setViewingVendor(null)} />}
                </Card>
            );
        };

        const VendorFormModal = ({ vendor, onClose }) => {
            const { vendors } = useData();
            const { showNotification } = useNotification();
            const { doc, addDoc, updateDoc, collection } = window.Firebase;
            const [formData, setFormData] = useState({
                name: '', contactPerson: '', phone: '', address: '', bankName: '', accNoKhr: '', accNoUsd: '',
                ...vendor
            });
            const [isSubmitting, setIsSubmitting] = useState(false);

            const handleChange = (e) => {
                setFormData(prev => ({ ...prev, [e.target.name]: e.target.value }));
            };

            const handleSubmit = async (e) => {
                e.preventDefault();
                const trimmedName = formData.name.trim();
                if (!trimmedName) {
                    showNotification("Vendor name is required.", "error");
                    return;
                }

                const isDuplicate = vendors.some(
                    v => v.name.toLowerCase() === trimmedName.toLowerCase() && v.id !== vendor?.id
                );

                if (isDuplicate) {
                    showNotification("A vendor with this name already exists.", "error");
                    return;
                }

                setIsSubmitting(true);
                const dataToSave = { ...formData, name: trimmedName };
                delete dataToSave.id;

                try {
                    if (vendor?.id) {
                        await updateDoc(doc(window.db, "vendors", vendor.id), dataToSave);
                        showNotification("Vendor updated successfully!", "success");
                    } else {
                        await addDoc(collection(window.db, "vendors"), dataToSave);
                        showNotification("Vendor added successfully!", "success");
                    }
                    onClose();
                } catch (error) {
                    showNotification("Failed to save vendor.", "error");
                } finally {
                    setIsSubmitting(false);
                }
            };

            return (
                <Modal title={vendor ? 'Edit Vendor' : 'Add New Vendor'} onClose={onClose} size="2xl">
                    <form onSubmit={handleSubmit} className="space-y-4">
                        <FormInput label="Vendor Name" name="name" value={formData.name} onChange={handleChange} required />
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <FormInput label="Contact Person" name="contactPerson" value={formData.contactPerson} onChange={handleChange} />
                            <FormInput label="Phone Number" name="phone" value={formData.phone} onChange={handleChange} />
                        </div>
                        <FormInput label="Bank Name" name="bankName" value={formData.bankName} onChange={handleChange} />
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <FormInput label="Acc No (៛)" name="accNoKhr" value={formData.accNoKhr} onChange={handleChange} />
                            <FormInput label="Acc. No ($)" name="accNoUsd" value={formData.accNoUsd} onChange={handleChange} />
                        </div>
                        <FormTextarea label="Address" name="address" value={formData.address} onChange={handleChange} />
                        <div className="flex justify-end gap-4 pt-4 border-t border-slate-700">
                            <Button type="button" onClick={onClose} variant="secondary">Cancel</Button>
                            <Button type="submit" disabled={isSubmitting} icon={isSubmitting ? "LoaderCircle" : null}>
                                {isSubmitting ? 'Saving...' : 'Save Vendor'}
                            </Button>
                        </div>
                    </form>
                </Modal>
            );
        };
        // --- END: Purchase Order Page ---
        
        // --- START: Expense Report Page ---
        const ExpenseFormModal = ({ expense, onClose }) => {
            const { userData, shops, businessCategories, familyCategories, appSettings } = useData();
            const { showNotification } = useNotification();
            const { doc, addDoc, updateDoc, collection } = window.Firebase;
            const [isSubmitting, setIsSubmitting] = useState(false);
            const isMounted = useRef(true);
            const shareholders = useMemo(() => [...new Set(shops.flatMap(s => (s.shareholders || []).map(sh => sh.name)))], [shops]);

            const getInitialState = useCallback(() => {
                const userAvailableShops = (userData?.role === 'Admin' || userData?.role === 'Management')
                    ? shops
                    : shops.filter(s => userData?.shopIds?.includes(s.id));
                const defaultShop = userAvailableShops[0]?.name || '';

                return {
                    expenseType: 'Business', date: getCambodiaISODate(), shop: defaultShop,
                    category: '', amountKhr: '', amountUsd: '', note: '', paidBy: shareholders[0] || ''
                }
            }, [shops, shareholders, userData]);
            
            const [formData, setFormData] = useState(getInitialState);

            useEffect(() => {
                isMounted.current = true;
                if (expense) {
                    setFormData({
                        id: expense.id, expenseType: expense.type, date: getCambodiaISODate(expense.date.toDate()),
                        shop: expense.shop || '', category: expense.category, amountKhr: String(expense.amountKhr || ''),
                        amountUsd: String(expense.amountUsd || ''), note: expense.note || '',
                        paidBy: expense.paidBy || (shareholders[0] || '')
                    });
                } else {
                    setFormData(getInitialState());
                }
                return () => { isMounted.current = false; };
            }, [expense, getInitialState, shareholders]);

            const subTotalKhr = useMemo(() => {
                const khr = parseFormattedNumber(formData.amountKhr);
                const usd = parseFormattedNumber(formData.amountUsd);
                return (usd * (appSettings.exchangeRate || 4100)) + khr;
            }, [formData.amountKhr, formData.amountUsd, appSettings.exchangeRate]);

            const handleChange = (e) => {
                const { name, value } = e.target;
                setFormData(prev => ({ ...prev, [name]: value }));
            };

            const handleSubmit = async (e) => {
                e.preventDefault();
                if (!isMounted.current) return;
                setIsSubmitting(true);
                const collectionName = formData.expenseType === 'Business' ? 'businessExpenses' : 'familyExpenses';
                const dataToSave = {
                    date: createTimestampFromDateAndCurrentTime(formData.date), category: formData.category,
                    amountKhr: parseFormattedNumber(formData.amountKhr), amountUsd: parseFormattedNumber(formData.amountUsd),
                    totalAmountKhr: subTotalKhr, note: formData.note, submittedBy: userData.uid,
                    recordedBy: userData.name,
                    ...(formData.expenseType === 'Business' ? { shop: formData.shop } : { paidBy: formData.paidBy })
                };

                try {
                    if (expense?.id) {
                        await updateDoc(doc(window.db, collectionName, expense.id), dataToSave);
                        showNotification("Expense updated successfully!", "success");
                    } else {
                        await addDoc(collection(window.db, collectionName), dataToSave);
                        showNotification("Expense added successfully!", "success");
                    }
                    if (isMounted.current) { onClose(); }
                } catch (error) {
                    showNotification("Failed to save expense.", "error");
                } finally {
                    if (isMounted.current) { setIsSubmitting(false); }
                }
            };

            const availableShops = useMemo(() => {
                if (!userData) return [];
                if (userData.role === 'Admin' || userData.role === 'Management') return shops;
                return shops.filter(s => userData.shopIds?.includes(s.id));
            }, [shops, userData]);

            const expenseTypeOptions = useMemo(() => [
                { value: 'Business', label: 'Business Expense' },
                ...((userData?.role === 'Admin' || userData?.role === 'Management') ? [{ value: 'Family', label: 'Family Expense' }] : [])
            ], [userData]);

            const categoryOptions = formData.expenseType === 'Business' ? businessCategories : familyCategories;

            return (
                <Modal title={expense ? 'Edit Expense' : 'Add New Expense'} onClose={onClose} size="2xl">
                    <form onSubmit={handleSubmit} className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 items-end">
                        <FormSelect label="Expense Type" name="expenseType" value={formData.expenseType} onChange={handleChange} options={expenseTypeOptions} />
                        <FormInput label="Date" type="date" name="date" value={formData.date} onChange={handleChange} />
                        
                        {formData.expenseType === 'Business' ? (
                            <FormSelect label="Shop" name="shop" value={formData.shop} onChange={handleChange} options={availableShops.map(s => ({value: s.name, label: s.name}))} />
                        ) : (
                            <FormSelect label="Paid By Shareholder" name="paidBy" value={formData.paidBy} onChange={handleChange} options={shareholders.map(s => ({value: s, label: s}))} />
                        )}

                        <FormSelect label="Category" name="category" value={formData.category} onChange={handleChange} options={[{value: '', label: 'Select Category'}, ...categoryOptions.map(c => ({value: c.name, label: c.name}))]} />
                        
                        <LiveFormatInput label="Amount (KHR)" name="amountKhr" value={formData.amountKhr} onChange={handleChange} />
                        <LiveFormatInput label="Amount (USD)" name="amountUsd" value={formData.amountUsd} onChange={handleChange} />
                        
                        <div className="p-2 bg-slate-700 rounded-md">
                            <label className="block text-sm font-medium text-slate-300 mb-1">Sub-Total (KHR)</label>
                            <p className="font-bold text-lg text-red-400">{formatCurrency(subTotalKhr, 'KHR')}</p>
                        </div>
                        
                        <div className="lg:col-span-4">
                            <FormInput label="Note" name="note" value={formData.note} onChange={handleChange} />
                        </div>
                        <div className="lg:col-span-4 flex justify-end gap-4 pt-4 border-t border-slate-700">
                            <Button type="button" onClick={onClose} variant="secondary">Cancel</Button>
                            <Button type="submit" disabled={isSubmitting} icon={isSubmitting ? "LoaderCircle" : null}>
                                {isSubmitting ? 'Saving...' : (expense ? 'Update Expense' : 'Save Expense')}
                            </Button>
                        </div>
                    </form>
                </Modal>
            );
        };

        const ExpenseReportPage = () => {
            const { userData, businessExpenses, familyExpenses, shops, businessCategories, familyCategories } = useData();
            const { showNotification } = useNotification();
            const { doc, deleteDoc } = window.Firebase;

            const [editingExpense, setEditingExpense] = useState(null);
            const [deletingExpense, setDeletingExpense] = useState(null);
            const [viewingExpense, setViewingExpense] = useState(null);
            const [isFormModalOpen, setIsFormModalOpen] = useState(false);
            const [isDeleting, setIsDeleting] = useState(false);
            // --- NEW: View Mode State ---
            const [isAggregated, setIsAggregated] = useState(false); 
            // ---------------------------
            const [filters, setFilters] = useState({ 
                shop: 'all', 
                category: 'all', 
                expenseType: 'all',
                dateRangeType: 'this_month',
                startDate: '',
                endDate: '',
            });
            const isMounted = useRef(true);

            useEffect(() => {
                isMounted.current = true;
                return () => { isMounted.current = false; };
            }, []);

            const availableShops = useMemo(() => {
                if (!userData) return [];
                if (userData.role === 'Admin' || userData?.role === 'Management') return shops;
                return shops.filter(s => userData.shopIds?.includes(s.id));
            }, [shops, userData]);

            const handleOpenForm = (expense = null) => {
                setEditingExpense(expense);
                setIsFormModalOpen(true);
            };

            const handleCloseForm = () => {
                setEditingExpense(null);
                setIsFormModalOpen(false);
            };

            const handleFilterChange = (e) => {
                const { name, value } = e.target;
                setFilters(prev => {
                    let newState = { ...prev, [name]: value };
                    if (name === 'shop' && value !== 'all') {
                        newState.expenseType = 'Business';
                        newState.category = 'all';
                    }
                    if (name === 'expenseType') {
                        newState.category = 'all';
                    }
                    return newState;
                });
            };
            
            const availableCategories = useMemo(() => {
                let categories = [];
                if (filters.expenseType === 'Business') {
                    categories = businessCategories.map(c => c.name);
                } else if (filters.expenseType === 'Family') {
                    categories = familyCategories.map(c => c.name);
                } else {
                    const business = businessCategories.map(c => c.name);
                    const family = familyCategories.map(c => c.name);
                    categories = [...new Set([...business, ...family])];
                }
                return categories.sort();
            }, [filters.expenseType, businessCategories, familyCategories]);

            const filteredExpenses = useMemo(() => {
                const userShopNames = (userData?.role === 'Admin' || userData?.role === 'Management')
                    ? null
                    : shops.filter(s => userData?.shopIds?.includes(s.id)).map(s => s.name);

                const accessibleBusinessExpenses = businessExpenses.filter(e => {
                    if (!userShopNames) return true;
                    return userShopNames.includes(e.shop);
                });

                let combinedList = [
                    ...accessibleBusinessExpenses.map(e => ({ ...e, type: 'Business' })),
                    ...((userData?.role === 'Admin' || userData?.role === 'Management') ? familyExpenses.map(e => ({ ...e, type: 'Family' })) : [])
                ];

                let startDate = null;
                let endDate = null;
                const { dateRangeType, startDate: customStart, endDate: customEnd } = filters;

                if (dateRangeType === 'this_month') {
                    const now = new Date();
                    startDate = new Date(now.getFullYear(), now.getMonth(), 1);
                    endDate = new Date(now.getFullYear(), now.getMonth() + 1, 0);
                    endDate.setHours(23, 59, 59, 999);
                } else if (dateRangeType === 'last_month') {
                    const now = new Date();
                    startDate = new Date(now.getFullYear(), now.getMonth() - 1, 1);
                    endDate = new Date(now.getFullYear(), now.getMonth(), 0);
                    endDate.setHours(23, 59, 59, 999);
                } else if (dateRangeType === 'custom') {
                    if (customStart) {
                         startDate = new Date(customStart);
                         startDate.setHours(0, 0, 0, 0);
                    }
                    if (customEnd) {
                        endDate = new Date(customEnd);
                        endDate.setHours(23, 59, 59, 999);
                    }
                }

                return combinedList.filter(exp => {
                    const shopMatch = filters.shop === 'all' || exp.type !== 'Business' || exp.shop === filters.shop;
                    const categoryMatch = filters.category === 'all' || exp.category === filters.category;
                    const typeMatch = filters.expenseType === 'all' || exp.type === filters.expenseType;
                    
                    if (!exp.date) return false;
                    const expDate = exp.date.toDate();
                    const dateMatch = dateRangeType === 'all' || (!startDate || expDate >= startDate) && (!endDate || expDate <= endDate);
                    
                    return shopMatch && categoryMatch && typeMatch && dateMatch;
                }).sort((a, b) => (b.date?.toDate()?.getTime() || 0) - (a.date?.toDate()?.getTime() || 0));
            }, [businessExpenses, familyExpenses, userData, filters, shops]);

            // --- NEW: Aggregation Logic ---
            const displayedExpenses = useMemo(() => {
                if (!isAggregated) return filteredExpenses;

                const groups = filteredExpenses.reduce((acc, exp) => {
                    // Group by Shop + Category + Type
                    const key = `${exp.shop || exp.paidBy || 'N/A'}|${exp.category}|${exp.type}`;
                    
                    if (!acc[key]) {
                        acc[key] = {
                            id: key, // unique key for React list
                            shop: exp.shop || exp.paidBy || 'N/A',
                            category: exp.category,
                            type: exp.type,
                            count: 0,
                            amountKhr: 0,
                            amountUsd: 0,
                            totalAmountKhr: 0,
                            isAggregate: true // flag to identify row type
                        };
                    }
                    
                    acc[key].count += 1;
                    acc[key].amountKhr += (exp.amountKhr || 0);
                    acc[key].amountUsd += (exp.amountUsd || 0);
                    acc[key].totalAmountKhr += (exp.totalAmountKhr || 0);
                    return acc;
                }, {});

                return Object.values(groups).sort((a,b) => b.totalAmountKhr - a.totalAmountKhr);
            }, [filteredExpenses, isAggregated]);
            // -----------------------------

            const totals = useMemo(() => {
                return filteredExpenses.reduce((acc, exp) => {
                    acc.totalAmountKhr += exp.totalAmountKhr || 0;
                    return acc;
                }, { totalAmountKhr: 0 });
            }, [filteredExpenses]);

            const handleDelete = async () => {
                if (!deletingExpense || !isMounted.current) return;
                setIsDeleting(true);
                const collectionName = deletingExpense.type === 'Business' ? 'businessExpenses' : 'familyExpenses';
                try {
                    await deleteDoc(doc(window.db, collectionName, deletingExpense.id));
                    showNotification("Expense deleted.", "success");
                } catch (error) {
                    showNotification("Failed to delete expense.", "error");
                } finally {
                    if (isMounted.current) {
                        setDeletingExpense(null);
                        setIsDeleting(false);
                    }
                }
            };
            
            const handleExport = useCallback(() => {
                if (!window.XLSX) {
                    showNotification("Excel library not loaded yet.", "error");
                    return;
                }
                
                // Export based on current view (Detailed or Aggregated)
                const dataToExport = displayedExpenses.map(exp => {
                    if (isAggregated) {
                         return {
                            "Shop/Paid By": exp.shop,
                            "Type": exp.type,
                            "Category": exp.category,
                            "Transactions Count": exp.count,
                            "Total KHR": exp.amountKhr,
                            "Total USD": exp.amountUsd,
                            "Grand Total (KHR)": exp.totalAmountKhr
                        };
                    } else {
                        return {
                            "Date": formatInCambodiaDateOnly(exp.date),
                            "Type": exp.type,
                            "Shop/Paid By": exp.shop || exp.paidBy || 'N/A',
                            "Category": exp.category,
                            "Recorded By": exp.recordedBy || 'N/A',
                            "Amount KHR": exp.amountKhr || 0,
                            "Amount USD": exp.amountUsd || 0,
                            "Total Amount (KHR)": exp.totalAmountKhr,
                            "Note": exp.note || ''
                        };
                    }
                });
                
                const ws = window.XLSX.utils.json_to_sheet(dataToExport);
                const wb = window.XLSX.utils.book_new();
                window.XLSX.utils.book_append_sheet(wb, ws, isAggregated ? "Expense Summary" : "Expense Details");
                window.XLSX.writeFile(wb, isAggregated ? "Expense_Summary_Report.xlsx" : "Expense_Detailed_Report.xlsx");
                showNotification("Exported successfully!", "success");
            }, [displayedExpenses, isAggregated, showNotification]);

            const ExpenseViewModal = ({ expense, onClose, onEdit, userData }) => {
                if (!expense) return null;
                const details = [
                    { label: "Date", value: formatInCambodiaDateOnly(expense.date) },
                    { label: "Type", value: expense.type },
                    { label: expense.type === 'Business' ? "Shop" : "Paid By", value: expense.shop || expense.paidBy || 'N/A' },
                    { label: "Category", value: expense.category },
                    { label: "Recorded By", value: expense.recordedBy || 'N/A' },
                    { label: "Amount (KHR)", value: formatCurrency(expense.amountKhr || 0, 'KHR'), isAmount: true },
                    { label: "Amount (USD)", value: formatCurrency(expense.amountUsd || 0, 'USD'), isAmount: true },
                    { label: "Total Amount", value: formatCurrency(expense.totalAmountKhr || 0, 'KHR'), isAmount: true, isTotal: true },
                    { label: "Note", value: expense.note || 'No note provided.', isNote: true },
                ];

                return (
                    <Modal title="Expense Details" onClose={onClose} size="lg">
                        <div className="space-y-4">
                            {details.map(detail => (
                                <div key={detail.label} className={`flex flex-col sm:flex-row sm:items-center ${detail.isNote ? 'items-start' : ''}`}>
                                    <p className="w-full sm:w-1/3 text-sm font-semibold text-slate-400">{detail.label}</p>
                                    <p className={`w-full sm:w-2/3 text-slate-200 ${detail.isAmount ? 'font-mono' : ''} ${detail.isTotal ? 'font-bold text-lg text-red-400' : ''} ${detail.isNote ? 'whitespace-pre-wrap bg-slate-700 p-2 rounded-md mt-1 sm:mt-0' : ''}`}>
                                        {detail.value}
                                    </p>
                                </div>
                            ))}
                        </div>
                        <div className="flex justify-end gap-4 pt-6 mt-6 border-t border-slate-700">
                            <Button type="button" onClick={onClose} variant="secondary">Close</Button>
                            {(userData?.role === 'Admin' || userData?.role === 'Management') && (
                                <Button type="button" onClick={onEdit} icon="PenSquare">Edit</Button>
                            )}
                        </div>
                    </Modal>
                );
            };

            return (
                <div className="space-y-6">
                    <PageHeader title="Expense Report" subtitle="Log and manage all business and family expenses.">
                        <Button onClick={() => handleOpenForm()} icon="Plus">Add Expense</Button>
                    </PageHeader>
                    
                    <Card>
                        <div className="flex flex-col sm:flex-row justify-between items-center mb-4 gap-4">
                            <h2 className="text-xl font-bold text-slate-100">Expense History</h2>
                            <Button onClick={handleExport} variant="secondary" icon="Download">Export to Excel</Button>
                        </div>
                        
                        <div className="p-4 bg-slate-900/50 rounded-lg">
                            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
                                <FormSelect label="Filter by Shop" name="shop" value={filters.shop} onChange={handleFilterChange} options={[{ value: 'all', label: 'All Shops' }, ...availableShops.map(s => ({ value: s.name, label: s.name }))]} />
                                <FormSelect 
                                    label="Date Range" 
                                    name="dateRangeType" 
                                    value={filters.dateRangeType} 
                                    onChange={handleFilterChange} 
                                    options={[
                                        { value: 'all', label: 'All Time' },
                                        { value: 'this_month', label: 'This Month' },
                                        { value: 'last_month', label: 'Last Month' },
                                        { value: 'custom', label: 'Custom' }
                                    ]} 
                                />
                                <FormSelect
                                    label="Filter by Type"
                                    name="expenseType"
                                    value={filters.expenseType}
                                    onChange={handleFilterChange}
                                    options={[
                                        { value: 'all', label: 'All Types' },
                                        { value: 'Business', label: 'Business' },
                                        ...(userData?.role === 'Admin' ? [{ value: 'Family', label: 'Family' }] : [])
                                    ]}
                                />
                                <FormSelect
                                    label="Filter by Category"
                                    name="category"
                                    value={filters.category}
                                    onChange={handleFilterChange}
                                    options={[
                                        { value: 'all', label: 'All Categories' },
                                        ...availableCategories.map(c => ({ value: c, label: c }))
                                    ]}
                                />
                            </div>
                             {filters.dateRangeType === 'custom' && (
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
                                    <FormInput label="Start Date" type="date" name="startDate" value={filters.startDate} onChange={handleFilterChange} />
                                    <FormInput label="End Date" type="date" name="endDate" value={filters.endDate} onChange={handleFilterChange} />
                                </div>
                            )}
                            
                            {/* --- NEW: View Mode Toggle --- */}
                            <div className="flex items-center gap-2 mt-4 pt-4 border-t border-slate-700">
                                <span className="text-sm font-medium text-slate-300">View Mode:</span>
                                <div className="flex bg-slate-800 rounded-lg p-1 border border-slate-700">
                                    <button
                                        onClick={() => setIsAggregated(false)}
                                        className={`px-3 py-1 text-xs font-semibold rounded-md transition-colors ${!isAggregated ? 'bg-blue-600 text-white shadow' : 'text-slate-400 hover:text-slate-200'}`}
                                    >
                                        Detailed List
                                    </button>
                                    <button
                                        onClick={() => setIsAggregated(true)}
                                        className={`px-3 py-1 text-xs font-semibold rounded-md transition-colors ${isAggregated ? 'bg-blue-600 text-white shadow' : 'text-slate-400 hover:text-slate-200'}`}
                                    >
                                        Summary by Category
                                    </button>
                                </div>
                            </div>
                            {/* --------------------------- */}
                        </div>

                        <div className="overflow-x-auto">
                            <table className="w-full text-sm text-left text-slate-300">
                                <thead className="bg-slate-900/50 text-xs text-slate-400 uppercase">
                                    <tr>
                                        {/* Dynamic Headers based on View Mode */}
                                        {!isAggregated ? (
                                            <>
                                                <th className="p-3">Date</th>
                                                <th className="p-3">Type</th>
                                                <th className="p-3">Shop/Paid By</th>
                                                <th className="p-3">Category</th>
                                                <th className="p-3">Recorded By</th>
                                                <th className="p-3 text-right">Total (KHR)</th>
                                                <th className="p-3">Note</th>
                                                <th className="p-3 text-center">Actions</th>
                                            </>
                                        ) : (
                                            <>
                                                <th className="p-3">Shop/Paid By</th>
                                                <th className="p-3">Type</th>
                                                <th className="p-3">Category</th>
                                                <th className="p-3 text-center">Count</th>
                                                <th className="p-3 text-right">Total KHR</th>
                                                <th className="p-3 text-right">Total USD</th>
                                                <th className="p-3 text-right">Grand Total (KHR)</th>
                                            </>
                                        )}
                                    </tr>
                                </thead>
                                <tbody className="text-sm divide-y divide-slate-700">
                                    {displayedExpenses.length === 0 ? (
                                        <tr><td colSpan={isAggregated ? 7 : 8} className="p-6 text-center text-slate-500">No expenses found.</td></tr>
                                    ) : (
                                        displayedExpenses.map((exp, idx) => (
                                            <tr key={exp.id || idx} className="hover:bg-slate-800">
                                                {!isAggregated ? (
                                                    // Detailed Row
                                                    <>
                                                        <td className="p-3 whitespace-nowrap">{formatInCambodiaDateOnly(exp.date)}</td>
                                                        <td className="p-3"><span className={`px-2 py-1 text-xs rounded-full ${exp.type === 'Business' ? 'bg-sky-500/20 text-sky-300' : 'bg-purple-500/20 text-purple-300'}`}>{exp.type}</span></td>
                                                        <td className="p-3">{exp.shop || exp.paidBy || 'N/A'}</td>
                                                        <td className="p-3">{exp.category}</td>
                                                        <td className="p-3">{exp.recordedBy || 'N/A'}</td>
                                                        <td className="p-3 text-right font-mono">{exp.totalAmountKhr?.toLocaleString()}</td>
                                                        <td className="p-3 truncate max-w-xs">{exp.note}</td>
                                                        <td className="p-3 flex gap-1 justify-center">
                                                            <Button variant="ghost" onClick={() => setViewingExpense(exp)}><Icon name="Eye"/></Button>
                                                            {(userData?.role === 'Admin' || userData?.role === 'Management') && (
                                                                <>
                                                                    <Button variant="ghost" onClick={() => handleOpenForm(exp)}><Icon name="PenSquare"/></Button>
                                                                    <Button variant="ghost" onClick={() => setDeletingExpense(exp)} className="text-red-400 hover:bg-red-900/50"><Icon name="Trash2"/></Button>
                                                                </>
                                                            )}
                                                        </td>
                                                    </>
                                                ) : (
                                                    // Aggregated Row
                                                    <>
                                                        <td className="p-3 font-semibold text-slate-200">{exp.shop}</td>
                                                        <td className="p-3"><span className={`px-2 py-1 text-xs rounded-full ${exp.type === 'Business' ? 'bg-sky-500/20 text-sky-300' : 'bg-purple-500/20 text-purple-300'}`}>{exp.type}</span></td>
                                                        <td className="p-3">{exp.category}</td>
                                                        <td className="p-3 text-center text-slate-400">{exp.count}</td>
                                                        <td className="p-3 text-right font-mono text-slate-400">{exp.amountKhr?.toLocaleString()}</td>
                                                        <td className="p-3 text-right font-mono text-slate-400">{exp.amountUsd?.toLocaleString()}</td>
                                                        <td className="p-3 text-right font-mono font-bold text-red-400">{exp.totalAmountKhr?.toLocaleString()}</td>
                                                    </>
                                                )}
                                            </tr>
                                        ))
                                    )}
                                </tbody>
                                <tfoot className="bg-slate-900/50 font-bold text-slate-200">
                                    <tr>
                                        <td colSpan={isAggregated ? 6 : 5} className="p-3 text-right">Subtotal</td>
                                        <td className="p-3 text-right font-mono">{totals.totalAmountKhr.toLocaleString()}</td>
                                        {!isAggregated && <td colSpan="2"></td>}
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                    </Card>
                    {isFormModalOpen && <ExpenseFormModal expense={editingExpense} onClose={handleCloseForm} />}
                    {deletingExpense && <ConfirmationModal title="Delete Expense" message="Are you sure you want to delete this expense record?" onConfirm={handleDelete} onClose={() => setDeletingExpense(null)} isSubmitting={isDeleting} confirmVariant="danger" confirmText="Delete" />}
                    {viewingExpense && <ExpenseViewModal expense={viewingExpense} onClose={() => setViewingExpense(null)} onEdit={() => { handleOpenForm(viewingExpense); setViewingExpense(null); }} userData={userData} />}
                </div>
            );
        };
        // --- END: Expense Report Page ---  

        // --- START: Settings Page ---
        const SettingsPage = () => {
            const [activeTab, setActiveTab] = useState('shops');

            const TabButton = ({ tabName, label, icon, isActive, onClick }) => (
                <button onClick={() => onClick(tabName)} className={`flex items-center gap-2 px-3 py-2 text-sm sm:px-4 sm:py-2 font-semibold rounded-t-lg transition-colors ${isActive ? 'border-b-2 border-blue-500 text-blue-400' : 'text-slate-400 hover:bg-slate-700/50'}`}>
                    <Icon name={icon} /> {label}
                </button>
            );

            return (
                <div className="space-y-6">
                    <PageHeader title="Settings" subtitle="Configure application settings and manage data." />
                    <div className="border-b border-slate-700 flex space-x-1 sm:space-x-2 flex-wrap">
                        <TabButton tabName="shops" label="Shops" icon="Landmark" isActive={activeTab === 'shops'} onClick={setActiveTab} />
                        <TabButton tabName="saleMargins" label="Sale Margins" icon="BarChart3" isActive={activeTab === 'saleMargins'} onClick={setActiveTab} /> {/* <-- ADDED */}
                        <TabButton tabName="employees" label="Employees" icon="Users" isActive={activeTab === 'employees'} onClick={setActiveTab} />
                        <TabButton tabName="expenses" label="Categories" icon="List" isActive={activeTab === 'expenses'} onClick={setActiveTab} />
                    </div>
                    <div className="mt-6">
                        <div className={activeTab === 'shops' ? '' : 'hidden'}><ManageShopsSection /></div>
                        <div className={activeTab === 'saleMargins' ? '' : 'hidden'}><ManageSaleMarginsSection /></div> {/* <-- ADDED */}
                        <div className={activeTab === 'employees' ? '' : 'hidden'}><ManageEmployeesSection /></div>
                        <div className={activeTab === 'expenses' ? '' : 'hidden'}><ManageExpenseCategoriesSection /></div>
                    </div>
                </div>
            );
        };
        
        const SettingsSection = ({ children }) => (
            <Card className="mb-8">
                {children}
            </Card>
        );

        const ManageShopsSection = () => {
            const { shops, appSettings } = useData();
            const { showNotification } = useNotification();
            const { doc, updateDoc, deleteDoc } = window.Firebase;
            const [isModalOpen, setIsModalOpen] = useState(false);
            const [editingShop, setEditingShop] = useState(null);
            const [deletingShop, setDeletingShop] = useState(null);
            const [isDeleting, setIsDeleting] = useState(false);
            const [exchangeRate, setExchangeRate] = useState(appSettings.exchangeRate);
            const isMounted = useRef(true);

            useEffect(() => {
                isMounted.current = true;
                setExchangeRate(appSettings.exchangeRate);
                return () => { isMounted.current = false; };
            }, [appSettings.exchangeRate]);

            const openModal = (shop = null) => {
                setEditingShop(shop || { name: '', address: '', phone: '', gca: 0, saleMargin: 0, shareholders: [{id: crypto.randomUUID(), name: '', percentage: 100}] });
                setIsModalOpen(true);
            };

            const handleDeleteShop = async () => {
                if (!deletingShop) return;
                setIsDeleting(true);
                try {
                    await deleteDoc(doc(window.db, "shops", deletingShop.id));
                    showNotification("Shop deleted.", "success");
                } catch (error) {
                    showNotification("Failed to delete shop.", "error");
                } finally {
                    if (isMounted.current) {
                        setDeletingShop(null);
                        setIsDeleting(false);
                    }
                }
            };
            
            const handleSaveExchangeRate = async () => {
                try {
                    await updateDoc(doc(window.db, "settings", "app"), { exchangeRate: parseFloat(exchangeRate) });
                    showNotification("Exchange rate saved!", "success");
                } catch (error) {
                    showNotification("Failed to save exchange rate.", "error");
                }
            };
            
            return (
                <div>
                    <SettingsSection>
                        <h2 className="text-xl font-bold text-slate-100 mb-4 border-b border-slate-700 pb-3">Exchange Rate</h2>
                        <div className="flex items-end gap-4">
                            <div className="flex-grow">
                                <FormInput label="USD to KHR Exchange Rate" type="number" value={exchangeRate || ''} onChange={(e) => setExchangeRate(e.target.value)} />
                            </div>
                            <Button onClick={handleSaveExchangeRate}>Save</Button>
                        </div>
                    </SettingsSection>
                    
                    <SettingsSection>
                         <div className="flex justify-between items-center mb-4 border-b border-slate-700 pb-3">
                             <h2 className="text-xl font-bold text-slate-100">Shops & Ownership</h2>
                             <Button onClick={() => openModal()} icon="Plus">Add Shop</Button>
                         </div>
                        <div className="overflow-x-auto">
                            <table className="w-full text-left text-sm">
                                <thead className="text-xs text-slate-400 uppercase bg-slate-900/50">
                                    <tr>
                                        <th className="p-3">Name</th>
                                        <th className="p-3">Shareholders</th>
                                        <th className="p-3 text-right">GCA (៛)</th>
                                        <th className="p-3 text-right">Sale Margin (%)</th>
                                        <th className="p-3 text-center">Actions</th>
                                    </tr>
                                </thead>
                                <tbody className="text-sm text-slate-300 divide-y divide-slate-700">
                                    {shops.map(shop => (
                                        <tr key={shop.id} className="hover:bg-slate-700/50">
                                            <td className="p-3 font-semibold text-slate-200">{shop.name}</td>
                                            <td className="p-3">{(shop.shareholders || []).map(s => `${s.name} (${s.percentage}%)`).join(', ') || 'N/A'}</td>
                                            <td className="p-3 text-right font-mono">{(shop.gca || 0).toLocaleString()}</td>
                                            <td className="p-3 text-right font-mono">{shop.saleMargin || 0}%</td>
                                            <td className="p-3 flex gap-1 justify-center">
                                                <Button variant="ghost" onClick={() => openModal(shop)}><Icon name="PenSquare"/></Button>
                                                <Button variant="ghost" onClick={() => setDeletingShop(shop)} className="text-red-400 hover:bg-red-900/50"><Icon name="Trash2"/></Button>
                                            </td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                    </SettingsSection>
                    
                    {isModalOpen && <ShopEditModal shop={editingShop} onClose={() => setIsModalOpen(false)} />}
                    {deletingShop && <ConfirmationModal title="Delete Shop" message={`Delete ${deletingShop.name}?`} onConfirm={handleDeleteShop} onClose={() => setDeletingShop(null)} isSubmitting={isDeleting} confirmVariant="danger" confirmText="Delete" />}
                </div>
            );
        };

        const ShopEditModal = ({ shop, onClose }) => {
            const { showNotification } = useNotification();
            const { doc, updateDoc, addDoc, collection, Timestamp } = window.Firebase; // Added Timestamp
            const { userData } = useAuth(); // Added useAuth hook
            const [formData, setFormData] = useState({
                name: '', address: '', phone: '', gca: 0, saleMargin: 0, shareholders: [],
                adjustmentAmount: '', // New state for adjustment amount
                adjustmentReason: '', // New state for adjustment reason
                ...shop
            });
            const [isUpdating, setIsUpdating] = useState(false);
            const isMounted = useRef(true);

            useEffect(() => {
                isMounted.current = true;
                // Ensure initial shop data includes empty adjustment fields
                if (shop) {
                     setFormData(prev => ({
                        ...prev, // Keep existing state if any
                        ...shop, // Overwrite with shop data
                        adjustmentAmount: '', // Reset adjustment fields when opening
                        adjustmentReason: '',
                        gca: shop.gca || 0 // Ensure GCA is initialized
                     }));
                } else {
                     setFormData({ // For new shops
                        name: '', address: '', phone: '', gca: 0, saleMargin: 0, 
                        shareholders: [{id: crypto.randomUUID(), name: '', percentage: 100}],
                        adjustmentAmount: '',
                        adjustmentReason: ''
                     });
                }
                return () => { isMounted.current = false; };
            }, [shop]); // Rerun effect when shop prop changes
            
            const shareholderTotal = useMemo(() => (formData.shareholders || []).reduce((sum, s) => sum + (parseFloat(String(s.percentage)) || 0), 0), [formData.shareholders]);
            const isTotalValid = shareholderTotal === 100;

            const handleChange = (e) => setFormData(prev => ({ ...prev, [e.target.name]: e.target.value }));
            const handleShareholderChange = (id, field, value) => setFormData(prev => ({ ...prev, shareholders: (prev.shareholders || []).map(s => s.id === id ? { ...s, [field]: value } : s) }));
            const addShareholder = () => setFormData(prev => ({ ...prev, shareholders: [...(prev.shareholders || []), {id: crypto.randomUUID(), name: '', percentage: 0}] }));
            const removeShareholder = (id) => setFormData(prev => ({ ...prev, shareholders: (prev.shareholders || []).filter(s => s.id !== id) }));

            const handleUpdate = async (e) => {
                e.preventDefault();
                if(!isTotalValid) {
                    showNotification("Shareholder percentages must total 100%.", "error");
                    return;
                }
                if (!isMounted.current) return;
                setIsUpdating(true);

                let currentGCA = parseFloat(String(shop?.gca || 0)) || 0; // Use GCA from prop for calculation base
                let finalGCA = currentGCA;
                const adjustmentAmount = parseFormattedNumber(formData.adjustmentAmount);
                const adjustmentReason = formData.adjustmentReason.trim();
                let adjustmentRecordSaved = false;

                // --- GCA Adjustment Logic ---
                if (adjustmentAmount !== 0 && adjustmentReason) {
                    const newGCA = currentGCA + adjustmentAmount;
                    finalGCA = newGCA; // Update the GCA to be saved

                    const adjustmentRecord = {
                        shopId: shop.id,
                        shopName: formData.name,
                        adjustmentAmount: adjustmentAmount,
                        reason: adjustmentReason,
                        previousGCA: currentGCA,
                        newGCA: newGCA,
                        adjustedAt: Timestamp.now(),
                        adjustedBy: userData?.uid || 'unknown',
                        adjustedByName: userData?.name || 'Unknown'
                    };

                    try {
                        // 1. Save the adjustment record
                        await addDoc(collection(window.db, "gcaAdjustments"), adjustmentRecord);
                        adjustmentRecordSaved = true;
                    } catch (error) {
                        console.error("Failed to save GCA adjustment record:", error);
                        // Don't block the main update, just log the error
                        showNotification("Failed to log GCA adjustment.", "error");
                    }
                }
                // --- End GCA Adjustment Logic ---

                // --- Main Shop Update Logic ---
                const dataToSave = {
                    name: formData.name,
                    address: formData.address,
                    phone: formData.phone,
                    gca: finalGCA, // Save the (potentially new) GCA
                    saleMargin: parseFloat(String(formData.saleMargin)) || 0,
                    shareholders: (formData.shareholders || []).map(s => ({
                        name: s.name,
                        percentage: parseFloat(String(s.percentage)) || 0
                    }))
                };

                try {
                    if (shop?.id) {
                        await updateDoc(doc(window.db, "shops", shop.id), dataToSave);
                        showNotification(`Shop ${adjustmentRecordSaved ? "and GCA" : ""} updated!`, "success");
                    } else {
                        await addDoc(collection(window.db, "shops"), dataToSave);
                        showNotification("New shop created!", "success");
                    }
                    if (isMounted.current) onClose();
                } catch (error) {
                    showNotification("Failed to save shop.", "error");
                } finally {
                    if (isMounted.current) setIsUpdating(false);
                }
            };
            
            // --- This is the rest of the missing component JSX ---
            return (
                <Modal title={shop?.id ? 'Edit Shop' : 'Add New Shop'} onClose={onClose} size="4xl">
                    <form onSubmit={handleUpdate} className="space-y-6">
                        <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <FormInput label="Shop Name" name="name" value={formData.name} onChange={handleChange} required />
                            <FormInput label="Phone" name="phone" value={formData.phone} onChange={handleChange} />
                            <FormInput label="Address" name="address" value={formData.address} onChange={handleChange} />
                        </div>
                        <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <FormInput label="Current GCA (៛)" name="gca" value={formData.gca.toLocaleString()} disabled />
                            <LiveFormatInput label="Sale Margin (%)" name="saleMargin" value={formData.saleMargin} onChange={handleChange} />
                        </div>

                        {shop?.id && (
                            <div className="p-4 rounded-lg bg-slate-700/50 border border-slate-600">
                                <h4 className="text-lg font-semibold text-slate-200 mb-3">GCA Adjustment</h4>
                                <p className="text-sm text-slate-400 mb-3">Only fill this out to make a manual adjustment. Use negative numbers to decrease GCA.</p>
                                <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                                    <LiveFormatInput 
                                        label="Adjustment Amount (៛)" 
                                        name="adjustmentAmount" 
                                        value={formData.adjustmentAmount} 
                                        onChange={handleChange}
                                        placeholder="e.g., -50000 or 100000"
                                    />
                                    <div className="md:col-span-2">
                                        <FormInput 
                                            label="Reason for Adjustment" 
                                            name="adjustmentReason" 
                                            value={formData.adjustmentReason} 
                                            onChange={handleChange}
                                            placeholder="Required if amount is set"
                                        />
                                    </div>
                                </div>
                            </div>
                        )}

                        <div>
                            <div className="flex justify-between items-center mb-2">
                                <h4 className="text-lg font-semibold text-slate-200">Shareholders</h4>
                                <Button type="button" variant="secondary" onClick={addShareholder} icon="Plus" />
                            </div>
                            <div className="space-y-2">
                                {(formData.shareholders || []).map((s, index) => (
                                    <div key={s.id} className="grid grid-cols-3 gap-2">
                                        <FormInput placeholder="Shareholder Name" value={s.name} onChange={(e) => handleShareholderChange(s.id, 'name', e.target.value)} />
                                        <LiveFormatInput name="percentage" value={s.percentage} onChange={(e) => handleShareholderChange(s.id, 'percentage', e.target.value)} placeholder="%" />
                                        <Button type="button" variant="danger" onClick={() => removeShareholder(s.id)} icon="Trash2" />
                                    </div>
                                ))}
                            </div>
                             <div className={`mt-2 text-right font-bold ${isTotalValid ? 'text-green-400' : 'text-red-400'}`}>
                                Total: {shareholderTotal}%
                            </div>
                        </div>

                        <div className="flex justify-end gap-4 pt-4 border-t border-slate-700">
                            <Button type="button" variant="secondary" onClick={onClose}>Cancel</Button>
                            <Button type="submit" disabled={isUpdating || !isTotalValid} icon={isUpdating ? "LoaderCircle" : null}>
                                {isUpdating ? 'Saving...' : (shop?.id ? 'Update Shop' : 'Create Shop')}
                            </Button>
                        </div>
                    </form>
                </Modal>
            );
        }; // --- This was the missing closing brace for the component ---

        // --- NEW COMPONENT: MANAGE SALE MARGINS ---
        const ManageSaleMarginsSection = () => {
            const { shops, saleMarginHistory } = useData();
            const { showNotification } = useNotification();
            const { addDoc, collection, doc, deleteDoc, updateDoc } = window.Firebase; // <-- Added 'updateDoc' here

            const [shop, setShop] = useState(shops[0]?.name || '');
            const [month, setMonth] = useState(new Date().toISOString().slice(0, 7));
            const [margin, setMargin] = useState('');
            const [deletingHistory, setDeletingHistory] = useState(null);
            const [editingHistory, setEditingHistory] = useState(null); // <-- ADDED
            const formRef = useRef(null); // <-- ADDED for scrolling
            
            const mutation = useFirestoreMutation({
                onSuccess: () => {
                    setDeletingHistory(null);
                    // Clear form only if we weren't just updating
                    if (editingHistory) {
                        handleCancelEdit();
                    }
                }
            });

            // --- ADDED ---
            const handleCancelEdit = () => {
                setEditingHistory(null);
                setShop(shops[0]?.name || '');
                setMonth(new Date().toISOString().slice(0, 7));
                setMargin('');
            };

            // --- ADDED ---
            const handleStartEdit = (history) => {
                setEditingHistory(history);
                setShop(history.shop);
                setMonth(history.month);
                setMargin(String(history.margin));
                formRef.current?.scrollIntoView({ behavior: 'smooth' }); // Scroll to form
            };

            const handleSubmit = async (e) => {
                e.preventDefault();
                const marginValue = parseFloat(margin);
                if (!shop || !month || isNaN(marginValue)) {
                    showNotification("Please fill all fields correctly.", "error");
                    return;
                }

                // Check for duplicates
                const isDuplicate = saleMarginHistory.some(h => 
                    h.shop === shop && 
                    h.month === month &&
                    h.id !== editingHistory?.id // <-- MODIFIED duplicate check
                );
                if (isDuplicate) {
                    showNotification("A margin for this shop and month already exists. Please delete the old one first.", "error");
                    return;
                }

                // --- MODIFIED ---
                if (editingHistory) {
                    // Update existing document
                    await mutation.execute(
                        () => updateDoc(doc(window.db, "saleMarginHistory", editingHistory.id), {
                            shop,
                            month,
                            margin: marginValue
                        }),
                        "Sale margin history updated!"
                    );
                } else {
                    // Add new document
                    await mutation.execute(
                        () => addDoc(collection(window.db, "saleMarginHistory"), {
                            shop,
                            month, // Stored as "YYYY-MM"
                            margin: marginValue
                        }),
                        "Sale margin history added!"
                    );
                }
                
                // Clear form fields
                if (!editingHistory) {
                    setMargin(''); // Clear margin field on success
                } else {
                    handleCancelEdit(); // Reset form after update
                }
            };

            const handleDelete = async (history) => {
                if (!history) return;
                setDeletingHistory(history);
                await mutation.execute(
                    () => deleteDoc(doc(window.db, "saleMarginHistory", history.id)),
                    "Sale margin history deleted!"
                );
            };

            const sortedHistory = useMemo(() => {
                return [...(saleMarginHistory || [])].sort((a, b) => {
                    if (a.month < b.month) return 1;
                    if (a.month > b.month) return -1;
                    if (a.shop < b.shop) return -1;
                    if (a.shop > b.shop) return 1;
                    return 0;
                });
            }, [saleMarginHistory]);

            return (
                <SettingsSection>
                    <h2 className="text-xl font-bold text-slate-100 mb-4 border-b border-slate-700 pb-3">
                        Sale Margin History Log
                    </h2>
                    <p className="text-sm text-slate-400 mb-4">
                        Set specific sale margins for any shop for a specific month. This will override the shop's default margin in the CashFlow Report for that month's calculations.
                    </p>
                    <form ref={formRef} onSubmit={handleSubmit} className="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6 p-4 bg-slate-900/50 rounded-lg items-end">
                        <FormSelect label="Shop" name="shop" value={shop} onChange={e => setShop(e.target.value)} options={shops.map(s => ({value: s.name, label: s.name}))} disabled={!!editingHistory} />
                        <FormInput label="Month" type="month" name="month" value={month} onChange={e => setMonth(e.target.value)} disabled={!!editingHistory} />
                        <FormInput label="Margin (%)" type="number" step="0.01" name="margin" value={margin} onChange={e => setMargin(e.target.value)} placeholder="e.g., 20" />
                        <div className="flex gap-2">
                            {editingHistory && (
                                <Button type="button" variant="secondary" onClick={handleCancelEdit} className="w-full">
                                    Cancel
                                </Button>
                            )}
                            <Button type="submit" icon={editingHistory ? "PenSquare" : "Plus"} className="w-full" disabled={mutation.isMutating}>
                                {mutation.isMutating ? (editingHistory ? 'Updating...' : 'Adding...') : (editingHistory ? 'Update' : 'Add History')}
                            </Button>
                        </div>
                    </form>

                    <h3 className="text-lg font-semibold text-slate-200 mb-2">History</h3>
                    <div className="overflow-x-auto max-h-96">
                        <table className="w-full text-left text-sm">
                            <thead className="text-xs text-slate-400 uppercase bg-slate-900/50 sticky top-0">
                                <tr>
                                    <th className="p-3">Month</th>
                                    <th className="p-3">Shop</th>
                                    <th className="p-3 text-right">Margin (%)</th>
                                    <th className="p-3 text-center">Actions</th>
                                </tr>
                            </thead>
                            <tbody className="text-sm text-slate-300 divide-y divide-slate-700">
                                {sortedHistory.map(history => (
                                    <tr key={history.id} className="hover:bg-slate-700/50">
                                        <td className="p-3 font-mono">{history.month}</td>
                                        <td className="p-3 font-semibold text-slate-200">{history.shop}</td>
                                        <td className="p-3 text-right font-mono">{history.margin}%</td>
                                        <td className="p-3 text-center flex justify-center gap-1">
                                            {/* --- ADDED --- */}
                                            <Button 
                                                variant="ghost" 
                                                onClick={() => handleStartEdit(history)} 
                                                className="text-blue-400 hover:bg-blue-900/50" 
                                                title="Edit"
                                                disabled={mutation.isMutating}
                                            >
                                                <Icon name="PenSquare"/>
                                            </Button>
                                            {/* --- END ADDED --- */}
                                            <Button 
                                                variant="ghost" 
                                                onClick={() => setDeletingHistory(history)} 
                                                className="text-red-400 hover:bg-red-900/50" 
                                                title="Delete"
                                                disabled={mutation.isMutating && deletingHistory?.id === history.id}
                                            >
                                                <Icon name={mutation.isMutating && deletingHistory?.id === history.id ? "LoaderCircle" : "Trash2"}/>
                                            </Button>
                                        </td>
                                    </tr>
                                ))}
                                {sortedHistory.length === 0 && (
                                    <tr>
                                        <td colSpan="4" className="text-center p-6 text-slate-500">No sale margin history found.</td>
                                    </tr>
                                )}
                            </tbody>
                        </table>
                    </div>
                    {deletingHistory && !mutation.isMutating && (
                        <ConfirmationModal 
                            title="Delete Margin History" 
                            message={`Are you sure you want to delete the margin for ${deletingHistory.shop} for ${deletingHistory.month}?`} 
                            onConfirm={() => handleDelete(deletingHistory)} 
                            onClose={() => setDeletingHistory(null)} 
                            isSubmitting={mutation.isMutating} 
                            confirmVariant="danger" 
                            confirmText="Delete" 
                        />
                    )}
                </SettingsSection>
            );
        };
        // --- END: MANAGE SALE MARGINS ---

        // --- NEW COMPONENT: EmployeeTable ---
        const EmployeeTable = ({ employees, onEdit, onDelete, shops }) => { 
            // 2. Create a Shop Map for efficient lookups
            const shopMap = useMemo(() => {
                if (!shops) return new Map();
                return shops.reduce((map, shop) => {
                    map.set(shop.id, shop.name);
                    return map;
                }, new Map());
            }, [shops]);

            return (
                <div className="overflow-x-auto">
                    <table className="w-full text-left text-sm">
                        <thead className="text-xs text-slate-400 uppercase bg-slate-900/50">
                            <tr>
                                <th className="p-3">Name</th>
                                <th className="p-3">Position</th>
                                <th className="p-3">Email</th>
                                <th className="p-3">Role</th>
                                <th className="p-3">Assigned Shops</th>
                                <th className="p-3">Status</th>
                                <th className="p-3 text-center">Actions</th>
                            </tr>
                        </thead>
                        <tbody className="text-sm text-slate-300 divide-y divide-slate-700">
                            {employees.map(staff => {
                                // 4. Map shop IDs to names
                                const shopNames = (staff.shopIds || [])
                                    .map(id => shopMap.get(id))
                                    .filter(Boolean)
                                    .join(', ');
                                
                                return (
                                <tr key={staff.id} className="hover:bg-slate-700/50">
                                    <td className="p-3 font-semibold text-slate-200">{staff.name}</td>
                                    <td className="p-3">{staff.position}</td>
                                    <td className="p-3">{staff.email}</td>
                                    <td className="p-3"><span className={`px-2 py-1 text-xs rounded-full ${staff.role === 'Admin' ? 'bg-red-500/20 text-red-300' : staff.role === 'Shop Manager' ? 'bg-blue-500/20 text-blue-300' : 'bg-slate-500/20 text-slate-300'}`}>{staff.role}</span></td>
                                    <td className="p-3 text-slate-400 text-xs">{shopNames || 'N/A'}</td>
                                    <td className="p-3">
                                        <span className={`px-2 py-1 text-xs rounded-full ${staff.status === 'Inactive' ? 'bg-yellow-500/20 text-yellow-300' : 'bg-green-500/20 text-green-300'}`}>
                                            {staff.status || 'Active'}
                                        </span>
                                    </td>
                                    <td className="p-3 flex gap-1 justify-center">
                                        <Button variant="ghost" onClick={() => onEdit(staff)}><Icon name="PenSquare"/></Button>
                                        <Button variant="ghost" onClick={() => onDelete(staff)} className="text-red-400 hover:bg-red-900/50"><Icon name="Trash2"/></Button>
                                    </td>
                                </tr>
                                )})}
                            {employees.length === 0 && (
                                <tr>
                                    <td colSpan="7" className="text-center p-6 text-slate-500">No employees found in this tab.</td>
                                </tr>
                            )}
                        </tbody>
                    </table>
                </div>
            );
        };
        // --- END: EmployeeTable ---

        const ManageEmployeesSection = () => {
            const { employees, shops } = useData(); // <-- Added 'shops'
            const { showNotification } = useNotification();
            const { doc, deleteDoc } = window.Firebase;
            const [isFormOpen, setIsFormOpen] = useState(false);
            const [isCreateModalOpen, setIsCreateModalOpen] = useState(false); // <-- ADDED
            const [isImportModalOpen, setIsImportModalOpen] = useState(false); // <-- NEW
            const [editingEmployee, setEditingEmployee] = useState(null);
            const [deletingEmployee, setDeletingEmployee] = useState(null);
            const [isDeleting, setIsDeleting] = useState(false);
            const isMounted = useRef(true);
            const [activeTab, setActiveTab] = useState('Active'); // <-- NEW STATE
            const [shopFilter, setShopFilter] = useState('all'); // <-- NEW: Shop filter state
            const [searchFilter, setSearchFilter] = useState(''); // <-- NEW: Search filter state

            useEffect(() => {
                isMounted.current = true;
                return () => { isMounted.current = false; };
            }, []);

            const openForm = (employee = null) => {
                setEditingEmployee(employee);
                setIsFormOpen(true);
            };

            const handleDelete = async () => {
                if (!deletingEmployee) return;
                setIsDeleting(true);
                try {
                    await deleteDoc(doc(window.db, "employees", deletingEmployee.id));
                    showNotification("Employee deleted.", "success");
                } catch(e) {
                     showNotification("Failed to delete employee.", "error");
                } finally {
                    if (isMounted.current) {
                        setDeletingEmployee(null);
                        setIsDeleting(false);
                    }
                }
            };

            // --- NEW: Filter employees ---
            const { activeEmployees, inactiveEmployees } = useMemo(() => {
                const active = [];
                const inactive = [];
                const lowerSearch = searchFilter.toLowerCase();
                
                (employees || []).forEach(emp => {
                    // Search Filter
                    if (lowerSearch && !emp.name.toLowerCase().includes(lowerSearch)) {
                        return; // Skip if name doesn't match search
                    }
                    
                    // Shop Filter
                    if (shopFilter !== 'all' && !emp.shopIds?.includes(shopFilter)) {
                        return; // Skip if not in selected shop
                    }
                    
                    // Status Filter (existing logic)
                    if (emp.status === 'Inactive') {
                        inactive.push(emp);
                    } else {
                        // Default to 'Active' if status is 'Active', null, or undefined
                        active.push(emp);
                    }
                });
                return { activeEmployees: active, inactiveEmployees: inactive };
            }, [employees, shopFilter, searchFilter]); // <-- Added new dependencies

            // --- NEW: TabButton sub-component ---
            const TabButton = ({ label, isActive, onClick }) => (
                <button 
                    onClick={onClick} 
                    className={`px-4 py-2 text-sm font-semibold rounded-t-lg ${isActive ? 'border-b-2 border-blue-500 text-blue-400' : 'text-slate-400 hover:bg-slate-700/50'}`}
                >
                    {label}
                </button>
            );

            return (
                <Card>
                     <div className="flex justify-between items-center mb-4 border-b border-slate-700 pb-3">
                        <h2 className="text-xl font-bold text-slate-100">Employee Management</h2>
                         <div className="flex gap-2"> {/* <-- Wrapper for buttons */}
                            <Button onClick={() => setIsImportModalOpen(true)} icon="Download" variant="secondary">Import Staff</Button> {/* <-- NEW */}
                            <Button onClick={() => setIsCreateModalOpen(true)} icon="Plus">New Employee</Button>
                         </div>
                    </div>
                    
                    {/* --- NEW: Filter Bar --- */}
                    <div className="p-4 bg-slate-900/50 rounded-lg mb-4 border border-slate-700">
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <FormInput 
                                label="Search by Name"
                                name="searchFilter"
                                value={searchFilter}
                                onChange={(e) => setSearchFilter(e.target.value)}
                                placeholder="Enter employee name..."
                            />
                            <FormSelect
                                label="Filter by Shop"
                                name="shopFilter"
                                value={shopFilter}
                                onChange={(e) => setShopFilter(e.target.value)}
                                options={[
                                    { value: 'all', label: 'All Shops' },
                                    ...shops.map(s => ({ value: s.id, label: s.name }))
                                ]}
                            />
                        </div>
                    </div>
                    {/* --- END: Filter Bar --- */}

                    {/* --- NEW TABS --- */}
                    <div className="border-b border-slate-700 flex space-x-1 sm:space-x-2 flex-wrap mb-4">
                        <TabButton 
                            label={`Active (${activeEmployees.length})`} 
                            isActive={activeTab === 'Active'} 
                            onClick={() => setActiveTab('Active')} 
                        />
                        <TabButton 
                            label={`Inactive (${inactiveEmployees.length})`} 
                            isActive={activeTab === 'Inactive'} 
                            onClick={() => setActiveTab('Inactive')} 
                        />
                    </div>
                    {/* --- END NEW TABS --- */}

                    {/* --- MODIFIED: Conditional Tables --- */}
                    <div className={activeTab === 'Active' ? '' : 'hidden'}>
                        <EmployeeTable 
                            employees={activeEmployees} 
                            onEdit={openForm} 
                            onDelete={setDeletingEmployee} 
                            shops={shops}
                        />
                    </div>
                    <div className={activeTab === 'Inactive' ? '' : 'hidden'}>
                        <EmployeeTable 
                            employees={inactiveEmployees} 
                            onEdit={openForm} 
                            onDelete={setDeletingEmployee} 
                            shops={shops}
                        />
                    </div>
                    {/* --- END MODIFIED --- */}
                    
                     {isFormOpen && <EmployeeFormModal employee={editingEmployee} onClose={() => setIsFormOpen(false)} />}
                     {isCreateModalOpen && <EmployeeCreateModal onClose={() => setIsCreateModalOpen(false)} />} {/* <-- ADDED */}
                     {isImportModalOpen && <EmployeeImportModal onClose={() => setIsImportModalOpen(false)} />} {/* <-- NEW */}
                     {deletingEmployee && <ConfirmationModal title="Delete Employee" message={`Delete ${deletingEmployee.name}?`} onConfirm={handleDelete} onClose={() => setDeletingEmployee(null)} isSubmitting={isDeleting} confirmVariant="danger" confirmText="Delete" />}
                </Card>
            );
        };
  const EmployeeFormModal = ({ employee, onClose }) => {
            const { shops } = useData();
            const { showNotification } = useNotification();
            const { setDoc, doc, updateDoc } = window.Firebase; // <-- FIX: Added 'updateDoc' here
            const [formData, setFormData] = useState({
                ...employee,
                uid: employee?.id || '' // <-- MODIFIED: Use document ID as UID
            });
            const [isSubmitting, setIsSubmitting] = useState(false);
            const isMounted = useRef(true);

            useEffect(() => {
                isMounted.current = true;
                return () => { isMounted.current = false; };
            }, []);

            const handleChange = (e) => setFormData(prev => ({ ...prev, [e.target.name]: e.target.value }));
            const handleShopIdChange = (shopId, isChecked) => setFormData(prev => ({ ...prev, shopIds: isChecked ? [...(prev.shopIds || []), shopId] : (prev.shopIds || []).filter(id => id !== shopId) }));
            const handleAllShopsChange = (isChecked) => setFormData(prev => ({...prev, shopIds: isChecked ? shops.map(s => s.id) : [] }));
            const handlePageAccessChange = (pageId, isChecked) => setFormData(prev => ({ ...prev, accessiblePages: isChecked ? [...(prev.accessiblePages || []), pageId] : (prev.accessiblePages || []).filter(id => id !== pageId) }));

            const handleSubmit = async (e) => {
                e.preventDefault();
                setIsSubmitting(true);
                const { id, uid, ...employeeData } = formData; // <-- MODIFIED: destructure id and uid
                try {
                    if (!employee?.id) { // <-- MODIFIED: Check employee.id
                        showNotification("Cannot update employee without an ID.", "error");
                        setIsSubmitting(false);
                        return;
                    }
                    // MODIFIED: Use updateDoc with employee.id
                    await updateDoc(doc(window.db, "employees", employee.id), employeeData); 
                    showNotification(`Employee updated.`, "success");
                    if (isMounted.current) onClose();
                } catch (error) {
                    console.error("Error saving employee:", error);
                    showNotification('Failed to save employee', 'error');
                } finally {
                    if (isMounted.current) setIsSubmitting(false);
                }
            };
            
            const allShopsSelected = formData.shopIds?.length === shops.length && shops.length > 0;

            return (
                 <Modal title={employee ? 'Edit Employee' : 'New Employee'} onClose={onClose} size="4xl">
                    <form onSubmit={handleSubmit} className="space-y-6">
                         <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <div className="space-y-4 md:col-span-1">
                                <FormInput label="Full Name" name="name" value={formData.name || ''} onChange={handleChange} required />
                                <FormInput label="Position" name="position" value={formData.position || ''} onChange={handleChange} />
                                <FormInput label="Email" name="email" type="email" value={formData.email || ''} onChange={handleChange} disabled />
                                <FormInput label="Firebase UID" name="uid" value={formData.uid || ''} onChange={handleChange} required disabled />
                                <FormSelect label="Role" name="role" value={formData.role || 'Staff'} onChange={handleChange} options={[{value: 'Admin', label: 'Admin'}, {value: 'Shop Manager', label: 'Shop Manager'}, {value: 'Staff', label: 'Staff'}]} />
                                {/* --- ADDED --- */}
                                <FormSelect 
                                    label="Status" 
                                    name="status" 
                                    value={formData.status || 'Active'} 
                                    onChange={handleChange} 
                                    options={[
                                        {value: 'Active', label: 'Active'}, 
                                        {value: 'Inactive', label: 'Inactive'}
                                    ]} 
                                />
                            </div>
                             <div className="space-y-4 md:col-span-1">
                                 <label className="block text-sm font-medium text-slate-300">Assigned Shops</label>
                                 <div className="bg-slate-700 p-3 rounded-lg max-h-60 overflow-y-auto border border-slate-600">
                                    <div className="flex items-center border-b border-slate-600 pb-2 mb-2"><input type="checkbox" id="all-shops" checked={allShopsSelected} onChange={e => handleAllShopsChange(e.target.checked)} className="h-4 w-4 rounded bg-slate-600 border-slate-500 text-blue-500 focus:ring-blue-500" /><label htmlFor="all-shops" className="ml-3 font-bold">All Shops</label></div>
                                    {shops.map(shop => (<div key={shop.id} className="flex items-center mt-1"><input id={`s-${shop.id}`} type="checkbox" checked={formData.shopIds?.includes(shop.id)} onChange={e => handleShopIdChange(shop.id, e.target.checked)} className="h-4 w-4 rounded bg-slate-600 border-slate-500 text-blue-500 focus:ring-blue-500" /><label htmlFor={`s-${shop.id}`} className="ml-3">{shop.name}</label></div>))}
                                 </div>
                             </div>
                             <div className="space-y-4 md:col-span-1">
                                <label className="block text-sm font-medium text-slate-300">Page Permissions</label>
                                <div className="bg-slate-700 p-3 rounded-lg max-h-60 overflow-y-auto border border-slate-600">
                                    {CONSTANTS.ALL_PAGES.map(page => (<div key={page.id} className="flex items-center mt-1"><input id={`p-${page.id}`} type="checkbox" checked={formData.accessiblePages?.includes(page.id)} onChange={e => handlePageAccessChange(page.id, e.target.checked)} className="h-4 w-4 rounded bg-slate-600 border-slate-500 text-blue-500 focus:ring-blue-500" /><label htmlFor={`p-${page.id}`} className="ml-3">{page.label}</label></div>))}
                                </div>
                             </div>
                         </div>
                         <div className="flex justify-end gap-4 pt-4 border-t border-slate-700">
                            <Button type="button" onClick={onClose} variant="secondary">Cancel</Button>
                            <Button type="submit" disabled={isSubmitting} className="w-24" icon={isSubmitting ? "LoaderCircle" : null}>{isSubmitting ? '' : "Save"}</Button>
                        </div>
                    </form>
                </Modal>
            );
        };

        // --- NEW COMPONENT: EmployeeCreateModal ---
        const EmployeeCreateModal = ({ onClose }) => {
            const { shops } = useData();
            const { showNotification } = useNotification();
            const { doc, setDoc } = window.Firebase;
            
            // Firebase functions for temporary app instance
            const { initializeApp, getAuth, createUserWithEmailAndPassword, deleteApp } = window.Firebase;

            const [formData, setFormData] = useState({
                name: '', email: '', password: '', position: '', role: 'Staff', shopIds: [], accessiblePages: [], status: 'Active' // <-- ADDED status
            });
            const [isSubmitting, setIsSubmitting] = useState(false);
            const isMounted = useRef(true);
            const [showPassword, setShowPassword] = useState(false);

            useEffect(() => {
                isMounted.current = true;
                return () => { isMounted.current = false; };
            }, []);

            const handleChange = (e) => setFormData(prev => ({ ...prev, [e.target.name]: e.target.value }));
            const handleShopIdChange = (shopId, isChecked) => setFormData(prev => ({ ...prev, shopIds: isChecked ? [...(prev.shopIds || []), shopId] : (prev.shopIds || []).filter(id => id !== shopId) }));
            const handleAllShopsChange = (isChecked) => setFormData(prev => ({...prev, shopIds: isChecked ? shops.map(s => s.id) : [] }));
            const handlePageAccessChange = (pageId, isChecked) => setFormData(prev => ({ ...prev, accessiblePages: isChecked ? [...(prev.accessiblePages || []), pageId] : (prev.accessiblePages || []).filter(id => id !== pageId) }));

            const handleSubmit = async (e) => {
                e.preventDefault();
                if (formData.password.length < 6) {
                    showNotification("Password must be at least 6 characters long.", "error");
                    return;
                }
                if (!isMounted.current) return;
                setIsSubmitting(true);

                const tempAppName = `temp-auth-app-${Date.now()}`;
                let tempApp;
                let newUid;

                try {
                    // 1. Initialize temporary, secondary app
                    const firebaseConfig = JSON.parse(document.getElementById('firebase-config-json').textContent);
                    tempApp = initializeApp(firebaseConfig, tempAppName);
                    const tempAuth = getAuth(tempApp);

                    // 2. Create the user with the temporary auth instance
                    // This creates the user in the project without logging out the admin
                    const userCredential = await createUserWithEmailAndPassword(tempAuth, formData.email, formData.password);
                    newUid = userCredential.user.uid;

                    // 3. Prepare the employee data (strip password)
                    const { password, ...profileData } = formData;
                    
                    // 4. Save the employee profile to Firestore using the *main* db instance
                    await setDoc(doc(window.db, "employees", newUid), profileData);
                    
                    showNotification("Employee created successfully!", "success");
                    if (isMounted.current) onClose();

                } catch (err) {
                    console.error("Employee creation error:", err);
                    showNotification(err.message || "Failed to create employee.", "error");
                } finally {
                    if (isMounted.current) setIsSubmitting(false);
                    // 5. Clean up (delete) the temporary app instance
                    if (tempApp) {
                        try {
                            await deleteApp(tempApp);
                        } catch (err) {
                            console.error("Failed to delete temp app", err);
                        }
                    }
                }
            };

            const allShopsSelected = formData.shopIds?.length === shops.length && shops.length > 0;

            return (
                 <Modal title="Create New Employee" onClose={onClose} size="4xl">
                    <form onSubmit={handleSubmit} className="space-y-6">
                         <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <div className="space-y-4 md:col-span-1">
                                <FormInput label="Full Name" name="name" value={formData.name || ''} onChange={handleChange} required />
                                <FormInput label="Position" name="position" value={formData.position || ''} onChange={handleChange} />
                                <FormInput label="Email" name="email" type="email" value={formData.email || ''} onChange={handleChange} required />
                                <div className="relative">
                                    <FormInput label="Password (min. 6 char)" name="password" type={showPassword ? 'text' : 'password'} value={formData.password} onChange={handleChange} required />
                                    <button type="button" onClick={() => setShowPassword(!showPassword)} className="absolute top-9 right-0 pr-3 flex items-center text-slate-400 hover:text-slate-200">
                                        <Icon name={showPassword ? 'EyeOff' : 'Eye'} />
                                    </button>
                                </div>
                                <FormSelect label="Role" name="role" value={formData.role || 'Staff'} onChange={handleChange} options={[{value: 'Admin', label: 'Admin'}, {value: 'Shop Manager', label: 'Shop Manager'}, {value: 'Staff', label: 'Staff'}]} />
                                {/* --- ADDED --- */}
                                <FormSelect 
                                    label="Status" 
                                    name="status" 
                                    value={formData.status || 'Active'} 
                                    onChange={handleChange} 
                                    options={[
                                        {value: 'Active', label: 'Active'}, 
                                        {value: 'Inactive', label: 'Inactive'}
                                    ]} 
                                />
                            </div>
                             <div className="space-y-4 md:col-span-1">
                                 <label className="block text-sm font-medium text-slate-300">Assigned Shops</label>
                                 <div className="bg-slate-700 p-3 rounded-lg max-h-60 overflow-y-auto border border-slate-600">
                                    <div className="flex items-center border-b border-slate-600 pb-2 mb-2"><input type="checkbox" id="all-shops-invite" checked={allShopsSelected} onChange={e => handleAllShopsChange(e.target.checked)} className="h-4 w-4 rounded bg-slate-600 border-slate-500 text-blue-500 focus:ring-blue-500" /><label htmlFor="all-shops-invite" className="ml-3 font-bold">All Shops</label></div>
                                    {shops.map(shop => (<div key={shop.id} className="flex items-center mt-1"><input id={`s-invite-${shop.id}`} type="checkbox" checked={formData.shopIds?.includes(shop.id)} onChange={e => handleShopIdChange(shop.id, e.target.checked)} className="h-4 w-4 rounded bg-slate-600 border-slate-500 text-blue-500 focus:ring-blue-500" /><label htmlFor={`s-invite-${shop.id}`} className="ml-3">{shop.name}</label></div>))}
                                 </div>
                             </div>
                             <div className="space-y-4 md:col-span-1">
                                <label className="block text-sm font-medium text-slate-300">Page Permissions</label>
                                <div className="bg-slate-700 p-3 rounded-lg max-h-60 overflow-y-auto border border-slate-600">
                                    {CONSTANTS.ALL_PAGES.map(page => (<div key={page.id} className="flex items-center mt-1"><input id={`p-invite-${page.id}`} type="checkbox" checked={formData.accessiblePages?.includes(page.id)} onChange={e => handlePageAccessChange(page.id, e.target.checked)} className="h-4 w-4 rounded bg-slate-600 border-slate-500 text-blue-500 focus:ring-blue-500" /><label htmlFor={`p-invite-${page.id}`} className="ml-3">{page.label}</label></div>))}
                                </div>
                             </div>
                         </div>
                         <div className="flex justify-end gap-4 pt-4 border-t border-slate-700">
                            <Button type="button" onClick={onClose} variant="secondary">Cancel</Button>
                            <Button type="submit" disabled={isSubmitting} className="w-40" icon={isSubmitting ? "LoaderCircle" : null}>{isSubmitting ? '' : "Create Employee"}</Button>
                        </div>
                    </form>
                </Modal>
            );
        };
        // --- END: EmployeeCreateModal ---

        // --- NEW COMPONENT: EmployeeImportModal ---
        const EmployeeImportModal = ({ onClose }) => {
            const { shops } = useData();
            const { showNotification } = useNotification();
            const { doc, setDoc } = window.Firebase;
            const { initializeApp, getAuth, createUserWithEmailAndPassword, deleteApp } = window.Firebase;

            const [parsedData, setParsedData] = useState(null);
            const [isImporting, setIsImporting] = useState(false);
            const [importLog, setImportLog] = useState([]);
            const isMounted = useRef(true);

            useEffect(() => {
                isMounted.current = true;
                return () => { isMounted.current = false; };
            }, []);

            const handleDownloadTemplate = () => {
                const templateData = [{
                    name: "John Doe",
                    email: "john.doe@example.com",
                    password: "password123",
                    position: "Cashier",
                    role: "Staff", // Must be Admin, Shop Manager, or Staff
                    status: "Active", // Must be Active or Inactive
                    shopNames: "JLW KTL,JLW BKK", // Comma-separated list of shop names
                    accessiblePages: "cashDrop,purchaseOrder", // Comma-separated list of page IDs
                    "Instructions / Notes (DELETE THIS ROW)": "role: Must be 'Admin', 'Shop Manager', or 'Staff'. | status: Must be 'Active' or 'Inactive'. | shopNames: Comma-separated list of exact shop names (e.g., JLW KTL,JLW BKK). | accessiblePages: Comma-separated list of page IDs (e.g., cashDrop, purchaseOrder, cashflowReport, settings)."
                }];
                const ws = window.XLSX.utils.json_to_sheet(templateData);
                const wb = window.XLSX.utils.book_new();
                window.XLSX.utils.book_append_sheet(wb, ws, "Employees");
                window.XLSX.writeFile(wb, "Employee_Import_Template.xlsx");
            };

            const handleFileChange = (e) => {
                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (evt) => {
                    const bstr = evt.target.result;
                    const wb = window.XLSX.read(bstr, { type: 'binary' });
                    const wsname = wb.SheetNames[0];
                    const ws = wb.Sheets[wsname];
                    const data = window.XLSX.utils.sheet_to_json(ws);
                    setParsedData(data);
                    setImportLog([]);
                    showNotification(`File parsed. Found ${data.length} records.`, "success");
                };
                reader.readAsBinaryString(file);
            };

            const handleStartImport = async () => {
                if (!parsedData) return;
                
                if (!isMounted.current) return;
                setIsImporting(true);
                setImportLog([]);

                const tempAppName = `temp-import-app-${Date.now()}`;
                let tempApp;
                let tempAuth;

                try {
                    const firebaseConfig = JSON.parse(document.getElementById('firebase-config-json').textContent);
                    tempApp = initializeApp(firebaseConfig, tempAppName);
                    tempAuth = getAuth(tempApp);

                    for (const [index, row] of parsedData.entries()) {
                        const email = row.email?.trim();
                        const password = row.password?.toString().trim();
                        const name = row.name?.trim();
                        const role = row.role?.trim() || 'Staff';
                        const status = row.status?.trim() || 'Active'; // <-- ADDED status import

                        if (!email || !password || !name) {
                            setImportLog(prev => [...prev, { status: 'error', message: `Row ${index + 2}: Skipped. Missing name, email, or password.` }]);
                            continue;
                        }

                        if (password.length < 6) {
                            setImportLog(prev => [...prev, { status: 'error', message: `Row ${index + 2}: Skipped for ${email}. Password must be at least 6 characters.` }]);
                            continue;
                        }

                        try {
                            // Find Shop IDs from Names
                            const shopNames = (row.shopNames || '').split(',').map(s => s.trim()).filter(Boolean);
                            const shopIds = shops.filter(s => shopNames.includes(s.name)).map(s => s.id);

                            // Get Accessible Pages
                            const accessiblePages = (row.accessiblePages || '').split(',').map(s => s.trim()).filter(Boolean);
                            
                            const profileData = {
                                name: name,
                                email: email,
                                position: row.position?.trim() || '',
                                role: role,
                                status: status, // <-- ADDED status save
                                shopIds: shopIds,
                                accessiblePages: accessiblePages
                            };

                            const userCredential = await createUserWithEmailAndPassword(tempAuth, email, password);
                            const newUid = userCredential.user.uid;

                            await setDoc(doc(window.db, "employees", newUid), profileData);
                            
                            setImportLog(prev => [...prev, { status: 'success', message: `Row ${index + 2}: Successfully created user ${email}.` }]);

                        } catch (err) {
                            console.error(`Failed to import row ${index + 2}:`, err);
                            setImportLog(prev => [...prev, { status: 'error', message: `Row ${index + 2}: Failed for ${email}. ${err.message}` }]);
                        }
                    }
                    showNotification("Import process finished.", "info");

                } catch (err) {
                    console.error("Import error:", err);
                    showNotification(err.message || "Failed to start import.", "error");
                } finally {
                    if (isMounted.current) setIsImporting(false);
                    if (tempApp) {
                        try {
                            await deleteApp(tempApp);
                        } catch (err) {
                            console.error("Failed to delete temp app", err);
                        }
                    }
                }
            };

            return (
                <Modal title="Import Staff from Excel" onClose={onClose} size="2xl">
                    <div className="space-y-4">
                        <div className="p-4 bg-slate-700/50 rounded-lg">
                            <h4 className="font-semibold text-slate-200">Step 1: Download Template</h4>
                            <p className="text-sm text-slate-400 my-2">Download the Excel template. The first row contains instructions and examples for columns like `role`, `shopNames`, and `accessiblePages`. Please delete the example row before uploading.</p>
                            <Button onClick={handleDownloadTemplate} variant="secondary">Download .xlsx Template</Button>
                        </div>

                        <div className="p-4 bg-slate-700/50 rounded-lg">
                            <h4 className="font-semibold text-slate-200">Step 2: Upload File</h4>
                            <FormInput type="file" onChange={handleFileChange} accept=".xlsx, .xls" className="mt-2" />
                        </div>
                        
                        {parsedData && !isImporting && (
                            <div className="p-4 bg-blue-900/30 border border-blue-600 rounded-lg text-center">
                                <h4 className="font-semibold text-blue-300">File Ready for Import</h4>
                                <p className="text-slate-300 my-2">Found {parsedData.length} records. Click below to begin the import process.</p>
                                <Button onClick={handleStartImport} disabled={isImporting} icon={isImporting ? "LoaderCircle" : "Upload"}>
                                    {isImporting ? 'Importing...' : `Start Importing ${parsedData.length} Users`}
                                </Button>
                            </div>
                        )}
                        
                        {isImporting && (
                             <div className="flex justify-center items-center gap-2 p-4">
                                <Icon name="LoaderCircle" />
                                <span className="text-slate-300">Importing... Please wait.</span>
                            </div>
                        )}

                        {importLog.length > 0 && (
                            <div className="p-4 bg-slate-900/50 rounded-lg max-h-60 overflow-y-auto">
                                <h4 className="font-semibold text-slate-200 mb-2">Import Log</h4>
                                <ul className="space-y-1">
                                    {importLog.map((log, index) => (
                                        <li key={index} className={`text-sm ${log.status === 'success' ? 'text-green-400' : 'text-red-400'}`}>
                                            {log.message}
                                        </li>
                                    ))}
                                </ul>
                            </div>
                        )}

                         <div className="flex justify-end gap-4 pt-4 border-t border-slate-700">
                            <Button type="button" onClick={onClose} variant="secondary">Close</Button>
                        </div>
                    </div>
                </Modal>
            );
        };
        // --- END: EmployeeImportModal ---

        const ManageExpenseCategoriesSection = () => {
            const { businessCategories, familyCategories } = useData();
            return(
                <div className="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <CategoryManager title="Business Expenses" icon="CreditCard" categories={businessCategories} collectionPath="businessExpenseCategories" />
                    <CategoryManager title="Family Expenses" icon="Users" categories={familyCategories} collectionPath="familyExpenseCategories" />
                </div>
            )
        };

        const CategoryManager = ({ title, icon, categories, collectionPath }) => {
            const { showNotification } = useNotification();
            const { doc, addDoc, deleteDoc, collection } = window.Firebase;
            const [newCategoryName, setNewCategoryName] = useState('');
            const [deletingCategory, setDeletingCategory] = useState(null);
            const [isDeleting, setIsDeleting] = useState(false);
            const isMounted = useRef(true);

            useEffect(() => {
                isMounted.current = true;
                return () => { isMounted.current = false; };
            }, []);

            const handleAddCategory = async (e) => {
                e.preventDefault();
                if (!newCategoryName.trim()) return;
                try {
                    await addDoc(collection(window.db, collectionPath), { name: newCategoryName.trim() });
                    if(isMounted.current) setNewCategoryName('');
                    showNotification("Category added.", "success");
                } catch (error) {
                    showNotification("Failed to add category.", "error");
                }
            };

            const handleDeleteCategory = async () => {
                if (!deletingCategory) return;
                setIsDeleting(true);
                try {
                    await deleteDoc(doc(window.db, collectionPath, deletingCategory.id));
                    showNotification("Category deleted.", "success");
                } catch (error) {
                    showNotification("Failed to delete category.", "error");
                } finally {
                    if (isMounted.current) {
                        setDeletingCategory(null);
                        setIsDeleting(false);
                    }
                }
            };

            return (
                <Card>
                    <h2 className="flex gap-2 items-center mb-4 text-xl font-bold text-slate-100 border-b border-slate-700 pb-3"><Icon name={icon}/>{title}</h2>
                    <form onSubmit={handleAddCategory} className="flex gap-4 mb-4">
                        <FormInput value={newCategoryName} onChange={e => setNewCategoryName(e.target.value)} placeholder="New category name..." />
                        <Button type="submit" icon="Plus">Add</Button>
                    </form>
                    <div className="space-y-2 max-h-60 overflow-y-auto pr-2">
                        {(categories || []).map(cat => (
                            <div key={cat.id} className="flex justify-between items-center p-2 rounded-md hover:bg-slate-700/50">
                                <span className="text-slate-200">{cat.name}</span>
                                <Button variant="ghost" onClick={() => setDeletingCategory(cat)} className="text-red-400 hover:bg-red-900/50"><Icon name="Trash2"/></Button>
                            </div>
                        ))}
                    </div>
                     {deletingCategory && <ConfirmationModal title="Delete Category" message={`Delete "${deletingCategory.name}"?`} onConfirm={handleDeleteCategory} onClose={() => setDeletingCategory(null)} isSubmitting={isDeleting} confirmVariant="danger" confirmText="Delete" />}
                </Card>
            );
        };
        // --- END: Settings Page ---

        const PlaceholderPage = ({title}) => (
            <PageHeader title={title} subtitle="This section is under construction."/>
        );
       
        const CashflowHistoryTab = ({ filters }) => {
            const data = useMonthlyData({ ...filters, dateRangeType: 'by_month' });

            // Create a lookup map for faster margin history access
            const marginHistoryMap = useMemo(() => {
                if (!data.saleMarginHistory) return new Map();
                // Stores margin as: "ShopName|YYYY-MM" -> marginValue
                return data.saleMarginHistory.reduce((map, history) => {
                    const key = `${history.shop}|${history.month}`;
                    map.set(key, history.margin);
                    return map;
                }, new Map());
            }, [data.saleMarginHistory]);

            const getMarginForReport = useCallback((report, defaultShopMargin) => {
                if (!report.createdAt?.toDate) return defaultShopMargin; // Safety check
                
                const reportDate = report.createdAt.toDate();
                // Format date to "YYYY-MM" string key
                const reportMonthKey = reportDate.toISOString().slice(0, 7); 
                const historyKey = `${report.shop}|${reportMonthKey}`;
                
                if (marginHistoryMap.has(historyKey)) {
                    return marginHistoryMap.get(historyKey); // Use historical margin
                }
                return defaultShopMargin; // Fallback to current default
            }, [marginHistoryMap]);


            const { shopCalculations, totals: cashflowTotals } = useMemo(() => {
                const shopCalculations = data.shops.map(shop => {
                    const openingGCA = shop.gca || 0;
                    const saleMargin = shop.saleMargin || 0; // This is the *default* margin
                    
                    // --- Updated Sales Contribution Logic ---
                    const salesContributionAllTime = data.allReports
                        .filter(cd => cd.shop === shop.name)
                        .reduce((sum, cd) => {
                            // Use the new helper function to get the correct margin
                            const effectiveMargin = getMarginForReport(cd, saleMargin);
                            const marginToUse = (1 - (effectiveMargin / 100));
                            return sum + (cd.grandTotalKhr * marginToUse);
                        }, 0);
                    // --- End Updated Logic ---

                    const totalPOsAllTime = data.allPOs.filter(po => po.shop === shop.name).reduce((sum, po) => sum + ((po.amountKhr || 0) + (po.amountUsd || 0) * data.exchangeRate), 0);
                    const transfersInAllTime = data.allTransfers.filter(it => it.toShop === shop.name).reduce((sum, it) => sum + (it.amountKhr || 0) + ((it.amountUsd || 0) * data.exchangeRate), 0);
                    const transfersOutAllTime = data.allTransfers.filter(it => it.fromShop === shop.name).reduce((sum, it) => sum + (it.amountKhr || 0) + ((it.amountUsd || 0) * data.exchangeRate), 0);
                    const currentGCA = openingGCA + salesContributionAllTime - totalPOsAllTime - transfersInAllTime + transfersOutAllTime;

                    const netSaleForMonth = data.filteredReports.filter(cd => cd.shop === shop.name).reduce((sum, cd) => sum + (cd.grandTotalKhr || 0), 0);
                    const bizExpenseForMonth = data.filteredBusinessExpenses.filter(e => e.shop === shop.name).reduce((sum, e) => sum + (e.totalAmountKhr || 0), 0);
                    
                    // --- Updated Net Profit Logic ---
                    const netProfitForMonth = data.filteredReports
                        .filter(cd => cd.shop === shop.name)
                        .reduce((sum, cd) => {
                            // Use the new helper function to get the correct margin
                            const effectiveMargin = getMarginForReport(cd, saleMargin);
                            const marginToUse = (effectiveMargin / 100);
                            return sum + (cd.grandTotalKhr * marginToUse);
                        }, 0);
                    // --- End Updated Logic ---
                    
                    const totalNetIncomeForMonth = netProfitForMonth - bizExpenseForMonth;
                    const totalPOForMonth = data.filteredPurchaseOrders.filter(po => po.shop === shop.name).reduce((sum, po) => sum + ((po.amountKhr || 0) + (po.amountUsd || 0) * data.exchangeRate), 0);
                    const totalTransInForMonth = data.filteredInternalTransfers.filter(it => it.toShop === shop.name).reduce((sum, it) => sum + (it.amountKhr || 0) + ((it.amountUsd || 0) * data.exchangeRate), 0);
                    const totalTransOutForMonth = data.filteredInternalTransfers.filter(it => it.fromShop === shop.name).reduce((sum, it) => sum + (it.amountKhr || 0) + ((it.amountUsd || 0) * data.exchangeRate), 0);

                    return { name: shop.name, currentGCA, netSale: netSaleForMonth, netProfit: netProfitForMonth, totalPO: totalPOForMonth, totalTransIn: totalTransInForMonth, totalTransOut: totalTransOutForMonth, totalBizExpense: bizExpenseForMonth, totalNetIncome: totalNetIncomeForMonth };
                });
                const totals = shopCalculations.reduce((acc, shop) => {
                    Object.keys(shop).forEach(key => { if (key !== 'name') acc[key] = (acc[key] || 0) + shop[key]; });
                    return acc;
                }, {});
                return { shopCalculations, totals };
            }, [data, getMarginForReport]); // <-- ADDED dependency

            const { shareholderData, totals: shareholderTotals } = useMemo(() => {
                const shareholderData = {};
                const allShareholders = [...new Set(data.shops.flatMap(s => (s.shareholders || []).map(sh => sh.name)))];
                allShareholders.forEach(name => {
                    shareholderData[name] = { totalGCA: 0, totalNetIncome: 0, totalBizExpense: 0, familyExpense: 0, finalNetIncome: 0, totalCOH: 0 };
                });

                data.shops.forEach(shop => {
                    const openingGCA = shop.gca || 0;
                    const saleMargin = shop.saleMargin || 0; // *Default* margin
                    
                    // --- Updated Sales Contribution Logic (Shareholder) ---
                    const salesContributionAllTime = data.allReports
                        .filter(cd => cd.shop === shop.name)
                        .reduce((sum, cd) => {
                            const effectiveMargin = getMarginForReport(cd, saleMargin); // <-- Use helper
                            const marginToUse = (1 - (effectiveMargin / 100));
                            return sum + (cd.grandTotalKhr * marginToUse);
                        }, 0);
                    // --- End Updated Logic ---
                    
                    const totalPOsAllTime = data.allPOs.filter(po => po.shop === shop.name).reduce((sum, po) => sum + ((po.amountKhr || 0) + (po.amountUsd || 0) * data.exchangeRate), 0);
                    const transfersInAllTime = data.allTransfers.filter(it => it.toShop === shop.name).reduce((sum, it) => sum + (it.amountKhr || 0) + ((it.amountUsd || 0) * data.exchangeRate), 0);
                    const transfersOutAllTime = data.allTransfers.filter(it => it.fromShop === shop.name).reduce((sum, it) => sum + (it.amountKhr || 0) + ((it.amountUsd || 0) * data.exchangeRate), 0);
                    const currentGCA = openingGCA + salesContributionAllTime - totalPOsAllTime - transfersInAllTime + transfersOutAllTime;

                    const netSaleForMonth = data.filteredReports.filter(cd => cd.shop === shop.name).reduce((sum, cd) => sum + (cd.grandTotalKhr || 0), 0);
                    const bizExpenseForMonth = data.filteredBusinessExpenses.filter(e => e.shop === shop.name).reduce((sum, e) => sum + (e.totalAmountKhr || 0), 0);
                    
                    // --- Updated Net Profit Logic (Shareholder) ---
                    const netProfitForMonth = data.filteredReports
                        .filter(cd => cd.shop === shop.name)
                        .reduce((sum, cd) => {
                            const effectiveMargin = getMarginForReport(cd, saleMargin); // <-- Use helper
                            const marginToUse = (effectiveMargin / 100);
                            return sum + (cd.grandTotalKhr * marginToUse);
                        }, 0);
                    // --- End Updated Logic ---
                    
                    const totalNetIncomeForMonth = netProfitForMonth - bizExpenseForMonth;
                    
                    (shop.shareholders || []).forEach(sh => {
                        if(shareholderData[sh.name]) {
                            shareholderData[sh.name].totalGCA += currentGCA * (sh.percentage / 100);
                            shareholderData[sh.name].totalNetIncome += totalNetIncomeForMonth * (sh.percentage / 100);
                            shareholderData[sh.name].totalBizExpense += bizExpenseForMonth * (sh.percentage / 100);
                        }
                    });
                });

                data.filteredFamilyExpenses.forEach(expense => {
                    if (shareholderData[expense.paidBy]) {
                        shareholderData[expense.paidBy].familyExpense += (expense.totalAmountKhr || 0);
                    }
                });

                Object.keys(shareholderData).forEach(name => {
                    const d = shareholderData[name];
                    d.finalNetIncome = d.totalNetIncome - d.familyExpense;
                    d.totalCOH = d.finalNetIncome + d.totalGCA;
                });
                
                const totals = Object.values(shareholderData).reduce((acc, d) => {
                    acc.totalGCA += d.totalGCA;
                    acc.totalNetIncome += d.totalNetIncome;
                    acc.totalBizExpense += d.totalBizExpense;
                    acc.familyExpense += d.familyExpense;
                    acc.finalNetIncome += d.finalNetIncome;
                    acc.totalCOH += d.totalCOH;
                    return acc;
                }, { totalGCA: 0, totalNetIncome: 0, totalBizExpense: 0, familyExpense: 0, finalNetIncome: 0, totalCOH: 0 });

                return { shareholderData, totals };
            }, [data, getMarginForReport]); // <-- ADDED dependency

            return (
                <>
                    <Card>
                        <h3 className="text-lg font-bold mb-4 text-slate-100">CashFlow History</h3>
                        <div className="overflow-x-auto">
                           <table className="w-full text-sm text-slate-300">
                                 <thead className="bg-slate-900/50 text-xs uppercase">
                                    <tr>
                                        <th className="p-2 text-left">No.</th><th className="p-2 text-left">Shop</th>
                                        <th className="p-2 text-right">Current GCA (៛)</th><th className="p-2 text-right">Net Sale</th>
                                        <th className="p-2 text-right">Net Profit</th><th className="p-2 text-right">Total PO</th>
                                        <th className="p-2 text-right">Total Tran-IN</th><th className="p-2 text-right">Total-Trans-OUT</th>
                                        <th className="p-2 text-right">Total Biz Expense</th><th className="p-2 text-right">Total Net Income</th>
                                    </tr>
                                 </thead>
                                 <tbody className="divide-y divide-slate-700">
                                    {shopCalculations.map((shop, index) => (
                                        <tr key={shop.name}>
                                            <td className="p-2">{index+1}</td>
                                            <td className="p-2 font-semibold">{shop.name}</td>
                                            <td className="p-2 text-right font-mono">{shop.currentGCA.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                                            <td className="p-2 text-right font-mono">{shop.netSale.toLocaleString()}</td>
                                            <td className="p-2 text-right font-mono text-green-400">{shop.netProfit.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                                            <td className="p-2 text-right font-mono text-red-400">{shop.totalPO.toLocaleString()}</td>
                                            <td className="p-2 text-right font-mono">{shop.totalTransIn.toLocaleString()}</td>
                                            <td className="p-2 text-right font-mono">{shop.totalTransOut.toLocaleString()}</td>
                                            <td className="p-2 text-right font-mono text-red-400">{shop.totalBizExpense.toLocaleString()}</td>
                                            <td className="p-2 text-right font-mono font-bold text-blue-400 bg-slate-700/50">{shop.totalNetIncome.toLocaleString()}</td>
                                        </tr>
                                    ))}
                                 </tbody>
                                 <tfoot className="bg-slate-900/50 font-bold">
                                    <tr>
                                        <td colSpan="2" className="p-2 text-right">Sub-Totals</td>
                                        <td className="p-2 text-right font-mono">{cashflowTotals.currentGCA?.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                                        <td className="p-2 text-right font-mono">{cashflowTotals.netSale?.toLocaleString()}</td>
                                        <td className="p-2 text-right font-mono">{cashflowTotals.netProfit?.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                                        <td className="p-2 text-right font-mono">{cashflowTotals.totalPO?.toLocaleString()}</td>
                                        <td className="p-2 text-right font-mono">{cashflowTotals.totalTransIn?.toLocaleString()}</td>
                                        <td className="p-2 text-right font-mono">{cashflowTotals.totalTransOut?.toLocaleString()}</td>
                                        <td className="p-2 text-right font-mono">{cashflowTotals.totalBizExpense?.toLocaleString()}</td>
                                        <td className="p-2 text-right font-mono text-blue-400">{cashflowTotals.totalNetIncome?.toLocaleString()}</td>
                                    </tr>
                                 </tfoot>
                            </table>
                        </div>
                    </Card>
                    <Card className="mt-8">
                        <h3 className="text-lg font-bold mb-4 text-slate-100">Shareholder NET</h3>
                        <div className="overflow-x-auto">
                            <table className="w-full text-sm text-slate-300">
                                <thead className="bg-slate-900/50 text-xs uppercase">
                                    <tr>
                                        <th className="p-2 text-left">No.</th><th className="p-2 text-left">Shareholder</th>
                                        <th className="p-2 text-right">Total GCA</th><th className="p-2 text-right">Total Net-Income</th>
                                        <th className="p-2 text-right">Total Biz Expense</th>
                                        <th className="p-2 text-right">Family Expense</th><th className="p-2 text-right">Final Net-Income</th>
                                        <th className="p-2 text-right">Total COH</th>
                                    </tr>
                                </thead>
                                <tbody className="divide-y divide-slate-700">
                                    {Object.entries(shareholderData).map(([name, d], index) => (
                                        <tr key={name}>
                                            <td className="p-2">{index + 1}</td><td className="p-2 font-semibold">{name}</td>
                                            <td className="p-2 text-right font-mono">{d.totalGCA.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                                            <td className="p-2 text-right font-mono">{d.totalNetIncome.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                                            <td className="p-2 text-right font-mono text-red-400">{d.totalBizExpense.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                                            <td className="p-2 text-right font-mono text-red-400">{d.familyExpense.toLocaleString()}</td>
                                            <td className="p-2 text-right font-mono font-bold">{d.finalNetIncome.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                                            <td className="p-2 text-right font-mono font-bold text-blue-400">{d.totalCOH.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                                        </tr>
                                    ))}
                                </tbody>
                                <tfoot className="bg-slate-900/50 font-bold">
                                    <tr>
                                        <td colSpan="2" className="p-2 text-right">Sub-Total (KHR)</td>
                                        <td className="p-2 text-right font-mono">{shareholderTotals.totalGCA.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                                        <td className="p-2 text-right font-mono">{shareholderTotals.totalNetIncome.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                                        <td className="p-2 text-right font-mono text-red-400">{shareholderTotals.totalBizExpense.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                                        <td className="p-2 text-right font-mono">{shareholderTotals.familyExpense.toLocaleString()}</td>
                                        <td className="p-2 text-right font-mono">{shareholderTotals.finalNetIncome.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                                        <td className="p-2 text-right font-mono">{shareholderTotals.totalCOH.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                    </Card>
                </>
            );
        };
        
        // =================================================================================
        // #region IIT PAYMENT TAB
        // =================================================================================
        // #endregion
        
        const CashFlowReportPage = () => {
            const [activeTab, setActiveTab] = useState('cashflowHistory');
            const [filters, setFilters] = useState({ month: new Date().toISOString().slice(0, 7) });
            const printRef = useRef();
            const { showNotification } = useNotification();
            const [isCapturing, setIsCapturing] = useState(false);
            const isMounted = useRef(true);

            useEffect(() => {
                isMounted.current = true;
                return () => { isMounted.current = false; };
            }, []);

            const handleDownloadImage = useCallback(async () => {
                if (!printRef.current || !isMounted.current) return;
                setIsCapturing(true);
                // Allow time for state to update before capturing
                setTimeout(async () => {
                    try {
                        const canvas = await html2canvas(printRef.current, { useCORS: true, scale: 2, backgroundColor: '#0f172a' });
                        const image = canvas.toDataURL("image/png", 1.0);
                        const link = document.createElement('a');
                        link.href = image;
                        link.download = `cashflow-report-${filters.month}.png`;
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                        showNotification("Image downloaded successfully!", "success");
                    } catch (error) {
                        console.error("Image capture error:", error);
                        showNotification("Failed to download image.", "error");
                    } finally {
                        if(isMounted.current) setIsCapturing(false);
                    }
                }, 100);
            }, [filters.month, showNotification]);

            const TabButton = ({ tabName, label, isActive, onClick }) => (
                <button onClick={() => onClick(tabName)} className={`px-4 py-2 text-sm font-semibold rounded-t-lg ${isActive ? 'border-b-2 border-blue-500 text-blue-400' : 'text-slate-400 hover:bg-slate-700/50'}`}>
                    {label}
                </button>
            );

            return (
                <div>
                    <PageHeader title="CashFlow Report" subtitle="Monthly financial overview.">
                        <div className="flex gap-2">
                             <a href="https://jlw168.github.io/App-Center/Family-Cashflow.html" target="_blank" rel="noopener noreferrer">
                                <Button variant="primary" icon="ExternalLink">Family Cashflow</Button>
                            </a>
                             <Button onClick={handleDownloadImage} disabled={isCapturing} variant="secondary" icon={isCapturing ? 'LoaderCircle' : 'Download'}>
                                {isCapturing ? 'Capturing...' : 'Download as Image'}
                            </Button>
                        </div>
                    </PageHeader>
                    <div className="border-b border-slate-700 flex space-x-1 sm:space-x-2 flex-wrap">
                        <TabButton tabName="cashflowHistory" label="CashFlow & Shareholder NET" isActive={activeTab === 'cashflowHistory'} onClick={setActiveTab} />
                    </div>
                    <Card className="mt-6">
                        <FormInput label="Select Month" type="month" name="month" value={filters.month} onChange={(e) => setFilters({ month: e.target.value })} />
                    </Card>
                    
                    <div ref={printRef} className="bg-slate-900 p-4 rounded-lg space-y-8 mt-6">
                        {activeTab === 'cashflowHistory' && <CashflowHistoryTab filters={filters} />}
                    </div>
                </div>
            );
        };
        
        // =================================================================================
        // #region 5. MAIN APP & AUTHENTICATION
        // =================================================================================
        
        // --- REMOVED SignUpPage ---

        const LoginPage = () => {
            const { signInWithEmailAndPassword, setPersistence, browserSessionPersistence, browserLocalPersistence } = window.Firebase;
            const { showNotification } = useNotification();
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [isLoading, setIsLoading] = useState(false);
            const [showPassword, setShowPassword] = useState(false);
            const [rememberMe, setRememberMe] = useState(false);

            const handleLogin = async (e) => {
                e.preventDefault();
                setIsLoading(true);
                try {
                    const persistence = rememberMe ? browserLocalPersistence : browserSessionPersistence;
                    await setPersistence(window.auth, persistence);
                    await signInWithEmailAndPassword(window.auth, email, password);
                } catch (err) {
                    showNotification('Login failed. Please check your credentials.', 'error');
                } finally {
                    setIsLoading(false);
                }
            };

            return (
                <div className="flex items-center justify-center min-h-full bg-slate-900 px-4 py-12">
                    <div className="w-full max-w-md space-y-8">
                        <div>
                            <Icon name="Landmark" className="mx-auto h-12 w-auto text-blue-500" />
                            <h2 className="mt-6 text-center text-3xl font-extrabold text-slate-100">Sign in to your Account</h2>
                            <p className="mt-2 text-center text-sm text-red-400 font-semibold">For Internal Management ONLY!</p>
                        </div>
                        <form onSubmit={handleLogin} className="mt-8 space-y-6">
                            <div className="rounded-md shadow-sm space-y-4">
                                <FormInput label="Email address" name="email" type="email" value={email} onChange={(e) => setEmail(e.target.value)} required placeholder="Email address" />
                                <div className="relative">
                                    <FormInput label="Password" name="password" type={showPassword ? 'text' : 'password'} value={password} onChange={(e) => setPassword(e.target.value)} required placeholder="Password" />
                                    <button type="button" onClick={() => setShowPassword(!showPassword)} className="absolute top-9 right-0 pr-3 flex items-center text-slate-400 hover:text-slate-200">
                                        <Icon name={showPassword ? 'EyeOff' : 'Eye'} />
                                    </button>
                                </div>
                            </div>
                            <div className="flex items-center"><input id="remember-me" name="remember-me" type="checkbox" checked={rememberMe} onChange={(e) => setRememberMe(e.target.checked)} className="h-4 w-4 bg-slate-700 border-slate-600 text-blue-600 focus:ring-blue-500 rounded" /><label htmlFor="remember-me" className="ml-2 block text-sm text-slate-300">Remember me</label></div>
                            <Button type="submit" disabled={isLoading} className="w-full" icon={isLoading ? "LoaderCircle" : null}>{isLoading ? 'Signing in...' : 'Sign in'}</Button>
                        </form>
                    </div>
                </div>
            );
        };

        const AppLayout = () => {
            const { userData } = useAuth();
            const { signOut } = window.Firebase;
            const { showNotification } = useNotification();
            
            // --- UPDATED: Centralized Access Logic with Safe Type Checking ---
            const hasDashboardAccess = useMemo(() => {
                if (!userData?.role) return false;
                // Ensure role is a string before trimming to prevent errors
                const normalizedRole = String(userData.role).trim();
                return ['Admin', 'Management', 'Shop Manager'].includes(normalizedRole);
            }, [userData]);

            const getDefaultPage = useCallback(() => {
                // Priority 1: Dashboard roles (Admin, Management, Shop Manager) ALWAYS go to Dashboard first
                if (hasDashboardAccess) return 'dashboard';
                
                // Priority 2: Staff with Cash Drop access go to Cash Drop
                if (userData?.accessiblePages?.includes('cashDrop')) return 'cashDrop';
                
                // Priority 3: Fallback to first accessible page or Cashflow Report
                return (userData?.accessiblePages?.[0] || 'cashflowReport');
            }, [userData, hasDashboardAccess]);

            const [activePage, setActivePage] = useState(getDefaultPage());
            const [isSidebarOpen, setIsSidebarOpen] = useState(false);

            useEffect(() => {
                // Allow implicit access to Dashboard and Sale Report for specific roles
                if ((activePage === 'dashboard' || activePage === 'saleReport') && hasDashboardAccess) {
                    return; 
                }

                // Redirect if user is on a page they don't have permission for
                if (userData?.accessiblePages && !userData.accessiblePages.includes(activePage)) {
                    setActivePage(getDefaultPage());
                }
            }, [userData, activePage, getDefaultPage, hasDashboardAccess]);

            const handleLogout = async () => {
                await signOut(window.auth);
                showNotification("You have been logged out.", "info");
            };

            const NavLink = ({ item }) => {
                let hasAccess = userData?.accessiblePages?.includes(item.id);
                
                // --- UPDATED: Implicit permissions for Dashboard & Sale Report ---
                if (['saleReport', 'dashboard'].includes(item.id) && hasDashboardAccess) {
                    hasAccess = true;
                }
                
                if (!hasAccess) return null;

                const isActive = activePage === item.id;
                return (
                    <a href="#" onClick={(e) => { e.preventDefault(); setActivePage(item.id); setIsSidebarOpen(false); }}
                        className={`flex items-center w-full px-3 py-2.5 text-sm font-medium rounded-lg transition-colors group ${ isActive ? 'bg-blue-600 text-white' : 'text-slate-300 hover:bg-slate-700 hover:text-slate-100' }`}>
                        <Icon name={item.icon} className={`mr-3 h-5 w-5 ${isActive ? 'text-white' : 'text-slate-400 group-hover:text-slate-300'}`} />
                        <span>{item.label}</span>
                    </a>
                );
            }

            return (
                <div className="flex h-full text-slate-300">
                    <div className={`fixed inset-y-0 left-0 z-40 w-64 bg-slate-800 border-r border-slate-700 transform ${isSidebarOpen ? 'translate-x-0' : '-translate-x-full'} md:relative md:translate-x-0 transition-transform`}>
                        <div className="flex items-center justify-center p-4 h-16 border-b border-slate-700">
                             <Icon name="Landmark" className="h-8 w-auto text-blue-500" />
                             <h2 className="ml-2 text-xl font-bold text-slate-100">JLW Management</h2>
                        </div>
                        <nav className="flex-grow p-4 space-y-1">
                            {CONSTANTS.NAV_ITEMS.map(item => <NavLink key={item.id} item={item} />)}
                        </nav>
                    </div>

                    <div className="flex-1 flex flex-col overflow-hidden">
                        <header className="relative z-30 flex-shrink-0 flex h-16 bg-slate-800/50 backdrop-blur-sm shadow-lg border-b border-slate-700">
                             <button onClick={() => setIsSidebarOpen(true)} className="px-4 border-r border-slate-700 text-slate-400 md:hidden"><Icon name="Menu" className="h-6 w-6" /></button>
                             <div className="flex-1 px-4 flex justify-end items-center gap-4">
                                <span className="text-sm font-medium text-slate-200 hidden sm:inline">Welcome, {userData.name}</span>
                                <Button onClick={handleLogout} variant="ghost" className="text-slate-400 hover:text-red-400 !p-2 rounded-full" title="Sign out" icon="LogOut" />
                             </div>
                        </header>
                        <main className="flex-1 overflow-y-auto bg-slate-900 p-6">
                            <div className="max-w-7xl mx-auto">
                                <PageContent activePage={activePage} getDefaultPage={getDefaultPage} />
                            </div>
                        </main>
                    </div>
                </div>
            );
        };
        
        const PageContent = ({ activePage, getDefaultPage }) => {
            const pages = {
                dashboard: DashboardPage, // <--- MAPPED NEW PAGE
                cashDrop: CashDropPage, 
                saleReport: SaleReportPage,
                purchaseOrder: PurchaseOrderPage,
                expenseReport: ExpenseReportPage, 
                cashflowReport: CashFlowReportPage, 
                settings: SettingsPage,
            };
            const Component = pages[activePage] || pages[getDefaultPage()];
            return <Component />;
        };
        // #endregion

        // =================================================================================
        // #region 6. APP ENTRY POINT
        // =================================================================================
        const App = () => {
            const { user, userData, isLoading } = useAuth();
            
            // --- REMOVED: Check for invitation link ---
            
            if (isLoading) {
                return <div className="flex items-center justify-center h-screen bg-slate-900"><Icon name="LoaderCircle" size={48} className="text-blue-500" /></div>;
            }
            
            // --- SIMPLIFIED: Show AppLayout or LoginPage ---
            return user && userData ? <AppLayout /> : <LoginPage />;
        }

        ReactDOM.render(
            <NotificationProvider>
                <AuthProvider>
                    <DataProvider>
                        <App />
                    </DataProvider>
                </AuthProvider>
            </NotificationProvider>, 
            document.getElementById('root')
        );
        // #endregion
    </script>
    
    <!-- ADDED: Script tag to hold firebase config for the temp app -->
    <script id="firebase-config-json" type="application/json">
        {
            "apiKey": "AIzaSyA4upjtl0UFToWSfRZEiEQvwz9ieFLfqhI",
            "authDomain": "cashflow-mgr.firebaseapp.com",
            "projectId": "cashflow-mgr",
            "storageBucket": "cashflow-mgr.appspot.com",
            "messagingSenderId": "873891130920",
            "appId": "1:873891130920:web:b6b8f0432943c33a930f1d",
            "measurementId": "G-LVLMJ8ZY0B"
        }
    </script>

</body>
</html>
