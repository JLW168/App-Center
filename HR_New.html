<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HR Management System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" xintegrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        @import url('https://rsms.me/inter/inter.css');
        html { font-family: 'Inter', sans-serif; }
        .input {
            margin-top: 0.25rem; display: block; width: 100%; padding: 0.5rem 0.75rem;
            border-width: 1px; border-color: #475569; border-radius: 0.375rem;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); line-height: 1.5;
            background-color: #334155; color: #f1f5f9;
        }
        .input:focus {
            outline: 2px solid transparent; outline-offset: 2px;
            --tw-ring-color: #2563eb; border-color: #2563eb;
        }
        .checkbox-group {
            max-height: 150px; overflow-y: auto; border: 1px solid #475569;
            border-radius: 0.375rem; padding: 0.75rem; margin-top: 0.25rem;
            background-color: #334155;
        }
        .tab-link-dark {
            color: #94a3b8; border-color: transparent; transition: color 0.2s, border-color 0.2s;
        }
        .tab-link-dark:hover { color: #e2e8f0; border-color: #475569; }
        .tab-link-dark.active-tab-dark { color: #60a5fa; border-color: #60a5fa; font-weight: 600; }
    </style>
</head>
<body class="bg-slate-900 text-slate-300">
    <div id="root"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, doc, addDoc, updateDoc, deleteDoc, query } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        window.firebaseSDK = {
            initializeApp, getAuth, getFirestore, collection, onSnapshot,
            doc, addDoc, updateDoc, deleteDoc, query
        };
    </script>
    
    <script type="text/babel">
        const { useState, useEffect, useMemo, useCallback } = React;

        // --- PASTE YOUR FIREBASE CONFIGURATION HERE ---
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_AUTH_DOMAIN",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_STORAGE_BUCKET",
            messagingSenderId: "YOUR_SENDER_ID",
            appId: "YOUR_APP_ID"
        };
        // ---------------------------------------------
        
        // --- CUSTOM HOOK FOR DATA FETCHING ---
        const useCollection = (db, collectionName) => {
            const [data, setData] = useState([]);
            useEffect(() => {
                if (!db) return;
                const { collection, onSnapshot, query } = window.firebaseSDK;
                const q = query(collection(db, collectionName));
                const unsubscribe = onSnapshot(q, (querySnapshot) => {
                    const items = [];
                    querySnapshot.forEach((doc) => {
                        items.push({ id: doc.id, ...doc.data() });
                    });
                    setData(items);
                });
                return () => unsubscribe();
            }, [db, collectionName]);
            return { data };
        };

        // --- REUSABLE UI & PAGE COMPONENTS ---
        const Card = ({ children, className = '' }) => (
            <div className={`bg-slate-800/50 p-6 rounded-lg shadow-lg border border-slate-700 ${className}`}>
                {children}
            </div>
        );

        const UnderConstructionPage = ({ title }) => (
            <Card>
                <div className="text-center p-8">
                    <i className="fas fa-tools text-5xl text-yellow-400 mb-6"></i>
                    <h3 className="text-3xl font-bold text-slate-200">{title}</h3>
                    <p className="text-slate-400 mt-2">This page is under construction.</p>
                </div>
            </Card>
        );

        // --- SETTINGS PAGE & CRUD COMPONENT ---
        function SettingsCRUD({ db, auth, title, collectionName, items, formFields, listColumns }) {
            const [editingItem, setEditingItem] = useState(null);
            const [newItem, setNewItem] = useState({});

            const getInitialState = useCallback(() => {
                return formFields.reduce((acc, field) => {
                    acc[field.name] = (field.type === 'checkbox-group') ? [] : (field.type === 'checkbox' ? false : '');
                    return acc;
                }, {});
            }, [formFields]);

            useEffect(() => {
                setNewItem(getInitialState());
            }, [getInitialState]);

            const handleSave = async (item) => {
                const { doc, updateDoc, addDoc, collection } = window.firebaseSDK;
                const dataToSave = { ...item };
                try {
                    if (item.id) {
                        const { id, ...data } = dataToSave;
                        await updateDoc(doc(db, collectionName, id), data);
                    } else {
                        await addDoc(collection(db, collectionName), dataToSave);
                    }
                    setEditingItem(null);
                    setNewItem(getInitialState());
                } catch (e) {
                    console.error(`Error saving ${collectionName}:`, e);
                }
            };
            
            const handleDelete = async (id) => {
                if (window.confirm(`Are you sure you want to delete this item?`)) {
                    try {
                        const { doc, deleteDoc } = window.firebaseSDK;
                        await deleteDoc(doc(db, collectionName, id));
                    } catch (e) {
                        console.error(`Error deleting ${collectionName}:`, e);
                    }
                }
            };

            const handleInputChange = (e, item, setItem) => {
                const { name, type, value, checked } = e.target;
                 if (type === 'checkbox' && !Array.isArray(item[name])) {
                    setItem({ ...item, [name]: checked });
                 } else if (type === 'checkbox') {
                    const currentValues = item[name] || [];
                    if (checked) {
                        setItem({ ...item, [name]: [...currentValues, value] });
                    } else {
                        setItem({ ...item, [name]: currentValues.filter(val => val !== value) });
                    }
                } else {
                    setItem({ ...item, [name]: value });
                }
            };

            const renderForm = (item, setItem, isNew = false) => (
                 <form onSubmit={(e) => { e.preventDefault(); handleSave(item); }} className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4 items-end p-4 bg-slate-800/50 rounded-lg mb-6 border border-slate-700">
                    {formFields.map(field => (
                        <div key={field.name} className={field.fullWidth ? 'col-span-full' : ''}>
                            <label className="block text-sm font-medium text-slate-400">{field.label}</label>
                            <input type={field.type || 'text'} name={field.name} value={item[field.name] || ''} onChange={(e) => handleInputChange(e, item, setItem)} className="input" required={field.required} />
                        </div>
                    ))}
                    <div className="flex space-x-2 col-span-1 self-end">
                        <button type="submit" className="w-full bg-blue-600 text-white px-4 py-2 rounded-lg shadow hover:bg-blue-700 transition-colors">
                            {isNew ? `Add ${title}` : 'Save'}
                        </button>
                        {!isNew && <button type="button" onClick={() => setEditingItem(null)} className="w-full bg-slate-600 text-slate-200 px-4 py-2 rounded-lg hover:bg-slate-500">Cancel</button>}
                    </div>
                </form>
            );

            return (
                <div className="bg-slate-800/50 p-6 rounded-lg border border-slate-700">
                    <h2 className="text-2xl font-semibold text-slate-100 mb-4">{title} Properties</h2>
                    {renderForm(newItem, setNewItem, true)}
                    <div className="overflow-x-auto">
                        <table className="min-w-full divide-y divide-slate-700">
                             <thead className="bg-slate-900/50">
                                <tr>
                                    {listColumns.map(col => <th key={col.header} className="px-6 py-3 text-left text-xs font-semibold text-slate-400 uppercase tracking-wider">{col.header}</th>)}
                                    <th className="px-6 py-3 text-right text-xs font-semibold text-slate-400 uppercase tracking-wider">Actions</th>
                                </tr>
                            </thead>
                            <tbody className="bg-slate-800/50 divide-y divide-slate-700">
                                {items.map(item => (
                                    <tr key={item.id} className="hover:bg-slate-700/50">
                                        {editingItem?.id === item.id ? (
                                            <td colSpan={listColumns.length + 1} className="p-0">
                                                {renderForm(editingItem, setEditingItem)}
                                            </td>
                                        ) : (
                                            <>
                                                {listColumns.map(col => (
                                                    <td key={col.header} className="px-6 py-4 whitespace-nowrap text-sm text-slate-300">
                                                        {col.render ? col.render(item) : item[col.accessor]}
                                                    </td>
                                                ))}
                                                <td className="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                                                    <button onClick={() => setEditingItem({ ...item })} className="text-indigo-400 hover:text-indigo-300 mr-4">Edit</button>
                                                    <button onClick={() => handleDelete(item.id)} className="text-red-400 hover:text-red-300">Delete</button>
                                                </td>
                                            </>
                                        )}
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                </div>
            );
        }

        function SettingsPage({ db, auth }) {
            const { data: shops } = useCollection(db, 'shops');
            const shopFormFields = [
                { name: 'name', label: 'Shop Name', required: true },
                { name: 'latitude', label: 'Latitude', type: 'text' },
                { name: 'longitude', label: 'Longitude', type: 'text' },
                { name: 'radius', label: 'Radio Distance (m)', type: 'number' },
                { name: 'note', label: 'Note', type: 'text', fullWidth: true }
            ];
            const shopListColumns = [
                { header: 'Shop Name', accessor: 'name' },
                { header: 'Latitude', accessor: 'latitude' },
                { header: 'Longitude', accessor: 'longitude' },
                { header: 'Radius (m)', accessor: 'radius' },
                { header: 'Note', accessor: 'note' }
            ];

            return (
                 <SettingsCRUD 
                    db={db} auth={auth} title="Shop" collectionName="shops" 
                    items={shops} formFields={shopFormFields} listColumns={shopListColumns} 
                />
            );
        }

        // --- NEW PAGE COMPONENTS (UNDER CONSTRUCTION) ---
        const TabbedPage = ({ tabs, children }) => {
            const [activeTab, setActiveTab] = useState(Object.keys(tabs)[0]);
            
            const renderContent = () => {
                if(children) {
                    // Find the child that corresponds to the active tab
                    return React.Children.toArray(children).find(child => child.props.id === activeTab);
                }
                return <UnderConstructionPage title={tabs[activeTab]} />;
            };

            return (
                <div>
                    <Card className="mb-6">
                        <nav className="flex -mb-px px-6 border-b border-slate-700" aria-label="Tabs">
                            {Object.entries(tabs).map(([key, title]) => (
                                <a href="#" key={key} onClick={(e) => { e.preventDefault(); setActiveTab(key); }} className={`tab-link-dark whitespace-nowrap py-4 px-1 mr-8 border-b-2 text-sm font-medium ${activeTab === key ? 'active-tab-dark' : ''}`}>
                                    {title}
                                </a>
                            ))}
                        </nav>
                    </Card>
                    {renderContent()}
                </div>
            );
        };

        const CheckInMePage = () => <TabbedPage tabs={{ checkInOut: 'Check In/Out', leaveRequest: 'Leave Request' }} />;
        const PayrollPage = () => <TabbedPage tabs={{ calculator: 'Payroll Calculator', history: 'Payroll History' }} />;
        const EmployeesPage = () => <TabbedPage tabs={{ active: 'Active Employees', former: 'Resigned/Terminated', salaryReport: 'Salary Revise Report', employeeState: 'Employee State' }} />;
        const LoadManagerPage = () => <UnderConstructionPage title="Load Manager" />;
        const UserActivityPage = () => <UnderConstructionPage title="User Activity" />;

        // --- LAYOUT COMPONENTS ---
        const Sidebar = ({ activePage, setActivePage, isSidebarOpen, toggleSidebar }) => {
            const sidebarLinks = [
                { key: 'checkinme', icon: 'fa-user-clock', label: 'CheckInMe' },
                { key: 'payroll', icon: 'fa-money-check-dollar', label: 'Payroll' },
                { key: 'employees', icon: 'fa-users', label: 'Employees' },
                { key: 'loadManager', icon: 'fa-truck-loading', label: 'Load Manager' },
                { key: 'userActivity', icon: 'fa-chart-line', label: 'User Activity' },
                { key: 'settings', icon: 'fa-cog', label: 'Settings' },
            ];

            const handleLinkClick = (pageKey) => {
                setActivePage(pageKey);
                if (window.innerWidth < 768) toggleSidebar();
            };

            return (
                <aside className={`w-64 bg-slate-900 text-slate-300 p-4 flex flex-col transform ${isSidebarOpen ? 'translate-x-0' : '-translate-x-full'} md:translate-x-0 transition-transform duration-300 ease-in-out z-30 fixed md:relative h-full border-r border-slate-700`}>
                    <div className="flex items-center mb-10 px-2">
                        <i className="fas fa-building-user text-3xl text-blue-500 mr-3"></i>
                        <h1 className="text-2xl font-bold text-white">HR System</h1>
                    </div>
                    <nav className="flex-grow">
                        {sidebarLinks.map(link => (
                            <a href="#" key={link.key} onClick={() => handleLinkClick(link.key)} className={`flex items-center py-3 px-4 rounded-lg transition duration-200 mt-2 ${activePage === link.key ? 'bg-blue-600 text-white shadow-lg' : 'hover:bg-slate-700/50'}`}>
                                <i className={`fas ${link.icon} w-6 mr-4`}></i>
                                <span className="font-medium">{link.label}</span>
                            </a>
                        ))}
                    </nav>
                </aside>
            );
        };

        const Header = ({ pageTitle, toggleSidebar }) => (
            <header className="bg-slate-800/80 backdrop-blur-sm shadow-md p-4 flex justify-between items-center z-10 border-b border-slate-700">
                <div className="flex items-center">
                    <button onClick={toggleSidebar} className="text-slate-400 focus:outline-none md:hidden mr-4">
                        <i className="fas fa-bars text-2xl"></i>
                    </button>
                    <h2 className="text-2xl font-bold text-slate-100">{pageTitle}</h2>
                </div>
            </header>
        );

        // --- MAIN DASHBOARD COMPONENT ---
        const Dashboard = ({ db, auth }) => {
            const [isSidebarOpen, setSidebarOpen] = useState(false);
            const [activePage, setActivePage] = useState('checkinme');

            const toggleSidebar = () => setSidebarOpen(!isSidebarOpen);
            
            const pageTitles = {
                checkinme: 'CheckInMe',
                payroll: 'Payroll',
                employees: 'Employees',
                loadManager: 'Load Manager',
                userActivity: 'User Activity',
                settings: 'Settings',
            };

            const renderActivePage = () => {
                switch(activePage) {
                    case 'checkinme': return <CheckInMePage />;
                    case 'payroll': return <PayrollPage />;
                    case 'employees': return <EmployeesPage />;
                    case 'loadManager': return <LoadManagerPage />;
                    case 'userActivity': return <UserActivityPage />;
                    case 'settings': return <SettingsPage db={db} auth={auth} />;
                    default: return <UnderConstructionPage title="Page Not Found" />;
                }
            };

            return (
                <div className="flex h-screen bg-slate-900 text-slate-300">
                    <Sidebar activePage={activePage} setActivePage={setActivePage} isSidebarOpen={isSidebarOpen} toggleSidebar={toggleSidebar} />
                    {isSidebarOpen && <div onClick={toggleSidebar} className="fixed inset-0 bg-black opacity-50 z-20 md:hidden"></div>}
                    
                    <div className="flex-1 flex flex-col overflow-hidden">
                        <Header pageTitle={pageTitles[activePage] || 'Dashboard'} toggleSidebar={toggleSidebar} />
                        <main className="flex-1 overflow-x-hidden overflow-y-auto bg-slate-800 p-4 sm:p-6">
                            {renderActivePage()}
                        </main>
                    </div>
                </div>
            );
        };

        // --- ROOT APP COMPONENT ---
        function App() {
            const [db, setDb] = useState(null);
            const [auth, setAuth] = useState(null);
            const [loading, setLoading] = useState(true);

            useEffect(() => {
                try {
                    const { initializeApp, getFirestore, getAuth } = window.firebaseSDK;
                    const app = initializeApp(firebaseConfig);
                    setDb(getFirestore(app));
                    setAuth(getAuth(app));
                } catch (error) {
                    console.error("Firebase initialization error:", error);
                } finally {
                    setLoading(false);
                }
            }, []);

            if (loading) {
                return <div className="flex items-center justify-center h-screen">Loading...</div>;
            }
            
            return <Dashboard db={db} auth={auth} />;
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
