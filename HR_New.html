<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>HR Management System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" xintegrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        @import url('https://rsms.me/inter/inter.css');
        html, body { 
            font-family: 'Inter', sans-serif;
            overflow-x: hidden; /* Prevents horizontal scrolling */
        }
        /* Base input styles */
        .input, .select {
            margin-top: 0.25rem; display: block; width: 100%; padding: 0.5rem 0.75rem;
            border-width: 1px; border-color: #475569; border-radius: 0.375rem;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); line-height: 1.5;
            background-color: #334155; color: #f1f5f9;
        }
        .input:focus, .select:focus {
            outline: 2px solid transparent; outline-offset: 2px;
            --tw-ring-color: #2563eb; border-color: #2563eb;
        }
        .input[disabled] {
            background-color: #475569;
            cursor: not-allowed;
        }
    </style>
</head>
<body class="bg-slate-900 text-slate-300">
    <div id="root"></div>

    <script type="module">
        // Firebase SDK imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, doc, addDoc, updateDoc, deleteDoc, query, where, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Make Firebase SDK available globally
        window.firebaseSDK = {
            initializeApp, getAuth, getFirestore, collection, onSnapshot,
            doc, addDoc, updateDoc, deleteDoc, query, where, serverTimestamp,
            signInWithEmailAndPassword, onAuthStateChanged, signOut
        };
    </script>
    
    <script type="text/babel">
        const { useState, useEffect, useMemo, useCallback } = React;

        // --- FIREBASE CONFIGURATION ---
        const firebaseConfig = {
            apiKey: "AIzaSyB7_pnmwHj6aOeZRTykPvNusNFYReaTY6Q",
            authDomain: "hrsm-j.firebaseapp.com",
            projectId: "hrsm-j",
            storageBucket: "hrsm-j.appspot.com",
            messagingSenderId: "45063715478",
            appId: "1:45063715478:web:cc2dd21b83dd195771e0b7",
            measurementId: "G-8HQDG2LTKP"
        };
        
        // --- CUSTOM HOOK FOR DATA FETCHING ---
        const useCollection = (db, collectionName) => {
            const [data, setData] = useState([]);
            useEffect(() => {
                if (!db) return;
                const { collection, onSnapshot, query } = window.firebaseSDK;
                const q = query(collection(db, collectionName));
                const unsubscribe = onSnapshot(q, (querySnapshot) => {
                    const items = [];
                    querySnapshot.forEach((doc) => {
                        items.push({ id: doc.id, ...doc.data() });
                    });
                    setData(items);
                }, (error) => {
                    console.error(`Error fetching collection ${collectionName}:`, error);
                });
                return () => unsubscribe();
            }, [db, collectionName]);
            return { data };
        };
        
        // --- UTILITY FUNCTIONS ---
        const formatCurrency = (value, currency = 'USD') => {
            if (value === null || value === undefined) return '';
            const num = parseFloat(String(value).replace(/,/g, ''));
            if (isNaN(num)) return '';
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: currency,
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            }).format(num).replace(currency, '').trim();
        };

        const getDistance = (lat1, lon1, lat2, lon2) => {
            const R = 6371e3; // metres
            const φ1 = lat1 * Math.PI/180;
            const φ2 = lat2 * Math.PI/180;
            const Δφ = (lat2-lat1) * Math.PI/180;
            const Δλ = (lon2-lon1) * Math.PI/180;

            const a = Math.sin(Δφ/2) * Math.sin(Δφ/2) +
                        Math.cos(φ1) * Math.cos(φ2) *
                        Math.sin(Δλ/2) * Math.sin(Δλ/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));

            return R * c; // in metres
        };

        // --- REUSABLE UI & PAGE COMPONENTS ---
        const Card = ({ children, className = '' }) => (
            <div className={`bg-slate-800/50 p-4 sm:p-6 rounded-lg shadow-lg border border-slate-700 ${className}`}>
                {children}
            </div>
        );
        
        const CardTitle = ({ children }) => (
            <h2 className="text-2xl font-semibold text-slate-100 mb-4 pb-4 border-b border-slate-700">
                {children}
            </h2>
        );

        const UnderConstructionPage = ({ title }) => (
            <Card>
                <div className="text-center p-4 sm:p-8">
                    <i className="fas fa-tools text-5xl text-yellow-400 mb-6"></i>
                    <h3 className="text-2xl sm:text-3xl font-bold text-slate-100">{title}</h3>
                    <p className="text-slate-400 mt-2">This page is under construction.</p>
                </div>
            </Card>
        );

        const Modal = ({ isOpen, onClose, children }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 bg-black bg-opacity-70 z-50 flex justify-center items-start sm:items-center p-4 overflow-y-auto">
                    <div className="bg-slate-800 rounded-lg shadow-2xl w-full max-w-4xl flex flex-col border border-slate-600 my-auto">
                        {children}
                    </div>
                </div>
            );
        };

        const ModalHeader = ({ title, onClose }) => (
            <div className="p-5 border-b border-slate-700 flex justify-between items-center flex-shrink-0">
                <h3 className="text-xl font-semibold text-slate-100">{title}</h3>
                <button onClick={onClose} className="text-slate-400 hover:text-white text-2xl p-1">&times;</button>
            </div>
        );

        const ModalBody = ({ children }) => (
            <div className="p-6 flex-grow overflow-y-auto max-h-[calc(90vh-140px)]">
                {children}
            </div>
        );

        const ModalFooter = ({ children }) => (
            <div className="p-4 bg-slate-900/50 border-t border-slate-700 flex justify-end gap-4 rounded-b-lg flex-shrink-0">
                {children}
            </div>
        );

        // --- LOGIN PAGE COMPONENT ---
        const LoginPage = ({ auth }) => {
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [error, setError] = useState('');
            const [loading, setLoading] = useState(false);
            const [showPassword, setShowPassword] = useState(false);

            const handleLogin = async (e) => {
                e.preventDefault();
                setLoading(true);
                setError('');
                try {
                    const { signInWithEmailAndPassword } = window.firebaseSDK;
                    await signInWithEmailAndPassword(auth, email, password);
                } catch (err) {
                    setError('Failed to login. Please check your credentials.');
                    console.error(err);
                }
                setLoading(false);
            };

            return (
                <div className="flex items-center justify-center min-h-screen bg-slate-900">
                    <div className="w-full max-w-md p-8 space-y-8 bg-slate-800 rounded-2xl shadow-lg border border-slate-700">
                        <div className="text-center">
                             <i className="fas fa-building-user text-5xl text-blue-500"></i>
                            <h2 className="mt-6 text-3xl font-bold text-white">HR Management System</h2>
                            <p className="mt-2 text-sm text-slate-400">Sign in to your account</p>
                        </div>
                        <form className="mt-8 space-y-6" onSubmit={handleLogin}>
                            <div className="rounded-md shadow-sm -space-y-px">
                                <div><input id="email-address" name="email" type="email" autoComplete="email" required className="appearance-none rounded-none relative block w-full px-3 py-3 border border-slate-600 bg-slate-700 text-white placeholder-slate-400 rounded-t-md focus:outline-none focus:ring-blue-500 focus:border-blue-500 focus:z-10 sm:text-sm" placeholder="Email address" value={email} onChange={(e) => setEmail(e.target.value)} /></div>
                                <div className="relative"><input id="password" name="password" type={showPassword ? "text" : "password"} autoComplete="current-password" required className="appearance-none rounded-none relative block w-full px-3 py-3 border border-slate-600 bg-slate-700 text-white placeholder-slate-400 rounded-b-md focus:outline-none focus:ring-blue-500 focus:border-blue-500 focus:z-10 sm:text-sm" placeholder="Password" value={password} onChange={(e) => setPassword(e.target.value)} /><button type="button" onClick={() => setShowPassword(!showPassword)} className="absolute inset-y-0 right-0 pr-3 flex items-center text-sm leading-5"><i className={`fas ${showPassword ? 'fa-eye-slash' : 'fa-eye'} text-slate-400 hover:text-slate-200`}></i></button></div>
                            </div>
                            {error && <p className="text-red-500 text-sm text-center">{error}</p>}
                            <div><button type="submit" disabled={loading} className="group relative w-full flex justify-center py-3 px-4 border border-transparent text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 focus:ring-offset-slate-800 disabled:bg-blue-800 disabled:cursor-not-allowed">{loading ? <i className="fas fa-spinner fa-spin"></i> : 'Sign in'}</button></div>
                        </form>
                    </div>
                </div>
            );
        };

        // --- EMPLOYEE MANAGEMENT COMPONENTS ---
        const EmployeeModal = ({ isOpen, onClose, onSave, employee, db }) => {
            const [formData, setFormData] = useState({});
            const { data: shops } = useCollection(db, 'shops');
            const { data: positions } = useCollection(db, 'positions');
            const { data: employees } = useCollection(db, 'employees');
            
            const availablePages = [
                { key: 'employees', label: 'Employees' }, { key: 'checkinme', label: 'CheckInMe' },
                { key: 'attendanceReport', label: 'Attendance Report' }, { key: 'loanManager', label: 'Loan Manager' },
                { key: 'payroll', label: 'Payroll' }, { key: 'expenseReport', label: 'Expense Report' },
                { key: 'userActivity', label: 'User Activity' }, { key: 'settings', label: 'Settings' },
            ];

            useEffect(() => {
                const initialData = employee ? { ...employee, permissions: employee.permissions || [] } : {
                    name: '', sex: 'M', dob: '', nationId: '', tel: '', shop: '',
                    joinedDate: '', salary: '', position: '', shift: 'AM',
                    supervisor: '', status: 'Active', email: '', uid: '',
                    role: 'Staff', address: '', permissions: []
                };
                setFormData(initialData);
            }, [employee, isOpen]);

            const handleChange = (e) => {
                const { name, value, type, checked } = e.target;
                if (type === 'checkbox') {
                    setFormData(prev => {
                        const currentPermissions = prev.permissions || [];
                        if (checked) {
                            return { ...prev, permissions: [...currentPermissions, value] };
                        } else {
                            return { ...prev, permissions: currentPermissions.filter(p => p !== value) };
                        }
                    });
                } else {
                    setFormData(prev => ({ ...prev, [name]: value }));
                }
            };

            const handleSalaryChange = (e) => {
                const { value } = e.target;
                const sanitizedValue = value.replace(/[^0-9.]/g, '');
                setFormData(prev => ({ ...prev, salary: sanitizedValue }));
            };

            const handleSalaryBlur = (e) => {
                 setFormData(prev => ({ ...prev, salary: formatCurrency(e.target.value) }));
            };

            const handleSubmit = (e) => {
                e.preventDefault();
                onSave(formData);
            };

            return (
                <Modal isOpen={isOpen} onClose={onClose}>
                    <form onSubmit={handleSubmit}>
                        <ModalHeader title={employee ? 'Edit Employee' : 'Add New Employee'} onClose={onClose} />
                        <ModalBody>
                            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                <div><label className="text-sm font-medium text-slate-400">Name</label><input name="name" value={formData.name || ''} onChange={handleChange} className="input" required /></div>
                                <div><label className="text-sm font-medium text-slate-400">Sex</label><select name="sex" value={formData.sex || 'M'} onChange={handleChange} className="select"><option value="M">Male</option><option value="F">Female</option></select></div>
                                <div><label className="text-sm font-medium text-slate-400">Date of Birth</label><input type="date" name="dob" value={formData.dob || ''} onChange={handleChange} className="input" /></div>
                                <div><label className="text-sm font-medium text-slate-400">Nation ID</label><input name="nationId" value={formData.nationId || ''} onChange={handleChange} className="input" /></div>
                                <div><label className="text-sm font-medium text-slate-400">Tel No</label><input name="tel" value={formData.tel || ''} onChange={handleChange} className="input" /></div>
                                <div><label className="text-sm font-medium text-slate-400">Shop</label><select name="shop" value={formData.shop || ''} onChange={handleChange} className="select"><option value="">Select Shop</option>{shops.map(s => <option key={s.id} value={s.name}>{s.name}</option>)}</select></div>
                                <div><label className="text-sm font-medium text-slate-400">Joined Date</label><input type="date" name="joinedDate" value={formData.joinedDate || ''} onChange={handleChange} className="input" /></div>
                                <div><label className="text-sm font-medium text-slate-400">Salary</label><input name="salary" value={formData.salary || ''} onChange={handleSalaryChange} onBlur={handleSalaryBlur} className="input" /></div>
                                <div><label className="text-sm font-medium text-slate-400">Position</label><select name="position" value={formData.position || ''} onChange={handleChange} className="select"><option value="">Select Position</option>{positions.map(p => <option key={p.id} value={p.position}>{p.position}</option>)}</select></div>
                                <div><label className="text-sm font-medium text-slate-400">Shift</label><select name="shift" value={formData.shift || 'AM'} onChange={handleChange} className="select"><option>AM</option><option>PM</option><option>APM</option></select></div>
                                <div><label className="text-sm font-medium text-slate-400">Supervisor</label><select name="supervisor" value={formData.supervisor || ''} onChange={handleChange} className="select"><option value="">Select Supervisor</option>{employees.map(e => <option key={e.id} value={e.name}>{e.name}</option>)}</select></div>
                                <div><label className="text-sm font-medium text-slate-400">Staff Status</label><select name="status" value={formData.status || 'Active'} onChange={handleChange} className="select"><option>Active</option><option>Terminated</option><option>Resigned</option></select></div>
                                <div><label className="text-sm font-medium text-slate-400">Email</label><input type="email" name="email" value={formData.email || ''} onChange={handleChange} className="input" /></div>
                                <div><label className="text-sm font-medium text-slate-400">UID</label><input name="uid" value={formData.uid || ''} onChange={handleChange} className="input" /></div>
                                <div><label className="text-sm font-medium text-slate-400">Role</label><select name="role" value={formData.role || 'Staff'} onChange={handleChange} className="select"><option>Admin</option><option>Shop Manager</option><option>Staff</option></select></div>
                                <div className="md:col-span-2 lg:col-span-3"><label className="text-sm font-medium text-slate-400">Address</label><textarea name="address" value={formData.address || ''} onChange={handleChange} className="input" rows="3"></textarea></div>
                                <div className="md:col-span-2 lg:col-span-3">
                                    <label className="text-sm font-medium text-slate-400">Page Permissions</label>
                                    <div className="mt-2 grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4 p-4 border border-slate-600 rounded-lg bg-slate-700/50">
                                        {availablePages.map(page => (
                                            <div key={page.key} className="flex items-center">
                                                <input id={`perm-${page.key}`} type="checkbox" value={page.key} checked={formData.permissions?.includes(page.key)} onChange={handleChange} className="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500 bg-slate-600" />
                                                <label htmlFor={`perm-${page.key}`} className="ml-3 text-sm text-slate-300">{page.label}</label>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            </div>
                        </ModalBody>
                        <ModalFooter>
                            <button type="button" onClick={onClose} className="bg-slate-600 text-slate-200 px-4 py-2 rounded-lg hover:bg-slate-500 transition-colors">Cancel</button>
                            <button type="submit" className="bg-blue-600 text-white px-6 py-2 rounded-lg shadow hover:bg-blue-700 transition-colors">Save</button>
                        </ModalFooter>
                    </form>
                </Modal>
            );
        };

        const ActiveEmployeesTab = ({ db }) => {
            const [isModalOpen, setModalOpen] = useState(false);
            const [editingEmployee, setEditingEmployee] = useState(null);
            const { data: employees } = useCollection(db, 'employees');
            const handleOpenModal = (employee = null) => { setEditingEmployee(employee); setModalOpen(true); };
            const handleCloseModal = () => { setModalOpen(false); setEditingEmployee(null); };

            const handleSaveEmployee = async (employeeData) => {
                const { doc, updateDoc, addDoc, collection } = window.firebaseSDK;
                const salaryToSave = parseFloat(String(employeeData.salary).replace(/,/g, '')) || 0;
                const dataToSave = { ...employeeData, salary: salaryToSave };
                try {
                    if (dataToSave.id) {
                        const { id, ...data } = dataToSave;
                        await updateDoc(doc(db, 'employees', id), data);
                    } else {
                        await addDoc(collection(db, 'employees'), dataToSave);
                    }
                    handleCloseModal();
                } catch (e) { console.error("Error saving employee:", e); }
            };
            
            const handleDeleteEmployee = async (id) => {
                 if (window.confirm(`Are you sure you want to delete this employee?`)) {
                    try { await window.firebaseSDK.deleteDoc(window.firebaseSDK.doc(db, 'employees', id)); } 
                    catch (e) { console.error(`Error deleting employee:`, e); }
                }
            }

            return (
                <Card>
                    <div className="flex flex-wrap gap-4 justify-between items-center mb-6"><h3 className="text-xl font-semibold text-slate-100">Active Employee List</h3><button onClick={() => handleOpenModal()} className="bg-blue-600 text-white px-4 py-2 rounded-lg shadow hover:bg-blue-700 transition-colors flex items-center gap-2"><i className="fas fa-plus"></i> Add Employee</button></div>
                    <div className="overflow-x-auto"><table className="min-w-full divide-y divide-slate-700"><thead className="bg-slate-900/50"><tr><th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Name</th><th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase hidden md:table-cell">Position</th><th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase hidden lg:table-cell">Shop</th><th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Tel</th><th className="px-4 py-3 text-right text-xs font-semibold text-slate-400 uppercase hidden sm:table-cell">Salary</th><th className="px-4 py-3 text-center text-xs font-semibold text-slate-400 uppercase">Actions</th></tr></thead><tbody className="divide-y divide-slate-700">{employees.filter(e => e.status === 'Active').map(emp => (<tr key={emp.id} className="hover:bg-slate-700/50"><td className="px-4 py-4 text-sm text-slate-200 whitespace-nowrap">{emp.name}</td><td className="px-4 py-4 text-sm text-slate-300 hidden md:table-cell whitespace-nowrap">{emp.position}</td><td className="px-4 py-4 text-sm text-slate-300 hidden lg:table-cell whitespace-nowrap">{emp.shop}</td><td className="px-4 py-4 text-sm text-slate-300 whitespace-nowrap">{emp.tel}</td><td className="px-4 py-4 text-sm text-slate-300 text-right hidden sm:table-cell whitespace-nowrap">{formatCurrency(emp.salary)}</td><td className="px-4 py-4 text-center whitespace-nowrap"><button onClick={() => handleOpenModal(emp)} className="text-blue-400 hover:text-blue-300 mr-4"><i className="fas fa-edit"></i></button><button onClick={() => handleDeleteEmployee(emp.id)} className="text-red-500 hover:text-red-400"><i className="fas fa-trash"></i></button></td></tr>))}</tbody></table></div>
                    <EmployeeModal isOpen={isModalOpen} onClose={handleCloseModal} onSave={handleSaveEmployee} employee={editingEmployee} db={db} />
                </Card>
            );
        };
        
        const FormerEmployeesTab = ({ db }) => {
            const { data: employees } = useCollection(db, 'employees');
            const formerEmployees = employees.filter(e => e.status === 'Resigned' || e.status === 'Terminated');

            return (
                <Card>
                    <h3 className="text-xl font-semibold text-slate-100 mb-6">Resigned/Terminated Employees</h3>
                    <div className="overflow-x-auto">
                        <table className="min-w-full divide-y divide-slate-700">
                            <thead className="bg-slate-900/50">
                                <tr>
                                    <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Name</th>
                                    <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase hidden md:table-cell">Position</th>
                                    <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Status</th>
                                </tr>
                            </thead>
                            <tbody className="divide-y divide-slate-700">
                                {formerEmployees.map(emp => (
                                    <tr key={emp.id} className="hover:bg-slate-700/50">
                                        <td className="px-4 py-4 text-sm text-slate-200 whitespace-nowrap">{emp.name}</td>
                                        <td className="px-4 py-4 text-sm text-slate-300 hidden md:table-cell whitespace-nowrap">{emp.position}</td>
                                        <td className="px-4 py-4 text-sm text-slate-300 whitespace-nowrap">
                                            <span className={`px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${emp.status === 'Resigned' ? 'bg-yellow-100 text-yellow-800' : 'bg-red-100 text-red-800'}`}>
                                                {emp.status}
                                            </span>
                                        </td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                </Card>
            );
        };
        
        const SalaryReviseReportTab = ({ db }) => {
            const { data: shops } = useCollection(db, 'shops');
            const { data: employees } = useCollection(db, 'employees');
            const [selectedShop, setSelectedShop] = useState('');
            const [selectedEmployeeId, setSelectedEmployeeId] = useState('');
            const [reviseAmount, setReviseAmount] = useState('');
            const [message, setMessage] = useState('');

            const employeesInShop = useMemo(() => {
                if (!selectedShop) return [];
                return employees.filter(emp => emp.shop === selectedShop && emp.status === 'Active');
            }, [selectedShop, employees]);

            const selectedEmployee = useMemo(() => {
                if (!selectedEmployeeId) return null;
                return employees.find(emp => emp.id === selectedEmployeeId);
            }, [selectedEmployeeId, employees]);

            const baseSalary = selectedEmployee ? selectedEmployee.salary : 0;
            const updatedSalary = useMemo(() => {
                const base = parseFloat(baseSalary) || 0;
                const revise = parseFloat(reviseAmount) || 0;
                return base + revise;
            }, [baseSalary, reviseAmount]);

            const handleShopChange = (e) => {
                setSelectedShop(e.target.value);
                setSelectedEmployeeId('');
                setReviseAmount('');
            };

            const handleEmployeeChange = (e) => {
                setSelectedEmployeeId(e.target.value);
                setReviseAmount('');
            };

            const handleSubmit = async (e) => {
                e.preventDefault();
                if (!selectedEmployeeId || !reviseAmount) {
                    setMessage('Please select an employee and enter a revise amount.');
                    return;
                }
                
                try {
                    const { doc, updateDoc } = window.firebaseSDK;
                    const employeeRef = doc(db, 'employees', selectedEmployeeId);
                    await updateDoc(employeeRef, {
                        salary: updatedSalary
                    });
                    setMessage('Salary updated successfully!');
                    // Reset form
                    setSelectedShop('');
                    setSelectedEmployeeId('');
                    setReviseAmount('');
                    setTimeout(() => setMessage(''), 3000);
                } catch (error) {
                    console.error("Error updating salary: ", error);
                    setMessage('Failed to update salary.');
                }
            };

            return (
                <Card>
                    <CardTitle>Salary Revise Report</CardTitle>
                    <form onSubmit={handleSubmit} className="space-y-6">
                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                            <div><label className="text-sm font-medium text-slate-400">Date</label><input type="date" defaultValue={new Date().toISOString().substring(0, 10)} className="input" /></div>
                            <div><label className="text-sm font-medium text-slate-400">Shop Name</label><select value={selectedShop} onChange={handleShopChange} className="select"><option value="">Select Shop</option>{shops.map(s => <option key={s.id} value={s.name}>{s.name}</option>)}</select></div>
                            <div><label className="text-sm font-medium text-slate-400">Staff Name</label><select value={selectedEmployeeId} onChange={handleEmployeeChange} className="select" disabled={!selectedShop}><option value="">Select Staff</option>{employeesInShop.map(e => <option key={e.id} value={e.id}>{e.name}</option>)}</select></div>
                            <div><label className="text-sm font-medium text-slate-400">Base Salary</label><input value={formatCurrency(baseSalary)} className="input" disabled /></div>
                            <div><label className="text-sm font-medium text-slate-400">Amount Revise</label><input type="number" value={reviseAmount} onChange={(e) => setReviseAmount(e.target.value)} className="input" /></div>
                            <div><label className="text-sm font-medium text-slate-400">Updated Salary</label><input value={formatCurrency(updatedSalary)} className="input" disabled /></div>
                        </div>
                        <div className="flex justify-end items-center gap-4">
                            {message && <p className="text-sm text-green-400">{message}</p>}
                            <button type="submit" className="bg-blue-600 text-white px-6 py-2 rounded-lg shadow hover:bg-blue-700 transition-colors">Revise Salary</button>
                        </div>
                    </form>
                </Card>
            );
        };
        
        const EmployeeStateTab = ({ db }) => {
            const [isModalOpen, setModalOpen] = useState(false);
            const { data: employeeStates } = useCollection(db, 'employeeStates');
            const { data: shops } = useCollection(db, 'shops');
            const { data: employees } = useCollection(db, 'employees');
            const [selectedShop, setSelectedShop] = useState('');
            const [formData, setFormData] = useState({ date: new Date().toISOString().substring(0, 10), shop: '', staffId: '', statusState: 'Deduction', amount: '', note: '' });

            const employeesInShop = useMemo(() => {
                if (!selectedShop) return [];
                return employees.filter(emp => emp.shop === selectedShop && emp.status === 'Active');
            }, [selectedShop, employees]);
            
            const handleSave = async () => {
                if (!formData.shop || !formData.staffId || !formData.amount) {
                    alert("Please fill all required fields.");
                    return;
                }
                const { addDoc, collection } = window.firebaseSDK;
                try {
                    await addDoc(collection(db, 'employeeStates'), {
                        ...formData,
                        amount: parseFloat(formData.amount) || 0,
                        staffName: employees.find(e => e.id === formData.staffId)?.name || ''
                    });
                    setModalOpen(false);
                } catch (error) {
                    console.error("Error adding employee state:", error);
                }
            };

            return (
                <Card>
                    <div className="flex flex-wrap gap-4 justify-between items-center mb-6">
                        <h3 className="text-xl font-semibold text-slate-100">Employee State Records</h3>
                        <button onClick={() => setModalOpen(true)} className="bg-blue-600 text-white px-4 py-2 rounded-lg shadow hover:bg-blue-700 transition-colors flex items-center gap-2">
                            <i className="fas fa-plus"></i> Add New Record
                        </button>
                    </div>
                    <div className="overflow-x-auto">
                        <table className="min-w-full divide-y divide-slate-700">
                            <thead className="bg-slate-900/50">
                                <tr>
                                    <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Date</th>
                                    <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Staff Name</th>
                                    <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Status</th>
                                    <th className="px-4 py-3 text-right text-xs font-semibold text-slate-400 uppercase">Amount (KHR)</th>
                                </tr>
                            </thead>
                            <tbody className="divide-y divide-slate-700">
                                {employeeStates.map(record => (
                                    <tr key={record.id} className="hover:bg-slate-700/50">
                                        <td className="px-4 py-4 text-sm text-slate-200">{record.date}</td>
                                        <td className="px-4 py-4 text-sm text-slate-300">{record.staffName}</td>
                                        <td className="px-4 py-4 text-sm text-slate-300">{record.statusState}</td>
                                        <td className="px-4 py-4 text-sm text-slate-300 text-right">{formatCurrency(record.amount, 'KHR')}</td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                    
                    <Modal isOpen={isModalOpen} onClose={() => setModalOpen(false)}>
                        <ModalHeader title="Add New Employee State Record" onClose={() => setModalOpen(false)} />
                        <ModalBody>
                            <div className="space-y-4">
                                <div><label className="text-sm">Date</label><input type="date" value={formData.date} onChange={e => setFormData({...formData, date: e.target.value})} className="input"/></div>
                                <div><label className="text-sm">Shop</label><select value={selectedShop} onChange={e => { setSelectedShop(e.target.value); setFormData({...formData, shop: e.target.value, staffId: ''}); }} className="select"><option value="">Select Shop</option>{shops.map(s => <option key={s.id} value={s.name}>{s.name}</option>)}</select></div>
                                <div><label className="text-sm">Staff</label><select value={formData.staffId} onChange={e => setFormData({...formData, staffId: e.target.value})} className="select" disabled={!selectedShop}><option value="">Select Staff</option>{employeesInShop.map(e => <option key={e.id} value={e.id}>{e.name}</option>)}</select></div>
                                <div><label className="text-sm">Status State</label><select value={formData.statusState} onChange={e => setFormData({...formData, statusState: e.target.value})} className="select"><option>Deduction</option><option>Engagement</option></select></div>
                                <div><label className="text-sm">Amount (KHR)</label><input type="number" value={formData.amount} onChange={e => setFormData({...formData, amount: e.target.value})} className="input"/></div>
                                <div><label className="text-sm">Note</label><textarea value={formData.note} onChange={e => setFormData({...formData, note: e.target.value})} className="input" rows="3"></textarea></div>
                            </div>
                        </ModalBody>
                        <ModalFooter>
                            <button type="button" onClick={() => setModalOpen(false)} className="bg-slate-600 text-slate-200 px-4 py-2 rounded-lg hover:bg-slate-500">Cancel</button>
                            <button type="button" onClick={handleSave} className="bg-blue-600 text-white px-6 py-2 rounded-lg shadow hover:bg-blue-700">Save Record</button>
                        </ModalFooter>
                    </Modal>
                </Card>
            );
        };
        
        const LoanManagerPage = ({ db }) => {
            const [activeTab, setActiveTab] = useState('management');
            return (
                <TabbedPage tabs={{ management: 'Loan Management', history: 'Loan History' }}>
                    <div id="management"><LoanManagementTab db={db} /></div>
                    <div id="history"><LoanHistoryTab db={db} /></div>
                </TabbedPage>
            );
        };

        const LoanManagementTab = ({ db }) => {
            const [isModalOpen, setModalOpen] = useState(false);
            const { data: loans } = useCollection(db, 'staffLoans');
            const { data: shops } = useCollection(db, 'shops');
            const { data: employees } = useCollection(db, 'employees');
            const [selectedShop, setSelectedShop] = useState('');
            const [formData, setFormData] = useState({ loanDate: new Date().toISOString().substring(0, 10), shop: '', staffId: '', loanAmount: '', agreedMonthlyDeduction: '', reason: '' });

            const employeesInShop = useMemo(() => {
                if (!selectedShop) return [];
                return employees.filter(emp => emp.shop === selectedShop && emp.status === 'Active');
            }, [selectedShop, employees]);

            const handleSave = async () => {
                const { addDoc, collection } = window.firebaseSDK;
                try {
                    await addDoc(collection(db, 'staffLoans'), {
                        ...formData,
                        loanAmount: parseFloat(formData.loanAmount) || 0,
                        agreedMonthlyDeduction: parseFloat(formData.agreedMonthlyDeduction) || 0,
                        staffName: employees.find(e => e.id === formData.staffId)?.name || '',
                        totalPaid: 0,
                        status: 'Active'
                    });
                    setModalOpen(false);
                } catch (error) {
                    console.error("Error adding loan:", error);
                }
            };
            
            return (
                 <Card>
                    <div className="flex flex-wrap gap-4 justify-between items-center mb-6">
                        <h3 className="text-xl font-semibold text-slate-100">Loan Management</h3>
                        <button onClick={() => setModalOpen(true)} className="bg-blue-600 text-white px-4 py-2 rounded-lg shadow hover:bg-blue-700 transition-colors flex items-center gap-2">
                            <i className="fas fa-plus"></i> Add New Loan
                        </button>
                    </div>
                    <div className="overflow-x-auto">
                        <table className="min-w-full divide-y divide-slate-700">
                            <thead className="bg-slate-900/50">
                                <tr>
                                    <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Staff Name</th>
                                    <th className="px-4 py-3 text-right text-xs font-semibold text-slate-400 uppercase">Loan Amount</th>
                                    <th className="px-4 py-3 text-right text-xs font-semibold text-slate-400 uppercase">Total Paid</th>
                                    <th className="px-4 py-3 text-right text-xs font-semibold text-slate-400 uppercase">Balance</th>
                                    <th className="px-4 py-3 text-center text-xs font-semibold text-slate-400 uppercase">Status</th>
                                </tr>
                            </thead>
                            <tbody className="divide-y divide-slate-700">
                                {loans.map(loan => {
                                    const balance = loan.loanAmount - loan.totalPaid;
                                    return (
                                        <tr key={loan.id} className="hover:bg-slate-700/50">
                                            <td className="px-4 py-4 text-sm text-slate-200">{loan.staffName}</td>
                                            <td className="px-4 py-4 text-sm text-slate-300 text-right">{formatCurrency(loan.loanAmount)}</td>
                                            <td className="px-4 py-4 text-sm text-slate-300 text-right">{formatCurrency(loan.totalPaid)}</td>
                                            <td className="px-4 py-4 text-sm text-slate-300 text-right">{formatCurrency(balance)}</td>
                                            <td className="px-4 py-4 text-center text-sm">
                                                <span className={`px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${balance <= 0 ? 'bg-green-100 text-green-800' : 'bg-blue-100 text-blue-800'}`}>
                                                    {balance <= 0 ? 'Paid Off' : 'Active'}
                                                </span>
                                            </td>
                                        </tr>
                                    );
                                })}
                            </tbody>
                        </table>
                    </div>
                    <Modal isOpen={isModalOpen} onClose={() => setModalOpen(false)}>
                        <ModalHeader title="Add New Loan" onClose={() => setModalOpen(false)} />
                        <ModalBody>
                             <div className="space-y-4">
                                <div><label className="text-sm">Shop</label><select value={selectedShop} onChange={e => { setSelectedShop(e.target.value); setFormData({...formData, shop: e.target.value, staffId: ''}); }} className="select"><option value="">Select Shop</option>{shops.map(s => <option key={s.id} value={s.name}>{s.name}</option>)}</select></div>
                                <div><label className="text-sm">Staff</label><select value={formData.staffId} onChange={e => setFormData({...formData, staffId: e.target.value})} className="select" disabled={!selectedShop}><option value="">Select Staff</option>{employeesInShop.map(e => <option key={e.id} value={e.id}>{e.name}</option>)}</select></div>
                                <div><label className="text-sm">Loan Date</label><input type="date" value={formData.loanDate} onChange={e => setFormData({...formData, loanDate: e.target.value})} className="input"/></div>
                                <div><label className="text-sm">Loan Amount</label><input type="number" value={formData.loanAmount} onChange={e => setFormData({...formData, loanAmount: e.target.value})} className="input"/></div>
                                <div><label className="text-sm">Agreed Monthly Deduction</label><input type="number" value={formData.agreedMonthlyDeduction} onChange={e => setFormData({...formData, agreedMonthlyDeduction: e.target.value})} className="input"/></div>
                                <div><label className="text-sm">Reason</label><textarea value={formData.reason} onChange={e => setFormData({...formData, reason: e.target.value})} className="input" rows="3"></textarea></div>
                            </div>
                        </ModalBody>
                        <ModalFooter>
                            <button type="button" onClick={() => setModalOpen(false)} className="bg-slate-600 text-slate-200 px-4 py-2 rounded-lg hover:bg-slate-500">Cancel</button>
                            <button type="button" onClick={handleSave} className="bg-blue-600 text-white px-6 py-2 rounded-lg shadow hover:bg-blue-700">Save Loan</button>
                        </ModalFooter>
                    </Modal>
                </Card>
            );
        };
        
        const LoanHistoryTab = ({ db }) => {
            const { data: loanPayments } = useCollection(db, 'loanPayments'); // Assuming 'loanPayments' collection
            
            return (
                 <Card>
                    <h3 className="text-xl font-semibold text-slate-100 mb-6">Loan Payment History</h3>
                    <div className="overflow-x-auto">
                        <table className="min-w-full divide-y divide-slate-700">
                            <thead className="bg-slate-900/50">
                                <tr>
                                    <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Payment Date</th>
                                    <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Staff Name</th>
                                    <th className="px-4 py-3 text-right text-xs font-semibold text-slate-400 uppercase">Amount Paid</th>
                                    <th className="px-4 py-3 text-right text-xs font-semibold text-slate-400 uppercase">Remaining Balance</th>
                                    <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Note</th>
                                </tr>
                            </thead>
                            <tbody className="divide-y divide-slate-700">
                                {loanPayments.map(payment => (
                                    <tr key={payment.id} className="hover:bg-slate-700/50">
                                        <td className="px-4 py-4 text-sm text-slate-200">{payment.paymentDate}</td>
                                        <td className="px-4 py-4 text-sm text-slate-300">{payment.staffName}</td>
                                        <td className="px-4 py-4 text-sm text-slate-300 text-right">{formatCurrency(payment.amountPaid)}</td>
                                        <td className="px-4 py-4 text-sm text-slate-300 text-right">{formatCurrency(payment.remainingBalance)}</td>
                                        <td className="px-4 py-4 text-sm text-slate-300">{payment.note}</td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                </Card>
            );
        };


        // --- GENERIC SETTINGS & PAGE COMPONENTS ---
        function SettingsCRUD({ db, title, collectionName, items, formFields, listColumns }) {
            const [editingItem, setEditingItem] = useState(null);
            const [newItem, setNewItem] = useState({});
            const getInitialState = useCallback(() => formFields.reduce((acc, field) => ({...acc, [field.name]: '' }), {}), [formFields]);
            useEffect(() => { setNewItem(getInitialState()); }, [getInitialState]);

            const handleSave = async (item) => {
                const { doc, updateDoc, addDoc, collection } = window.firebaseSDK;
                try {
                    if (item.id) {
                        const { id, ...data } = item;
                        await updateDoc(doc(db, collectionName, id), data);
                    } else {
                        await addDoc(collection(db, collectionName), item);
                    }
                    setEditingItem(null);
                    setNewItem(getInitialState());
                } catch (e) { console.error(`Error saving ${collectionName}:`, e); }
            };
            
            const handleDelete = async (id) => {
                if (window.confirm(`Are you sure you want to delete this item?`)) {
                    try { await window.firebaseSDK.deleteDoc(window.firebaseSDK.doc(db, collectionName, id)); } 
                    catch (e) { console.error(`Error deleting ${collectionName}:`, e); }
                }
            };

            const renderForm = (item, setItem, isNew = false) => (
                 <form onSubmit={(e) => { e.preventDefault(); handleSave(item); }} className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-4 items-end p-4 bg-slate-800/50 rounded-lg mb-6 border border-slate-700">
                    {formFields.map(field => (<div key={field.name} className={field.fullWidth ? 'col-span-full' : 'sm:col-span-1'}><label className="block text-sm font-medium text-slate-400">{field.label}</label><input type={field.type || 'text'} name={field.name} value={item[field.name] || ''} onChange={(e) => setItem({...item, [field.name]: e.target.value})} className="input" required={field.required} /></div>))}
                    <div className="flex space-x-2 col-span-full md:col-span-1 self-end mt-4 md:mt-0"><button type="submit" className="w-full bg-blue-600 text-white px-4 py-2 rounded-lg shadow hover:bg-blue-700 transition-colors">{isNew ? `Add ${title}` : 'Save'}</button>{!isNew && <button type="button" onClick={() => setEditingItem(null)} className="w-full bg-slate-600 text-slate-200 px-4 py-2 rounded-lg hover:bg-slate-500">Cancel</button>}</div>
                </form>
            );

            return (
                <Card><CardTitle>{title} Management</CardTitle>{renderForm(newItem, setNewItem, true)}<div className="overflow-x-auto"><table className="min-w-full divide-y divide-slate-700"><thead className="bg-slate-900/50"><tr>{listColumns.map(col => <th key={col.accessor} className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">{col.header}</th>)}<th className="px-4 py-3 text-right text-xs font-semibold text-slate-400 uppercase">Actions</th></tr></thead><tbody className="divide-y divide-slate-700">{items.map(item => (<tr key={item.id} className="hover:bg-slate-700/50">{editingItem?.id === item.id ? (<td colSpan={listColumns.length + 1} className="p-0">{renderForm(editingItem, setEditingItem)}</td>) : (<>{listColumns.map(col => <td key={col.accessor} className="px-4 py-4 text-sm text-slate-300">{item[col.accessor]}</td>)}<td className="px-4 py-4 text-right text-sm"><button onClick={() => setEditingItem({ ...item })} className="text-blue-400 hover:text-blue-300 mr-3"><i className="fas fa-edit"></i></button><button onClick={() => handleDelete(item.id)} className="text-red-500 hover:text-red-400"><i className="fas fa-trash"></i></button></td></>)}</tr>))}</tbody></table></div></Card>
            );
        }
        
        const TabbedPage = ({ tabs, children }) => {
            const [activeTab, setActiveTab] = useState(Object.keys(tabs)[0]);
            const renderContent = () => children ? React.Children.toArray(children).find(child => child.props.id === activeTab) : <UnderConstructionPage title={tabs[activeTab]} />;
            return (
                <div><div className="mb-6 overflow-x-auto"><nav className="flex space-x-2 sm:space-x-4" aria-label="Tabs">{Object.entries(tabs).map(([key, title]) => (<a href="#" key={key} onClick={(e) => { e.preventDefault(); setActiveTab(key); }} className={`whitespace-nowrap rounded-md px-3 py-2 text-sm font-medium transition-colors ${activeTab === key ? 'bg-blue-600 text-white shadow' : 'text-slate-400 hover:bg-slate-700/50 hover:text-slate-200'}`}>{title}</a>))}</nav></div>{renderContent()}</div>
            );
        };
        
        function SettingsPage({ db }) {
            const { data: shops } = useCollection(db, 'shops');
            const { data: positions } = useCollection(db, 'positions');
            const shopFormFields = [{ name: 'name', label: 'Shop Name', required: true }, { name: 'latitude', label: 'Latitude' }, { name: 'longitude', label: 'Longitude' }, { name: 'radius', label: 'Radius (m)', type: 'number' }, { name: 'note', label: 'Note', fullWidth: true }];
            const shopListColumns = [{ header: 'Shop Name', accessor: 'name' }, { header: 'Latitude', accessor: 'latitude' }, { header: 'Longitude', accessor: 'longitude' }, { header: 'Radius (m)', accessor: 'radius' }, { header: 'Note', accessor: 'note' }];
            const positionFormFields = [{ name: 'position', label: 'Position', required: true }, { name: 'note', label: 'Note', fullWidth: true }];
            const positionListColumns = [{ header: 'Position', accessor: 'position' }, { header: 'Note', accessor: 'note' }];

            return (
                <TabbedPage tabs={{ shop: 'Shop Properties', position: 'Position Management' }}>
                    <div id="shop"><SettingsCRUD db={db} title="Shop" collectionName="shops" items={shops} formFields={shopFormFields} listColumns={shopListColumns} /></div>
                    <div id="position"><SettingsCRUD db={db} title="Position" collectionName="positions" items={positions} formFields={positionFormFields} listColumns={positionListColumns} /></div>
                </TabbedPage>
            );
        }
        
        const EmployeesPage = ({ db }) => (
            <TabbedPage tabs={{ active: 'Active Employees', former: 'Resigned/Terminated', salaryReport: 'Salary Revise Report', employeeState: 'Employee State' }}>
                <div id="active"><ActiveEmployeesTab db={db} /></div>
                <div id="former"><FormerEmployeesTab db={db} /></div>
                <div id="salaryReport"><SalaryReviseReportTab db={db} /></div>
                <div id="employeeState"><EmployeeStateTab db={db} /></div>
            </TabbedPage>
        );
        const CheckInMePage = ({ db, userProfile }) => (
            <TabbedPage tabs={{ checkInOut: 'Check In/Out', leaveRequest: 'Leave Request' }}>
                <div id="checkInOut"><CheckInOutTab db={db} userProfile={userProfile} /></div>
                <div id="leaveRequest"><UnderConstructionPage title="Leave Request" /></div>
            </TabbedPage>
        );
        const AttendanceReportPage = () => <UnderConstructionPage title="Attendance Report" />;
        const PayrollPage = () => <TabbedPage tabs={{ calculator: 'Payroll Calculator', history: 'Payroll History' }} />;
        const ExpenseReportPage = () => <UnderConstructionPage title="Expense Report" />;
        const UserActivityPage = () => <UnderConstructionPage title="User Activity" />;

        // --- LAYOUT COMPONENTS ---
        const Sidebar = ({ activePage, setActivePage, isSidebarOpen, toggleSidebar }) => {
            const sidebarLinks = [ { key: 'employees', icon: 'fa-users', label: 'Employees' }, { key: 'checkinme', icon: 'fa-user-clock', label: 'CheckInMe' }, { key: 'attendanceReport', icon: 'fa-file-alt', label: 'Attendance Report' }, { key: 'loanManager', icon: 'fa-hand-holding-usd', label: 'Loan Manager' }, { key: 'payroll', icon: 'fa-money-check-dollar', label: 'Payroll' }, { key: 'expenseReport', icon: 'fa-file-invoice-dollar', label: 'Expense Report' }, { key: 'userActivity', icon: 'fa-chart-line', label: 'User Activity' }, { key: 'settings', icon: 'fa-cog', label: 'Settings' }, ];
            const handleLinkClick = (pageKey) => { setActivePage(pageKey); if (window.innerWidth < 768) toggleSidebar(); };
            return (<aside className={`w-64 bg-slate-900 text-slate-300 p-4 flex flex-col transform ${isSidebarOpen ? 'translate-x-0' : '-translate-x-full'} md:translate-x-0 transition-transform duration-300 ease-in-out z-40 fixed md:relative h-full border-r border-slate-700`}><div className="flex items-center mb-10 px-2"><i className="fas fa-building-user text-3xl text-blue-500 mr-3"></i><h1 className="text-2xl font-bold text-white">HR System</h1></div><nav className="flex-grow">{sidebarLinks.map(link => (<a href="#" key={link.key} onClick={() => handleLinkClick(link.key)} className={`flex items-center py-3 px-4 rounded-lg transition duration-200 mt-2 ${activePage === link.key ? 'bg-blue-600 text-white shadow-lg' : 'hover:bg-slate-700/50'}`}><i className={`fas ${link.icon} w-6 mr-4`}></i><span className="font-medium">{link.label}</span></a>))}</nav></aside>);
        };
        const Header = ({ pageTitle, toggleSidebar, auth, userProfile }) => {
            const handleLogout = async () => {
                try {
                    await window.firebaseSDK.signOut(auth);
                } catch (error) {
                    console.error("Error signing out: ", error);
                }
            };
            return (
                <header className="bg-slate-800/80 backdrop-blur-sm shadow-md p-4 flex justify-between items-center z-30 border-b border-slate-700 sticky top-0">
                    <div className="flex items-center">
                        <button onClick={toggleSidebar} className="text-slate-400 focus:outline-none md:hidden mr-4"><i className="fas fa-bars text-2xl"></i></button>
                        <h2 className="text-xl sm:text-2xl font-bold text-slate-100">{pageTitle}</h2>
                    </div>
                    <div className="flex items-center gap-4">
                        {userProfile && (
                            <div className="text-right hidden sm:block">
                                <span className="text-sm text-slate-400">Welcome, </span>
                                <span className="font-medium text-slate-200">{userProfile.name}</span>
                            </div>
                        )}
                        <button onClick={handleLogout} title="Logout" className="bg-slate-700 text-slate-300 w-10 h-10 rounded-full hover:bg-slate-600 hover:text-white transition duration-150 flex items-center justify-center flex-shrink-0">
                            <i className="fas fa-sign-out-alt"></i>
                        </button>
                    </div>
                </header>
            );
        };
        
        // --- MAIN DASHBOARD COMPONENT ---
        const Dashboard = ({ db, auth, user, userProfile }) => {
            const [isSidebarOpen, setSidebarOpen] = useState(false);
            const [activePage, setActivePage] = useState('employees');
            const toggleSidebar = () => setSidebarOpen(!isSidebarOpen);
            const pageTitles = { employees: 'Employees', checkinme: 'CheckInMe', attendanceReport: 'Attendance Report', loanManager: 'Loan Manager', payroll: 'Payroll', expenseReport: 'Expense Report', userActivity: 'User Activity', settings: 'Settings' };
            const renderActivePage = () => {
                switch(activePage) {
                    case 'employees': return <EmployeesPage db={db} />;
                    case 'checkinme': return <CheckInMePage db={db} userProfile={userProfile} />;
                    case 'attendanceReport': return <AttendanceReportPage />;
                    case 'loanManager': return <LoanManagerPage db={db} />;
                    case 'payroll': return <PayrollPage />;
                    case 'expenseReport': return <ExpenseReportPage />;
                    case 'userActivity': return <UserActivityPage />;
                    case 'settings': return <SettingsPage db={db} />;
                    default: return <UnderConstructionPage title="Page Not Found" />;
                }
            };
            return (<div className="flex h-screen bg-slate-900 text-slate-300"><Sidebar activePage={activePage} setActivePage={setActivePage} isSidebarOpen={isSidebarOpen} toggleSidebar={toggleSidebar} /><div className="flex-1 flex flex-col overflow-hidden"><Header pageTitle={pageTitles[activePage] || 'Dashboard'} toggleSidebar={toggleSidebar} auth={auth} userProfile={userProfile} /><main className="flex-1 overflow-x-hidden overflow-y-auto bg-slate-800 p-4 sm:p-6">{renderActivePage()}</main></div></div>);
        };

        // --- ROOT APP COMPONENT ---
        function App() {
            const [db, setDb] = useState(null);
            const [auth, setAuth] = useState(null);
            const [currentUser, setCurrentUser] = useState(null);
            const [userProfile, setUserProfile] = useState(null);
            const [loading, setLoading] = useState(true);

            useEffect(() => {
                try {
                    const { initializeApp, getFirestore, getAuth, onAuthStateChanged } = window.firebaseSDK;
                    const app = initializeApp(firebaseConfig);
                    const authInstance = getAuth(app);
                    const dbInstance = getFirestore(app);
                    setAuth(authInstance);
                    setDb(dbInstance);

                    const unsubscribe = onAuthStateChanged(authInstance, (user) => {
                        setCurrentUser(user);
                        if (!user) {
                            setLoading(false);
                        }
                    });
                    return () => unsubscribe();
                } catch (error) { 
                    console.error("Firebase initialization error:", error); 
                    setLoading(false);
                } 
            }, []);

            useEffect(() => {
                if (!db || !currentUser) {
                    setUserProfile(null);
                    return;
                };

                const { collection, query, where, onSnapshot } = window.firebaseSDK;
                const q = query(collection(db, "employees"), where("uid", "==", currentUser.uid));
                
                const unsubscribe = onSnapshot(q, (snapshot) => {
                    if (!snapshot.empty) {
                        const userDoc = snapshot.docs[0];
                        setUserProfile({ id: userDoc.id, ...userDoc.data() });
                    } else {
                        // If no profile, use email as name, but don't grant permissions
                        setUserProfile({ name: currentUser.email, permissions: [] });
                    }
                    setLoading(false);
                }, (error) => {
                    console.error("Error fetching user profile:", error);
                    setLoading(false);
                });

                return () => unsubscribe();
            }, [db, currentUser]);

            if (loading) { return <div className="flex items-center justify-center h-screen text-lg text-slate-300">Loading Application...</div>; }
            
            if (!currentUser) {
                return <LoginPage auth={auth} />;
            }

            return <Dashboard db={db} auth={auth} user={currentUser} userProfile={userProfile} />;
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
