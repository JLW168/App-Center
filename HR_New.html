<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>HR Management System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" xintegrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        @import url('https://rsms.me/inter/inter.css');
        html, body { 
            font-family: 'Inter', sans-serif;
            overflow-x: hidden; /* Prevents horizontal scrolling */
        }
        /* Base input styles */
        .input, .select {
            margin-top: 0.25rem; display: block; width: 100%; padding: 0.5rem 0.75rem;
            border-width: 1px; border-color: #475569; border-radius: 0.375rem;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); line-height: 1.5;
            background-color: #334155; color: #f1f5f9;
        }
        .input:focus, .select:focus {
            outline: 2px solid transparent; outline-offset: 2px;
            --tw-ring-color: #2563eb; border-color: #2563eb;
        }
        .input[disabled] {
            background-color: #475569;
            cursor: not-allowed;
        }
    </style>
</head>
<body class="bg-slate-900 text-slate-300">
    <div id="root"></div>

    <script type="module">
        // Firebase SDK imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, doc, addDoc, updateDoc, deleteDoc, query, where, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Make Firebase SDK available globally
        window.firebaseSDK = {
            initializeApp, getAuth, getFirestore, collection, onSnapshot,
            doc, addDoc, updateDoc, deleteDoc, query, where, serverTimestamp,
            signInWithEmailAndPassword, onAuthStateChanged, signOut
        };
    </script>
    
    <script type="text/babel">
        const { useState, useEffect, useMemo, useCallback } = React;

        // --- FIREBASE CONFIGURATION ---
        const firebaseConfig = {
            apiKey: "AIzaSyB7_pnmwHj6aOeZRTykPvNusNFYReaTY6Q",
            authDomain: "hrsm-j.firebaseapp.com",
            projectId: "hrsm-j",
            storageBucket: "hrsm-j.appspot.com",
            messagingSenderId: "45063715478",
            appId: "1:45063715478:web:cc2dd21b83dd195771e0b7",
            measurementId: "G-8HQDG2LTKP"
        };
        
        // --- CUSTOM HOOK FOR DATA FETCHING ---
        const useCollection = (db, collectionName, queryConstraints = []) => {
            const [data, setData] = useState([]);
            useEffect(() => {
                if (!db) return;
                const { collection, onSnapshot, query } = window.firebaseSDK;
                const q = query(collection(db, collectionName), ...queryConstraints);
                const unsubscribe = onSnapshot(q, (querySnapshot) => {
                    const items = [];
                    querySnapshot.forEach((doc) => {
                        items.push({ id: doc.id, ...doc.data() });
                    });
                    setData(items);
                }, (error) => {
                    console.error(`Error fetching collection ${collectionName}:`, error);
                });
                return () => unsubscribe();
            }, [db, collectionName, JSON.stringify(queryConstraints)]); // Stringify constraints for dependency array
            return { data };
        };
        
        // --- UTILITY FUNCTIONS ---
        const formatCurrency = (value, currency = 'KHR') => {
            if (value === null || value === undefined) return '';
            const num = parseFloat(String(value).replace(/[^0-9.-]/g, ''));
            if (isNaN(num)) return '';
            
            const options = {
                style: 'currency',
                currency: currency,
                minimumFractionDigits: currency === 'KHR' ? 0 : 2,
                maximumFractionDigits: currency === 'KHR' ? 0 : 2,
            };
            
            const locale = currency === 'KHR' ? 'km-KH' : 'en-US';

            let formatted = new Intl.NumberFormat(locale, options).format(num);
            if (currency === 'KHR') {
                formatted = formatted.replace('KHR', '៛').trim();
            }
            return formatted;
        };
        
        const formatRequestDate = (timestamp) => {
            if (!timestamp || !timestamp.toDate) return 'N/A';
            const date = timestamp.toDate();
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const year = String(date.getFullYear()).slice(-2);
            const formattedDate = `${day}-${month}-${year}`;
            const formattedTime = date.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: true });
            return `${formattedDate} | ${formattedTime}`;
        };

        const calculateWorkedDuration = (joinedDate) => {
            if (!joinedDate) return 'N/A';
            const start = new Date(joinedDate);
            const now = new Date();

            if (isNaN(start.getTime())) return 'N/A';

            let years = now.getFullYear() - start.getFullYear();
            let months = now.getMonth() - start.getMonth();
            let days = now.getDate() - start.getDate();

            if (days < 0) {
                months--;
                days += new Date(now.getFullYear(), now.getMonth(), 0).getDate();
            }

            if (months < 0) {
                years--;
                months += 12;
            }

            const parts = [];
            if (years > 0) parts.push(`${years}y`);
            if (months > 0) parts.push(`${months}m`);
            if (days > 0 && years === 0 && months === 0) parts.push(`${days}d`);

            return parts.length > 0 ? parts.join(', ') : '0d';
        };

        const getDistance = (lat1, lon1, lat2, lon2) => {
            const R = 6371e3; // metres
            const φ1 = lat1 * Math.PI/180;
            const φ2 = lat2 * Math.PI/180;
            const Δφ = (lat2-lat1) * Math.PI/180;
            const Δλ = (lon2-lon1) * Math.PI/180;

            const a = Math.sin(Δφ/2) * Math.sin(Δφ/2) +
                        Math.cos(φ1) * Math.cos(φ2) *
                        Math.sin(Δλ/2) * Math.sin(Δλ/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));

            return R * c; // in metres
        };

        // --- REUSABLE UI & PAGE COMPONENTS ---
        const Card = ({ children, className = '' }) => (
            <div className={`bg-slate-800/50 p-4 sm:p-6 rounded-lg shadow-lg border border-slate-700 ${className}`}>
                {children}
            </div>
        );
        
        const CardTitle = ({ children }) => (
            <h2 className="text-2xl font-semibold text-slate-100 mb-4 pb-4 border-b border-slate-700">
                {children}
            </h2>
        );

        const UnderConstructionPage = ({ title }) => (
            <Card>
                <div className="text-center p-4 sm:p-8">
                    <i className="fas fa-tools text-5xl text-yellow-400 mb-6"></i>
                    <h3 className="text-2xl sm:text-3xl font-bold text-slate-100">{title}</h3>
                    <p className="text-slate-400 mt-2">This page is under construction.</p>
                </div>
            </Card>
        );

        const Modal = ({ isOpen, onClose, children, maxWidth = "max-w-4xl" }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 bg-black bg-opacity-70 z-50 flex justify-center items-start sm:items-center p-4 overflow-y-auto">
                    <div className={`bg-slate-800 rounded-lg shadow-2xl w-full ${maxWidth} flex flex-col border border-slate-600 my-auto`}>
                        {children}
                    </div>
                </div>
            );
        };

        const ModalHeader = ({ title, onClose }) => (
            <div className="p-5 border-b border-slate-700 flex justify-between items-center flex-shrink-0">
                <h3 className="text-xl font-semibold text-slate-100">{title}</h3>
                <button onClick={onClose} className="text-slate-400 hover:text-white text-2xl p-1">&times;</button>
            </div>
        );

        const ModalBody = ({ children }) => (
            <div className="p-6 flex-grow overflow-y-auto max-h-[calc(90vh-140px)]">
                {children}
            </div>
        );

        const ModalFooter = ({ children }) => (
            <div className="p-4 bg-slate-900/50 border-t border-slate-700 flex justify-end gap-4 rounded-b-lg flex-shrink-0">
                {children}
            </div>
        );
        
        const ConfirmationModal = ({ isOpen, onClose, onConfirm, title, message }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 bg-black bg-opacity-70 z-50 flex justify-center items-center p-4">
                    <div className="bg-slate-800 rounded-lg shadow-2xl w-full max-w-sm border border-slate-600">
                        <div className="p-6">
                            <h3 className="text-lg font-bold text-slate-100">{title}</h3>
                            <p className="mt-2 text-sm text-slate-400">{message}</p>
                        </div>
                        <div className="p-4 bg-slate-900/50 border-t border-slate-700 flex justify-end gap-4 rounded-b-lg">
                            <button onClick={onClose} className="bg-slate-600 text-slate-200 px-4 py-2 rounded-lg hover:bg-slate-500">Cancel</button>
                            <button onClick={onConfirm} className="bg-red-600 text-white px-4 py-2 rounded-lg shadow hover:bg-red-700">Confirm</button>
                        </div>
                    </div>
                </div>
            );
        };

        // --- LOGIN PAGE COMPONENT ---
        const LoginPage = ({ auth }) => {
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [error, setError] = useState('');
            const [loading, setLoading] = useState(false);
            const [showPassword, setShowPassword] = useState(false);

            const handleLogin = async (e) => {
                e.preventDefault();
                setLoading(true);
                setError('');
                try {
                    const { signInWithEmailAndPassword } = window.firebaseSDK;
                    await signInWithEmailAndPassword(auth, email, password);
                } catch (err) {
                    setError('Failed to login. Please check your credentials.');
                    console.error(err);
                }
                setLoading(false);
            };

            return (
                <div className="flex items-center justify-center min-h-screen bg-slate-900">
                    <div className="w-full max-w-md p-8 space-y-8 bg-slate-800 rounded-2xl shadow-lg border border-slate-700">
                        <div className="text-center">
                             <i className="fas fa-building-user text-5xl text-blue-500"></i>
                            <h2 className="mt-6 text-3xl font-bold text-white">HR Management System</h2>
                            <p className="mt-2 text-sm text-slate-400">Sign in to your account</p>
                        </div>
                        <form className="mt-8 space-y-6" onSubmit={handleLogin}>
                            <div className="rounded-md shadow-sm -space-y-px">
                                <div><input id="email-address" name="email" type="email" autoComplete="email" required className="appearance-none rounded-none relative block w-full px-3 py-3 border border-slate-600 bg-slate-700 text-white placeholder-slate-400 rounded-t-md focus:outline-none focus:ring-blue-500 focus:border-blue-500 focus:z-10 sm:text-sm" placeholder="Email address" value={email} onChange={(e) => setEmail(e.target.value)} /></div>
                                <div className="relative"><input id="password" name="password" type={showPassword ? "text" : "password"} autoComplete="current-password" required className="appearance-none rounded-none relative block w-full px-3 py-3 border border-slate-600 bg-slate-700 text-white placeholder-slate-400 rounded-b-md focus:outline-none focus:ring-blue-500 focus:border-blue-500 focus:z-10 sm:text-sm" placeholder="Password" value={password} onChange={(e) => setPassword(e.target.value)} /><button type="button" onClick={() => setShowPassword(!showPassword)} className="absolute inset-y-0 right-0 pr-3 flex items-center text-sm leading-5"><i className={`fas ${showPassword ? 'fa-eye-slash' : 'fa-eye'} text-slate-400 hover:text-slate-200`}></i></button></div>
                            </div>
                            {error && <p className="text-red-500 text-sm text-center">{error}</p>}
                            <div><button type="submit" disabled={loading} className="group relative w-full flex justify-center py-3 px-4 border border-transparent text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 focus:ring-offset-slate-800 disabled:bg-blue-800 disabled:cursor-not-allowed">{loading ? <i className="fas fa-spinner fa-spin"></i> : 'Sign in'}</button></div>
                        </form>
                    </div>
                </div>
            );
        };

        // --- EMPLOYEE MANAGEMENT COMPONENTS ---
        const EmployeeModal = ({ isOpen, onClose, onSave, employee, db, auth }) => {
            const [formData, setFormData] = useState({});
            const { data: shops } = useCollection(db, 'shops');
            const { data: positions } = useCollection(db, 'positions');
            const { data: employees } = useCollection(db, 'employees');
            
            const availablePages = [
                { key: 'employees', label: 'Employees' }, { key: 'checkinme', label: 'CheckInMe' },
                { key: 'attendanceReport', label: 'Attendance Report' }, { key: 'loanManager', label: 'Loan Manager' },
                { key: 'payroll', label: 'Payroll' }, { key: 'expenseReport', label: 'Expense Report' },
                { key: 'userActivity', label: 'User Activity' }, { key: 'settings', label: 'Settings' },
            ];

            useEffect(() => {
                const initialData = employee ? { ...employee, permissions: employee.permissions || [] } : {
                    name: '', sex: 'M', dob: '', nationId: '', tel: '', shop: '',
                    joinedDate: '', salary: '', position: '', shift: 'AM',
                    supervisor: '', status: 'Active', email: '', uid: '',
                    role: 'Staff', address: '', permissions: []
                };
                setFormData(initialData);
            }, [employee, isOpen]);

            const handleChange = (e) => {
                const { name, value, type, checked } = e.target;
                if (type === 'checkbox') {
                    setFormData(prev => {
                        const currentPermissions = prev.permissions || [];
                        if (checked) {
                            return { ...prev, permissions: [...currentPermissions, value] };
                        } else {
                            return { ...prev, permissions: currentPermissions.filter(p => p !== value) };
                        }
                    });
                } else {
                    setFormData(prev => ({ ...prev, [name]: value }));
                }
            };

            const handleSalaryChange = (e) => {
                const { value } = e.target;
                const sanitizedValue = value.replace(/[^0-9.]/g, '');
                setFormData(prev => ({ ...prev, salary: sanitizedValue }));
            };

            const handleSalaryBlur = (e) => {
                 setFormData(prev => ({ ...prev, salary: formatCurrency(e.target.value) }));
            };

            const handleSubmit = (e) => {
                e.preventDefault();
                onSave(formData);
            };

            return (
                <Modal isOpen={isOpen} onClose={onClose}>
                    <form onSubmit={handleSubmit}>
                        <ModalHeader title={employee ? 'Edit Employee' : 'Add New Employee'} onClose={onClose} />
                        <ModalBody>
                            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                <div><label className="text-sm font-medium text-slate-400">Name</label><input name="name" value={formData.name || ''} onChange={handleChange} className="input" required /></div>
                                <div><label className="text-sm font-medium text-slate-400">Sex</label><select name="sex" value={formData.sex || 'M'} onChange={handleChange} className="select"><option value="M">Male</option><option value="F">Female</option></select></div>
                                <div><label className="text-sm font-medium text-slate-400">Date of Birth</label><input type="date" name="dob" value={formData.dob || ''} onChange={handleChange} className="input" /></div>
                                <div><label className="text-sm font-medium text-slate-400">Nation ID</label><input name="nationId" value={formData.nationId || ''} onChange={handleChange} className="input" /></div>
                                <div><label className="text-sm font-medium text-slate-400">Tel No</label><input name="tel" value={formData.tel || ''} onChange={handleChange} className="input" /></div>
                                <div><label className="text-sm font-medium text-slate-400">Shop</label><select name="shop" value={formData.shop || ''} onChange={handleChange} className="select"><option value="">Select Shop</option>{shops.map(s => <option key={s.id} value={s.name}>{s.name}</option>)}</select></div>
                                <div><label className="text-sm font-medium text-slate-400">Joined Date</label><input type="date" name="joinedDate" value={formData.joinedDate || ''} onChange={handleChange} className="input" /></div>
                                <div><label className="text-sm font-medium text-slate-400">Salary</label><input name="salary" value={formData.salary || ''} onChange={handleSalaryChange} onBlur={handleSalaryBlur} className="input" /></div>
                                <div><label className="text-sm font-medium text-slate-400">Position</label><select name="position" value={formData.position || ''} onChange={handleChange} className="select"><option value="">Select Position</option>{positions.map(p => <option key={p.id} value={p.position}>{p.position}</option>)}</select></div>
                                <div><label className="text-sm font-medium text-slate-400">Shift</label><select name="shift" value={formData.shift || 'AM'} onChange={handleChange} className="select"><option>AM</option><option>PM</option><option>APM</option></select></div>
                                <div><label className="text-sm font-medium text-slate-400">Supervisor</label><select name="supervisor" value={formData.supervisor || ''} onChange={handleChange} className="select"><option value="">Select Supervisor</option>{employees.map(e => <option key={e.id} value={e.name}>{e.name}</option>)}</select></div>
                                <div><label className="text-sm font-medium text-slate-400">Staff Status</label><select name="status" value={formData.status || 'Active'} onChange={handleChange} className="select"><option>Active</option><option>Terminated</option><option>Resigned</option></select></div>
                                <div><label className="text-sm font-medium text-slate-400">Email</label><input type="email" name="email" value={formData.email || ''} onChange={handleChange} className="input" /></div>
                                <div><label className="text-sm font-medium text-slate-400">UID</label><input name="uid" value={formData.uid || ''} onChange={handleChange} className="input" /></div>
                                <div><label className="text-sm font-medium text-slate-400">Role</label><select name="role" value={formData.role || 'Staff'} onChange={handleChange} className="select"><option>Admin</option><option>Shop Manager</option><option>Staff</option></select></div>
                                <div className="md:col-span-2 lg:col-span-3"><label className="text-sm font-medium text-slate-400">Address</label><textarea name="address" value={formData.address || ''} onChange={handleChange} className="input" rows="3"></textarea></div>
                                <div className="md:col-span-2 lg:col-span-3">
                                    <label className="text-sm font-medium text-slate-400">Page Permissions</label>
                                    <div className="mt-2 grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4 p-4 border border-slate-600 rounded-lg bg-slate-700/50">
                                        {availablePages.map(page => (
                                            <div key={page.key} className="flex items-center">
                                                <input id={`perm-${page.key}`} type="checkbox" value={page.key} checked={formData.permissions?.includes(page.key)} onChange={handleChange} className="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500 bg-slate-600" />
                                                <label htmlFor={`perm-${page.key}`} className="ml-3 text-sm text-slate-300">{page.label}</label>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            </div>
                        </ModalBody>
                        <ModalFooter>
                            <button type="button" onClick={onClose} className="bg-slate-600 text-slate-200 px-4 py-2 rounded-lg hover:bg-slate-500 transition-colors">Cancel</button>
                            <button type="submit" className="bg-blue-600 text-white px-6 py-2 rounded-lg shadow hover:bg-blue-700 transition-colors">Save</button>
                        </ModalFooter>
                    </form>
                </Modal>
            );
        };

        const ActiveEmployeesTab = ({ db, auth, userProfile }) => {
            const [isModalOpen, setModalOpen] = useState(false);
            const [editingEmployee, setEditingEmployee] = useState(null);
            const { where } = window.firebaseSDK;

            const queryConstraints = useMemo(() => {
                if (userProfile?.role === 'Admin') return [];
                if (userProfile?.shop) {
                    return [where("shop", "==", userProfile.shop)];
                }
                return [where("uid", "==", auth.currentUser.uid)];
            }, [userProfile, auth.currentUser.uid]);

            const { data: employees } = useCollection(db, 'employees', queryConstraints);

            const handleOpenModal = (employee = null) => { setEditingEmployee(employee); setModalOpen(true); };
            const handleCloseModal = () => { setModalOpen(false); setEditingEmployee(null); };

            const handleSaveEmployee = async (employeeData) => {
                const { doc, updateDoc, addDoc, collection, serverTimestamp } = window.firebaseSDK;
                const salaryToSave = parseFloat(String(employeeData.salary).replace(/[^0-9.-]/g, '')) || 0;
                const dataToSave = { ...employeeData, salary: salaryToSave };
                try {
                    let activity;
                    if (dataToSave.id) {
                        const { id, ...data } = dataToSave;
                        const originalData = employees.find(e => e.id === id);
                        await updateDoc(doc(db, 'employees', id), data);
                        activity = `Updated employee: ${data.name}`;
                        await addDoc(collection(db, "userLogs"), { userId: auth.currentUser.uid, activity, timestamp: serverTimestamp(), originalData, updatedData: data });
                    } else {
                        await addDoc(collection(db, 'employees'), dataToSave);
                        activity = `Added new employee: ${dataToSave.name}`;
                        await addDoc(collection(db, "userLogs"), { userId: auth.currentUser.uid, activity, timestamp: serverTimestamp(), originalData: null, updatedData: dataToSave });
                    }
                    handleCloseModal();
                } catch (e) { console.error("Error saving employee:", e); }
            };
            
            const handleDeleteEmployee = async (employee) => {
                 if (window.confirm(`Are you sure you want to delete ${employee.name}?`)) {
                    try { 
                        await window.firebaseSDK.deleteDoc(window.firebaseSDK.doc(db, 'employees', employee.id)); 
                        const { addDoc, collection, serverTimestamp } = window.firebaseSDK;
                        await addDoc(collection(db, "userLogs"), { userId: auth.currentUser.uid, activity: `Deleted employee: ${employee.name}`, timestamp: serverTimestamp(), originalData: employee, updatedData: null });
                    } 
                    catch (e) { console.error(`Error deleting employee:`, e); }
                }
            }

            return (
                <Card>
                    <div className="flex flex-wrap gap-4 justify-between items-center mb-6"><h3 className="text-xl font-semibold text-slate-100">Active Employee List</h3><button onClick={() => handleOpenModal()} className="bg-blue-600 text-white px-4 py-2 rounded-lg shadow hover:bg-blue-700 transition-colors flex items-center gap-2"><i className="fas fa-plus"></i> Add Employee</button></div>
                    <div className="overflow-x-auto"><table className="min-w-full divide-y divide-slate-700"><thead className="bg-slate-900/50"><tr><th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Name</th><th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase hidden md:table-cell">Position</th><th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase hidden lg:table-cell">Shop</th><th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase hidden lg:table-cell">Join Date</th><th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase hidden lg:table-cell">Worked Dur.</th><th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Tel</th><th className="px-4 py-3 text-right text-xs font-semibold text-slate-400 uppercase hidden sm:table-cell">Salary</th><th className="px-4 py-3 text-center text-xs font-semibold text-slate-400 uppercase">Actions</th></tr></thead><tbody className="divide-y divide-slate-700">{employees.filter(e => e.status === 'Active').map(emp => (<tr key={emp.id} className="hover:bg-slate-700/50"><td className="px-4 py-4 text-sm text-slate-200 whitespace-nowrap">{emp.name}</td><td className="px-4 py-4 text-sm text-slate-300 hidden md:table-cell whitespace-nowrap">{emp.position}</td><td className="px-4 py-4 text-sm text-slate-300 hidden lg:table-cell whitespace-nowrap">{emp.shop}</td><td className="px-4 py-4 text-sm text-slate-300 hidden lg:table-cell whitespace-nowrap">{emp.joinedDate}</td><td className="px-4 py-4 text-sm text-slate-300 hidden lg:table-cell whitespace-nowrap">{calculateWorkedDuration(emp.joinedDate)}</td><td className="px-4 py-4 text-sm text-slate-300 whitespace-nowrap">{emp.tel}</td><td className="px-4 py-4 text-sm text-slate-300 text-right hidden sm:table-cell whitespace-nowrap">{formatCurrency(emp.salary)}</td><td className="px-4 py-4 text-center whitespace-nowrap"><button onClick={() => handleOpenModal(emp)} className="text-blue-400 hover:text-blue-300 mr-4"><i className="fas fa-edit"></i></button><button onClick={() => handleDeleteEmployee(emp)} className="text-red-500 hover:text-red-400"><i className="fas fa-trash"></i></button></td></tr>))}</tbody></table></div>
                    <EmployeeModal isOpen={isModalOpen} onClose={handleCloseModal} onSave={handleSaveEmployee} employee={editingEmployee} db={db} auth={auth} />
                </Card>
            );
        };
        
        const FormerEmployeesTab = ({ db }) => {
            const { data: employees } = useCollection(db, 'employees');
            const formerEmployees = employees.filter(e => e.status === 'Resigned' || e.status === 'Terminated');

            return (
                <Card>
                    <h3 className="text-xl font-semibold text-slate-100 mb-6">Resigned/Terminated Employees</h3>
                    <div className="overflow-x-auto">
                        <table className="min-w-full divide-y divide-slate-700">
                            <thead className="bg-slate-900/50">
                                <tr>
                                    <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Name</th>
                                    <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase hidden md:table-cell">Position</th>
                                    <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Status</th>
                                </tr>
                            </thead>
                            <tbody className="divide-y divide-slate-700">
                                {formerEmployees.map(emp => (
                                    <tr key={emp.id} className="hover:bg-slate-700/50">
                                        <td className="px-4 py-4 text-sm text-slate-200 whitespace-nowrap">{emp.name}</td>
                                        <td className="px-4 py-4 text-sm text-slate-300 hidden md:table-cell whitespace-nowrap">{emp.position}</td>
                                        <td className="px-4 py-4 text-sm text-slate-300 whitespace-nowrap">
                                            <span className={`px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${emp.status === 'Resigned' ? 'bg-yellow-100 text-yellow-800' : 'bg-red-100 text-red-800'}`}>
                                                {emp.status}
                                            </span>
                                        </td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                </Card>
            );
        };

        const SalaryReviseModal = ({ isOpen, onClose, onSave, db, revision }) => {
            const [formData, setFormData] = useState({});
            const { data: shops } = useCollection(db, 'shops');
            const { data: employees } = useCollection(db, 'employees');
            const [selectedShop, setSelectedShop] = useState('');

            useEffect(() => {
                const initialData = revision ? { ...revision } : {
                    date: new Date().toISOString().substring(0, 10),
                    shopName: '',
                    staffId: '',
                    reviseAmount: ''
                };
                setFormData(initialData);
                setSelectedShop(initialData.shopName);
            }, [revision, isOpen]);

            const employeesInShop = useMemo(() => {
                if (!selectedShop) return [];
                return employees.filter(emp => emp.shop === selectedShop && emp.status === 'Active');
            }, [selectedShop, employees]);

            const selectedEmployee = useMemo(() => {
                if (!formData.staffId) return null;
                return employees.find(emp => emp.id === formData.staffId);
            }, [formData.staffId, employees]);

            const baseSalary = selectedEmployee ? selectedEmployee.salary : 0;
            
            const updatedSalary = useMemo(() => {
                const base = parseFloat(String(baseSalary).replace(/[^0-9.-]/g, '')) || 0;
                const revise = parseFloat(formData.reviseAmount) || 0;
                return base + revise;
            }, [baseSalary, formData.reviseAmount]);

            const handleChange = (e) => {
                const { name, value } = e.target;
                setFormData(prev => ({ ...prev, [name]: value }));
                if (name === 'shopName') {
                    setSelectedShop(value);
                    setFormData(prev => ({ ...prev, staffId: '' }));
                }
            };

            const handleSubmit = (e) => {
                e.preventDefault();
                const staffName = selectedEmployee?.name || '';
                const finalData = { ...formData, baseSalary, updatedSalary, staffName };
                onSave(finalData);
            };

            return (
                <Modal isOpen={isOpen} onClose={onClose} maxWidth="max-w-2xl">
                    <form onSubmit={handleSubmit}>
                        <ModalHeader title={revision ? "Edit Salary Revision" : "New Salary Revision"} onClose={onClose} />
                        <ModalBody>
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div><label className="text-sm font-medium text-slate-400">Date</label><input type="date" name="date" value={formData.date || ''} onChange={handleChange} className="input" /></div>
                                <div><label className="text-sm font-medium text-slate-400">Shop Name</label><select name="shopName" value={formData.shopName || ''} onChange={handleChange} className="select"><option value="">Select Shop</option>{shops.map(s => <option key={s.id} value={s.name}>{s.name}</option>)}</select></div>
                                <div><label className="text-sm font-medium text-slate-400">Staff Name</label><select name="staffId" value={formData.staffId || ''} onChange={handleChange} className="select" disabled={!selectedShop}><option value="">Select Staff</option>{employeesInShop.map(e => <option key={e.id} value={e.id}>{e.name}</option>)}</select></div>
                                <div><label className="text-sm font-medium text-slate-400">Amount to Revise</label><input type="number" name="reviseAmount" value={formData.reviseAmount || ''} onChange={handleChange} className="input" /></div>
                                <div className="bg-slate-700/50 p-4 rounded-lg"><label className="text-sm font-medium text-slate-400">Base Salary</label><input value={formatCurrency(baseSalary)} className="input mt-1" disabled /></div>
                                <div className="bg-slate-700/50 p-4 rounded-lg"><label className="text-sm font-medium text-slate-400">Updated Salary</label><input value={formatCurrency(updatedSalary)} className="input mt-1" disabled /></div>
                            </div>
                        </ModalBody>
                        <ModalFooter>
                            <button type="button" onClick={onClose} className="bg-slate-600 text-slate-200 px-4 py-2 rounded-lg hover:bg-slate-500">Cancel</button>
                            <button type="submit" className="bg-blue-600 text-white px-6 py-2 rounded-lg shadow hover:bg-blue-700">Submit</button>
                        </ModalFooter>
                    </form>
                </Modal>
            );
        };
        
        const SalaryReviseReportTab = ({ db }) => {
            const [isModalOpen, setModalOpen] = useState(false);
            const [editingRevision, setEditingRevision] = useState(null);
            const [revisionToDelete, setRevisionToDelete] = useState(null);
            const { data: revisions } = useCollection(db, 'salaryRevisions');

            const handleOpenModal = (revision = null) => {
                setEditingRevision(revision);
                setModalOpen(true);
            };

            const handleCloseModal = () => {
                setEditingRevision(null);
                setModalOpen(false);
            };

            const handleSaveRevision = async (revisionData) => {
                const { doc, updateDoc, addDoc, collection } = window.firebaseSDK;
                const { id, staffId, updatedSalary, ...dataToSave } = revisionData;

                try {
                    // Save the revision record
                    if (id) {
                        await updateDoc(doc(db, 'salaryRevisions', id), dataToSave);
                    } else {
                        await addDoc(collection(db, 'salaryRevisions'), dataToSave);
                    }

                    // Update the employee's main salary field
                    if (staffId && updatedSalary !== undefined) {
                        const employeeRef = doc(db, 'employees', staffId);
                        await updateDoc(employeeRef, { salary: updatedSalary });
                    }
                    
                    handleCloseModal();
                } catch (error) {
                    console.error("Error saving salary revision:", error);
                }
            };
            
            const handleDeleteRevision = async () => {
                if (!revisionToDelete) return;
                try {
                    await window.firebaseSDK.deleteDoc(window.firebaseSDK.doc(db, 'salaryRevisions', revisionToDelete.id));
                    setRevisionToDelete(null);
                } catch (error) {
                    console.error("Error deleting revision:", error);
                    setRevisionToDelete(null);
                }
            };

            return (
                <Card>
                    <div className="flex flex-wrap gap-4 justify-between items-center mb-6">
                        <h3 className="text-xl font-semibold text-slate-100">Revise Tracking Report</h3>
                        <button onClick={() => handleOpenModal()} className="bg-blue-600 text-white px-4 py-2 rounded-lg shadow hover:bg-blue-700 transition-colors flex items-center gap-2">
                            <i className="fas fa-plus"></i> Add New Revision
                        </button>
                    </div>
                    <div className="overflow-x-auto">
                        <table className="min-w-full divide-y divide-slate-700">
                            <thead className="bg-slate-900/50">
                                <tr>
                                    <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Date</th>
                                    <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Staff Name</th>
                                    <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Shop Name</th>
                                    <th className="px-4 py-3 text-right text-xs font-semibold text-slate-400 uppercase">Amount Revised</th>
                                    <th className="px-4 py-3 text-right text-xs font-semibold text-slate-400 uppercase">Updated Salary</th>
                                    <th className="px-4 py-3 text-center text-xs font-semibold text-slate-400 uppercase">Actions</th>
                                </tr>
                            </thead>
                            <tbody className="divide-y divide-slate-700">
                                {revisions.map(rev => (
                                    <tr key={rev.id} className="hover:bg-slate-700/50">
                                        <td className="px-4 py-4 text-sm text-slate-200">{rev.date}</td>
                                        <td className="px-4 py-4 text-sm text-slate-200">{rev.staffName}</td>
                                        <td className="px-4 py-4 text-sm text-slate-300">{rev.shopName}</td>
                                        <td className={`px-4 py-4 text-sm text-right font-semibold ${parseFloat(rev.reviseAmount) < 0 ? 'text-red-400' : 'text-blue-400'}`}>{formatCurrency(rev.reviseAmount)}</td>
                                        <td className="px-4 py-4 text-sm text-slate-300 text-right">{formatCurrency(rev.updatedSalary)}</td>
                                        <td className="px-4 py-4 text-center whitespace-nowrap">
                                            <button onClick={() => handleOpenModal(rev)} className="text-blue-400 hover:text-blue-300 mr-4"><i className="fas fa-edit"></i></button>
                                            <button onClick={() => setRevisionToDelete(rev)} className="text-red-500 hover:text-red-400"><i className="fas fa-trash"></i></button>
                                        </td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                    <SalaryReviseModal isOpen={isModalOpen} onClose={handleCloseModal} onSave={handleSaveRevision} db={db} revision={editingRevision} />
                    <ConfirmationModal 
                        isOpen={!!revisionToDelete}
                        onClose={() => setRevisionToDelete(null)}
                        onConfirm={handleDeleteRevision}
                        title="Delete Salary Revision"
                        message="Are you sure you want to delete this revision record? This action cannot be undone."
                    />
                </Card>
            );
        };
        
        const EmployeeStateTab = ({ db }) => {
            const [isModalOpen, setModalOpen] = useState(false);
            const { data: employeeStates } = useCollection(db, 'employeeStates');
            const { data: shops } = useCollection(db, 'shops');
            const { data: employees } = useCollection(db, 'employees');
            const [selectedShop, setSelectedShop] = useState('');
            const [formData, setFormData] = useState({ date: new Date().toISOString().substring(0, 10), shop: '', staffId: '', statusState: 'Deduction', amount: '', note: '' });

            const employeesInShop = useMemo(() => {
                if (!selectedShop) return [];
                return employees.filter(emp => emp.shop === selectedShop && emp.status === 'Active');
            }, [selectedShop, employees]);
            
            const handleSave = async () => {
                if (!formData.shop || !formData.staffId || !formData.amount) {
                    alert("Please fill all required fields.");
                    return;
                }
                const { addDoc, collection } = window.firebaseSDK;
                try {
                    await addDoc(collection(db, 'employeeStates'), {
                        ...formData,
                        amount: parseFloat(formData.amount) || 0,
                        staffName: employees.find(e => e.id === formData.staffId)?.name || ''
                    });
                    setModalOpen(false);
                } catch (error) {
                    console.error("Error adding employee state:", error);
                }
            };

            return (
                <Card>
                    <div className="flex flex-wrap gap-4 justify-between items-center mb-6">
                        <h3 className="text-xl font-semibold text-slate-100">Employee State Records</h3>
                        <button onClick={() => setModalOpen(true)} className="bg-blue-600 text-white px-4 py-2 rounded-lg shadow hover:bg-blue-700 transition-colors flex items-center gap-2">
                            <i className="fas fa-plus"></i> Add New Record
                        </button>
                    </div>
                    <div className="overflow-x-auto">
                        <table className="min-w-full divide-y divide-slate-700">
                            <thead className="bg-slate-900/50">
                                <tr>
                                    <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Date</th>
                                    <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Staff Name</th>
                                    <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Status</th>
                                    <th className="px-4 py-3 text-right text-xs font-semibold text-slate-400 uppercase">Amount (KHR)</th>
                                </tr>
                            </thead>
                            <tbody className="divide-y divide-slate-700">
                                {employeeStates.map(record => (
                                    <tr key={record.id} className="hover:bg-slate-700/50">
                                        <td className="px-4 py-4 text-sm text-slate-200">{record.date}</td>
                                        <td className="px-4 py-4 text-sm text-slate-300">{record.staffName}</td>
                                        <td className="px-4 py-4 text-sm text-slate-300">{record.statusState}</td>
                                        <td className="px-4 py-4 text-sm text-slate-300 text-right">{formatCurrency(record.amount)}</td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                    
                    <Modal isOpen={isModalOpen} onClose={() => setModalOpen(false)}>
                        <ModalHeader title="Add New Employee State Record" onClose={() => setModalOpen(false)} />
                        <ModalBody>
                            <div className="space-y-4">
                                <div><label className="text-sm">Date</label><input type="date" value={formData.date} onChange={e => setFormData({...formData, date: e.target.value})} className="input"/></div>
                                <div><label className="text-sm">Shop</label><select value={selectedShop} onChange={e => { setSelectedShop(e.target.value); setFormData({...formData, shop: e.target.value, staffId: ''}); }} className="select"><option value="">Select Shop</option>{shops.map(s => <option key={s.id} value={s.name}>{s.name}</option>)}</select></div>
                                <div><label className="text-sm">Staff</label><select value={formData.staffId} onChange={e => setFormData({...formData, staffId: e.target.value})} className="select" disabled={!selectedShop}><option value="">Select Staff</option>{employeesInShop.map(e => <option key={e.id} value={e.id}>{e.name}</option>)}</select></div>
                                <div><label className="text-sm">Status State</label><select value={formData.statusState} onChange={e => setFormData({...formData, statusState: e.target.value})} className="select"><option>Deduction</option><option>Engagement</option></select></div>
                                <div><label className="text-sm">Amount (KHR)</label><input type="number" value={formData.amount} onChange={e => setFormData({...formData, amount: e.target.value})} className="input"/></div>
                                <div><label className="text-sm">Note</label><textarea value={formData.note} onChange={e => setFormData({...formData, note: e.target.value})} className="input" rows="3"></textarea></div>
                            </div>
                        </ModalBody>
                        <ModalFooter>
                            <button type="button" onClick={() => setModalOpen(false)} className="bg-slate-600 text-slate-200 px-4 py-2 rounded-lg hover:bg-slate-500">Cancel</button>
                            <button type="button" onClick={handleSave} className="bg-blue-600 text-white px-6 py-2 rounded-lg shadow hover:bg-blue-700">Save Record</button>
                        </ModalFooter>
                    </Modal>
                </Card>
            );
        };
        
        const LoanManagerPage = ({ db }) => {
            const [activeTab, setActiveTab] = useState('management');
            return (
                <TabbedPage tabs={{ management: 'Loan Management', history: 'Loan History' }}>
                    <div id="management"><LoanManagementTab db={db} /></div>
                    <div id="history"><LoanHistoryTab db={db} /></div>
                </TabbedPage>
            );
        };

        const LoanManagementTab = ({ db }) => {
            const [isModalOpen, setModalOpen] = useState(false);
            const { data: loans } = useCollection(db, 'staffLoans');
            const { data: shops } = useCollection(db, 'shops');
            const { data: employees } = useCollection(db, 'employees');
            const [selectedShop, setSelectedShop] = useState('');
            const [formData, setFormData] = useState({ loanDate: new Date().toISOString().substring(0, 10), shop: '', staffId: '', loanAmount: '', agreedMonthlyDeduction: '', reason: '' });

            const employeesInShop = useMemo(() => {
                if (!selectedShop) return [];
                return employees.filter(emp => emp.shop === selectedShop && emp.status === 'Active');
            }, [selectedShop, employees]);

            const handleSave = async () => {
                const { addDoc, collection } = window.firebaseSDK;
                try {
                    await addDoc(collection(db, 'staffLoans'), {
                        ...formData,
                        loanAmount: parseFloat(formData.loanAmount) || 0,
                        agreedMonthlyDeduction: parseFloat(formData.agreedMonthlyDeduction) || 0,
                        staffName: employees.find(e => e.id === formData.staffId)?.name || '',
                        totalPaid: 0,
                        status: 'Active'
                    });
                    setModalOpen(false);
                } catch (error) {
                    console.error("Error adding loan:", error);
                }
            };
            
            return (
                 <Card>
                    <div className="flex flex-wrap gap-4 justify-between items-center mb-6">
                        <h3 className="text-xl font-semibold text-slate-100">Loan Management</h3>
                        <button onClick={() => setModalOpen(true)} className="bg-blue-600 text-white px-4 py-2 rounded-lg shadow hover:bg-blue-700 transition-colors flex items-center gap-2">
                            <i className="fas fa-plus"></i> Add New Loan
                        </button>
                    </div>
                    <div className="overflow-x-auto">
                        <table className="min-w-full divide-y divide-slate-700">
                            <thead className="bg-slate-900/50">
                                <tr>
                                    <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Staff Name</th>
                                    <th className="px-4 py-3 text-right text-xs font-semibold text-slate-400 uppercase">Loan Amount</th>
                                    <th className="px-4 py-3 text-right text-xs font-semibold text-slate-400 uppercase">Total Paid</th>
                                    <th className="px-4 py-3 text-right text-xs font-semibold text-slate-400 uppercase">Balance</th>
                                    <th className="px-4 py-3 text-center text-xs font-semibold text-slate-400 uppercase">Status</th>
                                </tr>
                            </thead>
                            <tbody className="divide-y divide-slate-700">
                                {loans.map(loan => {
                                    const balance = loan.loanAmount - loan.totalPaid;
                                    return (
                                        <tr key={loan.id} className="hover:bg-slate-700/50">
                                            <td className="px-4 py-4 text-sm text-slate-200">{loan.staffName}</td>
                                            <td className="px-4 py-4 text-sm text-slate-300 text-right">{formatCurrency(loan.loanAmount)}</td>
                                            <td className="px-4 py-4 text-sm text-slate-300 text-right">{formatCurrency(loan.totalPaid)}</td>
                                            <td className="px-4 py-4 text-sm text-slate-300 text-right">{formatCurrency(balance)}</td>
                                            <td className="px-4 py-4 text-center text-sm">
                                                <span className={`px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${balance <= 0 ? 'bg-green-100 text-green-800' : 'bg-blue-100 text-blue-800'}`}>
                                                    {balance <= 0 ? 'Paid Off' : 'Active'}
                                                </span>
                                            </td>
                                        </tr>
                                    );
                                })}
                            </tbody>
                        </table>
                    </div>
                    <Modal isOpen={isModalOpen} onClose={() => setModalOpen(false)}>
                        <ModalHeader title="Add New Loan" onClose={() => setModalOpen(false)} />
                        <ModalBody>
                             <div className="space-y-4">
                                <div><label className="text-sm">Shop</label><select value={selectedShop} onChange={e => { setSelectedShop(e.target.value); setFormData({...formData, shop: e.target.value, staffId: ''}); }} className="select"><option value="">Select Shop</option>{shops.map(s => <option key={s.id} value={s.name}>{s.name}</option>)}</select></div>
                                <div><label className="text-sm">Staff</label><select value={formData.staffId} onChange={e => setFormData({...formData, staffId: e.target.value})} className="select" disabled={!selectedShop}><option value="">Select Staff</option>{employeesInShop.map(e => <option key={e.id} value={e.id}>{e.name}</option>)}</select></div>
                                <div><label className="text-sm">Loan Date</label><input type="date" value={formData.loanDate} onChange={e => setFormData({...formData, loanDate: e.target.value})} className="input"/></div>
                                <div><label className="text-sm">Loan Amount</label><input type="number" value={formData.loanAmount} onChange={e => setFormData({...formData, loanAmount: e.target.value})} className="input"/></div>
                                <div><label className="text-sm">Agreed Monthly Deduction</label><input type="number" value={formData.agreedMonthlyDeduction} onChange={e => setFormData({...formData, agreedMonthlyDeduction: e.target.value})} className="input"/></div>
                                <div><label className="text-sm">Reason</label><textarea value={formData.reason} onChange={e => setFormData({...formData, reason: e.target.value})} className="input" rows="3"></textarea></div>
                            </div>
                        </ModalBody>
                        <ModalFooter>
                            <button type="button" onClick={() => setModalOpen(false)} className="bg-slate-600 text-slate-200 px-4 py-2 rounded-lg hover:bg-slate-500">Cancel</button>
                            <button type="button" onClick={handleSave} className="bg-blue-600 text-white px-6 py-2 rounded-lg shadow hover:bg-blue-700">Save Loan</button>
                        </ModalFooter>
                    </Modal>
                </Card>
            );
        };
        
        const LoanHistoryTab = ({ db }) => {
            const { data: loanPayments } = useCollection(db, 'loanPayments'); // Assuming 'loanPayments' collection
            
            return (
                 <Card>
                    <h3 className="text-xl font-semibold text-slate-100 mb-6">Loan Payment History</h3>
                    <div className="overflow-x-auto">
                        <table className="min-w-full divide-y divide-slate-700">
                            <thead className="bg-slate-900/50">
                                <tr>
                                    <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Payment Date</th>
                                    <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Staff Name</th>
                                    <th className="px-4 py-3 text-right text-xs font-semibold text-slate-400 uppercase">Amount Paid</th>
                                    <th className="px-4 py-3 text-right text-xs font-semibold text-slate-400 uppercase">Remaining Balance</th>
                                    <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Note</th>
                                </tr>
                            </thead>
                            <tbody className="divide-y divide-slate-700">
                                {loanPayments.map(payment => (
                                    <tr key={payment.id} className="hover:bg-slate-700/50">
                                        <td className="px-4 py-4 text-sm text-slate-200">{payment.paymentDate}</td>
                                        <td className="px-4 py-4 text-sm text-slate-300">{payment.staffName}</td>
                                        <td className="px-4 py-4 text-sm text-slate-300 text-right">{formatCurrency(payment.amountPaid)}</td>
                                        <td className="px-4 py-4 text-sm text-slate-300 text-right">{formatCurrency(payment.remainingBalance)}</td>
                                        <td className="px-4 py-4 text-sm text-slate-300">{payment.note}</td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                </Card>
            );
        };


        // --- GENERIC SETTINGS & PAGE COMPONENTS ---
        function SettingsCRUD({ db, title, collectionName, items, formFields, listColumns }) {
            const [editingItem, setEditingItem] = useState(null);
            const [newItem, setNewItem] = useState({});
            const getInitialState = useCallback(() => formFields.reduce((acc, field) => ({...acc, [field.name]: '' }), {}), [formFields]);
            useEffect(() => { setNewItem(getInitialState()); }, [getInitialState]);

            const handleSave = async (item) => {
                const { doc, updateDoc, addDoc, collection } = window.firebaseSDK;
                try {
                    if (item.id) {
                        const { id, ...data } = item;
                        await updateDoc(doc(db, collectionName, id), data);
                    } else {
                        await addDoc(collection(db, collectionName), item);
                    }
                    setEditingItem(null);
                    setNewItem(getInitialState());
                } catch (e) { console.error(`Error saving ${collectionName}:`, e); }
            };
            
            const handleDelete = async (id) => {
                if (window.confirm(`Are you sure you want to delete this item?`)) {
                    try { await window.firebaseSDK.deleteDoc(window.firebaseSDK.doc(db, collectionName, id)); } 
                    catch (e) { console.error(`Error deleting ${collectionName}:`, e); }
                }
            };

            const renderForm = (item, setItem, isNew = false) => (
                 <form onSubmit={(e) => { e.preventDefault(); handleSave(item); }} className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-4 items-end p-4 bg-slate-800/50 rounded-lg mb-6 border border-slate-700">
                    {formFields.map(field => (<div key={field.name} className={field.fullWidth ? 'col-span-full' : 'sm:col-span-1'}><label className="block text-sm font-medium text-slate-400">{field.label}</label><input type={field.type || 'text'} name={field.name} value={item[field.name] || ''} onChange={(e) => setItem({...item, [field.name]: e.target.value})} className="input" required={field.required} /></div>))}
                    <div className="flex space-x-2 col-span-full md:col-span-1 self-end mt-4 md:mt-0"><button type="submit" className="w-full bg-blue-600 text-white px-4 py-2 rounded-lg shadow hover:bg-blue-700 transition-colors">{isNew ? `Add ${title}` : 'Save'}</button>{!isNew && <button type="button" onClick={() => setEditingItem(null)} className="w-full bg-slate-600 text-slate-200 px-4 py-2 rounded-lg hover:bg-slate-500">Cancel</button>}</div>
                </form>
            );

            return (
                <Card><CardTitle>{title} Management</CardTitle>{renderForm(newItem, setNewItem, true)}<div className="overflow-x-auto"><table className="min-w-full divide-y divide-slate-700"><thead className="bg-slate-900/50"><tr>{listColumns.map(col => <th key={col.accessor} className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">{col.header}</th>)}<th className="px-4 py-3 text-right text-xs font-semibold text-slate-400 uppercase">Actions</th></tr></thead><tbody className="divide-y divide-slate-700">{items.map(item => (<tr key={item.id} className="hover:bg-slate-700/50">{editingItem?.id === item.id ? (<td colSpan={listColumns.length + 1} className="p-0">{renderForm(editingItem, setEditingItem)}</td>) : (<>{listColumns.map(col => <td key={col.accessor} className="px-4 py-4 text-sm text-slate-300">{item[col.accessor]}</td>)}<td className="px-4 py-4 text-right text-sm"><button onClick={() => setEditingItem({ ...item })} className="text-blue-400 hover:text-blue-300 mr-3"><i className="fas fa-edit"></i></button><button onClick={() => handleDelete(item.id)} className="text-red-500 hover:text-red-400"><i className="fas fa-trash"></i></button></td></>)}</tr>))}</tbody></table></div></Card>
            );
        }
        
        const TabbedPage = ({ tabs, children }) => {
            const [activeTab, setActiveTab] = useState(Object.keys(tabs)[0]);
            const renderContent = () => children ? React.Children.toArray(children).find(child => child.props.id === activeTab) : <UnderConstructionPage title={tabs[activeTab]} />;
            return (
                <div><div className="mb-6 overflow-x-auto"><nav className="flex space-x-2 sm:space-x-4" aria-label="Tabs">{Object.entries(tabs).map(([key, title]) => (<a href="#" key={key} onClick={(e) => { e.preventDefault(); setActiveTab(key); }} className={`whitespace-nowrap rounded-md px-3 py-2 text-sm font-medium transition-colors ${activeTab === key ? 'bg-blue-600 text-white shadow' : 'text-slate-400 hover:bg-slate-700/50 hover:text-slate-200'}`}>{title}</a>))}</nav></div>{renderContent()}</div>
            );
        };
        
        function SettingsPage({ db }) {
            const { data: shops } = useCollection(db, 'shops');
            const { data: positions } = useCollection(db, 'positions');
            const shopFormFields = [{ name: 'name', label: 'Shop Name', required: true }, { name: 'latitude', label: 'Latitude' }, { name: 'longitude', label: 'Longitude' }, { name: 'radius', label: 'Radius (m)', type: 'number' }, { name: 'note', label: 'Note', fullWidth: true }];
            const shopListColumns = [{ header: 'Shop Name', accessor: 'name' }, { header: 'Latitude', accessor: 'latitude' }, { header: 'Longitude', accessor: 'longitude' }, { header: 'Radius (m)', accessor: 'radius' }, { header: 'Note', accessor: 'note' }];
            const positionFormFields = [{ name: 'position', label: 'Position', required: true }, { name: 'note', label: 'Note', fullWidth: true }];
            const positionListColumns = [{ header: 'Position', accessor: 'position' }, { header: 'Note', accessor: 'note' }];

            return (
                <TabbedPage tabs={{ shop: 'Shop Properties', position: 'Position Management' }}>
                    <div id="shop"><SettingsCRUD db={db} title="Shop" collectionName="shops" items={shops} formFields={shopFormFields} listColumns={shopListColumns} /></div>
                    <div id="position"><SettingsCRUD db={db} title="Position" collectionName="positions" items={positions} formFields={positionFormFields} listColumns={positionListColumns} /></div>
                </TabbedPage>
            );
        }
        
        const EmployeesPage = ({ db, auth, userProfile }) => (
            <TabbedPage tabs={{ active: 'Active Employees', former: 'Resigned/Terminated', salaryReport: 'Salary Revise Report', employeeState: 'Employee State' }}>
                <div id="active"><ActiveEmployeesTab db={db} auth={auth} userProfile={userProfile} /></div>
                <div id="former"><FormerEmployeesTab db={db} /></div>
                <div id="salaryReport"><SalaryReviseReportTab db={db} /></div>
                <div id="employeeState"><EmployeeStateTab db={db} /></div>
            </TabbedPage>
        );

        // --- CHECK-IN/OUT COMPONENT ---
        const LeaveRequestModal = ({ isOpen, onClose, onSave, db, request }) => {
            const { data: shops } = useCollection(db, 'shops');
            const { data: employees } = useCollection(db, 'employees');
            const [formData, setFormData] = useState({});

            const employeesInShop = useMemo(() => {
                if (!formData.shop) return [];
                return employees.filter(emp => emp.shop === formData.shop && emp.status === 'Active');
            }, [formData.shop, employees]);

            useEffect(() => {
                const initialData = request ? { ...request } : {
                    shop: '', staffId: '', supervisor: '',
                    leaveType: 'Full Day', leaveDate: '', returnDate: '',
                    numberOfDays: 0, reason: ''
                };
                 setFormData(initialData);
            }, [request, isOpen]);

            useEffect(() => {
                if (formData.leaveDate && formData.returnDate) {
                    const start = new Date(formData.leaveDate);
                    const end = new Date(formData.returnDate);
                    if (end >= start) {
                        const startUTC = Date.UTC(start.getFullYear(), start.getMonth(), start.getDate());
                        const endUTC = Date.UTC(end.getFullYear(), end.getMonth(), end.getDate());
                        let diffDays = (endUTC - startUTC) / (1000 * 60 * 60 * 24);

                        if (formData.leaveType?.startsWith('Half Day')) {
                             diffDays = 0.5;
                        } else if (diffDays === 0) {
                            diffDays = 1;
                        } else {
                            diffDays += 1;
                        }
                        
                        setFormData(prev => ({ ...prev, numberOfDays: diffDays }));
                    } else {
                        setFormData(prev => ({ ...prev, numberOfDays: 0 }));
                    }
                }
            }, [formData.leaveDate, formData.returnDate, formData.leaveType]);

            const handleChange = (e) => {
                const { name, value } = e.target;
                setFormData(prev => ({ ...prev, [name]: value }));
                if (name === 'shop') {
                    setFormData(prev => ({ ...prev, staffId: '' }));
                }
            };

            const handleSubmit = (e) => {
                e.preventDefault();
                onSave(formData);
            };

            return (
                <Modal isOpen={isOpen} onClose={onClose} maxWidth="max-w-4xl">
                    <form onSubmit={handleSubmit}>
                        <ModalHeader title={request ? "Edit Leave Request" : "New Leave Request"} onClose={onClose} />
                        <ModalBody>
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div><label className="text-sm">Shop</label><select name="shop" value={formData.shop || ''} onChange={handleChange} className="select" required><option value="">Select Shop</option>{shops.map(s => <option key={s.id} value={s.name}>{s.name}</option>)}</select></div>
                                <div><label className="text-sm">Staff Name</label><select name="staffId" value={formData.staffId || ''} onChange={handleChange} className="select" disabled={!formData.shop} required><option value="">Select Staff</option>{employeesInShop.map(e => <option key={e.id} value={e.id}>{e.name}</option>)}</select></div>
                                <div><label className="text-sm">Supervisor</label><select name="supervisor" value={formData.supervisor || ''} onChange={handleChange} className="select" required><option value="">Select Supervisor</option>{employees.map(e => <option key={e.id} value={e.name}>{e.name}</option>)}</select></div>
                                <div><label className="text-sm">Leave Type</label><select name="leaveType" value={formData.leaveType || 'Full Day'} onChange={handleChange} className="select"><option>Full Day</option><option>Half Day (AM)</option><option>Half Day (PM)</option></select></div>
                                <div><label className="text-sm">Leave Date</label><input type="date" name="leaveDate" value={formData.leaveDate || ''} onChange={handleChange} className="input" required /></div>
                                <div><label className="text-sm">Return Date</label><input type="date" name="returnDate" value={formData.returnDate || ''} onChange={handleChange} className="input" required /></div>
                                <div><label className="text-sm">Number of Days</label><input type="number" name="numberOfDays" value={formData.numberOfDays || 0} className="input" disabled /></div>
                                <div className="md:col-span-2"><label className="text-sm">Reason</label><textarea name="reason" value={formData.reason || ''} onChange={handleChange} className="input" rows="3" required></textarea></div>
                            </div>
                        </ModalBody>
                        <ModalFooter>
                            <button type="button" onClick={onClose} className="bg-slate-600 text-slate-200 px-4 py-2 rounded-lg hover:bg-slate-500">Cancel</button>
                            <button type="submit" className="bg-blue-600 text-white px-6 py-2 rounded-lg shadow hover:bg-blue-700">Submit Request</button>
                        </ModalFooter>
                    </form>
                </Modal>
            );
        };

        const LeaveRequestTab = ({ db, userProfile }) => {
            const [isModalOpen, setModalOpen] = useState(false);
            const [editingRequest, setEditingRequest] = useState(null);
            const [isConfirmOpen, setConfirmOpen] = useState(false);
            const [requestToDelete, setRequestToDelete] = useState(null);
            const { where } = window.firebaseSDK;

            const queryConstraints = useMemo(() => {
                if (!userProfile) return [where("staffId", "==", "null")]; // No data if no profile
                if (userProfile.role === 'Admin') return [];
                if (userProfile.role === 'Shop Manager') {
                    return [where("shop", "==", userProfile.shop)];
                }
                return [where("staffId", "==", userProfile.id)];
            }, [userProfile]);

            const { data: leaveRequests } = useCollection(db, 'leaveRequests', queryConstraints);
            const { data: employees } = useCollection(db, 'employees');

            const handleOpenModal = (request = null) => {
                setEditingRequest(request);
                setModalOpen(true);
            };

            const handleCloseModal = () => {
                setEditingRequest(null);
                setModalOpen(false);
            };

            const handleSaveRequest = async (formData) => {
                const { doc, addDoc, updateDoc, collection, serverTimestamp } = window.firebaseSDK;
                const staffName = employees.find(e => e.id === formData.staffId)?.name || '';
                
                try {
                    if (formData.id) { // Editing existing request
                        const { id, ...dataToUpdate } = formData;
                        await updateDoc(doc(db, 'leaveRequests', id), { ...dataToUpdate, staffName });
                    } else { // Creating new request
                        await addDoc(collection(db, 'leaveRequests'), {
                            ...formData,
                            staffName,
                            requestDate: serverTimestamp(),
                            status: 'Pending',
                        });
                    }
                    handleCloseModal();
                } catch (error) {
                    console.error("Error saving leave request:", error);
                }
            };

            const handleUpdateRequestStatus = async (id, status) => {
                const { doc, updateDoc } = window.firebaseSDK;
                try {
                    await updateDoc(doc(db, 'leaveRequests', id), { status });
                } catch (error) {
                    console.error(`Error updating status for request ${id}:`, error);
                }
            };
            
            const handleDeleteRequest = (id) => {
                setRequestToDelete(id);
                setConfirmOpen(true);
            };
            
            const confirmDelete = async () => {
                if (requestToDelete) {
                    const { doc, deleteDoc } = window.firebaseSDK;
                    try {
                        await deleteDoc(doc(db, 'leaveRequests', requestToDelete));
                    } catch (error) {
                        console.error(`Error deleting request ${requestToDelete}:`, error);
                    } finally {
                        setConfirmOpen(false);
                        setRequestToDelete(null);
                    }
                }
            };
            
            return (
                <Card>
                    <div className="flex flex-wrap gap-4 justify-between items-center mb-6">
                        <h3 className="text-xl font-semibold text-slate-100">Leave Request History</h3>
                        <button onClick={() => handleOpenModal()} className="bg-blue-600 text-white px-4 py-2 rounded-lg shadow hover:bg-blue-700 transition-colors flex items-center gap-2">
                            <i className="fas fa-plus"></i> New Leave Request
                        </button>
                    </div>

                    {/* Desktop Table View */}
                    <div className="hidden md:block overflow-x-auto">
                        <table className="min-w-full divide-y divide-slate-700">
                            <thead className="bg-slate-900/50">
                                <tr>
                                    <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Req. Date</th>
                                    <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Staff Name</th>
                                    <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Leave Type</th>
                                    <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Leave Date</th>
                                    <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Return Date</th>
                                    <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Days</th>
                                    <th className="px-4 py-3 text-center text-xs font-semibold text-slate-400 uppercase">Status</th>
                                    <th className="px-4 py-3 text-center text-xs font-semibold text-slate-400 uppercase">Actions</th>
                                </tr>
                            </thead>
                            <tbody className="divide-y divide-slate-700">
                                {leaveRequests.map(req => (
                                    <tr key={req.id} className="hover:bg-slate-700/50">
                                        <td className="px-4 py-4 text-sm text-slate-300 whitespace-nowrap">{formatRequestDate(req.requestDate)}</td>
                                        <td className="px-4 py-4 text-sm text-slate-200">{req.staffName}</td>
                                        <td className="px-4 py-4 text-sm text-slate-300">{req.leaveType}</td>
                                        <td className="px-4 py-4 text-sm text-slate-300">{req.leaveDate}</td>
                                        <td className="px-4 py-4 text-sm text-slate-300">{req.returnDate}</td>
                                        <td className="px-4 py-4 text-sm text-slate-300">{req.numberOfDays}</td>
                                        <td className="px-4 py-4 text-center text-sm">
                                            <span className={`px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${
                                                req.status === 'Approved' ? 'bg-green-100 text-green-800' :
                                                req.status === 'Rejected' ? 'bg-red-100 text-red-800' :
                                                'bg-yellow-100 text-yellow-800'
                                            }`}>
                                                {req.status}
                                            </span>
                                        </td>
                                        <td className="px-4 py-4 text-center text-sm space-x-4 whitespace-nowrap">
                                            {userProfile?.name === req.supervisor && req.status === 'Pending' && (
                                                <>
                                                    <button onClick={() => handleUpdateRequestStatus(req.id, 'Approved')} className="text-green-400 hover:text-green-300" title="Approve"><i className="fas fa-check"></i></button>
                                                    <button onClick={() => handleUpdateRequestStatus(req.id, 'Rejected')} className="text-orange-400 hover:text-orange-300" title="Reject"><i className="fas fa-times"></i></button>
                                                </>
                                            )}
                                            <button onClick={() => handleOpenModal(req)} className="text-indigo-400 hover:text-indigo-300" title="Edit"><i className="fas fa-edit"></i></button>
                                            <button onClick={() => handleDeleteRequest(req.id)} className="text-red-400 hover:text-red-300" title="Delete"><i className="fas fa-trash"></i></button>
                                        </td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>

                    {/* Mobile Card View */}
                    <div className="md:hidden space-y-4">
                        {leaveRequests.map(req => (
                            <div key={req.id} className="bg-slate-800/50 p-4 rounded-lg shadow-lg border border-slate-700 space-y-3">
                                <div className="flex justify-between items-start">
                                    <h4 className="font-semibold text-slate-100 text-lg">{req.staffName}</h4>
                                    <span className={`px-3 py-1 text-xs font-semibold rounded-full ${
                                        req.status === 'Approved' ? 'bg-green-900/50 text-green-300' :
                                        req.status === 'Rejected' ? 'bg-red-900/50 text-red-300' :
                                        'bg-yellow-900/50 text-yellow-300'
                                    }`}>
                                        {req.status}
                                    </span>
                                </div>
                                <div className="text-sm text-slate-400 border-t border-slate-700 pt-3">
                                    <div className="grid grid-cols-2 gap-x-4 gap-y-2">
                                        <div className="font-semibold text-slate-300">Request Date:</div>
                                        <div>{formatRequestDate(req.requestDate)}</div>

                                        <div className="font-semibold text-slate-300">Leave Type:</div>
                                        <div>{req.leaveType}</div>

                                        <div className="font-semibold text-slate-300">From:</div>
                                        <div>{req.leaveDate}</div>
                                        
                                        <div className="font-semibold text-slate-300">To:</div>
                                        <div>{req.returnDate}</div>

                                        <div className="font-semibold text-slate-300">Days:</div>
                                        <div>{req.numberOfDays}</div>
                                    </div>
                                </div>
                                <div className="flex justify-end items-center pt-3 border-t border-slate-700 space-x-4 text-lg">
                                    {userProfile?.name === req.supervisor && req.status === 'Pending' && (
                                        <>
                                            <button onClick={() => handleUpdateRequestStatus(req.id, 'Approved')} className="text-green-400 hover:text-green-300" title="Approve"><i className="fas fa-check-circle"></i></button>
                                            <button onClick={() => handleUpdateRequestStatus(req.id, 'Rejected')} className="text-orange-400 hover:text-orange-300" title="Reject"><i className="fas fa-times-circle"></i></button>
                                        </>
                                    )}
                                    <button onClick={() => handleOpenModal(req)} className="text-indigo-400 hover:text-indigo-300" title="Edit"><i className="fas fa-edit"></i></button>
                                    <button onClick={() => handleDeleteRequest(req.id)} className="text-red-400 hover:text-red-300" title="Delete"><i className="fas fa-trash"></i></button>
                                </div>
                            </div>
                        ))}
                    </div>

                    <LeaveRequestModal isOpen={isModalOpen} onClose={handleCloseModal} onSave={handleSaveRequest} db={db} request={editingRequest} />
                    <ConfirmationModal 
                        isOpen={isConfirmOpen}
                        onClose={() => setConfirmOpen(false)}
                        onConfirm={confirmDelete}
                        title="Delete Leave Request"
                        message="Are you sure you want to permanently delete this leave request?"
                    />
                </Card>
            );
        };

        const CheckInOutTab = ({ db, userProfile }) => {
            const [currentTime, setCurrentTime] = useState(new Date());
            const [location, setLocation] = useState(null);
            const [status, setStatus] = useState('Getting your location...');
            const [loading, setLoading] = useState(false);
            const [distance, setDistance] = useState(null);
            
            const { data: shops } = useCollection(db, 'shops');
            const { data: attendance } = useCollection(db, 'attendance');

            const userShop = useMemo(() => {
                if (!userProfile || !shops.length) return null;
                return shops.find(s => s.name === userProfile.shop);
            }, [userProfile, shops]);

            const today = new Date().toISOString().split('T')[0];
            const userAttendanceToday = useMemo(() => {
                if (!userProfile || !attendance.length) return [];
                return attendance
                    .filter(a => a.employeeId === userProfile.id && a.timestamp?.toDate().toISOString().startsWith(today))
                    .sort((a, b) => b.timestamp?.toDate() - a.timestamp?.toDate());
            }, [userProfile, attendance, today]);
            
            const lastAction = userAttendanceToday.length > 0 ? userAttendanceToday[0] : null;

            useEffect(() => {
                const timerId = setInterval(() => setCurrentTime(new Date()), 1000);
                return () => clearInterval(timerId);
            }, []);

            const getLocation = useCallback(() => {
                if (!userShop) {
                    setStatus("Your assigned shop could not be found.");
                    return;
                }

                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const { latitude, longitude } = position.coords;
                        setLocation({ latitude, longitude });
                        const dist = getDistance(latitude, longitude, parseFloat(userShop.latitude), parseFloat(userShop.longitude));
                        setDistance(dist);
                        if (dist > (parseFloat(userShop.radius) || 500)) { // Default 500m radius
                            setStatus(`You are too far from the shop (${Math.round(dist)}m). Check-in disabled.`);
                        } else {
                            setStatus(`You are within the shop area (${Math.round(dist)}m). Ready to check in/out.`);
                        }
                    },
                    (error) => {
                        console.error(`Geolocation error: ${error.message} (Code: ${error.code})`);
                        let errorMessage = "Could not get your location. Please try again.";
                        switch(error.code) {
                            case error.PERMISSION_DENIED:
                                errorMessage = "Location permission denied. Please enable it in your browser settings.";
                                break;
                            case error.POSITION_UNAVAILABLE:
                                errorMessage = "Location information is currently unavailable.";
                                break;
                            case error.TIMEOUT:
                                errorMessage = "The request to get user location timed out.";
                                break;
                        }
                        setStatus(errorMessage);
                    },
                    { enableHighAccuracy: true }
                );
            }, [userShop]);

            useEffect(() => {
                getLocation();
                const interval = setInterval(getLocation, 30000); // every 30 seconds
                return () => clearInterval(interval);
            }, [getLocation]);

            const handleCheckAction = async () => {
                if (!location || !userShop || distance > (userShop.radius || 500)) {
                    setStatus("Cannot check-in. You are not within the allowed radius.");
                    return;
                }
                setLoading(true);

                const { addDoc, collection, serverTimestamp } = window.firebaseSDK;
                const nextActionType = lastAction?.type === 'in' ? 'out' : 'in';

                try {
                    await addDoc(collection(db, 'attendance'), {
                        employeeId: userProfile.id,
                        employeeName: userProfile.name,
                        shop: userProfile.shop,
                        timestamp: serverTimestamp(),
                        type: nextActionType,
                        location
                    });
                    setStatus(`Successfully checked ${nextActionType} at ${new Date().toLocaleTimeString()}`);
                } catch (error) {
                    console.error("Error recording attendance:", error);
                    setStatus("Failed to record attendance. Please try again.");
                }
                setLoading(false);
            };

            const canCheck = distance !== null && userShop && distance <= (parseFloat(userShop.radius) || 500);

            return (
                <Card className="max-w-2xl mx-auto">
                    <div className="flex flex-col items-center justify-center p-4 sm:p-8 space-y-8">
                        <div className="text-center">
                            <p className="text-6xl md:text-7xl font-bold text-slate-100 tracking-wider">
                                {currentTime.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: true })}
                            </p>
                            <p className="text-xl text-slate-400 mt-2">
                                {currentTime.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}
                            </p>
                        </div>

                        <div className="flex gap-4">
                            <button
                                onClick={handleCheckAction}
                                disabled={lastAction?.type === 'in' || !canCheck || loading}
                                className={`px-8 py-3 text-lg font-semibold rounded-lg shadow-md transition-colors transform hover:scale-105 ${lastAction?.type === 'in' || !canCheck || loading ? 'bg-slate-700 text-slate-500 cursor-not-allowed' : 'bg-green-600 text-white hover:bg-green-700'}`}
                            >
                                {loading && lastAction?.type !== 'in' ? <i className="fas fa-spinner fa-spin"></i> : 'Check In'}
                            </button>
                            <button
                                onClick={handleCheckAction}
                                disabled={lastAction?.type !== 'in' || !canCheck || loading}
                                className={`px-8 py-3 text-lg font-semibold rounded-lg shadow-md transition-colors transform hover:scale-105 ${lastAction?.type !== 'in' || !canCheck || loading ? 'bg-slate-700 text-slate-500 cursor-not-allowed' : 'bg-slate-600 text-white hover:bg-slate-500'}`}
                            >
                                {loading && lastAction?.type === 'in' ? <i className="fas fa-spinner fa-spin"></i> : 'Check Out'}
                            </button>
                        </div>
                        
                        <div className={`p-4 rounded-lg text-center w-full max-w-md ${canCheck ? 'bg-green-900/50 border-green-700' : 'bg-red-900/50 border-red-700'} border`}>
                            <p className="font-medium text-lg text-slate-100">{status}</p>
                        </div>

                        <div className="text-center text-sm text-slate-400">
                            <p>Welcome, <span className="font-bold text-slate-200">{userProfile?.name}</span></p>
                            <p>Your assigned shop is <span className="font-bold text-slate-200">{userProfile?.shop}</span></p>
                            {lastAction && (
                                <p className="mt-2">Last action: Checked <span className="font-semibold text-slate-200">{lastAction.type}</span> at <span className="font-semibold text-slate-200">{lastAction.timestamp?.toDate().toLocaleTimeString()}</span></p>
                            )}
                        </div>
                    </div>
                </Card>
            );
        };

        const CheckInMePage = ({ db, userProfile }) => (
            <TabbedPage tabs={{ checkInOut: 'Check In/Out', leaveRequest: 'Leave Request' }}>
                <div id="checkInOut"><CheckInOutTab db={db} userProfile={userProfile} /></div>
                <div id="leaveRequest"><LeaveRequestTab db={db} userProfile={userProfile}/></div>
            </TabbedPage>
        );
        
        const DailyReportTab = ({ db }) => {
            const { data: attendance } = useCollection(db, 'attendance');
            const attendanceReport = useMemo(() => {
                const recordsByEmployeeDay = {};
                attendance.forEach(record => {
                    if (!record.timestamp) return;
                    const date = record.timestamp.toDate();
                    const dateKey = date.toISOString().split('T')[0];
                    const employeeKey = `${record.employeeId}_${dateKey}`;
                    if (!recordsByEmployeeDay[employeeKey]) {
                        recordsByEmployeeDay[employeeKey] = { date: dateKey, employeeName: record.employeeName, shop: record.shop, checkIn: null, checkOut: null };
                    }
                    if (record.type === 'in') {
                        if (!recordsByEmployeeDay[employeeKey].checkIn || date < recordsByEmployeeDay[employeeKey].checkIn) {
                            recordsByEmployeeDay[employeeKey].checkIn = date;
                        }
                    } else if (record.type === 'out') {
                        if (!recordsByEmployeeDay[employeeKey].checkOut || date > recordsByEmployeeDay[employeeKey].checkOut) {
                            recordsByEmployeeDay[employeeKey].checkOut = date;
                        }
                    }
                });
                return Object.values(recordsByEmployeeDay).map(record => {
                    let totalHours = '';
                    if (record.checkIn && record.checkOut) {
                        const diff = (record.checkOut.getTime() - record.checkIn.getTime()) / 1000 / 60 / 60;
                        totalHours = diff.toFixed(2) + ' hours';
                    }
                    return { ...record, checkIn: record.checkIn ? record.checkIn.toLocaleTimeString() : '', checkOut: record.checkOut ? record.checkOut.toLocaleTimeString() : '', totalHours };
                });
            }, [attendance]);
            return (
                <Card>
                    <CardTitle>Daily Attendance Report</CardTitle>
                    <div className="overflow-x-auto">
                        <table className="min-w-full divide-y divide-slate-700">
                            <thead className="bg-slate-900/50">
                                <tr>
                                    <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Date</th>
                                    <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Staff Name</th>
                                    <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Shop Name</th>
                                    <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Check In</th>
                                    <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Check Out</th>
                                    <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Total Hour</th>
                                </tr>
                            </thead>
                            <tbody className="divide-y divide-slate-700">
                                {attendanceReport.map((report, index) => (
                                    <tr key={index} className="hover:bg-slate-700/50">
                                        <td className="px-4 py-4 text-sm text-slate-200">{report.date}</td>
                                        <td className="px-4 py-4 text-sm text-slate-200">{report.employeeName}</td>
                                        <td className="px-4 py-4 text-sm text-slate-300">{report.shop}</td>
                                        <td className="px-4 py-4 text-sm text-slate-300">{report.checkIn}</td>
                                        <td className="px-4 py-4 text-sm text-slate-300">{report.checkOut}</td>
                                        <td className="px-4 py-4 text-sm text-slate-300">{report.totalHours}</td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                </Card>
            );
        };
        
        const WorkDayReportTab = ({ db }) => {
            const { data: attendance } = useCollection(db, 'attendance');
            const workDayReport = useMemo(() => {
                const recordsByEmployeeMonth = {};
                attendance.forEach(record => {
                    if (!record.timestamp) return;
                    const date = record.timestamp.toDate();
                    const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                    const employeeMonthKey = `${record.employeeId}_${monthKey}`;
                    if (!recordsByEmployeeMonth[employeeMonthKey]) {
                        recordsByEmployeeMonth[employeeMonthKey] = { employeeName: record.employeeName, shop: record.shop, month: monthKey, records: [] };
                    }
                    recordsByEmployeeMonth[employeeMonthKey].records.push({ date: date, type: record.type });
                });
                return Object.values(recordsByEmployeeMonth).map(group => {
                    const dailyRecords = {};
                    group.records.forEach(rec => {
                        const dayKey = rec.date.toISOString().split('T')[0];
                        if (!dailyRecords[dayKey]) { dailyRecords[dayKey] = []; }
                        dailyRecords[dayKey].push(rec);
                    });
                    const workDays = Object.keys(dailyRecords).length;
                    let totalHours = 0;
                    Object.values(dailyRecords).forEach(dayRecords => {
                        const checkIns = dayRecords.filter(r => r.type === 'in').sort((a, b) => a.date - b.date);
                        const checkOuts = dayRecords.filter(r => r.type === 'out').sort((a, b) => b.date - a.date);
                        if (checkIns.length > 0 && checkOuts.length > 0) {
                            const firstCheckIn = checkIns[0].date;
                            const lastCheckOut = checkOuts[0].date;
                            const diff = (lastCheckOut.getTime() - firstCheckIn.getTime()) / 1000 / 60 / 60;
                            if (diff > 0) { totalHours += diff; }
                        }
                    });
                    const [year, month] = group.month.split('-');
                    const dueTime = `${month}-${year.substring(2)}`;
                    return { dueTime, shopName: group.shop, staffName: group.employeeName, workDays, totalLeave: 0, totalHours: totalHours > 0 ? totalHours.toFixed(2) + ' hours' : '' };
                });
            }, [attendance]);
            return (
                <Card>
                    <CardTitle>Monthly Work Day Report</CardTitle>
                    <div className="overflow-x-auto">
                        <table className="min-w-full divide-y divide-slate-700">
                            <thead className="bg-slate-900/50">
                                <tr>
                                    <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Due Time (MM-YY)</th>
                                    <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Shop Name</th>
                                    <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Staff Name</th>
                                    <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">No. Work Day</th>
                                    <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Total Leave No</th>
                                    <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Total Hour</th>
                                </tr>
                            </thead>
                            <tbody className="divide-y divide-slate-700">
                                {workDayReport.map((report, index) => (
                                    <tr key={index} className="hover:bg-slate-700/50">
                                        <td className="px-4 py-4 text-sm text-slate-200">{report.dueTime}</td>
                                        <td className="px-4 py-4 text-sm text-slate-300">{report.shopName}</td>
                                        <td className="px-4 py-4 text-sm text-slate-200">{report.staffName}</td>
                                        <td className="px-4 py-4 text-sm text-slate-300">{report.workDays}</td>
                                        <td className="px-4 py-4 text-sm text-slate-300">{report.totalLeave}</td>
                                        <td className="px-4 py-4 text-sm text-slate-300">{report.totalHours}</td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                </Card>
            );
        };
        
        const AttendanceReportPage = ({ db }) => (
            <TabbedPage tabs={{ daily: 'Daily Report', monthly: 'No. Work Day' }}>
                <div id="daily"><DailyReportTab db={db} /></div>
                <div id="monthly"><WorkDayReportTab db={db} /></div>
            </TabbedPage>
        );

        const PayrollPage = () => <UnderConstructionPage title="Payroll" />;
        const ExpenseReportPage = () => <UnderConstructionPage title="Expense Report" />;
        
        const UserActivityPage = ({ db }) => {
            const { data: logs } = useCollection(db, 'userLogs');
            const { data: employees } = useCollection(db, 'employees');

            const employeeNameMap = useMemo(() => {
                if (!employees.length) return {};
                return employees.reduce((acc, emp) => {
                    if (emp.uid) {
                        acc[emp.uid] = emp.name;
                    }
                    return acc;
                }, {});
            }, [employees]);

            const formatActivityDetails = (log) => {
                const { originalData, updatedData } = log;
                
                if (originalData && updatedData) { // Edit
                    const changes = [];
                    const allKeys = new Set([...Object.keys(originalData), ...Object.keys(updatedData)]);
                    
                    allKeys.forEach(key => {
                        if (key === 'id' || typeof updatedData[key] === 'object') return;

                        const originalValue = String(originalData[key] || '');
                        const updatedValue = String(updatedData[key] || '');

                        if (originalValue !== updatedValue) {
                            changes.push(`${key}: from '${originalValue || 'empty'}' to '${updatedValue || 'empty'}'`);
                        }
                    });
                    return changes.length > 0 ? changes.join('; ') : log.activity || 'No detailed changes detected.';
                }
                
                return log.activity; // Fallback for Add/Delete
            };

            const getActionType = (log) => {
                 if (log.originalData && log.updatedData) return 'Edit';
                 if (!log.originalData && log.updatedData) return 'Add';
                 if (log.originalData && !log.updatedData) return 'Delete';
                 return 'Unknown';
            }

            return (
                <Card>
                    <CardTitle>User Activity Log</CardTitle>
                    <div className="overflow-x-auto">
                        <table className="min-w-full divide-y divide-slate-700">
                            <thead className="bg-slate-900/50">
                                <tr>
                                    <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Timestamp</th>
                                    <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">User</th>
                                    <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Action</th>
                                    <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Activity Details</th>
                                </tr>
                            </thead>
                            <tbody className="divide-y divide-slate-700">
                                {logs.sort((a, b) => (b.timestamp?.toDate() || 0) - (a.timestamp?.toDate() || 0)).map(log => (
                                    <tr key={log.id} className="hover:bg-slate-700/50">
                                        <td className="px-4 py-4 text-sm text-slate-200 whitespace-nowrap">{log.timestamp ? log.timestamp.toDate().toLocaleString() : 'No date'}</td>
                                        <td className="px-4 py-4 text-sm text-slate-300">{employeeNameMap[log.userId] || log.userId}</td>
                                        <td className="px-4 py-4 text-sm text-slate-300">{getActionType(log)}</td>
                                        <td className="px-4 py-4 text-sm text-slate-300">{formatActivityDetails(log)}</td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                </Card>
            );
        };


        // --- LAYOUT COMPONENTS ---
        const Sidebar = ({ activePage, setActivePage, isSidebarOpen, toggleSidebar, userProfile }) => {
            const sidebarLinks = [ { key: 'employees', icon: 'fa-users', label: 'Employees' }, { key: 'checkinme', icon: 'fa-user-clock', label: 'CheckInMe' }, { key: 'attendanceReport', icon: 'fa-file-alt', label: 'Attendance Report' }, { key: 'loanManager', icon: 'fa-hand-holding-usd', label: 'Loan Manager' }, { key: 'payroll', icon: 'fa-money-check-dollar', label: 'Payroll' }, { key: 'expenseReport', icon: 'fa-file-invoice-dollar', label: 'Expense Report' }, { key: 'userActivity', icon: 'fa-chart-line', label: 'User Activity' }, { key: 'settings', icon: 'fa-cog', label: 'Settings' }, ];
            
            const availableLinks = useMemo(() => {
                if (userProfile?.role === 'Admin') {
                    return sidebarLinks;
                }
                if (!userProfile?.permissions) {
                    return [];
                }
                return sidebarLinks.filter(link => userProfile.permissions.includes(link.key));
            }, [userProfile]);

            const handleLinkClick = (pageKey) => { setActivePage(pageKey); if (window.innerWidth < 768) toggleSidebar(); };
            
            return (<aside className={`w-64 bg-slate-900 text-slate-300 p-4 flex flex-col transform ${isSidebarOpen ? 'translate-x-0' : '-translate-x-full'} md:translate-x-0 transition-transform duration-300 ease-in-out z-40 fixed md:relative h-full border-r border-slate-700`}><div className="flex items-center mb-10 px-2"><i className="fas fa-building-user text-3xl text-blue-500 mr-3"></i><h1 className="text-2xl font-bold text-white">HR System</h1></div><nav className="flex-grow">{availableLinks.map(link => (<a href="#" key={link.key} onClick={() => handleLinkClick(link.key)} className={`flex items-center py-3 px-4 rounded-lg transition duration-200 mt-2 ${activePage === link.key ? 'bg-blue-600 text-white shadow-lg' : 'hover:bg-slate-700/50'}`}><i className={`fas ${link.icon} w-6 mr-4`}></i><span className="font-medium">{link.label}</span></a>))}</nav></aside>);
        };
        const Header = ({ pageTitle, toggleSidebar, auth, userProfile }) => {
            const handleLogout = async () => {
                try {
                    await window.firebaseSDK.signOut(auth);
                } catch (error) {
                    console.error("Error signing out: ", error);
                }
            };
            return (
                <header className="bg-slate-800/80 backdrop-blur-sm shadow-md p-4 flex justify-between items-center z-30 border-b border-slate-700 sticky top-0">
                    <div className="flex items-center">
                        <button onClick={toggleSidebar} className="text-slate-400 focus:outline-none md:hidden mr-4"><i className="fas fa-bars text-2xl"></i></button>
                        <h2 className="text-xl sm:text-2xl font-bold text-slate-100">{pageTitle}</h2>
                    </div>
                    <div className="flex items-center gap-4">
                        {userProfile && (
                            <div className="text-right hidden sm:block">
                                <span className="text-sm text-slate-400">Welcome, </span>
                                <span className="font-medium text-slate-200">{userProfile.name}</span>
                            </div>
                        )}
                        <button onClick={handleLogout} title="Logout" className="bg-slate-700 text-slate-300 w-10 h-10 rounded-full hover:bg-slate-600 hover:text-white transition duration-150 flex items-center justify-center flex-shrink-0">
                            <i className="fas fa-sign-out-alt"></i>
                        </button>
                    </div>
                </header>
            );
        };
        
        // --- MAIN DASHBOARD COMPONENT ---
        const Dashboard = ({ db, auth, user, userProfile }) => {
            const [isSidebarOpen, setSidebarOpen] = useState(false);
            const [activePage, setActivePage] = useState('');
            
            useEffect(() => {
                if (userProfile) {
                    if (userProfile.role === 'Admin') {
                        setActivePage('employees');
                    } else if (userProfile.permissions && userProfile.permissions.length > 0) {
                        setActivePage(userProfile.permissions[0]);
                    } else {
                        setActivePage('checkinme'); // Fallback for users with no specific permissions
                    }
                }
            }, [userProfile]);

            const toggleSidebar = () => setSidebarOpen(!isSidebarOpen);
            const pageTitles = { employees: 'Employees', checkinme: 'CheckInMe', attendanceReport: 'Attendance Report', loanManager: 'Loan Manager', payroll: 'Payroll', expenseReport: 'Expense Report', userActivity: 'User Activity', settings: 'Settings' };
            
            const renderActivePage = () => {
                const hasPermission = userProfile?.role === 'Admin' || userProfile?.permissions?.includes(activePage);

                if (!activePage) return null; // Don't render anything until activePage is set

                if (!hasPermission) {
                    return <Card><CardTitle>Access Denied</CardTitle><p>You do not have permission to view this page.</p></Card>;
                }

                switch(activePage) {
                    case 'employees': return <EmployeesPage db={db} auth={auth} userProfile={userProfile} />;
                    case 'checkinme': return <CheckInMePage db={db} userProfile={userProfile} />;
                    case 'attendanceReport': return <AttendanceReportPage db={db} />;
                    case 'loanManager': return <LoanManagerPage db={db} />;
                    case 'payroll': return <PayrollPage />;
                    case 'expenseReport': return <ExpenseReportPage />;
                    case 'userActivity': return <UserActivityPage db={db} />;
                    case 'settings': return <SettingsPage db={db} />;
                    default: return <UnderConstructionPage title="Page Not Found" />;
                }
            };
            return (<div className="flex h-screen bg-slate-900 text-slate-300"><Sidebar activePage={activePage} setActivePage={setActivePage} isSidebarOpen={isSidebarOpen} toggleSidebar={toggleSidebar} userProfile={userProfile} /><div className="flex-1 flex flex-col overflow-hidden"><Header pageTitle={pageTitles[activePage] || 'Dashboard'} toggleSidebar={toggleSidebar} auth={auth} userProfile={userProfile} /><main className="flex-1 overflow-x-hidden overflow-y-auto bg-slate-800 p-4 sm:p-6">{renderActivePage()}</main></div></div>);
        };

        // --- ROOT APP COMPONENT ---
        function App() {
            const [db, setDb] = useState(null);
            const [auth, setAuth] = useState(null);
            const [currentUser, setCurrentUser] = useState(null);
            const [userProfile, setUserProfile] = useState(null);
            const [loading, setLoading] = useState(true);

            useEffect(() => {
                try {
                    const { initializeApp, getFirestore, getAuth, onAuthStateChanged } = window.firebaseSDK;
                    const app = initializeApp(firebaseConfig);
                    const authInstance = getAuth(app);
                    const dbInstance = getFirestore(app);
                    setAuth(authInstance);
                    setDb(dbInstance);

                    const unsubscribe = onAuthStateChanged(authInstance, (user) => {
                        setCurrentUser(user);
                        if (!user) {
                             setUserProfile(null);
                            setLoading(false);
                        }
                    });
                    return () => unsubscribe();
                } catch (error) { 
                    console.error("Firebase initialization error:", error); 
                    setLoading(false);
                } 
            }, []);

            useEffect(() => {
                if (!db || !currentUser) {
                    setUserProfile(null);
                    return;
                };

                const { collection, query, where, onSnapshot } = window.firebaseSDK;
                const q = query(collection(db, "employees"), where("uid", "==", currentUser.uid));
                
                const unsubscribe = onSnapshot(q, (snapshot) => {
                    if (!snapshot.empty) {
                        const userDoc = snapshot.docs[0];
                        setUserProfile({ id: userDoc.id, ...userDoc.data() });
                    } else {
                        setUserProfile({ name: currentUser.email, permissions: [], role: 'Staff' });
                    }
                    setLoading(false);
                }, (error) => {
                    console.error("Error fetching user profile:", error);
                    setLoading(false);
                });

                return () => unsubscribe();
            }, [db, currentUser]);

            if (loading) { return <div className="flex items-center justify-center h-screen text-lg text-slate-300">Loading Application...</div>; }
            
            if (!currentUser) {
                return <LoginPage auth={auth} />;
            }

            return <Dashboard db={db} auth={auth} user={currentUser} userProfile={userProfile} />;
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
