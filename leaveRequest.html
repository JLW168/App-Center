<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Leave Report System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        @import url('https://rsms.me/inter/inter.css');
        html { font-family: 'Inter', sans-serif; }
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-content {
            background-color: #1f2937; /* bg-gray-800 */
            color: #d1d5db; /* text-gray-300 */
            padding: 2rem;
            border-radius: 0.5rem;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }
        .input {
            margin-top: 0.25rem;
            display: block;
            width: 100%;
            padding: 0.5rem 0.75rem;
            border-width: 1px;
            border-color: #4b5563; /* border-gray-600 */
            border-radius: 0.375rem;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            line-height: 1.5;
            background-color: #374151; /* bg-gray-700 */
            color: #f3f4f6; /* text-gray-100 */
        }
        .input:focus {
            outline: 2px solid transparent;
            outline-offset: 2px;
            --tw-ring-color: #3b82f6; /* ring-blue-500 */
            border-color: #3b82f6; /* border-blue-500 */
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-300">
    <div id="root"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, doc, addDoc, updateDoc, deleteDoc, setLogLevel, getDocs, serverTimestamp, query, where } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        window.firebaseSDK = {
            initializeApp,
            getAuth,
            onAuthStateChanged,
            signInWithEmailAndPassword,
            signOut,
            getFirestore,
            collection,
            onSnapshot,
            doc,
            addDoc,
            updateDoc,
            deleteDoc,
            setLogLevel,
            getDocs,
            serverTimestamp,
            query,
            where,
        };
    </script>
    
    <script type="text/babel">
        const { useState, useEffect, useMemo, useCallback } = React;

        // --- PASTE YOUR FIREBASE CONFIGURATION HERE ---
        const firebaseConfig = {
            apiKey: "AIzaSyBNb5ZI9XIWWSpxGD-FeV94K5FMc2a8udU",
            authDomain: "hr-manager-84ada.firebaseapp.com",
            projectId: "hr-manager-84ada",
            storageBucket: "hr-manager-84ada.firebasestorage.app",
            messagingSenderId: "365563456537",
            appId: "1:365563456537:web:9c5a6fbce7710b4c72ce88",
            measurementId: "G-51R9KT7LC1"
        };
        // ---------------------------------------------

        // --- HELPER FUNCTIONS ---
        const formatDate = (dateString) => {
            if (!dateString) return '';
            const date = new Date(dateString);
            const day = String(date.getUTCDate()).padStart(2, '0');
            const month = String(date.getUTCMonth() + 1).padStart(2, '0');
            const year = date.getUTCFullYear();
            return `${day}-${month}-${year}`;
        };

        const formatRequestTimestamp = (timestamp) => {
            if (!timestamp) return 'N/A';
            const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
            
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const year = String(date.getFullYear()).slice(-2);

            let hours = date.getHours();
            const minutes = String(date.getMinutes()).padStart(2, '0');
            const ampm = hours >= 12 ? 'PM' : 'AM';
            hours = hours % 12;
            hours = hours ? hours : 12; // the hour '0' should be '12'
            const strHours = String(hours).padStart(2, '0');

            return `${day}-${month}-${year} | ${strHours}:${minutes} ${ampm}`;
        };


        function showConfirmation(message) {
            return new Promise((resolve) => {
                const confirmationBox = document.createElement('div');
                confirmationBox.className = 'modal-overlay';
                confirmationBox.innerHTML = `
                    <div class="modal-content text-center">
                        <p class="mb-4">${message}</p>
                        <div class="flex justify-center space-x-4">
                            <button id="confirm-yes" class="bg-blue-600 text-white px-4 py-2 rounded-lg shadow hover:bg-blue-700">Confirm</button>
                            <button id="confirm-no" class="bg-gray-600 text-gray-200 px-4 py-2 border border-gray-500 rounded-md shadow-sm hover:bg-gray-500">Cancel</button>
                        </div>
                    </div>
                `;
                document.body.appendChild(confirmationBox);

                document.getElementById('confirm-yes').onclick = () => {
                    document.body.removeChild(confirmationBox);
                    resolve(true);
                };

                document.getElementById('confirm-no').onclick = () => {
                    document.body.removeChild(confirmationBox);
                    resolve(false);
                };
            });
        }

        // --- CUSTOM HOOK FOR DATA FETCHING (ENHANCED) ---
        const useCollection = (db, collectionName, refreshKey) => {
            const [data, setData] = useState([]);
            const [loading, setLoading] = useState(true);
            const [lastUpdate, setLastUpdate] = useState(null);

            useEffect(() => {
                if (!db) {
                    setLoading(false);
                    return;
                };
                
                setLoading(true); // Set loading to true on each refresh
                const { collection, onSnapshot, query } = window.firebaseSDK;
                const q = query(collection(db, collectionName));
                const unsubscribe = onSnapshot(q, (querySnapshot) => {
                    const items = [];
                    querySnapshot.forEach((doc) => {
                        items.push({ id: doc.id, ...doc.data() });
                    });
                    setData(items);
                    setLastUpdate(new Date()); // Always update the timestamp on new data
                    setLoading(false);
                }, (error) => {
                    console.error(`Error fetching ${collectionName}:`, error);
                    setLoading(false);
                });

                return () => unsubscribe();
            }, [db, collectionName, refreshKey]);

            return { data, loading, lastUpdate };
        };

        // --- AUTHENTICATION COMPONENT (REDESIGNED) ---
        function LoginPage({ auth }) {
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [error, setError] = useState('');
            const [loading, setLoading] = useState(false);
            const [showPassword, setShowPassword] = useState(false);
            const { signInWithEmailAndPassword } = window.firebaseSDK;

            const handleLogin = async (e) => {
                e.preventDefault();
                setLoading(true);
                setError('');
                try {
                    await signInWithEmailAndPassword(auth, email, password);
                } catch (err) {
                    setError("Invalid email or password.");
                } finally {
                    setLoading(false);
                }
            };

            return (
                <div className="min-h-screen bg-gray-900 flex">
                    <div className="flex-1 flex flex-col justify-center py-12 px-4 sm:px-6 lg:flex-none lg:px-20 xl:px-24">
                        <div className="mx-auto w-full max-w-sm lg:w-96">
                            <div>
                                <h2 className="mt-6 text-3xl font-extrabold text-white">Sign in to your account</h2>
                                <p className="mt-2 text-sm text-gray-400">
                                    Welcome to the Leave Request System
                                </p>
                            </div>

                            <div className="mt-8">
                                <div className="mt-6">
                                    <form onSubmit={handleLogin} className="space-y-6">
                                        <div>
                                            <label htmlFor="email" className="block text-sm font-medium text-gray-300">
                                                Email address
                                            </label>
                                            <div className="mt-1">
                                                <input
                                                    id="email"
                                                    name="email"
                                                    type="email"
                                                    autoComplete="email"
                                                    required
                                                    value={email}
                                                    onChange={(e) => setEmail(e.target.value)}
                                                    className="appearance-none block w-full px-3 py-2 border border-gray-700 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm bg-gray-800 text-white"
                                                />
                                            </div>
                                        </div>

                                        <div className="space-y-1">
                                            <label htmlFor="password"  className="block text-sm font-medium text-gray-300">
                                                Password
                                            </label>
                                            <div className="mt-1 relative">
                                                <input
                                                    id="password"
                                                    name="password"
                                                    type={showPassword ? "text" : "password"}
                                                    autoComplete="current-password"
                                                    required
                                                    value={password}
                                                    onChange={(e) => setPassword(e.target.value)}
                                                    className="appearance-none block w-full px-3 py-2 border border-gray-700 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm bg-gray-800 text-white"
                                                />
                                                <div className="absolute inset-y-0 right-0 pr-3 flex items-center text-sm leading-5">
                                                    <svg onClick={() => setShowPassword(!showPassword)} className="h-6 w-6 text-gray-400 cursor-pointer" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d={showPassword ? "M15 12a3 3 0 11-6 0 3 3 0 016 0z" : "M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242"} />
                                                        {showPassword && <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242" />}
                                                    </svg>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        {error && <p className="text-red-500 text-sm mt-2">{error}</p>}

                                        <div>
                                            <button
                                                type="submit"
                                                disabled={loading}
                                                className="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 disabled:bg-blue-400"
                                            >
                                                {loading ? 'Signing in...' : 'Sign in'}
                                            </button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div className="hidden lg:block relative w-0 flex-1">
                        <img
                            className="absolute inset-0 h-full w-full object-cover"
                            src="https://images.unsplash.com/photo-1521737604893-d14cc237f11d?ixlib=rb-4.0.3&ixid=MnwxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8&auto=format&fit=crop&w=1768&q=80"
                            alt=""
                        />
                    </div>
                </div>
            );
        }

        // --- CORE APPLICATION ---
        function App() {
            const [db, setDb] = useState(null);
            const [auth, setAuth] = useState(null);
            const [currentUser, setCurrentUser] = useState(null);
            const [userPermissions, setUserPermissions] = useState(null);
            const [authLoading, setAuthLoading] = useState(true);

            useEffect(() => {
                const { initializeApp, getFirestore, getAuth, onAuthStateChanged, collection, query, where, getDocs } = window.firebaseSDK;
                const app = initializeApp(firebaseConfig);
                const firestore = getFirestore(app);
                const authInstance = getAuth(app);
                
                setDb(firestore);
                setAuth(authInstance);

                onAuthStateChanged(authInstance, async (user) => {
                    if (user) {
                        setCurrentUser(user);
                        const supervisorsRef = collection(firestore, "supervisors");
                        const q = query(supervisorsRef, where("uid", "==", user.uid));
                        const querySnapshot = await getDocs(q);
                        if (!querySnapshot.empty) {
                            setUserPermissions({ id: querySnapshot.docs[0].id, ...querySnapshot.docs[0].data() });
                        } else {
                            setUserPermissions(null);
                        }
                    } else {
                        setCurrentUser(null);
                        setUserPermissions(null);
                    }
                    setAuthLoading(false);
                });
            }, []);

            if (authLoading) {
                return <div className="flex justify-center items-center h-screen"><div className="text-xl font-semibold">Loading...</div></div>;
            }

            if (!currentUser || !userPermissions) {
                return <LoginPage auth={auth} />;
            }

            return <LeaveRequestPage db={db} auth={auth} userPermissions={userPermissions} />;
        }

        function LeaveRequestPage({ db, auth, userPermissions }) {
            const [isModalOpen, setIsModalOpen] = useState(false);
            const [editingRequest, setEditingRequest] = useState(null);
            const [filters, setFilters] = useState({ shopId: '', status: '', supervisorId: '', date: '' });
            const [refreshKey, setRefreshKey] = useState(0);
            const { signOut } = window.firebaseSDK;

            const { data: employees, loading: employeesLoading } = useCollection(db, 'employees', refreshKey);
            const { data: shops, loading: shopsLoading } = useCollection(db, 'shops', refreshKey);
            const { data: leaveRequests, loading: leaveRequestsLoading, lastUpdate } = useCollection(db, 'leaveRequests', refreshKey);
            const { data: supervisors, loading: supervisorsLoading } = useCollection(db, 'supervisors', refreshKey);
            
            const isLoading = employeesLoading || shopsLoading || leaveRequestsLoading || supervisorsLoading;

            const handleFilterChange = (e) => {
                const { name, value } = e.target;
                setFilters(prev => ({ ...prev, [name]: value }));
            };

            const handleRefresh = () => {
                setRefreshKey(prevKey => prevKey + 1);
            };

            const filteredRequests = useMemo(() => {
                return leaveRequests.filter(req => {
                    const shopMatch = !filters.shopId || req.shopId === filters.shopId;
                    const statusMatch = !filters.status || req.status === filters.status;
                    const supervisorMatch = !filters.supervisorId || req.supervisorId === filters.supervisorId;
                    const dateMatch = !filters.date || req.date === filters.date;
                    return shopMatch && statusMatch && supervisorMatch && dateMatch;
                });
            }, [leaveRequests, filters]);

            const handleLogout = () => {
                signOut(auth).catch(error => console.error("Logout failed:", error));
            };

            const openModal = (request = null) => {
                setEditingRequest(request);
                setIsModalOpen(true);
            };

            const closeModal = () => {
                setEditingRequest(null);
                setIsModalOpen(false);
            };

            const filteredShops = useMemo(() => {
                if (userPermissions.role === 'Admin') return shops;
                return shops.filter(shop => userPermissions.shops.includes(shop.id));
            }, [shops, userPermissions]);

            if (isLoading && refreshKey === 0) {
                return <div className="flex justify-center items-center h-screen"><div className="text-xl font-semibold">Loading Data...</div></div>;
            }

            return (
                <div className="min-h-screen bg-gray-900">
                    <nav className="bg-gray-800 shadow-sm sticky top-0 z-10">
                        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                            <div className="flex justify-between items-center h-16">
                                <div className="flex-shrink-0 flex items-center text-xl font-bold text-blue-400">
                                    Leave Requests
                                </div>
                                <div className="flex items-center">
                                    <span className="text-sm font-medium text-gray-300 mr-4 hidden sm:block">Welcome, {userPermissions.name}</span>
                                    <button onClick={handleLogout} className="text-sm text-blue-400 hover:underline">Logout</button>
                                </div>
                            </div>
                        </div>
                    </nav>
                    <main className="py-6 sm:py-10">
                        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                            <div className="flex flex-col sm:flex-row justify-between items-center mb-4 gap-4">
                                <div className="text-sm text-gray-400">
                                    Last updated: {lastUpdate ? lastUpdate.toLocaleTimeString() : 'Checking...'}
                                </div>
                                <button onClick={handleRefresh} disabled={leaveRequestsLoading} className="bg-gray-700 text-gray-200 px-4 py-2 rounded-lg shadow-sm border border-gray-600 hover:bg-gray-600 flex items-center disabled:opacity-50">
                                    <svg xmlns="http://www.w3.org/2000/svg" className={`h-5 w-5 mr-2 ${leaveRequestsLoading ? 'animate-spin' : ''}`} fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M4 4v5h5M20 20v-5h-5M20 4h-5v5M4 20h5v-5" />
                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M4 4v5h5m11 11v-5h-5m0-6h5V4m-5 16h5v-5" />
                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" transform="rotate(-45 12 12)" />
                                    </svg>
                                    {leaveRequestsLoading ? 'Refreshing...' : 'Refresh'}
                                </button>
                            </div>

                            {/* --- FILTER CONTROLS --- */}
                            <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-6 p-4 bg-gray-800 rounded-lg shadow">
                                <select name="shopId" value={filters.shopId} onChange={handleFilterChange} className="input">
                                    <option value="">All Shops</option>
                                    {shops.map(s => <option key={s.id} value={s.id}>{s.name}</option>)}
                                </select>
                                <select name="status" value={filters.status} onChange={handleFilterChange} className="input">
                                    <option value="">All Statuses</option>
                                    <option value="Pending">Pending</option>
                                    <option value="Approved">Approved</option>
                                    <option value="Rejected">Rejected</option>
                                </select>
                                <select name="supervisorId" value={filters.supervisorId} onChange={handleFilterChange} className="input">
                                    <option value="">All Supervisors</option>
                                    {supervisors.map(s => <option key={s.id} value={s.id}>{s.name}</option>)}
                                </select>
                                <input type="date" name="date" value={filters.date} onChange={handleFilterChange} className="input" />
                            </div>

                            <LeaveRequestsTable 
                                db={db}
                                auth={auth}
                                requests={filteredRequests} 
                                employees={employees} 
                                shops={shops} 
                                supervisors={supervisors}
                                userPermissions={userPermissions}
                                onEdit={openModal}
                            />
                        </div>
                    </main>
                    <button onClick={() => openModal()} className="fixed bottom-6 right-6 bg-blue-600 text-white p-4 rounded-full shadow-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 md:hidden">
                        <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 4v16m8-8H4" />
                        </svg>
                    </button>
                    <div className="hidden md:flex justify-end m-8">
                         <button onClick={() => openModal()} className="bg-blue-600 text-white px-4 py-2 rounded-lg shadow hover:bg-blue-700">
                            New Leave Request
                        </button>
                    </div>
                    {isModalOpen && <LeaveRequestModal db={db} auth={auth} request={editingRequest} onClose={closeModal} employees={employees} shops={filteredShops} supervisors={supervisors} userPermissions={userPermissions} />}
                </div>
            );
        }

        function LeaveRequestsTable({ db, auth, requests, employees, shops, supervisors, userPermissions, onEdit }) {
            const getNameById = (id, list) => list.find(item => item.id === id)?.name || 'N/A';
            
            const handleStatusChange = async (request, newStatus) => {
                if (await showConfirmation(`Are you sure you want to ${newStatus.toLowerCase()} this request?`)) {
                    const { doc, updateDoc, serverTimestamp } = window.firebaseSDK;
                    await updateDoc(doc(db, "leaveRequests", request.id), {
                        status: newStatus,
                        approvedBy: userPermissions.name,
                        approvedAt: serverTimestamp()
                    });
                }
            };

            const handleDelete = async (requestId) => {
                if (await showConfirmation("Are you sure you want to delete this leave request?")) {
                     const { doc, deleteDoc } = window.firebaseSDK;
                    await deleteDoc(doc(db, "leaveRequests", requestId));
                }
            };

            const displayLeaveDuration = (req) => {
                if (req.leaveType && req.leaveType !== 'Full Day') {
                    return `${req.leaveNo} Day (${req.leaveType.replace('Half Day ', '')})`;
                }
                return `${req.leaveNo} Day(s)`;
            };

            return (
                <div className="bg-gray-800 shadow-md rounded-lg overflow-hidden">
                    <div className="overflow-x-auto">
                        <table className="min-w-full divide-y divide-gray-700 hidden md:table">
                            <thead className="bg-gray-700">
                                <tr>
                                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase">Request Date</th>
                                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase">Shop Name</th>
                                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase">Staff Name</th>
                                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase">Leave No.</th>
                                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase">Leave Date</th>
                                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase">Return Date</th>
                                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase">Status</th>
                                    <th className="px-6 py-3 text-right text-xs font-medium text-gray-300 uppercase">Actions</th>
                                </tr>
                            </thead>
                            <tbody className="bg-gray-800 divide-y divide-gray-700">
                                {requests.map(req => {
                                    const canManage = userPermissions.role === 'Admin' || 
                                                      (userPermissions.role === 'Shop Manager' && 
                                                       userPermissions.shops.includes(req.shopId) &&
                                                       userPermissions.id === req.supervisorId);

                                    return (
                                        <tr key={req.id}>
                                            <td className="px-6 py-4 whitespace-nowrap text-gray-300">{formatRequestTimestamp(req.requestDate)}</td>
                                            <td className="px-6 py-4 whitespace-nowrap text-gray-300">{getNameById(req.shopId, shops)}</td>
                                            <td className="px-6 py-4 whitespace-nowrap text-gray-300">{getNameById(req.employeeId, employees)}</td>
                                            <td className="px-6 py-4 whitespace-nowrap text-gray-300">{displayLeaveDuration(req)}</td>
                                            <td className="px-6 py-4 whitespace-nowrap text-gray-300">{formatDate(req.date)}</td>
                                            <td className="px-6 py-4 whitespace-nowrap text-gray-300">{formatDate(req.returnDate)}</td>
                                            <td className="px-6 py-4 whitespace-nowrap">
                                                <span className={`px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${
                                                    req.status === 'Approved' ? 'bg-green-900 text-green-200' : 
                                                    req.status === 'Rejected' ? 'bg-red-900 text-red-200' : 'bg-yellow-900 text-yellow-200'
                                                }`}>
                                                    {req.status}
                                                </span>
                                            </td>
                                            <td className="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                                                {canManage && req.status === 'Pending' && (
                                                    <>
                                                        <button onClick={() => handleStatusChange(req, 'Approved')} className="text-green-400 hover:text-green-300 mr-4">Approve</button>
                                                        <button onClick={() => handleStatusChange(req, 'Rejected')} className="text-red-400 hover:text-red-300 mr-4">Reject</button>
                                                    </>
                                                )}
                                                <button onClick={() => onEdit(req)} disabled={!canManage} className={!canManage ? "text-indigo-400 cursor-not-allowed mr-4" : "text-indigo-400 hover:text-indigo-300 mr-4"}>Edit</button>
                                                <button onClick={() => handleDelete(req.id)} disabled={!canManage} className={!canManage ? "text-red-400 cursor-not-allowed" : "text-red-400 hover:text-red-300"}>Delete</button>
                                            </td>
                                        </tr>
                                    );
                                })}
                            </tbody>
                        </table>
                        <div className="md:hidden p-4 space-y-4">
                            {requests.map(req => {
                                const canManage = userPermissions.role === 'Admin' || 
                                                      (userPermissions.role === 'Shop Manager' && 
                                                       userPermissions.shops.includes(req.shopId) &&
                                                       userPermissions.id === req.supervisorId);
                                return (
                                <div key={req.id} className="bg-gray-800 p-4 rounded-lg shadow">
                                    <div className="flex justify-between items-center mb-2">
                                        <div className="text-sm font-bold text-white">{getNameById(req.employeeId, employees)}</div>
                                        <span className={`px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${
                                            req.status === 'Approved' ? 'bg-green-900 text-green-200' : 
                                            req.status === 'Rejected' ? 'bg-red-900 text-red-200' : 'bg-yellow-900 text-yellow-200'
                                        }`}>
                                            {req.status}
                                        </span>
                                    </div>
                                    <div className="text-sm text-gray-400 mb-1"><strong>Requested:</strong> {formatRequestTimestamp(req.requestDate)}</div>
                                    <div className="text-sm text-gray-400 mb-1"><strong>Leave Date:</strong> {formatDate(req.date)}</div>
                                    <div className="text-sm text-gray-400 mb-1"><strong>Return Date:</strong> {formatDate(req.returnDate)}</div>
                                    <div className="text-sm text-gray-400 mb-1"><strong>Duration:</strong> {displayLeaveDuration(req)}</div>
                                    <div className="flex justify-end space-x-2 mt-4">
                                        {canManage && req.status === 'Pending' && (
                                            <>
                                                <button onClick={() => handleStatusChange(req, 'Approved')} className="text-green-400 hover:text-green-300">Approve</button>
                                                <button onClick={() => handleStatusChange(req, 'Rejected')} className="text-red-400 hover:text-red-300">Reject</button>
                                            </>
                                        )}
                                        <button onClick={() => onEdit(req)} disabled={!canManage} className={!canManage ? "text-indigo-400 cursor-not-allowed" : "text-indigo-400 hover:text-indigo-300"}>Edit</button>
                                        <button onClick={() => handleDelete(req.id)} disabled={!canManage} className={!canManage ? "text-red-400 cursor-not-allowed" : "text-red-400 hover:text-red-300"}>Delete</button>
                                    </div>
                                </div>
                            )})}
                        </div>
                    </div>
                </div>
            );
        }

        function LeaveRequestModal({ db, auth, request, onClose, employees, shops, supervisors, userPermissions }) {
            const initialFormState = {
                date: '',
                returnDate: '',
                shopId: '',
                employeeId: '',
                supervisorId: '',
                leaveNo: 1,
                leaveType: 'Full Day',
                note: '',
                status: 'Pending',
                requestedBy: userPermissions.name
            };
            const [formData, setFormData] = useState(request || initialFormState);
            const [isSaving, setIsSaving] = useState(false);

            useEffect(() => {
                if (formData.leaveType === 'Full Day') {
                    if (formData.date && formData.returnDate) {
                        const start = new Date(formData.date);
                        const end = new Date(formData.returnDate);
                        if (end >= start) {
                            const diffTime = end.getTime() - start.getTime();
                            const diffDays = Math.round(diffTime / (1000 * 60 * 60 * 24));
                            setFormData(prev => ({ ...prev, leaveNo: diffDays }));
                        } else {
                            setFormData(prev => ({ ...prev, leaveNo: 0 }));
                        }
                    }
                } else if (formData.leaveType.includes('Half Day')) {
                    setFormData(prev => ({ ...prev, leaveNo: 0.5, returnDate: formData.date }));
                }
            }, [formData.date, formData.returnDate, formData.leaveType]);

            const filteredEmployees = useMemo(() => {
                if (!formData.shopId) return [];
                return employees.filter(emp => emp.shop === formData.shopId && emp.staffStatus === 'Active');
            }, [formData.shopId, employees]);
            
            const filteredSupervisors = useMemo(() => {
                if (!formData.shopId) return [];
                const supervisorIdsInShop = new Set(
                    employees
                        .filter(emp => emp.shop === formData.shopId && emp.supervisor)
                        .map(emp => emp.supervisor)
                );
                return supervisors.filter(sup => supervisorIdsInShop.has(sup.id));
            }, [formData.shopId, employees, supervisors]);


            const handleShopChange = (e) => {
                const shopId = e.target.value;
                setFormData(prev => ({ ...prev, shopId, employeeId: '', supervisorId: '' }));
            };

            const handleChange = (e) => {
                const { name, value } = e.target;
                setFormData(prev => ({ ...prev, [name]: value }));
            };

            const handleSubmit = async (e) => {
                e.preventDefault();
                setIsSaving(true);
                try {
                    const { doc, updateDoc, addDoc, collection, serverTimestamp } = window.firebaseSDK;
                    const dataToSave = { ...formData, leaveNo: parseFloat(formData.leaveNo) };

                    if (request) {
                        await updateDoc(doc(db, "leaveRequests", request.id), dataToSave);
                    } else {
                        await addDoc(collection(db, "leaveRequests"), { ...dataToSave, requestDate: serverTimestamp(), createdAt: serverTimestamp() });
                    }
                    onClose();
                } catch (error) {
                    console.error("Error saving leave request:", error);
                } finally {
                    setIsSaving(false);
                }
            };

            return (
                <div className="modal-overlay">
                    <div className="modal-content">
                        <h3 className="text-xl font-semibold mb-4">{request ? 'Edit Leave Request' : 'New Leave Request'}</h3>
                        <form onSubmit={handleSubmit} className="space-y-4">
                            <div>
                                <label className="block text-sm font-medium text-gray-400">Request Date</label>
                                <input type="text" value={request ? formatRequestTimestamp(request.requestDate) : 'Will be set on submission'} className="input bg-gray-700" readOnly />
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-gray-400">Shop</label>
                                <select name="shopId" value={formData.shopId} onChange={handleShopChange} className="input" required>
                                    <option value="">Select Shop</option>
                                    {shops.map(shop => <option key={shop.id} value={shop.id}>{shop.name}</option>)}
                                </select>
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-gray-400">Employee</label>
                                <select name="employeeId" value={formData.employeeId} onChange={handleChange} className="input" required disabled={!formData.shopId}>
                                    <option value="">Select Employee</option>
                                    {filteredEmployees.map(emp => <option key={emp.id} value={emp.id}>{emp.name}</option>)}
                                </select>
                            </div>
                             <div>
                                <label className="block text-sm font-medium text-gray-400">Supervisor</label>
                                <select name="supervisorId" value={formData.supervisorId} onChange={handleChange} className="input" required disabled={!formData.shopId}>
                                    <option value="">Select Supervisor</option>
                                    {filteredSupervisors.map(s => <option key={s.id} value={s.id}>{s.name}</option>)}
                                </select>
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-gray-400">Leave Type</label>
                                <select name="leaveType" value={formData.leaveType} onChange={handleChange} className="input" required>
                                    <option>Full Day</option>
                                    <option>Half Day (AM)</option>
                                    <option>Half Day (PM)</option>
                                </select>
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-gray-400">Leave Date</label>
                                <input type="date" name="date" value={formData.date} onChange={handleChange} className="input" required />
                            </div>
                            {formData.leaveType === 'Full Day' && (
                                <div>
                                    <label className="block text-sm font-medium text-gray-400">Return Date</label>
                                    <input type="date" name="returnDate" value={formData.returnDate} onChange={handleChange} className="input" required />
                                </div>
                            )}
                            <div>
                                <label className="block text-sm font-medium text-gray-400">Number of Days</label>
                                <input type="number" name="leaveNo" value={formData.leaveNo} onChange={handleChange} className="input" min="0.5" step="0.5" required />
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-gray-400">Reason / Note</label>
                                <textarea name="note" value={formData.note} onChange={handleChange} rows="3" className="input"></textarea>
                            </div>
                            <div className="flex justify-end space-x-3 pt-4">
                                <button type="button" onClick={onClose} className="bg-gray-600 text-gray-200 py-2 px-4 border border-gray-500 rounded-md shadow-sm text-sm font-medium hover:bg-gray-500">Cancel</button>
                                <button type="submit" disabled={isSaving} className="bg-blue-600 text-white px-4 py-2 rounded-lg shadow hover:bg-blue-700">{isSaving ? 'Saving...' : 'Submit Request'}</button>
                            </div>
                        </form>
                    </div>
                </div>
            );
        }
        
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
