<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Purchase Order System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" xintegrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Custom scrollbar for better aesthetics */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        /* Active state for sidebar links */
        .sidebar-link.active {
            background-color: #3b82f6; /* blue-600 */
            color: white;
        }
        #product-search-results div:hover {
            background-color: #e5e7eb; /* gray-200 */
        }
        /* Styles for the printable PO */
        #po-printable {
            position: absolute;
            left: -9999px;
            width: 1123px; /* A4 landscape width in pixels at 96 DPI */
            height: 794px; /* A4 landscape height in pixels at 96 DPI */
            background: white;
            padding: 40px;
            font-size: 12px;
            color: #000;
        }
    </style>
</head>
<body class="bg-gray-100">
    <div class="flex h-screen bg-gray-200">
        <!-- Sidebar -->
        <aside id="sidebar" class="w-64 bg-gray-800 text-white p-4 transform -translate-x-full md:translate-x-0 transition-transform duration-300 ease-in-out z-30 fixed md:relative h-full">
            <div class="flex items-center mb-8">
                <i class="fas fa-file-invoice-dollar text-3xl text-blue-400 mr-3"></i>
                <h1 class="text-2xl font-bold">PO System</h1>
            </div>
            <nav>
                <a href="#" class="sidebar-link active flex items-center py-3 px-4 rounded-lg transition duration-200 hover:bg-gray-700" data-page="po-request">
                    <i class="fas fa-paper-plane w-6 mr-3"></i>
                    <span>PO Request</span>
                </a>
                <a href="#" class="sidebar-link flex items-center py-3 px-4 rounded-lg transition duration-200 hover:bg-gray-700" data-page="po-center">
                    <i class="fas fa-inbox w-6 mr-3"></i>
                    <span>PO Center</span>
                </a>
                <a href="#" class="sidebar-link flex items-center py-3 px-4 rounded-lg transition duration-200 hover:bg-gray-700" data-page="product-data">
                    <i class="fas fa-database w-6 mr-3"></i>
                    <span>Product Data</span>
                </a>
                <a href="#" class="sidebar-link flex items-center py-3 px-4 rounded-lg transition duration-200 hover:bg-gray-700" data-page="settings">
                    <i class="fas fa-cog w-6 mr-3"></i>
                    <span>Settings</span>
                </a>
            </nav>
        </aside>

        <!-- Main Content -->
        <div class="flex-1 flex flex-col overflow-hidden">
            <!-- Header -->
            <header class="bg-white shadow-md p-4 flex justify-between items-center">
                <button id="sidebar-toggle" class="text-gray-500 focus:outline-none md:hidden">
                    <i class="fas fa-bars text-2xl"></i>
                </button>
                <h2 id="page-title" class="text-2xl font-semibold text-gray-800">PO Request</h2>
                <div class="flex items-center">
                    <i class="fas fa-user-circle text-3xl text-gray-600"></i>
                </div>
            </header>

            <!-- Content Area -->
            <main class="flex-1 overflow-x-hidden overflow-y-auto bg-gray-100 p-6">
                <div id="page-content">
                    <div class="bg-white p-8 rounded-lg shadow-lg text-center"><i class="fas fa-spinner fa-spin text-5xl text-gray-400 mb-4"></i><h3 class="text-3xl font-bold text-gray-700">Authenticating...</h3><p class="text-gray-500 mt-2">Please wait.</p></div>
                </div>
            </main>
        </div>
    </div>

    <!-- Overlay for mobile sidebar -->
    <div id="overlay" class="fixed inset-0 bg-black opacity-50 z-20 hidden md:hidden"></div>
    
    <!-- Firebase SDKs -->
    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, setDoc, getDoc, updateDoc, deleteDoc, writeBatch, getDocs, query, where, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";

        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAsw_K2LarDunqh9ePnSRuMjXrzd6WZ1EI",
            authDomain: "posystem-3e373.firebaseapp.com",
            projectId: "posystem-3e373",
            storageBucket: "posystem-3e373.appspot.com",
            messagingSenderId: "783169032599",
            appId: "1:783169032599:web:d44e8956e790a7f9b3b4d2",
            measurementId: "G-G6B8H6HSQC"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        let currentUserId = null;

        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUserId = user.uid;
                // Once authenticated, initialize the main application logic
                initializeAppLogic();
            } else {
                currentUserId = null;
                // Handle signed-out state if necessary
                document.getElementById('page-content').innerHTML = `<div class="bg-white p-8 rounded-lg shadow-lg text-center"><i class="fas fa-exclamation-circle text-5xl text-red-400 mb-4"></i><h3 class="text-3xl font-bold text-gray-700">Authentication Failed</h3><p class="text-gray-500 mt-2">Please refresh the page to try again.</p></div>`;
            }
        });

        // Sign in anonymously
        signInAnonymously(auth).catch((error) => {
            console.error("Anonymous sign-in failed:", error);
        });

        function initializeAppLogic() {
            const sidebar = document.getElementById('sidebar');
            const sidebarToggle = document.getElementById('sidebar-toggle');
            const overlay = document.getElementById('overlay');
            const pageTitle = document.getElementById('page-title');
            const pageContent = document.getElementById('page-content');
            const sidebarLinks = document.querySelectorAll('.sidebar-link');

            // --- Page Content Templates ---
            const pages = {
                'po-request': {
                    title: 'PO Request',
                    content: `
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <h3 id="po-request-title" class="text-2xl font-semibold text-gray-800 mb-6">Create Purchase Order</h3>
                        <input type="hidden" id="po-id">
                        
                        <!-- PO Details Form -->
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8 p-6 border border-gray-200 rounded-lg bg-gray-50">
                            <div><label for="po-shop-name" class="block text-sm font-medium text-gray-700 mb-1">Shop Name</label><select id="po-shop-name" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" required><option value="">Loading Shops...</option></select></div>
                            <div><label for="po-vendor" class="block text-sm font-medium text-gray-700 mb-1">Vendor</label><select id="po-vendor" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" required><option value="">Loading Vendors...</option></select></div>
                            <div><label for="po-number" class="block text-sm font-medium text-gray-700 mb-1">PO No.</label><input type="text" id="po-number" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm bg-gray-100" readonly></div>
                            <div><label for="po-req-date" class="block text-sm font-medium text-gray-700 mb-1">Req Date</label><input type="text" id="po-req-date" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm bg-gray-100" readonly></div>
                        </div>

                        <!-- Add Product Form -->
                        <div class="mb-8 p-6 border border-gray-200 rounded-lg bg-gray-50">
                            <h4 class="text-xl font-medium mb-4 text-gray-700">Add Product to PO</h4>
                            <form id="add-po-item-form" class="grid grid-cols-1 md:grid-cols-12 gap-4 items-end">
                                <div class="md:col-span-4 relative">
                                    <label for="po-product-search" class="block text-sm font-medium text-gray-700 mb-1">Product Code/Barcode/Name</label>
                                    <input type="text" id="po-product-search" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" autocomplete="off">
                                    <div id="product-search-results" class="absolute z-10 w-full bg-white border border-gray-300 rounded-md mt-1 shadow-lg max-h-60 overflow-y-auto hidden"></div>
                                </div>
                                <div class="md:col-span-5">
                                    <label for="po-product-name" class="block text-sm font-medium text-gray-700 mb-1">Product Name</label>
                                    <input type="text" id="po-product-name" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm bg-gray-100" readonly>
                                    <input type="hidden" id="po-selected-product-id">
                                    <input type="hidden" id="po-selected-product-code">
                                    <input type="hidden" id="po-selected-product-barcode">
                                    <input type="hidden" id="po-selected-product-vendor-name">
                                    <input type="hidden" id="po-selected-product-cost">
                                </div>
                                <div class="md:col-span-2">
                                    <label for="po-item-quantity" class="block text-sm font-medium text-gray-700 mb-1">Quantity</label>
                                    <input type="number" id="po-item-quantity" min="1" value="1" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                </div>
                                <div class="md:col-span-1">
                                    <button type="submit" class="w-full bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition duration-150 ease-in-out">Add</button>
                                </div>
                            </form>
                        </div>

                        <!-- PO Items List -->
                        <div>
                            <h4 class="text-xl font-medium mb-4 text-gray-700">PO Items</h4>
                            <div id="po-items-container" class="bg-white rounded-lg shadow overflow-x-auto">
                                <p class="p-4 text-gray-500 text-center">No products added yet.</p>
                            </div>
                        </div>
                        
                        <!-- PO Actions -->
                        <div class="mt-8 text-right space-x-4">
                            <button id="save-draft-po" class="bg-yellow-500 text-white font-bold py-2 px-6 rounded-lg hover:bg-yellow-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-yellow-500">Save Draft</button>
                            <button id="submit-po" class="bg-green-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">Submit PO</button>
                        </div>
                    </div>
                    <!-- Hidden Printable PO Template -->
                    <div id="po-printable"></div>
                    `
                },
                'po-center': {
                    title: 'PO Center',
                    content: `<div><div class="mb-6 border-b border-gray-200"><nav class="flex -mb-px" aria-label="Tabs" id="po-center-tabs"><a href="#" class="tab-link active-tab whitespace-nowrap py-4 px-6 border-b-2 font-medium text-lg" data-tab="drafts-po">Drafts PO</a><a href="#" class="tab-link whitespace-nowrap py-4 px-6 border-b-2 font-medium text-lg" data-tab="active-po">Active PO</a></nav></div><div id="po-center-tab-content"></div></div>`
                },
                'product-data': {
                    title: 'Product Data',
                    content: `<div><div class="mb-6 border-b border-gray-200"><nav class="flex -mb-px" aria-label="Tabs" id="product-data-tabs"><a href="#" class="tab-link active-tab whitespace-nowrap py-4 px-6 border-b-2 font-medium text-lg" data-tab="product-list">Product List</a><a href="#" class="tab-link whitespace-nowrap py-4 px-6 border-b-2 font-medium text-lg" data-tab="vendor-list">Vendor List</a></nav></div><div id="product-data-tab-content"></div></div>`
                },
                'settings': {
                    title: 'Settings',
                    content: `<div><div class="mb-6 border-b border-gray-200"><nav class="flex -mb-px" aria-label="Tabs" id="settings-tabs"><a href="#" class="tab-link active-tab whitespace-nowrap py-4 px-6 border-b-2 font-medium text-lg" data-tab="shop-list">Shop List</a><a href="#" class="tab-link whitespace-nowrap py-4 px-6 border-b-2 font-medium text-lg" data-tab="user-profile">User Profile</a></nav></div><div id="settings-tab-content"></div></div>`
                }
            };

            const poCenterTabs = {
                'drafts-po': `<div id="drafts-po-container"></div>`,
                'active-po': `<div id="active-po-container"></div>`
            };

            const productDataTabs = {
                'product-list': `
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <div class="flex justify-between items-center mb-6 flex-wrap gap-4">
                            <h3 class="text-2xl font-semibold text-gray-800">Product Data Management</h3>
                            <div class="flex items-center gap-2">
                                <button id="import-product-btn" class="bg-teal-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-teal-600 transition duration-150 ease-in-out">
                                    <i class="fas fa-file-import mr-2"></i>Import
                                </button>
                                <button id="download-template-btn" class="bg-gray-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-gray-600 transition duration-150 ease-in-out">
                                    <i class="fas fa-download mr-2"></i>Template
                                </button>
                                <button id="export-product-btn" class="bg-green-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-600 transition duration-150 ease-in-out">
                                    <i class="fas fa-file-export mr-2"></i>Export
                                </button>
                                <input type="file" id="product-csv-input" class="hidden" accept=".csv">
                            </div>
                        </div>
                        <div class="mb-8 p-6 border border-gray-200 rounded-lg bg-gray-50">
                            <h4 id="product-form-title" class="text-xl font-medium mb-4 text-gray-700">Add New Product</h4>
                            <form id="add-product-form">
                                <input type="hidden" id="product-id">
                                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                    <div><label for="product-code" class="block text-sm font-medium text-gray-700 mb-1">Product Code</label><input type="text" id="product-code" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" required></div>
                                    <div><label for="product-barcode" class="block text-sm font-medium text-gray-700 mb-1">Barcode</label><input type="text" id="product-barcode" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"></div>
                                    <div><label for="product-name" class="block text-sm font-medium text-gray-700 mb-1">Product Name</label><input type="text" id="product-name" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" required></div>
                                    <div><label for="product-vendor" class="block text-sm font-medium text-gray-700 mb-1">Vendor</label><select id="product-vendor" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" required><option value="">Select Vendor</option></select></div>
                                    <div><label for="product-cost" class="block text-sm font-medium text-gray-700 mb-1">Cost</label><input type="number" id="product-cost" step="0.01" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" required></div>
                                    <div><label for="product-price" class="block text-sm font-medium text-gray-700 mb-1">Sale Price</label><input type="number" id="product-price" step="0.01" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" required></div>
                                    <div class="md:col-span-2 lg:col-span-3"><label for="product-note" class="block text-sm font-medium text-gray-700 mb-1">Note</label><textarea id="product-note" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"></textarea></div>
                                </div>
                                <div id="product-form-buttons" class="mt-6 text-right">
                                    <button type="submit" class="bg-blue-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition duration-150 ease-in-out">
                                        <i class="fas fa-plus-circle mr-2"></i>Add Product
                                    </button>
                                </div>
                            </form>
                        </div>
                        <div>
                             <h4 class="text-xl font-medium mb-4 text-gray-700">Existing Products</h4>
                             <div id="products-list-container" class="bg-white rounded-lg shadow overflow-x-auto"><p class="p-4 text-gray-500 text-center">Loading products...</p></div>
                        </div>
                    </div>`,
                'vendor-list': `
                    <div class="bg-white p-6 rounded-lg shadow-md">
                         <div class="flex justify-between items-center mb-6">
                            <h3 class="text-2xl font-semibold text-gray-800">Vendor List</h3>
                            <button id="import-vendor-btn" class="bg-teal-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-teal-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-teal-500 transition duration-150 ease-in-out">
                                <i class="fas fa-file-import mr-2"></i>Import Vendor
                            </button>
                            <input type="file" id="vendor-csv-input" class="hidden" accept=".csv">
                        </div>
                        <div class="mb-8 p-6 border border-gray-200 rounded-lg bg-gray-50">
                            <h4 id="vendor-form-title" class="text-xl font-medium mb-4 text-gray-700">Add New Vendor</h4>
                            <form id="add-vendor-form">
                                <input type="hidden" id="vendor-id">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <div><label for="vendor-name" class="block text-sm font-medium text-gray-700 mb-1">Vendor Name</label><input type="text" id="vendor-name" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" placeholder="Enter vendor name" required></div>
                                    <div><label for="vendor-contact" class="block text-sm font-medium text-gray-700 mb-1">Contact</label><input type="text" id="vendor-contact" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" placeholder="Enter contact info" required></div>
                                </div>
                                <div id="vendor-form-buttons" class="mt-6 text-right">
                                    <button type="submit" class="bg-blue-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition duration-150 ease-in-out">
                                        <i class="fas fa-plus-circle mr-2"></i>Add Vendor
                                    </button>
                                </div>
                            </form>
                        </div>
                        <div>
                             <h4 class="text-xl font-medium mb-4 text-gray-700">Existing Vendors</h4>
                             <div id="vendors-list-container" class="bg-white rounded-lg shadow overflow-x-auto"><p class="p-4 text-gray-500 text-center">Loading vendors...</p></div>
                        </div>
                    </div>`
            };

            const settingsTabs = {
                'shop-list': `
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <h3 class="text-2xl font-semibold mb-6 text-gray-800">Shop List</h3>
                        <div class="mb-8 p-6 border border-gray-200 rounded-lg bg-gray-50">
                            <h4 id="shop-form-title" class="text-xl font-medium mb-4 text-gray-700">Add New Shop</h4>
                            <form id="add-shop-form">
                                <input type="hidden" id="shop-id">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <div><label for="shop-name" class="block text-sm font-medium text-gray-700 mb-1">Shop Name</label><input type="text" id="shop-name" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" placeholder="Enter shop name" required></div>
                                    <div><label for="shop-contact" class="block text-sm font-medium text-gray-700 mb-1">Contact</label><input type="text" id="shop-contact" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" placeholder="Enter contact number or email" required></div>
                                    <div class="md:col-span-2"><label for="shop-address" class="block text-sm font-medium text-gray-700 mb-1">Address</label><textarea id="shop-address" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" placeholder="Enter shop address" required></textarea></div>
                                </div>
                                <div id="shop-form-buttons" class="mt-6 text-right">
                                    <button type="submit" class="bg-blue-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition duration-150 ease-in-out">
                                        <i class="fas fa-plus-circle mr-2"></i>Add Shop
                                    </button>
                                </div>
                            </form>
                        </div>
                        <div>
                             <h4 class="text-xl font-medium mb-4 text-gray-700">Existing Shops</h4>
                             <div id="shops-list-container" class="bg-white rounded-lg shadow overflow-x-auto"><p class="p-4 text-gray-500 text-center">Loading shops...</p></div>
                        </div>
                    </div>`,
                'user-profile': `
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <h3 class="text-2xl font-semibold mb-6 text-gray-800">User Profile Management</h3>
                        <div class="mb-8 p-6 border border-gray-200 rounded-lg bg-gray-50">
                            <h4 id="user-form-title" class="text-xl font-medium mb-4 text-gray-700">Add New User</h4>
                            <form id="add-user-form">
                                <input type="hidden" id="user-doc-id">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <div><label for="user-name" class="block text-sm font-medium text-gray-700 mb-1">Name</label><input type="text" id="user-name" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" placeholder="Enter user's full name" required></div>
                                    <div><label for="user-email" class="block text-sm font-medium text-gray-700 mb-1">Email</label><input type="email" id="user-email" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" placeholder="Enter user's email" required></div>
                                    <div><label for="user-role" class="block text-sm font-medium text-gray-700 mb-1">Role</label><select id="user-role" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"><option>Admin</option><option>Shop Manager</option><option>Staff</option></select></div>
                                    <div><label for="user-uid" class="block text-sm font-medium text-gray-700 mb-1">UID</label><input type="text" id="user-uid" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm bg-gray-100" placeholder="System Generated" readonly></div>
                                    <div class="md:col-span-2"><label class="block text-sm font-medium text-gray-700 mb-2">Assigned Shops</label><div id="user-form-shops" class="space-y-2 p-4 border border-gray-200 rounded-md max-h-32 overflow-y-auto">Loading shops...</div></div>
                                    <div class="md:col-span-2"><label class="block text-sm font-medium text-gray-700 mb-2">Page Permissions</label><div id="user-form-permissions" class="space-y-2 p-4 border border-gray-200 rounded-md"><label class="flex items-center"><input type="checkbox" name="permissions" value="po-request" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500 mr-2">PO Request</label><label class="flex items-center"><input type="checkbox" name="permissions" value="po-center" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500 mr-2">PO Center</label><label class="flex items-center"><input type="checkbox" name="permissions" value="product-data" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500 mr-2">Product Data</label><label class="flex items-center"><input type="checkbox" name="permissions" value="settings" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500 mr-2">Settings</label></div></div>
                                </div>
                                <div id="user-form-buttons" class="mt-6 text-right">
                                    <button type="submit" class="bg-blue-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition duration-150 ease-in-out">
                                        <i class="fas fa-plus-circle mr-2"></i>Add User
                                    </button>
                                </div>
                            </form>
                        </div>
                        <div class="overflow-x-auto">
                             <h4 class="text-xl font-medium mb-4 text-gray-700">Existing Users</h4>
                             <div id="users-list-container" class="bg-white rounded-lg shadow"><p class="p-4 text-gray-500 text-center">Loading users...</p></div>
                        </div>
                    </div>`
            };

            // --- Functions ---
            function loadPage(pageKey, data = null) {
                const page = pages[pageKey];
                if (!page) return;
                pageTitle.textContent = page.title;
                pageContent.innerHTML = page.content;

                if (pageKey === 'po-request') {
                    setupPoRequestPage(data);
                } else if (pageKey === 'po-center') {
                    setupPoCenterTabs();
                    loadPoCenterTab('drafts-po');
                } else if (pageKey === 'settings') {
                    setupSettingsTabs();
                    loadSettingsTab('shop-list');
                } else if (pageKey === 'product-data') {
                    setupProductDataTabs();
                    loadProductDataTab('product-list');
                }
            }
            
            function loadPoCenterTab(tabKey) {
                const tabContentContainer = document.getElementById('po-center-tab-content');
                if (!tabContentContainer) return;

                tabContentContainer.innerHTML = poCenterTabs[tabKey];
                
                if (tabKey === 'drafts-po') {
                    renderDraftsPO();
                } else if (tabKey === 'active-po') {
                    renderActivePO();
                }
            }

            function renderPOsByStatus(status, containerId) {
                const container = document.getElementById(containerId);
                if (!container) return;
                container.innerHTML = `<p class="p-4 text-gray-500 text-center">Loading POs...</p>`;

                const q = query(collection(db, "purchaseOrders"), where("status", "==", status));
                onSnapshot(q, (snapshot) => {
                    if (snapshot.empty) {
                        container.innerHTML = `<p class="p-4 text-gray-500 text-center">No ${status} POs found.</p>`;
                        return;
                    }

                    const khrFormatter = new Intl.NumberFormat('en-US', { style: 'currency', currency: 'KHR' });
                    let tableHtml = `<div class="bg-white rounded-lg shadow overflow-x-auto"><table class="min-w-full divide-y divide-gray-200"><thead class="bg-gray-50"><tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">PO Number</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Req Date</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Shop</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Vendor</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Total Amount</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                        ${status === 'draft' ? '<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>' : ''}
                    </tr></thead><tbody class="bg-white divide-y divide-gray-200">`;

                    snapshot.forEach(doc => {
                        const po = doc.data();
                        const reqDate = po.requestDate.toDate().toLocaleDateString();
                        const statusClass = po.status === 'draft' ? 'bg-yellow-200 text-yellow-800' : 'bg-green-200 text-green-800';
                        
                        tableHtml += `<tr>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${po.poNumber}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${reqDate}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${po.shopName}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${po.vendorName}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${khrFormatter.format(po.totalAmount)}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500"><span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${statusClass}">${po.status}</span></td>
                            ${status === 'draft' ? `<td class="px-6 py-4 whitespace-nowrap text-sm font-medium space-x-2">
                                <button data-id="${doc.id}" class="edit-draft-po text-blue-600 hover:text-blue-900"><i class="fas fa-edit"></i></button>
                                <button data-id="${doc.id}" class="delete-draft-po text-red-600 hover:text-red-900"><i class="fas fa-trash"></i></button>
                            </td>` : ''}
                        </tr>`;
                    });

                    tableHtml += `</tbody></table></div>`;
                    container.innerHTML = tableHtml;
                });
            }

            async function handleDraftPoActions(e) {
                const button = e.target.closest('button');
                if (!button) return;
                
                const poId = button.dataset.id;
                if (!poId) return;

                if (button.classList.contains('delete-draft-po')) {
                    if (confirm('Are you sure you want to delete this draft?')) {
                        try {
                            await deleteDoc(doc(db, "purchaseOrders", poId));
                            alert('Draft deleted successfully.');
                        } catch (error) {
                            console.error("Error deleting draft:", error);
                            alert('Failed to delete draft.');
                        }
                    }
                } else if (button.classList.contains('edit-draft-po')) {
                    try {
                        const poDoc = await getDoc(doc(db, "purchaseOrders", poId));
                        if (poDoc.exists()) {
                            loadPage('po-request', { id: poDoc.id, ...poDoc.data() });
                        } else {
                            alert('Could not find the selected draft.');
                        }
                    } catch (error) {
                        console.error("Error fetching draft for editing:", error);
                        alert('Failed to fetch draft for editing.');
                    }
                }
            }

            function renderDraftsPO() {
                renderPOsByStatus('draft', 'drafts-po-container');
                const container = document.getElementById('drafts-po-container');
                // Remove previous listener to avoid duplicates
                container.removeEventListener('click', handleDraftPoActions);
                container.addEventListener('click', handleDraftPoActions);
            }

            function renderActivePO() {
                renderPOsByStatus('submitted', 'active-po-container');
            }

            function loadSettingsTab(tabKey) {
                const tabContentContainer = document.getElementById('settings-tab-content');
                if (!tabContentContainer) return;
                
                tabContentContainer.innerHTML = settingsTabs[tabKey];
                if (tabKey === 'shop-list') {
                    setupShopList();
                } else if (tabKey === 'user-profile') {
                    setupUserProfile();
                }
            }
            
            function loadProductDataTab(tabKey) {
                const tabContentContainer = document.getElementById('product-data-tab-content');
                if (!tabContentContainer) return;

                tabContentContainer.innerHTML = productDataTabs[tabKey];
                if (tabKey === 'product-list') {
                    setupProductList();
                } else if (tabKey === 'vendor-list') {
                    setupVendorList();
                }
            }

            function setupPoCenterTabs() {
                const tabsContainer = document.getElementById('po-center-tabs');
                if (!tabsContainer) return;

                tabsContainer.addEventListener('click', (e) => {
                    if (e.target.classList.contains('tab-link')) {
                        e.preventDefault();
                        const tabKey = e.target.dataset.tab;
                        
                        tabsContainer.querySelectorAll('.tab-link').forEach(l => l.classList.remove('active-tab'));
                        e.target.classList.add('active-tab');
                        
                        loadPoCenterTab(tabKey);
                    }
                });
            }

            function setupSettingsTabs() {
                const tabsContainer = document.getElementById('settings-tabs');
                if (!tabsContainer) return;

                tabsContainer.addEventListener('click', (e) => {
                    if (e.target.classList.contains('tab-link')) {
                        e.preventDefault();
                        const tabKey = e.target.dataset.tab;
                        
                        tabsContainer.querySelectorAll('.tab-link').forEach(l => l.classList.remove('active-tab'));
                        e.target.classList.add('active-tab');
                        
                        loadSettingsTab(tabKey);
                    }
                });
            }
            
            function setupProductDataTabs() {
                const tabsContainer = document.getElementById('product-data-tabs');
                if (!tabsContainer) return;

                tabsContainer.addEventListener('click', (e) => {
                    if (e.target.classList.contains('tab-link')) {
                        e.preventDefault();
                        const tabKey = e.target.dataset.tab;
                        
                        tabsContainer.querySelectorAll('.tab-link').forEach(l => l.classList.remove('active-tab'));
                        e.target.classList.add('active-tab');
                        
                        loadProductDataTab(tabKey);
                    }
                });
            }

            function toggleSidebar() {
                sidebar.classList.toggle('-translate-x-full');
                overlay.classList.toggle('hidden');
            }

            // --- Firebase Logic ---
            
            async function generatePoPdf(poData) {
                const { jsPDF } = window.jspdf;
                const printableArea = document.getElementById('po-printable');
                const khrFormatter = new Intl.NumberFormat('en-US');

                // Fetch shop and vendor details for addresses
                let shopDetails = {};
                let vendorDetails = {};
                try {
                    const shopDoc = await getDoc(doc(db, "shops", poData.shopId));
                    if(shopDoc.exists()) shopDetails = shopDoc.data();

                    const vendorDoc = await getDoc(doc(db, "vendors", poData.vendorId));
                    if(vendorDoc.exists()) vendorDetails = vendorDoc.data();
                } catch(e) {
                    console.error("Could not fetch shop/vendor details for printing:", e);
                }

                // Populate the printable template
                printableArea.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: flex-start; border-bottom: 2px solid #000; padding-bottom: 10px;">
                        <div style="width: 33%;">
                            <h1 style="font-size: 24px; font-weight: bold;">PURCHASE ORDER</h1>
                            <p><strong>PO #:</strong> ${poData.poNumber}</p>
                            <p><strong>Date:</strong> ${poData.requestDate.toLocaleDateString()}</p>
                        </div>
                        <div style="width: 33%; text-align: center;">
                            <h3 style="font-weight: bold; margin-bottom: 5px;">VENDOR:</h3>
                            <p>${poData.vendorName}</p>
                            <p>${vendorDetails.contact || ''}</p>
                        </div>
                        <div style="width: 33%; text-align: right;">
                            <h2 style="font-size: 18px; font-weight: bold;">${poData.shopName}</h2>
                            <p>${shopDetails.address || ''}</p>
                            <p>${shopDetails.contact || ''}</p>
                        </div>
                    </div>
                    <table style="width: 100%; margin-top: 20px; border-collapse: collapse;">
                        <thead style="background-color: #eee;">
                            <tr>
                                <th style="border: 1px solid #ccc; padding: 8px; text-align: left;">No.</th>
                                <th style="border: 1px solid #ccc; padding: 8px; text-align: left;">Product Code</th>
                                <th style="border: 1px solid #ccc; padding: 8px; text-align: left;">Barcode</th>
                                <th style="border: 1px solid #ccc; padding: 8px; text-align: left;">Product Name</th>
                                <th style="border: 1px solid #ccc; padding: 8px; text-align: right;">QTY</th>
                                <th style="border: 1px solid #ccc; padding: 8px; text-align: right;">Cost (KHR)</th>
                                <th style="border: 1px solid #ccc; padding: 8px; text-align: right;">Cost (USD)</th>
                                <th style="border: 1px solid #ccc; padding: 8px; text-align: right;">Sub-Total</th>
                                <th style="border: 1px solid #ccc; padding: 8px; text-align: right;">CB4</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${poData.items.map((item, index) => `
                                <tr>
                                    <td style="border: 1px solid #ccc; padding: 8px;">${index + 1}</td>
                                    <td style="border: 1px solid #ccc; padding: 8px;">${item.code}</td>
                                    <td style="border: 1px solid #ccc; padding: 8px;">${item.barcode}</td>
                                    <td style="border: 1px solid #ccc; padding: 8px;">${item.name}</td>
                                    <td style="border: 1px solid #ccc; padding: 8px; text-align: right;">${item.quantity}</td>
                                    <td style="border: 1px solid #ccc; padding: 8px; text-align: right;"></td>
                                    <td style="border: 1px solid #ccc; padding: 8px; text-align: right;"></td>
                                    <td style="border: 1px solid #ccc; padding: 8px; text-align: right;"></td>
                                    <td style="border: 1px solid #ccc; padding: 8px; text-align: right;">${khrFormatter.format(item.cb4)}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                        <tfoot>
                            <tr>
                                <td colspan="8" style="border: 1px solid #ccc; padding: 8px; text-align: right; font-weight: bold;">TOTAL</td>
                                <td style="border: 1px solid #ccc; padding: 8px; text-align: right; font-weight: bold;"></td>
                            </tr>
                        </tfoot>
                    </table>
                    <div style="position: absolute; bottom: 40px; width: 1043px; display: flex; justify-content: space-between;">
                        <div>
                            <p style="border-top: 1px solid #000; padding-top: 5px;">Prepared By</p>
                        </div>
                        <div>
                            <p style="border-top: 1px solid #000; padding-top: 5px;">Approved By</p>
                        </div>
                    </div>
                `;

                try {
                    const canvas = await html2canvas(printableArea);
                    const imgData = canvas.toDataURL('image/png');
                    const pdf = new jsPDF({
                        orientation: 'landscape',
                        unit: 'px',
                        format: 'a4'
                    });
                    const pdfWidth = pdf.internal.pageSize.getWidth();
                    const pdfHeight = pdf.internal.pageSize.getHeight();
                    pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);
                    pdf.save(`PO-${poData.poNumber}.pdf`);
                } catch (error) {
                    console.error('Error generating PDF:', error);
                    alert('Could not generate PO PDF.');
                }
            }

            function setupPoRequestPage(poDataToEdit = null) {
                const poRequestTitle = document.getElementById('po-request-title');
                const poIdInput = document.getElementById('po-id');
                const shopSelect = document.getElementById('po-shop-name');
                const vendorSelect = document.getElementById('po-vendor');
                const poNumberInput = document.getElementById('po-number');
                const reqDateInput = document.getElementById('po-req-date');
                const productSearchInput = document.getElementById('po-product-search');
                const searchResultsContainer = document.getElementById('product-search-results');
                const productNameInput = document.getElementById('po-product-name');
                const selectedProductIdInput = document.getElementById('po-selected-product-id');
                const selectedProductCodeInput = document.getElementById('po-selected-product-code');
                const selectedProductBarcodeInput = document.getElementById('po-selected-product-barcode');
                const selectedProductVendorNameInput = document.getElementById('po-selected-product-vendor-name');
                const selectedProductCostInput = document.getElementById('po-selected-product-cost');
                const quantityInput = document.getElementById('po-item-quantity');
                const addItemForm = document.getElementById('add-po-item-form');
                const poItemsContainer = document.getElementById('po-items-container');
                const saveDraftBtn = document.getElementById('save-draft-po');
                const submitPoBtn = document.getElementById('submit-po');

                let poItems = [];

                // --- Populate Dropdowns ---
                onSnapshot(collection(db, "shops"), (snapshot) => {
                    let optionsHtml = '<option value="">Select Shop</option>';
                    snapshot.forEach(doc => {
                        optionsHtml += `<option value="${doc.id}" data-name="${doc.data().name}">${doc.data().name}</option>`;
                    });
                    shopSelect.innerHTML = optionsHtml;
                    if (poDataToEdit) shopSelect.value = poDataToEdit.shopId;
                });

                onSnapshot(collection(db, "vendors"), (snapshot) => {
                    let optionsHtml = '<option value="">Select Vendor</option>';
                    snapshot.forEach(doc => {
                        optionsHtml += `<option value="${doc.id}" data-name="${doc.data().name}">${doc.data().name}</option>`;
                    });
                    vendorSelect.innerHTML = optionsHtml;
                    if (poDataToEdit) vendorSelect.value = poDataToEdit.vendorId;
                });
                
                // --- Auto Generate PO Number & Date ---
                function generatePoNumber() {
                    if (poNumberInput.value) return; // Don't regenerate if editing
                    if (shopSelect.value && vendorSelect.value) {
                        const shopName = shopSelect.options[shopSelect.selectedIndex].dataset.name.replace(/\s+/g, '');
                        const vendorName = vendorSelect.options[vendorSelect.selectedIndex].dataset.name.replace(/\s+/g, '');
                        const now = new Date();
                        const d = String(now.getDate()).padStart(2, '0');
                        const m = String(now.getMonth() + 1).padStart(2, '0');
                        const y = String(now.getFullYear()).slice(-2);
                        const h = String(now.getHours()).padStart(2, '0');
                        const min = String(now.getMinutes()).padStart(2, '0');
                        const s = String(now.getSeconds()).padStart(2, '0');
                        poNumberInput.value = `${shopName}-${vendorName}-${d}${m}${y}-${h}${min}${s}`;
                    } else {
                        poNumberInput.value = '';
                    }
                }

                function setRequestDate() {
                    const now = new Date();
                    reqDateInput.value = now.toLocaleDateString('en-CA'); // YYYY-MM-DD format
                }

                shopSelect.addEventListener('change', generatePoNumber);
                vendorSelect.addEventListener('change', generatePoNumber);
                
                if (!poDataToEdit) {
                    setRequestDate();
                }

                // --- Product Search ---
                productSearchInput.addEventListener('input', async (e) => {
                    const searchTerm = e.target.value.trim().toLowerCase();
                    if (searchTerm.length < 1) {
                        searchResultsContainer.innerHTML = '';
                        searchResultsContainer.classList.add('hidden');
                        return;
                    }

                    try {
                        const productsRef = collection(db, "products");
                        const querySnapshot = await getDocs(productsRef);
                        
                        const results = [];
                        querySnapshot.forEach(doc => {
                            const product = doc.data();
                            const code = product.code ? product.code.toLowerCase() : '';
                            const barcode = product.barcode ? product.barcode.toLowerCase() : '';
                            const name = product.name ? product.name.toLowerCase() : '';

                            if (name.includes(searchTerm) || 
                                code.includes(searchTerm) || 
                                barcode.includes(searchTerm) ||
                                (code.length >= 5 && code.slice(-5) === searchTerm) ||
                                (barcode.length >= 6 && barcode.slice(-6) === searchTerm)
                                ) {
                                results.push({ id: doc.id, ...product });
                            }
                        });

                        if (results.length > 0) {
                            searchResultsContainer.innerHTML = results.map(p => `
                                <div class="p-2 cursor-pointer" data-id="${p.id}" data-name="${p.name}" data-code="${p.code}" data-barcode="${p.barcode || ''}" data-vendor-name="${p.vendorName || ''}" data-cost="${p.cost}">
                                    <p class="font-semibold">${p.name}</p>
                                    <p class="text-sm text-gray-500">Code: ${p.code} | Barcode: ${p.barcode || 'N/A'}</p>
                                </div>
                            `).join('');
                            searchResultsContainer.classList.remove('hidden');
                        } else {
                            searchResultsContainer.innerHTML = '<div class="p-2 text-gray-500">No products found.</div>';
                            searchResultsContainer.classList.remove('hidden');
                        }
                    } catch (error) {
                        console.error("Error searching products:", error);
                        searchResultsContainer.innerHTML = '<div class="p-2 text-red-500">Error searching.</div>';
                        searchResultsContainer.classList.remove('hidden');
                    }
                });
                
                // --- Select a Product from search ---
                searchResultsContainer.addEventListener('click', (e) => {
                    const productDiv = e.target.closest('div[data-id]');
                    if (productDiv) {
                        productNameInput.value = productDiv.dataset.name;
                        selectedProductIdInput.value = productDiv.dataset.id;
                        selectedProductCodeInput.value = productDiv.dataset.code;
                        selectedProductBarcodeInput.value = productDiv.dataset.barcode;
                        selectedProductVendorNameInput.value = productDiv.dataset.vendorName;
                        selectedProductCostInput.value = productDiv.dataset.cost;
                        productSearchInput.value = '';
                        searchResultsContainer.classList.add('hidden');
                        quantityInput.focus();
                    }
                });

                // --- Add Item to PO List ---
                addItemForm.addEventListener('submit', (e) => {
                    e.preventDefault();
                    const productId = selectedProductIdInput.value;
                    if (!productId) {
                        alert("Please select a product first.");
                        return;
                    }

                    const existingItemIndex = poItems.findIndex(item => item.productId === productId);
                    const quantity = parseInt(quantityInput.value);

                    if (existingItemIndex > -1) {
                        poItems[existingItemIndex].quantity += quantity;
                    } else {
                        poItems.push({
                            productId: productId,
                            code: selectedProductCodeInput.value,
                            barcode: selectedProductBarcodeInput.value,
                            name: productNameInput.value,
                            vendorName: selectedProductVendorNameInput.value,
                            cost: parseFloat(selectedProductCostInput.value),
                            cb4: parseFloat(selectedProductCostInput.value), // Cost Before
                            quantity: quantity
                        });
                    }
                    
                    renderPoItems();
                    resetAddItemForm();
                });

                function resetAddItemForm() {
                    addItemForm.reset();
                    quantityInput.value = "1";
                    productNameInput.value = '';
                    selectedProductIdInput.value = '';
                    selectedProductCodeInput.value = '';
                    selectedProductBarcodeInput.value = '';
                    selectedProductVendorNameInput.value = '';
                    selectedProductCostInput.value = '';
                    productSearchInput.focus();
                }

                function renderPoItems() {
                    if (poItems.length === 0) {
                        poItemsContainer.innerHTML = `<p class="p-4 text-gray-500 text-center">No products added yet.</p>`;
                        return;
                    }

                    let tableHtml = `<table class="min-w-full divide-y divide-gray-200"><thead class="bg-gray-50"><tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">No.</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Product Code</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Barcode</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Product Name</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Vendor</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Qty</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Cost (KHR)</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Cost (USD)</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Sub-Total</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">CB4</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                    </tr></thead><tbody class="bg-white divide-y divide-gray-200">`;
                    
                    poItems.forEach((item, index) => {
                        tableHtml += `<tr>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${index + 1}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${item.code}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${item.barcode}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${item.name}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${item.vendorName}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${item.quantity}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500"></td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500"></td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500"></td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500"></td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium space-x-2">
                                <button data-index="${index}" class="edit-po-item text-blue-600 hover:text-blue-900"><i class="fas fa-edit"></i></button>
                                <button data-index="${index}" class="remove-po-item text-red-600 hover:text-red-900"><i class="fas fa-trash"></i></button>
                            </td>
                        </tr>`;
                    });

                    tableHtml += `</tbody></table>`;
                    poItemsContainer.innerHTML = tableHtml;
                }
                
                poItemsContainer.addEventListener('click', (e) => {
                    const button = e.target.closest('button');
                    if(!button) return;

                    const index = button.dataset.index;

                    if(button.classList.contains('remove-po-item')) {
                        poItems.splice(index, 1);
                        renderPoItems();
                    } else if (button.classList.contains('edit-po-item')) {
                        const itemToEdit = poItems[index];
                        
                        // Populate the form
                        selectedProductIdInput.value = itemToEdit.productId;
                        selectedProductCodeInput.value = itemToEdit.code;
                        selectedProductBarcodeInput.value = itemToEdit.barcode;
                        productNameInput.value = itemToEdit.name;
                        selectedProductVendorNameInput.value = itemToEdit.vendorName;
                        selectedProductCostInput.value = itemToEdit.cost;
                        quantityInput.value = itemToEdit.quantity;

                        // Remove from list to be re-added on submit
                        poItems.splice(index, 1);
                        renderPoItems();
                        productSearchInput.focus();
                    }
                });


                // --- Save/Submit PO ---
                async function savePO(status) {
                    if (!shopSelect.value || !vendorSelect.value || !poNumberInput.value) {
                        alert("Please select a shop and vendor.");
                        return;
                    }
                    if (poItems.length === 0) {
                        alert("Please add at least one product to the PO.");
                        return;
                    }

                    const totalAmount = poItems.reduce((sum, item) => sum + (item.cost * item.quantity), 0);
                    const poId = poIdInput.value;

                    const poData = {
                        poNumber: poNumberInput.value,
                        shopId: shopSelect.value,
                        shopName: shopSelect.options[shopSelect.selectedIndex].dataset.name,
                        vendorId: vendorSelect.value,
                        vendorName: vendorSelect.options[vendorSelect.selectedIndex].dataset.name,
                        requestDate: new Date(reqDateInput.value),
                        status: status, // 'draft' or 'submitted'
                        items: poItems,
                        totalAmount: totalAmount,
                        createdBy: currentUserId,
                        updatedAt: serverTimestamp()
                    };

                    try {
                        if (status === 'submitted') {
                            await generatePoPdf(poData);
                        }

                        if (poId) { // If we are editing an existing PO
                            await updateDoc(doc(db, "purchaseOrders", poId), poData);
                        } else { // If we are creating a new one
                            poData.createdAt = serverTimestamp();
                            await addDoc(collection(db, "purchaseOrders"), poData);
                        }
                        alert(`PO successfully ${status}!`);
                        loadPage('po-request'); // Reset the page
                    } catch (error) {
                        console.error("Error saving PO: ", error);
                        alert("Failed to save PO. See console for details.");
                    }
                }

                if (poDataToEdit) {
                    poRequestTitle.textContent = 'Edit Purchase Order';
                    poIdInput.value = poDataToEdit.id;
                    poNumberInput.value = poDataToEdit.poNumber;
                    reqDateInput.value = poDataToEdit.requestDate.toDate().toLocaleDateString('en-CA');
                    poItems = poDataToEdit.items;
                    renderPoItems();
                    // Dropdowns are populated via onSnapshot listeners above
                }

                saveDraftBtn.addEventListener('click', () => savePO('draft'));
                submitPoBtn.addEventListener('click', () => savePO('submitted'));
            }

            function setupShopList() {
                const addShopForm = document.getElementById('add-shop-form');
                const shopsListContainer = document.getElementById('shops-list-container');
                const shopFormTitle = document.getElementById('shop-form-title');
                const shopFormButtons = document.getElementById('shop-form-buttons');
                const shopIdInput = document.getElementById('shop-id');
                const shopNameInput = document.getElementById('shop-name');
                const shopContactInput = document.getElementById('shop-contact');
                const shopAddressInput = document.getElementById('shop-address');

                const resetShopForm = () => {
                    addShopForm.reset();
                    shopIdInput.value = '';
                    shopFormTitle.textContent = 'Add New Shop';
                    shopFormButtons.innerHTML = `
                        <button type="submit" class="bg-blue-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition duration-150 ease-in-out">
                            <i class="fas fa-plus-circle mr-2"></i>Add Shop
                        </button>`;
                }

                addShopForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const shopId = shopIdInput.value;
                    const shopData = {
                        name: shopNameInput.value,
                        contact: shopContactInput.value,
                        address: shopAddressInput.value,
                    };

                    try {
                        if (shopId) {
                            await updateDoc(doc(db, "shops", shopId), shopData);
                        } else {
                            await addDoc(collection(db, "shops"), shopData);
                        }
                        resetShopForm();
                    } catch (error) {
                        console.error("Error saving shop: ", error);
                    }
                });

                shopsListContainer.addEventListener('click', async (e) => {
                    const target = e.target.closest('button');
                    if (!target) return;

                    const shopId = target.dataset.id;
                    if (!shopId) return;

                    if (target.classList.contains('delete-shop')) {
                        try {
                            await deleteDoc(doc(db, "shops", shopId));
                            resetShopForm();
                        } catch (error) {
                            console.error("Error deleting shop: ", error);
                        }
                    }

                    if (target.classList.contains('edit-shop')) {
                        try {
                            const shopDoc = await getDoc(doc(db, "shops", shopId));
                            if (shopDoc.exists()) {
                                const shop = shopDoc.data();
                                shopIdInput.value = shopDoc.id;
                                shopNameInput.value = shop.name;
                                shopContactInput.value = shop.contact;
                                shopAddressInput.value = shop.address;
                                shopFormTitle.textContent = 'Edit Shop';
                                shopFormButtons.innerHTML = `
                                    <button type="button" id="cancel-edit-shop" class="bg-gray-500 text-white font-bold py-2 px-6 rounded-lg hover:bg-gray-600 mr-2">Cancel</button>
                                    <button type="submit" class="bg-green-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-green-700"><i class="fas fa-save mr-2"></i>Update Shop</button>
                                `;
                                document.getElementById('cancel-edit-shop').addEventListener('click', resetShopForm);
                                window.scrollTo(0, 0);
                            }
                        } catch (error) {
                            console.error("Error fetching shop for edit: ", error);
                        }
                    }
                });

                onSnapshot(collection(db, "shops"), (snapshot) => {
                    if (snapshot.empty) {
                        shopsListContainer.innerHTML = `<p class="p-4 text-gray-500 text-center">No shops have been added yet.</p>`;
                        return;
                    }
                    let tableHtml = `<table class="min-w-full divide-y divide-gray-200"><thead class="bg-gray-50"><tr><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">No.</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Contact</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Address</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th></tr></thead><tbody class="bg-white divide-y divide-gray-200">`;
                    let index = 1;
                    snapshot.forEach(doc => {
                        const shop = doc.data();
                        tableHtml += `<tr>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${index++}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${shop.name}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${shop.contact}</td>
                            <td class="px-6 py-4 text-sm text-gray-500">${shop.address}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium space-x-2">
                                <button data-id="${doc.id}" class="edit-shop text-blue-600 hover:text-blue-900"><i class="fas fa-edit"></i></button>
                                <button data-id="${doc.id}" class="delete-shop text-red-600 hover:text-red-900"><i class="fas fa-trash"></i></button>
                            </td>
                        </tr>`;
                    });
                    tableHtml += `</tbody></table>`;
                    shopsListContainer.innerHTML = tableHtml;
                });
            }

            function setupUserProfile() {
                const addUserForm = document.getElementById('add-user-form');
                const usersListContainer = document.getElementById('users-list-container');
                const userFormTitle = document.getElementById('user-form-title');
                const userFormButtons = document.getElementById('user-form-buttons');
                const userDocIdInput = document.getElementById('user-doc-id');
                const userNameInput = document.getElementById('user-name');
                const userEmailInput = document.getElementById('user-email');
                const userRoleInput = document.getElementById('user-role');
                const userUidInput = document.getElementById('user-uid');
                const userFormShops = document.getElementById('user-form-shops');
                const userFormPermissions = document.getElementById('user-form-permissions');

                const resetUserForm = () => {
                    addUserForm.reset();
                    userDocIdInput.value = '';
                    userFormTitle.textContent = 'Add New User';
                    userFormButtons.innerHTML = `
                        <button type="submit" class="bg-blue-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition duration-150 ease-in-out">
                            <i class="fas fa-plus-circle mr-2"></i>Add User
                        </button>`;
                };
                
                onSnapshot(collection(db, "shops"), (snapshot) => {
                    userFormShops.innerHTML = snapshot.empty ? `<p class="text-gray-500">Please add shops first.</p>` : snapshot.docs.map(doc => `<label class="flex items-center"><input type="checkbox" name="assignedShops" value="${doc.id}" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500 mr-2">${doc.data().name}</label>`).join('');
                });

                addUserForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const userDocId = userDocIdInput.value;
                    const userData = {
                        name: userNameInput.value,
                        email: userEmailInput.value,
                        role: userRoleInput.value,
                        assignedShops: Array.from(userFormShops.querySelectorAll('input[name="assignedShops"]:checked')).map(el => el.value),
                        permissions: Array.from(userFormPermissions.querySelectorAll('input[name="permissions"]:checked')).map(el => el.value),
                    };

                    try {
                        if (userDocId) {
                            await updateDoc(doc(db, "users", userDocId), userData);
                        } else {
                            const userDocRef = doc(collection(db, "users"));
                            await setDoc(userDocRef, { ...userData, uid: userDocRef.id });
                        }
                        resetUserForm();
                    } catch (error) {
                        console.error("Error saving user: ", error);
                    }
                });

                usersListContainer.addEventListener('click', async (e) => {
                    const target = e.target.closest('button');
                    if (!target) return;

                    const userId = target.dataset.id;
                    if (!userId) return;

                    if (target.classList.contains('delete-user')) {
                        try {
                            await deleteDoc(doc(db, "users", userId));
                            resetUserForm();
                        } catch (error) {
                            console.error("Error deleting user: ", error);
                        }
                    }

                    if (target.classList.contains('edit-user')) {
                        try {
                            const userDoc = await getDoc(doc(db, "users", userId));
                            if (userDoc.exists()) {
                                const user = userDoc.data();
                                userDocIdInput.value = userDoc.id;
                                userNameInput.value = user.name;
                                userEmailInput.value = user.email;
                                userRoleInput.value = user.role;
                                userUidInput.value = user.uid;

                                userFormShops.querySelectorAll('input').forEach(c => c.checked = false);
                                if(user.assignedShops) {
                                    user.assignedShops.forEach(shopId => {
                                        const checkbox = userFormShops.querySelector(`input[value="${shopId}"]`);
                                        if(checkbox) checkbox.checked = true;
                                    });
                                }

                                userFormPermissions.querySelectorAll('input').forEach(c => c.checked = false);
                                if(user.permissions) {
                                    user.permissions.forEach(perm => {
                                        const checkbox = userFormPermissions.querySelector(`input[value="${perm}"]`);
                                        if(checkbox) checkbox.checked = true;
                                    });
                                }

                                userFormTitle.textContent = 'Edit User';
                                userFormButtons.innerHTML = `
                                    <button type="button" id="cancel-edit-user" class="bg-gray-500 text-white font-bold py-2 px-6 rounded-lg hover:bg-gray-600 mr-2">Cancel</button>
                                    <button type="submit" class="bg-green-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-green-700"><i class="fas fa-save mr-2"></i>Update User</button>
                                `;
                                document.getElementById('cancel-edit-user').addEventListener('click', resetUserForm);
                                window.scrollTo(0, 0);
                            }
                        } catch (error) {
                            console.error("Error fetching user for edit: ", error);
                        }
                    }
                });

                 onSnapshot(collection(db, "users"), (snapshot) => {
                    if (snapshot.empty) {
                        usersListContainer.innerHTML = `<p class="p-4 text-gray-500 text-center">No users have been added yet.</p>`;
                        return;
                    }
                    let tableHtml = `<table class="min-w-full divide-y divide-gray-200"><thead class="bg-gray-50"><tr><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Email</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Role</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">UID</th><th class="relative px-6 py-3">Actions</th></tr></thead><tbody class="bg-white divide-y divide-gray-200">`;
                    snapshot.forEach(doc => {
                        const user = doc.data();
                        tableHtml += `<tr>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${user.name}</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${user.email}</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${user.role}</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500" style="word-break: break-all;">${user.uid}</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium space-x-2">
                                            <button data-id="${doc.id}" class="edit-user text-blue-600 hover:text-blue-900"><i class="fas fa-edit"></i></button>
                                            <button data-id="${doc.id}" class="delete-user text-red-600 hover:text-red-900"><i class="fas fa-trash"></i></button>
                                        </td>
                                      </tr>`;
                    });
                    tableHtml += `</tbody></table>`;
                    usersListContainer.innerHTML = tableHtml;
                });
            }

            function setupProductList() {
                const importBtn = document.getElementById('import-product-btn');
                const templateBtn = document.getElementById('download-template-btn');
                const exportBtn = document.getElementById('export-product-btn');
                const fileInput = document.getElementById('product-csv-input');

                const addProductForm = document.getElementById('add-product-form');
                const productsListContainer = document.getElementById('products-list-container');
                const productFormTitle = document.getElementById('product-form-title');
                const productFormButtons = document.getElementById('product-form-buttons');
                const productIdInput = document.getElementById('product-id');
                const productCodeInput = document.getElementById('product-code');
                const productBarcodeInput = document.getElementById('product-barcode');
                const productNameInput = document.getElementById('product-name');
                const productVendorSelect = document.getElementById('product-vendor');
                const productCostInput = document.getElementById('product-cost');
                const productPriceInput = document.getElementById('product-price');
                const productNoteInput = document.getElementById('product-note');

                // --- Import/Export/Template Logic ---
                importBtn.addEventListener('click', () => fileInput.click());
                templateBtn.addEventListener('click', downloadProductTemplate);
                exportBtn.addEventListener('click', exportProductsToCSV);
                fileInput.addEventListener('change', handleProductImport);

                function downloadProductTemplate() {
                    const headers = ["Product Code", "Barcode", "Product Name", "Vendor Name", "Cost", "Sale Price", "Note"];
                    const csvContent = "data:text/csv;charset=utf-8," + headers.join(",");
                    const encodedUri = encodeURI(csvContent);
                    const link = document.createElement("a");
                    link.setAttribute("href", encodedUri);
                    link.setAttribute("download", "product_template.csv");
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                }

                async function exportProductsToCSV() {
                    const productsQuery = await getDocs(collection(db, "products"));
                    let csvContent = "data:text/csv;charset=utf-8,";
                    const headers = ["Product Code", "Barcode", "Product Name", "Vendor Name", "Cost", "Sale Price", "Note"];
                    csvContent += headers.join(",") + "\r\n";

                    productsQuery.forEach(doc => {
                        const product = doc.data();
                        const row = [
                            `"${product.code || ''}"`,
                            `"${product.barcode || ''}"`,
                            `"${product.name || ''}"`,
                            `"${product.vendorName || ''}"`,
                            product.cost || 0,
                            product.price || 0,
                            `"${product.note || ''}"`
                        ];
                        csvContent += row.join(",") + "\r\n";
                    });

                    const encodedUri = encodeURI(csvContent);
                    const link = document.createElement("a");
                    link.setAttribute("href", encodedUri);
                    link.setAttribute("download", "products.csv");
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                }

                async function handleProductImport(event) {
                    const file = event.target.files[0];
                    if (!file) return;

                    const reader = new FileReader();
                    reader.onload = async (e) => {
                        const text = e.target.result;
                        const lines = text.split('\n').filter(line => line.trim() !== '');
                        const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
                        
                        const requiredHeaders = ["Product Code", "Product Name", "Vendor Name", "Cost", "Sale Price"];
                        const missingHeaders = requiredHeaders.filter(h => !headers.includes(h));
                        if(missingHeaders.length > 0) {
                            console.error(`CSV is missing required headers: ${missingHeaders.join(', ')}`);
                            return;
                        }

                        const batch = writeBatch(db);
                        const vendorsCache = {}; // Cache to avoid repeated lookups

                        for (let i = 1; i < lines.length; i++) {
                            const data = lines[i].split(',').map(d => d.trim().replace(/"/g, ''));
                            let rowData = {};
                            headers.forEach((header, index) => {
                                rowData[header] = data[index];
                            });

                            const vendorName = rowData["Vendor Name"];
                            let vendorId = vendorsCache[vendorName];

                            if (!vendorId) {
                                const vendorQuery = query(collection(db, "vendors"), where("name", "==", vendorName));
                                const querySnapshot = await getDocs(vendorQuery);
                                if (!querySnapshot.empty) {
                                    vendorId = querySnapshot.docs[0].id;
                                    vendorsCache[vendorName] = vendorId;
                                } else {
                                    console.warn(`Vendor "${vendorName}" not found for product "${rowData["Product Name"]}". Skipping.`);
                                    continue; // Skip this product if vendor not found
                                }
                            }

                            const productRef = doc(collection(db, "products"));
                            batch.set(productRef, {
                                code: rowData["Product Code"],
                                barcode: rowData["Barcode"] || "",
                                name: rowData["Product Name"],
                                vendorId: vendorId,
                                vendorName: vendorName,
                                cost: parseFloat(rowData["Cost"]) || 0,
                                price: parseFloat(rowData["Sale Price"]) || 0,
                                note: rowData["Note"] || ""
                            });
                        }

                        try {
                            await batch.commit();
                            console.log('Products imported successfully!');
                        } catch (error) {
                            console.error('Error importing products: ', error);
                        }
                    };
                    reader.readAsText(file);
                    fileInput.value = ''; // Reset file input
                }


                // Populate vendor dropdown
                onSnapshot(collection(db, "vendors"), (snapshot) => {
                    let optionsHtml = '<option value="">Select Vendor</option>';
                    snapshot.forEach(doc => {
                        optionsHtml += `<option value="${doc.id}" data-name="${doc.data().name}">${doc.data().name}</option>`;
                    });
                    productVendorSelect.innerHTML = optionsHtml;
                });

                const resetProductForm = () => {
                    addProductForm.reset();
                    productIdInput.value = '';
                    productFormTitle.textContent = 'Add New Product';
                    productFormButtons.innerHTML = `
                        <button type="submit" class="bg-blue-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition duration-150 ease-in-out">
                            <i class="fas fa-plus-circle mr-2"></i>Add Product
                        </button>`;
                };

                addProductForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const productId = productIdInput.value;
                    const selectedVendorOption = productVendorSelect.options[productVendorSelect.selectedIndex];
                    const productData = {
                        code: productCodeInput.value,
                        barcode: productBarcodeInput.value,
                        name: productNameInput.value,
                        vendorId: selectedVendorOption.value,
                        vendorName: selectedVendorOption.dataset.name,
                        cost: parseFloat(productCostInput.value),
                        price: parseFloat(productPriceInput.value),
                        note: productNoteInput.value,
                    };

                    try {
                        if (productId) {
                            await updateDoc(doc(db, "products", productId), productData);
                        } else {
                            await addDoc(collection(db, "products"), productData);
                        }
                        resetProductForm();
                    } catch (error) {
                        console.error("Error saving product: ", error);
                    }
                });

                productsListContainer.addEventListener('click', async (e) => {
                    const target = e.target.closest('button');
                    if (!target) return;

                    const productId = target.dataset.id;
                    if (!productId) return;

                    if (target.classList.contains('delete-product')) {
                        try {
                            await deleteDoc(doc(db, "products", productId));
                            resetProductForm();
                        } catch (error) {
                            console.error("Error deleting product: ", error);
                        }
                    }

                    if (target.classList.contains('edit-product')) {
                        try {
                            const productDoc = await getDoc(doc(db, "products", productId));
                            if (productDoc.exists()) {
                                const product = productDoc.data();
                                productIdInput.value = productDoc.id;
                                productCodeInput.value = product.code;
                                productBarcodeInput.value = product.barcode;
                                productNameInput.value = product.name;
                                productVendorSelect.value = product.vendorId;
                                productCostInput.value = product.cost;
                                productPriceInput.value = product.price;
                                productNoteInput.value = product.note;

                                productFormTitle.textContent = 'Edit Product';
                                productFormButtons.innerHTML = `
                                    <button type="button" id="cancel-edit-product" class="bg-gray-500 text-white font-bold py-2 px-6 rounded-lg hover:bg-gray-600 mr-2">Cancel</button>
                                    <button type="submit" class="bg-green-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-green-700"><i class="fas fa-save mr-2"></i>Update Product</button>
                                `;
                                document.getElementById('cancel-edit-product').addEventListener('click', resetProductForm);
                                window.scrollTo(0, 0);
                            }
                        } catch (error) {
                            console.error("Error fetching product for edit: ", error);
                        }
                    }
                });

                onSnapshot(collection(db, "products"), (snapshot) => {
                    if (snapshot.empty) {
                        productsListContainer.innerHTML = `<p class="p-4 text-gray-500 text-center">No products have been added yet.</p>`;
                        return;
                    }
                    let tableHtml = `<table class="min-w-full divide-y divide-gray-200"><thead class="bg-gray-50"><tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Code</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Vendor</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Cost</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Price</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                    </tr></thead><tbody class="bg-white divide-y divide-gray-200">`;
                    snapshot.forEach(doc => {
                        const product = doc.data();
                        tableHtml += `<tr>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${product.code}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${product.name}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${product.vendorName || ''}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${product.cost}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${product.price}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium space-x-2">
                                <button data-id="${doc.id}" class="edit-product text-blue-600 hover:text-blue-900"><i class="fas fa-edit"></i></button>
                                <button data-id="${doc.id}" class="delete-product text-red-600 hover:text-red-900"><i class="fas fa-trash"></i></button>
                            </td>
                        </tr>`;
                    });
                    tableHtml += `</tbody></table>`;
                    productsListContainer.innerHTML = tableHtml;
                });
            }

            function setupVendorList() {
                const importVendorBtn = document.getElementById('import-vendor-btn');
                const vendorCsvInput = document.getElementById('vendor-csv-input');
                const addVendorForm = document.getElementById('add-vendor-form');
                const vendorsListContainer = document.getElementById('vendors-list-container');
                const vendorFormTitle = document.getElementById('vendor-form-title');
                const vendorFormButtons = document.getElementById('vendor-form-buttons');
                const vendorIdInput = document.getElementById('vendor-id');
                const vendorNameInput = document.getElementById('vendor-name');
                const vendorContactInput = document.getElementById('vendor-contact');

                importVendorBtn.addEventListener('click', () => vendorCsvInput.click());
                vendorCsvInput.addEventListener('change', handleVendorImport);

                async function handleVendorImport(event) {
                    const file = event.target.files[0];
                    if (!file) return;

                    const reader = new FileReader();
                    reader.onload = async (e) => {
                        const text = e.target.result;
                        const rows = text.split('\n').slice(1); // Skip header row
                        const batch = writeBatch(db);

                        rows.forEach(row => {
                            const columns = row.split(',');
                            if (columns.length >= 2) {
                                const vendorRef = doc(collection(db, "vendors"));
                                batch.set(vendorRef, { 
                                    name: columns[0].trim(), 
                                    contact: columns[1].trim() 
                                });
                            }
                        });

                        try {
                            await batch.commit();
                            console.log('Vendors imported successfully!');
                        } catch (error) {
                            console.error('Error importing vendors: ', error);
                        }
                    };
                    reader.readAsText(file);
                    vendorCsvInput.value = ''; // Reset file input
                }

                const resetVendorForm = () => {
                    addVendorForm.reset();
                    vendorIdInput.value = '';
                    vendorFormTitle.textContent = 'Add New Vendor';
                    vendorFormButtons.innerHTML = `
                        <button type="submit" class="bg-blue-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition duration-150 ease-in-out">
                            <i class="fas fa-plus-circle mr-2"></i>Add Vendor
                        </button>`;
                }

                addVendorForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const vendorId = vendorIdInput.value;
                    const vendorData = {
                        name: vendorNameInput.value,
                        contact: vendorContactInput.value,
                    };

                    try {
                        if (vendorId) {
                            await updateDoc(doc(db, "vendors", vendorId), vendorData);
                        } else {
                            await addDoc(collection(db, "vendors"), vendorData);
                        }
                        resetVendorForm();
                    } catch (error) {
                        console.error("Error saving vendor: ", error);
                    }
                });

                vendorsListContainer.addEventListener('click', async (e) => {
                    const target = e.target.closest('button');
                    if (!target) return;

                    const vendorId = target.dataset.id;
                    if (!vendorId) return;

                    if (target.classList.contains('delete-vendor')) {
                        try {
                            await deleteDoc(doc(db, "vendors", vendorId));
                            resetVendorForm();
                        } catch (error) {
                            console.error("Error deleting vendor: ", error);
                        }
                    }

                    if (target.classList.contains('edit-vendor')) {
                        try {
                            const vendorDoc = await getDoc(doc(db, "vendors", vendorId));
                            if (vendorDoc.exists()) {
                                const vendor = vendorDoc.data();
                                vendorIdInput.value = vendorDoc.id;
                                vendorNameInput.value = vendor.name;
                                vendorContactInput.value = vendor.contact;
                                vendorFormTitle.textContent = 'Edit Vendor';
                                vendorFormButtons.innerHTML = `
                                    <button type="button" id="cancel-edit-vendor" class="bg-gray-500 text-white font-bold py-2 px-6 rounded-lg hover:bg-gray-600 mr-2">Cancel</button>
                                    <button type="submit" class="bg-green-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-green-700"><i class="fas fa-save mr-2"></i>Update Vendor</button>
                                `;
                                document.getElementById('cancel-edit-vendor').addEventListener('click', resetVendorForm);
                                window.scrollTo(0, 0);
                            }
                        } catch (error) {
                            console.error("Error fetching vendor for edit: ", error);
                        }
                    }
                });

                onSnapshot(collection(db, "vendors"), (snapshot) => {
                    if (snapshot.empty) {
                        vendorsListContainer.innerHTML = `<p class="p-4 text-gray-500 text-center">No vendors have been added yet.</p>`;
                        return;
                    }
                    let tableHtml = `<table class="min-w-full divide-y divide-gray-200"><thead class="bg-gray-50"><tr><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Contact</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th></tr></thead><tbody class="bg-white divide-y divide-gray-200">`;
                    snapshot.forEach(doc => {
                        const vendor = doc.data();
                        tableHtml += `<tr>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${vendor.name}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${vendor.contact}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium space-x-2">
                                <button data-id="${doc.id}" class="edit-vendor text-blue-600 hover:text-blue-900"><i class="fas fa-edit"></i></button>
                                <button data-id="${doc.id}" class="delete-vendor text-red-600 hover:text-red-900"><i class="fas fa-trash"></i></button>
                            </td>
                        </tr>`;
                    });
                    tableHtml += `</tbody></table>`;
                    vendorsListContainer.innerHTML = tableHtml;
                });
            }


            // --- Event Listeners ---
            sidebarToggle.addEventListener('click', toggleSidebar);
            overlay.addEventListener('click', toggleSidebar);

            sidebarLinks.forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const pageKey = e.currentTarget.dataset.page;
                    sidebarLinks.forEach(l => l.classList.remove('active'));
                    e.currentTarget.classList.add('active');
                    loadPage(pageKey);
                    if (window.innerWidth < 768) toggleSidebar();
                });
            });
            
            // --- Initial Load ---
            loadPage('po-request');

            // --- Style for active tabs ---
            const style = document.createElement('style');
            style.innerHTML = `
                .tab-link.active-tab { color: #3b82f6; border-color: #3b82f6; }
                .tab-link { color: #6b7280; border-color: transparent; }
                .tab-link:hover { color: #1f2937; border-color: #d1d5db; }
            `;
            document.head.appendChild(style);
        }
    </script>
</body>
</html>
