<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Purchase Order System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" xintegrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Custom scrollbar for better aesthetics */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        /* Active state for sidebar links */
        .sidebar-link.active {
            background-color: #3b82f6; /* blue-600 */
            color: white;
        }
        #product-search-results div:hover {
            background-color: #e5e7eb; /* gray-200 */
        }
        /* Styles for the printable PO */
        #po-printable {
            position: absolute;
            left: -9999px;
            width: 1123px; /* A4 landscape width in pixels at 96 DPI */
            height: 794px; /* A4 landscape height in pixels at 96 DPI */
            background: white;
            padding: 40px;
            font-size: 12px;
            color: #000;
        }
        /* Styles for Audit Modal */
        #audit-modal-backdrop {
            background-color: rgba(0, 0, 0, 0.5);
        }
        .audit-input {
             width: 100%;
             text-align: right;
             padding: 4px 8px;
             border: 1px solid #d1d5db;
             border-radius: 0.375rem;
        }
        .calculated-field {
            text-align: right;
            padding: 4px 8px;
            background-color: #f3f4f6;
        }
        /* Simple loader for login button */
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100">
    <!-- App content will be rendered here by JavaScript based on auth state -->
    <div id="app-container" class="flex items-center justify-center h-screen">
        <div class="text-center">
            <i class="fas fa-spinner fa-spin text-5xl text-gray-400 mb-4"></i>
            <h3 class="text-3xl font-bold text-gray-700">Loading Application...</h3>
            <p class="text-gray-500 mt-2">Please wait.</p>
        </div>
    </div>
    
    <!-- Firebase SDKs -->
    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, setDoc, getDoc, updateDoc, deleteDoc, writeBatch, getDocs, query, where, serverTimestamp, Timestamp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";

        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAsw_K2LarDunqh9ePnSRuMjXrzd6WZ1EI",
            authDomain: "posystem-3e373.firebaseapp.com",
            projectId: "posystem-3e373",
            storageBucket: "posystem-3e373.appspot.com",
            messagingSenderId: "783169032599",
            appId: "1:783169032599:web:d44e8956e790a7f9b3b4d2",
            measurementId: "G-G6B8H6HSQC"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth();
        const db = getFirestore(app);
        
        const appContainer = document.getElementById('app-container');
        let currentUserId = null;
        let currentUserProfile = null;

        // --- HTML TEMPLATES ---

        const loginPageHtml = `
            <div class="flex items-center justify-center h-screen bg-gray-200 p-4">
                <div class="w-full max-w-md p-8 space-y-6 bg-white rounded-lg shadow-md">
                    <div class="text-center">
                        <i class="fas fa-file-invoice-dollar text-4xl text-blue-500"></i>
                        <h1 class="text-2xl font-bold text-gray-700 mt-2">PO System Login</h1>
                    </div>
                    <form id="login-form" class="space-y-6">
                        <div id="login-error" class="hidden bg-red-100 text-red-700 p-3 rounded-lg text-center"></div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Email</label>
                            <input type="email" id="login-email" class="w-full px-3 py-2 mt-1 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" required />
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Password</label>
                            <input type="password" id="login-password" class="w-full px-3 py-2 mt-1 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" required />
                        </div>
                        <div>
                            <button type="submit" id="login-button" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 disabled:bg-blue-300">
                                <span id="login-button-text">Login</span>
                                <div id="login-loader" class="loader hidden"></div>
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        `;
        
        const mainAppHtml = `
            <div class="flex h-screen bg-gray-200">
                <!-- Sidebar -->
                <aside id="sidebar" class="w-64 bg-gray-800 text-white p-4 transform -translate-x-full md:translate-x-0 transition-transform duration-300 ease-in-out z-30 fixed md:relative h-full">
                    <div class="flex items-center mb-8">
                        <i class="fas fa-file-invoice-dollar text-3xl text-blue-400 mr-3"></i>
                        <h1 class="text-2xl font-bold">PO System</h1>
                    </div>
                    <nav>
                        <a href="#" class="sidebar-link active flex items-center py-3 px-4 rounded-lg transition duration-200 hover:bg-gray-700" data-page="po-request">
                            <i class="fas fa-paper-plane w-6 mr-3"></i>
                            <span>PO Request</span>
                        </a>
                        <a href="#" class="sidebar-link flex items-center py-3 px-4 rounded-lg transition duration-200 hover:bg-gray-700" data-page="po-center">
                            <i class="fas fa-inbox w-6 mr-3"></i>
                            <span>PO Center</span>
                        </a>
                        <a href="#" class="sidebar-link flex items-center py-3 px-4 rounded-lg transition duration-200 hover:bg-gray-700" data-page="product-data">
                            <i class="fas fa-database w-6 mr-3"></i>
                            <span>Product Data</span>
                        </a>
                        <a href="#" class="sidebar-link flex items-center py-3 px-4 rounded-lg transition duration-200 hover:bg-gray-700" data-page="settings">
                            <i class="fas fa-cog w-6 mr-3"></i>
                            <span>Settings</span>
                        </a>
                    </nav>
                </aside>

                <!-- Main Content -->
                <div class="flex-1 flex flex-col overflow-hidden">
                    <!-- Header -->
                    <header class="bg-white shadow-md p-4 flex justify-between items-center">
                        <button id="sidebar-toggle" class="text-gray-500 focus:outline-none md:hidden">
                            <i class="fas fa-bars text-2xl"></i>
                        </button>
                        <h2 id="page-title" class="text-xl sm:text-2xl font-semibold text-gray-800 truncate">PO Request</h2>
                        <div id="user-info-header" class="flex items-center">
                            <!-- User info and logout button will be injected here -->
                        </div>
                    </header>

                    <!-- Content Area -->
                    <main class="flex-1 overflow-x-hidden overflow-y-auto bg-gray-100 p-3 sm:p-6">
                        <div id="page-content" class="bg-white p-4 sm:p-6 rounded-lg shadow-md">
                            <!-- Page content will be injected here -->
                        </div>
                    </main>
                </div>
            </div>

            <!-- Overlay for mobile sidebar -->
            <div id="overlay" class="fixed inset-0 bg-black opacity-50 z-20 hidden md:hidden"></div>

            <!-- Modal Container -->
            <div id="audit-modal-backdrop" class="fixed inset-0 z-40 hidden items-center justify-center p-4">
                <div id="audit-modal" class="bg-white rounded-lg shadow-xl w-full max-w-lg md:max-w-4xl lg:max-w-7xl max-h-[95vh] flex flex-col">
                    <!-- Modal content will be injected here -->
                </div>
            </div>
        `;


        // --- AUTHENTICATION CONTROLLER ---
        
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                // User is signed in. Check for their profile in Firestore.
                const usersRef = collection(db, "users");
                const q = query(usersRef, where("uid", "==", user.uid));
                const querySnapshot = await getDocs(q);

                if (!querySnapshot.empty) {
                    const userDoc = querySnapshot.docs[0];
                    currentUserId = user.uid;
                    currentUserProfile = { id: userDoc.id, ...userDoc.data() };
                    
                    // Render the main application
                    appContainer.innerHTML = mainAppHtml;
                    initializeAppLogic();
                } else {
                    // User is authenticated but has no profile in the system.
                    console.error("No user profile found for UID:", user.uid);
                    await signOut(auth);
                    // The onAuthStateChanged will fire again, showing the login page with an error.
                    const urlParams = new URLSearchParams(window.location.search);
                    if (!urlParams.has('error')) {
                         window.location.href = window.location.pathname + '?error=no_profile';
                    }
                }
            } else {
                // User is signed out. Render the login page.
                appContainer.innerHTML = loginPageHtml;
                initializeLoginPageLogic();
            }
        });

        // --- LOGIN PAGE LOGIC ---

        function initializeLoginPageLogic() {
            const loginForm = document.getElementById('login-form');
            const emailInput = document.getElementById('login-email');
            const passwordInput = document.getElementById('login-password');
            const errorDiv = document.getElementById('login-error');
            const loginButton = document.getElementById('login-button');
            const loginButtonText = document.getElementById('login-button-text');
            const loginLoader = document.getElementById('login-loader');

            // Check for URL errors
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('error') === 'no_profile') {
                errorDiv.textContent = "Login successful, but no user profile found. Please contact an administrator.";
                errorDiv.classList.remove('hidden');
            }

            loginForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const email = emailInput.value;
                const password = passwordInput.value;

                if (!email || !password) {
                    errorDiv.textContent = "Please enter both email and password.";
                    errorDiv.classList.remove('hidden');
                    return;
                }

                // Show loading state
                loginButton.disabled = true;
                loginButtonText.classList.add('hidden');
                loginLoader.classList.remove('hidden');
                errorDiv.classList.add('hidden');

                try {
                    await signInWithEmailAndPassword(auth, email, password);
                    // onAuthStateChanged will handle the redirect to the main app
                } catch (err) {
                    console.error("Login error:", err);
                    errorDiv.textContent = "Failed to login. Please check your credentials.";
                    errorDiv.classList.remove('hidden');
                    // Reset button state
                    loginButton.disabled = false;
                    loginButtonText.classList.remove('hidden');
                    loginLoader.classList.add('hidden');
                }
            });
        }


        // --- MAIN APPLICATION LOGIC ---

        function initializeAppLogic() {
            const sidebar = document.getElementById('sidebar');
            const sidebarToggle = document.getElementById('sidebar-toggle');
            const overlay = document.getElementById('overlay');
            const pageTitle = document.getElementById('page-title');
            const pageContent = document.getElementById('page-content');
            const sidebarLinks = document.querySelectorAll('.sidebar-link');
            const userInfoHeader = document.getElementById('user-info-header');

            // --- Setup Header with User Info & Logout ---
            userInfoHeader.innerHTML = `
                <span class="mr-4 text-gray-700 hidden sm:inline">Welcome, <strong>${currentUserProfile.name}</strong></span>
                <button id="logout-btn" class="bg-red-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-600 transition duration-150">
                    <i class="fas fa-sign-out-alt sm:mr-2"></i><span class="hidden sm:inline">Logout</span>
                </button>
            `;
            document.getElementById('logout-btn').addEventListener('click', () => {
                signOut(auth);
            });

            // --- Role-Based Access Control (RBAC) for Sidebar ---
            const allowedPages = currentUserProfile.permissions || [];
            let firstAllowedPage = null;

            sidebarLinks.forEach(link => {
                const pageKey = link.dataset.page;
                if (allowedPages.includes(pageKey)) {
                    if (!firstAllowedPage) {
                        firstAllowedPage = pageKey; // Determine the first accessible page
                    }
                } else {
                    link.style.display = 'none'; // Hide disallowed links
                }
            });
            
            // Set the active link to be the first allowed page
            sidebarLinks.forEach(link => {
                link.classList.remove('active');
                if (link.dataset.page === firstAllowedPage) {
                    link.classList.add('active');
                }
            });


            // --- Caches ---
            const usersCache = new Map();

            // --- Pre-load and cache data ---
            function listenForUsers() {
                onSnapshot(collection(db, "users"), (snapshot) => {
                    snapshot.forEach(doc => {
                        const user = doc.data();
                        if (user.uid) {
                            usersCache.set(user.uid, user);
                        }
                    });
                });
            }

            // --- Custom Modal Functions ---
            function showModalMessage(title, message, isError = false) {
                const modalBackdrop = document.getElementById('audit-modal-backdrop');
                const modal = document.getElementById('audit-modal');
                const titleColor = isError ? 'text-red-600' : 'text-gray-800';
                const icon = isError ? '<i class="fas fa-exclamation-circle text-red-500 text-3xl mr-4"></i>' : '<i class="fas fa-info-circle text-blue-500 text-3xl mr-4"></i>';

                modal.innerHTML = `
                    <div class="p-4 border-b border-gray-200 flex justify-between items-center">
                        <h3 class="text-xl font-semibold ${titleColor}">${title}</h3>
                        <button id="close-message-modal-btn" class="text-gray-500 hover:text-gray-800 text-2xl">&times;</button>
                    </div>
                    <div class="p-6 flex items-center">
                        ${icon}
                        <p>${message}</p>
                    </div>
                    <div class="p-4 border-t border-gray-200 flex justify-end">
                        <button id="close-message-modal-btn-2" type="button" class="bg-blue-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-700">OK</button>
                    </div>
                `;
                modalBackdrop.classList.remove('hidden');
                modalBackdrop.classList.add('flex');

                const closeModal = () => {
                    modalBackdrop.classList.add('hidden');
                    modalBackdrop.classList.remove('flex');
                    modal.innerHTML = '';
                };

                modal.querySelector('#close-message-modal-btn').addEventListener('click', closeModal);
                modal.querySelector('#close-message-modal-btn-2').addEventListener('click', closeModal);
            }

            function showConfirmation(title, message, onConfirm) {
                const modalBackdrop = document.getElementById('audit-modal-backdrop');
                const modal = document.getElementById('audit-modal');

                modal.innerHTML = `
                    <div class="p-4 border-b border-gray-200">
                        <h3 class="text-xl font-semibold text-gray-800">${title}</h3>
                    </div>
                    <div class="p-6 flex items-center">
                        <i class="fas fa-question-circle text-yellow-500 text-3xl mr-4"></i>
                        <p>${message}</p>
                    </div>
                    <div class="p-4 border-t border-gray-200 flex justify-end gap-4">
                        <button id="confirm-cancel-btn" type="button" class="bg-gray-500 text-white font-bold py-2 px-6 rounded-lg hover:bg-gray-600">Cancel</button>
                        <button id="confirm-ok-btn" type="button" class="bg-red-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-red-700">Confirm</button>
                    </div>
                `;
                modalBackdrop.classList.remove('hidden');
                modalBackdrop.classList.add('flex');
                
                const closeModal = () => {
                    modalBackdrop.classList.add('hidden');
                    modalBackdrop.classList.remove('flex');
                    modal.innerHTML = '';
                };

                modal.querySelector('#confirm-cancel-btn').addEventListener('click', closeModal);
                modal.querySelector('#confirm-ok-btn').addEventListener('click', () => {
                    closeModal();
                    onConfirm(); // Execute the callback function
                });
            }

            // --- Page Content Templates ---
            const pages = {
                'po-request': {
                    title: 'PO Request',
                    content: `
                        <h3 id="po-request-title" class="text-2xl font-semibold text-gray-800 mb-6">Create Purchase Order</h3>
                        <input type="hidden" id="po-id">
                        
                        <!-- PO Details Form -->
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 md:gap-6 mb-8 p-4 sm:p-6 border border-gray-200 rounded-lg bg-gray-50">
                            <div><label for="po-shop-name" class="block text-sm font-medium text-gray-700 mb-1">Shop Name</label><select id="po-shop-name" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" required><option value="">Loading Shops...</option></select></div>
                            <div><label for="po-vendor" class="block text-sm font-medium text-gray-700 mb-1">Vendor</label><select id="po-vendor" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" required><option value="">Loading Vendors...</option></select></div>
                            <div><label for="po-number" class="block text-sm font-medium text-gray-700 mb-1">PO No.</label><input type="text" id="po-number" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm bg-gray-100" readonly></div>
                            <div><label for="po-req-date" class="block text-sm font-medium text-gray-700 mb-1">Req Date</label><input type="text" id="po-req-date" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm bg-gray-100" readonly></div>
                        </div>

                        <!-- Add Product Form -->
                        <div class="mb-8 p-4 sm:p-6 border border-gray-200 rounded-lg bg-gray-50">
                            <h4 class="text-xl font-medium mb-4 text-gray-700">Add Product to PO</h4>
                            <form id="add-po-item-form" class="grid grid-cols-1 md:grid-cols-12 gap-4 items-end space-y-4 md:space-y-0">
                                <div class="md:col-span-4 relative">
                                    <label for="po-product-search" class="block text-sm font-medium text-gray-700 mb-1">Product Code/Barcode/Name</label>
                                    <input type="text" id="po-product-search" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" autocomplete="off">
                                    <div id="product-search-results" class="absolute z-10 w-full bg-white border border-gray-300 rounded-md mt-1 shadow-lg max-h-60 overflow-y-auto hidden"></div>
                                </div>
                                <div class="md:col-span-5">
                                    <label for="po-product-name" class="block text-sm font-medium text-gray-700 mb-1">Product Name</label>
                                    <input type="text" id="po-product-name" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm bg-gray-100" readonly>
                                    <input type="hidden" id="po-selected-product-id">
                                    <input type="hidden" id="po-selected-product-code">
                                    <input type="hidden" id="po-selected-product-barcode">
                                    <input type="hidden" id="po-selected-product-vendor-name">
                                    <input type="hidden" id="po-selected-product-cost">
                                </div>
                                <div class="md:col-span-2">
                                    <label for="po-item-quantity" class="block text-sm font-medium text-gray-700 mb-1">Quantity</label>
                                    <input type="number" id="po-item-quantity" min="1" value="1" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                </div>
                                <div class="md:col-span-1">
                                    <button type="submit" class="w-full bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition duration-150 ease-in-out">Add</button>
                                </div>
                            </form>
                        </div>

                        <!-- PO Items List -->
                        <div>
                            <h4 class="text-xl font-medium mb-4 text-gray-700">PO Items</h4>
                            <div id="po-items-container" class="bg-white rounded-lg shadow overflow-x-auto">
                                <p class="p-4 text-gray-500 text-center">No products added yet.</p>
                            </div>
                        </div>
                        
                        <!-- PO Actions -->
                        <div class="mt-8 flex flex-wrap justify-end gap-3">
                            <button id="cancel-po-req" class="bg-red-500 text-white font-bold py-2 px-6 rounded-lg hover:bg-red-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500">Cancel Req.</button>
                            <button id="save-draft-po" class="bg-yellow-500 text-white font-bold py-2 px-6 rounded-lg hover:bg-yellow-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-yellow-500">Save Draft</button>
                            <button id="submit-po" class="bg-green-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">Submit PO</button>
                        </div>
                    <!-- Hidden Printable PO Template -->
                    <div id="po-printable"></div>
                    `
                },
                'po-center': {
                    title: 'PO Center',
                    content: `<div class="mb-6 border-b border-gray-200"><nav class="flex -mb-px overflow-x-auto" aria-label="Tabs" id="po-center-tabs"><a href="#" class="tab-link active-tab whitespace-nowrap py-4 px-6 border-b-2 font-medium text-lg" data-tab="drafts-po">Drafts PO</a><a href="#" class="tab-link whitespace-nowrap py-4 px-6 border-b-2 font-medium text-lg" data-tab="active-po">Active PO</a><a href="#" class="tab-link whitespace-nowrap py-4 px-6 border-b-2 font-medium text-lg" data-tab="audited-po">Audited PO</a></nav></div><div id="po-center-tab-content"></div>`
                },
                'product-data': {
                    title: 'Product Data',
                    content: `<div class="mb-6 border-b border-gray-200"><nav class="flex -mb-px overflow-x-auto" aria-label="Tabs" id="product-data-tabs"><a href="#" class="tab-link active-tab whitespace-nowrap py-4 px-6 border-b-2 font-medium text-lg" data-tab="product-list">Product List</a><a href="#" class="tab-link whitespace-nowrap py-4 px-6 border-b-2 font-medium text-lg" data-tab="vendor-list">Vendor List</a></nav></div><div id="product-data-tab-content"></div>`
                },
                'settings': {
                    title: 'Settings',
                    content: `<div class="mb-6 border-b border-gray-200"><nav class="flex -mb-px overflow-x-auto" aria-label="Tabs" id="settings-tabs"><a href="#" class="tab-link active-tab whitespace-nowrap py-4 px-6 border-b-2 font-medium text-lg" data-tab="shop-list">Shop List</a><a href="#" class="tab-link whitespace-nowrap py-4 px-6 border-b-2 font-medium text-lg" data-tab="user-profile">User Profile</a></nav></div><div id="settings-tab-content"></div>`
                }
            };

            const poCenterTabs = {
                'drafts-po': `<div id="drafts-po-container"></div>`,
                'active-po': `<div id="active-po-container"></div>`,
                'audited-po': `<div id="audited-po-container"></div>`
            };

            const productDataTabs = {
                'product-list': `
                    <div>
                        <div class="flex justify-between items-center mb-6 flex-wrap gap-4">
                            <h3 class="text-2xl font-semibold text-gray-800">Product Data</h3>
                            <div class="flex flex-wrap items-center gap-2">
                                <button id="import-product-btn" class="bg-teal-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-teal-600 transition duration-150 ease-in-out">
                                    <i class="fas fa-file-import mr-2"></i>Import
                                </button>
                                <button id="download-template-btn" class="bg-gray-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-gray-600 transition duration-150 ease-in-out">
                                    <i class="fas fa-download mr-2"></i>Template
                                </button>
                                <button id="export-product-btn" class="bg-green-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-600 transition duration-150 ease-in-out">
                                    <i class="fas fa-file-export mr-2"></i>Export
                                </button>
                                <input type="file" id="product-csv-input" class="hidden" accept=".csv">
                            </div>
                        </div>
                        <div class="mb-8 p-4 sm:p-6 border border-gray-200 rounded-lg bg-gray-50">
                            <h4 id="product-form-title" class="text-xl font-medium mb-4 text-gray-700">Add New Product</h4>
                            <form id="add-product-form">
                                <input type="hidden" id="product-id">
                                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 md:gap-6">
                                    <div><label for="product-code" class="block text-sm font-medium text-gray-700 mb-1">Product Code</label><input type="text" id="product-code" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" required></div>
                                    <div><label for="product-barcode" class="block text-sm font-medium text-gray-700 mb-1">Barcode</label><input type="text" id="product-barcode" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"></div>
                                    <div><label for="product-name" class="block text-sm font-medium text-gray-700 mb-1">Product Name</label><input type="text" id="product-name" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" required></div>
                                    <div><label for="product-vendor" class="block text-sm font-medium text-gray-700 mb-1">Vendor</label><select id="product-vendor" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" required><option value="">Select Vendor</option></select></div>
                                    <div><label for="product-cost" class="block text-sm font-medium text-gray-700 mb-1">Cost</label><input type="number" id="product-cost" step="0.01" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" required></div>
                                    <div><label for="product-price" class="block text-sm font-medium text-gray-700 mb-1">Sale Price</label><input type="number" id="product-price" step="0.01" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" required></div>
                                    <div class="md:col-span-2 lg:col-span-3"><label for="product-note" class="block text-sm font-medium text-gray-700 mb-1">Note</label><textarea id="product-note" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"></textarea></div>
                                </div>
                                <div id="product-form-buttons" class="mt-6 text-right">
                                    <button type="submit" class="bg-blue-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition duration-150 ease-in-out">
                                        <i class="fas fa-plus-circle mr-2"></i>Add Product
                                    </button>
                                </div>
                            </form>
                        </div>
                        <div>
                             <h4 class="text-xl font-medium mb-4 text-gray-700">Existing Products</h4>
                             <div id="products-list-container" class="bg-white rounded-lg shadow overflow-x-auto"><p class="p-4 text-gray-500 text-center">Loading products...</p></div>
                        </div>
                    </div>`,
                'vendor-list': `
                    <div>
                         <div class="flex justify-between items-center mb-6">
                            <h3 class="text-2xl font-semibold text-gray-800">Vendor List</h3>
                            <button id="import-vendor-btn" class="bg-teal-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-teal-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-teal-500 transition duration-150 ease-in-out">
                                <i class="fas fa-file-import mr-2"></i>Import
                            </button>
                            <input type="file" id="vendor-csv-input" class="hidden" accept=".csv">
                        </div>
                        <div class="mb-8 p-4 sm:p-6 border border-gray-200 rounded-lg bg-gray-50">
                            <h4 id="vendor-form-title" class="text-xl font-medium mb-4 text-gray-700">Add New Vendor</h4>
                            <form id="add-vendor-form">
                                <input type="hidden" id="vendor-id">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 md:gap-6">
                                    <div><label for="vendor-name" class="block text-sm font-medium text-gray-700 mb-1">Vendor Name</label><input type="text" id="vendor-name" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" placeholder="Enter vendor name" required></div>
                                    <div><label for="vendor-contact" class="block text-sm font-medium text-gray-700 mb-1">Contact</label><input type="text" id="vendor-contact" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" placeholder="Enter contact info" required></div>
                                </div>
                                <div id="vendor-form-buttons" class="mt-6 text-right">
                                    <button type="submit" class="bg-blue-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition duration-150 ease-in-out">
                                        <i class="fas fa-plus-circle mr-2"></i>Add Vendor
                                    </button>
                                </div>
                            </form>
                        </div>
                        <div>
                             <h4 class="text-xl font-medium mb-4 text-gray-700">Existing Vendors</h4>
                             <div id="vendors-list-container" class="bg-white rounded-lg shadow overflow-x-auto"><p class="p-4 text-gray-500 text-center">Loading vendors...</p></div>
                        </div>
                    </div>`
            };

            const settingsTabs = {
                'shop-list': `
                    <div>
                        <h3 class="text-2xl font-semibold mb-6 text-gray-800">Shop List</h3>
                        <div class="mb-8 p-4 sm:p-6 border border-gray-200 rounded-lg bg-gray-50">
                            <h4 id="shop-form-title" class="text-xl font-medium mb-4 text-gray-700">Add New Shop</h4>
                            <form id="add-shop-form">
                                <input type="hidden" id="shop-id">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 md:gap-6">
                                    <div><label for="shop-name" class="block text-sm font-medium text-gray-700 mb-1">Shop Name</label><input type="text" id="shop-name" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" placeholder="Enter shop name" required></div>
                                    <div><label for="shop-contact" class="block text-sm font-medium text-gray-700 mb-1">Contact</label><input type="text" id="shop-contact" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" placeholder="Enter contact number or email" required></div>
                                    <div class="md:col-span-2"><label for="shop-address" class="block text-sm font-medium text-gray-700 mb-1">Address</label><textarea id="shop-address" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" placeholder="Enter shop address" required></textarea></div>
                                </div>
                                <div id="shop-form-buttons" class="mt-6 text-right">
                                    <button type="submit" class="bg-blue-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition duration-150 ease-in-out">
                                        <i class="fas fa-plus-circle mr-2"></i>Add Shop
                                    </button>
                                </div>
                            </form>
                        </div>
                        <div>
                             <h4 class="text-xl font-medium mb-4 text-gray-700">Existing Shops</h4>
                             <div id="shops-list-container" class="bg-white rounded-lg shadow overflow-x-auto"><p class="p-4 text-gray-500 text-center">Loading shops...</p></div>
                        </div>
                    </div>`,
                'user-profile': `
                    <div>
                        <h3 class="text-2xl font-semibold mb-6 text-gray-800">User Profile Management</h3>
                        <div class="mb-8 p-4 sm:p-6 border border-gray-200 rounded-lg bg-gray-50">
                            <h4 id="user-form-title" class="text-xl font-medium mb-4 text-gray-700">Add New User</h4>
                            <form id="add-user-form">
                                <input type="hidden" id="user-doc-id">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 md:gap-6">
                                    <div><label for="user-name" class="block text-sm font-medium text-gray-700 mb-1">Name</label><input type="text" id="user-name" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" placeholder="Enter user's full name" required></div>
                                    <div><label for="user-email" class="block text-sm font-medium text-gray-700 mb-1">Email</label><input type="email" id="user-email" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" placeholder="Enter user's email" required></div>
                                    <div><label for="user-role" class="block text-sm font-medium text-gray-700 mb-1">Role</label><select id="user-role" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"><option>Admin</option><option>Shop Manager</option><option>Staff</option></select></div>
                                    <div><label for="user-uid" class="block text-sm font-medium text-gray-700 mb-1">Linked Auth UID</label><input type="text" id="user-uid" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm bg-gray-100" placeholder="Link user below" readonly></div>
                                    <div class="md:col-span-2"><label class="block text-sm font-medium text-gray-700 mb-2">Assigned Shops</label><div id="user-form-shops" class="space-y-2 p-4 border border-gray-200 rounded-md max-h-32 overflow-y-auto">Loading shops...</div></div>
                                    <div class="md:col-span-2"><label class="block text-sm font-medium text-gray-700 mb-2">Page Permissions</label><div id="user-form-permissions" class="space-y-2 p-4 border border-gray-200 rounded-md"><label class="flex items-center"><input type="checkbox" name="permissions" value="po-request" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500 mr-2">PO Request</label><label class="flex items-center"><input type="checkbox" name="permissions" value="po-center" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500 mr-2">PO Center</label><label class="flex items-center"><input type="checkbox" name="permissions" value="product-data" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500 mr-2">Product Data</label><label class="flex items-center"><input type="checkbox" name="permissions" value="settings" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500 mr-2">Settings</label></div></div>
                                </div>
                                <div id="user-form-buttons" class="mt-6 text-right">
                                    <button type="submit" class="bg-blue-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition duration-150 ease-in-out">
                                        <i class="fas fa-plus-circle mr-2"></i>Add User
                                    </button>
                                </div>
                            </form>
                        </div>
                        <div class="overflow-x-auto">
                             <h4 class="text-xl font-medium mb-4 text-gray-700">Existing Users</h4>
                             <div id="users-list-container" class="bg-white rounded-lg shadow"><p class="p-4 text-gray-500 text-center">Loading users...</p></div>
                        </div>
                    </div>`
            };

            // --- Functions ---
            function loadPage(pageKey, data = null) {
                // RBAC Check
                if (!currentUserProfile.permissions.includes(pageKey)) {
                    showModalMessage('Access Denied', 'You do not have permission to view this page.', true);
                    return;
                }

                const page = pages[pageKey];
                if (!page) return;
                pageTitle.textContent = page.title;
                pageContent.innerHTML = page.content;

                if (pageKey === 'po-request') {
                    setupPoRequestPage(data);
                } else if (pageKey === 'po-center') {
                    setupPoCenterTabs();
                    loadPoCenterTab('drafts-po');
                } else if (pageKey === 'settings') {
                    setupSettingsTabs();
                    loadSettingsTab('shop-list');
                } else if (pageKey === 'product-data') {
                    setupProductDataTabs();
                    loadProductDataTab('product-list');
                }
            }
            
            function loadPoCenterTab(tabKey) {
                const tabContentContainer = document.getElementById('po-center-tab-content');
                if (!tabContentContainer) return;

                tabContentContainer.innerHTML = poCenterTabs[tabKey];
                
                if (tabKey === 'drafts-po') {
                    renderDraftsPO();
                } else if (tabKey === 'active-po') {
                    renderActivePO();
                } else if (tabKey === 'audited-po') {
                    renderAuditedPO();
                }
            }

            async function renderPOsByStatus(status, containerId, filters = {}) {
                const container = document.getElementById(containerId);
                if (!container) return;
                
                let queryConstraints = [where("status", "==", status)];

                if (filters.shopId) {
                    queryConstraints.push(where("shopId", "==", filters.shopId));
                }
                if (filters.startDate) {
                    queryConstraints.push(where("requestDate", ">=", filters.startDate));
                }
                if (filters.endDate) {
                    queryConstraints.push(where("requestDate", "<=", filters.endDate));
                }

                const q = query(collection(db, "purchaseOrders"), ...queryConstraints);
                
                try {
                    const snapshot = await getDocs(q);
                    const tableContainer = document.getElementById('po-list-table'); // Changed to get element by ID
                    if (snapshot.empty) {
                        tableContainer.innerHTML = `<p class="p-4 text-gray-500 text-center">No ${status} POs found for the selected filters.</p>`;
                        return;
                    }

                    const khrFormatter = new Intl.NumberFormat('en-US', { style: 'currency', currency: 'KHR' });
                    let tableHtml = `<div class="overflow-x-auto"><table class="min-w-full divide-y divide-gray-200"><thead class="bg-gray-50"><tr>
                        <th class="px-2 py-3 sm:px-6 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">PO Number</th>
                        <th class="px-2 py-3 sm:px-6 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Req Date</th>
                        <th class="px-2 py-3 sm:px-6 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Shop</th>
                        <th class="px-2 py-3 sm:px-6 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Vendor</th>
                        <th class="px-2 py-3 sm:px-6 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Total Amount</th>
                        <th class="px-2 py-3 sm:px-6 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                        <th class="px-2 py-3 sm:px-6 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                    </tr></thead><tbody class="bg-white divide-y divide-gray-200">`;

                    snapshot.forEach(doc => {
                        const po = doc.data();
                        const reqDate = po.requestDate.toDate().toLocaleDateString();
                        const statusClass = po.status === 'draft' ? 'bg-yellow-200 text-yellow-800' : (po.status === 'submitted' ? 'bg-blue-200 text-blue-800' : 'bg-green-200 text-green-800');
                        
                        let actionsHtml = '';
                        if (po.status === 'draft') {
                            actionsHtml = `<td class="px-2 py-4 sm:px-6 whitespace-nowrap text-sm font-medium space-x-2">
                                <button data-id="${doc.id}" class="edit-draft-po text-blue-600 hover:text-blue-900"><i class="fas fa-edit"></i></button>
                                <button data-id="${doc.id}" class="delete-draft-po text-red-600 hover:text-red-900"><i class="fas fa-trash"></i></button>
                            </td>`;
                        } else if (po.status === 'submitted') {
                             actionsHtml = `<td class="px-2 py-4 sm:px-6 whitespace-nowrap text-sm font-medium">
                                <button data-id="${doc.id}" class="audit-po bg-indigo-600 text-white px-3 py-1 rounded-md hover:bg-indigo-700">Audit</button>
                            </td>`;
                        } else if (po.status === 'audited') {
                            actionsHtml = `<td class="px-2 py-4 sm:px-6 whitespace-nowrap text-sm font-medium">
                               <button data-id="${doc.id}" class="view-audited-po text-green-600 hover:text-green-900"><i class="fas fa-eye"></i></button>
                           </td>`;
                        }


                        tableHtml += `<tr>
                            <td class="px-2 py-4 sm:px-6 whitespace-nowrap text-sm font-medium text-gray-900">${po.poNumber}</td>
                            <td class="px-2 py-4 sm:px-6 whitespace-nowrap text-sm text-gray-500">${reqDate}</td>
                            <td class="px-2 py-4 sm:px-6 whitespace-nowrap text-sm text-gray-500">${po.shopName}</td>
                            <td class="px-2 py-4 sm:px-6 whitespace-nowrap text-sm text-gray-500">${po.vendorName}</td>
                            <td class="px-2 py-4 sm:px-6 whitespace-nowrap text-sm text-gray-500">${khrFormatter.format(po.totalAmount)}</td>
                            <td class="px-2 py-4 sm:px-6 whitespace-nowrap text-sm text-gray-500"><span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${statusClass}">${po.status}</span></td>
                            ${actionsHtml}
                        </tr>`;
                    });

                    tableHtml += `</tbody></table></div>`;
                    tableContainer.innerHTML = tableHtml;
                } catch (error) {
                    console.error("Error fetching POs:", error);
                    document.getElementById('po-list-table').innerHTML = `<p class="p-4 text-red-500 text-center">Error loading POs.</p>`;
                }
            }

            async function handlePoCenterActions(e) {
                const button = e.target.closest('button');
                if (!button) return;
                
                const poId = button.dataset.id;
                if (!poId) return;

                if (button.classList.contains('delete-draft-po')) {
                    showConfirmation('Delete Draft', 'Are you sure you want to delete this draft?', async () => {
                         try {
                            await deleteDoc(doc(db, "purchaseOrders", poId));
                            showModalMessage('Success', 'Draft deleted successfully.');
                        } catch (error) {
                            console.error("Error deleting draft:", error);
                            showModalMessage('Error', 'Failed to delete draft.', true);
                        }
                    });
                } else if (button.classList.contains('edit-draft-po')) {
                    try {
                        const poDoc = await getDoc(doc(db, "purchaseOrders", poId));
                        if (poDoc.exists()) {
                            loadPage('po-request', { id: poDoc.id, ...poDoc.data() });
                        } else {
                            showModalMessage('Error', 'Could not find the selected draft.', true);
                        }
                    } catch (error) {
                        console.error("Error fetching draft for editing:", error);
                        showModalMessage('Error', 'Failed to fetch draft for editing.', true);
                    }
                } else if (button.classList.contains('audit-po')) {
                    try {
                        const poDoc = await getDoc(doc(db, "purchaseOrders", poId));
                        if (poDoc.exists()) {
                            openAuditModal({ id: poDoc.id, ...poDoc.data() });
                        } else {
                            showModalMessage('Error', 'Could not find the selected PO.', true);
                        }
                    } catch (error) {
                        console.error("Error fetching PO for audit:", error);
                        showModalMessage('Error', 'Failed to fetch PO for audit.', true);
                    }
                } else if (button.classList.contains('view-audited-po')) {
                    try {
                        const poDoc = await getDoc(doc(db, "purchaseOrders", poId));
                        if (poDoc.exists()) {
                            openViewPoModal({ id: poDoc.id, ...poDoc.data() });
                        } else {
                            showModalMessage('Error', 'Could not find the selected PO.', true);
                        }
                    } catch (error) {
                        console.error("Error fetching PO for viewing:", error);
                        showModalMessage('Error', 'Failed to fetch PO for viewing.', true);
                    }
                }
            }
            
            function closeAuditModal() {
                const modalBackdrop = document.getElementById('audit-modal-backdrop');
                modalBackdrop.classList.add('hidden');
                modalBackdrop.classList.remove('flex');
                modalBackdrop.querySelector('#audit-modal').innerHTML = ''; // Clear content
            }

            async function openViewPoModal(poData) {
                const modalBackdrop = document.getElementById('audit-modal-backdrop');
                const modal = document.getElementById('audit-modal');
                const numberFormatter = (num, decimals = 2) => isNaN(parseFloat(num)) ? '0.00' : parseFloat(num).toFixed(decimals);
                const currencyFormatter = (num) => new Intl.NumberFormat('en-US').format(numberFormatter(num));

                const auditedByName = poData.auditedByName || 'N/A';

                let modalHtml = `
                    <div class="p-4 border-b border-gray-200 flex justify-between items-center">
                        <h3 class="text-xl font-semibold text-gray-800">View Audited PO: ${poData.poNumber}</h3>
                        <button id="close-view-modal-btn" class="text-gray-500 hover:text-gray-800 text-2xl">&times;</button>
                    </div>
                    <div class="p-4 flex-grow overflow-y-auto">
                        <div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-4 gap-4 mb-4 text-sm bg-gray-50 p-4 rounded-lg">
                            <div><strong>Shop:</strong> ${poData.shopName}</div>
                            <div><strong>Vendor:</strong> ${poData.vendorName}</div>
                            <div><strong>Request Date:</strong> ${poData.requestDate.toDate().toLocaleDateString()}</div>
                            <div><strong>Exchange Rate:</strong> ${poData.exchangeRate || 'N/A'}</div>
                            <div class="lg:col-span-2"><strong>Audited By:</strong> ${auditedByName}</div>
                            <div class="lg:col-span-2"><strong>Audited At:</strong> ${poData.auditedAt ? poData.auditedAt.toDate().toLocaleString() : 'N/A'}</div>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200 text-sm">
                                <thead class="bg-gray-100">
                                    <tr>
                                        <th class="px-2 py-2 text-left font-medium text-gray-600 uppercase">Product</th>
                                        <th class="px-2 py-2 text-center font-medium text-gray-600 uppercase">Ordered</th>
                                        <th class="px-2 py-2 text-center font-medium text-gray-600 uppercase">Received</th>
                                        <th class="px-2 py-2 text-right font-medium text-gray-600 uppercase">Cost (KHR)</th>
                                        <th class="px-2 py-2 text-right font-medium text-gray-600 uppercase">Cost (USD)</th>
                                        <th class="px-2 py-2 text-right font-medium text-gray-600 uppercase">Cost/Unit</th>
                                        <th class="px-2 py-2 text-right font-medium text-gray-600 uppercase">CB4</th>
                                        <th class="px-2 py-2 text-right font-medium text-gray-600 uppercase">Checked-Cost</th>
                                        <th class="px-2 py-2 text-left font-medium text-gray-600 uppercase">Note</th>
                                    </tr>
                                </thead>
                                <tbody class="bg-white divide-y divide-gray-200">
                                    ${poData.items.map((item) => {
                                        let checkedCostColor = 'text-gray-900';
                                        if (item.costPerUnit > item.cb4) {
                                            checkedCostColor = 'text-red-600';
                                        } else if (item.costPerUnit < item.cb4) {
                                            checkedCostColor = 'text-blue-600';
                                        }
                                        return `<tr>
                                            <td class="px-2 py-1 whitespace-nowrap">${item.name}</td>
                                            <td class="px-2 py-1 text-center">${item.quantity}</td>
                                            <td class="px-2 py-1 text-center">${item.receivedQuantity || 0}</td>
                                            <td class="px-2 py-1 text-right">${currencyFormatter(item.costKhr || 0)}</td>
                                            <td class="px-2 py-1 text-right">$${numberFormatter(item.costUsd || 0)}</td>
                                            <td class="px-2 py-1 text-right">${currencyFormatter(item.costPerUnit || 0)}</td>
                                            <td class="px-2 py-1 text-right">${currencyFormatter(item.cb4 || 0)}</td>
                                            <td class="px-2 py-1 text-right font-bold ${checkedCostColor}">${currencyFormatter(item.checkedCost || 0)}</td>
                                            <td class="px-2 py-1 whitespace-nowrap">${item.auditNote || ''}</td>
                                        </tr>`;
                                    }).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div class="p-4 border-t border-gray-200 flex justify-end gap-4">
                        <button id="close-view-modal-btn-2" type="button" class="bg-gray-500 text-white font-bold py-2 px-6 rounded-lg hover:bg-gray-600">Close</button>
                    </div>
                `;
                modal.innerHTML = modalHtml;
                modalBackdrop.classList.remove('hidden');
                modalBackdrop.classList.add('flex');

                document.getElementById('close-view-modal-btn').addEventListener('click', closeAuditModal);
                document.getElementById('close-view-modal-btn-2').addEventListener('click', closeAuditModal);
            }

            function openAuditModal(poData) {
                const modalBackdrop = document.getElementById('audit-modal-backdrop');
                const modal = document.getElementById('audit-modal');
                const numberFormatter = (num) => isNaN(num) ? '0.00' : num.toFixed(2);

                let modalHtml = `
                    <div class="p-4 border-b border-gray-200 flex justify-between items-center">
                        <h3 class="text-xl font-semibold text-gray-800">Audit PO: ${poData.poNumber}</h3>
                        <button id="close-audit-modal-btn" class="text-gray-500 hover:text-gray-800 text-2xl">&times;</button>
                    </div>
                    <div class="p-4 flex-grow overflow-y-auto">
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4 text-sm bg-gray-50 p-4 rounded-lg">
                            <div><strong>Shop:</strong> ${poData.shopName}</div>
                            <div><strong>Vendor:</strong> ${poData.vendorName}</div>
                            <div>
                                <label for="audit-audited-by" class="block font-medium text-gray-700">Audited By</label>
                                <input type="text" id="audit-audited-by" class="w-full mt-1 px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" placeholder="Enter auditor's name">
                            </div>
                            <div>
                                <label for="audit-exchange-rate" class="block font-medium text-gray-700">Exchange Rate (USD to KHR)</label>
                                <input type="number" id="audit-exchange-rate" class="audit-input mt-1" value="4100">
                            </div>
                        </div>
                        <form id="audit-form" class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200 text-sm">
                                <thead class="bg-gray-100">
                                    <tr>
                                        <th class="px-2 py-2 text-left font-medium text-gray-600 uppercase">Product</th>
                                        <th class="px-2 py-2 text-center font-medium text-gray-600 uppercase" style="width: 8%;">Ordered Qty</th>
                                        <th class="px-2 py-2 text-center font-medium text-gray-600 uppercase" style="width: 8%;">Received Qty</th>
                                        <th class="px-2 py-2 text-right font-medium text-gray-600 uppercase" style="width: 10%;">Cost (KHR)</th>
                                        <th class="px-2 py-2 text-right font-medium text-gray-600 uppercase" style="width: 10%;">Cost (USD)</th>
                                        <th class="px-2 py-2 text-right font-medium text-gray-600 uppercase" style="width: 10%;">Cost/Unit</th>
                                        <th class="px-2 py-2 text-right font-medium text-gray-600 uppercase" style="width: 10%;">CB4</th>
                                        <th class="px-2 py-2 text-right font-medium text-gray-600 uppercase" style="width: 10%;">Checked-Cost</th>
                                        <th class="px-2 py-2 text-left font-medium text-gray-600 uppercase" style="width: 14%;">Note</th>
                                    </tr>
                                </thead>
                                <tbody class="bg-white divide-y divide-gray-200">
                                    ${poData.items.map((item, index) => `
                                        <tr data-index="${index}" data-product-id="${item.productId}" data-cb4="${item.cb4}">
                                            <td class="px-2 py-1 whitespace-nowrap">${item.name}</td>
                                            <td class="px-2 py-1 text-center">${item.quantity}</td>
                                            <td class="px-2 py-1"><input type="number" class="audit-input audit-received-qty" value="${item.quantity}" min="0"></td>
                                            <td class="px-2 py-1"><input type="number" class="audit-input audit-cost-khr" placeholder="0.00"></td>
                                            <td class="px-2 py-1"><input type="number" class="audit-input audit-cost-usd" placeholder="0.00"></td>
                                            <td class="px-2 py-1 calculated-field cost-per-unit">0.00</td>
                                            <td class="px-2 py-1 calculated-field">${numberFormatter(item.cb4)}</td>
                                            <td class="px-2 py-1 calculated-field checked-cost font-bold">0.00</td>
                                            <td class="px-2 py-1"><input type="text" class="audit-input audit-item-note" placeholder="Optional note"></td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </form>
                    </div>
                    <div class="p-4 border-t border-gray-200 flex justify-end gap-4">
                        <button id="cancel-audit-btn" type="button" class="bg-gray-500 text-white font-bold py-2 px-6 rounded-lg hover:bg-gray-600">Cancel</button>
                        <button id="confirm-audit-btn" type="button" class="bg-green-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-green-700">Confirm & Save Audit</button>
                    </div>
                `;
                modal.innerHTML = modalHtml;
                modalBackdrop.classList.remove('hidden');
                modalBackdrop.classList.add('flex');

                const auditedByInput = document.getElementById('audit-audited-by');
                auditedByInput.value = currentUserProfile.name;


                const auditForm = document.getElementById('audit-form');
                
                function updateAuditRow(rowElement) {
                    const exchangeRate = parseFloat(document.getElementById('audit-exchange-rate').value) || 0;
                    const receivedQty = parseFloat(rowElement.querySelector('.audit-received-qty').value) || 0;
                    const costKhr = parseFloat(rowElement.querySelector('.audit-cost-khr').value) || 0;
                    const costUsd = parseFloat(rowElement.querySelector('.audit-cost-usd').value) || 0;
                    const cb4 = parseFloat(rowElement.dataset.cb4) || 0;

                    let costPerUnit = 0;
                    if (receivedQty > 0) {
                        if (costKhr > 0) {
                            costPerUnit = costKhr / receivedQty;
                        } else if (costUsd > 0 && exchangeRate > 0) {
                            costPerUnit = (costUsd * exchangeRate) / receivedQty;
                        }
                    }
                    
                    const checkedCost = costPerUnit - cb4;
                    const checkedCostEl = rowElement.querySelector('.checked-cost');
                    
                    rowElement.querySelector('.cost-per-unit').textContent = numberFormatter(costPerUnit);
                    checkedCostEl.textContent = numberFormatter(checkedCost);

                    // Apply color based on cost comparison
                    checkedCostEl.classList.remove('text-red-600', 'text-blue-600', 'text-gray-900');
                    if (costPerUnit > cb4) {
                        checkedCostEl.classList.add('text-red-600');
                    } else if (costPerUnit < cb4) {
                        checkedCostEl.classList.add('text-blue-600');
                    } else {
                        checkedCostEl.classList.add('text-gray-900');
                    }
                }
                
                auditForm.addEventListener('input', (e) => {
                    const target = e.target;
                    if (target.classList.contains('audit-input')) {
                        const row = target.closest('tr');
                        if (row) {
                            updateAuditRow(row);
                        }
                    }
                });
                
                document.getElementById('audit-exchange-rate').addEventListener('input', () => {
                    auditForm.querySelectorAll('tbody tr').forEach(row => updateAuditRow(row));
                });

                document.getElementById('close-audit-modal-btn').addEventListener('click', closeAuditModal);
                document.getElementById('cancel-audit-btn').addEventListener('click', closeAuditModal);
                document.getElementById('confirm-audit-btn').addEventListener('click', async () => {
                    const auditedByName = document.getElementById('audit-audited-by').value.trim();
                    if (!auditedByName) {
                        showModalMessage('Validation Error', "Please enter the auditor's name.", true);
                        return;
                    }

                    const auditedItems = [];
                    const itemRows = modal.querySelectorAll('tbody tr');
                    const exchangeRate = parseFloat(document.getElementById('audit-exchange-rate').value) || 0;

                    itemRows.forEach(row => {
                        const index = parseInt(row.dataset.index);
                        const originalItem = poData.items[index];
                        
                        auditedItems.push({
                            ...originalItem,
                            productId: row.dataset.productId, // Ensure productId is carried over
                            receivedQuantity: parseFloat(row.querySelector('.audit-received-qty').value) || 0,
                            costKhr: parseFloat(row.querySelector('.audit-cost-khr').value) || 0,
                            costUsd: parseFloat(row.querySelector('.audit-cost-usd').value) || 0,
                            costPerUnit: parseFloat(row.querySelector('.cost-per-unit').textContent) || 0,
                            checkedCost: parseFloat(row.querySelector('.checked-cost').textContent) || 0,
                            auditNote: row.querySelector('.audit-item-note').value
                        });
                    });

                    const auditData = {
                        status: 'audited',
                        auditedAt: serverTimestamp(),
                        auditedBy: currentUserId,
                        auditedByName: auditedByName,
                        exchangeRate: exchangeRate,
                        items: auditedItems
                    };

                    try {
                        // Create a single batch for all database writes
                        const batch = writeBatch(db);

                        // 1. Update the PO document
                        const poRef = doc(db, "purchaseOrders", poData.id);
                        batch.update(poRef, auditData);

                        // 2. Update product costs and add to history
                        auditedItems.forEach(item => {
                            if (item.productId && item.costPerUnit > 0) {
                                const productRef = doc(db, "products", item.productId);
                                batch.update(productRef, { cost: item.costPerUnit });

                                const historyRef = doc(collection(db, "products", item.productId, "costHistory"));
                                batch.set(historyRef, {
                                    updatedAt: serverTimestamp(),
                                    newCost: item.costPerUnit,
                                    poNumber: poData.poNumber,
                                    auditedByName: auditedByName
                                });
                            }
                        });

                        // Commit all changes at once
                        await batch.commit();

                        showModalMessage('Success', 'PO audited and product costs updated successfully.');
                        closeAuditModal();
                    } catch (error) {
                        console.error("Error confirming audit or updating products:", error);
                        showModalMessage('Error', 'Failed to save audit or update product costs.', true);
                    }
                });
            }

            function renderDraftsPO() {
                const container = document.getElementById('drafts-po-container');
                setupPoListWithFilters(container, 'draft');
            }

            function renderActivePO() {
                const container = document.getElementById('active-po-container');
                setupPoListWithFilters(container, 'submitted');
            }

            function renderAuditedPO() {
                const container = document.getElementById('audited-po-container');
                setupPoListWithFilters(container, 'audited');
            }
            
            async function setupPoListWithFilters(container, status) {
                let shopsOptions = '<option value="">All Shops</option>';
                try {
                    const shopsSnapshot = await getDocs(collection(db, "shops"));
                    shopsSnapshot.forEach(doc => {
                        shopsOptions += `<option value="${doc.id}">${doc.data().name}</option>`;
                    });
                } catch (error) {
                    console.error("Error fetching shops for filter:", error);
                }

                container.innerHTML = `
                    <div class="p-4 border border-gray-200 rounded-lg bg-gray-50 mb-6">
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4 items-end">
                            <div>
                                <label for="filter-shop" class="block text-sm font-medium text-gray-700">Shop</label>
                                <select id="filter-shop" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md">${shopsOptions}</select>
                            </div>
                            <div>
                                <label for="filter-date-range" class="block text-sm font-medium text-gray-700">Date Range</label>
                                <select id="filter-date-range" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md">
                                    <option value="all">All Time</option>
                                    <option value="today">Today</option>
                                    <option value="this-week">This Week</option>
                                    <option value="this-month">This Month</option>
                                    <option value="last-month">Last Month</option>
                                </select>
                            </div>
                            <div>
                                <label for="filter-specific-date" class="block text-sm font-medium text-gray-700">Specific Day</label>
                                <input type="date" id="filter-specific-date" class="mt-1 block w-full pl-3 pr-2 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md">
                            </div>
                            <div class="flex gap-2">
                                <button id="filter-apply-btn" class="w-full bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700"><i class="fas fa-filter mr-2"></i>Filter</button>
                                <button id="filter-reset-btn" class="w-full bg-gray-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-gray-600"><i class="fas fa-undo mr-2"></i>Reset</button>
                            </div>
                        </div>
                    </div>
                    <div id="po-list-table"><p class="p-4 text-gray-500 text-center">Loading POs...</p></div>
                `;

                const applyBtn = container.querySelector('#filter-apply-btn');
                const resetBtn = container.querySelector('#filter-reset-btn');

                const applyFilters = () => {
                    const shopId = container.querySelector('#filter-shop').value;
                    const dateRange = container.querySelector('#filter-date-range').value;
                    const specificDate = container.querySelector('#filter-specific-date').value;
                    
                    let filters = { shopId: shopId || null };
                    let startDate, endDate;
                    const now = new Date();

                    if (specificDate) {
                        const date = new Date(specificDate);
                        startDate = new Date(date.getFullYear(), date.getMonth(), date.getDate(), 0, 0, 0);
                        endDate = new Date(date.getFullYear(), date.getMonth(), date.getDate(), 23, 59, 59);
                    } else {
                        switch (dateRange) {
                            case 'today':
                                startDate = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 0, 0, 0);
                                endDate = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 23, 59, 59);
                                break;
                            case 'this-week':
                                const firstDayOfWeek = new Date(now.setDate(now.getDate() - now.getDay()));
                                startDate = new Date(firstDayOfWeek.getFullYear(), firstDayOfWeek.getMonth(), firstDayOfWeek.getDate(), 0, 0, 0);
                                const lastDayOfWeek = new Date(firstDayOfWeek.setDate(firstDayOfWeek.getDate() + 6));
                                endDate = new Date(lastDayOfWeek.getFullYear(), lastDayOfWeek.getMonth(), lastDayOfWeek.getDate(), 23, 59, 59);
                                break;
                            case 'this-month':
                                startDate = new Date(now.getFullYear(), now.getMonth(), 1, 0, 0, 0);
                                endDate = new Date(now.getFullYear(), now.getMonth() + 1, 0, 23, 59, 59);
                                break;
                            case 'last-month':
                                startDate = new Date(now.getFullYear(), now.getMonth() - 1, 1, 0, 0, 0);
                                endDate = new Date(now.getFullYear(), now.getMonth(), 0, 23, 59, 59);
                                break;
                        }
                    }

                    if (startDate && endDate) {
                        filters.startDate = Timestamp.fromDate(startDate);
                        filters.endDate = Timestamp.fromDate(endDate);
                    }
                    
                    container.querySelector('#po-list-table').innerHTML = `<p class="p-4 text-gray-500 text-center">Loading filtered POs...</p>`;
                    renderPOsByStatus(status, container.id, filters);
                };

                applyBtn.addEventListener('click', applyFilters);
                resetBtn.addEventListener('click', () => {
                    container.querySelector('#filter-shop').value = '';
                    container.querySelector('#filter-date-range').value = 'all';
                    container.querySelector('#filter-specific-date').value = '';
                    applyFilters();
                });

                // Initial render
                renderPOsByStatus(status, container.id);
                container.removeEventListener('click', handlePoCenterActions);
                container.addEventListener('click', handlePoCenterActions);
            }


            function loadSettingsTab(tabKey) {
                const tabContentContainer = document.getElementById('settings-tab-content');
                if (!tabContentContainer) return;
                
                tabContentContainer.innerHTML = settingsTabs[tabKey];
                if (tabKey === 'shop-list') {
                    setupShopList();
                } else if (tabKey === 'user-profile') {
                    setupUserProfile();
                }
            }
            
            function loadProductDataTab(tabKey) {
                const tabContentContainer = document.getElementById('product-data-tab-content');
                if (!tabContentContainer) return;

                tabContentContainer.innerHTML = productDataTabs[tabKey];
                if (tabKey === 'product-list') {
                    setupProductList();
                } else if (tabKey === 'vendor-list') {
                    setupVendorList();
                }
            }

            function setupPoCenterTabs() {
                const tabsContainer = document.getElementById('po-center-tabs');
                if (!tabsContainer) return;

                tabsContainer.addEventListener('click', (e) => {
                    if (e.target.classList.contains('tab-link')) {
                        e.preventDefault();
                        const tabKey = e.target.dataset.tab;
                        
                        tabsContainer.querySelectorAll('.tab-link').forEach(l => l.classList.remove('active-tab'));
                        e.target.classList.add('active-tab');
                        
                        loadPoCenterTab(tabKey);
                    }
                });
            }

            function setupSettingsTabs() {
                const tabsContainer = document.getElementById('settings-tabs');
                if (!tabsContainer) return;

                tabsContainer.addEventListener('click', (e) => {
                    if (e.target.classList.contains('tab-link')) {
                        e.preventDefault();
                        const tabKey = e.target.dataset.tab;
                        
                        tabsContainer.querySelectorAll('.tab-link').forEach(l => l.classList.remove('active-tab'));
                        e.target.classList.add('active');
                        
                        loadSettingsTab(tabKey);
                    }
                });
            }
            
            function setupProductDataTabs() {
                const tabsContainer = document.getElementById('product-data-tabs');
                if (!tabsContainer) return;

                tabsContainer.addEventListener('click', (e) => {
                    if (e.target.classList.contains('tab-link')) {
                        e.preventDefault();
                        const tabKey = e.target.dataset.tab;
                        
                        tabsContainer.querySelectorAll('.tab-link').forEach(l => l.classList.remove('active-tab'));
                        e.target.classList.add('active-tab');
                        
                        loadProductDataTab(tabKey);
                    }
                });
            }

            function toggleSidebar() {
                sidebar.classList.toggle('-translate-x-full');
                overlay.classList.toggle('hidden');
            }

            // --- Firebase Logic ---
            
            async function generatePoPdf(poData) {
                const { jsPDF } = window.jspdf;
                const printableArea = document.getElementById('po-printable');
                const khrFormatter = new Intl.NumberFormat('en-US');

                // Fetch shop and vendor details for addresses
                let shopDetails = {};
                let vendorDetails = {};
                try {
                    const shopDoc = await getDoc(doc(db, "shops", poData.shopId));
                    if(shopDoc.exists()) shopDetails = shopDoc.data();

                    const vendorDoc = await getDoc(doc(db, "vendors", poData.vendorId));
                    if(vendorDoc.exists()) vendorDetails = vendorDoc.data();
                } catch(e) {
                    console.error("Could not fetch shop/vendor details for printing:", e);
                }

                // Populate the printable template
                printableArea.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: flex-start; border-bottom: 2px solid #000; padding-bottom: 10px;">
                        <div style="width: 33%;">
                            <h1 style="font-size: 24px; font-weight: bold;">PURCHASE ORDER</h1>
                            <p><strong>PO #:</strong> ${poData.poNumber}</p>
                            <p><strong>Date:</strong> ${poData.requestDate.toLocaleDateString()}</p>
                        </div>
                        <div style="width: 33%; text-align: center;">
                            <h3 style="font-weight: bold; margin-bottom: 5px;">VENDOR:</h3>
                            <p>${poData.vendorName}</p>
                            <p>${vendorDetails.contact || ''}</p>
                        </div>
                        <div style="width: 33%; text-align: right;">
                            <h2 style="font-size: 18px; font-weight: bold;">${poData.shopName}</h2>
                            <p>${shopDetails.address || ''}</p>
                            <p>${shopDetails.contact || ''}</p>
                        </div>
                    </div>
                    <table style="width: 100%; margin-top: 20px; border-collapse: collapse;">
                        <thead style="background-color: #eee;">
                            <tr>
                                <th style="border: 1px solid #ccc; padding: 8px; text-align: left;">No.</th>
                                <th style="border: 1px solid #ccc; padding: 8px; text-align: left;">Product Code</th>
                                <th style="border: 1px solid #ccc; padding: 8px; text-align: left;">Barcode</th>
                                <th style="border: 1px solid #ccc; padding: 8px; text-align: left;">Product Name</th>
                                <th style="border: 1px solid #ccc; padding: 8px; text-align: right;">QTY</th>
                                <th style="border: 1px solid #ccc; padding: 8px; text-align: right;">Cost (KHR)</th>
                                <th style="border: 1px solid #ccc; padding: 8px; text-align: right;">Cost (USD)</th>
                                <th style="border: 1px solid #ccc; padding: 8px; text-align: right;">Sub-Total</th>
                                <th style="border: 1px solid #ccc; padding: 8px; text-align: right;">CB4</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${poData.items.map((item, index) => `
                                <tr>
                                    <td style="border: 1px solid #ccc; padding: 8px;">${index + 1}</td>
                                    <td style="border: 1px solid #ccc; padding: 8px;">${item.code}</td>
                                    <td style="border: 1px solid #ccc; padding: 8px;">${item.barcode}</td>
                                    <td style="border: 1px solid #ccc; padding: 8px;">${item.name}</td>
                                    <td style="border: 1px solid #ccc; padding: 8px; text-align: right;">${item.quantity}</td>
                                    <td style="border: 1px solid #ccc; padding: 8px; text-align: right;"></td>
                                    <td style="border: 1px solid #ccc; padding: 8px; text-align: right;"></td>
                                    <td style="border: 1px solid #ccc; padding: 8px; text-align: right;"></td>
                                    <td style="border: 1px solid #ccc; padding: 8px; text-align: right;">${khrFormatter.format(item.cb4)}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                        <tfoot>
                            <tr>
                                <td colspan="8" style="border: 1px solid #ccc; padding: 8px; text-align: right; font-weight: bold;">TOTAL</td>
                                <td style="border: 1px solid #ccc; padding: 8px; text-align: right; font-weight: bold;"></td>
                            </tr>
                        </tfoot>
                    </table>
                    <div style="position: absolute; bottom: 40px; width: 1043px; display: flex; justify-content: space-between;">
                        <div>
                            <p style="border-top: 1px solid #000; padding-top: 5px;">Prepared By</p>
                        </div>
                        <div>
                            <p style="border-top: 1px solid #000; padding-top: 5px;">Approved By</p>
                        </div>
                    </div>
                `;

                try {
                    const canvas = await html2canvas(printableArea);
                    const imgData = canvas.toDataURL('image/png');
                    const pdf = new jsPDF({
                        orientation: 'landscape',
                        unit: 'px',
                        format: 'a4'
                    });
                    const pdfWidth = pdf.internal.pageSize.getWidth();
                    const pdfHeight = pdf.internal.pageSize.getHeight();
                    pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);
                    pdf.save(`PO-${poData.poNumber}.pdf`);
                } catch (error) {
                    console.error('Error generating PDF:', error);
                    showModalMessage('PDF Error', 'Could not generate PO PDF.', true);
                }
            }

            function setupPoRequestPage(poDataToEdit = null) {
                const poRequestTitle = document.getElementById('po-request-title');
                const poIdInput = document.getElementById('po-id');
                const shopSelect = document.getElementById('po-shop-name');
                const vendorSelect = document.getElementById('po-vendor');
                const poNumberInput = document.getElementById('po-number');
                const reqDateInput = document.getElementById('po-req-date');
                const productSearchInput = document.getElementById('po-product-search');
                const searchResultsContainer = document.getElementById('product-search-results');
                const productNameInput = document.getElementById('po-product-name');
                const selectedProductIdInput = document.getElementById('po-selected-product-id');
                const selectedProductCodeInput = document.getElementById('po-selected-product-code');
                const selectedProductBarcodeInput = document.getElementById('po-selected-product-barcode');
                const selectedProductVendorNameInput = document.getElementById('po-selected-product-vendor-name');
                const selectedProductCostInput = document.getElementById('po-selected-product-cost');
                const quantityInput = document.getElementById('po-item-quantity');
                const addItemForm = document.getElementById('add-po-item-form');
                const poItemsContainer = document.getElementById('po-items-container');
                const cancelPoBtn = document.getElementById('cancel-po-req');
                const saveDraftBtn = document.getElementById('save-draft-po');
                const submitPoBtn = document.getElementById('submit-po');

                let poItems = [];

                // --- Populate Dropdowns ---
                onSnapshot(collection(db, "shops"), (snapshot) => {
                    let optionsHtml = '<option value="">Select Shop</option>';
                    snapshot.forEach(doc => {
                        optionsHtml += `<option value="${doc.id}" data-name="${doc.data().name}">${doc.data().name}</option>`;
                    });
                    shopSelect.innerHTML = optionsHtml;
                    if (poDataToEdit) shopSelect.value = poDataToEdit.shopId;
                });

                onSnapshot(collection(db, "vendors"), (snapshot) => {
                    let optionsHtml = '<option value="">Select Vendor</option>';
                    snapshot.forEach(doc => {
                        optionsHtml += `<option value="${doc.id}" data-name="${doc.data().name}">${doc.data().name}</option>`;
                    });
                    vendorSelect.innerHTML = optionsHtml;
                    if (poDataToEdit) vendorSelect.value = poDataToEdit.vendorId;
                });
                
                // --- Auto Generate PO Number & Date ---
                function generatePoNumber() {
                    if (poNumberInput.value) return; // Don't regenerate if editing
                    if (shopSelect.value && vendorSelect.value) {
                        const shopName = shopSelect.options[shopSelect.selectedIndex].dataset.name.replace(/\s+/g, '');
                        const vendorName = vendorSelect.options[vendorSelect.selectedIndex].dataset.name.replace(/\s+/g, '');
                        const now = new Date();
                        const d = String(now.getDate()).padStart(2, '0');
                        const m = String(now.getMonth() + 1).padStart(2, '0');
                        const y = String(now.getFullYear()).slice(-2);
                        const h = String(now.getHours()).padStart(2, '0');
                        const min = String(now.getMinutes()).padStart(2, '0');
                        const s = String(now.getSeconds()).padStart(2, '0');
                        poNumberInput.value = `${shopName}-${vendorName}-${d}${m}${y}-${h}${min}${s}`;
                    } else {
                        poNumberInput.value = '';
                    }
                }

                function setRequestDate() {
                    const now = new Date();
                    reqDateInput.value = now.toLocaleDateString('en-CA'); // YYYY-MM-DD format
                }

                shopSelect.addEventListener('change', generatePoNumber);
                vendorSelect.addEventListener('change', generatePoNumber);
                
                if (!poDataToEdit) {
                    setRequestDate();
                }

                // --- Product Search ---
                productSearchInput.addEventListener('input', async (e) => {
                    const searchTerm = e.target.value.trim().toLowerCase();
                    if (searchTerm.length < 1) {
                        searchResultsContainer.innerHTML = '';
                        searchResultsContainer.classList.add('hidden');
                        return;
                    }

                    try {
                        const productsRef = collection(db, "products");
                        const querySnapshot = await getDocs(productsRef);
                        
                        const results = [];
                        querySnapshot.forEach(doc => {
                            const product = doc.data();
                            const code = product.code ? product.code.toLowerCase() : '';
                            const barcode = product.barcode ? product.barcode.toLowerCase() : '';
                            const name = product.name ? product.name.toLowerCase() : '';

                            if (name.includes(searchTerm) || 
                                code.includes(searchTerm) || 
                                barcode.includes(searchTerm) ||
                                (code.length >= 5 && code.slice(-5) === searchTerm) ||
                                (barcode.length >= 6 && barcode.slice(-6) === searchTerm)
                                ) {
                                results.push({ id: doc.id, ...product });
                            }
                        });

                        if (results.length > 0) {
                            searchResultsContainer.innerHTML = results.map(p => `
                                <div class="p-2 cursor-pointer" data-id="${p.id}" data-name="${p.name}" data-code="${p.code}" data-barcode="${p.barcode || ''}" data-vendor-name="${p.vendorName || ''}" data-cost="${p.cost}">
                                    <p class="font-semibold">${p.name}</p>
                                    <p class="text-sm text-gray-500">Code: ${p.code} | Barcode: ${p.barcode || 'N/A'}</p>
                                </div>
                            `).join('');
                            searchResultsContainer.classList.remove('hidden');
                        } else {
                            searchResultsContainer.innerHTML = '<div class="p-2 text-gray-500">No products found.</div>';
                            searchResultsContainer.classList.remove('hidden');
                        }
                    } catch (error) {
                        console.error("Error searching products:", error);
                        searchResultsContainer.innerHTML = '<div class="p-2 text-red-500">Error searching.</div>';
                        searchResultsContainer.classList.remove('hidden');
                    }
                });
                
                // --- Select a Product from search ---
                searchResultsContainer.addEventListener('click', (e) => {
                    const productDiv = e.target.closest('div[data-id]');
                    if (productDiv) {
                        productNameInput.value = productDiv.dataset.name;
                        selectedProductIdInput.value = productDiv.dataset.id;
                        selectedProductCodeInput.value = productDiv.dataset.code;
                        selectedProductBarcodeInput.value = productDiv.dataset.barcode;
                        selectedProductVendorNameInput.value = productDiv.dataset.vendorName;
                        selectedProductCostInput.value = productDiv.dataset.cost;
                        productSearchInput.value = '';
                        searchResultsContainer.classList.add('hidden');
                        quantityInput.focus();
                    }
                });

                // --- Add Item to PO List ---
                addItemForm.addEventListener('submit', (e) => {
                    e.preventDefault();
                    const productId = selectedProductIdInput.value;
                    if (!productId) {
                        showModalMessage('Validation Error', "Please select a product first.", true);
                        return;
                    }

                    const existingItemIndex = poItems.findIndex(item => item.productId === productId);
                    const quantity = parseInt(quantityInput.value);

                    if (existingItemIndex > -1) {
                        poItems[existingItemIndex].quantity += quantity;
                    } else {
                        poItems.push({
                            productId: productId,
                            code: selectedProductCodeInput.value,
                            barcode: selectedProductBarcodeInput.value,
                            name: productNameInput.value,
                            vendorName: selectedProductVendorNameInput.value,
                            cost: parseFloat(selectedProductCostInput.value),
                            cb4: parseFloat(selectedProductCostInput.value), // Cost Before
                            quantity: quantity
                        });
                    }
                    
                    renderPoItems();
                    resetAddItemForm();
                });

                function resetAddItemForm() {
                    addItemForm.reset();
                    quantityInput.value = "1";
                    productNameInput.value = '';
                    selectedProductIdInput.value = '';
                    selectedProductCodeInput.value = '';
                    selectedProductBarcodeInput.value = '';
                    selectedProductVendorNameInput.value = '';
                    selectedProductCostInput.value = '';
                    productSearchInput.focus();
                }

                function renderPoItems() {
                    if (poItems.length === 0) {
                        poItemsContainer.innerHTML = `<p class="p-4 text-gray-500 text-center">No products added yet.</p>`;
                        return;
                    }

                    let tableHtml = `<table class="min-w-full divide-y divide-gray-200"><thead class="bg-gray-50"><tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">No.</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Product Code</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Barcode</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Product Name</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Vendor</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Qty</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Cost (KHR)</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Cost (USD)</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Sub-Total</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">CB4</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                    </tr></thead><tbody class="bg-white divide-y divide-gray-200">`;
                    
                    poItems.forEach((item, index) => {
                        tableHtml += `<tr>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${index + 1}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${item.code}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${item.barcode}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${item.name}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${item.vendorName}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${item.quantity}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500"></td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500"></td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500"></td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500"></td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium space-x-2">
                                <button data-index="${index}" class="edit-po-item text-blue-600 hover:text-blue-900"><i class="fas fa-edit"></i></button>
                                <button data-index="${index}" class="remove-po-item text-red-600 hover:text-red-900"><i class="fas fa-trash"></i></button>
                            </td>
                        </tr>`;
                    });

                    tableHtml += `</tbody></table>`;
                    poItemsContainer.innerHTML = tableHtml;
                }
                
                poItemsContainer.addEventListener('click', (e) => {
                    const button = e.target.closest('button');
                    if(!button) return;

                    const index = button.dataset.index;

                    if(button.classList.contains('remove-po-item')) {
                        poItems.splice(index, 1);
                        renderPoItems();
                    } else if (button.classList.contains('edit-po-item')) {
                        const itemToEdit = poItems[index];
                        
                        // Populate the form
                        selectedProductIdInput.value = itemToEdit.productId;
                        selectedProductCodeInput.value = itemToEdit.code;
                        selectedProductBarcodeInput.value = itemToEdit.barcode;
                        productNameInput.value = itemToEdit.name;
                        selectedProductVendorNameInput.value = itemToEdit.vendorName;
                        selectedProductCostInput.value = itemToEdit.cost;
                        quantityInput.value = itemToEdit.quantity;

                        // Remove from list to be re-added on submit
                        poItems.splice(index, 1);
                        renderPoItems();
                        productSearchInput.focus();
                    }
                });


                // --- Save/Submit PO ---
                async function savePO(status) {
                    if (!shopSelect.value || !vendorSelect.value || !poNumberInput.value) {
                        showModalMessage('Validation Error', "Please select a shop and vendor.", true);
                        return;
                    }
                    if (poItems.length === 0) {
                        showModalMessage('Validation Error', "Please add at least one product to the PO.", true);
                        return;
                    }

                    const totalAmount = poItems.reduce((sum, item) => sum + (item.cost * item.quantity), 0);
                    const poId = poIdInput.value;

                    const poData = {
                        poNumber: poNumberInput.value,
                        shopId: shopSelect.value,
                        shopName: shopSelect.options[shopSelect.selectedIndex].dataset.name,
                        vendorId: vendorSelect.value,
                        vendorName: vendorSelect.options[vendorSelect.selectedIndex].dataset.name,
                        requestDate: new Date(reqDateInput.value),
                        status: status, // 'draft' or 'submitted'
                        items: poItems,
                        totalAmount: totalAmount,
                        createdBy: currentUserId,
                        updatedAt: serverTimestamp()
                    };

                    try {
                        if (status === 'submitted') {
                            await generatePoPdf(poData);
                        }

                        if (poId) { // If we are editing an existing PO
                            await updateDoc(doc(db, "purchaseOrders", poId), poData);
                        } else { // If we are creating a new one
                            poData.createdAt = serverTimestamp();
                            await addDoc(collection(db, "purchaseOrders"), poData);
                        }
                        showModalMessage('Success', `PO successfully ${status}!`);
                        loadPage('po-request'); // Reset the page
                    } catch (error) {
                        console.error("Error saving PO: ", error);
                        showModalMessage('Error', "Failed to save PO. See console for details.", true);
                    }
                }

                if (poDataToEdit) {
                    poRequestTitle.textContent = 'Edit Purchase Order';
                    poIdInput.value = poDataToEdit.id;
                    poNumberInput.value = poDataToEdit.poNumber;
                    reqDateInput.value = poDataToEdit.requestDate.toDate().toLocaleDateString('en-CA');
                    poItems = poDataToEdit.items;
                    renderPoItems();
                    // Dropdowns are populated via onSnapshot listeners above
                }

                cancelPoBtn.addEventListener('click', () => {
                    loadPage('po-request');
                });
                saveDraftBtn.addEventListener('click', () => savePO('draft'));
                submitPoBtn.addEventListener('click', () => savePO('submitted'));
            }

            function setupShopList() {
                const addShopForm = document.getElementById('add-shop-form');
                const shopsListContainer = document.getElementById('shops-list-container');
                const shopFormTitle = document.getElementById('shop-form-title');
                const shopFormButtons = document.getElementById('shop-form-buttons');
                const shopIdInput = document.getElementById('shop-id');
                const shopNameInput = document.getElementById('shop-name');
                const shopContactInput = document.getElementById('shop-contact');
                const shopAddressInput = document.getElementById('shop-address');

                const resetShopForm = () => {
                    addShopForm.reset();
                    shopIdInput.value = '';
                    shopFormTitle.textContent = 'Add New Shop';
                    shopFormButtons.innerHTML = `
                        <button type="submit" class="bg-blue-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition duration-150 ease-in-out">
                            <i class="fas fa-plus-circle mr-2"></i>Add Shop
                        </button>`;
                }

                addShopForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const shopId = shopIdInput.value;
                    const shopData = {
                        name: shopNameInput.value,
                        contact: shopContactInput.value,
                        address: shopAddressInput.value,
                    };

                    try {
                        if (shopId) {
                            await updateDoc(doc(db, "shops", shopId), shopData);
                        } else {
                            await addDoc(collection(db, "shops"), shopData);
                        }
                        resetShopForm();
                    } catch (error) {
                        console.error("Error saving shop: ", error);
                    }
                });

                shopsListContainer.addEventListener('click', async (e) => {
                    const target = e.target.closest('button');
                    if (!target) return;

                    const shopId = target.dataset.id;
                    if (!shopId) return;

                    if (target.classList.contains('delete-shop')) {
                        try {
                            await deleteDoc(doc(db, "shops", shopId));
                            resetShopForm();
                        } catch (error) {
                            console.error("Error deleting shop: ", error);
                        }
                    }

                    if (target.classList.contains('edit-shop')) {
                        try {
                            const shopDoc = await getDoc(doc(db, "shops", shopId));
                            if (shopDoc.exists()) {
                                const shop = shopDoc.data();
                                shopIdInput.value = shopDoc.id;
                                shopNameInput.value = shop.name;
                                shopContactInput.value = shop.contact;
                                shopAddressInput.value = shop.address;
                                shopFormTitle.textContent = 'Edit Shop';
                                shopFormButtons.innerHTML = `
                                    <button type="button" id="cancel-edit-shop" class="bg-gray-500 text-white font-bold py-2 px-6 rounded-lg hover:bg-gray-600 mr-2">Cancel</button>
                                    <button type="submit" class="bg-green-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-green-700"><i class="fas fa-save mr-2"></i>Update Shop</button>
                                `;
                                document.getElementById('cancel-edit-shop').addEventListener('click', resetShopForm);
                                window.scrollTo(0, 0);
                            }
                        } catch (error) {
                            console.error("Error fetching shop for edit: ", error);
                        }
                    }
                });

                onSnapshot(collection(db, "shops"), (snapshot) => {
                    if (snapshot.empty) {
                        shopsListContainer.innerHTML = `<p class="p-4 text-gray-500 text-center">No shops have been added yet.</p>`;
                        return;
                    }
                    let tableHtml = `<table class="min-w-full divide-y divide-gray-200"><thead class="bg-gray-50"><tr><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">No.</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Contact</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Address</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th></tr></thead><tbody class="bg-white divide-y divide-gray-200">`;
                    let index = 1;
                    snapshot.forEach(doc => {
                        const shop = doc.data();
                        tableHtml += `<tr>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${index++}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${shop.name}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${shop.contact}</td>
                            <td class="px-6 py-4 text-sm text-gray-500">${shop.address}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium space-x-2">
                                <button data-id="${doc.id}" class="edit-shop text-blue-600 hover:text-blue-900"><i class="fas fa-edit"></i></button>
                                <button data-id="${doc.id}" class="delete-shop text-red-600 hover:text-red-900"><i class="fas fa-trash"></i></button>
                            </td>
                        </tr>`;
                    });
                    tableHtml += `</tbody></table>`;
                    shopsListContainer.innerHTML = tableHtml;
                });
            }

            function setupUserProfile() {
                const addUserForm = document.getElementById('add-user-form');
                const usersListContainer = document.getElementById('users-list-container');
                const userFormTitle = document.getElementById('user-form-title');
                const userFormButtons = document.getElementById('user-form-buttons');
                const userDocIdInput = document.getElementById('user-doc-id');
                const userNameInput = document.getElementById('user-name');
                const userEmailInput = document.getElementById('user-email');
                const userRoleInput = document.getElementById('user-role');
                const userUidInput = document.getElementById('user-uid');
                const userFormShops = document.getElementById('user-form-shops');
                const userFormPermissions = document.getElementById('user-form-permissions');

                const resetUserForm = () => {
                    addUserForm.reset();
                    userDocIdInput.value = '';
                    userFormTitle.textContent = 'Add New User';
                    userFormButtons.innerHTML = `
                        <button type="submit" class="bg-blue-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition duration-150 ease-in-out">
                            <i class="fas fa-plus-circle mr-2"></i>Add User
                        </button>`;
                };
                
                onSnapshot(collection(db, "shops"), (snapshot) => {
                    userFormShops.innerHTML = snapshot.empty ? `<p class="text-gray-500">Please add shops first.</p>` : snapshot.docs.map(doc => `<label class="flex items-center"><input type="checkbox" name="assignedShops" value="${doc.id}" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500 mr-2">${doc.data().name}</label>`).join('');
                });

                addUserForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const userDocId = userDocIdInput.value;
                    const userData = {
                        name: userNameInput.value,
                        email: userEmailInput.value,
                        role: userRoleInput.value,
                        assignedShops: Array.from(userFormShops.querySelectorAll('input[name="assignedShops"]:checked')).map(el => el.value),
                        permissions: Array.from(userFormPermissions.querySelectorAll('input[name="permissions"]:checked')).map(el => el.value),
                    };

                    try {
                        if (userDocId) {
                            await updateDoc(doc(db, "users", userDocId), userData);
                        } else {
                            await addDoc(collection(db, "users"), { ...userData, uid: "" }); // uid is blank until linked
                        }
                        resetUserForm();
                    } catch (error) {
                        console.error("Error saving user: ", error);
                    }
                });

                usersListContainer.addEventListener('click', async (e) => {
                    const target = e.target.closest('button');
                    if (!target) return;

                    const userId = target.dataset.id;
                    if (!userId) return;

                    if (target.classList.contains('delete-user')) {
                        showConfirmation('Delete User', `Are you sure you want to delete this user?`, async () => {
                            try {
                                await deleteDoc(doc(db, "users", userId));
                                resetUserForm();
                            } catch (error) {
                                console.error("Error deleting user: ", error);
                            }
                        });
                    } else if (target.classList.contains('link-user')) {
                        showModalMessage('Feature Not Implemented', 'This feature requires creating an authentication user first, which cannot be done securely from the client-side. Please create users in the Firebase Authentication console and then link their UID here.');
                    } else if (target.classList.contains('edit-user')) {
                        try {
                            const userDoc = await getDoc(doc(db, "users", userId));
                            if (userDoc.exists()) {
                                const user = userDoc.data();
                                userDocIdInput.value = userDoc.id;
                                userNameInput.value = user.name;
                                userEmailInput.value = user.email;
                                userRoleInput.value = user.role;
                                userUidInput.value = user.uid; // Show linked auth UID

                                userFormShops.querySelectorAll('input').forEach(c => c.checked = false);
                                if(user.assignedShops) {
                                    user.assignedShops.forEach(shopId => {
                                        const checkbox = userFormShops.querySelector(`input[value="${shopId}"]`);
                                        if(checkbox) checkbox.checked = true;
                                    });
                                }

                                userFormPermissions.querySelectorAll('input').forEach(c => c.checked = false);
                                if(user.permissions) {
                                    user.permissions.forEach(perm => {
                                        const checkbox = userFormPermissions.querySelector(`input[value="${perm}"]`);
                                        if(checkbox) checkbox.checked = true;
                                    });
                                }

                                userFormTitle.textContent = 'Edit User';
                                userFormButtons.innerHTML = `
                                    <button type="button" id="cancel-edit-user" class="bg-gray-500 text-white font-bold py-2 px-6 rounded-lg hover:bg-gray-600 mr-2">Cancel</button>
                                    <button type="submit" class="bg-green-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-green-700"><i class="fas fa-save mr-2"></i>Update User</button>
                                `;
                                document.getElementById('cancel-edit-user').addEventListener('click', resetUserForm);
                                window.scrollTo(0, 0);
                            }
                        } catch (error) {
                            console.error("Error fetching user for edit: ", error);
                        }
                    }
                });

                 onSnapshot(collection(db, "users"), (snapshot) => {
                    if (snapshot.empty) {
                        usersListContainer.innerHTML = `<p class="p-4 text-gray-500 text-center">No users have been added yet.</p>`;
                        return;
                    }
                    let tableHtml = `<table class="min-w-full divide-y divide-gray-200"><thead class="bg-gray-50"><tr><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Email</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Role</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Linked Auth UID</th><th class="relative px-6 py-3">Actions</th></tr></thead><tbody class="bg-white divide-y divide-gray-200">`;
                    snapshot.forEach(doc => {
                        const user = doc.data();
                        tableHtml += `<tr>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${user.name}</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${user.email}</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${user.role}</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500" style="word-break: break-all;">${user.uid || 'Not Linked'}</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium space-x-2">
                                            <button data-id="${doc.id}" class="link-user text-purple-600 hover:text-purple-900" title="Link this profile to your current login"><i class="fas fa-link"></i></button>
                                            <button data-id="${doc.id}" class="edit-user text-blue-600 hover:text-blue-900" title="Edit User"><i class="fas fa-edit"></i></button>
                                            <button data-id="${doc.id}" class="delete-user text-red-600 hover:text-red-900" title="Delete User"><i class="fas fa-trash"></i></button>
                                        </td>
                                      </tr>`;
                    });
                    tableHtml += `</tbody></table>`;
                    usersListContainer.innerHTML = tableHtml;
                });
            }

            function setupProductList() {
                const importBtn = document.getElementById('import-product-btn');
                const templateBtn = document.getElementById('download-template-btn');
                const exportBtn = document.getElementById('export-product-btn');
                const fileInput = document.getElementById('product-csv-input');

                const addProductForm = document.getElementById('add-product-form');
                const productsListContainer = document.getElementById('products-list-container');
                const productFormTitle = document.getElementById('product-form-title');
                const productFormButtons = document.getElementById('product-form-buttons');
                const productIdInput = document.getElementById('product-id');
                const productCodeInput = document.getElementById('product-code');
                const productBarcodeInput = document.getElementById('product-barcode');
                const productNameInput = document.getElementById('product-name');
                const productVendorSelect = document.getElementById('product-vendor');
                const productCostInput = document.getElementById('product-cost');
                const productPriceInput = document.getElementById('product-price');
                const productNoteInput = document.getElementById('product-note');

                // --- Import/Export/Template Logic ---
                importBtn.addEventListener('click', () => fileInput.click());
                templateBtn.addEventListener('click', downloadProductTemplate);
                exportBtn.addEventListener('click', exportProductsToCSV);
                fileInput.addEventListener('change', handleProductImport);

                function downloadProductTemplate() {
                    const headers = ["Product Code", "Barcode", "Product Name", "Vendor Name", "Cost", "Sale Price", "Note"];
                    const csvContent = "data:text/csv;charset=utf-8," + headers.join(",");
                    const encodedUri = encodeURI(csvContent);
                    const link = document.createElement("a");
                    link.setAttribute("href", encodedUri);
                    link.setAttribute("download", "product_template.csv");
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                }

                async function exportProductsToCSV() {
                    const productsQuery = await getDocs(collection(db, "products"));
                    let csvContent = "data:text/csv;charset=utf-8,";
                    const headers = ["Product Code", "Barcode", "Product Name", "Vendor Name", "Cost", "Sale Price", "Note"];
                    csvContent += headers.join(",") + "\r\n";

                    productsQuery.forEach(doc => {
                        const product = doc.data();
                        const row = [
                            `"${product.code || ''}"`,
                            `"${product.barcode || ''}"`,
                            `"${product.name || ''}"`,
                            `"${product.vendorName || ''}"`,
                            product.cost || 0,
                            product.price || 0,
                            `"${product.note || ''}"`
                        ];
                        csvContent += row.join(",") + "\r\n";
                    });

                    const encodedUri = encodeURI(csvContent);
                    const link = document.createElement("a");
                    link.setAttribute("href", encodedUri);
                    link.setAttribute("download", "products.csv");
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                }

                async function handleProductImport(event) {
                    const file = event.target.files[0];
                    if (!file) return;

                    const reader = new FileReader();
                    reader.onload = async (e) => {
                        const text = e.target.result;
                        const lines = text.split('\n').filter(line => line.trim() !== '');
                        const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
                        
                        const requiredHeaders = ["Product Code", "Product Name", "Vendor Name", "Cost", "Sale Price"];
                        const missingHeaders = requiredHeaders.filter(h => !headers.includes(h));
                        if(missingHeaders.length > 0) {
                            showModalMessage('Import Error', `CSV is missing required headers: ${missingHeaders.join(', ')}`, true);
                            return;
                        }

                        const batch = writeBatch(db);
                        const vendorsCache = {}; // Cache to avoid repeated lookups
                        const vendorsQuery = await getDocs(collection(db, "vendors"));
                        vendorsQuery.forEach(doc => {
                            vendorsCache[doc.data().name] = doc.id;
                        });


                        for (let i = 1; i < lines.length; i++) {
                            const data = lines[i].split(',').map(d => d.trim().replace(/"/g, ''));
                            let rowData = {};
                            headers.forEach((header, index) => {
                                rowData[header] = data[index];
                            });

                            const vendorName = rowData["Vendor Name"];
                            const vendorId = vendorsCache[vendorName];

                            if (!vendorId) {
                                console.warn(`Vendor "${vendorName}" not found for product "${rowData["Product Name"]}". Skipping.`);
                                continue; // Skip this product if vendor not found
                            }

                            const productRef = doc(collection(db, "products"));
                            batch.set(productRef, {
                                code: rowData["Product Code"],
                                barcode: rowData["Barcode"] || "",
                                name: rowData["Product Name"],
                                vendorId: vendorId,
                                vendorName: vendorName,
                                cost: parseFloat(rowData["Cost"]) || 0,
                                price: parseFloat(rowData["Sale Price"]) || 0,
                                note: rowData["Note"] || ""
                            });
                        }

                        try {
                            await batch.commit();
                            showModalMessage('Success', 'Products imported successfully!');
                        } catch (error) {
                            console.error('Error importing products: ', error);
                            showModalMessage('Error', 'Error importing products.', true);
                        }
                    };
                    reader.readAsText(file);
                    fileInput.value = ''; // Reset file input
                }


                // Populate vendor dropdown
                onSnapshot(collection(db, "vendors"), (snapshot) => {
                    let optionsHtml = '<option value="">Select Vendor</option>';
                    snapshot.forEach(doc => {
                        optionsHtml += `<option value="${doc.id}" data-name="${doc.data().name}">${doc.data().name}</option>`;
                    });
                    productVendorSelect.innerHTML = optionsHtml;
                });

                const resetProductForm = () => {
                    addProductForm.reset();
                    productIdInput.value = '';
                    productFormTitle.textContent = 'Add New Product';
                    productFormButtons.innerHTML = `
                        <button type="submit" class="bg-blue-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition duration-150 ease-in-out">
                            <i class="fas fa-plus-circle mr-2"></i>Add Product
                        </button>`;
                };

                addProductForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const productId = productIdInput.value;
                    const selectedVendorOption = productVendorSelect.options[productVendorSelect.selectedIndex];
                    const productData = {
                        code: productCodeInput.value,
                        barcode: productBarcodeInput.value,
                        name: productNameInput.value,
                        vendorId: selectedVendorOption.value,
                        vendorName: selectedVendorOption.dataset.name,
                        cost: parseFloat(productCostInput.value),
                        price: parseFloat(productPriceInput.value),
                        note: productNoteInput.value,
                    };

                    try {
                        if (productId) {
                            await updateDoc(doc(db, "products", productId), productData);
                        } else {
                            await addDoc(collection(db, "products"), productData);
                        }
                        resetProductForm();
                    } catch (error) {
                        console.error("Error saving product: ", error);
                    }
                });

                productsListContainer.addEventListener('click', async (e) => {
                    const target = e.target.closest('button');
                    if (!target) return;

                    const productId = target.dataset.id;
                    if (!productId) return;

                    if (target.classList.contains('delete-product')) {
                        showConfirmation('Delete Product', 'Are you sure you want to delete this product?', async () => {
                            try {
                                await deleteDoc(doc(db, "products", productId));
                                resetProductForm();
                            } catch (error) {
                                console.error("Error deleting product: ", error);
                            }
                        });
                    }

                    if (target.classList.contains('edit-product')) {
                        try {
                            const productDoc = await getDoc(doc(db, "products", productId));
                            if (productDoc.exists()) {
                                const product = productDoc.data();
                                productIdInput.value = productDoc.id;
                                productCodeInput.value = product.code;
                                productBarcodeInput.value = product.barcode;
                                productNameInput.value = product.name;
                                productVendorSelect.value = product.vendorId;
                                productCostInput.value = product.cost;
                                productPriceInput.value = product.price;
                                productNoteInput.value = product.note;

                                productFormTitle.textContent = 'Edit Product';
                                productFormButtons.innerHTML = `
                                    <button type="button" id="cancel-edit-product" class="bg-gray-500 text-white font-bold py-2 px-6 rounded-lg hover:bg-gray-600 mr-2">Cancel</button>
                                    <button type="submit" class="bg-green-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-green-700"><i class="fas fa-save mr-2"></i>Update Product</button>
                                `;
                                document.getElementById('cancel-edit-product').addEventListener('click', resetProductForm);
                                window.scrollTo(0, 0);
                            }
                        } catch (error) {
                            console.error("Error fetching product for edit: ", error);
                        }
                    }

                    if (target.classList.contains('view-cost-history')) {
                        const productName = target.dataset.name;
                        openCostHistoryModal(productId, productName);
                    }
                });

                onSnapshot(collection(db, "products"), (snapshot) => {
                    if (snapshot.empty) {
                        productsListContainer.innerHTML = `<p class="p-4 text-gray-500 text-center">No products have been added yet.</p>`;
                        return;
                    }
                    let tableHtml = `<table class="min-w-full divide-y divide-gray-200"><thead class="bg-gray-50"><tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Code</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Vendor</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Cost</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Price</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                    </tr></thead><tbody class="bg-white divide-y divide-gray-200">`;
                    snapshot.forEach(doc => {
                        const product = doc.data();
                        tableHtml += `<tr>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${product.code}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${product.name}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${product.vendorName || ''}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${product.cost}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${product.price}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium space-x-2">
                                <button data-id="${doc.id}" class="edit-product text-blue-600 hover:text-blue-900"><i class="fas fa-edit"></i></button>
                                <button data-id="${doc.id}" class="delete-product text-red-600 hover:text-red-900"><i class="fas fa-trash"></i></button>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                <button data-id="${doc.id}" data-name="${product.name}" class="view-cost-history text-green-600 hover:text-green-900"><i class="fas fa-history mr-1"></i> View History</button>
                            </td>
                        </tr>`;
                    });
                    tableHtml += `</tbody></table>`;
                    productsListContainer.innerHTML = tableHtml;
                });
            }
            
            async function openCostHistoryModal(productId, productName) {
                const modalBackdrop = document.getElementById('audit-modal-backdrop');
                const modal = document.getElementById('audit-modal');
                
                let modalHtml = `
                    <div class="p-4 border-b border-gray-200 flex justify-between items-center">
                        <h3 class="text-xl font-semibold text-gray-800">Cost History for: ${productName}</h3>
                        <button id="close-history-modal-btn" class="text-gray-500 hover:text-gray-800 text-2xl">&times;</button>
                    </div>
                    <div class="p-4 flex-grow overflow-y-auto">
                        <div id="history-table-container">
                            <p class="text-center text-gray-500">Loading history...</p>
                        </div>
                    </div>
                    <div class="p-4 border-t border-gray-200 flex justify-end">
                        <button id="close-history-modal-btn-2" type="button" class="bg-gray-500 text-white font-bold py-2 px-6 rounded-lg hover:bg-gray-600">Close</button>
                    </div>
                `;
                modal.innerHTML = modalHtml;
                modalBackdrop.classList.remove('hidden');
                modalBackdrop.classList.add('flex');

                const closeModal = () => {
                    modalBackdrop.classList.add('hidden');
                    modalBackdrop.classList.remove('flex');
                    modal.innerHTML = '';
                };

                document.getElementById('close-history-modal-btn').addEventListener('click', closeModal);
                document.getElementById('close-history-modal-btn-2').addEventListener('click', closeModal);

                try {
                    const historyCollectionRef = collection(db, "products", productId, "costHistory");
                    const historySnapshot = await getDocs(historyCollectionRef);
                    const historyTableContainer = document.getElementById('history-table-container');

                    if (historySnapshot.empty) {
                        historyTableContainer.innerHTML = `<p class="text-center text-gray-500">No cost history found for this product.</p>`;
                        return;
                    }

                    let tableContent = `<table class="min-w-full divide-y divide-gray-200 text-sm">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="px-4 py-2 text-left font-medium text-gray-600 uppercase">Date</th>
                                <th class="px-4 py-2 text-left font-medium text-gray-600 uppercase">PO Number</th>
                                <th class="px-4 py-2 text-right font-medium text-gray-600 uppercase">New Cost</th>
                                <th class="px-4 py-2 text-left font-medium text-gray-600 uppercase">Audited By</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">`;
                    
                    historySnapshot.docs.forEach(doc => {
                        const history = doc.data();
                        tableContent += `
                            <tr>
                                <td class="px-4 py-2 whitespace-nowrap">${history.updatedAt.toDate().toLocaleString()}</td>
                                <td class="px-4 py-2 whitespace-nowrap">${history.poNumber}</td>
                                <td class="px-4 py-2 text-right">${history.newCost.toFixed(2)}</td>
                                <td class="px-4 py-2 whitespace-nowrap">${history.auditedByName}</td>
                            </tr>
                        `;
                    });

                    tableContent += `</tbody></table>`;
                    historyTableContainer.innerHTML = tableContent;
                } catch (error) {
                    console.error("Error fetching cost history:", error);
                    document.getElementById('history-table-container').innerHTML = `<p class="text-center text-red-500">Could not load cost history.</p>`;
                }
            }


            function setupVendorList() {
                const importVendorBtn = document.getElementById('import-vendor-btn');
                const vendorCsvInput = document.getElementById('vendor-csv-input');
                const addVendorForm = document.getElementById('add-vendor-form');
                const vendorsListContainer = document.getElementById('vendors-list-container');
                const vendorFormTitle = document.getElementById('vendor-form-title');
                const vendorFormButtons = document.getElementById('vendor-form-buttons');
                const vendorIdInput = document.getElementById('vendor-id');
                const vendorNameInput = document.getElementById('vendor-name');
                const vendorContactInput = document.getElementById('vendor-contact');

                importVendorBtn.addEventListener('click', () => vendorCsvInput.click());
                vendorCsvInput.addEventListener('change', handleVendorImport);

                async function handleVendorImport(event) {
                    const file = event.target.files[0];
                    if (!file) return;

                    const reader = new FileReader();
                    reader.onload = async (e) => {
                        const text = e.target.result;
                        const rows = text.split('\n').slice(1); // Skip header row
                        const batch = writeBatch(db);

                        rows.forEach(row => {
                            const columns = row.split(',');
                            if (columns.length >= 2) {
                                const vendorRef = doc(collection(db, "vendors"));
                                batch.set(vendorRef, { 
                                    name: columns[0].trim(), 
                                    contact: columns[1].trim() 
                                });
                            }
                        });

                        try {
                            await batch.commit();
                            showModalMessage('Success', 'Vendors imported successfully!');
                        } catch (error) {
                            console.error('Error importing vendors: ', error);
                            showModalMessage('Error', 'Error importing vendors.', true);
                        }
                    };
                    reader.readAsText(file);
                    vendorCsvInput.value = ''; // Reset file input
                }

                const resetVendorForm = () => {
                    addVendorForm.reset();
                    vendorIdInput.value = '';
                    vendorFormTitle.textContent = 'Add New Vendor';
                    vendorFormButtons.innerHTML = `
                        <button type="submit" class="bg-blue-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition duration-150 ease-in-out">
                            <i class="fas fa-plus-circle mr-2"></i>Add Vendor
                        </button>`;
                }

                addVendorForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const vendorId = vendorIdInput.value;
                    const vendorData = {
                        name: vendorNameInput.value,
                        contact: vendorContactInput.value,
                    };

                    try {
                        if (vendorId) {
                            await updateDoc(doc(db, "vendors", vendorId), vendorData);
                        } else {
                            await addDoc(collection(db, "vendors"), vendorData);
                        }
                        resetVendorForm();
                    } catch (error) {
                        console.error("Error saving vendor: ", error);
                    }
                });

                vendorsListContainer.addEventListener('click', async (e) => {
                    const target = e.target.closest('button');
                    if (!target) return;

                    const vendorId = target.dataset.id;
                    if (!vendorId) return;

                    if (target.classList.contains('delete-vendor')) {
                        showConfirmation('Delete Vendor', 'Are you sure you want to delete this vendor?', async () => {
                            try {
                                await deleteDoc(doc(db, "vendors", vendorId));
                                resetVendorForm();
                            } catch (error) {
                                console.error("Error deleting vendor: ", error);
                            }
                        });
                    }

                    if (target.classList.contains('edit-vendor')) {
                        try {
                            const vendorDoc = await getDoc(doc(db, "vendors", vendorId));
                            if (vendorDoc.exists()) {
                                const vendor = vendorDoc.data();
                                vendorIdInput.value = vendorDoc.id;
                                vendorNameInput.value = vendor.name;
                                vendorContactInput.value = vendor.contact;
                                vendorFormTitle.textContent = 'Edit Vendor';
                                vendorFormButtons.innerHTML = `
                                    <button type="button" id="cancel-edit-vendor" class="bg-gray-500 text-white font-bold py-2 px-6 rounded-lg hover:bg-gray-600 mr-2">Cancel</button>
                                    <button type="submit" class="bg-green-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-green-700"><i class="fas fa-save mr-2"></i>Update Vendor</button>
                                `;
                                document.getElementById('cancel-edit-vendor').addEventListener('click', resetVendorForm);
                                window.scrollTo(0, 0);
                            }
                        } catch (error) {
                            console.error("Error fetching vendor for edit: ", error);
                        }
                    }
                });

                onSnapshot(collection(db, "vendors"), (snapshot) => {
                    if (snapshot.empty) {
                        vendorsListContainer.innerHTML = `<p class="p-4 text-gray-500 text-center">No vendors have been added yet.</p>`;
                        return;
                    }
                    let tableHtml = `<table class="min-w-full divide-y divide-gray-200"><thead class="bg-gray-50"><tr><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Contact</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th></tr></thead><tbody class="bg-white divide-y divide-gray-200">`;
                    snapshot.forEach(doc => {
                        const vendor = doc.data();
                        tableHtml += `<tr>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${vendor.name}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${vendor.contact}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium space-x-2">
                                <button data-id="${doc.id}" class="edit-vendor text-blue-600 hover:text-blue-900"><i class="fas fa-edit"></i></button>
                                <button data-id="${doc.id}" class="delete-vendor text-red-600 hover:text-red-900"><i class="fas fa-trash"></i></button>
                            </td>
                        </tr>`;
                    });
                    tableHtml += `</tbody></table>`;
                    vendorsListContainer.innerHTML = tableHtml;
                });
            }


            // --- Event Listeners ---
            sidebarToggle.addEventListener('click', toggleSidebar);
            overlay.addEventListener('click', toggleSidebar);

            sidebarLinks.forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const pageKey = e.currentTarget.dataset.page;
                    sidebarLinks.forEach(l => l.classList.remove('active'));
                    e.currentTarget.classList.add('active');
                    loadPage(pageKey);
                    if (window.innerWidth < 768) toggleSidebar();
                });
            });
            
            // --- Initial Load ---
            listenForUsers(); // Start listening for user data to populate the cache
            if (firstAllowedPage) {
                loadPage(firstAllowedPage);
            } else {
                // If user has no allowed pages, show a message.
                pageContent.innerHTML = `<div class="bg-white p-8 rounded-lg shadow-lg text-center"><i class="fas fa-lock text-5xl text-yellow-500 mb-4"></i><h3 class="text-3xl font-bold text-gray-700">No Access</h3><p class="text-gray-500 mt-2">You do not have permissions for any pages. Please contact an administrator.</p></div>`;
                pageTitle.textContent = "Access Denied";
            }

            // --- Style for active tabs ---
            const style = document.createElement('style');
            style.innerHTML = `
                .tab-link.active-tab { color: #3b82f6; border-color: #3b82f6; }
                .tab-link { color: #6b7280; border-color: transparent; }
                .tab-link:hover { color: #1f2937; border-color: #d1d5db; }
            `;
            document.head.appendChild(style);
        }
    </script>
</body>
</html>
