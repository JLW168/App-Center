<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Purchase Order System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" xintegrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f1f5f9; /* slate-100 */
        }
        /* Custom scrollbar for better aesthetics */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #e2e8f0; /* slate-200 */
        }
        ::-webkit-scrollbar-thumb {
            background: #94a3b8; /* slate-400 */
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #64748b; /* slate-500 */
        }
        /* Active state for sidebar links */
        .sidebar-link.active {
            background-color: #0f172a; /* slate-900 */
            color: white;
            box-shadow: inset 3px 0 0 #3b82f6; /* blue-600 */
        }
        .sidebar-link:hover {
             background-color: #1e293b; /* slate-800 */
        }
        
        #product-search-results div:hover {
            background-color: #e5e7eb; /* gray-200 */
        }
        /* Styles for the printable PO */
        #po-printable {
            position: absolute;
            left: -9999px;
            width: 1123px; /* A4 landscape width in pixels at 96 DPI */
            height: 794px; /* A4 landscape height in pixels at 96 DPI */
            background: white;
            padding: 40px;
            font-size: 12px;
            color: #000;
        }
        /* Styles for Audit Modal */
        #audit-modal-backdrop {
            background-color: rgba(0, 0, 0, 0.6);
        }
        .audit-input {
             width: 100%;
             text-align: right;
             padding: 4px 8px;
             border: 1px solid #d1d5db;
             border-radius: 0.375rem;
             transition: border-color 0.2s, box-shadow 0.2s;
        }
        .audit-input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.4);
        }
        .calculated-field {
            text-align: right;
            padding: 4px 8px;
            background-color: #f3f4f6;
            border-radius: 0.375rem;
        }
        /* Simple loader for login button */
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* Tab styling */
        .tab-link {
            color: #475569; /* slate-600 */
            border-color: transparent;
            transition: color 0.2s, border-color 0.2s;
        }
        .tab-link:hover {
            color: #0f172a; /* slate-900 */
            border-color: #cbd5e1; /* slate-300 */
        }
        .tab-link.active-tab {
            color: #3b82f6; /* blue-600 */
            border-color: #3b82f6;
            font-weight: 600;
        }
    </style>
</head>
<body class="bg-slate-100">
    <!-- App content will be rendered here by JavaScript based on auth state -->
    <div id="app-container" class="flex items-center justify-center h-screen">
        <div class="text-center">
            <i class="fas fa-spinner fa-spin text-5xl text-slate-400 mb-4"></i>
            <h3 class="text-3xl font-bold text-slate-700">Loading Application...</h3>
            <p class="text-slate-500 mt-2">Please wait.</p>
        </div>
    </div>
    
    <!-- Firebase SDKs -->
    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, setDoc, getDoc, updateDoc, deleteDoc, writeBatch, getDocs, query, where, serverTimestamp, Timestamp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";

        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAsw_K2LarDunqh9ePnSRuMjXrzd6WZ1EI",
            authDomain: "posystem-3e373.firebaseapp.com",
            projectId: "posystem-3e373",
            storageBucket: "posystem-3e373.appspot.com",
            messagingSenderId: "783169032599",
            appId: "1:783169032599:web:d44e8956e790a7f9b3b4d2",
            measurementId: "G-G6B8H6HSQC"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth();
        const db = getFirestore(app);
        
        const appContainer = document.getElementById('app-container');
        let currentUserId = null;
        let currentUserProfile = null;

        // --- HTML TEMPLATES ---

        const loginPageHtml = `
            <div class="min-h-screen bg-slate-100 flex items-center justify-center p-4">
                <div class="w-full max-w-md mx-auto bg-white rounded-2xl shadow-xl p-8">
                    <div class="text-center mb-8">
                        <i class="fas fa-file-invoice-dollar text-5xl text-blue-600"></i>
                        <h1 class="text-3xl font-bold text-slate-800 mt-4">PO System</h1>
                        <p class="text-slate-500">Please sign in to continue</p>
                    </div>
                    <form id="login-form" class="space-y-6">
                        <div id="login-error" class="hidden bg-red-100 text-red-700 p-3 rounded-lg text-sm text-center"></div>
                        <div>
                            <label for="login-email" class="block text-sm font-medium text-slate-700">Email Address</label>
                            <input type="email" id="login-email" class="w-full px-4 py-2 mt-1 border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" required />
                        </div>
                        <div>
                            <label for="login-password" class="block text-sm font-medium text-slate-700">Password</label>
                            <input type="password" id="login-password" class="w-full px-4 py-2 mt-1 border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" required />
                        </div>
                        <div>
                            <button type="submit" id="login-button" class="w-full flex justify-center py-3 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 disabled:bg-blue-400 transition duration-150">
                                <span id="login-button-text">Sign In</span>
                                <div id="login-loader" class="loader hidden"></div>
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        `;
        
        const mainAppHtml = `
            <div class="flex h-screen bg-slate-100">
                <!-- Sidebar -->
                <aside id="sidebar" class="w-72 bg-slate-900 text-slate-300 p-4 flex flex-col transform -translate-x-full md:translate-x-0 transition-transform duration-300 ease-in-out z-30 fixed md:relative h-full">
                    <div class="flex items-center mb-10 px-2">
                        <i class="fas fa-file-invoice-dollar text-3xl text-blue-500 mr-3"></i>
                        <h1 class="text-2xl font-bold text-white">PO System</h1>
                    </div>
                    <nav class="flex-grow">
                        <a href="#" class="sidebar-link active flex items-center py-3 px-4 rounded-lg transition duration-200" data-page="po-request">
                            <i class="fas fa-paper-plane w-6 mr-4"></i>
                            <span class="font-medium">PO Request</span>
                        </a>
                        <a href="#" class="sidebar-link flex items-center py-3 px-4 rounded-lg transition duration-200 mt-2" data-page="po-center">
                            <i class="fas fa-inbox w-6 mr-4"></i>
                            <span class="font-medium">PO Center</span>
                        </a>
                        <a href="#" class="sidebar-link flex items-center py-3 px-4 rounded-lg transition duration-200 mt-2" data-page="product-data">
                            <i class="fas fa-database w-6 mr-4"></i>
                            <span class="font-medium">Product Data</span>
                        </a>
                        <a href="#" class="sidebar-link flex items-center py-3 px-4 rounded-lg transition duration-200 mt-2" data-page="settings">
                            <i class="fas fa-cog w-6 mr-4"></i>
                            <span class="font-medium">Settings</span>
                        </a>
                    </nav>
                </aside>

                <!-- Main Content -->
                <div class="flex-1 flex flex-col overflow-hidden">
                    <!-- Header -->
                    <header class="bg-white shadow-sm p-4 flex justify-between items-center z-10">
                        <div class="flex items-center">
                            <button id="sidebar-toggle" class="text-slate-500 focus:outline-none md:hidden mr-4">
                                <i class="fas fa-bars text-2xl"></i>
                            </button>
                            <h2 id="page-title" class="text-2xl font-bold text-slate-800">PO Request</h2>
                        </div>
                        <div id="user-info-header" class="flex items-center">
                            <!-- User info and logout button will be injected here -->
                        </div>
                    </header>

                    <!-- Content Area -->
                    <main class="flex-1 overflow-x-hidden overflow-y-auto bg-slate-100 p-6">
                        <div id="page-content">
                            <!-- Page content will be injected here -->
                        </div>
                    </main>
                </div>
            </div>

            <!-- Overlay for mobile sidebar -->
            <div id="overlay" class="fixed inset-0 bg-black opacity-50 z-20 hidden md:hidden"></div>

            <!-- Modal Container -->
            <div id="audit-modal-backdrop" class="fixed inset-0 z-40 hidden items-center justify-center p-4">
                <div id="audit-modal" class="bg-white rounded-lg shadow-xl w-full max-w-4xl max-h-[95vh] flex flex-col">
                    <!-- Modal content will be injected here -->
                </div>
            </div>
        `;


        // --- AUTHENTICATION CONTROLLER ---
        
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                // User is signed in. Check for their profile in Firestore.
                try {
                    const usersRef = collection(db, "users");
                    const q = query(usersRef, where("uid", "==", user.uid));
                    const querySnapshot = await getDocs(q);

                    if (!querySnapshot.empty) {
                        const userDoc = querySnapshot.docs[0];
                        currentUserId = user.uid;
                        currentUserProfile = { id: userDoc.id, ...userDoc.data() };
                        
                        // Render the main application
                        appContainer.innerHTML = mainAppHtml;
                        initializeAppLogic();
                    } else {
                        // User is authenticated but has no profile in the system.
                        console.error("No user profile found for UID:", user.uid);
                        await signOut(auth);
                        const urlParams = new URLSearchParams(window.location.search);
                        if (!urlParams.has('error')) {
                             window.location.href = window.location.pathname + '?error=no_profile';
                        }
                    }
                } catch (error) {
                    console.error("Error fetching user profile:", error);
                    appContainer.innerHTML = `<div class="flex items-center justify-center h-screen"><div class="text-center"><h3 class="text-2xl font-bold text-red-600">Error</h3><p>Could not connect to the database. Please check your Firestore security rules.</p></div></div>`;
                }
            } else {
                // User is signed out. Render the login page.
                appContainer.innerHTML = loginPageHtml;
                initializeLoginPageLogic();
            }
        });

        // --- LOGIN PAGE LOGIC ---

        function initializeLoginPageLogic() {
            const loginForm = document.getElementById('login-form');
            const emailInput = document.getElementById('login-email');
            const passwordInput = document.getElementById('login-password');
            const errorDiv = document.getElementById('login-error');
            const loginButton = document.getElementById('login-button');
            const loginButtonText = document.getElementById('login-button-text');
            const loginLoader = document.getElementById('login-loader');

            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('error') === 'no_profile') {
                errorDiv.textContent = "Login successful, but no user profile found. Please contact an administrator.";
                errorDiv.classList.remove('hidden');
            }

            loginForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const email = emailInput.value;
                const password = passwordInput.value;

                if (!email || !password) {
                    errorDiv.textContent = "Please enter both email and password.";
                    errorDiv.classList.remove('hidden');
                    return;
                }

                loginButton.disabled = true;
                loginButtonText.classList.add('hidden');
                loginLoader.classList.remove('hidden');
                errorDiv.classList.add('hidden');

                try {
                    await signInWithEmailAndPassword(auth, email, password);
                } catch (err) {
                    console.error("Login error:", err);
                    errorDiv.textContent = "Failed to login. Please check your credentials.";
                    errorDiv.classList.remove('hidden');
                    loginButton.disabled = false;
                    loginButtonText.classList.remove('hidden');
                    loginLoader.classList.add('hidden');
                }
            });
        }


        // --- MAIN APPLICATION LOGIC ---

        function initializeAppLogic() {
            const sidebar = document.getElementById('sidebar');
            const sidebarToggle = document.getElementById('sidebar-toggle');
            const overlay = document.getElementById('overlay');
            const pageTitle = document.getElementById('page-title');
            const pageContent = document.getElementById('page-content');
            const sidebarLinks = document.querySelectorAll('.sidebar-link');
            const userInfoHeader = document.getElementById('user-info-header');

            // --- Setup Header with User Info & Logout ---
            userInfoHeader.innerHTML = `
                <div class="text-right">
                    <div class="font-semibold text-slate-700">${currentUserProfile.name}</div>
                    <div class="text-sm text-slate-500">${currentUserProfile.role}</div>
                </div>
                <button id="logout-btn" class="ml-4 bg-slate-200 text-slate-600 w-10 h-10 rounded-full hover:bg-slate-300 transition duration-150 flex items-center justify-center">
                    <i class="fas fa-sign-out-alt"></i>
                </button>
            `;
            document.getElementById('logout-btn').addEventListener('click', () => {
                signOut(auth);
            });

            // --- Role-Based Access Control (RBAC) for Sidebar ---
            const allowedPages = currentUserProfile.permissions || [];
            let firstAllowedPage = null;

            sidebarLinks.forEach(link => {
                const pageKey = link.dataset.page;
                if (pageKey && !allowedPages.includes(pageKey)) {
                    link.style.display = 'none';
                } else if (pageKey && !firstAllowedPage) {
                    firstAllowedPage = pageKey;
                }
            });
            
            sidebarLinks.forEach(link => {
                link.classList.remove('active');
                if (link.dataset.page === firstAllowedPage) {
                    link.classList.add('active');
                }
            });

            // --- Custom Modal Functions ---
            function showModalMessage(title, message, isError = false) {
                const modalBackdrop = document.getElementById('audit-modal-backdrop');
                const modal = document.getElementById('audit-modal');
                const titleColor = isError ? 'text-red-600' : 'text-slate-800';
                const icon = isError ? '<i class="fas fa-exclamation-circle text-red-500 text-4xl mr-5"></i>' : '<i class="fas fa-info-circle text-blue-500 text-4xl mr-5"></i>';

                modal.innerHTML = `
                    <div class="p-6 border-b border-slate-200">
                        <h3 class="text-xl font-semibold ${titleColor}">${title}</h3>
                    </div>
                    <div class="p-8 flex items-center">
                        ${icon}
                        <p class="text-slate-600">${message}</p>
                    </div>
                    <div class="p-4 bg-slate-50 border-t border-slate-200 flex justify-end rounded-b-lg">
                        <button id="close-message-modal-btn" type="button" class="bg-blue-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-700 transition">OK</button>
                    </div>
                `;
                modalBackdrop.classList.remove('hidden');
                modalBackdrop.classList.add('flex');

                const closeModal = () => {
                    modalBackdrop.classList.add('hidden');
                    modalBackdrop.classList.remove('flex');
                    modal.innerHTML = '';
                };
                modal.querySelector('#close-message-modal-btn').addEventListener('click', closeModal);
            }

            function showConfirmation(title, message, onConfirm) {
                const modalBackdrop = document.getElementById('audit-modal-backdrop');
                const modal = document.getElementById('audit-modal');

                modal.innerHTML = `
                    <div class="p-6 border-b border-slate-200">
                        <h3 class="text-xl font-semibold text-slate-800">${title}</h3>
                    </div>
                    <div class="p-8 flex items-start">
                        <i class="fas fa-question-circle text-yellow-500 text-4xl mr-5 mt-1"></i>
                        <div>
                            <p class="text-slate-600">${message}</p>
                            <p class="text-sm text-slate-500 mt-2">This action cannot be undone.</p>
                        </div>
                    </div>
                    <div class="p-4 bg-slate-50 border-t border-slate-200 flex justify-end gap-4 rounded-b-lg">
                        <button id="confirm-cancel-btn" type="button" class="bg-slate-200 text-slate-800 font-bold py-2 px-6 rounded-lg hover:bg-slate-300 transition">Cancel</button>
                        <button id="confirm-ok-btn" type="button" class="bg-red-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-red-700 transition">Confirm</button>
                    </div>
                `;
                modalBackdrop.classList.remove('hidden');
                modalBackdrop.classList.add('flex');
                
                const closeModal = () => {
                    modalBackdrop.classList.add('hidden');
                    modalBackdrop.classList.remove('flex');
                    modal.innerHTML = '';
                };

                modal.querySelector('#confirm-cancel-btn').addEventListener('click', closeModal);
                modal.querySelector('#confirm-ok-btn').addEventListener('click', () => {
                    closeModal();
                    onConfirm();
                });
            }

            // --- Page Content Templates ---
            const pages = {
                'po-request': {
                    title: 'PO Request',
                    content: `
                        <div class="bg-white p-6 rounded-lg shadow-md">
                            <h3 id="po-request-title" class="text-2xl font-semibold text-slate-800 mb-6 border-b pb-4">Create Purchase Order</h3>
                            <input type="hidden" id="po-id">
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                                <div><label for="po-shop-name" class="block text-sm font-medium text-slate-700 mb-1">Shop Name</label><select id="po-shop-name" class="w-full px-3 py-2 border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" required><option value="">Loading Shops...</option></select></div>
                                <div><label for="po-vendor" class="block text-sm font-medium text-slate-700 mb-1">Vendor</label><select id="po-vendor" class="w-full px-3 py-2 border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" required><option value="">Loading Vendors...</option></select></div>
                                <div><label for="po-number" class="block text-sm font-medium text-slate-700 mb-1">PO No.</label><input type="text" id="po-number" class="w-full px-3 py-2 border border-slate-300 rounded-md shadow-sm bg-slate-100" readonly></div>
                                <div><label for="po-req-date" class="block text-sm font-medium text-slate-700 mb-1">Req Date</label><input type="text" id="po-req-date" class="w-full px-3 py-2 border border-slate-300 rounded-md shadow-sm bg-slate-100" readonly></div>
                            </div>
                        </div>

                        <div class="bg-white p-6 rounded-lg shadow-md mt-6">
                            <h4 class="text-xl font-semibold text-slate-700 mb-4">Add Product to PO</h4>
                            <form id="add-po-item-form" class="grid grid-cols-1 md:grid-cols-12 gap-4 items-end">
                                <div class="md:col-span-4 relative">
                                    <label for="po-product-search" class="block text-sm font-medium text-slate-700 mb-1">Product Code/Barcode/Name</label>
                                    <input type="text" id="po-product-search" class="w-full px-3 py-2 border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" autocomplete="off">
                                    <div id="product-search-results" class="absolute z-10 w-full bg-white border border-slate-300 rounded-md mt-1 shadow-lg max-h-60 overflow-y-auto hidden"></div>
                                </div>
                                <div class="md:col-span-5">
                                    <label for="po-product-name" class="block text-sm font-medium text-slate-700 mb-1">Product Name</label>
                                    <input type="text" id="po-product-name" class="w-full px-3 py-2 border border-slate-300 rounded-md shadow-sm bg-slate-100" readonly>
                                    <input type="hidden" id="po-selected-product-id"><input type="hidden" id="po-selected-product-code"><input type="hidden" id="po-selected-product-barcode"><input type="hidden" id="po-selected-product-vendor-name"><input type="hidden" id="po-selected-product-cost">
                                </div>
                                <div class="md:col-span-2">
                                    <label for="po-item-quantity" class="block text-sm font-medium text-slate-700 mb-1">Quantity</label>
                                    <input type="number" id="po-item-quantity" min="1" value="1" class="w-full px-3 py-2 border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                </div>
                                <div class="md:col-span-1">
                                    <button type="submit" class="w-full bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition">Add</button>
                                </div>
                            </form>
                        </div>

                        <div class="bg-white p-6 rounded-lg shadow-md mt-6">
                            <h4 class="text-xl font-semibold text-slate-700 mb-4">PO Items</h4>
                            <div id="po-items-container" class="overflow-x-auto">
                                <p class="p-4 text-slate-500 text-center">No products added yet.</p>
                            </div>
                        </div>
                        
                        <div class="mt-8 flex flex-wrap justify-end gap-3">
                            <button id="cancel-po-req" class="bg-slate-500 text-white font-bold py-2 px-6 rounded-lg hover:bg-slate-600 transition">Cancel Req.</button>
                            <button id="save-draft-po" class="bg-yellow-500 text-white font-bold py-2 px-6 rounded-lg hover:bg-yellow-600 transition">Save Draft</button>
                            <button id="submit-po" class="bg-green-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-green-700 transition">Submit PO</button>
                        </div>
                    <div id="po-printable"></div>
                    `
                },
                'po-center': {
                    title: 'PO Center',
                    content: `<div class="bg-white rounded-lg shadow-md"><div class="border-b border-slate-200"><nav class="flex -mb-px px-6" aria-label="Tabs" id="po-center-tabs"><a href="#" class="tab-link active-tab whitespace-nowrap py-4 px-1 mr-8 border-b-2 text-sm font-medium" data-tab="drafts-po">Drafts PO</a><a href="#" class="tab-link whitespace-nowrap py-4 px-1 mx-8 border-b-2 text-sm font-medium" data-tab="active-po">Active PO</a><a href="#" class="tab-link whitespace-nowrap py-4 px-1 ml-8 border-b-2 text-sm font-medium" data-tab="audited-po">Audited PO</a></nav></div><div id="po-center-tab-content" class="p-6"></div></div>`
                },
                'product-data': {
                    title: 'Product Data',
                    content: `<div class="bg-white rounded-lg shadow-md"><div class="border-b border-slate-200"><nav class="flex -mb-px px-6" aria-label="Tabs" id="product-data-tabs"><a href="#" class="tab-link active-tab whitespace-nowrap py-4 px-1 mr-8 border-b-2 text-sm font-medium" data-tab="product-list">Product List</a><a href="#" class="tab-link whitespace-nowrap py-4 px-1 mx-8 border-b-2 text-sm font-medium" data-tab="vendor-list">Vendor List</a></nav></div><div id="product-data-tab-content" class="p-6"></div></div>`
                },
                'settings': {
                    title: 'Settings',
                    content: `<div class="bg-white rounded-lg shadow-md"><div class="border-b border-slate-200"><nav class="flex -mb-px px-6" aria-label="Tabs" id="settings-tabs"><a href="#" class="tab-link active-tab whitespace-nowrap py-4 px-1 mr-8 border-b-2 text-sm font-medium" data-tab="shop-list">Shop List</a><a href="#" class="tab-link whitespace-nowrap py-4 px-1 mx-8 border-b-2 text-sm font-medium" data-tab="user-profile">User Management</a></nav></div><div id="settings-tab-content" class="p-6"></div></div>`
                }
            };

            const poCenterTabs = {
                'drafts-po': `<div id="drafts-po-container"></div>`,
                'active-po': `<div id="active-po-container"></div>`,
                'audited-po': `<div id="audited-po-container"></div>`
            };

            const productDataTabs = {
                'product-list': `
                    <div>
                        <div class="flex justify-between items-center mb-6 flex-wrap gap-4">
                            <h3 class="text-2xl font-semibold text-slate-800">Product Data</h3>
                            <div class="flex flex-wrap items-center gap-2">
                                <button id="import-product-btn" class="bg-teal-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-teal-600 transition"><i class="fas fa-file-import mr-2"></i>Import</button>
                                <button id="download-template-btn" class="bg-slate-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-slate-600 transition"><i class="fas fa-download mr-2"></i>Template</button>
                                <button id="export-product-btn" class="bg-green-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-600 transition"><i class="fas fa-file-export mr-2"></i>Export</button>
                                <input type="file" id="product-csv-input" class="hidden" accept=".csv">
                            </div>
                        </div>
                        <div class="mb-8">
                            <h4 id="product-form-title" class="text-xl font-semibold mb-4 text-slate-700">Add New Product</h4>
                            <form id="add-product-form" class="p-6 bg-slate-50 rounded-lg border border-slate-200">
                                <input type="hidden" id="product-id">
                                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                    <div><label for="product-code" class="block text-sm font-medium text-slate-700 mb-1">Product Code</label><input type="text" id="product-code" class="w-full px-3 py-2 border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" required></div>
                                    <div><label for="product-barcode" class="block text-sm font-medium text-slate-700 mb-1">Barcode</label><input type="text" id="product-barcode" class="w-full px-3 py-2 border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"></div>
                                    <div><label for="product-name" class="block text-sm font-medium text-slate-700 mb-1">Product Name</label><input type="text" id="product-name" class="w-full px-3 py-2 border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" required></div>
                                    <div><label for="product-vendor" class="block text-sm font-medium text-slate-700 mb-1">Vendor</label><select id="product-vendor" class="w-full px-3 py-2 border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" required><option value="">Select Vendor</option></select></div>
                                    <div><label for="product-cost" class="block text-sm font-medium text-slate-700 mb-1">Cost</label><input type="number" id="product-cost" step="0.01" class="w-full px-3 py-2 border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" required></div>
                                    <div><label for="product-price" class="block text-sm font-medium text-slate-700 mb-1">Sale Price</label><input type="number" id="product-price" step="0.01" class="w-full px-3 py-2 border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" required></div>
                                    <div class="md:col-span-2 lg:col-span-3"><label for="product-note" class="block text-sm font-medium text-slate-700 mb-1">Note</label><textarea id="product-note" rows="3" class="w-full px-3 py-2 border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"></textarea></div>
                                </div>
                                <div id="product-form-buttons" class="mt-6 text-right">
                                    <button type="submit" class="bg-blue-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-700 transition"><i class="fas fa-plus-circle mr-2"></i>Add Product</button>
                                </div>
                            </form>
                        </div>
                        <div>
                             <h4 class="text-xl font-semibold mb-4 text-slate-700">Existing Products</h4>
                             <div id="products-list-container" class="overflow-x-auto"><p class="p-4 text-slate-500 text-center">Loading products...</p></div>
                        </div>
                    </div>`,
                'vendor-list': `
                    <div>
                         <div class="flex justify-between items-center mb-6">
                            <h3 class="text-2xl font-semibold text-slate-800">Vendor List</h3>
                            <div>
                                <button id="import-vendor-btn" class="bg-teal-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-teal-600 transition"><i class="fas fa-file-import mr-2"></i>Import</button>
                                <input type="file" id="vendor-csv-input" class="hidden" accept=".csv">
                            </div>
                        </div>
                        <div class="mb-8">
                            <h4 id="vendor-form-title" class="text-xl font-semibold mb-4 text-slate-700">Add New Vendor</h4>
                            <form id="add-vendor-form" class="p-6 bg-slate-50 rounded-lg border border-slate-200">
                                <input type="hidden" id="vendor-id">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <div><label for="vendor-name" class="block text-sm font-medium text-slate-700 mb-1">Vendor Name</label><input type="text" id="vendor-name" class="w-full px-3 py-2 border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" placeholder="Enter vendor name" required></div>
                                    <div><label for="vendor-contact" class="block text-sm font-medium text-slate-700 mb-1">Contact</label><input type="text" id="vendor-contact" class="w-full px-3 py-2 border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" placeholder="Enter contact info" required></div>
                                </div>
                                <div id="vendor-form-buttons" class="mt-6 text-right">
                                    <button type="submit" class="bg-blue-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-700 transition"><i class="fas fa-plus-circle mr-2"></i>Add Vendor</button>
                                </div>
                            </form>
                        </div>
                        <div>
                             <h4 class="text-xl font-semibold mb-4 text-slate-700">Existing Vendors</h4>
                             <div id="vendors-list-container" class="overflow-x-auto"><p class="p-4 text-slate-500 text-center">Loading vendors...</p></div>
                        </div>
                    </div>`
            };

            const settingsTabs = {
                'shop-list': `
                    <div>
                        <h3 class="text-2xl font-semibold mb-6 text-slate-800">Shop List</h3>
                        <div class="mb-8">
                            <h4 id="shop-form-title" class="text-xl font-semibold mb-4 text-slate-700">Add New Shop</h4>
                            <form id="add-shop-form" class="p-6 bg-slate-50 rounded-lg border border-slate-200">
                                <input type="hidden" id="shop-id">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <div><label for="shop-name" class="block text-sm font-medium text-slate-700 mb-1">Shop Name</label><input type="text" id="shop-name" class="w-full px-3 py-2 border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" placeholder="Enter shop name" required></div>
                                    <div><label for="shop-contact" class="block text-sm font-medium text-slate-700 mb-1">Contact</label><input type="text" id="shop-contact" class="w-full px-3 py-2 border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" placeholder="Enter contact number or email" required></div>
                                    <div class="md:col-span-2"><label for="shop-address" class="block text-sm font-medium text-slate-700 mb-1">Address</label><textarea id="shop-address" rows="3" class="w-full px-3 py-2 border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" placeholder="Enter shop address" required></textarea></div>
                                </div>
                                <div id="shop-form-buttons" class="mt-6 text-right">
                                    <button type="submit" class="bg-blue-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-700 transition"><i class="fas fa-plus-circle mr-2"></i>Add Shop</button>
                                </div>
                            </form>
                        </div>
                        <div>
                             <h4 class="text-xl font-semibold mb-4 text-slate-700">Existing Shops</h4>
                             <div id="shops-list-container" class="overflow-x-auto"><p class="p-4 text-slate-500 text-center">Loading shops...</p></div>
                        </div>
                    </div>`,
                'user-profile': `
                    <div>
                        <h3 class="text-2xl font-semibold mb-6 text-slate-800">User Profile Management</h3>
                        <div class="mb-8">
                            <h4 id="user-form-title" class="text-xl font-semibold mb-4 text-slate-700">Add New User</h4>
                            <form id="add-user-form" class="p-6 bg-slate-50 rounded-lg border border-slate-200">
                                <input type="hidden" id="user-doc-id">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <div><label for="user-name" class="block text-sm font-medium text-slate-700 mb-1">Name</label><input type="text" id="user-name" class="w-full px-3 py-2 border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" required></div>
                                    <div><label for="user-email" class="block text-sm font-medium text-slate-700 mb-1">Email</label><input type="email" id="user-email" class="w-full px-3 py-2 border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" required></div>
                                    <div><label for="user-role" class="block text-sm font-medium text-slate-700 mb-1">Role</label><select id="user-role" class="w-full px-3 py-2 border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"><option>Admin</option><option>Shop Manager</option><option>Staff</option></select></div>
                                    <div><label for="user-uid" class="block text-sm font-medium text-slate-700 mb-1">Linked Auth UID</label><input type="text" id="user-uid" class="w-full px-3 py-2 border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" placeholder="Enter Firebase Auth UID"></div>
                                    <div class="md:col-span-2"><label class="block text-sm font-medium text-slate-700 mb-2">Assigned Shops</label><div id="user-form-shops" class="space-y-2 p-4 border border-slate-200 rounded-md max-h-32 overflow-y-auto bg-white">Loading shops...</div></div>
                                    <div class="md:col-span-2"><label class="block text-sm font-medium text-slate-700 mb-2">Page Permissions</label><div id="user-form-permissions" class="space-y-2 p-4 border border-slate-200 rounded-md bg-white"><label class="flex items-center"><input type="checkbox" name="permissions" value="po-request" class="h-4 w-4 text-blue-600 border-slate-300 rounded focus:ring-blue-500 mr-2">PO Request</label><label class="flex items-center"><input type="checkbox" name="permissions" value="po-center" class="h-4 w-4 text-blue-600 border-slate-300 rounded focus:ring-blue-500 mr-2">PO Center</label><label class="flex items-center"><input type="checkbox" name="permissions" value="product-data" class="h-4 w-4 text-blue-600 border-slate-300 rounded focus:ring-blue-500 mr-2">Product Data</label><label class="flex items-center"><input type="checkbox" name="permissions" value="settings" class="h-4 w-4 text-blue-600 border-slate-300 rounded focus:ring-blue-500 mr-2">Settings</label></div></div>
                                </div>
                                <div id="user-form-buttons" class="mt-6 text-right">
                                    <button type="submit" class="bg-blue-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-700 transition"><i class="fas fa-plus-circle mr-2"></i>Add User</button>
                                </div>
                            </form>
                        </div>
                        <div class="overflow-x-auto">
                             <h4 class="text-xl font-semibold mb-4 text-slate-700">Existing Users</h4>
                             <div id="users-list-container"><p class="p-4 text-slate-500 text-center">Loading users...</p></div>
                        </div>
                    </div>`
            };

            // --- Functions ---
            function loadPage(pageKey, data = null) {
                if (!currentUserProfile.permissions.includes(pageKey)) {
                    showModalMessage('Access Denied', 'You do not have permission to view this page.', true);
                    return;
                }

                const page = pages[pageKey];
                if (!page) return;
                pageTitle.textContent = page.title;
                pageContent.innerHTML = page.content;

                if (pageKey === 'po-request') setupPoRequestPage(data);
                else if (pageKey === 'po-center') {
                    setupPoCenterTabs();
                    loadPoCenterTab('drafts-po');
                } else if (pageKey === 'product-data') {
                    setupProductDataTabs();
                    loadProductDataTab('product-list');
                } else if (pageKey === 'settings') {
                    setupSettingsPage();
                }
            }
            
            function loadPoCenterTab(tabKey) {
                const tabContentContainer = document.getElementById('po-center-tab-content');
                if (!tabContentContainer) return;

                tabContentContainer.innerHTML = poCenterTabs[tabKey];
                
                if (tabKey === 'drafts-po') renderDraftsPO();
                else if (tabKey === 'active-po') renderActivePO();
                else if (tabKey === 'audited-po') renderAuditedPO();
            }

            async function renderPOsByStatus(status, containerId, filters = {}) {
                const container = document.getElementById(containerId);
                if (!container) return;
                
                let queryConstraints = [where("status", "==", status)];
                if (filters.shopId) queryConstraints.push(where("shopId", "==", filters.shopId));
                if (filters.startDate) queryConstraints.push(where("requestDate", ">=", filters.startDate));
                if (filters.endDate) queryConstraints.push(where("requestDate", "<=", filters.endDate));

                const q = query(collection(db, "purchaseOrders"), ...queryConstraints);
                
                try {
                    const snapshot = await getDocs(q);
                    const tableContainer = container.querySelector('#po-list-table'); // <-- BUG FIX: Scoped query
                    if (!tableContainer) return;

                    if (snapshot.empty) {
                        tableContainer.innerHTML = `<div class="text-center py-12"><i class="fas fa-folder-open text-4xl text-slate-400"></i><p class="mt-4 text-slate-500">No ${status} POs found for the selected filters.</p></div>`;
                        return;
                    }

                    const khrFormatter = new Intl.NumberFormat('en-US', { style: 'currency', currency: 'KHR' });
                    let tableHtml = `<div class="overflow-x-auto"><table class="min-w-full divide-y divide-slate-200"><thead class="bg-slate-50"><tr>
                        <th class="px-4 py-3 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">PO Number</th>
                        <th class="px-4 py-3 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">Req Date</th>
                        <th class="px-4 py-3 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">Shop</th>
                        <th class="px-4 py-3 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">Vendor</th>
                        <th class="px-4 py-3 text-right text-xs font-semibold text-slate-500 uppercase tracking-wider">Total Amount</th>
                        <th class="px-4 py-3 text-center text-xs font-semibold text-slate-500 uppercase tracking-wider">Status</th>
                        <th class="px-4 py-3 text-center text-xs font-semibold text-slate-500 uppercase tracking-wider">Actions</th>
                    </tr></thead><tbody class="bg-white divide-y divide-slate-200">`;

                    snapshot.forEach(doc => {
                        const po = doc.data();
                        const reqDate = po.requestDate.toDate().toLocaleDateString();
                        const statusStyles = {
                            draft: 'bg-yellow-100 text-yellow-800',
                            submitted: 'bg-blue-100 text-blue-800',
                            audited: 'bg-green-100 text-green-800'
                        };
                        const statusClass = statusStyles[po.status] || 'bg-slate-100 text-slate-800';
                        
                        let actionsHtml = '';
                        if (po.status === 'draft') {
                            actionsHtml = `<td class="px-4 py-3 whitespace-nowrap text-center text-sm font-medium space-x-4">
                                <button data-id="${doc.id}" class="edit-draft-po text-blue-600 hover:text-blue-900" title="Edit"><i class="fas fa-edit"></i></button>
                                <button data-id="${doc.id}" class="delete-draft-po text-red-600 hover:text-red-900" title="Delete"><i class="fas fa-trash"></i></button>
                            </td>`;
                        } else if (po.status === 'submitted') {
                             actionsHtml = `<td class="px-4 py-3 whitespace-nowrap text-center text-sm font-medium">
                                <button data-id="${doc.id}" class="audit-po bg-indigo-600 text-white px-3 py-1 rounded-md hover:bg-indigo-700 text-xs font-bold">Audit</button>
                            </td>`;
                        } else if (po.status === 'audited') {
                            actionsHtml = `<td class="px-4 py-3 whitespace-nowrap text-center text-sm font-medium">
                               <button data-id="${doc.id}" class="view-audited-po text-green-600 hover:text-green-900" title="View Details"><i class="fas fa-eye"></i></button>
                           </td>`;
                        }

                        tableHtml += `<tr class="hover:bg-slate-50 transition">
                            <td class="px-4 py-3 whitespace-nowrap text-sm font-medium text-slate-900">${po.poNumber}</td>
                            <td class="px-4 py-3 whitespace-nowrap text-sm text-slate-500">${reqDate}</td>
                            <td class="px-4 py-3 whitespace-nowrap text-sm text-slate-500">${po.shopName}</td>
                            <td class="px-4 py-3 whitespace-nowrap text-sm text-slate-500">${po.vendorName}</td>
                            <td class="px-4 py-3 whitespace-nowrap text-sm text-slate-500 text-right">${khrFormatter.format(po.totalAmount)}</td>
                            <td class="px-4 py-3 whitespace-nowrap text-center text-sm text-slate-500"><span class="px-3 py-1 inline-flex text-xs leading-5 font-semibold rounded-full ${statusClass}">${po.status}</span></td>
                            ${actionsHtml}
                        </tr>`;
                    });

                    tableHtml += `</tbody></table></div>`;
                    tableContainer.innerHTML = tableHtml;
                } catch (error) {
                    console.error("Error fetching POs:", error);
                    document.getElementById('po-list-table').innerHTML = `<p class="p-4 text-red-500 text-center">Error loading POs.</p>`;
                }
            }

            async function handlePoCenterActions(e) {
                const button = e.target.closest('button');
                if (!button) return;
                
                const poId = button.dataset.id;
                if (!poId) return;

                if (button.classList.contains('delete-draft-po')) {
                    showConfirmation('Delete Draft', 'Are you sure you want to permanently delete this draft?', async () => {
                         try {
                            await deleteDoc(doc(db, "purchaseOrders", poId));
                            showModalMessage('Success', 'Draft deleted successfully.');
                        } catch (error) {
                            console.error("Error deleting draft:", error);
                            showModalMessage('Error', 'Failed to delete draft.', true);
                        }
                    });
                } else if (button.classList.contains('edit-draft-po')) {
                    try {
                        const poDoc = await getDoc(doc(db, "purchaseOrders", poId));
                        if (poDoc.exists()) {
                            loadPage('po-request', { id: poDoc.id, ...poDoc.data() });
                        } else {
                            showModalMessage('Error', 'Could not find the selected draft.', true);
                        }
                    } catch (error) {
                        console.error("Error fetching draft for editing:", error);
                        showModalMessage('Error', 'Failed to fetch draft for editing.', true);
                    }
                } else if (button.classList.contains('audit-po')) {
                    try {
                        const poDoc = await getDoc(doc(db, "purchaseOrders", poId));
                        if (poDoc.exists()) {
                            openAuditModal({ id: poDoc.id, ...poDoc.data() });
                        } else {
                            showModalMessage('Error', 'Could not find the selected PO.', true);
                        }
                    } catch (error) {
                        console.error("Error fetching PO for audit:", error);
                        showModalMessage('Error', 'Failed to fetch PO for audit.', true);
                    }
                } else if (button.classList.contains('view-audited-po')) {
                    try {
                        const poDoc = await getDoc(doc(db, "purchaseOrders", poId));
                        if (poDoc.exists()) {
                            openViewPoModal({ id: poDoc.id, ...poDoc.data() });
                        } else {
                            showModalMessage('Error', 'Could not find the selected PO.', true);
                        }
                    } catch (error) {
                        console.error("Error fetching PO for viewing:", error);
                        showModalMessage('Error', 'Failed to fetch PO for viewing.', true);
                    }
                }
            }
            
            function closeAuditModal() {
                const modalBackdrop = document.getElementById('audit-modal-backdrop');
                modalBackdrop.classList.add('hidden');
                modalBackdrop.classList.remove('flex');
                modalBackdrop.querySelector('#audit-modal').innerHTML = '';
            }

            async function openViewPoModal(poData) {
                const modalBackdrop = document.getElementById('audit-modal-backdrop');
                const modal = document.getElementById('audit-modal');
                const numberFormatter = (num, decimals = 2) => isNaN(parseFloat(num)) ? '0.00' : parseFloat(num).toFixed(decimals);
                const currencyFormatter = (num) => new Intl.NumberFormat('en-US').format(numberFormatter(num));

                let modalHtml = `
                    <div class="p-5 border-b border-slate-200 flex justify-between items-center">
                        <h3 class="text-xl font-semibold text-slate-800">View Audited PO: ${poData.poNumber}</h3>
                        <button id="close-view-modal-btn" class="text-slate-400 hover:text-slate-800 text-2xl">&times;</button>
                    </div>
                    <div class="p-6 flex-grow overflow-y-auto">
                        <div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-4 gap-4 mb-6 text-sm bg-slate-50 p-4 rounded-lg">
                            <div><strong>Shop:</strong> <span class="text-slate-600">${poData.shopName}</span></div>
                            <div><strong>Vendor:</strong> <span class="text-slate-600">${poData.vendorName}</span></div>
                            <div><strong>Request Date:</strong> <span class="text-slate-600">${poData.requestDate.toDate().toLocaleDateString()}</span></div>
                            <div><strong>Exchange Rate:</strong> <span class="text-slate-600">${poData.exchangeRate || 'N/A'}</span></div>
                            <div class="lg:col-span-2"><strong>Audited By:</strong> <span class="text-slate-600">${poData.auditedByName || 'N/A'}</span></div>
                            <div class="lg:col-span-2"><strong>Audited At:</strong> <span class="text-slate-600">${poData.auditedAt ? poData.auditedAt.toDate().toLocaleString() : 'N/A'}</span></div>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-slate-200 text-sm">
                                <thead class="bg-slate-100">
                                    <tr>
                                        <th class="px-3 py-2 text-left font-semibold text-slate-600 uppercase">Product</th>
                                        <th class="px-3 py-2 text-center font-semibold text-slate-600 uppercase">Ordered</th>
                                        <th class="px-3 py-2 text-center font-semibold text-slate-600 uppercase">Received</th>
                                        <th class="px-3 py-2 text-right font-semibold text-slate-600 uppercase">Cost (KHR)</th>
                                        <th class="px-3 py-2 text-right font-semibold text-slate-600 uppercase">Cost (USD)</th>
                                        <th class="px-3 py-2 text-right font-semibold text-slate-600 uppercase">Cost/Unit</th>
                                        <th class="px-3 py-2 text-right font-semibold text-slate-600 uppercase">CB4</th>
                                        <th class="px-3 py-2 text-right font-semibold text-slate-600 uppercase">Checked-Cost</th>
                                        <th class="px-3 py-2 text-left font-semibold text-slate-600 uppercase">Note</th>
                                    </tr>
                                </thead>
                                <tbody class="bg-white divide-y divide-slate-200">
                                    ${poData.items.map((item) => {
                                        let checkedCostColor = 'text-slate-900';
                                        if (item.costPerUnit > item.cb4) checkedCostColor = 'text-red-600';
                                        else if (item.costPerUnit < item.cb4) checkedCostColor = 'text-blue-600';
                                        return `<tr>
                                            <td class="px-3 py-2 whitespace-nowrap">${item.name}</td>
                                            <td class="px-3 py-2 text-center">${item.quantity}</td>
                                            <td class="px-3 py-2 text-center">${item.receivedQuantity || 0}</td>
                                            <td class="px-3 py-2 text-right">${currencyFormatter(item.costKhr || 0)}</td>
                                            <td class="px-3 py-2 text-right">$${numberFormatter(item.costUsd || 0)}</td>
                                            <td class="px-3 py-2 text-right">${currencyFormatter(item.costPerUnit || 0)}</td>
                                            <td class="px-3 py-2 text-right">${currencyFormatter(item.cb4 || 0)}</td>
                                            <td class="px-3 py-2 text-right font-bold ${checkedCostColor}">${currencyFormatter(item.checkedCost || 0)}</td>
                                            <td class="px-3 py-2 whitespace-nowrap">${item.auditNote || ''}</td>
                                        </tr>`;
                                    }).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div class="p-4 bg-slate-50 border-t border-slate-200 flex justify-end gap-4 rounded-b-lg">
                        <button id="close-view-modal-btn-2" type="button" class="bg-slate-200 text-slate-800 font-bold py-2 px-6 rounded-lg hover:bg-slate-300 transition">Close</button>
                    </div>
                `;
                modal.innerHTML = modalHtml;
                modalBackdrop.classList.remove('hidden');
                modalBackdrop.classList.add('flex');

                document.getElementById('close-view-modal-btn').addEventListener('click', closeAuditModal);
                document.getElementById('close-view-modal-btn-2').addEventListener('click', closeAuditModal);
            }

            function openAuditModal(poData) {
                const modalBackdrop = document.getElementById('audit-modal-backdrop');
                const modal = document.getElementById('audit-modal');
                const numberFormatter = (num) => isNaN(num) ? '0.00' : num.toFixed(2);

                let modalHtml = `
                    <div class="p-5 border-b border-slate-200 flex justify-between items-center">
                        <h3 class="text-xl font-semibold text-slate-800">Audit PO: ${poData.poNumber}</h3>
                        <button id="close-audit-modal-btn" class="text-slate-400 hover:text-slate-800 text-2xl">&times;</button>
                    </div>
                    <div class="p-6 flex-grow overflow-y-auto">
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6 text-sm bg-slate-50 p-4 rounded-lg">
                            <div><strong>Shop:</strong> <span class="text-slate-600">${poData.shopName}</span></div>
                            <div><strong>Vendor:</strong> <span class="text-slate-600">${poData.vendorName}</span></div>
                            <div>
                                <label for="audit-audited-by" class="block font-medium text-slate-700">Audited By</label>
                                <input type="text" id="audit-audited-by" class="w-full mt-1 px-3 py-2 border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                            </div>
                            <div>
                                <label for="audit-exchange-rate" class="block font-medium text-slate-700">Exchange Rate</label>
                                <input type="number" id="audit-exchange-rate" class="audit-input mt-1" value="4100">
                            </div>
                        </div>
                        <form id="audit-form" class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-slate-200 text-sm">
                                <thead class="bg-slate-100">
                                    <tr>
                                        <th class="px-2 py-2 text-left font-semibold text-slate-600 uppercase">Product</th>
                                        <th class="px-2 py-2 text-center font-semibold text-slate-600 uppercase" style="width: 8%;">Ordered</th>
                                        <th class="px-2 py-2 text-center font-semibold text-slate-600 uppercase" style="width: 8%;">Received</th>
                                        <th class="px-2 py-2 text-right font-semibold text-slate-600 uppercase" style="width: 10%;">Cost (KHR)</th>
                                        <th class="px-2 py-2 text-right font-semibold text-slate-600 uppercase" style="width: 10%;">Cost (USD)</th>
                                        <th class="px-2 py-2 text-right font-semibold text-slate-600 uppercase" style="width: 10%;">Cost/Unit</th>
                                        <th class="px-2 py-2 text-right font-semibold text-slate-600 uppercase" style="width: 10%;">CB4</th>
                                        <th class="px-2 py-2 text-right font-semibold text-slate-600 uppercase" style="width: 10%;">Checked-Cost</th>
                                        <th class="px-2 py-2 text-left font-semibold text-slate-600 uppercase" style="width: 14%;">Note</th>
                                    </tr>
                                </thead>
                                <tbody class="bg-white divide-y divide-slate-200">
                                    ${poData.items.map((item, index) => `
                                        <tr data-index="${index}" data-product-id="${item.productId}" data-cb4="${item.cb4}">
                                            <td class="px-2 py-1 whitespace-nowrap">${item.name}</td>
                                            <td class="px-2 py-1 text-center">${item.quantity}</td>
                                            <td class="px-2 py-1"><input type="number" class="audit-input audit-received-qty" value="${item.quantity}" min="0"></td>
                                            <td class="px-2 py-1"><input type="number" class="audit-input audit-cost-khr" placeholder="0.00"></td>
                                            <td class="px-2 py-1"><input type="number" class="audit-input audit-cost-usd" placeholder="0.00"></td>
                                            <td class="px-2 py-1 calculated-field cost-per-unit">0.00</td>
                                            <td class="px-2 py-1 calculated-field">${numberFormatter(item.cb4)}</td>
                                            <td class="px-2 py-1 calculated-field checked-cost font-bold">0.00</td>
                                            <td class="px-2 py-1"><input type="text" class="audit-input audit-item-note" placeholder="Optional note"></td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </form>
                    </div>
                    <div class="p-4 bg-slate-50 border-t border-slate-200 flex justify-end gap-4 rounded-b-lg">
                        <button id="cancel-audit-btn" type="button" class="bg-slate-200 text-slate-800 font-bold py-2 px-6 rounded-lg hover:bg-slate-300 transition">Cancel</button>
                        <button id="confirm-audit-btn" type="button" class="bg-green-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-green-700 transition">Confirm & Save Audit</button>
                    </div>
                `;
                modal.innerHTML = modalHtml;
                modalBackdrop.classList.remove('hidden');
                modalBackdrop.classList.add('flex');

                document.getElementById('audit-audited-by').value = currentUserProfile.name;
                const auditForm = document.getElementById('audit-form');
                
                function updateAuditRow(rowElement) {
                    const exchangeRate = parseFloat(document.getElementById('audit-exchange-rate').value) || 0;
                    const receivedQty = parseFloat(rowElement.querySelector('.audit-received-qty').value) || 0;
                    const costKhr = parseFloat(rowElement.querySelector('.audit-cost-khr').value) || 0;
                    const costUsd = parseFloat(rowElement.querySelector('.audit-cost-usd').value) || 0;
                    const cb4 = parseFloat(rowElement.dataset.cb4) || 0;

                    let costPerUnit = 0;
                    if (receivedQty > 0) {
                        if (costKhr > 0) costPerUnit = costKhr / receivedQty;
                        else if (costUsd > 0 && exchangeRate > 0) costPerUnit = (costUsd * exchangeRate) / receivedQty;
                    }
                    
                    const checkedCost = costPerUnit - cb4;
                    const checkedCostEl = rowElement.querySelector('.checked-cost');
                    
                    rowElement.querySelector('.cost-per-unit').textContent = numberFormatter(costPerUnit);
                    checkedCostEl.textContent = numberFormatter(checkedCost);

                    checkedCostEl.classList.remove('text-red-600', 'text-blue-600', 'text-slate-900');
                    if (costPerUnit > cb4) checkedCostEl.classList.add('text-red-600');
                    else if (costPerUnit < cb4) checkedCostEl.classList.add('text-blue-600');
                    else checkedCostEl.classList.add('text-slate-900');
                }
                
                auditForm.addEventListener('input', (e) => {
                    if (e.target.classList.contains('audit-input')) {
                        const row = e.target.closest('tr');
                        if (row) updateAuditRow(row);
                    }
                });
                
                document.getElementById('audit-exchange-rate').addEventListener('input', () => {
                    auditForm.querySelectorAll('tbody tr').forEach(row => updateAuditRow(row));
                });

                document.getElementById('close-audit-modal-btn').addEventListener('click', closeAuditModal);
                document.getElementById('cancel-audit-btn').addEventListener('click', closeAuditModal);
                document.getElementById('confirm-audit-btn').addEventListener('click', async () => {
                    const auditedByName = document.getElementById('audit-audited-by').value.trim();
                    if (!auditedByName) {
                        showModalMessage('Validation Error', "Please enter the auditor's name.", true);
                        return;
                    }

                    const auditedItems = [];
                    const itemRows = modal.querySelectorAll('tbody tr');
                    const exchangeRate = parseFloat(document.getElementById('audit-exchange-rate').value) || 0;

                    itemRows.forEach(row => {
                        const index = parseInt(row.dataset.index);
                        const originalItem = poData.items[index];
                        auditedItems.push({
                            ...originalItem,
                            productId: row.dataset.productId,
                            receivedQuantity: parseFloat(row.querySelector('.audit-received-qty').value) || 0,
                            costKhr: parseFloat(row.querySelector('.audit-cost-khr').value) || 0,
                            costUsd: parseFloat(row.querySelector('.audit-cost-usd').value) || 0,
                            costPerUnit: parseFloat(row.querySelector('.cost-per-unit').textContent.replace(/,/g, '')) || 0,
                            checkedCost: parseFloat(row.querySelector('.checked-cost').textContent.replace(/,/g, '')) || 0,
                            auditNote: row.querySelector('.audit-item-note').value
                        });
                    });

                    const auditData = {
                        status: 'audited',
                        auditedAt: serverTimestamp(),
                        auditedBy: currentUserId,
                        auditedByName: auditedByName,
                        exchangeRate: exchangeRate,
                        items: auditedItems
                    };

                    try {
                        const batch = writeBatch(db);
                        const poRef = doc(db, "purchaseOrders", poData.id);
                        batch.update(poRef, auditData);

                        auditedItems.forEach(item => {
                            if (item.productId && item.costPerUnit > 0) {
                                const productRef = doc(db, "products", item.productId);
                                batch.update(productRef, { cost: item.costPerUnit });

                                const historyRef = doc(collection(db, "products", item.productId, "costHistory"));
                                batch.set(historyRef, {
                                    updatedAt: serverTimestamp(),
                                    newCost: item.costPerUnit,
                                    poNumber: poData.poNumber,
                                    auditedByName: auditedByName
                                });
                            }
                        });
                        await batch.commit();
                        showModalMessage('Success', 'PO audited and product costs updated successfully.');
                        closeAuditModal();
                    } catch (error) {
                        console.error("Error confirming audit or updating products:", error);
                        showModalMessage('Error', 'Failed to save audit or update product costs.', true);
                    }
                });
            }

            function renderDraftsPO() {
                const container = document.getElementById('drafts-po-container');
                setupPoListWithFilters(container, 'draft');
            }

            function renderActivePO() {
                const container = document.getElementById('active-po-container');
                setupPoListWithFilters(container, 'submitted');
            }

            function renderAuditedPO() {
                const container = document.getElementById('audited-po-container');
                setupPoListWithFilters(container, 'audited');
            }
            
            async function setupPoListWithFilters(container, status) {
                let shopsOptions = '<option value="">All Shops</option>';
                try {
                    const shopsSnapshot = await getDocs(collection(db, "shops"));
                    shopsSnapshot.forEach(doc => {
                        shopsOptions += `<option value="${doc.id}">${doc.data().name}</option>`;
                    });
                } catch (error) { console.error("Error fetching shops for filter:", error); }

                const statusTitleMap = {
                    draft: 'Draft',
                    submitted: 'Active',
                    audited: 'Audited'
                };
                const statusTitle = statusTitleMap[status] || (status.charAt(0).toUpperCase() + status.slice(1));

                container.innerHTML = `
                    <div>
                        <div class="mb-8">
                            <h4 class="text-xl font-semibold mb-4 text-slate-700">Filter Options</h4>
                            <div class="p-6 bg-slate-50 rounded-lg border border-slate-200">
                                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4 items-end">
                                    <div>
                                        <label for="filter-shop" class="block text-sm font-medium text-slate-700">Shop</label>
                                        <select id="filter-shop" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-slate-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md">${shopsOptions}</select>
                                    </div>
                                    <div>
                                        <label for="filter-date-range" class="block text-sm font-medium text-slate-700">Date Range</label>
                                        <select id="filter-date-range" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-slate-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md">
                                            <option value="all">All Time</option><option value="today">Today</option><option value="this-week">This Week</option><option value="this-month">This Month</option><option value="last-month">Last Month</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label for="filter-specific-date" class="block text-sm font-medium text-slate-700">Specific Day</label>
                                        <input type="date" id="filter-specific-date" class="mt-1 block w-full pl-3 pr-2 py-2 text-base border-slate-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md">
                                    </div>
                                    <div class="flex gap-2 lg:col-span-2">
                                        <button id="filter-apply-btn" class="w-full bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 transition"><i class="fas fa-filter mr-2"></i>Filter</button>
                                        <button id="filter-reset-btn" class="w-full bg-slate-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-slate-600 transition"><i class="fas fa-undo mr-2"></i>Reset</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div>
                            <h4 class="text-xl font-semibold mb-4 text-slate-700">${statusTitle} Purchase Orders</h4>
                            <div id="po-list-table"><p class="p-4 text-slate-500 text-center">Loading POs...</p></div>
                        </div>
                    </div>
                `;

                const applyBtn = container.querySelector('#filter-apply-btn');
                const resetBtn = container.querySelector('#filter-reset-btn');

                const applyFilters = () => {
                    const shopId = container.querySelector('#filter-shop').value;
                    const dateRange = container.querySelector('#filter-date-range').value;
                    const specificDate = container.querySelector('#filter-specific-date').value;
                    
                    let filters = { shopId: shopId || null };
                    let startDate, endDate;
                    const now = new Date();

                    if (specificDate) {
                        const date = new Date(specificDate);
                        startDate = new Date(date.getFullYear(), date.getMonth(), date.getDate(), 0, 0, 0);
                        endDate = new Date(date.getFullYear(), date.getMonth(), date.getDate(), 23, 59, 59);
                    } else {
                        switch (dateRange) {
                            case 'today':
                                startDate = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 0, 0, 0);
                                endDate = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 23, 59, 59);
                                break;
                            case 'this-week':
                                const firstDayOfWeek = new Date(now.setDate(now.getDate() - now.getDay()));
                                startDate = new Date(firstDayOfWeek.getFullYear(), firstDayOfWeek.getMonth(), firstDayOfWeek.getDate(), 0, 0, 0);
                                endDate = new Date(new Date(firstDayOfWeek).setDate(firstDayOfWeek.getDate() + 6));
                                endDate.setHours(23, 59, 59);
                                break;
                            case 'this-month':
                                startDate = new Date(now.getFullYear(), now.getMonth(), 1, 0, 0, 0);
                                endDate = new Date(now.getFullYear(), now.getMonth() + 1, 0, 23, 59, 59);
                                break;
                            case 'last-month':
                                startDate = new Date(now.getFullYear(), now.getMonth() - 1, 1, 0, 0, 0);
                                endDate = new Date(now.getFullYear(), now.getMonth(), 0, 23, 59, 59);
                                break;
                        }
                    }

                    if (startDate && endDate) {
                        filters.startDate = Timestamp.fromDate(startDate);
                        filters.endDate = Timestamp.fromDate(endDate);
                    }
                    
                    container.querySelector('#po-list-table').innerHTML = `<p class="p-4 text-slate-500 text-center">Loading filtered POs...</p>`;
                    renderPOsByStatus(status, container.id, filters);
                };

                applyBtn.addEventListener('click', applyFilters);
                resetBtn.addEventListener('click', () => {
                    container.querySelector('#filter-shop').value = '';
                    container.querySelector('#filter-date-range').value = 'all';
                    container.querySelector('#filter-specific-date').value = '';
                    applyFilters();
                });

                renderPOsByStatus(status, container.id);
                container.removeEventListener('click', handlePoCenterActions);
                container.addEventListener('click', handlePoCenterActions);
            }

            function loadProductDataTab(tabKey) {
                const tabContentContainer = document.getElementById('product-data-tab-content');
                if (!tabContentContainer) return;
                tabContentContainer.innerHTML = productDataTabs[tabKey];
                if (tabKey === 'product-list') setupProductList();
                else if (tabKey === 'vendor-list') setupVendorList();
            }

            function setupPoCenterTabs() {
                const tabsContainer = document.getElementById('po-center-tabs');
                if (!tabsContainer) return;
                tabsContainer.addEventListener('click', (e) => {
                    if (e.target.classList.contains('tab-link')) {
                        e.preventDefault();
                        const tabKey = e.target.dataset.tab;
                        tabsContainer.querySelectorAll('.tab-link').forEach(l => l.classList.remove('active-tab'));
                        e.target.classList.add('active-tab');
                        loadPoCenterTab(tabKey);
                    }
                });
            }
            
            function setupProductDataTabs() {
                const tabsContainer = document.getElementById('product-data-tabs');
                if (!tabsContainer) return;
                tabsContainer.addEventListener('click', (e) => {
                    if (e.target.classList.contains('tab-link')) {
                        e.preventDefault();
                        const tabKey = e.target.dataset.tab;
                        tabsContainer.querySelectorAll('.tab-link').forEach(l => l.classList.remove('active-tab'));
                        e.target.classList.add('active-tab');
                        loadProductDataTab(tabKey);
                    }
                });
            }

            function toggleSidebar() {
                sidebar.classList.toggle('-translate-x-full');
                overlay.classList.toggle('hidden');
            }

            async function generatePoPdf(poData) {
                const { jsPDF } = window.jspdf;
                const printableArea = document.getElementById('po-printable');
                const khrFormatter = new Intl.NumberFormat('en-US');

                let shopDetails = {}, vendorDetails = {};
                try {
                    const shopDoc = await getDoc(doc(db, "shops", poData.shopId));
                    if(shopDoc.exists()) shopDetails = shopDoc.data();
                    const vendorDoc = await getDoc(doc(db, "vendors", poData.vendorId));
                    if(vendorDoc.exists()) vendorDetails = vendorDoc.data();
                } catch(e) { console.error("Could not fetch shop/vendor details for printing:", e); }

                printableArea.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: flex-start; border-bottom: 2px solid #000; padding-bottom: 10px;">
                        <div style="width: 33%;"><h1 style="font-size: 24px; font-weight: bold;">PURCHASE ORDER</h1><p><strong>PO #:</strong> ${poData.poNumber}</p><p><strong>Date:</strong> ${poData.requestDate.toLocaleDateString()}</p></div>
                        <div style="width: 33%; text-align: center;"><h3 style="font-weight: bold; margin-bottom: 5px;">VENDOR:</h3><p>${poData.vendorName}</p><p>${vendorDetails.contact || ''}</p></div>
                        <div style="width: 33%; text-align: right;"><h2 style="font-size: 18px; font-weight: bold;">${poData.shopName}</h2><p>${shopDetails.address || ''}</p><p>${shopDetails.contact || ''}</p></div>
                    </div>
                    <table style="width: 100%; margin-top: 20px; border-collapse: collapse;">
                        <thead style="background-color: #eee;">
                            <tr>
                                <th style="border: 1px solid #ccc; padding: 8px; text-align: left;">No.</th><th style="border: 1px solid #ccc; padding: 8px; text-align: left;">Product Code</th><th style="border: 1px solid #ccc; padding: 8px; text-align: left;">Barcode</th><th style="border: 1px solid #ccc; padding: 8px; text-align: left;">Product Name</th><th style="border: 1px solid #ccc; padding: 8px; text-align: right;">QTY</th><th style="border: 1px solid #ccc; padding: 8px; text-align: right;">Cost (KHR)</th><th style="border: 1px solid #ccc; padding: 8px; text-align: right;">Cost (USD)</th><th style="border: 1px solid #ccc; padding: 8px; text-align: right;">Sub-Total</th><th style="border: 1px solid #ccc; padding: 8px; text-align: right;">CB4</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${poData.items.map((item, index) => `
                                <tr>
                                    <td style="border: 1px solid #ccc; padding: 8px;">${index + 1}</td><td style="border: 1px solid #ccc; padding: 8px;">${item.code}</td><td style="border: 1px solid #ccc; padding: 8px;">${item.barcode}</td><td style="border: 1px solid #ccc; padding: 8px;">${item.name}</td><td style="border: 1px solid #ccc; padding: 8px; text-align: right;">${item.quantity}</td><td style="border: 1px solid #ccc; padding: 8px; text-align: right;"></td><td style="border: 1px solid #ccc; padding: 8px; text-align: right;"></td><td style="border: 1px solid #ccc; padding: 8px; text-align: right;"></td><td style="border: 1px solid #ccc; padding: 8px; text-align: right;">${khrFormatter.format(item.cb4)}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                        <tfoot><tr><td colspan="8" style="border: 1px solid #ccc; padding: 8px; text-align: right; font-weight: bold;">TOTAL</td><td style="border: 1px solid #ccc; padding: 8px; text-align: right; font-weight: bold;"></td></tr></tfoot>
                    </table>
                    <div style="position: absolute; bottom: 40px; width: 1043px; display: flex; justify-content: space-between;">
                        <div><p style="border-top: 1px solid #000; padding-top: 5px;">Prepared By</p></div><div><p style="border-top: 1px solid #000; padding-top: 5px;">Approved By</p></div>
                    </div>
                `;

                try {
                    const canvas = await html2canvas(printableArea);
                    const imgData = canvas.toDataURL('image/png');
                    const pdf = new jsPDF({ orientation: 'landscape', unit: 'px', format: 'a4' });
                    pdf.addImage(imgData, 'PNG', 0, 0, pdf.internal.pageSize.getWidth(), pdf.internal.pageSize.getHeight());
                    pdf.save(`PO-${poData.poNumber}.pdf`);
                } catch (error) {
                    console.error('Error generating PDF:', error);
                    showModalMessage('PDF Error', 'Could not generate PO PDF.', true);
                }
            }

            function setupPoRequestPage(poDataToEdit = null) {
                const poRequestTitle = document.getElementById('po-request-title');
                const poIdInput = document.getElementById('po-id');
                const shopSelect = document.getElementById('po-shop-name');
                const vendorSelect = document.getElementById('po-vendor');
                const poNumberInput = document.getElementById('po-number');
                const reqDateInput = document.getElementById('po-req-date');
                const productSearchInput = document.getElementById('po-product-search');
                const searchResultsContainer = document.getElementById('product-search-results');
                const productNameInput = document.getElementById('po-product-name');
                const selectedProductIdInput = document.getElementById('po-selected-product-id');
                const selectedProductCodeInput = document.getElementById('po-selected-product-code');
                const selectedProductBarcodeInput = document.getElementById('po-selected-product-barcode');
                const selectedProductVendorNameInput = document.getElementById('po-selected-product-vendor-name');
                const selectedProductCostInput = document.getElementById('po-selected-product-cost');
                const quantityInput = document.getElementById('po-item-quantity');
                const addItemForm = document.getElementById('add-po-item-form');
                const poItemsContainer = document.getElementById('po-items-container');
                const cancelPoBtn = document.getElementById('cancel-po-req');
                const saveDraftBtn = document.getElementById('save-draft-po');
                const submitPoBtn = document.getElementById('submit-po');

                let poItems = [];

                onSnapshot(collection(db, "shops"), (snapshot) => {
                    let optionsHtml = '<option value="">Select Shop</option>';
                    snapshot.forEach(doc => optionsHtml += `<option value="${doc.id}" data-name="${doc.data().name}">${doc.data().name}</option>`);
                    shopSelect.innerHTML = optionsHtml;
                    if (poDataToEdit) shopSelect.value = poDataToEdit.shopId;
                });

                onSnapshot(collection(db, "vendors"), (snapshot) => {
                    let optionsHtml = '<option value="">Select Vendor</option>';
                    snapshot.forEach(doc => optionsHtml += `<option value="${doc.id}" data-name="${doc.data().name}">${doc.data().name}</option>`);
                    vendorSelect.innerHTML = optionsHtml;
                    if (poDataToEdit) vendorSelect.value = poDataToEdit.vendorId;
                });
                
                function generatePoNumber() {
                    if (poNumberInput.value) return;
                    if (shopSelect.value && vendorSelect.value) {
                        const shopName = shopSelect.options[shopSelect.selectedIndex].dataset.name.replace(/\s+/g, '');
                        const vendorName = vendorSelect.options[vendorSelect.selectedIndex].dataset.name.replace(/\s+/g, '');
                        const now = new Date();
                        poNumberInput.value = `${shopName}-${vendorName}-${now.toISOString().slice(0,10).replace(/-/g,"")}-${Date.now().toString().slice(-6)}`;
                    } else {
                        poNumberInput.value = '';
                    }
                }

                function setRequestDate() {
                    reqDateInput.value = new Date().toLocaleDateString('en-CA');
                }

                shopSelect.addEventListener('change', generatePoNumber);
                vendorSelect.addEventListener('change', generatePoNumber);
                if (!poDataToEdit) setRequestDate();

                productSearchInput.addEventListener('input', async (e) => {
                    const searchTerm = e.target.value.trim().toLowerCase();
                    if (searchTerm.length < 1) {
                        searchResultsContainer.classList.add('hidden');
                        return;
                    }

                    try {
                        const productsRef = collection(db, "products");
                        const querySnapshot = await getDocs(productsRef);
                        const results = [];
                        querySnapshot.forEach(doc => {
                            const p = doc.data();
                            if ((p.name && p.name.toLowerCase().includes(searchTerm)) || 
                                (p.code && p.code.toLowerCase().includes(searchTerm)) || 
                                (p.barcode && p.barcode.toLowerCase().includes(searchTerm))) {
                                results.push({ id: doc.id, ...p });
                            }
                        });

                        if (results.length > 0) {
                            searchResultsContainer.innerHTML = results.map(p => `
                                <div class="p-2 cursor-pointer hover:bg-slate-100" data-id="${p.id}" data-name="${p.name}" data-code="${p.code}" data-barcode="${p.barcode || ''}" data-vendor-name="${p.vendorName || ''}" data-cost="${p.cost}">
                                    <p class="font-semibold">${p.name}</p><p class="text-sm text-slate-500">Code: ${p.code} | Barcode: ${p.barcode || 'N/A'}</p>
                                </div>`).join('');
                            searchResultsContainer.classList.remove('hidden');
                        } else {
                            searchResultsContainer.innerHTML = '<div class="p-2 text-slate-500">No products found.</div>';
                            searchResultsContainer.classList.remove('hidden');
                        }
                    } catch (error) {
                        console.error("Error searching products:", error);
                        searchResultsContainer.innerHTML = '<div class="p-2 text-red-500">Error searching.</div>';
                    }
                });
                
                searchResultsContainer.addEventListener('click', (e) => {
                    const productDiv = e.target.closest('div[data-id]');
                    if (productDiv) {
                        productNameInput.value = productDiv.dataset.name;
                        selectedProductIdInput.value = productDiv.dataset.id;
                        selectedProductCodeInput.value = productDiv.dataset.code;
                        selectedProductBarcodeInput.value = productDiv.dataset.barcode;
                        selectedProductVendorNameInput.value = productDiv.dataset.vendorName;
                        selectedProductCostInput.value = productDiv.dataset.cost;
                        productSearchInput.value = '';
                        searchResultsContainer.classList.add('hidden');
                        quantityInput.focus();
                    }
                });

                addItemForm.addEventListener('submit', (e) => {
                    e.preventDefault();
                    const productId = selectedProductIdInput.value;
                    if (!productId) {
                        showModalMessage('Validation Error', "Please select a product first.", true);
                        return;
                    }

                    const existingItemIndex = poItems.findIndex(item => item.productId === productId);
                    const quantity = parseInt(quantityInput.value);

                    if (existingItemIndex > -1) {
                        poItems[existingItemIndex].quantity += quantity;
                    } else {
                        poItems.push({
                            productId: productId, code: selectedProductCodeInput.value, barcode: selectedProductBarcodeInput.value, name: productNameInput.value, vendorName: selectedProductVendorNameInput.value, cost: parseFloat(selectedProductCostInput.value), cb4: parseFloat(selectedProductCostInput.value), quantity: quantity
                        });
                    }
                    renderPoItems();
                    resetAddItemForm();
                });

                function resetAddItemForm() {
                    addItemForm.reset();
                    quantityInput.value = "1";
                    productNameInput.value = '';
                    selectedProductIdInput.value = '';
                    productSearchInput.focus();
                }

                function renderPoItems() {
                    if (poItems.length === 0) {
                        poItemsContainer.innerHTML = `<p class="p-4 text-slate-500 text-center">No products added yet.</p>`;
                        return;
                    }

                    let tableHtml = `<table class="min-w-full divide-y divide-slate-200"><thead class="bg-slate-50"><tr>
                        <th class="px-4 py-3 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">No.</th>
                        <th class="px-4 py-3 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">Product</th>
                        <th class="px-4 py-3 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">Vendor</th>
                        <th class="px-4 py-3 text-center text-xs font-semibold text-slate-500 uppercase tracking-wider">Qty</th>
                        <th class="px-4 py-3 text-center text-xs font-semibold text-slate-500 uppercase tracking-wider">Actions</th>
                    </tr></thead><tbody class="bg-white divide-y divide-slate-200">`;
                    
                    poItems.forEach((item, index) => {
                        tableHtml += `<tr class="hover:bg-slate-50">
                            <td class="px-4 py-3 whitespace-nowrap text-sm font-medium text-slate-900">${index + 1}</td>
                            <td class="px-4 py-3 whitespace-nowrap text-sm text-slate-500"><div>${item.name}</div><div class="text-xs text-slate-400">Code: ${item.code}</div></td>
                            <td class="px-4 py-3 whitespace-nowrap text-sm text-slate-500">${item.vendorName}</td>
                            <td class="px-4 py-3 whitespace-nowrap text-sm text-slate-500 text-center">${item.quantity}</td>
                            <td class="px-4 py-3 whitespace-nowrap text-sm font-medium text-center space-x-4">
                                <button data-index="${index}" class="edit-po-item text-blue-600 hover:text-blue-900" title="Edit"><i class="fas fa-edit"></i></button>
                                <button data-index="${index}" class="remove-po-item text-red-600 hover:text-red-900" title="Remove"><i class="fas fa-trash"></i></button>
                            </td>
                        </tr>`;
                    });

                    tableHtml += `</tbody></table>`;
                    poItemsContainer.innerHTML = tableHtml;
                }
                
                poItemsContainer.addEventListener('click', (e) => {
                    const button = e.target.closest('button');
                    if(!button) return;
                    const index = button.dataset.index;
                    if(button.classList.contains('remove-po-item')) {
                        poItems.splice(index, 1);
                        renderPoItems();
                    } else if (button.classList.contains('edit-po-item')) {
                        const itemToEdit = poItems[index];
                        selectedProductIdInput.value = itemToEdit.productId;
                        selectedProductCodeInput.value = itemToEdit.code;
                        selectedProductBarcodeInput.value = itemToEdit.barcode;
                        productNameInput.value = itemToEdit.name;
                        selectedProductVendorNameInput.value = itemToEdit.vendorName;
                        selectedProductCostInput.value = itemToEdit.cost;
                        quantityInput.value = itemToEdit.quantity;
                        poItems.splice(index, 1);
                        renderPoItems();
                        productSearchInput.focus();
                    }
                });

                async function savePO(status) {
                    if (!shopSelect.value || !vendorSelect.value || !poNumberInput.value) {
                        showModalMessage('Validation Error', "Please select a shop and vendor.", true);
                        return;
                    }
                    if (poItems.length === 0) {
                        showModalMessage('Validation Error', "Please add at least one product to the PO.", true);
                        return;
                    }

                    const totalAmount = poItems.reduce((sum, item) => sum + (item.cost * item.quantity), 0);
                    const poId = poIdInput.value;

                    const poData = {
                        poNumber: poNumberInput.value,
                        shopId: shopSelect.value,
                        shopName: shopSelect.options[shopSelect.selectedIndex].dataset.name,
                        vendorId: vendorSelect.value,
                        vendorName: vendorSelect.options[vendorSelect.selectedIndex].dataset.name,
                        requestDate: new Date(reqDateInput.value),
                        status: status,
                        items: poItems,
                        totalAmount: totalAmount,
                        createdBy: currentUserId,
                        updatedAt: serverTimestamp()
                    };

                    try {
                        if (status === 'submitted') await generatePoPdf(poData);

                        if (poId) {
                            await updateDoc(doc(db, "purchaseOrders", poId), poData);
                        } else {
                            poData.createdAt = serverTimestamp();
                            await addDoc(collection(db, "purchaseOrders"), poData);
                        }
                        showModalMessage('Success', `PO successfully ${status}!`);
                        loadPage('po-request');
                    } catch (error) {
                        console.error("Error saving PO: ", error);
                        showModalMessage('Error', "Failed to save PO. See console for details.", true);
                    }
                }

                if (poDataToEdit) {
                    poRequestTitle.textContent = 'Edit Purchase Order';
                    poIdInput.value = poDataToEdit.id;
                    poNumberInput.value = poDataToEdit.poNumber;
                    reqDateInput.value = poDataToEdit.requestDate.toDate().toLocaleDateString('en-CA');
                    poItems = poDataToEdit.items;
                    renderPoItems();
                }

                cancelPoBtn.addEventListener('click', () => loadPage('po-request'));
                saveDraftBtn.addEventListener('click', () => savePO('draft'));
                submitPoBtn.addEventListener('click', () => savePO('submitted'));
            }

            function setupProductList() {
                const importBtn = document.getElementById('import-product-btn');
                const templateBtn = document.getElementById('download-template-btn');
                const exportBtn = document.getElementById('export-product-btn');
                const fileInput = document.getElementById('product-csv-input');
                const addProductForm = document.getElementById('add-product-form');
                const productsListContainer = document.getElementById('products-list-container');
                const productFormTitle = document.getElementById('product-form-title');
                const productFormButtons = document.getElementById('product-form-buttons');
                const productIdInput = document.getElementById('product-id');
                const productVendorSelect = document.getElementById('product-vendor');

                importBtn.addEventListener('click', () => fileInput.click());
                templateBtn.addEventListener('click', downloadProductTemplate);
                exportBtn.addEventListener('click', exportProductsToCSV);
                fileInput.addEventListener('change', handleProductImport);

                function downloadProductTemplate() {
                    const headers = ["Product Code", "Barcode", "Product Name", "Vendor Name", "Cost", "Sale Price", "Note"];
                    const csvContent = "data:text/csv;charset=utf-8," + headers.join(",");
                    const link = document.createElement("a");
                    link.setAttribute("href", encodeURI(csvContent));
                    link.setAttribute("download", "product_template.csv");
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                }

                async function exportProductsToCSV() {
                    const productsQuery = await getDocs(collection(db, "products"));
                    let csvContent = "data:text/csv;charset=utf-8,";
                    const headers = ["Product Code", "Barcode", "Product Name", "Vendor Name", "Cost", "Sale Price", "Note"];
                    csvContent += headers.join(",") + "\r\n";

                    productsQuery.forEach(doc => {
                        const p = doc.data();
                        const row = [`"${p.code||''}"`,`"${p.barcode||''}"`,`"${p.name||''}"`,`"${p.vendorName||''}"`,p.cost||0,p.price||0,`"${p.note||''}"`];
                        csvContent += row.join(",") + "\r\n";
                    });

                    const link = document.createElement("a");
                    link.setAttribute("href", encodeURI(csvContent));
                    link.setAttribute("download", "products.csv");
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                }

                async function handleProductImport(event) {
                    const file = event.target.files[0];
                    if (!file) return;

                    const reader = new FileReader();
                    reader.onload = async (e) => {
                        const text = e.target.result;
                        const lines = text.split('\n').filter(line => line.trim() !== '');
                        const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
                        
                        const requiredHeaders = ["Product Code", "Product Name", "Vendor Name", "Cost", "Sale Price"];
                        if(requiredHeaders.some(h => !headers.includes(h))) {
                            showModalMessage('Import Error', `CSV is missing required headers: ${requiredHeaders.join(', ')}`, true);
                            return;
                        }

                        const batch = writeBatch(db);
                        const vendorsCache = {};
                        const vendorsQuery = await getDocs(collection(db, "vendors"));
                        vendorsQuery.forEach(doc => { vendorsCache[doc.data().name] = doc.id; });

                        for (let i = 1; i < lines.length; i++) {
                            const data = lines[i].split(',').map(d => d.trim().replace(/"/g, ''));
                            let rowData = {};
                            headers.forEach((h, index) => { rowData[h] = data[index]; });

                            const vendorId = vendorsCache[rowData["Vendor Name"]];
                            if (!vendorId) {
                                console.warn(`Vendor "${rowData["Vendor Name"]}" not found for product "${rowData["Product Name"]}". Skipping.`);
                                continue;
                            }

                            const productRef = doc(collection(db, "products"));
                            batch.set(productRef, {
                                code: rowData["Product Code"], barcode: rowData["Barcode"] || "", name: rowData["Product Name"], vendorId: vendorId, vendorName: rowData["Vendor Name"], cost: parseFloat(rowData["Cost"]) || 0, price: parseFloat(rowData["Sale Price"]) || 0, note: rowData["Note"] || ""
                            });
                        }

                        try {
                            await batch.commit();
                            showModalMessage('Success', 'Products imported successfully!');
                        } catch (error) {
                            console.error('Error importing products: ', error);
                            showModalMessage('Error', 'Error importing products.', true);
                        }
                    };
                    reader.readAsText(file);
                    fileInput.value = '';
                }

                onSnapshot(collection(db, "vendors"), (snapshot) => {
                    let optionsHtml = '<option value="">Select Vendor</option>';
                    snapshot.forEach(doc => optionsHtml += `<option value="${doc.id}" data-name="${doc.data().name}">${doc.data().name}</option>`);
                    productVendorSelect.innerHTML = optionsHtml;
                });

                const resetProductForm = () => {
                    addProductForm.reset();
                    productIdInput.value = '';
                    productFormTitle.textContent = 'Add New Product';
                    productFormButtons.innerHTML = `<button type="submit" class="bg-blue-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-700 transition"><i class="fas fa-plus-circle mr-2"></i>Add Product</button>`;
                };

                addProductForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const productId = productIdInput.value;
                    const selectedVendorOption = productVendorSelect.options[productVendorSelect.selectedIndex];
                    const productData = {
                        code: document.getElementById('product-code').value,
                        barcode: document.getElementById('product-barcode').value,
                        name: document.getElementById('product-name').value,
                        vendorId: selectedVendorOption.value,
                        vendorName: selectedVendorOption.dataset.name,
                        cost: parseFloat(document.getElementById('product-cost').value),
                        price: parseFloat(document.getElementById('product-price').value),
                        note: document.getElementById('product-note').value,
                    };

                    try {
                        if (productId) await updateDoc(doc(db, "products", productId), productData);
                        else await addDoc(collection(db, "products"), productData);
                        resetProductForm();
                    } catch (error) { console.error("Error saving product: ", error); }
                });

                productsListContainer.addEventListener('click', async (e) => {
                    const target = e.target.closest('button');
                    if (!target) return;
                    const productId = target.dataset.id;
                    if (!productId) return;

                    if (target.classList.contains('delete-product')) {
                        showConfirmation('Delete Product', 'Are you sure you want to delete this product?', async () => {
                            try {
                                await deleteDoc(doc(db, "products", productId));
                                resetProductForm();
                            } catch (error) { console.error("Error deleting product: ", error); }
                        });
                    } else if (target.classList.contains('edit-product')) {
                        try {
                            const productDoc = await getDoc(doc(db, "products", productId));
                            if (productDoc.exists()) {
                                const p = productDoc.data();
                                productIdInput.value = productDoc.id;
                                document.getElementById('product-code').value = p.code;
                                document.getElementById('product-barcode').value = p.barcode;
                                document.getElementById('product-name').value = p.name;
                                productVendorSelect.value = p.vendorId;
                                document.getElementById('product-cost').value = p.cost;
                                document.getElementById('product-price').value = p.price;
                                document.getElementById('product-note').value = p.note;

                                productFormTitle.textContent = 'Edit Product';
                                productFormButtons.innerHTML = `
                                    <button type="button" id="cancel-edit-product" class="bg-slate-200 text-slate-800 font-bold py-2 px-6 rounded-lg hover:bg-slate-300 mr-2">Cancel</button>
                                    <button type="submit" class="bg-green-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-green-700"><i class="fas fa-save mr-2"></i>Update Product</button>
                                `;
                                document.getElementById('cancel-edit-product').addEventListener('click', resetProductForm);
                                window.scrollTo(0, 0);
                            }
                        } catch (error) { console.error("Error fetching product for edit: ", error); }
                    } else if (target.classList.contains('view-cost-history')) {
                        openCostHistoryModal(productId, target.dataset.name);
                    }
                });

                onSnapshot(collection(db, "products"), (snapshot) => {
                    if (snapshot.empty) {
                        productsListContainer.innerHTML = `<p class="p-4 text-slate-500 text-center">No products have been added yet.</p>`;
                        return;
                    }
                    let tableHtml = `<table class="min-w-full divide-y divide-slate-200"><thead class="bg-slate-50"><tr>
                        <th class="px-4 py-3 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">Code</th><th class="px-4 py-3 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">Name</th><th class="px-4 py-3 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">Vendor</th><th class="px-4 py-3 text-right text-xs font-semibold text-slate-500 uppercase tracking-wider">Cost</th><th class="px-4 py-3 text-right text-xs font-semibold text-slate-500 uppercase tracking-wider">Price</th><th class="px-4 py-3 text-center text-xs font-semibold text-slate-500 uppercase tracking-wider">Actions</th>
                    </tr></thead><tbody class="bg-white divide-y divide-slate-200">`;
                    snapshot.forEach(doc => {
                        const p = doc.data();
                        tableHtml += `<tr class="hover:bg-slate-50">
                            <td class="px-4 py-3 whitespace-nowrap text-sm font-medium text-slate-900">${p.code}</td>
                            <td class="px-4 py-3 whitespace-nowrap text-sm text-slate-500">${p.name}</td>
                            <td class="px-4 py-3 whitespace-nowrap text-sm text-slate-500">${p.vendorName || ''}</td>
                            <td class="px-4 py-3 whitespace-nowrap text-sm text-slate-500 text-right">${p.cost}</td>
                            <td class="px-4 py-3 whitespace-nowrap text-sm text-slate-500 text-right">${p.price}</td>
                            <td class="px-4 py-3 whitespace-nowrap text-sm font-medium text-center space-x-2">
                                <button data-id="${doc.id}" data-name="${p.name}" class="view-cost-history text-green-600 hover:text-green-900" title="Cost History"><i class="fas fa-history"></i></button>
                                <button data-id="${doc.id}" class="edit-product text-blue-600 hover:text-blue-900" title="Edit"><i class="fas fa-edit"></i></button>
                                <button data-id="${doc.id}" class="delete-product text-red-600 hover:text-red-900" title="Delete"><i class="fas fa-trash"></i></button>
                            </td>
                        </tr>`;
                    });
                    tableHtml += `</tbody></table>`;
                    productsListContainer.innerHTML = tableHtml;
                });
            }
            
            async function openCostHistoryModal(productId, productName) {
                const modalBackdrop = document.getElementById('audit-modal-backdrop');
                const modal = document.getElementById('audit-modal');
                
                let modalHtml = `
                    <div class="p-5 border-b border-slate-200 flex justify-between items-center">
                        <h3 class="text-xl font-semibold text-slate-800">Cost History for: ${productName}</h3>
                        <button id="close-history-modal-btn" class="text-slate-400 hover:text-slate-800 text-2xl">&times;</button>
                    </div>
                    <div class="p-6 flex-grow overflow-y-auto"><div id="history-table-container"><p class="text-center text-slate-500">Loading history...</p></div></div>
                    <div class="p-4 bg-slate-50 border-t border-slate-200 flex justify-end rounded-b-lg">
                        <button id="close-history-modal-btn-2" type="button" class="bg-slate-200 text-slate-800 font-bold py-2 px-6 rounded-lg hover:bg-slate-300 transition">Close</button>
                    </div>
                `;
                modal.innerHTML = modalHtml;
                modalBackdrop.classList.remove('hidden');
                modalBackdrop.classList.add('flex');

                const closeModal = () => {
                    modalBackdrop.classList.add('hidden');
                    modalBackdrop.classList.remove('flex');
                    modal.innerHTML = '';
                };

                document.getElementById('close-history-modal-btn').addEventListener('click', closeModal);
                document.getElementById('close-history-modal-btn-2').addEventListener('click', closeModal);

                try {
                    const historyCollectionRef = collection(db, "products", productId, "costHistory");
                    const historySnapshot = await getDocs(historyCollectionRef);
                    const historyTableContainer = document.getElementById('history-table-container');

                    if (historySnapshot.empty) {
                        historyTableContainer.innerHTML = `<p class="text-center text-slate-500">No cost history found for this product.</p>`;
                        return;
                    }

                    let tableContent = `<table class="min-w-full divide-y divide-slate-200 text-sm"><thead class="bg-slate-100">
                        <tr><th class="px-4 py-2 text-left font-semibold text-slate-600 uppercase">Date</th><th class="px-4 py-2 text-left font-semibold text-slate-600 uppercase">PO Number</th><th class="px-4 py-2 text-right font-semibold text-slate-600 uppercase">New Cost</th><th class="px-4 py-2 text-left font-semibold text-slate-600 uppercase">Audited By</th></tr>
                        </thead><tbody class="bg-white divide-y divide-slate-200">`;
                    historySnapshot.docs.forEach(doc => {
                        const h = doc.data();
                        tableContent += `<tr><td class="px-4 py-2 whitespace-nowrap">${h.updatedAt.toDate().toLocaleString()}</td><td class="px-4 py-2 whitespace-nowrap">${h.poNumber}</td><td class="px-4 py-2 text-right">${h.newCost.toFixed(2)}</td><td class="px-4 py-2 whitespace-nowrap">${h.auditedByName}</td></tr>`;
                    });
                    tableContent += `</tbody></table>`;
                    historyTableContainer.innerHTML = tableContent;
                } catch (error) {
                    console.error("Error fetching cost history:", error);
                    document.getElementById('history-table-container').innerHTML = `<p class="text-center text-red-500">Could not load cost history.</p>`;
                }
            }

            function setupVendorList() {
                const importVendorBtn = document.getElementById('import-vendor-btn');
                const vendorCsvInput = document.getElementById('vendor-csv-input');
                const addVendorForm = document.getElementById('add-vendor-form');
                const vendorsListContainer = document.getElementById('vendors-list-container');
                const vendorFormTitle = document.getElementById('vendor-form-title');
                const vendorFormButtons = document.getElementById('vendor-form-buttons');
                const vendorIdInput = document.getElementById('vendor-id');

                importVendorBtn.addEventListener('click', () => vendorCsvInput.click());
                vendorCsvInput.addEventListener('change', handleVendorImport);

                async function handleVendorImport(event) {
                    const file = event.target.files[0];
                    if (!file) return;

                    const reader = new FileReader();
                    reader.onload = async (e) => {
                        const text = e.target.result;
                        const rows = text.split('\n').slice(1);
                        const batch = writeBatch(db);
                        rows.forEach(row => {
                            const cols = row.split(',');
                            if (cols.length >= 2) {
                                batch.set(doc(collection(db, "vendors")), { name: cols[0].trim(), contact: cols[1].trim() });
                            }
                        });
                        try {
                            await batch.commit();
                            showModalMessage('Success', 'Vendors imported successfully!');
                        } catch (error) {
                            console.error('Error importing vendors: ', error);
                            showModalMessage('Error', 'Error importing vendors.', true);
                        }
                    };
                    reader.readAsText(file);
                    vendorCsvInput.value = '';
                }

                const resetVendorForm = () => {
                    addVendorForm.reset();
                    vendorIdInput.value = '';
                    vendorFormTitle.textContent = 'Add New Vendor';
                    vendorFormButtons.innerHTML = `<button type="submit" class="bg-blue-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-700 transition"><i class="fas fa-plus-circle mr-2"></i>Add Vendor</button>`;
                }

                addVendorForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const vendorId = vendorIdInput.value;
                    const vendorData = { name: document.getElementById('vendor-name').value, contact: document.getElementById('vendor-contact').value };
                    try {
                        if (vendorId) await updateDoc(doc(db, "vendors", vendorId), vendorData);
                        else await addDoc(collection(db, "vendors"), vendorData);
                        resetVendorForm();
                    } catch (error) { console.error("Error saving vendor: ", error); }
                });

                vendorsListContainer.addEventListener('click', async (e) => {
                    const target = e.target.closest('button');
                    if (!target) return;
                    const vendorId = target.dataset.id;
                    if (!vendorId) return;

                    if (target.classList.contains('delete-vendor')) {
                        showConfirmation('Delete Vendor', 'Are you sure you want to delete this vendor?', async () => {
                            try {
                                await deleteDoc(doc(db, "vendors", vendorId));
                                resetVendorForm();
                            } catch (error) { console.error("Error deleting vendor: ", error); }
                        });
                    } else if (target.classList.contains('edit-vendor')) {
                        try {
                            const vendorDoc = await getDoc(doc(db, "vendors", vendorId));
                            if (vendorDoc.exists()) {
                                const v = vendorDoc.data();
                                vendorIdInput.value = vendorDoc.id;
                                document.getElementById('vendor-name').value = v.name;
                                document.getElementById('vendor-contact').value = v.contact;
                                vendorFormTitle.textContent = 'Edit Vendor';
                                vendorFormButtons.innerHTML = `
                                    <button type="button" id="cancel-edit-vendor" class="bg-slate-200 text-slate-800 font-bold py-2 px-6 rounded-lg hover:bg-slate-300 mr-2">Cancel</button>
                                    <button type="submit" class="bg-green-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-green-700"><i class="fas fa-save mr-2"></i>Update Vendor</button>
                                `;
                                document.getElementById('cancel-edit-vendor').addEventListener('click', resetVendorForm);
                                window.scrollTo(0, 0);
                            }
                        } catch (error) { console.error("Error fetching vendor for edit: ", error); }
                    }
                });

                onSnapshot(collection(db, "vendors"), (snapshot) => {
                    if (snapshot.empty) {
                        vendorsListContainer.innerHTML = `<p class="p-4 text-slate-500 text-center">No vendors have been added yet.</p>`;
                        return;
                    }
                    let tableHtml = `<table class="min-w-full divide-y divide-slate-200"><thead class="bg-slate-50"><tr><th class="px-4 py-3 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">Name</th><th class="px-4 py-3 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">Contact</th><th class="px-4 py-3 text-center text-xs font-semibold text-slate-500 uppercase tracking-wider">Actions</th></tr></thead><tbody class="bg-white divide-y divide-slate-200">`;
                    snapshot.forEach(doc => {
                        const v = doc.data();
                        tableHtml += `<tr class="hover:bg-slate-50">
                            <td class="px-4 py-3 whitespace-nowrap text-sm font-medium text-slate-900">${v.name}</td>
                            <td class="px-4 py-3 whitespace-nowrap text-sm text-slate-500">${v.contact}</td>
                            <td class="px-4 py-3 whitespace-nowrap text-sm font-medium text-center space-x-4">
                                <button data-id="${doc.id}" class="edit-vendor text-blue-600 hover:text-blue-900"><i class="fas fa-edit"></i></button>
                                <button data-id="${doc.id}" class="delete-vendor text-red-600 hover:text-red-900"><i class="fas fa-trash"></i></button>
                            </td>
                        </tr>`;
                    });
                    tableHtml += `</tbody></table>`;
                    vendorsListContainer.innerHTML = tableHtml;
                });
            }

            function setupSettingsPage() {
                const tabsContainer = document.getElementById('settings-tabs');
                if (!tabsContainer) return;
                tabsContainer.addEventListener('click', (e) => {
                    if (e.target.classList.contains('tab-link')) {
                        e.preventDefault();
                        const tabKey = e.target.dataset.tab;
                        tabsContainer.querySelectorAll('.tab-link').forEach(l => l.classList.remove('active-tab'));
                        e.target.classList.add('active-tab');
                        loadSettingsTab(tabKey);
                    }
                });
                loadSettingsTab('shop-list');
            }

            function loadSettingsTab(tabKey) {
                const tabContentContainer = document.getElementById('settings-tab-content');
                if (!tabContentContainer) return;
                tabContentContainer.innerHTML = settingsTabs[tabKey];
                if (tabKey === 'shop-list') setupShopList();
                else if (tabKey === 'user-profile') setupUserProfile();
            }

            function setupShopList() {
                const addShopForm = document.getElementById('add-shop-form');
                const shopsListContainer = document.getElementById('shops-list-container');
                const shopFormTitle = document.getElementById('shop-form-title');
                const shopFormButtons = document.getElementById('shop-form-buttons');
                const shopIdInput = document.getElementById('shop-id');

                const resetShopForm = () => {
                    addShopForm.reset();
                    shopIdInput.value = '';
                    shopFormTitle.textContent = 'Add New Shop';
                    shopFormButtons.innerHTML = `<button type="submit" class="bg-blue-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-700 transition"><i class="fas fa-plus-circle mr-2"></i>Add Shop</button>`;
                }

                addShopForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const shopId = shopIdInput.value;
                    const shopData = { name: document.getElementById('shop-name').value, contact: document.getElementById('shop-contact').value, address: document.getElementById('shop-address').value };
                    try {
                        if (shopId) await updateDoc(doc(db, "shops", shopId), shopData);
                        else await addDoc(collection(db, "shops"), shopData);
                        resetShopForm();
                    } catch (error) { console.error("Error saving shop: ", error); }
                });

                shopsListContainer.addEventListener('click', async (e) => {
                    const target = e.target.closest('button');
                    if (!target) return;
                    const shopId = target.dataset.id;
                    if (!shopId) return;

                    if (target.classList.contains('delete-shop')) {
                         showConfirmation('Delete Shop', 'Are you sure you want to delete this shop?', async () => {
                            try {
                                await deleteDoc(doc(db, "shops", shopId));
                                resetShopForm();
                            } catch (error) { console.error("Error deleting shop: ", error); }
                        });
                    } else if (target.classList.contains('edit-shop')) {
                        try {
                            const shopDoc = await getDoc(doc(db, "shops", shopId));
                            if (shopDoc.exists()) {
                                const s = shopDoc.data();
                                shopIdInput.value = shopDoc.id;
                                document.getElementById('shop-name').value = s.name;
                                document.getElementById('shop-contact').value = s.contact;
                                document.getElementById('shop-address').value = s.address;
                                shopFormTitle.textContent = 'Edit Shop';
                                shopFormButtons.innerHTML = `
                                    <button type="button" id="cancel-edit-shop" class="bg-slate-200 text-slate-800 font-bold py-2 px-6 rounded-lg hover:bg-slate-300 mr-2">Cancel</button>
                                    <button type="submit" class="bg-green-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-green-700"><i class="fas fa-save mr-2"></i>Update Shop</button>
                                `;
                                document.getElementById('cancel-edit-shop').addEventListener('click', resetShopForm);
                                window.scrollTo(0, 0);
                            }
                        } catch (error) { console.error("Error fetching shop for edit: ", error); }
                    }
                });

                onSnapshot(collection(db, "shops"), (snapshot) => {
                    if (snapshot.empty) {
                        shopsListContainer.innerHTML = `<p class="p-4 text-slate-500 text-center">No shops have been added yet.</p>`;
                        return;
                    }
                    let tableHtml = `<table class="min-w-full divide-y divide-slate-200"><thead class="bg-slate-50"><tr><th class="px-4 py-3 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">No.</th><th class="px-4 py-3 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">Name</th><th class="px-4 py-3 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">Contact</th><th class="px-4 py-3 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">Address</th><th class="px-4 py-3 text-center text-xs font-semibold text-slate-500 uppercase tracking-wider">Actions</th></tr></thead><tbody class="bg-white divide-y divide-slate-200">`;
                    snapshot.forEach((doc, index) => {
                        const shop = doc.data();
                        tableHtml += `<tr class="hover:bg-slate-50">
                            <td class="px-4 py-3 whitespace-nowrap text-sm font-medium text-slate-900">${index + 1}</td>
                            <td class="px-4 py-3 whitespace-nowrap text-sm font-medium text-slate-900">${shop.name}</td>
                            <td class="px-4 py-3 whitespace-nowrap text-sm text-slate-500">${shop.contact}</td>
                            <td class="px-4 py-3 text-sm text-slate-500">${shop.address}</td>
                            <td class="px-4 py-3 whitespace-nowrap text-sm font-medium text-center space-x-4">
                                <button data-id="${doc.id}" class="edit-shop text-blue-600 hover:text-blue-900"><i class="fas fa-edit"></i></button>
                                <button data-id="${doc.id}" class="delete-shop text-red-600 hover:text-red-900"><i class="fas fa-trash"></i></button>
                            </td>
                        </tr>`;
                    });
                    tableHtml += `</tbody></table>`;
                    shopsListContainer.innerHTML = tableHtml;
                });
            }

            function setupUserProfile() {
                const addUserForm = document.getElementById('add-user-form');
                const usersListContainer = document.getElementById('users-list-container');
                const userFormTitle = document.getElementById('user-form-title');
                const userFormButtons = document.getElementById('user-form-buttons');
                const userDocIdInput = document.getElementById('user-doc-id');
                const userFormShops = document.getElementById('user-form-shops');
                const userFormPermissions = document.getElementById('user-form-permissions');

                const resetUserForm = () => {
                    addUserForm.reset();
                    userDocIdInput.value = '';
                    userFormTitle.textContent = 'Add New User';
                    userFormButtons.innerHTML = `<button type="submit" class="bg-blue-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-700 transition"><i class="fas fa-plus-circle mr-2"></i>Add User</button>`;
                };
                
                onSnapshot(collection(db, "shops"), (snapshot) => {
                    userFormShops.innerHTML = snapshot.empty ? `<p class="text-slate-500">Please add shops first.</p>` : snapshot.docs.map(doc => `<label class="flex items-center"><input type="checkbox" name="assignedShops" value="${doc.id}" class="h-4 w-4 text-blue-600 border-slate-300 rounded focus:ring-blue-500 mr-2">${doc.data().name}</label>`).join('');
                });

                addUserForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const userDocId = userDocIdInput.value;
                    const userData = {
                        name: document.getElementById('user-name').value, email: document.getElementById('user-email').value, role: document.getElementById('user-role').value, uid: document.getElementById('user-uid').value,
                        assignedShops: Array.from(userFormShops.querySelectorAll('input:checked')).map(el => el.value),
                        permissions: Array.from(userFormPermissions.querySelectorAll('input:checked')).map(el => el.value),
                    };

                    try {
                        if (userDocId) await updateDoc(doc(db, "users", userDocId), userData);
                        else await addDoc(collection(db, "users"), userData); 
                        resetUserForm();
                    } catch (error) { console.error("Error saving user: ", error); }
                });

                usersListContainer.addEventListener('click', async (e) => {
                    const target = e.target.closest('button');
                    if (!target) return;
                    const userId = target.dataset.id;
                    if (!userId) return;

                    if (target.classList.contains('delete-user')) {
                        showConfirmation('Delete User', `Are you sure you want to delete this user?`, async () => {
                            try {
                                await deleteDoc(doc(db, "users", userId));
                                resetUserForm();
                            } catch (error) { console.error("Error deleting user: ", error); }
                        });
                    } else if (target.classList.contains('edit-user')) {
                        try {
                            const userDoc = await getDoc(doc(db, "users", userId));
                            if (userDoc.exists()) {
                                const user = userDoc.data();
                                userDocIdInput.value = userDoc.id;
                                document.getElementById('user-name').value = user.name;
                                document.getElementById('user-email').value = user.email;
                                document.getElementById('user-role').value = user.role;
                                document.getElementById('user-uid').value = user.uid;

                                userFormShops.querySelectorAll('input').forEach(c => c.checked = user.assignedShops && user.assignedShops.includes(c.value));
                                userFormPermissions.querySelectorAll('input').forEach(c => c.checked = user.permissions && user.permissions.includes(c.value));

                                userFormTitle.textContent = 'Edit User';
                                userFormButtons.innerHTML = `
                                    <button type="button" id="cancel-edit-user" class="bg-slate-200 text-slate-800 font-bold py-2 px-6 rounded-lg hover:bg-slate-300 mr-2">Cancel</button>
                                    <button type="submit" class="bg-green-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-green-700"><i class="fas fa-save mr-2"></i>Update User</button>
                                `;
                                document.getElementById('cancel-edit-user').addEventListener('click', resetUserForm);
                                window.scrollTo(0, 0);
                            }
                        } catch (error) { console.error("Error fetching user for edit: ", error); }
                    }
                });

                 onSnapshot(collection(db, "users"), (snapshot) => {
                    if (snapshot.empty) {
                        usersListContainer.innerHTML = `<p class="p-4 text-slate-500 text-center">No users have been added yet.</p>`;
                        return;
                    }
                    let tableHtml = `<table class="min-w-full divide-y divide-slate-200"><thead class="bg-slate-50"><tr><th class="px-4 py-3 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">Name</th><th class="px-4 py-3 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">Email</th><th class="px-4 py-3 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">Role</th><th class="px-4 py-3 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">Linked UID</th><th class="px-4 py-3 text-center text-xs font-semibold text-slate-500 uppercase tracking-wider">Actions</th></tr></thead><tbody class="bg-white divide-y divide-slate-200">`;
                    snapshot.forEach(doc => {
                        const u = doc.data();
                        tableHtml += `<tr class="hover:bg-slate-50">
                            <td class="px-4 py-3 whitespace-nowrap text-sm font-medium text-slate-900">${u.name}</td>
                            <td class="px-4 py-3 whitespace-nowrap text-sm text-slate-500">${u.email}</td>
                            <td class="px-4 py-3 whitespace-nowrap text-sm text-slate-500">${u.role}</td>
                            <td class="px-4 py-3 whitespace-nowrap text-sm text-slate-500 truncate" style="max-width: 150px;" title="${u.uid || ''}">${u.uid || 'Not Linked'}</td>
                            <td class="px-4 py-3 whitespace-nowrap text-center text-sm font-medium space-x-4">
                                <button data-id="${doc.id}" class="edit-user text-blue-600 hover:text-blue-900" title="Edit"><i class="fas fa-edit"></i></button>
                                <button data-id="${doc.id}" class="delete-user text-red-600 hover:text-red-900" title="Delete"><i class="fas fa-trash"></i></button>
                            </td>
                        </tr>`;
                    });
                    tableHtml += `</tbody></table>`;
                    usersListContainer.innerHTML = tableHtml;
                });
            }


            // --- Event Listeners ---
            sidebarToggle.addEventListener('click', toggleSidebar);
            overlay.addEventListener('click', toggleSidebar);

            sidebarLinks.forEach(link => {
                link.addEventListener('click', (e) => {
                    const pageKey = e.currentTarget.dataset.page;
                    if (pageKey) {
                        e.preventDefault();
                        sidebarLinks.forEach(l => l.classList.remove('active'));
                        e.currentTarget.classList.add('active');
                        loadPage(pageKey);
                        if (window.innerWidth < 768) toggleSidebar();
                    }
                });
            });
            
            // --- Initial Load ---
            if (firstAllowedPage) {
                loadPage(firstAllowedPage);
            } else {
                pageContent.innerHTML = `<div class="bg-white p-8 rounded-lg shadow-lg text-center"><i class="fas fa-lock text-5xl text-yellow-500 mb-4"></i><h3 class="text-3xl font-bold text-slate-700">No Access</h3><p class="text-slate-500 mt-2">You do not have permissions for any pages. Please contact an administrator.</p></div>`;
                pageTitle.textContent = "Access Denied";
            }
        }
    </script>
</body>
</html>
