<!DOCTYPE html>
    <html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Purchase Order System</title>
        
        <!-- Tailwind CSS -->
        <script src="https://cdn.tailwindcss.com"></script>
        
        <!-- Font Awesome for Icons -->
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
        
        <!-- Google Fonts for Khmer Unicode -->
        <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Khmer:wght@400;700&display=swap" rel="stylesheet">

        <!-- React & Babel for JSX in Browser -->
        <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
        <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
        <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
        
        <!-- Firebase SDKs (Compat version for script tags) -->
        <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
        <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
        <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
        
        <!-- Helper Libraries -->
        <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcode-generator/1.4.4/qrcode.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/fuse.js@6.6.2"></script>
        <!-- NEW: Chart.js for Reports -->
        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

        <!-- Custom Styles -->
        <style>
            body {
                background-color: #0f172a; /* bg-slate-900 */
                -webkit-font-smoothing: antialiased;
                -moz-osx-font-smoothing: grayscale;
                overflow-x: hidden; /* Prevent horizontal scroll on the body */
            }
            /* Custom utility to hide scrollbars */
            .no-scrollbar::-webkit-scrollbar {
                display: none;
            }
            .no-scrollbar {
                -ms-overflow-style: none;  /* IE and Edge */
                scrollbar-width: none;  /* Firefox */
            }
            .loader {
                border: 4px solid rgba(255, 255, 255, 0.3);
                border-top: 4px solid #3b82f6; /* blue-500 */
                border-radius: 50%;
                width: 24px;
                height: 24px;
                animation: spin 1s linear infinite;
            }
            @keyframes spin {
                0% { transform: rotate(0deg); }
                100% { transform: rotate(360deg); }
            }
            .tab-link-dark {
                color: #94a3b8; /* text-slate-400 */
                border-color: transparent;
            }
            .tab-link-dark:hover {
                border-color: #475569; /* border-slate-600 */
                color: #cbd5e1; /* text-slate-300 */
            }
            .tab-link-dark.active-tab-dark {
                color: #60a5fa; /* text-blue-400 */
                border-color: #60a5fa; /* border-blue-400 */
            }
            @keyframes fade-in-up {
                from {
                    opacity: 0;
                    transform: translateY(20px) scale(0.95);
                }
                to {
                    opacity: 1;
                    transform: translateY(0) scale(1);
                }
            }
            .animate-fade-in-up {
                animation: fade-in-up 0.3s ease-out forwards;
            }
            .po-preview-capture {
                color: #1e293b; /* slate-800 */
                background-color: white;
                font-family: 'Noto Sans Khmer', 'Arial', sans-serif;
                width: 1050px; /* Fixed width for layout consistency */
                margin: auto;
                display: flex;
                flex-direction: column;
                padding: 1.5rem;
                font-size: 12pt; /* Set base font size for PDF output */
            }
            /* Custom styles for responsive tables */
            @media (max-width: 767px) {
                .responsive-table thead {
                    display: none;
                }
                .responsive-table tr {
                    display: block;
                    margin-bottom: 1rem;
                    border-radius: 0.5rem;
                    border: 1px solid #334155; /* border-slate-700 */
                    overflow: hidden;
                    background-color: #1e293b; /* bg-slate-800 for card effect */
                }
                .responsive-table td {
                    display: block;
                    padding: 0.75rem 1rem;
                    text-align: right;
                    border-bottom: 1px solid #334155; /* border-slate-700 */
                    position: relative;
                    padding-left: 40%; /* Reduced padding left to give more space to content */
                    min-height: 40px; /* Ensure touch target size */
                }
                .responsive-table td:last-child {
                    border-bottom: none;
                    padding-left: 1rem; /* Center actions */
                    text-align: center;
                    display: flex;
                    justify-content: space-around;
                    align-items: center;
                    padding-top: 1rem;
                    padding-bottom: 1rem;
                    background-color: rgba(15, 23, 42, 0.3); /* Slightly darker footer for actions */
                }
                .responsive-table td:before {
                    content: attr(data-label);
                    position: absolute;
                    left: 1rem;
                    width: 35%;
                    padding-right: 0.5rem;
                    white-space: nowrap;
                    text-align: left;
                    font-weight: 600;
                    color: #94a3b8; /* text-slate-400 */
                    font-size: 0.75rem;
                    text-transform: uppercase;
                    letter-spacing: 0.05em;
                    top: 50%;
                    transform: translateY(-50%);
                }
                /* Hide empty cells in mobile view to save space */
                .responsive-table td:empty {
                    display: none;
                }
            }
        </style>
    </head>
    <body>
        <div id="root"></div>

        <script type="text/babel">
    // --- 1. SETUP & CONFIGURATION ---

    // Firebase Initialization
    const firebaseConfig = {
        apiKey: "AIzaSyAsw_K2LarDunqh9ePnSRuMjXrzd6WZ1EI",
        authDomain: "posystem-3e373.firebaseapp.com",
        projectId: "posystem-3e373",
        storageBucket: "posystem-3e373.appspot.com",
        messagingSenderId: "783169032599",
        appId: "1:783169032599:web:d44e8956e790a7f9b3b4d2",
        measurementId: "G-G6B8H6HSQC"
    };
    const app = firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // FIX: Force long polling to prevent WebSocket connection drops and [code=unavailable] errors
    db.settings({ 
        experimentalForceLongPolling: true, 
        useFetchStreams: false 
    });

    // React Hooks
    const { useState, useEffect, useCallback, useMemo, useRef, createContext, useContext, memo } = React;

    // --- 2. GLOBAL CONTEXTS (State Management) ---

    // Application Data Context
    const DataContext = createContext(null);
    const DataProvider = ({ children }) => {
        // STEP 1: Refactor state to handle prioritized loading
        const [highPriorityProducts, setHighPriorityProducts] = useState([]);
        const [mediumPriorityProducts, setMediumPriorityProducts] = useState([]);
        const [lowPriorityProducts, setLowPriorityProducts] = useState([]);
        const [productsLoading, setProductsLoading] = useState(true);

        // New states for the background loading indicator
        const [highPriorityLoaded, setHighPriorityLoaded] = useState(false);
        const [mediumPriorityLoaded, setMediumPriorityLoaded] = useState(false);
        const [lowPriorityLoaded, setLowPriorityLoaded] = useState(false);
        const [backgroundFetchInitiated, setBackgroundFetchInitiated] = useState(false);
        
        // --- NEW: System Config State ---
        const [systemConfig, setSystemConfig] = useState({ appName: 'PO System' });

        // --- NEW: Device Management State (PHASE 1) ---
        const { data: devices, loading: devicesLoading } = useCollection('devices');
        const [currentDeviceId, setCurrentDeviceId] = useState(() => localStorage.getItem('pos_deviceId') || '');

        const setLocalDevice = (deviceId) => {
            localStorage.setItem('pos_deviceId', deviceId);
            setCurrentDeviceId(deviceId);
        };

        const { data: vendors, loading: vendorsLoading } = useCollection('vendors');
        const { data: shops, loading: shopsLoading } = useCollection('shops');
        // --- HIGH PRIORITY FETCHING ---
        // These collections are fetched first to unblock the UI quickly.
        const { data: allPOs, loading: posLoading } = useCollection('purchaseOrders');
        const { data: allTransfers, loading: transfersLoading } = useCollection('internalTransfers');
        const { data: users, loading: usersLoading } = useCollection('users');
        // --- PHASE 1 ADDITION: Fetch Customers ---
        const { data: customers, loading: customersLoading } = useCollection('customers');

        // --- NEW: Fetch System Config ---
        useEffect(() => {
            const unsubscribe = db.collection('system').doc('config').onSnapshot(doc => {
                if (doc.exists) {
                    setSystemConfig(prev => ({ ...prev, ...doc.data() }));
                }
            }, (error) => {
                // Silently handle permission errors if rules are strict
                console.warn("System config sync paused:", error.code);
            });
            return () => unsubscribe();
        }, []);

        // STEP 2: Implement Phased Fetching Logic
        useEffect(() => {
            // Wait until vendors have been loaded.
            if (vendorsLoading || !vendors) {
                return;
            }

            // If there are no vendors, there are no products to load.
            if (vendors.length === 0) {
                setProductsLoading(false);
                setHighPriorityLoaded(true);
                setMediumPriorityLoaded(true);
                setLowPriorityLoaded(true);
                return;
            }

            setHighPriorityProducts([]);
            setMediumPriorityProducts([]);
            setLowPriorityProducts([]);
            
            // Reset loading indicators on re-fetch
            setBackgroundFetchInitiated(false);
            setHighPriorityLoaded(false);
            setMediumPriorityLoaded(false);
            setLowPriorityLoaded(false);

            const highPriorityVendorIds = vendors.filter(v => (v.priority || 'Low') === 'High').map(v => v.id);
            const mediumPriorityVendorIds = vendors.filter(v => (v.priority || 'Low') === 'Medium').map(v => v.id);
            const lowPriorityVendorIds = vendors.filter(v => (v.priority || 'Low') === 'Low').map(v => v.id);

            let allUnsubscribes = [];

            // Helper function to fetch products in chunks to respect Firestore's 30-item limit for 'in' queries.
            const fetchProductsInChunks = (vendorIds, setDataCallback, setLoadedCallback) => {
                if (!vendorIds || vendorIds.length === 0) {
                    setDataCallback([]);
                    if(setLoadedCallback) setLoadedCallback(true); // If no vendors, it's immediately "loaded"
                    return;
                }

                const CHUNK_SIZE = 30;
                const allProductsForPriority = new Map();

                for (let i = 0; i < vendorIds.length; i += CHUNK_SIZE) {
                    const chunk = vendorIds.slice(i, i + CHUNK_SIZE);
                    if (chunk.length > 0) {
                        const query = db.collection('products').where('vendorId', 'in', chunk);
                        
                        const unsub = query.onSnapshot(snapshot => {
                            // --- FIX START ---
                            // Use docChanges() to correctly handle additions, modifications, AND removals.
                            snapshot.docChanges().forEach((change) => {
                                if (change.type === "added" || change.type === "modified") {
                                    allProductsForPriority.set(change.doc.id, { id: change.doc.id, ...change.doc.data() });
                                }
                                if (change.type === "removed") {
                                    allProductsForPriority.delete(change.doc.id);
                                }
                            });
                            // --- FIX END ---

                            // Update state with the combined results from all chunks for this priority level.
                            setDataCallback(Array.from(allProductsForPriority.values()));
                            if(setLoadedCallback) setLoadedCallback(true); // Signal that at least one chunk has loaded.
                        }, (error) => console.error("Error fetching product chunk:", error));
                        
                        allUnsubscribes.push(unsub);
                    }
                }
            };
            
            // --- Initiate Phased Fetching ---
            setBackgroundFetchInitiated(true);
            fetchProductsInChunks(highPriorityVendorIds, setHighPriorityProducts, setHighPriorityLoaded);
            fetchProductsInChunks(mediumPriorityVendorIds, setMediumPriorityProducts, setMediumPriorityLoaded);
            fetchProductsInChunks(lowPriorityVendorIds, setLowPriorityProducts, setLowPriorityLoaded);
            
            // Set loading to false immediately, allowing the UI to become interactive.
            // All products will now stream in in the background.
            

            // Cleanup function to detach all listeners when the component unmounts or vendors change.
            return () => {
                allUnsubscribes.forEach(unsub => unsub());
            };

        }, [vendors, vendorsLoading]);

        // This effect ensures the app is "ready" for product searches once high-priority items are loaded.
        useEffect(() => {
            if (highPriorityLoaded) {
                setProductsLoading(false);
            }
        }, [highPriorityLoaded]);


        // Combine all product lists into one for the rest of the application
        const products = useMemo(() => [
            ...highPriorityProducts, 
            ...mediumPriorityProducts, 
            ...lowPriorityProducts
        ], [highPriorityProducts, mediumPriorityProducts, lowPriorityProducts]);


        const isLoading = vendorsLoading || shopsLoading || posLoading || transfersLoading || usersLoading;
        const backgroundLoadComplete = highPriorityLoaded && mediumPriorityLoaded && lowPriorityLoaded;

        const value = { 
            products, vendors, shops, allPOs, allTransfers, users, customers, 
            devices, // <-- Expose devices list
            currentDeviceId, setLocalDevice, // <-- Expose identity state
            isLoading, 
            productsLoading,
            posLoading, transfersLoading, usersLoading, customersLoading,
            backgroundFetchInitiated, backgroundLoadComplete,
            systemConfig // <-- Expose config
        };

        return (
            <DataContext.Provider value={value}>
                {children}
            </DataContext.Provider>
        );
    };
    const useData = () => useContext(DataContext);

    // Product Search Context (Fuse.js)
    const SearchContext = createContext(null);
    const SearchProvider = ({ children }) => {
        const { products, productsLoading } = useData();
        const fuse = useMemo(() => {
            if (!productsLoading && products && products.length > 0) {
                return new Fuse(products, {
                    keys: ['name', 'code', 'barcode'],
                    includeScore: true,
                    threshold: 0.4,
                    minMatchCharLength: 2,
                });
            }
            return null;
        }, [products, productsLoading]);

        return (
            <SearchContext.Provider value={fuse}>
                {children}
            </SearchContext.Provider>
        );
    };
    const useProductSearch = () => useContext(SearchContext);

    // --- 3. CUSTOM HOOKS (Reusable Logic) ---

    // Fetches a Firestore collection with real-time updates
    const useCollection = (collectionName, options = {}) => {
        const [data, setData] = useState([]);
        const [loading, setLoading] = useState(true);

        useEffect(() => {
            let query = db.collection(collectionName);
            if (options.query) {
                options.query.forEach(q => {
                    query = query.where(q[0], q[1], q[2]);
                });
            }

            const unsubscribe = query.onSnapshot((querySnapshot) => {
                const items = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                setData(items);
                setLoading(false);
            }, (error) => {
                console.error(`Error fetching ${collectionName}:`, error);
                setLoading(false);
            });

            return () => unsubscribe();
        }, [collectionName, JSON.stringify(options.query)]);

        return { data, loading };
    };

    // Delays updating a value until a certain time has passed
    const useDebounce = (value, delay) => {
        const [debouncedValue, setDebouncedValue] = useState(value);
        useEffect(() => {
            const handler = setTimeout(() => setDebouncedValue(value), delay);
            return () => clearTimeout(handler);
        }, [value, delay]);
        return debouncedValue;
    };

    // --- 4. UTILITY FUNCTIONS ---

    // Safely converts Firestore Timestamps or date strings to Date objects
    const safeToDate = (timestamp) => {
        if (!timestamp) return null;
        if (timestamp instanceof Date) return timestamp; // Handle native Date objects
        if (typeof timestamp.toDate === 'function') return timestamp.toDate();
        if (typeof timestamp === 'string') {
            const date = new Date(timestamp);
            return isNaN(date) ? null : date;
        }
        if (timestamp.seconds) return new Date(timestamp.seconds * 1000);
        return null;
    };

    // Formats a date object or compatible string into DD-MM-YYYY format
    const formatDateDDMMYYYY = (dateObj) => {
        if (!dateObj) return 'N/A';
        const d = safeToDate(dateObj);
        if (!d) return 'N/A';
        const day = String(d.getDate()).padStart(2, '0');
        const month = String(d.getMonth() + 1).padStart(2, '0'); // Month is 0-indexed
        const year = d.getFullYear();
        return `${day}-${month}-${year}`;
    };

    // Generates a unique, non-duplicate product code.
    const generateUniqueProductCode = async () => {
        const generateCode = () => `DF_${Math.floor(10000 + Math.random() * 90000)}`;
        let isUnique = false;
        let newCode = '';
        let attempts = 0; // Safety break to prevent infinite loops
        while (!isUnique && attempts < 20) {
            newCode = generateCode();
            const snapshot = await db.collection("products").where("code", "==", newCode).limit(1).get();
            if (snapshot.empty) {
                isUnique = true;
            }
            attempts++;
        }
        if (!isUnique) {
            throw new Error("Could not generate a unique product code after several attempts. Please try again.");
        }
        return newCode;
    };


    // Formatters for currency
    const khrFormatter = new Intl.NumberFormat('en-US');
    const usdFormatter = new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' });

    // --- 5. REUSABLE UI COMPONENTS ---

    const Card = memo(({ children, className = '' }) => (
        <div className={`bg-slate-800/50 p-4 md:p-6 rounded-lg shadow-lg border border-slate-700 ${className}`}>
            {children}
        </div>
    ));

    const CardTitle = memo(({ children }) => (
        <h3 className="text-xl md:text-2xl font-semibold text-slate-100 mb-4 md:mb-6 border-b border-slate-600 pb-4">{children}</h3>
    ));

    const TableCard = memo(({ title, children }) => (
        <Card>
            <div className="flex flex-col md:flex-row justify-between md:items-center mb-4">
                <h4 className="text-lg md:text-xl font-semibold text-slate-200 mb-4 md:mb-0">{title}</h4>
            </div>
            <div className="overflow-x-auto">
                {children}
            </div>
        </Card>
    ));

    const Modal = ({ children, show, maxWidth = 'max-w-4xl' }) => {
        if (!show) return null;
        return (
            <div className="fixed inset-0 z-50 flex items-end md:items-center justify-center p-0 md:p-4 bg-black bg-opacity-70 backdrop-blur-sm transition-opacity">
                <div className={`bg-slate-800 border-slate-700 border-t md:border border-x-0 md:border-x rounded-t-2xl md:rounded-lg shadow-2xl w-full ${maxWidth} h-[85vh] md:h-auto md:max-h-[95vh] flex flex-col text-slate-200 animate-fade-in-up transform transition-transform`}>
                    {/* Mobile Handle Bar for visual cue */}
                    <div className="md:hidden w-full flex justify-center pt-3 pb-1 cursor-grab">
                        <div className="w-16 h-1.5 bg-slate-600 rounded-full"></div>
                    </div>
                    {children}
                </div>
            </div>
        );
    };

    const ModalHeader = memo(({ title, onClose }) => (
        <div className="px-5 py-4 border-b border-slate-700 flex justify-between items-center shrink-0">
            <h3 className="text-lg md:text-xl font-bold text-slate-100 truncate pr-4">{title}</h3>
            <button onClick={onClose} className="w-8 h-8 flex items-center justify-center rounded-full bg-slate-700 text-slate-300 hover:text-white hover:bg-slate-600 transition-colors">
                <i className="fas fa-times"></i>
            </button>
        </div>
    ));

    const ModalBody = memo(({ children }) => (
        <div className="p-4 md:p-6 flex-grow overflow-auto">{children}</div>
    ));

    const ModalFooter = memo(({ children }) => (
        <div className="p-4 bg-slate-900/50 border-t border-slate-700 flex flex-col sm:flex-row justify-end gap-3">
            {children}
        </div>
    ));

    const MessageModal = ({ title, message, isError, onClose, show }) => (
        <Modal show={show} maxWidth="max-w-md">
            <ModalHeader title={title} onClose={onClose} />
            <ModalBody>
                <div className="flex items-center">
                    <i className={`fas ${isError ? 'fa-exclamation-circle text-red-500' : 'fa-info-circle text-blue-500'} text-4xl mr-5`}></i>
                    <p className="text-slate-300">{message}</p>
                </div>
            </ModalBody>
            <ModalFooter>
                <button onClick={onClose} type="button" className="bg-blue-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-700 transition w-full sm:w-auto">OK</button>
            </ModalFooter>
        </Modal>
    );

    const ConfirmationModal = ({ title, message, onConfirm, onCancel, show }) => (
        <Modal show={show} maxWidth="max-w-lg">
            <ModalHeader title={title} onClose={onCancel} />
            <ModalBody>
                <div className="p-4 md:p-8 flex items-start">
                    <i className="fas fa-question-circle text-yellow-400 text-4xl mr-5 mt-1"></i>
                    <div>
                        <p className="text-slate-300">{message}</p>
                        <p className="text-sm text-slate-400 mt-2">This action cannot be undone.</p>
                    </div>
                </div>
            </ModalBody>
            <ModalFooter>
                <button onClick={onCancel} type="button" className="bg-slate-600 text-slate-100 font-bold py-2 px-6 rounded-lg hover:bg-slate-500 transition w-full sm:w-auto">Cancel</button>
                <button onClick={onConfirm} type="button" className="bg-red-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-red-700 transition w-full sm:w-auto">Confirm</button>
            </ModalFooter>
        </Modal>
    );

    const LoadingStatusToast = ({ isComplete }) => {
        const [visible, setVisible] = useState(true);
        const [statusText, setStatusText] = useState('Loading products...');
        const [icon, setIcon] = useState(<div className="loader w-4 h-4"></div>);
        const [bgColor, setBgColor] = useState('bg-slate-700');

        useEffect(() => {
            if (isComplete) {
                setStatusText('All products loaded.');
                setIcon(<i className="fas fa-check-circle"></i>);
                setBgColor('bg-green-600');
                
                const timer = setTimeout(() => {
                    setVisible(false);
                }, 4000); // Hide after 4 seconds

                return () => clearTimeout(timer);
            }
        }, [isComplete]);

        if (!visible) return null;

        return (
            <div className={`fixed bottom-4 right-4 ${bgColor} text-white px-4 py-3 rounded-lg shadow-lg flex items-center gap-3 transition-all duration-500 z-50`}>
                {icon}
                <span className="font-medium text-sm">{statusText}</span>
            </div>
        );
    };

    // --- 6. AUTHENTICATION & LAYOUT COMPONENTS (RESTORED) ---

    const LoginPage = () => {
        const [email, setEmail] = useState('');
        const [password, setPassword] = useState('');
        const [showPassword, setShowPassword] = useState(false);
        const [rememberMe, setRememberMe] = useState(true);
        const [error, setError] = useState('');
        const [loading, setLoading] = useState(false);
        
        const [appName, setAppName] = useState('PO System');

        useEffect(() => {
            db.collection('system').doc('config').get().then(doc => {
                if(doc.exists && doc.data().appName) {
                    setAppName(doc.data().appName);
                    document.title = doc.data().appName;
                }
            }).catch(err => {
                if (err.code !== 'permission-denied') console.log("Config fetch error", err);
            });
        }, []);

        const handleLogin = async (e) => {
            e.preventDefault();
            if (!email || !password) { setError("Please enter both email and password."); return; }
            setLoading(true); setError('');
            try {
                const persistence = rememberMe ? firebase.auth.Auth.Persistence.LOCAL : firebase.auth.Auth.Persistence.SESSION;
                await auth.setPersistence(persistence);
                await auth.signInWithEmailAndPassword(email, password);
            } catch (err) {
                setError("Failed to login. Please check your credentials.");
                setLoading(false);
            }
        };

        return (
            <div className="min-h-screen bg-slate-900 flex items-center justify-center p-4">
                <div className="w-full max-w-md mx-auto bg-slate-800 rounded-2xl shadow-xl p-8 border border-slate-700">
                    <div className="text-center mb-8">
                        <i className="fas fa-file-invoice-dollar text-5xl text-blue-500"></i>
                        <h1 className="text-3xl font-bold text-slate-100 mt-4">{appName}</h1>
                        <p className="text-slate-400">Please sign in to continue</p>
                    </div>
                    <form onSubmit={handleLogin} className="space-y-6">
                        {error && <div className="bg-red-500/10 border border-red-500/50 rounded-lg p-3 flex items-center gap-3 text-red-400 text-sm"><i className="fas fa-exclamation-circle text-lg"></i>{error}</div>}
                        <div>
                            <label className="block text-sm font-medium text-slate-300 mb-1">Email Address</label>
                            <div className="relative">
                                <span className="absolute left-3 top-3 text-slate-500"><i className="fas fa-envelope"></i></span>
                                <input type="email" required value={email} onChange={(e) => setEmail(e.target.value)} className="w-full bg-slate-700 text-white pl-10 pr-4 py-3 rounded-lg border border-slate-600 focus:ring-2 focus:ring-blue-500 outline-none" placeholder="Enter your email" />
                            </div>
                        </div>
                        <div>
                            <label className="block text-sm font-medium text-slate-300 mb-1">Password</label>
                            <div className="relative">
                                <span className="absolute left-3 top-3 text-slate-500"><i className="fas fa-lock"></i></span>
                                <input type={showPassword ? "text" : "password"} required value={password} onChange={(e) => setPassword(e.target.value)} className="w-full bg-slate-700 text-white pl-10 pr-10 py-3 rounded-lg border border-slate-600 focus:ring-2 focus:ring-blue-500 outline-none" placeholder="Enter your password" />
                                <button type="button" onClick={() => setShowPassword(!showPassword)} className="absolute right-3 top-3 text-slate-500 hover:text-slate-300"><i className={`fas ${showPassword ? 'fa-eye-slash' : 'fa-eye'}`}></i></button>
                            </div>
                        </div>
                        <button type="submit" disabled={loading} className="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg transition-all shadow-lg shadow-blue-500/30">
                            {loading ? <div className="loader mx-auto w-5 h-5 border-white/30 border-t-white"></div> : "Sign In"}
                        </button>
                    </form>
                </div>
            </div>
        );
    };

    const Sidebar = ({ activePage, setActivePage, userProfile, isSidebarOpen, toggleSidebar }) => {
        const { systemConfig } = useData();
        const allowedPages = userProfile.permissions || [];
        
        return (
            <aside className={`w-64 bg-slate-900 text-slate-300 p-4 flex flex-col transform ${isSidebarOpen ? 'translate-x-0' : '-translate-x-full'} md:translate-x-0 transition-transform duration-300 ease-in-out z-40 fixed md:relative h-full border-r border-slate-700`}>
                <div className="flex items-center mb-10 px-2">
                    <i className="fas fa-file-invoice-dollar text-3xl text-blue-500 mr-3"></i>
                    <h1 className="text-2xl font-bold text-white truncate" title={systemConfig?.appName || 'PO System'}>{systemConfig?.appName || 'PO System'}</h1>
                </div>
                <nav className="flex-grow space-y-2">
                    <a href="#" onClick={() => setActivePage('pos-terminal')} className={`flex items-center py-3 px-4 rounded-lg transition duration-200 ${activePage === 'pos-terminal' ? 'bg-blue-600 text-white shadow-lg' : 'hover:bg-slate-800'}`}>
                        <i className="fas fa-cash-register w-6 mr-3 text-center"></i><span className="font-medium">POS Terminal</span>
                    </a>
                    {(userProfile.role === 'Admin' || allowedPages.includes('sales-report')) && (
                        <a href="#" onClick={() => setActivePage('sales-report')} className={`flex items-center py-3 px-4 rounded-lg transition duration-200 ${activePage === 'sales-report' ? 'bg-blue-600 text-white shadow-lg' : 'hover:bg-slate-800'}`}>
                            <i className="fas fa-chart-line w-6 mr-3 text-center"></i><span className="font-medium">Sale Report</span>
                        </a>
                    )}
                    {(userProfile.role === 'Admin' || allowedPages.includes('customer-management')) && (
                        <a href="#" onClick={() => setActivePage('customer-management')} className={`flex items-center py-3 px-4 rounded-lg transition duration-200 ${activePage === 'customer-management' ? 'bg-blue-600 text-white shadow-lg' : 'hover:bg-slate-800'}`}>
                            <i className="fas fa-users w-6 mr-3 text-center"></i><span className="font-medium">Customers</span>
                        </a>
                    )}
                    {(userProfile.role === 'Admin' || allowedPages.includes('inventory')) && (
                        <a href="#" onClick={() => setActivePage('inventory')} className={`flex items-center py-3 px-4 rounded-lg transition duration-200 ${activePage === 'inventory' ? 'bg-blue-600 text-white shadow-lg' : 'hover:bg-slate-800'}`}>
                            <i className="fas fa-warehouse w-6 mr-3 text-center"></i><span className="font-medium">Inventory</span>
                        </a>
                    )}
                    {(userProfile.role === 'Admin' || allowedPages.includes('settings')) && (
                        <a href="#" onClick={() => setActivePage('settings')} className={`flex items-center py-3 px-4 rounded-lg transition duration-200 ${activePage === 'settings' ? 'bg-blue-600 text-white shadow-lg' : 'hover:bg-slate-800'}`}>
                            <i className="fas fa-cog w-6 mr-3 text-center"></i><span className="font-medium">Settings</span>
                        </a>
                    )}
                </nav>
            </aside>
        );
    };

    const Header = ({ pageTitle, userProfile, toggleSidebar }) => (
        <header className="bg-slate-800 shadow-md h-16 flex items-center justify-between px-4 sm:px-6 z-30">
            <div className="flex items-center">
                <button onClick={toggleSidebar} className="text-slate-400 hover:text-white mr-4 md:hidden"><i className="fas fa-bars text-xl"></i></button>
                <h2 className="text-lg md:text-xl font-bold text-slate-100 truncate">{pageTitle}</h2>
            </div>
            <div className="flex items-center space-x-4">
                <div className="hidden md:flex flex-col items-end">
                    <span className="text-sm font-medium text-slate-200">{userProfile?.name}</span>
                    <span className="text-xs text-slate-400 capitalize">{userProfile?.role}</span>
                </div>
                <div className="relative group">
                    <div className="w-10 h-10 rounded-full bg-blue-600 flex items-center justify-center text-white font-bold cursor-pointer shadow-lg border-2 border-slate-700">
                        {userProfile?.name?.charAt(0).toUpperCase()}
                    </div>
                    <div className="absolute right-0 mt-2 w-48 bg-slate-800 rounded-lg shadow-xl py-2 border border-slate-700 hidden group-hover:block z-50">
                        <a href="#" onClick={() => auth.signOut()} className="block px-4 py-2 text-sm text-red-400 hover:bg-slate-700"><i className="fas fa-sign-out-alt mr-2"></i> Sign Out</a>
                    </div>
                </div>
            </div>
        </header>
    );

    // --- 8. PAGE & FEATURE COMPONENTS ---

    // --- NEW: Device Setup Wizard (Professional One-Time Set) ---
    const DeviceSetup = ({ userProfile }) => {
        const { shops, devices, setLocalDevice } = useData();
        const [selectedShopId, setSelectedShopId] = useState('');
        const [selectedDeviceId, setSelectedDeviceId] = useState('');
        const [isSubmitting, setIsSubmitting] = useState(false);
        const [busyDevices, setBusyDevices] = useState([]); // Stores IDs of devices with open shifts

        // 1. Filter shops based on user permissions
        const availableShops = useMemo(() => {
            if (!userProfile || userProfile.role === 'Admin') return shops;
            const assigned = userProfile.assignedShops || [];
            return shops.filter(s => assigned.includes(s.id));
        }, [shops, userProfile]);

        // 2. Auto-select shop if user only has one assigned
        useEffect(() => {
            if (availableShops.length === 1) {
                setSelectedShopId(availableShops[0].id);
            }
        }, [availableShops]);

        // 3. Real-time check for BUSY devices (Open Shifts)
        useEffect(() => {
            if (!selectedShopId) {
                setBusyDevices([]);
                return;
            }

            // Query active shifts for this shop
            const unsubscribe = db.collection('shifts')
                .where('shopId', '==', selectedShopId)
                .where('status', '==', 'open')
                .onSnapshot(snapshot => {
                    const busyList = snapshot.docs.map(doc => {
                        const data = doc.data();
                        return {
                            deviceId: data.deviceId,
                            cashierId: data.cashierId,
                            cashierName: data.cashierName
                        };
                    });
                    setBusyDevices(busyList);
                });
            return () => unsubscribe();
        }, [selectedShopId]);

        // 4. Filter Available Devices
        const availableDevices = useMemo(() => {
            if (!selectedShopId) return [];
            
            const shopDevices = devices.filter(d => d.shopId === selectedShopId);
            
            return shopDevices.map(device => {
                const busyInfo = busyDevices.find(b => b.deviceId === device.id);
                // A device is "Available" if:
                // 1. It has no open shift (busyInfo is undefined)
                // 2. OR It has an open shift, but it belongs to ME (Resume Session)
                const isMine = busyInfo && busyInfo.cashierId === userProfile.uid;
                const isBusy = busyInfo && !isMine;
                
                return {
                    ...device,
                    isBusy,
                    isMine,
                    statusLabel: isBusy ? `Busy (${busyInfo.cashierName})` : isMine ? 'Resume Session' : 'Available'
                };
            }).filter(d => !d.isBusy); // STRICT: Hide devices busy by others as requested
        }, [devices, selectedShopId, busyDevices, userProfile.uid]);

        // NOTE: Auto-select logic for devices has been REMOVED as requested.

        const handleInitialize = () => {
            if (!selectedDeviceId) return;
            setIsSubmitting(true);
            // Simulate processing for UX
            setTimeout(() => {
                setLocalDevice(selectedDeviceId);
                setIsSubmitting(false);
            }, 500);
        };

        return (
            <div className="flex items-center justify-center h-full bg-slate-900 p-4">
                <div className="bg-slate-800 rounded-2xl shadow-2xl w-full max-w-md border border-slate-700 overflow-hidden animate-fade-in-up">
                    <div className="bg-gradient-to-r from-blue-600 to-blue-800 p-6 text-center">
                        <i className="fas fa-cash-register text-5xl text-white mb-4 opacity-90"></i>
                        <h2 className="text-2xl font-bold text-white">Terminal Setup</h2>
                        <p className="text-blue-100 text-sm mt-1">Identify this device to start selling.</p>
                    </div>
                    
                    <div className="p-8 space-y-6">
                        {/* Shop Selection */}
                        <div>
                            <label className="block text-sm font-medium text-slate-400 mb-2 uppercase tracking-wider">
                                1. Select Location
                            </label>
                            <div className="relative">
                                <select 
                                    value={selectedShopId} 
                                    onChange={(e) => { setSelectedShopId(e.target.value); setSelectedDeviceId(''); }}
                                    className="w-full bg-slate-900 text-white pl-4 pr-10 py-3 rounded-xl border border-slate-600 focus:ring-2 focus:ring-blue-500 outline-none appearance-none transition-all hover:border-slate-500"
                                >
                                    <option value="">-- Choose Shop --</option>
                                    {availableShops.map(s => <option key={s.id} value={s.id}>{s.name}</option>)}
                                </select>
                                <div className="absolute inset-y-0 right-0 flex items-center px-4 pointer-events-none text-slate-400">
                                    <i className="fas fa-store"></i>
                                </div>
                            </div>
                            {userProfile.role !== 'Admin' && availableShops.length === 0 && (
                                <p className="text-xs text-red-400 mt-2">No shops assigned to your account.</p>
                            )}
                        </div>

                        {/* Device Selection */}
                        <div className={`transition-all duration-300 ${!selectedShopId ? 'opacity-50 grayscale pointer-events-none' : 'opacity-100'}`}>
                            <label className="block text-sm font-medium text-slate-400 mb-2 uppercase tracking-wider">
                                2. Select Available Terminal
                            </label>
                            <div className="relative">
                                <select 
                                    value={selectedDeviceId} 
                                    onChange={(e) => setSelectedDeviceId(e.target.value)}
                                    className="w-full bg-slate-900 text-white pl-4 pr-10 py-3 rounded-xl border border-slate-600 focus:ring-2 focus:ring-blue-500 outline-none appearance-none transition-all hover:border-slate-500"
                                    disabled={!selectedShopId}
                                >
                                    <option value="">-- Choose Device --</option>
                                    {availableDevices.map(d => (
                                        <option key={d.id} value={d.id}>
                                            {d.name} {d.isMine ? '(Resume)' : ''}
                                        </option>
                                    ))}
                                </select>
                                <div className="absolute inset-y-0 right-0 flex items-center px-4 pointer-events-none text-slate-400">
                                    <i className="fas fa-desktop"></i>
                                </div>
                            </div>
                            
                            {selectedShopId && availableDevices.length === 0 ? (
                                <p className="text-xs text-red-400 mt-2">
                                    <i className="fas fa-exclamation-circle mr-1"></i>
                                    All terminals in this shop are currently busy.
                                </p>
                            ) : (
                                <p className="text-xs text-slate-500 mt-2">
                                    Only showing available terminals.
                                </p>
                            )}
                        </div>

                        <button 
                            onClick={handleInitialize}
                            disabled={!selectedDeviceId || isSubmitting}
                            className="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-4 rounded-xl shadow-lg shadow-blue-600/30 transition-all transform active:scale-95 disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2"
                        >
                            {isSubmitting ? <div className="loader w-5 h-5 border-white/30 border-t-white"></div> : <i className="fas fa-check-circle"></i>}
                            {isSubmitting ? 'Initializing...' : 'Initialize Terminal'}
                        </button>
                    </div>
                </div>
            </div>
        );
    };

    // --- PHASE 1 & 2: POS Terminal Component ---
    const POSTerminal = ({ userProfile }) => {
        const { products, shops, customers, systemConfig, devices, currentDeviceId } = useData(); // <-- ADDED devices & currentDeviceId
        const [cart, setCart] = useState([]);
        const [searchTerm, setSearchTerm] = useState('');
        
        // --- NEW: Find current device object ---
        const currentDevice = useMemo(() => devices.find(d => d.id === currentDeviceId), [devices, currentDeviceId]);

        // Changed state name to be generic, logic switches to Vendor
        const [selectedTab, setSelectedTab] = useState('All'); 
        
        const [selectedShopId, setSelectedShopId] = useState('');
        const [selectedCustomerId, setSelectedCustomerId] = useState('');
        
        // --- NEW: Mobile Tab State ---
        const [activeMobileTab, setActiveMobileTab] = useState('products'); 
        // --- NEW: Mobile View Mode (Grid vs List) ---
        const [mobileViewMode, setMobileViewMode] = useState('grid');

        // --- NEW: Shift State ---
        const [currentShift, setCurrentShift] = useState(null);
        const [showShiftModal, setShowShiftModal] = useState(false);
        const [shiftLoading, setShiftLoading] = useState(false);

        // --- PERFORMANCE LIMIT ---
        const RENDER_LIMIT = 50; 

        // --- PHASE 2 STATE ---
        const [showPaymentModal, setShowPaymentModal] = useState(false);
        const [showReceiptModal, setShowReceiptModal] = useState(false);
        const [lastSaleData, setLastSaleData] = useState(null);
        const [isProcessing, setIsProcessing] = useState(false);

        // --- PHASE 3 STATE ---
        const [showSalesHistory, setShowSalesHistory] = useState(false);
        const [showDailyReport, setShowDailyReport] = useState(false);
        // --- NEW: Add Customer State ---
        const [showAddCustomerModal, setShowAddCustomerModal] = useState(false);
        
        // --- NEW: Hold/Recall State ---
        const [showHeldTicketsModal, setShowHeldTicketsModal] = useState(false);
        const [showSaveTicketModal, setShowSaveTicketModal] = useState(false); // <-- NEW

        // --- UX STATE ---
        const [highlightedIndex, setHighlightedIndex] = useState(0);
        const searchInputRef = useRef(null);

        // Setup initial shop (Enforce Device Shop if set)
        useEffect(() => {
            if (currentDevice && currentDevice.shopId) {
                // STRICT MODE: If this browser is a registered device, it MUST operate on its assigned shop
                setSelectedShopId(currentDevice.shopId);
            } else if (userProfile.assignedShops && userProfile.assignedShops.length > 0) {
                // Fallback for non-device browsers (e.g. admin laptop)
                setSelectedShopId(userProfile.assignedShops[0]);
            } else if (shops.length > 0) {
                setSelectedShopId(shops[0].id);
            }
        }, [userProfile, shops, currentDevice]);

        // Check user access to this device's shop
        const userHasAccess = useMemo(() => {
            if (!currentDevice) return true; // No device restriction
            if (userProfile.role === 'Admin') return true;
            return (userProfile.assignedShops || []).includes(currentDevice.shopId);
        }, [currentDevice, userProfile]);

        // --- NEW: Check for Open Shift (Scoped by DEVICE) ---
        useEffect(() => {
            if (!selectedShopId || !userProfile.uid || !currentDeviceId) return; // Added currentDeviceId check
            
            const unsubscribe = db.collection('shifts')
                .where('shopId', '==', selectedShopId)
                .where('cashierId', '==', userProfile.uid)
                .where('deviceId', '==', currentDeviceId) // <-- CRITICAL: Scope shift to specific Device
                .where('status', '==', 'open')
                .limit(1)
                .onSnapshot(snapshot => {
                    if (!snapshot.empty) {
                        setCurrentShift({ id: snapshot.docs[0].id, ...snapshot.docs[0].data() });
                    } else {
                        setCurrentShift(null);
                    }
                });
            return () => unsubscribe();
        }, [selectedShopId, userProfile.uid, currentDeviceId]);

        // Derive Tabs (Vendors) from Products
        const filterTabs = useMemo(() => {
            const uniqueVendors = new Set();
            if (products) {
                products.forEach(p => {
                    // Normalize: Trim whitespace, handle empty/null
                    const vName = p.vendorName ? p.vendorName.trim() : '';
                    if (vName && vName.toLowerCase() !== 'all') {
                        uniqueVendors.add(vName);
                    } else if (!vName) {
                        uniqueVendors.add('Uncategorized'); // Products with no vendor
                    }
                });
            }
            // Sort alphabetically
            const sortedVendors = Array.from(uniqueVendors).sort();
            
            // Ensure 'All' is always first
            return ['All', ...sortedVendors];
        }, [products]);

        // Filter Products for Grid
        const filteredProducts = useMemo(() => {
            if (!products) return [];
            let res = products;
            
            // 1. Filter by Vendor Tab
            if (selectedTab !== 'All') {
                res = res.filter(p => {
                    const vName = p.vendorName ? p.vendorName.trim() : '';
                    const effectiveVendor = vName || 'Uncategorized';
                    return effectiveVendor === selectedTab;
                });
            }

            // 2. Filter by Search
            if (searchTerm) {
                const lower = searchTerm.toLowerCase();
                res = res.filter(p => 
                    p.name.toLowerCase().includes(lower) || 
                    p.code.toLowerCase().includes(lower) || 
                    (p.barcode && p.barcode.includes(lower))
                );
            }
            return res;
        }, [products, selectedTab, searchTerm]);

        // Reset highlight when search changes
        useEffect(() => {
            setHighlightedIndex(0);
        }, [searchTerm, selectedTab]);

        // Cart Actions
        const addToCart = (product) => {
            if (!currentShift) {
                setShowShiftModal(true);
                return;
            }

            const existingItem = cart.find(item => item.productId === product.id);
            if (existingItem) {
                setCart(cart.map(item => item.productId === product.id ? { ...item, quantity: item.quantity + 1 } : item));
            } else {
                setCart([...cart, { 
                    productId: product.id, 
                    name: product.name, 
                    price: product.price, 
                    cost: product.cost, 
                    quantity: 1,
                    code: product.code 
                }]);
            }
        };

        const removeFromCart = (productId) => {
            setCart(cart.filter(item => item.productId !== productId));
        };

        const updateQty = (productId, delta) => {
            setCart(prev => prev.map(item => {
                if (item.productId === productId) {
                    const newQty = Math.max(1, item.quantity + delta);
                    return { ...item, quantity: newQty };
                }
                return item;
            }));
        };

        const cartTotal = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
        const cartTotalCost = cart.reduce((sum, item) => sum + (item.cost * item.quantity), 0);
        const cartItemCount = cart.reduce((sum, item) => sum + item.quantity, 0);

        // Get selected customer details for points display
        const selectedCustomerObj = useMemo(() => {
            return customers?.find(c => c.id === selectedCustomerId);
        }, [customers, selectedCustomerId]);

        // --- NEW: Calculate Estimated Points for UI ---
        const loyaltyRate = parseFloat(systemConfig?.loyaltyRate) || 0;
        const estimatedPoints = (selectedCustomerId && loyaltyRate > 0) ? Math.floor(cartTotal * (loyaltyRate / 100)) : 0;

        // --- NEW: Handle Save Ticket (Open Modal) ---
        const handleOpenSaveTicket = () => {
            if (cart.length === 0) {
                alert("Cart is empty. Nothing to save.");
                return;
            }
            if (!selectedShopId) return;
            setShowSaveTicketModal(true);
        };

        // --- NEW: Process Save Ticket (DB Write) ---
        const processSaveTicket = async (note) => {
            setIsProcessing(true);
            try {
                // If no specific note is provided, fallback to customer name or 'Walk-in'
                const referenceName = note || (selectedCustomerObj ? selectedCustomerObj.name : 'Walk-in Customer');
                
                await db.collection('heldTickets').add({
                    shopId: selectedShopId,
                    items: cart,
                    customerId: selectedCustomerId,
                    customerName: selectedCustomerObj ? selectedCustomerObj.name : 'Walk-in Customer',
                    referenceNote: referenceName, // <-- NEW FIELD
                    savedBy: userProfile.name,
                    savedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    totalAmount: cartTotal
                });

                // Clear current session
                setCart([]);
                setSelectedCustomerId('');
                setSearchTerm('');
                setShowSaveTicketModal(false);
            } catch (err) {
                console.error("Error saving ticket:", err);
                alert("Failed to save ticket.");
            } finally {
                setIsProcessing(false);
            }
        };

        // --- NEW: Handle Restore Ticket ---
        const handleRestoreTicket = (ticket) => {
            if (cart.length > 0) {
                if (!confirm("Current cart is not empty. Overwrite with saved ticket?")) {
                    return;
                }
            }
            setCart(ticket.items);
            setSelectedCustomerId(ticket.customerId || '');
            setShowHeldTicketsModal(false);
        };

        // --- NEW: Handle Scanner/Keyboard Input ---
        const handleSearchKeyDown = (e) => {
            // Block if no shift
            if (e.key === 'Enter' && !currentShift && searchTerm.trim()) {
                setShowShiftModal(true);
                return;
            }

            // Calculate effective limit for navigation
            const effectiveLimit = Math.min(filteredProducts.length, RENDER_LIMIT);

            if (e.key === 'ArrowDown') {
                e.preventDefault();
                // Clamp navigation to visible items only
                setHighlightedIndex(prev => Math.min(prev + 1, effectiveLimit - 1));
            } else if (e.key === 'ArrowUp') {
                e.preventDefault();
                setHighlightedIndex(prev => Math.max(prev - 1, 0));
            } else if (e.key === 'Enter') {
                e.preventDefault();
                const term = searchTerm.trim();
                
                if (term) {
                    // 1. SCANNER PRIORITY: Check for EXACT barcode/code match in GLOBAL products (ignore category tab)
                    const exactMatch = products.find(p => 
                        p.barcode === term || p.code.toLowerCase() === term.toLowerCase()
                    );

                    if (exactMatch) {
                        addToCart(exactMatch);
                        setSearchTerm('');
                        setHighlightedIndex(0);
                        return;
                    }
                }

                // 2. KEYBOARD SELECTION: If no exact scan match, add the currently highlighted item from the visible list
                if (filteredProducts.length > 0 && filteredProducts[highlightedIndex]) {
                    addToCart(filteredProducts[highlightedIndex]);
                    setSearchTerm(''); // Optional: clear search after selection
                    setHighlightedIndex(0);
                }
            }
        };

        // --- PHASE 2: Transaction Logic (Updated for Shifts) ---
        const handleProcessSale = async (paymentDetails) => {
            if (!selectedShopId || cart.length === 0) return;
            
            // Validation: Device must be set
            if (!currentDeviceId) {
                alert("Device not configured. Please go to Settings > General to select this terminal.");
                return;
            }

            if (!currentShift) {
                alert("Please open a shift first.");
                return;
            }
            setIsProcessing(true);

            try {
                const batch = db.batch();
                const saleRef = db.collection("sales").doc();
                const shop = shops.find(s => s.id === selectedShopId);
                const customer = customers.find(c => c.id === selectedCustomerId);
                // Use the memoized currentDevice instead of finding it again
                
                // Calculate Points Logic (Pre-computation)
                const rate = parseFloat(systemConfig?.loyaltyRate) || 0;
                const finalGrandTotal = cartTotal - (paymentDetails.discount || 0);
                const pointsEarned = (selectedCustomerId && rate > 0) ? Math.floor(finalGrandTotal * (rate / 100)) : 0;

                // 1. Prepare Sale Document
                const saleData = {
                    receiptNo: `REC-${Date.now().toString().slice(-6)}`,
                    shopId: selectedShopId,
                    shopName: shop?.name || 'Unknown',
                    cashierId: userProfile.uid,
                    cashierName: userProfile.name,
                    shiftId: currentShift.id,
                    deviceId: currentDeviceId, // <-- NEW: Track Device ID
                    deviceName: currentDevice?.name || 'Unknown Device', // <-- NEW: Track Device Name
                    customerId: selectedCustomerId || null,
                    customerName: customer?.name || 'Walk-in',
                    items: cart,
                    subtotal: cartTotal,
                    discount: paymentDetails.discount || 0,
                    tax: 0, 
                    grandTotal: finalGrandTotal,
                    totalCost: cartTotalCost, 
                    paymentMethod: paymentDetails.method, 
                    amountTendered: paymentDetails.tendered,
                    changeDue: paymentDetails.change,
                    pointsEarned: pointsEarned, 
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    createdAt: new Date().toISOString()
                };

                batch.set(saleRef, saleData);

                // 2. Inventory Deduction & Movement Logs
                cart.forEach(item => {
                    const productRef = db.collection("products").doc(item.productId);
                    
                    // Decrement Stock
                    batch.update(productRef, {
                        [`stockByShop.${selectedShopId}`]: firebase.firestore.FieldValue.increment(-item.quantity)
                    });

                    // Log Movement
                    const moveRef = db.collection("productMovement").doc();
                    batch.set(moveRef, {
                        productId: item.productId,
                        productCode: item.code,
                        productName: item.name,
                        type: 'Sale',
                        quantityChange: -item.quantity,
                        from: shop?.name,
                        to: 'Customer',
                        referenceNo: saleData.receiptNo,
                        timestamp: firebase.firestore.FieldValue.serverTimestamp()
                    });
                });

                // 3. Customer Points Update
                if (selectedCustomerId) {
                    const custRef = db.collection("customers").doc(selectedCustomerId);
                    // NEW: Update Visit Count and Total Spent
                    const updateData = {
                        visitCount: firebase.firestore.FieldValue.increment(1),
                        totalSpent: firebase.firestore.FieldValue.increment(saleData.grandTotal),
                        lastVisit: firebase.firestore.FieldValue.serverTimestamp()
                    };
                    
                    if (pointsEarned > 0) {
                        updateData.points = firebase.firestore.FieldValue.increment(pointsEarned);
                    }
                    
                    batch.update(custRef, updateData);
                }

                // 4. Update Shift Totals (Split Cash and KHQR)
                const shiftRef = db.collection("shifts").doc(currentShift.id);
                const isCash = paymentDetails.method === 'Cash';
                const isKHQR = paymentDetails.method === 'KHQR';

                batch.update(shiftRef, {
                    totalSales: firebase.firestore.FieldValue.increment(saleData.grandTotal),
                    transactionCount: firebase.firestore.FieldValue.increment(1),
                    totalCashSales: isCash ? firebase.firestore.FieldValue.increment(saleData.grandTotal) : firebase.firestore.FieldValue.increment(0),
                    totalKHQRSales: isKHQR ? firebase.firestore.FieldValue.increment(saleData.grandTotal) : firebase.firestore.FieldValue.increment(0)
                });

                await batch.commit();

                // 5. Success State
                setLastSaleData({ ...saleData, id: saleRef.id }); 
                setCart([]);
                setSearchTerm('');
                setSelectedCustomerId('');
                setShowPaymentModal(false);
                setShowReceiptModal(true);

            } catch (error) {
                console.error("Sale Error:", error);
                alert("Failed to process sale. Check console.");
            } finally {
                setIsProcessing(false);
                // Refocus search input after sale
                setTimeout(() => searchInputRef.current?.focus(), 100);
            } 
        };

        const handleNewCustomerSaved = (newCustomer) => {
            setShowAddCustomerModal(false);
            setSelectedCustomerId(newCustomer.id); 
        };

        // --- NEW: Render Setup Wizard if No Device Set ---
        if (!currentDeviceId) {
            return <DeviceSetup userProfile={userProfile} />;
        }

        // --- NEW: Access Denied if User cannot access Device Shop ---
        if (currentDevice && !userHasAccess) {
             return (
                <div className="flex items-center justify-center h-full">
                    <div className="bg-slate-800 p-8 rounded-xl border border-red-500/50 text-center max-w-lg shadow-2xl">
                        <i className="fas fa-ban text-5xl text-red-500 mb-4"></i>
                        <h2 className="text-2xl font-bold text-white mb-2">Access Denied</h2>
                        <p className="text-slate-400 mb-4">
                            This terminal <strong>{currentDevice.name}</strong> is strictly assigned to: <br/>
                            <span className="text-white font-bold text-lg mt-1 block">{shops.find(s => s.id === currentDevice.shopId)?.name || 'Unknown'}</span>
                        </p>
                        <p className="text-sm text-red-400 bg-red-900/20 p-2 rounded border border-red-500/30">
                            You do not have permission to access this shop.
                        </p>
                    </div>
                </div>
            );
        }

        return (
            <div className="flex flex-col h-[calc(100vh-90px)] md:h-[calc(100vh-100px)]">
                {/* Modals */}
                {showPaymentModal && (
                    <PaymentModal 
                        total={cartTotal} 
                        onConfirm={handleProcessSale} 
                        onCancel={() => setShowPaymentModal(false)}
                        isProcessing={isProcessing}
                    />
                )}
                {showReceiptModal && lastSaleData && (
                    <ReceiptModal 
                        saleData={lastSaleData} 
                        onClose={() => setShowReceiptModal(false)} 
                    />
                )}
                
                {/* PHASE 3 MODALS */}
                {showSalesHistory && (
                    <SalesHistoryModal 
                        shopId={selectedShopId} 
                        onClose={() => setShowSalesHistory(false)}
                        onReprint={(sale) => { setLastSaleData(sale); setShowReceiptModal(true); }}
                        userProfile={userProfile}
                    />
                )}
                {showDailyReport && (
                    <DailyReportModal 
                        shopId={selectedShopId} 
                        onClose={() => setShowDailyReport(false)} 
                    />
                )}
                {/* SHIFT MODAL - Pass deviceId */}
                {showShiftModal && (
                    <ShiftManagementModal 
                        currentShift={currentShift} 
                        shopId={selectedShopId}
                        userProfile={userProfile}
                        onClose={() => setShowShiftModal(false)}
                        deviceId={currentDeviceId} // <-- PASS DEVICE ID HERE
                    />
                )}

                {/* NEW: Add Customer Modal (Inline) */}
                {showAddCustomerModal && (
                    <AddCustomerModal 
                        onClose={() => setShowAddCustomerModal(false)} 
                        onSave={handleNewCustomerSaved}
                        shops={shops} // Pass shops
                        defaultShopId={selectedShopId} // Pass current shop
                    />
                )}

                {/* NEW: Save Ticket Modal */}
                {showSaveTicketModal && (
                    <SaveTicketModal
                        onConfirm={processSaveTicket}
                        onCancel={() => setShowSaveTicketModal(false)}
                    />
                )}

                {/* NEW: Held Tickets Modal */}
                {showHeldTicketsModal && (
                    <HeldTicketsModal 
                        shopId={selectedShopId}
                        onClose={() => setShowHeldTicketsModal(false)}
                        onRestore={handleRestoreTicket}
                    />
                )}

                {/* MAIN CONTENT AREA */}
                <div className="flex-1 flex gap-4 overflow-hidden relative">
                    
                    {/* LEFT: Product Grid (Visible on Desktop OR when Mobile Tab is 'products') */}
                    <div className={`flex-1 flex flex-col bg-slate-800 rounded-lg border border-slate-700 overflow-hidden ${activeMobileTab === 'products' ? 'flex' : 'hidden md:flex'}`}>
                        {/* Top Bar: Search & Shop */}
                        <div className="p-3 md:p-4 bg-slate-900/50 border-b border-slate-700 flex flex-col md:flex-row gap-3 md:gap-4 justify-between">
                            <div className="flex gap-2 md:gap-4 flex-1">
                                <div className="flex-1 relative">
                                    <input 
                                        ref={searchInputRef}
                                        type="text" 
                                        placeholder="Search or Scan..." 
                                        value={searchTerm}
                                        onChange={(e) => setSearchTerm(e.target.value)}
                                        onKeyDown={handleSearchKeyDown}
                                        className="w-full bg-slate-700 text-white pl-9 pr-4 py-2 md:py-3 rounded-lg border border-slate-600 focus:ring-2 focus:ring-blue-500 outline-none text-sm md:text-base"
                                        autoFocus
                                    />
                                    <i className="fas fa-search absolute left-3 top-3 md:top-4 text-slate-400"></i>
                                </div>
                                {/* LOCKED SHOP SELECTOR */}
                                <div className="relative">
                                    <select 
                                        value={selectedShopId} 
                                        onChange={(e) => setSelectedShopId(e.target.value)}
                                        disabled={!!currentDevice} // STRICT LOCK
                                        className={`bg-slate-700 text-white px-2 md:px-4 py-2 rounded-lg border border-slate-600 text-sm md:text-base max-w-[120px] md:max-w-none appearance-none ${!!currentDevice ? 'opacity-75 cursor-not-allowed pr-8' : 'cursor-pointer'}`}
                                    >
                                        {shops.filter(s => (userProfile.assignedShops || []).includes(s.id) || userProfile.role === 'Admin').map(s => (
                                            <option key={s.id} value={s.id}>{s.name}</option>
                                        ))}
                                    </select>
                                    {currentDevice && <i className="fas fa-lock absolute right-2 top-3 text-slate-400 text-xs pointer-events-none"></i>}
                                </div>
                            </div>
                            
                            {/* PHASE 3: Action Buttons */}
                            <div className="flex gap-2 justify-end">
                                <button onClick={() => setShowShiftModal(true)} className={`px-3 py-2 ${currentShift ? 'bg-green-600 hover:bg-green-700 text-white' : 'bg-red-600 hover:bg-red-700 text-white'} rounded-lg border border-transparent`} title="Shift Management">
                                    <i className="fas fa-clock mr-1"></i> {currentShift ? 'Shift Open' : 'Open Shift'}
                                </button>
                                <button onClick={() => setShowSalesHistory(true)} className="px-3 py-2 bg-slate-700 text-slate-300 rounded-lg hover:bg-slate-600 border border-slate-600" title="Recent Transactions">
                                    <i className="fas fa-history"></i>
                                </button>
                                <button onClick={() => setShowDailyReport(true)} className="px-3 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700" title="End of Day Report">
                                    <i className="fas fa-chart-pie"></i>
                                </button>
                            </div>
                        </div>

                        {/* Vendor Drop List (Replaces Tabs) */}
                        <div className="p-3 bg-slate-800 border-b border-slate-700 flex items-center gap-3">
                            <label className="hidden sm:block text-sm font-medium text-slate-400 whitespace-nowrap">
                                <i className="fas fa-filter mr-1"></i> Vendor Filter:
                            </label>
                            <div className="relative flex-1 max-w-sm">
                                <select 
                                    value={selectedTab} 
                                    onChange={(e) => setSelectedTab(e.target.value)} 
                                    className="w-full bg-slate-700 text-white pl-4 pr-10 py-2 rounded-lg border border-slate-600 focus:ring-2 focus:ring-blue-500 appearance-none outline-none font-medium text-sm transition-shadow cursor-pointer hover:bg-slate-600"
                                >
                                    {filterTabs.map(tabName => (
                                        <option key={tabName} value={tabName}>{tabName}</option>
                                    ))}
                                </select>
                                <div className="absolute inset-y-0 right-0 flex items-center px-3 pointer-events-none text-slate-400">
                                    <i className="fas fa-chevron-down text-xs"></i>
                                </div>
                            </div>

                            {/* Mobile View Toggle */}
                            <div className="md:hidden flex bg-slate-900 rounded-lg p-0.5 border border-slate-600 shrink-0">
                                <button 
                                    onClick={() => setMobileViewMode('grid')}
                                    className={`p-2 rounded-md transition-all ${mobileViewMode === 'grid' ? 'bg-blue-600 text-white shadow-sm' : 'text-slate-400 hover:text-slate-200'}`}
                                    title="Grid View"
                                >
                                    <i className="fas fa-th-large"></i>
                                </button>
                                <button 
                                    onClick={() => setMobileViewMode('list')}
                                    className={`p-2 rounded-md transition-all ${mobileViewMode === 'list' ? 'bg-blue-600 text-white shadow-sm' : 'text-slate-400 hover:text-slate-200'}`}
                                    title="List View"
                                >
                                    <i className="fas fa-list"></i>
                                </button>
                            </div>
                        </div>

                        {/* Product List (Transaction Style) */}
                        <div className="flex-1 overflow-y-auto bg-slate-800 relative scroll-smooth">
                            
                            {/* DESKTOP TABLE VIEW (Hidden on Mobile) */}
                            <div className="hidden md:block">
                                <table className="w-full text-left border-collapse">
                                    <thead className="bg-slate-900/90 text-xs md:text-sm uppercase text-slate-400 font-semibold sticky top-0 z-10 backdrop-blur-sm shadow-sm">
                                        <tr>
                                            <th className="p-3 pl-4 font-bold border-b border-slate-700">Product Info</th>
                                            <th className="p-3 border-b border-slate-700 text-center">Stock</th>
                                            <th className="p-3 border-b border-slate-700 text-right">Price</th>
                                            <th className="p-3 border-b border-slate-700 w-10"></th>
                                        </tr>
                                    </thead>
                                    <tbody className="divide-y divide-slate-700/50">
                                        {filteredProducts.slice(0, RENDER_LIMIT).map((product, index) => {
                                            const stock = product.stockByShop?.[selectedShopId] || 0;
                                            const isHighlighted = index === highlightedIndex;
                                            
                                            return (
                                                <tr 
                                                    key={product.id} 
                                                    onClick={() => addToCart(product)}
                                                    className={`group transition-all duration-150 cursor-pointer 
                                                        ${isHighlighted ? 'bg-blue-600/20 border-l-4 border-l-blue-500' : 'hover:bg-slate-700/60 border-l-4 border-l-transparent'}
                                                    `}
                                                >
                                                    <td className="p-3 pl-4">
                                                        <div className={`font-bold text-sm md:text-base mb-1 ${isHighlighted ? 'text-white' : 'text-slate-200'}`}>{product.name}</div>
                                                        <div className="flex items-center gap-2 text-[10px] md:text-xs text-slate-500">
                                                            <span className="bg-slate-700/50 px-2 py-0.5 rounded border border-slate-600">{product.code}</span>
                                                            {product.barcode && <span className="opacity-70"><i className="fas fa-barcode mr-1"></i>{product.barcode}</span>}
                                                        </div>
                                                    </td>
                                                    <td className="p-3 text-center">
                                                        <span className={`inline-block min-w-[2rem] text-xs md:text-sm font-bold px-2 py-1 rounded ${stock > 0 ? 'bg-slate-700 text-blue-300' : 'bg-red-900/20 text-red-500 border border-red-900/30'}`}>
                                                            {stock}
                                                        </span>
                                                    </td>
                                                    <td className="p-3 text-right">
                                                        <div className={`font-bold text-sm md:text-lg ${isHighlighted ? 'text-emerald-300' : 'text-emerald-400 group-hover:text-emerald-300'}`}>{new Intl.NumberFormat('en-US').format(product.price)}</div>
                                                    </td>
                                                    <td className="p-3 pr-4 text-right">
                                                        <button className={`w-8 h-8 md:w-10 md:h-10 rounded-full flex items-center justify-center transition-all shadow-sm ${isHighlighted ? 'bg-blue-500 text-white' : 'bg-slate-700/50 text-slate-400 group-hover:bg-blue-500 group-hover:text-white'}`}>
                                                            <i className="fas fa-plus text-xs md:text-sm"></i>
                                                        </button>
                                                    </td>
                                                </tr>
                                            );
                                        })}
                                        {filteredProducts.length > RENDER_LIMIT && (
                                            <tr>
                                                <td colSpan="4" className="p-6 text-center text-slate-500 italic border-t border-slate-700/50">
                                                    <i className="fas fa-search mr-2"></i>
                                                    Showing top {RENDER_LIMIT} of {filteredProducts.length} items. Keep typing to search...
                                                </td>
                                            </tr>
                                        )}
                                    </tbody>
                                </table>
                            </div>

                            {/* MOBILE VIEW (Grid or List based on preference) */}
                            <div className={`md:hidden p-2 pb-24 ${mobileViewMode === 'grid' ? 'grid grid-cols-2 gap-2' : 'flex flex-col gap-2'}`}>
                                {filteredProducts.slice(0, RENDER_LIMIT).map((product) => {
                                    const stock = product.stockByShop?.[selectedShopId] || 0;
                                    
                                    if (mobileViewMode === 'list') {
                                        return (
                                            <div 
                                                key={product.id} 
                                                onClick={() => addToCart(product)} 
                                                className="bg-slate-700/40 p-3 rounded-lg border border-slate-600/50 active:bg-slate-700 transition-all shadow-sm flex justify-between items-center"
                                            >
                                                <div className="flex-1 min-w-0 pr-3">
                                                    <div className="text-slate-100 font-bold text-sm truncate mb-0.5">{product.name}</div>
                                                    <div className="flex items-center gap-2 text-xs">
                                                        <span className="text-slate-400 bg-slate-800/50 px-1.5 py-0.5 rounded">{product.code}</span>
                                                        <span className={`${stock > 0 ? 'text-blue-300' : 'text-red-400'} font-medium`}>Stock: {stock}</span>
                                                    </div>
                                                </div>
                                                <div className="text-right shrink-0">
                                                    <div className="text-emerald-400 font-bold text-base">{new Intl.NumberFormat('en-US', { notation: "compact" }).format(product.price)}</div>
                                                    <div className="w-6 h-6 rounded-full bg-blue-600/90 flex items-center justify-center text-white shadow-lg ml-auto mt-1">
                                                        <i className="fas fa-plus text-[10px]"></i>
                                                    </div>
                                                </div>
                                            </div>
                                        );
                                    }

                                    return (
                                        <div 
                                            key={product.id} 
                                            onClick={() => addToCart(product)} 
                                            className="bg-slate-700/40 p-3 rounded-xl border border-slate-600/50 active:scale-95 active:bg-slate-700 transition-all shadow-sm relative overflow-hidden flex flex-col justify-between h-32"
                                        >
                                            {/* Top Row: Stock & Code */}
                                            <div className="flex justify-between items-start mb-1">
                                                <span className="text-[10px] text-slate-400 bg-slate-800/50 px-1.5 py-0.5 rounded">{product.code}</span>
                                                <span className={`text-[10px] font-bold px-1.5 py-0.5 rounded ${stock > 0 ? 'bg-slate-800 text-blue-300' : 'bg-red-900/50 text-red-300'}`}>
                                                    {stock}
                                                </span>
                                            </div>
                                            
                                            {/* Middle: Name */}
                                            <h4 className="text-slate-100 font-bold text-sm line-clamp-2 leading-snug mb-auto pt-1">{product.name}</h4>
                                            
                                            {/* Bottom: Price & Add Icon */}
                                            <div className="flex items-end justify-between mt-2">
                                                <div className="text-emerald-400 font-bold text-base">{new Intl.NumberFormat('en-US', { notation: "compact" }).format(product.price)}</div>
                                                <div className="w-8 h-8 rounded-full bg-blue-600/90 flex items-center justify-center text-white shadow-lg">
                                                    <i className="fas fa-plus text-xs"></i>
                                                </div>
                                            </div>
                                        </div>
                                    );
                                })}
                                {filteredProducts.length > RENDER_LIMIT && (
                                    <div className={`${mobileViewMode === 'grid' ? 'col-span-2' : ''} text-center py-4 text-slate-500 text-xs italic`}>
                                        End of list. Use search for more.
                                    </div>
                                )}
                            </div>

                            {filteredProducts.length === 0 && (
                                <div className="flex flex-col items-center justify-center h-48 text-slate-500">
                                    <div className="bg-slate-800/50 p-4 rounded-full mb-3">
                                        <i className="fas fa-search text-2xl opacity-50"></i>
                                    </div>
                                    <p>No products found.</p>
                                </div>
                            )}
                        </div>
                    </div>

                    {/* RIGHT: Cart / Ticket (Visible on Desktop OR when Mobile Tab is 'cart') */}
                    <div className={`w-full md:w-96 bg-white flex-col rounded-lg shadow-xl overflow-hidden ${activeMobileTab === 'cart' ? 'flex' : 'hidden md:flex'}`}>
                        {/* Customer Header */}
                        <div className="p-3 bg-slate-100 border-b border-slate-200">
                            <div className="flex justify-between items-center mb-1">
                                <div className="flex items-center text-slate-700 flex-1">
                                    <i className="fas fa-user-circle text-2xl mr-2 text-blue-500"></i>
                                    <select 
                                        value={selectedCustomerId}
                                        onChange={(e) => setSelectedCustomerId(e.target.value)}
                                        className="bg-transparent font-semibold outline-none w-full max-w-[140px] cursor-pointer"
                                    >
                                        <option value="">Walk-in Customer</option>
                                        {customers && customers.map(c => <option key={c.id} value={c.id}>{c.name}</option>)}
                                    </select>
                                </div>
                                <div className="flex gap-1">
                                    <button 
                                        onClick={() => setShowHeldTicketsModal(true)} 
                                        className="text-orange-500 hover:bg-orange-100 p-2 rounded-full transition shadow-sm border border-orange-200 bg-white"
                                        title="Recall Saved Bill"
                                    >
                                        <i className="fas fa-folder-open"></i>
                                    </button>
                                    <button 
                                        onClick={() => setShowAddCustomerModal(true)} 
                                        className="text-blue-600 hover:bg-blue-100 p-2 rounded-full transition shadow-sm border border-blue-200 bg-white"
                                        title="Add New Customer"
                                    >
                                        <i className="fas fa-user-plus"></i>
                                    </button>
                                </div>
                            </div>
                            {selectedCustomerObj && (
                                <div className="flex justify-between items-center text-xs px-1">
                                    <span className="text-slate-500">{selectedCustomerObj.phone || 'No Phone'}</span>
                                    <span className="font-bold text-orange-500 bg-orange-100 px-2 py-0.5 rounded-full border border-orange-200">
                                        <i className="fas fa-star mr-1"></i> {selectedCustomerObj.points || 0} pts
                                    </span>
                                </div>
                            )}
                        </div>

                        {/* Cart Items */}
                        <div className="flex-1 overflow-y-auto p-2 space-y-2 bg-slate-50">
                            {cart.length === 0 ? (
                                <div className="h-full flex flex-col items-center justify-center text-slate-400">
                                    <i className="fas fa-shopping-basket text-4xl mb-2 opacity-50"></i>
                                    <p>Basket is empty</p>
                                </div>
                            ) : (
                                cart.map(item => (
                                    <div key={item.productId} className="bg-white p-3 rounded-lg shadow-sm border border-slate-200 flex justify-between items-center touch-manipulation">
                                        <div className="flex-1 min-w-0 pr-2">
                                            <h5 className="font-bold text-slate-800 truncate text-sm">{item.name}</h5>
                                            <p className="text-xs text-slate-500">@{new Intl.NumberFormat('en-US').format(item.price)}</p>
                                        </div>
                                        <div className="flex items-center gap-2">
                                            <div className="flex items-center bg-slate-100 rounded-lg border border-slate-200 overflow-hidden">
                                                <button onClick={() => updateQty(item.productId, -1)} className="w-9 h-9 flex items-center justify-center text-slate-600 hover:text-red-500 active:bg-slate-200 transition font-bold text-lg">-</button>
                                                <span className="text-sm font-bold text-slate-800 w-8 text-center">{item.quantity}</span>
                                                <button onClick={() => updateQty(item.productId, 1)} className="w-9 h-9 flex items-center justify-center text-slate-600 hover:text-green-500 active:bg-slate-200 transition font-bold text-lg">+</button>
                                            </div>
                                            <div className="text-right min-w-[60px]">
                                                <div className="font-bold text-slate-800 text-sm">{new Intl.NumberFormat('en-US', { notation: "compact" }).format(item.price * item.quantity)}</div>
                                                <button onClick={() => removeFromCart(item.productId)} className="text-[10px] text-red-400 hover:text-red-600 p-1">Remove</button>
                                            </div>
                                        </div>
                                    </div>
                                ))
                            )}
                        </div>

                        {/* Footer / Totals */}
                        <div className="bg-white p-4 border-t border-slate-200 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.1)]">
                            {/* Points Preview */}
                            {selectedCustomerId && estimatedPoints > 0 && (
                                <div className="flex justify-between mb-3 text-xs bg-orange-50 p-2 rounded border border-orange-100 text-orange-600 font-bold">
                                    <span className="flex items-center"><i className="fas fa-star mr-1"></i> Points to Earn</span>
                                    <span>+{estimatedPoints}</span>
                                </div>
                            )}
                            <div className="flex justify-between mb-2 text-slate-600">
                                <span>Subtotal</span>
                                <span>{new Intl.NumberFormat('en-US').format(cartTotal)}</span>
                            </div>
                            <div className="flex justify-between mb-4 text-xl font-bold text-slate-900">
                                <span>Total</span>
                                <span>{new Intl.NumberFormat('en-US').format(cartTotal)}</span>
                            </div>
                            
                            <div className="grid grid-cols-3 gap-2">
                                <button 
                                    onClick={() => setCart([])}
                                    disabled={cart.length === 0}
                                    className="py-3 px-2 rounded-lg font-bold text-slate-600 bg-slate-200 hover:bg-slate-300 transition disabled:opacity-50 text-sm"
                                >
                                    Cancel
                                </button>
                                <button 
                                    onClick={handleOpenSaveTicket}
                                    disabled={cart.length === 0}
                                    className="py-3 px-2 rounded-lg font-bold text-white bg-orange-500 hover:bg-orange-600 transition disabled:bg-slate-300 disabled:cursor-not-allowed shadow-lg shadow-orange-500/30 text-sm"
                                    title="Save/Hold Bill"
                                >
                                    <i className="fas fa-save mr-1"></i> Save Bill
                                </button>
                                <button 
                                    onClick={() => setShowPaymentModal(true)}
                                    disabled={cart.length === 0}
                                    className="py-3 px-2 rounded-lg font-bold text-white bg-blue-600 hover:bg-blue-700 transition disabled:bg-slate-400 disabled:cursor-not-allowed shadow-lg shadow-blue-500/30 text-sm"
                                >
                                    Pay
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                {/* MOBILE BOTTOM NAVIGATION */}
                <div className="md:hidden mt-2 grid grid-cols-2 gap-2 shrink-0">
                    <button
                        onClick={() => setActiveMobileTab('products')}
                        className={`py-3 rounded-lg font-bold flex items-center justify-center gap-2 transition-all ${activeMobileTab === 'products' ? 'bg-slate-700 text-white border border-slate-600' : 'bg-slate-800 text-slate-400 border border-transparent'}`}
                    >
                        <i className="fas fa-boxes"></i> Products
                    </button>
                    <button
                        onClick={() => setActiveMobileTab('cart')}
                        className={`py-3 rounded-lg font-bold flex items-center justify-center gap-2 transition-all relative ${activeMobileTab === 'cart' ? 'bg-blue-600 text-white' : 'bg-slate-800 text-slate-400'}`}
                    >
                        <i className="fas fa-shopping-cart"></i> 
                        <span>Cart</span>
                        {cartTotal > 0 && <span className="text-xs bg-white/20 px-2 py-0.5 rounded ml-1">{new Intl.NumberFormat('en-US', { notation: "compact" }).format(cartTotal)}</span>}
                        {cartItemCount > 0 && (
                            <span className="absolute -top-1 -right-1 bg-red-500 text-white text-[10px] w-5 h-5 flex items-center justify-center rounded-full border-2 border-slate-900">
                                {cartItemCount}
                            </span>
                        )}
                    </button>
                </div>
            </div>
        );
    };

    // --- NEW: Save Ticket Modal ---
    const SaveTicketModal = ({ onConfirm, onCancel }) => {
        const [note, setNote] = useState('');
        
        return (
            <Modal show={true} onClose={onCancel} maxWidth="max-w-sm">
                <ModalHeader title="Save Bill (Hold)" onClose={onCancel} />
                <ModalBody>
                    <div className="space-y-4">
                        <p className="text-slate-400 text-sm">
                            Enter a reference name to easily identify this bill later (e.g., Customer Name, Table Number, or Description).
                        </p>
                        <div>
                            <label className="block text-sm font-medium text-slate-300 mb-1">Reference / Note</label>
                            <input 
                                type="text" 
                                value={note} 
                                onChange={e => setNote(e.target.value)} 
                                className="w-full bg-slate-700 text-white px-4 py-2 rounded border border-slate-600 focus:border-orange-500 outline-none" 
                                placeholder="e.g. Blue Shirt Lady"
                                autoFocus
                            />
                        </div>
                    </div>
                </ModalBody>
                <ModalFooter>
                    <button onClick={onCancel} className="bg-slate-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-slate-500 mr-2">Cancel</button>
                    <button 
                        onClick={() => onConfirm(note)} 
                        className="bg-orange-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-orange-700 flex items-center gap-2"
                    >
                        <i className="fas fa-save"></i> Save & Clear
                    </button>
                </ModalFooter>
            </Modal>
        );
    };

    // --- NEW: Held Tickets Modal ---
    const HeldTicketsModal = ({ shopId, onClose, onRestore }) => {
        const [tickets, setTickets] = useState([]);
        const [loading, setLoading] = useState(true);
        const [deleteId, setDeleteId] = useState(null); // New state for custom confirmation

        useEffect(() => {
            // Client-side sorting maintained to prevent index errors
            const unsubscribe = db.collection('heldTickets')
                .where('shopId', '==', shopId)
                .onSnapshot(snapshot => {
                    const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    
                    data.sort((a, b) => {
                        const dateA = safeToDate(a.savedAt) || new Date(0);
                        const dateB = safeToDate(b.savedAt) || new Date(0);
                        return dateB - dateA;
                    });

                    setTickets(data);
                    setLoading(false);
                }, err => {
                    console.error("Error fetching held tickets:", err);
                    setLoading(false);
                });
            return () => unsubscribe();
        }, [shopId]);

        const requestDelete = (id) => {
            setDeleteId(id); // Trigger custom modal instead of window.confirm
        };

        const confirmDelete = async () => {
            if (!deleteId) return;
            try {
                await db.collection('heldTickets').doc(deleteId).delete();
                setDeleteId(null);
            } catch (err) {
                console.error("Delete error:", err);
                alert("Failed to delete.");
            }
        };

        const handleRestore = async (ticket) => {
            onRestore(ticket);
            try {
                await db.collection('heldTickets').doc(ticket.id).delete();
            } catch (err) {
                console.error("Error clearing held ticket after restore:", err);
            }
        };

        return (
            <Modal show={true} onClose={onClose} maxWidth="max-w-2xl">
                {/* Custom Confirmation Overlay */}
                {deleteId && (
                    <div className="fixed inset-0 z-[60] flex items-center justify-center p-4 bg-black bg-opacity-70 backdrop-blur-sm">
                        <div className="bg-slate-800 rounded-lg border border-slate-600 shadow-2xl max-w-sm w-full p-6 animate-fade-in-up">
                            <h3 className="text-xl font-bold text-white mb-2">Discard Bill?</h3>
                            <p className="text-slate-300 mb-6">Are you sure you want to permanently discard this saved bill? This cannot be undone.</p>
                            <div className="flex justify-end gap-3">
                                <button 
                                    onClick={() => setDeleteId(null)} 
                                    className="px-4 py-2 bg-slate-700 text-slate-200 hover:text-white rounded font-bold hover:bg-slate-600 transition"
                                >
                                    Cancel
                                </button>
                                <button 
                                    onClick={confirmDelete} 
                                    className="px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded font-bold shadow-lg shadow-red-900/20 transition"
                                >
                                    Discard
                                </button>
                            </div>
                        </div>
                    </div>
                )}

                <ModalHeader title="Recall Saved Bill" onClose={onClose} />
                <ModalBody>
                    {loading ? (
                        <div className="flex justify-center p-8"><div className="loader"></div></div>
                    ) : tickets.length === 0 ? (
                        <div className="text-center p-8 text-slate-400">
                            <i className="fas fa-folder-open text-4xl mb-3 opacity-50"></i>
                            <p>No saved bills found.</p>
                        </div>
                    ) : (
                        <div className="space-y-3">
                            {tickets.map(ticket => (
                                <div key={ticket.id} className="bg-slate-700/50 p-4 rounded-lg border border-slate-600 flex justify-between items-center hover:bg-slate-700 transition">
                                    <div>
                                        <div className="flex items-center gap-3 mb-1">
                                            {/* Display the Reference Note prominently */}
                                            <span className="font-bold text-lg text-orange-400">
                                                {ticket.referenceNote || ticket.customerName || 'Saved Bill'}
                                            </span>
                                            {ticket.customerName && ticket.customerName !== 'Walk-in Customer' && (
                                                <span className="text-xs bg-slate-600 text-slate-300 px-2 py-0.5 rounded-full">
                                                    <i className="fas fa-user mr-1"></i> {ticket.customerName}
                                                </span>
                                            )}
                                        </div>
                                        <p className="text-sm text-slate-400">
                                            {ticket.items.length} items  Total: <span className="text-white font-bold">{new Intl.NumberFormat('en-US').format(ticket.totalAmount)}</span>
                                        </p>
                                        <p className="text-xs text-slate-500 mt-1">
                                            Saved: {ticket.savedAt ? safeToDate(ticket.savedAt).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : 'N/A'} by {ticket.savedBy}
                                        </p>
                                    </div>
                                    <div className="flex gap-2">
                                        <button 
                                            onClick={() => requestDelete(ticket.id)}
                                            className="p-2 bg-red-900/30 text-red-400 rounded hover:bg-red-900/50 transition border border-red-900/50"
                                            title="Discard"
                                        >
                                            <i className="fas fa-trash"></i>
                                        </button>
                                        <button 
                                            onClick={() => handleRestore(ticket)}
                                            className="px-4 py-2 bg-blue-600 text-white font-bold rounded hover:bg-blue-700 transition shadow-lg shadow-blue-500/20"
                                        >
                                            <i className="fas fa-reply mr-2"></i> Restore
                                        </button>
                                    </div>
                                </div>
                            ))}
                        </div>
                    )}
                </ModalBody>
                <ModalFooter>
                    <button onClick={onClose} className="bg-slate-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-slate-500">Close</button>
                </ModalFooter>
            </Modal>
        );
    };

    // --- NEW: Shift Management Modal ---
    const ShiftManagementModal = ({ currentShift, shopId, userProfile, onClose, deviceId }) => { // <-- Accept deviceId
        const { shops, devices } = useData(); // <-- Get devices
        // Open Shift State
        const [startCash, setStartCash] = useState('');
        
        // Close Shift / Cash Drop State
        const [actualCashKHR, setActualCashKHR] = useState('');
        const [actualCashUSD, setActualCashUSD] = useState('');
        const [actualBankKHR, setActualBankKHR] = useState('');
        const [actualBankUSD, setActualBankUSD] = useState('');
        const [exchangeRate, setExchangeRate] = useState('4000');
        const [note, setNote] = useState('');
        
        const [loading, setLoading] = useState(false);
        const [error, setError] = useState('');
        
        // FIX: Add state to track if we are currently opening a shift to prevent UI flash
        const [isOpening, setIsOpening] = useState(false);

        // --- NEW: Bill Counter State ---
        const [showBillCounter, setShowBillCounter] = useState(null); // 'KHR' or 'USD' or null

        const actualCashInputRef = useRef(null);
        const actualKHQRInputRef = useRef(null);

        // Helper to format input as KHR currency (1,234,567)
        const formatNumber = (value) => {
            if (!value && value !== 0) return '';
            const raw = String(value).replace(/[^0-9.]/g, '');
            if (!raw) return '';
            const parts = raw.split('.');
            parts[0] = parseInt(parts[0], 10).toLocaleString('en-US');
            return parts.join('.');
        };

        const parseNumber = (value) => {
            if (!value) return 0;
            return parseFloat(String(value).replace(/,/g, ''));
        };

        // Handlers for Inputs
        const handleCurrencyInput = (setter) => (e) => {
            const val = e.target.value.replace(/[^0-9.]/g, '');
            setter(val);
        };

        // --- NEW: Apply Bill Counter Total ---
        const handleApplyBillCount = (total) => {
            if (showBillCounter === 'KHR') {
                setActualCashKHR(formatNumber(total));
            } else if (showBillCounter === 'USD') {
                setActualCashUSD(formatNumber(total));
            }
            setShowBillCounter(null);
        };

        const handleOpenShift = async () => {
            if (!startCash && startCash !== '0') { 
                setError("Please enter starting cash (enter 0 if empty)."); 
                return; 
            }
            
            setIsOpening(true);
            setLoading(true); 
            setError('');
            
            const currentDevice = devices.find(d => d.id === deviceId); // Find name

            try {
                await db.collection('shifts').add({
                    shopId, 
                    cashierId: userProfile.uid, 
                    cashierName: userProfile.name || 'Staff', 
                    deviceId: deviceId, // <-- NEW: Linked to device
                    deviceName: currentDevice?.name || 'Unknown Device', // <-- NEW
                    startTime: firebase.firestore.FieldValue.serverTimestamp(),
                    startCash: parseNumber(startCash), totalSales: 0, totalCashSales: 0, totalKHQRSales: 0, transactionCount: 0, status: 'open', createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                onClose();
            } catch (err) { 
                setError("Failed to open shift: " + err.message); 
                setIsOpening(false); 
                setLoading(false);
            }
        };

        const handleCloseShift = async () => {
            setError('');
            setLoading(true);
            try {
                // 1. Parse Inputs
                const cashKHR = parseNumber(actualCashKHR);
                const cashUSD = parseNumber(actualCashUSD);
                const bankKHR = parseNumber(actualBankKHR);
                const bankUSD = parseNumber(actualBankUSD);
                const rate = parseNumber(exchangeRate) || 4000;

                // 2. Calculate Total Actuals in KHR
                const totalActualCash = cashKHR + (cashUSD * rate);
                const totalActualBank = bankKHR + (bankUSD * rate);
                const totalActual = totalActualCash + totalActualBank;

                // 3. Get Expected Values (System)
                const startCashVal = parseFloat(currentShift.startCash) || 0;
                const sysCashSales = parseFloat(currentShift.totalCashSales) || 0;
                const sysBankSales = parseFloat(currentShift.totalKHQRSales) || 0; 
                
                const expectedCash = startCashVal + sysCashSales;
                const expectedBank = sysBankSales;
                
                // 4. Calculate Variances
                const diffCash = totalActualCash - expectedCash;
                const diffBank = totalActualBank - expectedBank;
                const totalDiff = diffCash + diffBank;

                await db.collection('shifts').doc(currentShift.id).update({
                    endTime: firebase.firestore.FieldValue.serverTimestamp(),
                    
                    // Detailed Inputs (Save Raw)
                    closeInputCashKHR: cashKHR, closeInputCashUSD: cashUSD,
                    closeInputBankKHR: bankKHR, closeInputBankUSD: bankUSD,
                    closeExchangeRate: rate,
                    closeNote: note,

                    // Summary Logic (Save Calculated)
                    actualCash: totalActualCash,
                    expectedCash: expectedCash,
                    differenceCash: diffCash,
                    
                    actualKHQR: totalActualBank,
                    expectedKHQR: expectedBank,
                    differenceKHQR: diffBank,

                    difference: totalDiff,
                    status: 'closed',
                    closedBy: userProfile?.name || 'Staff'
                });
                onClose();
            } catch (err) { console.error("Close Shift Error:", err); setError("System Error: " + err.message); } finally { setLoading(false); }
        };

        // --- REAL-TIME CALCULATION LOGIC FOR UI ---
        const shopName = shops.find(s => s.id === shopId)?.name || 'Unknown Shop';
        const currentDeviceName = currentShift?.deviceName || (devices.find(d => d.id === deviceId)?.name) || 'Current Device'; // Get Name
        const startTime = currentShift ? safeToDate(currentShift.startTime) : new Date();
        const dateStr = startTime ? startTime.toLocaleDateString('en-GB') : '';
        const timeStr = startTime ? startTime.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) : '';
        const amPm = startTime ? (startTime.getHours() >= 12 ? 'PM' : 'AM') : '';
        
        // System Totals
        const startFund = currentShift ? (currentShift.startCash || 0) : 0;
        const sysTotal = currentShift ? (currentShift.totalSales || 0) : 0; // FIXED: Added sysTotal definition
        const sysCash = currentShift ? (currentShift.totalCashSales || 0) : 0; // Renamed for consistency
        const sysBank = currentShift ? (currentShift.totalKHQRSales || 0) : 0; // Renamed for consistency
        const currentRate = parseNumber(exchangeRate) || 4000;

        // Calculated Expectations
        const expectedCashTotal = startFund + sysCash;
        const expectedBankTotal = sysBank;

        // Calculated Actuals (Live from Inputs)
        const actualCashTotal = parseNumber(actualCashKHR) + (parseNumber(actualCashUSD) * currentRate);
        const actualBankTotal = parseNumber(actualBankKHR) + (parseNumber(actualBankUSD) * currentRate);

        // Calculated Variances
        const cashVariance = actualCashTotal - expectedCashTotal;
        const bankVariance = actualBankTotal - expectedBankTotal;
        const totalVariance = cashVariance + bankVariance;

        // Helper for Variance Color
        const getVarColor = (val) => {
            if (val === 0) return 'text-slate-400';
            if (val > 0) return 'text-green-400';
            return 'text-red-400';
        };

        const showOpenUI = !currentShift || isOpening;

        return (
            <Modal show={true} onClose={onClose} maxWidth={!showOpenUI ? "max-w-7xl" : "max-w-md"}>
                {/* NEW: Bill Counter Modal Overlay */}
                {showBillCounter && (
                    <BillCounterModal 
                        currency={showBillCounter} 
                        onClose={() => setShowBillCounter(null)} 
                        onApply={handleApplyBillCount} 
                    />
                )}

                <div className="absolute top-4 right-4 z-10">
                    <button onClick={onClose} className="text-slate-400 hover:text-white text-2xl transition-colors">&times;</button>
                </div>
                
                <ModalBody>
                    {error && (
                        <div className="mb-4 p-3 bg-red-500/20 border border-red-500/50 rounded-lg flex items-center gap-3 text-red-200 text-sm animate-pulse">
                            <i className="fas fa-exclamation-circle text-xl"></i><span>{error}</span>
                        </div>
                    )}

                    {showOpenUI ? (
                        /* --- OPEN SHIFT UI --- */
                        <div className="space-y-6 pt-6 p-4">
                            <h2 className="text-2xl font-bold text-white mb-2">Open New Shift</h2>
                            <div className="bg-slate-700/50 p-3 rounded-lg border border-slate-600 text-sm flex justify-between">
                                <span className="text-slate-400">Device:</span> <span className="text-white font-bold">{currentDeviceName}</span>
                            </div>
                            <p className="text-slate-400">Enter the starting cash amount in the drawer.</p>
                            <div>
                                <label className="block text-sm font-medium text-slate-300 mb-1">Starting Cash (KHR)</label>
                                <input type="text" inputMode="numeric" value={startCash} onChange={(e) => setStartCash(formatNumber(e.target.value))} className="w-full bg-slate-700 text-white text-3xl font-bold px-4 py-4 rounded-xl border border-slate-600 focus:border-green-500 outline-none text-center" placeholder="0" autoFocus />
                            </div>
                            <button onClick={handleOpenShift} disabled={loading} className="w-full bg-green-600 text-white font-bold py-3 px-8 rounded-lg hover:bg-green-700 flex items-center justify-center gap-2 disabled:bg-green-800 shadow-lg shadow-green-900/20">
                                {loading && <div className="loader w-4 h-4"></div>} Start Shift
                            </button>
                        </div>
                    ) : (
                        /* --- CLOSE SHIFT / RECONCILIATION UI --- */
                        <div className="flex flex-col lg:flex-row gap-6 p-2">
                            
                            {/* --- LEFT COLUMN: INPUTS --- */}
                            <div className="flex-1 space-y-6">
                                <h3 className="text-blue-400 font-bold uppercase tracking-wider text-sm flex items-center gap-2">
                                    <i className="fas fa-edit"></i> General Information
                                </h3>
                                
                                {/* Info Banner */}
                                <div className="bg-[#0f172a] border border-slate-800 rounded-lg p-4 grid grid-cols-2 gap-4 text-sm">
                                    <div><span className="text-slate-500 text-xs block uppercase">Shop</span><span className="text-white font-medium">{shopName}</span></div>
                                    <div><span className="text-slate-500 text-xs block uppercase">Device</span><span className="text-white font-medium">{currentDeviceName}</span></div> {/* NEW */}
                                    <div><span className="text-slate-500 text-xs block uppercase">Staff</span><span className="text-white font-medium">{userProfile.name}</span></div>
                                    <div><span className="text-slate-500 text-xs block uppercase">Shift Start</span><span className="text-white font-medium">{timeStr} ({amPm})</span></div>
                                </div>

                                {/* Exchange Rate */}
                                <div className="bg-[#0f172a] border border-slate-800 rounded-lg p-4 flex items-center justify-between">
                                    <h4 className="text-yellow-500 font-bold text-sm uppercase flex items-center gap-2"><i className="fas fa-exchange-alt"></i> Rate</h4>
                                    <div className="flex items-center gap-2">
                                        <span className="text-slate-400 text-xs">1 USD =</span>
                                        <input type="text" inputMode="numeric" value={exchangeRate} onChange={handleCurrencyInput(setExchangeRate)} className="w-24 bg-[#1e293b] text-white px-3 py-1.5 rounded border border-slate-700 focus:border-yellow-500 outline-none font-mono text-right font-bold" />
                                        <span className="text-slate-400 text-xs">KHR</span>
                                    </div>
                                </div>

                                <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    {/* Cash Inputs */}
                                    <div className="bg-[#0f172a] border border-slate-800 rounded-lg p-4 space-y-3">
                                        <h4 className="text-green-400 font-bold text-sm uppercase mb-3"><i className="fas fa-money-bill-wave mr-2"></i> Physical Cash</h4>
                                        <div>
                                            <label className="text-slate-500 text-xs font-bold uppercase mb-1 block">KHR (Riel)</label>
                                            <div className="relative flex items-center">
                                                <input 
                                                    type="text" 
                                                    inputMode="numeric" 
                                                    value={actualCashKHR} 
                                                    onChange={handleCurrencyInput(setActualCashKHR)} 
                                                    className="w-full bg-[#1e293b] text-white text-xl font-bold px-3 py-3 rounded-l border border-r-0 border-slate-700 focus:border-green-500 outline-none font-mono" 
                                                    placeholder="0" 
                                                />
                                                <button onClick={() => setShowBillCounter('KHR')} className="bg-slate-700 hover:bg-slate-600 text-slate-300 border border-slate-700 rounded-r px-4 py-3 transition">
                                                    <i className="fas fa-list"></i>
                                                </button>
                                            </div>
                                        </div>
                                        <div>
                                            <label className="text-slate-500 text-xs font-bold uppercase mb-1 block">USD (Dollar)</label>
                                            <div className="relative flex items-center">
                                                <input 
                                                    type="text" 
                                                    inputMode="numeric" 
                                                    value={actualCashUSD} 
                                                    onChange={handleCurrencyInput(setActualCashUSD)} 
                                                    className="w-full bg-[#1e293b] text-white text-xl font-bold px-3 py-3 rounded-l border border-r-0 border-slate-700 focus:border-green-500 outline-none font-mono" 
                                                    placeholder="0.00" 
                                                />
                                                <button onClick={() => setShowBillCounter('USD')} className="bg-slate-700 hover:bg-slate-600 text-slate-300 border border-slate-700 rounded-r px-4 py-3 transition">
                                                    <i className="fas fa-list"></i>
                                                </button>
                                            </div>
                                        </div>
                                    </div>

                                    {/* Bank Inputs */}
                                    <div className="bg-[#0f172a] border border-slate-800 rounded-lg p-4 space-y-3">
                                        <h4 className="text-blue-400 font-bold text-sm uppercase mb-3"><i className="fas fa-university mr-2"></i> Bank / KHQR</h4>
                                        <div>
                                            <label className="text-slate-500 text-xs font-bold uppercase mb-1 block">KHR (Riel)</label>
                                            <input 
                                                type="text" 
                                                inputMode="numeric" 
                                                value={actualBankKHR} 
                                                onChange={handleCurrencyInput(setActualBankKHR)} 
                                                className="w-full bg-[#1e293b] text-white text-xl font-bold px-3 py-3 rounded border border-slate-700 focus:border-blue-500 outline-none font-mono" 
                                                placeholder="0" 
                                            />
                                        </div>
                                        <div>
                                            <label className="text-slate-500 text-xs font-bold uppercase mb-1 block">USD (Dollar)</label>
                                            <input 
                                                type="text" 
                                                inputMode="numeric" 
                                                value={actualBankUSD} 
                                                onChange={handleCurrencyInput(setActualBankUSD)} 
                                                className="w-full bg-[#1e293b] text-white text-xl font-bold px-3 py-3 rounded border border-slate-700 focus:border-blue-500 outline-none font-mono" 
                                                placeholder="0.00" 
                                            />
                                        </div>
                                    </div>
                                </div>
                                
                                <textarea value={note} onChange={e => setNote(e.target.value)} className="w-full bg-[#0f172a] text-white px-4 py-3 rounded-lg border border-slate-800 focus:border-slate-500 outline-none text-sm resize-none" placeholder="Optional notes..." rows="2"></textarea>
                            </div>

                            {/* --- RIGHT COLUMN: RECONCILIATION SUMMARY --- */}
                            <div className="w-full lg:w-[420px] flex flex-col gap-4">
                                <div className="bg-[#0f172a] rounded-[1.5rem] p-6 border border-slate-800 shadow-2xl relative overflow-hidden font-sans flex-1 flex flex-col">
                                    <h2 className="text-white font-bold text-sm tracking-widest mb-6 opacity-90 border-b border-slate-800 pb-4">SUMMARY</h2>

                                    {/* GRAND TOTAL */}
                                    <div className="text-center mb-8 relative z-10">
                                        <p className="text-slate-500 text-[10px] font-bold tracking-[0.2em] uppercase mb-4">GRAND TOTAL (SYSTEM)</p>
                                        <div className="bg-[#161f32] inline-block px-10 py-5 rounded-2xl border border-slate-800/50 shadow-[inset_0_2px_4px_rgba(0,0,0,0.3)]">
                                            <span className="text-4xl font-black text-[#ef4444] mr-2 tracking-tight">{khrFormatter.format(sysTotal)}</span>
                                            <span className="text-2xl text-[#ef4444] font-bold"></span>
                                        </div>
                                    </div>

                                    {/* BREAKDOWN BOXES */}
                                    <div className="grid grid-cols-2 gap-4 relative z-10">
                                        {/* KHR Cash */}
                                        <div className="bg-[#161f32] p-4 rounded-2xl border border-slate-800 flex flex-col">
                                            <div className="flex justify-between items-center mb-1">
                                                <span className="text-[10px] text-slate-500 font-bold uppercase tracking-wider">KHR (Sys)</span>
                                                <i className="fas fa-money-bill-wave text-green-500/50 text-xs"></i>
                                            </div>
                                            <div className="font-bold text-emerald-400 text-xs md:text-sm truncate">{khrFormatter.format(sysCash)} </div>
                                        </div>
                                        
                                        {/* USD Cash */}
                                        <div className="bg-[#161f32] p-4 rounded-2xl border border-slate-800 flex flex-col">
                                            <div className="flex justify-between items-center mb-1">
                                                <span className="text-[10px] text-slate-500 font-bold uppercase tracking-wider">USD (Approx)</span>
                                                <i className="fas fa-dollar-sign text-green-500/50 text-xs"></i>
                                            </div>
                                            <div className="font-bold text-white text-xs md:text-sm truncate">{usdFormatter.format(sysCash / currentRate)}</div>
                                        </div>

                                        {/* KHR Bank */}
                                        <div className="bg-[#161f32] p-4 rounded-2xl border border-slate-800 flex flex-col">
                                            <div className="flex justify-between items-center mb-1">
                                                <span className="text-[10px] text-slate-500 font-bold uppercase tracking-wider">KHR (Sys)</span>
                                                <i className="fas fa-university text-blue-500/50 text-xs"></i>
                                            </div>
                                            <div className="font-bold text-blue-400 text-xs md:text-sm truncate">{khrFormatter.format(sysBank)} </div>
                                        </div>

                                        {/* USD Bank */}
                                        <div className="bg-[#161f32] p-4 rounded-2xl border border-slate-800 flex flex-col">
                                            <div className="flex justify-between items-center mb-1">
                                                <span className="text-[10px] text-slate-500 font-bold uppercase tracking-wider">USD (Approx)</span>
                                                <i className="fas fa-credit-card text-blue-500/50 text-xs"></i>
                                            </div>
                                            <div className="font-bold text-white text-xs md:text-sm truncate">{usdFormatter.format(sysBank / currentRate)}</div>
                                        </div>
                                    </div>

                                    {/* NET VARIANCE FOOTER */}
                                    <div className="mt-auto pt-6 border-t border-slate-800">
                                        <div className="flex justify-between items-center">
                                            <span className="text-slate-400 text-xs font-bold uppercase tracking-wider">Net Variance</span>
                                            <span className={`text-lg font-black ${getVarColor(totalVariance)}`}>
                                                {totalVariance > 0 ? '+' : ''}{khrFormatter.format(totalVariance)} <span className="text-sm"></span>
                                            </span>
                                        </div>
                                    </div>
                                    
                                    {/* Decorative Glow */}
                                    <div className="absolute -top-10 -right-10 w-40 h-40 bg-blue-500/5 rounded-full blur-3xl pointer-events-none"></div>
                                    <div className="absolute top-20 -left-10 w-32 h-32 bg-emerald-500/5 rounded-full blur-3xl pointer-events-none"></div>
                                </div>

                                <button onClick={handleCloseShift} disabled={loading} className="w-full bg-blue-600 text-white font-bold py-4 rounded-xl hover:bg-blue-700 transition shadow-lg shadow-blue-500/30 flex items-center justify-center gap-3 disabled:bg-slate-700 disabled:cursor-not-allowed">
                                    {loading ? <div className="loader w-5 h-5 border-white/30 border-t-white"></div> : 'Submit Report'}
                                </button>
                            </div>
                        </div>
                    )}
                </ModalBody>
            </Modal>
        );
    };

    // --- NEW: Bill Counter Modal ---
    const BillCounterModal = ({ currency, onClose, onApply }) => {
        const isKHR = currency === 'KHR';
        const denominations = isKHR 
            ? [100, 500, 1000, 2000, 5000, 10000, 20000, 50000, 100000]
            : [1, 2, 5, 10, 20, 50, 100];
        
        const [counts, setCounts] = useState(denominations.reduce((acc, den) => ({...acc, [den]: ''}), {}));

        const handleCountChange = (denom, val) => {
            const num = val.replace(/[^0-9]/g, '');
            setCounts(prev => ({ ...prev, [denom]: num }));
        };

        const totalCalculated = useMemo(() => {
            return denominations.reduce((sum, den) => {
                const count = parseInt(counts[den] || 0, 10);
                return sum + (count * den);
            }, 0);
        }, [counts, denominations]);

        // Helper for display
        const formatMoney = (val) => new Intl.NumberFormat('en-US').format(val);

        const accentColor = isKHR ? 'text-sky-400' : 'text-emerald-400'; // Cyan for KHR, Green for USD as per images

        return (
            <div className="fixed inset-0 z-[70] flex items-center justify-center p-4 bg-black/80 backdrop-blur-sm animate-fade-in-up">
                <div className="bg-[#1e293b] rounded-xl shadow-2xl w-full max-w-lg border border-slate-700 overflow-hidden flex flex-col max-h-[90vh]">
                    {/* Header */}
                    <div className="px-6 py-4 flex justify-between items-center border-b border-slate-700/50">
                        <h3 className="text-xl font-bold text-white">Bill Counter ({currency})</h3>
                        <button onClick={onClose} className="text-slate-400 hover:text-white transition-colors">
                            <i className="fas fa-times text-lg"></i>
                        </button>
                    </div>
                    
                    {/* Body */}
                    <div className="flex-1 overflow-y-auto p-6 space-y-6 bg-[#1e293b]">
                        {/* Total Card */}
                        <div className="bg-[#0f172a] p-6 rounded-xl border border-slate-700 text-center shadow-inner">
                            <p className="text-slate-400 text-xs font-bold uppercase tracking-widest mb-2">TOTAL CALCULATED</p>
                            <div className="text-4xl font-black text-white tracking-tight flex justify-center items-center gap-1">
                                {isKHR ? (
                                    <>
                                        {formatMoney(totalCalculated)}<span className="text-2xl font-bold align-top mt-1"></span>
                                    </>
                                ) : (
                                    <>
                                        <span className="text-2xl font-bold align-top mt-1">$</span>{formatMoney(totalCalculated)}
                                    </>
                                )}
                            </div>
                        </div>

                        {/* Denomination Grid */}
                        <div className="grid grid-cols-2 gap-4">
                            {denominations.map(denom => {
                                const count = counts[denom] || '';
                                
                                return (
                                    <div key={denom} className="flex items-center justify-between bg-[#0f172a]/50 p-1 rounded-lg border border-slate-700/50">
                                        {/* Label */}
                                        <div className={`pl-3 font-bold font-mono text-lg ${accentColor} flex items-baseline`}>
                                            {isKHR ? (
                                                <>{formatMoney(denom)}<span className="text-xs ml-0.5"></span></>
                                            ) : (
                                                <><span className="text-xs mr-0.5">$</span>{denom}</>
                                            )}
                                        </div>

                                        {/* Multiplier */}
                                        <div className="text-slate-600 text-xs font-bold px-2">x</div>

                                        {/* Input */}
                                        <input 
                                            type="tel" 
                                            value={count} 
                                            onChange={(e) => handleCountChange(denom, e.target.value)}
                                            className="w-20 bg-[#0f172a] text-white text-center font-bold rounded border border-slate-600 focus:border-blue-500 outline-none py-2 mx-1 transition-colors"
                                            placeholder="0"
                                        />
                                    </div>
                                );
                            })}
                        </div>
                    </div>

                    {/* Footer */}
                    <div className="p-5 border-t border-slate-700 bg-[#1e293b] flex justify-end gap-3">
                        <button onClick={onClose} className="px-6 py-2.5 rounded-lg bg-slate-700 text-slate-300 font-bold hover:bg-slate-600 transition border border-slate-600">
                            Cancel
                        </button>
                        <button onClick={() => onApply(totalCalculated)} className="px-6 py-2.5 rounded-lg bg-blue-600 text-white font-bold hover:bg-blue-700 transition flex items-center gap-2 shadow-lg shadow-blue-900/20">
                            <i className="far fa-check-circle"></i> Apply Total
                        </button>
                    </div>
                </div>
            </div>
        );
    };

    // --- NEW: Add Customer Modal Component ---
    const AddCustomerModal = ({ onClose, onSave, shops, defaultShopId }) => {
        const [name, setName] = useState('');
        const [phone, setPhone] = useState('');
        const [email, setEmail] = useState('');
        const [shopId, setShopId] = useState(defaultShopId || ''); // NEW: Shop Selection
        const [loading, setLoading] = useState(false);

        const handleSubmit = async (e) => {
            e.preventDefault();
            setLoading(true);
            try {
                const docRef = await db.collection("customers").add({
                    name, phone, email, 
                    points: 0,
                    visitCount: 0, // Init visit count
                    totalSpent: 0, // Init total spent
                    registeredShopId: shopId, // Track origin shop
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                onSave({ id: docRef.id, name, phone, email, points: 0, registeredShopId: shopId });
            } catch (error) {
                alert("Failed to add customer: " + error.message);
                setLoading(false);
            }
        };

        return (
            <Modal show={true} onClose={onClose} maxWidth="max-w-md">
                <ModalHeader title="Register New Customer" onClose={onClose} />
                <form onSubmit={handleSubmit}>
                    <ModalBody>
                        <div className="space-y-4">
                            <div>
                                <label className="block text-sm font-medium text-slate-300 mb-1">Customer Name <span className="text-red-400">*</span></label>
                                <input type="text" required value={name} onChange={e => setName(e.target.value)} className="w-full bg-slate-700 text-white px-3 py-2 rounded border border-slate-600 focus:border-blue-500 outline-none" placeholder="e.g. John Doe" autoFocus />
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-slate-300 mb-1">Phone Number <span className="text-red-400">*</span></label>
                                <input type="tel" required value={phone} onChange={e => setPhone(e.target.value)} className="w-full bg-slate-700 text-white px-3 py-2 rounded border border-slate-600 focus:border-blue-500 outline-none" placeholder="e.g. 012 345 678" />
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-slate-300 mb-1">Email (Optional)</label>
                                <input type="email" value={email} onChange={e => setEmail(e.target.value)} className="w-full bg-slate-700 text-white px-3 py-2 rounded border border-slate-600 focus:border-blue-500 outline-none" placeholder="e.g. client@example.com" />
                            </div>
                            {/* NEW: Shop Selection */}
                            <div>
                                <label className="block text-sm font-medium text-slate-300 mb-1">Registered Shop</label>
                                <select value={shopId} onChange={e => setShopId(e.target.value)} className="w-full bg-slate-700 text-white px-3 py-2 rounded border border-slate-600 focus:border-blue-500 outline-none">
                                    <option value="">Unknown / General</option>
                                    {shops && shops.map(s => <option key={s.id} value={s.id}>{s.name}</option>)}
                                </select>
                            </div>
                        </div>
                    </ModalBody>
                    <ModalFooter>
                        <button type="button" onClick={onClose} className="bg-slate-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-slate-500">Cancel</button>
                        <button type="submit" disabled={loading} className="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 flex items-center gap-2">
                            {loading ? <div className="loader w-4 h-4"></div> : <i className="fas fa-check"></i>}
                            {loading ? 'Saving...' : 'Register'}
                        </button>
                    </ModalFooter>
                </form>
            </Modal>
        );
    };

    // --- NEW: Payment Modal ---
    const PaymentModal = ({ total, onConfirm, onCancel, isProcessing }) => {
        const [method, setMethod] = useState('Cash');
        const [tenderedKHR, setTenderedKHR] = useState('');
        const [tenderedUSD, setTenderedUSD] = useState('');
        const [exchangeRate, setExchangeRate] = useState(4000); // Default exchange rate
        
        // Calculate totals
        const khrAmount = parseInt(tenderedKHR) || 0;
        const usdAmount = parseFloat(tenderedUSD) || 0;
        const totalTendered = khrAmount + (usdAmount * exchangeRate);
        
        const change = method === 'Cash' ? Math.max(0, totalTendered - total) : 0;
        const canPay = method !== 'Cash' || totalTendered >= total;

        return (
            <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black bg-opacity-70 backdrop-blur-sm">
                <div className="bg-slate-800 rounded-lg shadow-2xl w-full max-w-md border border-slate-700 flex flex-col animate-fade-in-up">
                    <div className="p-6 border-b border-slate-700 text-center">
                        <h2 className="text-slate-400 text-sm uppercase font-bold tracking-wider mb-2">Total Amount Due</h2>
                        <div className="text-4xl font-bold text-white">{new Intl.NumberFormat('en-US').format(total)}</div>
                        <div className="text-sm text-slate-400 mt-1"> ${new Intl.NumberFormat('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(total / exchangeRate)}</div>
                    </div>
                    
                    <div className="p-6 space-y-6">
                        {/* Payment Method Tabs */}
                        <div className="grid grid-cols-2 gap-3">
                            {['Cash', 'KHQR'].map(m => (
                                <button
                                    key={m}
                                    onClick={() => setMethod(m)}
                                    className={`py-3 rounded-lg font-bold transition flex flex-col items-center justify-center gap-1 ${method === m ? 'bg-blue-600 text-white' : 'bg-slate-700 text-slate-300 hover:bg-slate-600'}`}
                                >
                                    <i className={`fas ${m === 'Cash' ? 'fa-money-bill-wave' : 'fa-qrcode'}`}></i>
                                    {m}
                                </button>
                            ))}
                        </div>

                        {/* Cash Input Section */}
                        {method === 'Cash' && (
                            <div className="bg-slate-900/50 p-4 rounded-lg border border-slate-700 space-y-4">
                                <div className="flex justify-between items-center text-xs text-slate-400">
                                    <span>Exchange Rate (1 USD):</span>
                                    <div className="flex items-center">
                                        <span className="mr-1"></span>
                                        <input 
                                            type="number" 
                                            value={exchangeRate}
                                            onChange={e => setExchangeRate(parseFloat(e.target.value) || 0)}
                                            className="w-16 bg-slate-800 border border-slate-600 rounded px-1 text-right text-white focus:border-blue-500 outline-none"
                                        />
                                    </div>
                                </div>

                                <div className="grid grid-cols-2 gap-4">
                                    <div>
                                        <label className="block text-xs font-medium text-slate-400 mb-1">USD ($)</label>
                                        <input 
                                            type="number" 
                                            value={tenderedUSD}
                                            onChange={e => setTenderedUSD(e.target.value)}
                                            className="w-full bg-slate-800 text-white text-lg font-bold p-3 rounded border border-slate-600 focus:border-green-500 outline-none text-right"
                                            placeholder="0.00"
                                            step="0.01"
                                        />
                                    </div>
                                    <div>
                                        <label className="block text-xs font-medium text-slate-400 mb-1">KHR ()</label>
                                        <input 
                                            type="number" 
                                            value={tenderedKHR}
                                            onChange={e => setTenderedKHR(e.target.value)}
                                            className="w-full bg-slate-800 text-white text-lg font-bold p-3 rounded border border-slate-600 focus:border-blue-500 outline-none text-right"
                                            placeholder="0"
                                            autoFocus
                                        />
                                    </div>
                                </div>

                                {/* Quick Add Buttons */}
                                <div className="flex flex-wrap justify-end gap-2">
                                    {[5, 10, 20, 50, 100].map(amt => (
                                        <button 
                                            key={`usd-${amt}`}
                                            onClick={() => setTenderedUSD(amt.toString())}
                                            className="px-2 py-1 text-xs bg-green-900/30 text-green-400 border border-green-800/50 rounded hover:bg-green-800/50"
                                        >
                                            ${amt}
                                        </button>
                                    ))}
                                    {[1000, 5000, 10000, 20000, 50000, 100000].map(amt => (
                                        <button 
                                            key={`khr-${amt}`}
                                            onClick={() => setTenderedKHR(amt.toString())}
                                            className="px-2 py-1 text-xs bg-blue-900/30 text-blue-400 border border-blue-800/50 rounded hover:bg-blue-800/50"
                                        >
                                            {new Intl.NumberFormat('en-US').format(amt)}
                                        </button>
                                    ))}
                                    <button onClick={() => { setTenderedKHR(total.toString()); setTenderedUSD(''); }} className="px-2 py-1 text-xs bg-slate-600 text-white rounded hover:bg-slate-500">Exact</button>
                                </div>
                            </div>
                        )}

                        {/* Change Display */}
                        {method === 'Cash' && (
                            <div className="flex justify-between items-center py-3 px-4 bg-slate-700/50 rounded-lg">
                                <span className="text-slate-400 font-medium">Change Due:</span>
                                <div className="text-right">
                                    <div className={`text-xl font-bold ${change > 0 ? 'text-green-400' : 'text-slate-500'}`}>
                                        {new Intl.NumberFormat('en-US').format(change)}
                                    </div>
                                    {change > 0 && (
                                        <div className="text-xs text-slate-400">
                                             ${new Intl.NumberFormat('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(change / exchangeRate)}
                                        </div>
                                    )}
                                </div>
                            </div>
                        )}
                    </div>

                    <div className="p-6 border-t border-slate-700 flex gap-3">
                        <button onClick={onCancel} className="flex-1 py-3 font-bold text-slate-300 bg-slate-700 rounded-lg hover:bg-slate-600">Cancel</button>
                        <button 
                            onClick={() => onConfirm({ method, tendered: totalTendered, change, discount: 0 })}
                            disabled={!canPay || isProcessing}
                            className="flex-[2] py-3 font-bold text-white bg-green-600 rounded-lg hover:bg-green-700 disabled:bg-slate-600 disabled:cursor-not-allowed flex items-center justify-center gap-2"
                        >
                            {isProcessing ? <div className="loader w-4 h-4"></div> : <i className="fas fa-check"></i>}
                            Complete Sale
                        </button>
                    </div>
                </div>
            </div>
        );
    };

    // --- NEW: Receipt Modal ---
    const ReceiptModal = ({ saleData, onClose }) => {
        const receiptRef = useRef(null);
        const [isPrinting, setIsPrinting] = useState(false);

        const handlePrint = () => {
            setIsPrinting(true);
            const input = receiptRef.current;
            // Capture high-res image
            html2canvas(input, { scale: 3, backgroundColor: '#ffffff', useCORS: true }).then(canvas => {
                const imgData = canvas.toDataURL('image/png');
                const printWindow = window.open('', '', 'width=400,height=600');
                printWindow.document.write('<html><head><title>Print Receipt</title></head><body style="margin:0;display:flex;justify-content:center;">');
                printWindow.document.write('<img src="' + imgData + '" style="width:100%;max-width:300px;" />');
                printWindow.document.write('</body></html>');
                printWindow.document.close();
                printWindow.focus();
                // Allow image to load before printing
                setTimeout(() => {
                    printWindow.print();
                    printWindow.close();
                    setIsPrinting(false);
                }, 500);
            });
        };

        return (
            <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black bg-opacity-80 backdrop-blur-sm">
                <div className="bg-slate-800 rounded-lg shadow-xl max-w-sm w-full flex flex-col max-h-[90vh]">
                    <div className="p-4 border-b border-slate-700 flex justify-between items-center">
                        <h3 className="text-white font-bold">Transaction Success</h3>
                        <button onClick={onClose} className="text-slate-400 hover:text-white"><i className="fas fa-times"></i></button>
                    </div>
                    
                    <div className="flex-1 overflow-y-auto p-4 bg-slate-900 flex justify-center">
                        {/* Thermal Receipt Preview */}
                        <div ref={receiptRef} className="bg-white text-black p-4 w-[300px] text-xs font-mono shadow-lg leading-tight">
                            <div className="text-center mb-3">
                                <h2 className="text-base font-bold mb-1">{saleData.shopName}</h2>
                                <p className="text-[10px] text-gray-600">Receipt: {saleData.receiptNo}</p>
                                <p className="text-[10px] text-gray-600">{new Date(saleData.createdAt).toLocaleString()}</p>
                            </div>
                            
                            <div className="border-b border-dashed border-gray-400 my-2"></div>
                            
                            <div className="mb-2">
                                {saleData.items.map((item, i) => (
                                    <div key={i} className="flex justify-between mb-1">
                                        <div className="flex-1 pr-2">
                                            <div>{item.name}</div>
                                            <div className="text-[10px] text-gray-500">{item.quantity} x {new Intl.NumberFormat('en-US').format(item.price)}</div>
                                        </div>
                                        <div className="text-right font-semibold">
                                            {new Intl.NumberFormat('en-US').format(item.price * item.quantity)}
                                        </div>
                                    </div>
                                ))}
                            </div>
                            
                            <div className="border-b border-dashed border-gray-400 my-2"></div>
                            
                            <div className="flex justify-between font-bold text-sm mb-1">
                                <span>TOTAL</span>
                                <span>{new Intl.NumberFormat('en-US').format(saleData.grandTotal)}</span>
                            </div>
                            
                            {/* NEW: Redemption Line Item */}
                            {saleData.redemptionAmount > 0 && (
                                <div className="flex justify-between text-xs mb-1 text-black font-bold">
                                    <span>Loyalty Redeemed</span>
                                    <span>-{new Intl.NumberFormat('en-US').format(saleData.redemptionAmount)}</span>
                                </div>
                            )}
                            
                            {saleData.paymentMethod === 'Cash' && (
                                <>
                                    <div className="flex justify-between text-gray-600 mt-1">
                                        <span>Cash Tendered</span>
                                        <span>{new Intl.NumberFormat('en-US').format(saleData.amountTendered)}</span>
                                    </div>
                                    <div className="flex justify-between text-gray-600">
                                        <span>Change</span>
                                        <span>{new Intl.NumberFormat('en-US').format(saleData.changeDue)}</span>
                                    </div>
                                </>
                            )}
                            {saleData.paymentMethod !== 'Cash' && (
                                <div className="text-center mt-2 text-gray-500 text-[10px] uppercase">
                                    Paid via {saleData.paymentMethod}
                                </div>
                            )}

                            <div className="border-b border-dashed border-gray-400 my-4"></div>
                            
                            {/* Points Earned on Receipt */}
                            {saleData.pointsEarned > 0 && (
                                <div className="text-center mb-4 text-xs font-bold text-black">
                                    Points Earned: +{saleData.pointsEarned}
                                </div>
                            )}

                            <div className="text-center text-[10px] text-gray-500">
                                <p>Cashier: {saleData.cashierName}</p>
                                {saleData.customerName !== 'Walk-in' && <p>Customer: {saleData.customerName}</p>}
                                <p className="mt-2">Thank you for shopping!</p>
                            </div>
                        </div>
                    </div>

                    <div className="p-4 border-t border-slate-700 grid grid-cols-2 gap-3">
                        <button onClick={handlePrint} disabled={isPrinting} className="bg-slate-600 text-white font-bold py-2 rounded hover:bg-slate-500 flex items-center justify-center gap-2">
                            {isPrinting ? <div className="loader w-4 h-4"></div> : <i className="fas fa-print"></i>} Print
                        </button>
                        <button onClick={onClose} className="bg-blue-600 text-white font-bold py-2 rounded hover:bg-blue-700">
                            New Sale
                        </button>
                    </div>
                </div>
            </div>
        );
    };

    // --- PHASE 3: Sales History & Void Logic ---
    const SalesHistoryModal = ({ shopId, onClose, onReprint, userProfile }) => {
        const [sales, setSales] = useState([]);
        const [loading, setLoading] = useState(true);
        const [voidingId, setVoidingId] = useState(null);
        const [expandedSaleId, setExpandedSaleId] = useState(null); // New state for row expansion

        // Fetch today's sales for this shop
        useEffect(() => {
            const startOfDay = new Date();
            startOfDay.setHours(0,0,0,0);
            
            const unsubscribe = db.collection('sales')
                .where('shopId', '==', shopId)
                .where('timestamp', '>=', startOfDay)
                .orderBy('timestamp', 'desc')
                .limit(50)
                .onSnapshot(snapshot => {
                    const salesData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    setSales(salesData);
                    setLoading(false);
                });
            return () => unsubscribe();
        }, [shopId]);

        const toggleExpand = (saleId) => {
            setExpandedSaleId(prev => prev === saleId ? null : saleId);
        };

        const handleVoid = async (sale) => {
            if (!confirm(`Are you sure you want to VOID receipt ${sale.receiptNo}? This will restore stock.`)) return;
            setVoidingId(sale.id);

            try {
                const batch = db.batch();
                
                // 1. Update Sale Status
                const saleRef = db.collection('sales').doc(sale.id);
                batch.update(saleRef, { 
                    status: 'void', 
                    voidedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    voidedBy: userProfile?.name || 'Unknown'
                });

                // 2. Restore Stock
                const targetShopId = sale.shopId || shopId;
                sale.items.forEach(item => {
                    const productRef = db.collection('products').doc(item.productId);
                    batch.update(productRef, {
                        [`stockByShop.${targetShopId}`]: firebase.firestore.FieldValue.increment(item.quantity)
                    });

                    // 3. Log Negative Movement (Return)
                    const moveRef = db.collection("productMovement").doc();
                    batch.set(moveRef, {
                        productId: item.productId,
                        productCode: item.code,
                        productName: item.name,
                        type: 'Void/Return',
                        quantityChange: item.quantity,
                        from: 'Customer',
                        to: sale.shopName || 'Shop',
                        referenceNo: `${sale.receiptNo} (VOID)`,
                        performedBy: userProfile?.name || 'Unknown',
                        timestamp: firebase.firestore.FieldValue.serverTimestamp()
                    });
                });

                // 4. Reverse Customer Points (if applicable)
                // FIX: Use pointsEarned stored on the sale document instead of recalculating
                if (sale.customerId) {
                    const pointsToRevert = sale.pointsEarned || 0; 
                    
                    if (pointsToRevert > 0) {
                        const custRef = db.collection("customers").doc(sale.customerId);
                        batch.update(custRef, {
                            points: firebase.firestore.FieldValue.increment(-pointsToRevert),
                            // Also reverse spend and visit count logic if needed, but points is the critical financial metric
                            totalSpent: firebase.firestore.FieldValue.increment(-sale.grandTotal)
                        });
                    }
                }

                await batch.commit();
            } catch (err) {
                console.error(err);
                alert("Failed to void sale.");
            } finally {
                setVoidingId(null);
            }
        };

        return (
            <Modal show={true} onClose={onClose} maxWidth="max-w-4xl">
                <ModalHeader title="Today's Transactions" onClose={onClose} />
                <ModalBody>
                    {loading ? <div className="text-center p-8"><div className="loader"></div></div> : (
                        <div className="overflow-x-auto">
                            <table className="min-w-full text-sm text-left">
                                <thead className="bg-slate-900/50 text-slate-400">
                                    <tr>
                                        <th className="px-4 py-3 w-10"></th>
                                        <th className="px-4 py-3">Time</th>
                                        <th className="px-4 py-3">Receipt</th>
                                        <th className="px-4 py-3">Payment</th>
                                        <th className="px-4 py-3 text-right">Total</th>
                                        <th className="px-4 py-3 text-center">Status</th>
                                        <th className="px-4 py-3 text-center">Actions</th>
                                    </tr>
                                </thead>
                                <tbody className="divide-y divide-slate-700">
                                    {sales.length === 0 ? (
                                        <tr><td colSpan="7" className="p-4 text-center text-slate-500">No sales found today.</td></tr>
                                    ) : sales.map(sale => (
                                        <React.Fragment key={sale.id}>
                                            <tr className={`hover:bg-slate-700/30 transition-colors ${sale.status === 'void' ? 'opacity-50 bg-red-900/10' : ''}`}>
                                                <td className="px-4 py-3 text-center">
                                                    <button 
                                                        onClick={() => toggleExpand(sale.id)}
                                                        className="text-slate-400 hover:text-white transition-colors focus:outline-none"
                                                        title="View Products"
                                                    >
                                                        <i className={`fas fa-chevron-right transition-transform duration-200 ${expandedSaleId === sale.id ? 'rotate-90 text-blue-400' : ''}`}></i>
                                                    </button>
                                                </td>
                                                <td className="px-4 py-3 text-slate-300">{sale.createdAt ? new Date(sale.createdAt).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : '-'}</td>
                                                <td className="px-4 py-3 text-slate-300 font-mono">{sale.receiptNo}</td>
                                                <td className="px-4 py-3 text-slate-300">{sale.paymentMethod}</td>
                                                <td className="px-4 py-3 text-right font-bold text-emerald-400">{new Intl.NumberFormat('en-US').format(sale.grandTotal)}</td>
                                                <td className="px-4 py-3 text-center">
                                                    {sale.status === 'void' 
                                                        ? <span className="bg-red-500/20 text-red-400 px-2 py-1 rounded text-xs font-bold">VOIDED</span>
                                                        : <span className="bg-green-500/20 text-green-400 px-2 py-1 rounded text-xs font-bold">PAID</span>
                                                    }
                                                </td>
                                                <td className="px-4 py-3 text-center space-x-2">
                                                    <button onClick={() => onReprint(sale)} className="text-blue-400 hover:text-blue-300" title="Reprint"><i className="fas fa-print"></i></button>
                                                    {sale.status !== 'void' && (
                                                        <button 
                                                            onClick={() => handleVoid(sale)} 
                                                            disabled={voidingId === sale.id}
                                                            className="text-red-400 hover:text-red-300" 
                                                            title="Void/Refund"
                                                        >
                                                            {voidingId === sale.id ? <div className="loader w-3 h-3"></div> : <i className="fas fa-ban"></i>}
                                                        </button>
                                                    )}
                                                </td>
                                            </tr>
                                            {/* EXPANDED ROW FOR LINE ITEMS */}
                                            {expandedSaleId === sale.id && (
                                                <tr className="bg-slate-800/50 animate-fade-in-up">
                                                    <td colSpan="7" className="p-4 border-t border-slate-700 shadow-inner">
                                                        <div className="bg-slate-900 rounded-lg p-3 border border-slate-700">
                                                            <h5 className="text-xs font-bold text-slate-400 uppercase tracking-wider mb-2 flex items-center gap-2">
                                                                <i className="fas fa-list text-blue-500"></i> Transaction Items
                                                            </h5>
                                                            <table className="w-full text-sm">
                                                                <thead className="text-xs text-slate-500 border-b border-slate-700">
                                                                    <tr>
                                                                        <th className="py-1 text-left">Product</th>
                                                                        <th className="py-1 text-center">Qty</th>
                                                                        <th className="py-1 text-right">Price</th>
                                                                        <th className="py-1 text-right">Subtotal</th>
                                                                    </tr>
                                                                </thead>
                                                                <tbody className="divide-y divide-slate-800">
                                                                    {sale.items.map((item, idx) => (
                                                                        <tr key={idx} className="text-slate-300">
                                                                            <td className="py-2">
                                                                                <div className="font-medium">{item.name}</div>
                                                                                <div className="text-[10px] text-slate-500">{item.code || item.barcode}</div>
                                                                            </td>
                                                                            <td className="py-2 text-center">{item.quantity}</td>
                                                                            <td className="py-2 text-right">{new Intl.NumberFormat('en-US').format(item.price)}</td>
                                                                            <td className="py-2 text-right font-medium">{new Intl.NumberFormat('en-US').format(item.price * item.quantity)}</td>
                                                                        </tr>
                                                                    ))}
                                                                </tbody>
                                                                <tfoot className="border-t border-slate-700">
                                                                    <tr>
                                                                        <td colSpan="3" className="py-2 text-right text-xs text-slate-400">Total</td>
                                                                        <td className="py-2 text-right font-bold text-emerald-400">{new Intl.NumberFormat('en-US').format(sale.grandTotal)}</td>
                                                                    </tr>
                                                                </tfoot>
                                                            </table>
                                                        </div>
                                                    </td>
                                                </tr>
                                            )}
                                        </React.Fragment>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                    )}
                </ModalBody>
                <ModalFooter>
                    <button onClick={onClose} className="bg-slate-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-slate-500">Close</button>
                </ModalFooter>
            </Modal>
        );
    };

    // --- PHASE 3: Daily Report ---
    const DailyReportModal = ({ shopId, onClose }) => {
        const [stats, setStats] = useState(null);
        const [loading, setLoading] = useState(true);

        useEffect(() => {
            const startOfDay = new Date();
            startOfDay.setHours(0,0,0,0);
            
            const unsubscribe = db.collection('sales')
                .where('shopId', '==', shopId)
                .where('timestamp', '>=', startOfDay)
                .onSnapshot(snapshot => {
                    let totalSales = 0;
                    let totalCash = 0;
                    let totalQR = 0;
                    let totalCard = 0;
                    let count = 0;
                    let itemsSold = 0;

                    snapshot.docs.forEach(doc => {
                        const data = doc.data();
                        if (data.status === 'void') return; // Skip voided

                        totalSales += data.grandTotal;
                        count++;
                        itemsSold += data.items.reduce((acc, item) => acc + item.quantity, 0);

                        if (data.paymentMethod === 'Cash') totalCash += data.grandTotal;
                        else if (data.paymentMethod === 'KHQR') totalQR += data.grandTotal;
                        else totalCard += data.grandTotal;
                    });

                    setStats({ totalSales, totalCash, totalQR, totalCard, count, itemsSold });
                    setLoading(false);
                });
            return () => unsubscribe();
        }, [shopId]);

        return (
            <Modal show={true} onClose={onClose} maxWidth="max-w-md">
                <ModalHeader title="End of Day Report" onClose={onClose} />
                <ModalBody>
                    {loading ? <div className="text-center p-8"><div className="loader"></div></div> : (
                        <div className="space-y-6">
                            <div className="text-center bg-slate-700/50 p-6 rounded-xl border border-slate-600">
                                <p className="text-slate-400 text-sm uppercase tracking-wide">Total Sales Today</p>
                                <h2 className="text-4xl font-bold text-white mt-2">{new Intl.NumberFormat('en-US').format(stats.totalSales)}</h2>
                                <p className="text-slate-400 text-xs mt-2">{stats.count} Transactions  {stats.itemsSold} Items Sold</p>
                            </div>

                            <div className="space-y-3">
                                <h4 className="font-bold text-slate-300 border-b border-slate-700 pb-2">Payment Breakdown</h4>
                                <div className="flex justify-between items-center p-3 bg-slate-800 rounded border border-slate-700">
                                    <span className="flex items-center gap-2"><i className="fas fa-money-bill-wave text-green-400"></i> Cash</span>
                                    <span className="font-bold text-white">{new Intl.NumberFormat('en-US').format(stats.totalCash)}</span>
                                </div>
                                <div className="flex justify-between items-center p-3 bg-slate-800 rounded border border-slate-700">
                                    <span className="flex items-center gap-2"><i className="fas fa-qrcode text-blue-400"></i> KHQR / Bank</span>
                                    <span className="font-bold text-white">{new Intl.NumberFormat('en-US').format(stats.totalQR)}</span>
                                </div>
                                <div className="flex justify-between items-center p-3 bg-slate-800 rounded border border-slate-700">
                                    <span className="flex items-center gap-2"><i className="fas fa-credit-card text-purple-400"></i> Card</span>
                                    <span className="font-bold text-white">{new Intl.NumberFormat('en-US').format(stats.totalCard)}</span>
                                </div>
                            </div>
                        </div>
                    )}
                </ModalBody>
                <ModalFooter>
                    <button onClick={onClose} className="w-full bg-blue-600 text-white font-bold py-3 rounded-lg hover:bg-blue-700">
                        Close Report
                    </button>
                </ModalFooter>
            </Modal>
        );
    };

    // --- PHASE 1: Customer Management Component ---
    const CustomerManagement = () => {
        const { customers, loading, shops } = useData(); // Added shops
        // Added new fields to state
        const [formData, setFormData] = useState({ name: '', phone: '', email: '', points: 0, registeredShopId: '', visitCount: 0, totalSpent: 0 });
        const [editId, setEditId] = useState(null);
        const [modal, setModal] = useState({ type: null, data: null });
        const [searchTerm, setSearchTerm] = useState('');
        const [showCustomerModal, setShowCustomerModal] = useState(false); 

        const filteredCustomers = useMemo(() => {
            if (!customers) return [];
            return customers.filter(c => 
                c.name.toLowerCase().includes(searchTerm.toLowerCase()) || 
                (c.phone && c.phone.includes(searchTerm))
            );
        }, [customers, searchTerm]);

        const resetForm = () => { 
            setFormData({ name: '', phone: '', email: '', points: 0, registeredShopId: '', visitCount: 0, totalSpent: 0 }); 
            setEditId(null); 
            setShowCustomerModal(false); 
        };

        const handleAddNew = () => { 
            resetForm();
            setShowCustomerModal(true); 
        };

        const handleEdit = (customer) => { 
            setEditId(customer.id); 
            setFormData({ 
                name: customer.name, 
                phone: customer.phone, 
                email: customer.email || '', 
                points: customer.points || 0,
                registeredShopId: customer.registeredShopId || '',
                visitCount: customer.visitCount || 0,
                totalSpent: customer.totalSpent || 0
            }); 
            setShowCustomerModal(true); 
        };

        const handleSubmit = async (e) => {
            e.preventDefault();
            const dataToSave = {
                ...formData,
                points: parseInt(formData.points) || 0,
                visitCount: parseInt(formData.visitCount) || 0,
                totalSpent: parseFloat(formData.totalSpent) || 0
            };

            try {
                if (editId) await db.collection("customers").doc(editId).update(dataToSave);
                else await db.collection("customers").add({ ...dataToSave, createdAt: firebase.firestore.FieldValue.serverTimestamp() });
                setModal({ type: 'message', data: { title: 'Success', message: `Customer ${editId ? 'updated' : 'added'}.` } });
                resetForm(); 
            } catch (err) {
                setModal({ type: 'message', data: { title: 'Error', message: 'Failed to save customer.', isError: true } });
            }
        };

        const handleDelete = async (id) => {
            try {
                await db.collection("customers").doc(id).delete();
                setModal({ type: 'message', data: { title: 'Success', message: 'Customer deleted.' } });
            } catch (err) {
                setModal({ type: 'message', data: { title: 'Error', message: 'Failed to delete customer.', isError: true } });
            }
        };

        return (
            <div className="space-y-6">
                <MessageModal {...modal.data} show={modal.type === 'message'} onClose={() => setModal({ type: null })} />
                <ConfirmationModal show={modal.type === 'confirmDelete'} title="Delete Customer" message="Are you sure?" onConfirm={() => { handleDelete(modal.data); setModal({ type: null }); }} onCancel={() => setModal({ type: null })} />

                {/* NEW: Customer Form Modal */}
                {showCustomerModal && (
                    <Modal show={true} onClose={resetForm} maxWidth="max-w-3xl">
                        <ModalHeader title={editId ? 'Edit Customer' : 'Add New Customer'} onClose={resetForm} />
                        <form onSubmit={handleSubmit} className="flex flex-col h-full">
                            <ModalBody>
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-6 p-2">
                                    <div>
                                        <label className="block text-sm font-medium text-slate-300 mb-1">
                                            <i className="fas fa-user text-blue-400 mr-2"></i>Name
                                        </label>
                                        <input type="text" value={formData.name} onChange={e => setFormData({...formData, name: e.target.value})} className="w-full bg-slate-700 text-white px-3 py-2 rounded-md border border-slate-600 focus:border-blue-500 focus:ring-2 focus:ring-blue-500 outline-none transition" required />
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium text-slate-300 mb-1">
                                            <i className="fas fa-phone-alt text-green-400 mr-2"></i>Phone
                                        </label>
                                        <input type="text" value={formData.phone} onChange={e => setFormData({...formData, phone: e.target.value})} className="w-full bg-slate-700 text-white px-3 py-2 rounded-md border border-slate-600 focus:border-blue-500 focus:ring-2 focus:ring-blue-500 outline-none transition" required />
                                    </div>
                                    <div className="md:col-span-2">
                                        <label className="block text-sm font-medium text-slate-300 mb-1">
                                            <i className="fas fa-envelope text-orange-400 mr-2"></i>Email (Optional)
                                        </label>
                                        <input type="email" value={formData.email} onChange={e => setFormData({...formData, email: e.target.value})} className="w-full bg-slate-700 text-white px-3 py-2 rounded-md border border-slate-600 focus:border-blue-500 focus:ring-2 focus:ring-blue-500 outline-none transition" />
                                    </div>
                                    
                                    {/* NEW INPUTS */}
                                    <div>
                                        <label className="block text-sm font-medium text-slate-300 mb-1">
                                            <i className="fas fa-store-alt text-purple-400 mr-2"></i>Registered Shop
                                        </label>
                                        <select value={formData.registeredShopId} onChange={e => setFormData({...formData, registeredShopId: e.target.value})} className="w-full bg-slate-700 text-white px-3 py-2 rounded-md border border-slate-600 focus:border-blue-500 focus:ring-2 outline-none">
                                            <option value="">Unknown</option>
                                            {shops.map(s => <option key={s.id} value={s.id}>{s.name}</option>)}
                                        </select>
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium text-slate-300 mb-1">
                                            <i className="fas fa-star text-yellow-400 mr-2"></i>Current Points
                                        </label>
                                        <input type="number" value={formData.points} onChange={e => setFormData({...formData, points: e.target.value})} className="w-full bg-slate-700 text-white px-3 py-2 rounded-md border border-slate-600 focus:border-blue-500 focus:ring-2 outline-none" min="0" />
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium text-slate-300 mb-1">
                                            <i className="fas fa-walking text-cyan-400 mr-2"></i>Visit Count (Walk-ins)
                                        </label>
                                        <input type="number" value={formData.visitCount} onChange={e => setFormData({...formData, visitCount: e.target.value})} className="w-full bg-slate-700 text-white px-3 py-2 rounded-md border border-slate-600 focus:border-blue-500 focus:ring-2 outline-none" min="0" />
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium text-slate-300 mb-1">
                                            <i className="fas fa-wallet text-emerald-400 mr-2"></i>Total Spent ()
                                        </label>
                                        <input type="number" value={formData.totalSpent} onChange={e => setFormData({...formData, totalSpent: e.target.value})} className="w-full bg-slate-700 text-white px-3 py-2 rounded-md border border-slate-600 focus:border-blue-500 focus:ring-2 outline-none" min="0" />
                                    </div>
                                </div>
                            </ModalBody>
                            <ModalFooter>
                                <button type="button" onClick={resetForm} className="bg-slate-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-slate-500 transition">Cancel</button>
                                <button type="submit" className={`${editId ? 'bg-green-600 hover:bg-green-700' : 'bg-blue-600 hover:bg-blue-700'} text-white font-bold py-2 px-6 rounded-lg transition shadow-lg`}>
                                    {editId ? 'Update Customer' : 'Add Customer'}
                                </button>
                            </ModalFooter>
                        </form>
                    </Modal>
                )}

                <TableCard title="Customer Management">
                    <div className="mb-4 pb-4 border-b border-slate-700 flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                        <div className="flex-1 w-full max-w-sm">
                            <label className="block text-sm font-medium text-slate-300 mb-1">
                                <i className="fas fa-search text-purple-400 mr-2"></i>Search Customer
                            </label>
                            <div className="relative">
                                <input 
                                    type="text" 
                                    placeholder="Search by name or phone..." 
                                    value={searchTerm} 
                                    onChange={e => setSearchTerm(e.target.value)} 
                                    className="w-full bg-slate-700 text-slate-100 px-3 py-2 pl-10 border border-slate-600 rounded-md focus:ring-2 focus:ring-blue-500 outline-none transition" 
                                />
                                <i className="fas fa-search absolute left-3 top-3 text-slate-400"></i>
                            </div>
                        </div>
                        <button onClick={handleAddNew} className="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition flex items-center gap-2 shrink-0">
                            <i className="fas fa-user-plus"></i> Add New Customer
                        </button>
                    </div>
                    {loading ? <p className="text-center p-4">Loading...</p> : filteredCustomers.length === 0 ? <p className="text-center p-4 text-slate-400">No customers found.</p> : (
                        <table className="min-w-full divide-y divide-slate-700">
                            <thead className="bg-slate-900/50">
                                <tr>
                                    <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Name</th>
                                    <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Phone</th>
                                    <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Shop</th>
                                    <th className="px-4 py-3 text-center text-xs font-semibold text-slate-400 uppercase">Visits</th>
                                    <th className="px-4 py-3 text-right text-xs font-semibold text-slate-400 uppercase">Spent</th>
                                    <th className="px-4 py-3 text-center text-xs font-semibold text-slate-400 uppercase">Points</th>
                                    <th className="px-4 py-3 text-center text-xs font-semibold text-slate-400 uppercase">Actions</th>
                                </tr>
                            </thead>
                            <tbody className="divide-y divide-slate-700">
                                {filteredCustomers.map(c => {
                                    const registeredShop = shops.find(s => s.id === c.registeredShopId)?.name || '-';
                                    return (
                                    <tr key={c.id} className="hover:bg-slate-700/50">
                                        <td className="px-4 py-3 text-sm text-slate-200">{c.name}</td>
                                        <td className="px-4 py-3 text-sm text-slate-400">{c.phone}</td>
                                        <td className="px-4 py-3 text-sm text-slate-400">{registeredShop}</td>
                                        <td className="px-4 py-3 text-sm text-slate-300 text-center">{c.visitCount || 0}</td>
                                        <td className="px-4 py-3 text-sm text-emerald-400 text-right font-medium">{new Intl.NumberFormat('en-US', { notation: "compact" }).format(c.totalSpent || 0)}</td>
                                        <td className="px-4 py-3 text-sm text-slate-400 text-center">
                                            <span className="font-bold text-orange-400 bg-orange-400/10 px-2 py-1 rounded border border-orange-400/20">
                                                <i className="fas fa-star text-xs mr-1"></i> {c.points || 0}
                                            </span>
                                        </td>
                                        <td className="px-4 py-3 text-center space-x-4">
                                            <button onClick={() => handleEdit(c)} className="text-blue-400 hover:text-blue-300"><i className="fas fa-edit"></i></button>
                                            <button onClick={() => setModal({ type: 'confirmDelete', data: c.id })} className="text-red-500 hover:text-red-400"><i className="fas fa-trash"></i></button>
                                        </td>
                                    </tr>
                                )})}
                            </tbody>
                        </table>
                    )}
                </TableCard>
            </div>
        );
    };

    // --- 8.1 PO Request Page ---
    const PORequestPage = ({ poDataToEdit, setPage, userProfile }) => {
        const { shops, vendors, products } = useData(); 
        const [poId, setPoId] = useState('');
        const [shopId, setShopId] = useState('');
        const [vendorId, setVendorId] = useState('');
        const [poNumber, setPoNumber] = useState('');
        const [reqDate, setReqDate] = useState(new Date().toLocaleDateString('en-CA'));
        const [items, setItems] = useState([]);
        
        const [productSearch, setProductSearch] = useState('');
        const [searchResults, setSearchResults] = useState([]);
        const [selectedProduct, setSelectedProduct] = useState(null);
        const [quantity, setQuantity] = useState(1);
        const [note, setNote] = useState('');
        
        // New state for vendor search
        const [vendorSearch, setVendorSearch] = useState('');
        const [vendorSearchResults, setVendorSearchResults] = useState([]);
        const [selectedVendor, setSelectedVendor] = useState(null);
        
        const [modalInfo, setModalInfo] = useState({ show: false, title: '', message: '', isError: false });
        
        // --- NEW REF for File Input ---
        const importInputRef = useRef(null);

        const productFuse = useProductSearch();
        const debouncedProductSearch = useDebounce(productSearch, 250);
        
        const vendorFuse = useMemo(() => new Fuse(vendors, { keys: ['name'], threshold: 0.4 }), [vendors]);
        const debouncedVendorSearch = useDebounce(vendorSearch, 250);

        const resetForm = useCallback(() => {
            setPoId(''); setShopId(''); setVendorId(''); setPoNumber('');
            setReqDate(new Date().toLocaleDateString('en-CA'));
            setItems([]); resetAddItemForm();
            setVendorSearch(''); setSelectedVendor(null); setVendorSearchResults([]);
        }, []);
        
        useEffect(() => {
            if (poDataToEdit) {
                const requestDateObj = safeToDate(poDataToEdit.requestDate);
                setPoId(poDataToEdit.id); setShopId(poDataToEdit.shopId); setVendorId(poDataToEdit.vendorId);
                setPoNumber(poDataToEdit.poNumber);
                if (requestDateObj) setReqDate(requestDateObj.toLocaleDateString('en-CA'));
                setItems(poDataToEdit.items);
                const initialVendor = vendors.find(v => v.id === poDataToEdit.vendorId);
                if(initialVendor) {
                    setSelectedVendor(initialVendor);
                    setVendorSearch(initialVendor.name);
                }
            } else {
                resetForm();
            }
        }, [poDataToEdit, resetForm, vendors]);

        useEffect(() => {
            if (!poId && shopId && vendorId) {
                const shop = shops.find(s => s.id === shopId);
                const vendor = vendors.find(v => v.id === vendorId);
                if (shop && vendor) {
                    const now = new Date();
                    const newPoNumber = `${shop.name.replace(/\s+/g, '')}-${vendor.name.replace(/\s+/g, '')}-${now.toISOString().slice(0, 10).replace(/-/g, '')}-${now.getHours()}${now.getMinutes()}${now.getSeconds()}`;
                    setPoNumber(newPoNumber);
                }
            }
        }, [shopId, vendorId, poId, shops, vendors]);
        
        useEffect(() => {
            if (productFuse && debouncedProductSearch.length > 1 && !selectedProduct) {
                const results = productFuse.search(debouncedProductSearch, { limit: 50 });
                setSearchResults(results.map(result => result.item));
            } else {
                setSearchResults([]);
            }
        }, [debouncedProductSearch, productFuse, selectedProduct]);

        useEffect(() => {
            if (vendorFuse && debouncedVendorSearch.length > 1 && !selectedVendor) {
                const results = vendorFuse.search(debouncedVendorSearch, { limit: 10 });
                setVendorSearchResults(results.map(result => result.item));
            } else {
                setVendorSearchResults([]);
            }
        }, [debouncedVendorSearch, vendorFuse, selectedVendor]);

        const handleProductSearch = (e) => {
            setProductSearch(e.target.value);
            setSelectedProduct(null);
        };

        const selectProduct = (product) => {
            setSelectedProduct(product); 
            setProductSearch(product.code);
            setSearchResults([]);
        };

        const handleVendorSearch = (e) => {
            setVendorSearch(e.target.value);
            setSelectedVendor(null);
            setVendorId('');
        };

        const selectVendor = (vendor) => {
            setSelectedVendor(vendor);
            setVendorId(vendor.id);
            setVendorSearch(vendor.name);
            setVendorSearchResults([]);
        };
        
        const resetAddItemForm = () => {
            setSelectedProduct(null); setQuantity(1); setNote(''); setProductSearch('');
        };

        const handleAddItem = (e) => {
            e.preventDefault();
            if (!selectedProduct) {
                setModalInfo({ show: true, title: 'Validation Error', message: 'Please select a product first.', isError: true });
                return;
            }
            const existingItemIndex = items.findIndex(item => item.productId === selectedProduct.id);
            const qty = parseInt(quantity, 10) || 1;
            if (existingItemIndex > -1) {
                const newItems = [...items];
                newItems[existingItemIndex].quantity += qty;
                setItems(newItems);
            } else {
                setItems([...items, {
                    productId: selectedProduct.id, 
                    code: selectedProduct.code, 
                    barcode: selectedProduct.barcode || '',
                    name: selectedProduct.name, 
                    vendorName: selectedProduct.vendorName || '',
                    cost: parseFloat(selectedProduct.cost) || 0, 
                    cb4: parseFloat(selectedProduct.cost) || 0,
                    price: parseFloat(selectedProduct.price) || 0, // <-- FIX: Added Price here
                    quantity: qty, 
                    note
                }]);
            }
            resetAddItemForm();
        };

        // --- NEW: Import & Template Functions ---
        const handleDownloadTemplate = () => {
            const wb = XLSX.utils.book_new();
            const ws_data = [
                ['Product Code', 'Quantity', 'Note'], // Removed Product Name
                ['P001', 10, 'Sample Item'],
                ['P002', 5, '']
            ];
            const ws = XLSX.utils.aoa_to_sheet(ws_data);
            
            // Set column widths
            ws['!cols'] = [{wch: 20}, {wch: 10}, {wch: 30}];
            
            XLSX.utils.book_append_sheet(wb, ws, "PO_Template");
            XLSX.writeFile(wb, "PO_Import_Template.xlsx");
        };

        const handleImport = (e) => {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (evt) => {
                try {
                    const bstr = evt.target.result;
                    const wb = XLSX.read(bstr, { type: 'binary' });
                    const wsname = wb.SheetNames[0];
                    const ws = wb.Sheets[wsname];
                    // Convert to JSON array of arrays
                    const data = XLSX.utils.sheet_to_json(ws, { header: 1 });

                    if (data.length === 0) throw new Error("File is empty.");

                    // Basic header validation (Row 0)
                    const headers = data[0].map(h => h ? h.toString().toLowerCase().trim() : '');
                    const codeIdx = headers.indexOf('product code');
                    
                    if (codeIdx === -1) {
                        setModalInfo({ show: true, title: 'Import Error', message: 'Invalid template. "Product Code" column is missing.', isError: true });
                        return;
                    }

                    const qtyIdx = headers.indexOf('quantity');
                    const costIdx = headers.indexOf('cost');
                    const noteIdx = headers.indexOf('note');

                    const newItems = [];
                    let skippedCount = 0;

                    // Process rows (starting from row 1)
                    for (let i = 1; i < data.length; i++) {
                        const row = data[i];
                        if (!row || row.length === 0) continue;

                        const rawCode = row[codeIdx];
                        if (!rawCode) continue;
                        
                        const codeStr = rawCode.toString().trim();
                        
                        // Find product in system
                        const product = products.find(p => p.code === codeStr);
                        
                        if (product) {
                            const qty = qtyIdx !== -1 ? (parseInt(row[qtyIdx]) || 1) : 1;
                            let inputCost = costIdx !== -1 ? parseFloat(row[costIdx]) : 0;
                            
                            // If cost in file is missing/invalid, use system cost
                            if (isNaN(inputCost) || inputCost <= 0) {
                                inputCost = parseFloat(product.cost) || 0;
                            }

                            const noteText = noteIdx !== -1 && row[noteIdx] ? row[noteIdx].toString() : '';

                            newItems.push({
                                productId: product.id,
                                code: product.code,
                                barcode: product.barcode || '',
                                name: product.name,
                                vendorName: product.vendorName || '',
                                cost: inputCost,
                                cb4: parseFloat(product.cost) || 0, // Keep original cost ref
                                quantity: qty,
                                note: noteText
                            });
                        } else {
                            skippedCount++;
                        }
                    }

                    if (newItems.length > 0) {
                        setItems(prev => [...prev, ...newItems]);
                        setModalInfo({ show: true, title: 'Import Successful', message: `Successfully added ${newItems.length} items.${skippedCount > 0 ? ` Skipped ${skippedCount} items (code not found).` : ''}` });
                    } else {
                        setModalInfo({ show: true, title: 'Import Failed', message: 'No valid products found in the file matching your system codes.', isError: true });
                    }

                } catch (error) {
                    console.error("Import error:", error);
                    setModalInfo({ show: true, title: 'Import Error', message: 'Failed to read file. Please ensure it is a valid Excel file.', isError: true });
                } finally {
                    if (importInputRef.current) importInputRef.current.value = '';
                }
            };
            reader.readAsBinaryString(file);
        };

        // --- NEW FUNCTION: Auto-Fill Low Stock ---
        const handleAutoFillLowStock = () => {
            if (!shopId || !vendorId) {
                setModalInfo({ show: true, title: 'Action Required', message: 'Please select a Shop and Vendor first.', isError: true });
                return;
            }

            const vendorProducts = products.filter(p => p.vendorId === vendorId);
            const lowStockItems = [];
            let addedCount = 0;

            vendorProducts.forEach(p => {
                const minStock = parseInt(p.minStock) || 0;
                // Only consider products that have a Min Stock set
                if (minStock > 0) {
                    // Check stock specifically for the selected Shop
                    const currentShopStock = p.stockByShop?.[shopId] || 0;
                    
                    if (currentShopStock < minStock) {
                        const neededQty = minStock - currentShopStock;
                        
                        // Check if item is already in the current PO list
                        const exists = items.some(item => item.productId === p.id);
                        
                        if (neededQty > 0 && !exists) {
                            lowStockItems.push({
                                productId: p.id,
                                code: p.code,
                                barcode: p.barcode || '',
                                name: p.name,
                                vendorName: p.vendorName || '',
                                cost: parseFloat(p.cost) || 0,
                                cb4: parseFloat(p.cost) || 0,
                                quantity: neededQty,
                                note: 'Auto-refill to Min Stock'
                            });
                            addedCount++;
                        }
                    }
                }
            });

            if (addedCount > 0) {
                setItems(prevItems => [...prevItems, ...lowStockItems]);
                setModalInfo({ show: true, title: 'Auto-Fill Complete', message: `Added ${addedCount} items below minimum stock level.` });
            } else {
                setModalInfo({ show: true, title: 'No Items Added', message: 'No items from this vendor are below minimum stock for this shop, or they are already in the list.' });
            }
        };
        
        const handleRemoveItem = (index) => setItems(items.filter((_, i) => i !== index));

        const handleEditItem = (index) => {
            const itemToEdit = items[index];
            setSelectedProduct({
                id: itemToEdit.productId,
                name: itemToEdit.name,
                code: itemToEdit.code,
                barcode: itemToEdit.barcode,
                vendorName: itemToEdit.vendorName,
                cost: itemToEdit.cost,
                price: itemToEdit.price 
            });
            setProductSearch(itemToEdit.name);
            setQuantity(itemToEdit.quantity);
            setNote(itemToEdit.note || '');
            handleRemoveItem(index);
        };

        const handleSubmitPO = async (status) => {
            if (!shopId || !vendorId) {
                setModalInfo({ show: true, title: 'Validation Error', message: 'Please select Shop and Vendor.', isError: true });
                return;
            }
            if (items.length === 0) {
                setModalInfo({ show: true, title: 'Validation Error', message: 'Please add at least one item.', isError: true });
                return;
            }

            const poData = {
                poNumber, shopId, vendorId, requestDate: new Date(reqDate), items,
                totalAmount, status,
                vendorName: selectedVendor?.name || (vendors.find(v => v.id === vendorId)?.name || ''),
                shopName: shops.find(s => s.id === shopId)?.name || '',
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            };

            try {
                if (poId) {
                    await db.collection("purchaseOrders").doc(poId).update(poData);
                } else {
                    poData.createdByName = userProfile.name;
                    poData.createdBy = userProfile.uid;
                    poData.createdAt = firebase.firestore.FieldValue.serverTimestamp();
                    await db.collection("purchaseOrders").add(poData);
                }
                setModalInfo({ show: true, title: 'Success', message: `PO successfully ${status}!` });
                resetForm();
                setPage('inventory', { activeTab: status === 'draft' ? 'drafts-po' : 'active-po' });
            } catch (error) {
                console.error("Error saving PO:", error);
                setModalInfo({ show: true, title: 'Error', message: 'Failed to save PO.', isError: true });
            }
        };
        
        const totalAmount = useMemo(() => items.reduce((sum, item) => sum + (item.cost * item.quantity), 0), [items]);

        return (
            <div className="space-y-6">
                <MessageModal {...modalInfo} show={modalInfo.show} onClose={() => setModalInfo({ show: false })} />
                <Card>
                    <CardTitle>{poDataToEdit ? `Edit PO: ${poDataToEdit.poNumber}` : 'Create Purchase Order'}</CardTitle>
                    {/* UPDATE: Changed grid-cols-1 to grid-cols-2 for mobile to save space */}
                    <div className="grid grid-cols-2 lg:grid-cols-4 gap-4 md:gap-6">
                        <div>
                            <label className="block text-sm font-medium text-slate-300 mb-1">
                                <i className="fas fa-store-alt text-orange-400 mr-2"></i>Shop Name
                            </label>
                            <select value={shopId} onChange={(e) => setShopId(e.target.value)} className="w-full bg-slate-700 text-slate-100 px-3 py-2 border border-slate-600 rounded-md">
                                <option value="">Select Shop</option>
                                {shops
                                    .filter(s => userProfile.role === 'Admin' || (userProfile.assignedShops || []).includes(s.id))
                                    .map(s => <option key={s.id} value={s.id}>{s.name}</option>)}
                            </select>
                        </div>
                        <div className="relative">
                            <label className="block text-sm font-medium text-slate-300 mb-1">
                                <i className="fas fa-truck text-emerald-400 mr-2"></i>Vendor
                            </label>
                            <input type="text" value={vendorSearch} onChange={handleVendorSearch} className="w-full bg-slate-700 text-slate-100 px-3 py-2 border border-slate-600 rounded-md" placeholder="Search vendor..." autoComplete="off" />
                            {vendorSearchResults.length > 0 && (
                                <div className="absolute z-20 w-full bg-slate-800 border border-slate-600 rounded-md mt-1 shadow-lg max-h-60 overflow-y-auto">
                                    {vendorSearchResults.map(v => (
                                        <div key={v.id} onClick={() => selectVendor(v)} className="p-2 cursor-pointer hover:bg-slate-700">
                                            <p className="font-semibold text-slate-200">{v.name}</p>
                                        </div>
                                    ))}
                                </div>
                            )}
                        </div>
                        <div>
                            <label className="block text-sm font-medium text-slate-300 mb-1">
                                <i className="fas fa-hashtag text-purple-400 mr-2"></i>PO No.
                            </label>
                            <input type="text" value={poNumber} readOnly className="w-full px-3 py-2 border border-slate-600 rounded-md bg-slate-700 text-slate-300" />
                        </div>
                        <div>
                            <label className="block text-sm font-medium text-slate-300 mb-1">
                                <i className="fas fa-calendar-day text-blue-400 mr-2"></i>Req Date
                            </label>
                            <input type="date" value={reqDate} onChange={e => setReqDate(e.target.value)} className="w-full px-3 py-2 border border-slate-600 rounded-md bg-slate-700 text-slate-200" style={{colorScheme: 'dark'}}/>
                        </div>
                    </div>
                </Card>

                <Card>
                    <div className="flex flex-col md:flex-row justify-between items-center mb-4 gap-2">
                        <h4 className="text-xl font-semibold text-slate-200">Add Product to PO</h4>
                        
                        {/* ACTION BUTTONS: Auto-Fill, Template, Import */}
                        <div className="flex flex-wrap gap-2 justify-end w-full md:w-auto">
                            <input 
                                type="file" 
                                ref={importInputRef} 
                                onChange={handleImport} 
                                style={{ display: 'none' }} 
                                accept=".xlsx, .xls" 
                            />
                            
                            <button 
                                type="button" 
                                onClick={handleDownloadTemplate} 
                                className="bg-cyan-600 text-white font-bold py-2 px-3 rounded-lg hover:bg-cyan-700 transition flex items-center gap-2 text-xs md:text-sm"
                                title="Download Excel Template"
                            >
                                <i className="fas fa-file-download"></i> Template
                            </button>
                            
                            <button 
                                type="button" 
                                onClick={() => importInputRef.current.click()} 
                                className="bg-indigo-600 text-white font-bold py-2 px-3 rounded-lg hover:bg-indigo-700 transition flex items-center gap-2 text-xs md:text-sm"
                                title="Import Items from Excel"
                            >
                                <i className="fas fa-file-import"></i> Import
                            </button>

                            <button 
                                type="button" 
                                onClick={handleAutoFillLowStock} 
                                className="bg-orange-600 text-white font-bold py-2 px-3 rounded-lg hover:bg-orange-700 transition flex items-center gap-2 text-xs md:text-sm"
                                title="Automatically add items below Min Stock"
                            >
                                <i className="fas fa-magic"></i> Auto-Fill Low Stock
                            </button>
                        </div>
                    </div>
                    
                    <form onSubmit={handleAddItem} className="grid grid-cols-1 lg:grid-cols-12 gap-4 items-end">
                        <div className="lg:col-span-3 relative">
                            <label className="block text-sm font-medium text-slate-300 mb-1">
                                <i className="fas fa-search text-teal-400 mr-2"></i>Product Search
                            </label>
                            <input type="text" value={productSearch} onChange={handleProductSearch} className="w-full bg-slate-700 text-slate-100 px-3 py-2 border border-slate-600 rounded-md" autoComplete="off" />
                            {searchResults.length > 0 && (
                                <div className="absolute z-10 w-full bg-slate-800 border border-slate-600 rounded-md mt-1 shadow-lg max-h-60 overflow-y-auto">
                                    {searchResults.map(p => (
                                        <div key={p.id} onClick={() => selectProduct(p)} className="p-2 cursor-pointer hover:bg-slate-700">
                                            <p className="font-semibold text-slate-200">{p.name}</p>
                                            <div className="text-sm text-slate-400">
                                                <div>{p.code}</div>
                                                <div>{p.barcode || 'N/A'}</div>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            )}
                        </div>
                        <div className="lg:col-span-4">
                            <label className="block text-sm font-medium text-slate-300 mb-1">
                                <i className="fas fa-box-open text-indigo-400 mr-2"></i>Selected Product
                            </label>
                            <input type="text" value={selectedProduct?.name || ''} readOnly className="w-full px-3 py-2 border border-slate-600 rounded-md bg-slate-700 text-slate-300" />
                        </div>
                        <div className="lg:col-span-1">
                            <label className="block text-sm font-medium text-slate-300 mb-1">
                                <i className="fas fa-sort-numeric-up text-yellow-400 mr-2"></i>QTY
                            </label>
                            <input type="number" value={quantity} onChange={e => setQuantity(e.target.value)} min="1" className="w-full bg-slate-700 text-slate-100 px-3 py-2 border border-slate-600 rounded-md" />
                        </div>
                        <div className="lg:col-span-3">
                            <label className="block text-sm font-medium text-slate-300 mb-1">
                                <i className="fas fa-sticky-note text-pink-400 mr-2"></i>Note
                            </label>
                            <input type="text" value={note} onChange={e => setNote(e.target.value)} className="w-full bg-slate-700 text-slate-100 px-3 py-2 border border-slate-600 rounded-md" />
                        </div>
                        <div className="lg:col-span-1">
                            <button type="submit" className="w-full bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 transition">Add</button>
                        </div>
                    </form>
                </Card>

                <TableCard title="PO Items">
                    {items.length === 0 ? (
                        <p className="p-4 text-slate-400 text-center">No products added yet.</p>
                    ) : (
                        <table className="min-w-full divide-y divide-slate-700 md:divide-y-0 responsive-table">
                            <thead className="bg-slate-900/50">
                                <tr>
                                    <th className="px-2 py-3 text-left text-xs font-semibold text-slate-400 uppercase">No.</th>
                                    <th className="px-2 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Code</th>
                                    <th className="px-2 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Barcode</th>
                                    <th className="px-2 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Name</th>
                                    <th className="px-2 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Vendor</th>
                                    <th className="px-2 py-3 text-center text-xs font-semibold text-slate-400 uppercase">QTY</th>
                                    <th className="px-2 py-3 text-right text-xs font-semibold text-slate-400 uppercase">Price ()</th>
                                    <th className="px-2 py-3 text-right text-xs font-semibold text-slate-400 uppercase">Cost ()</th>
                                    <th className="px-2 py-3 text-right text-xs font-semibold text-slate-400 uppercase">Sub-Total</th>
                                    <th className="px-2 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Note</th>
                                    <th className="px-2 py-3 text-center text-xs font-semibold text-slate-400 uppercase">Actions</th>
                                </tr>
                            </thead>
                            <tbody className="divide-y divide-slate-700">
                                {items.map((item, index) => (
                                    <tr key={index} className="hover:bg-slate-700/50">
                                        <td className="px-2 py-2 text-sm text-slate-400" data-label="No.">{index + 1}</td>
                                        <td className="px-2 py-2 text-sm text-slate-300" data-label="Code">{item.code}</td>
                                        <td className="px-2 py-2 text-sm text-slate-300" data-label="Barcode">{item.barcode || ''}</td>
                                        <td className="px-2 py-2 text-sm text-slate-300" data-label="Name">{item.name}</td>
                                        <td className="px-2 py-2 text-sm text-slate-400" data-label="Vendor">{item.vendorName}</td>
                                        <td className="px-2 py-2 text-sm text-slate-300 md:text-center" data-label="QTY">{item.quantity}</td>
                                        <td className="px-2 py-2 text-sm text-slate-300 md:text-right" data-label="Price ()">{khrFormatter.format(item.price || 0)}</td>
                                        <td className="px-2 py-2 text-sm text-slate-300 md:text-right" data-label="Cost ()">{khrFormatter.format(item.cost)}</td>
                                        <td className="px-2 py-2 text-sm text-slate-300 md:text-right" data-label="Sub-Total">{khrFormatter.format(item.cost * item.quantity)}</td>
                                        <td className="px-2 py-2 text-sm text-slate-300" data-label="Note">{item.note || ''}</td>
                                        <td className="px-2 py-2 md:text-center space-x-4 actions-cell" data-label="Actions">
                                            <button type="button" onClick={() => handleEditItem(index)} className="text-blue-400 hover:text-blue-300"><i className="fas fa-edit"></i></button>
                                            <button type="button" onClick={() => handleRemoveItem(index)} className="text-red-500 hover:text-red-400"><i className="fas fa-trash"></i></button>
                                        </td>
                                    </tr>
                                ))}
                            </tbody>
                            <tfoot className="hidden md:table-footer-group bg-slate-900/50">
                                <tr>
                                    <td colSpan="9" className="px-2 py-3 text-right text-sm font-bold text-slate-300 uppercase">Grand Total</td>
                                    <td className="px-2 py-3 text-right text-sm font-bold text-slate-200">{khrFormatter.format(totalAmount)}</td>
                                    <td colSpan="2"></td>
                                </tr>
                            </tfoot>
                        </table>
                    )}
                </TableCard>
                
                <div className="mt-8 flex flex-col sm:flex-row justify-end gap-3">
                    {/* FIX: Redirect Cancel to the Drafts list within Inventory */}
                    <button 
                        onClick={() => setPage('inventory', { activeTab: 'drafts-po' })} 
                        className="bg-slate-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-slate-500 transition"
                    >
                        Cancel
                    </button>
                    
                    <button onClick={() => handleSubmitPO('draft')} className="bg-yellow-500 text-white font-bold py-2 px-6 rounded-lg hover:bg-yellow-600 transition">Save Draft</button>
                    <button onClick={() => handleSubmitPO('submitted')} className="bg-green-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-green-700 transition">Submit PO</button>
                </div>
            </div> // This closes the main div of PORequestPage
        );
    };

    // --- 8.2 PO Center Page ---
    const POCenterPage = ({ setPage, pageData, userProfile }) => {
        const [activeTab, setActiveTab] = useState('create-po');
        const [poDataForEdit, setPoDataForEdit] = useState(null);
        
        // Get POs from the global context instead of fetching here.
        const { allPOs, posLoading } = useData();

        useEffect(() => {
            if (pageData && pageData.activeTab) {
                setActiveTab(pageData.activeTab);
                if (pageData.poData) {
                    setPoDataForEdit(pageData.poData);
                }
            }
        }, [pageData]);

        const handleSetPage = (page, data) => {
            if (page !== 'po-center' || (data && data.activeTab !== 'create-po')) {
                setPoDataForEdit(null);
            }
            setPage(page, data);
        };
        
        return (
            <div className="space-y-6">
                <Card>
                    <nav className="flex flex-nowrap md:flex-wrap -mb-px border-b border-slate-700 overflow-x-auto no-scrollbar" aria-label="Tabs">
                        <a href="#" onClick={() => { setActiveTab('create-po'); setPoDataForEdit(null); }} className={`tab-link-dark whitespace-nowrap py-4 px-3 md:px-4 border-b-2 text-sm font-medium ${activeTab === 'create-po' ? 'active-tab-dark' : ''}`}>Create PO</a>
                        <a href="#" onClick={() => setActiveTab('drafts-po')} className={`tab-link-dark whitespace-nowrap py-4 px-3 md:px-4 border-b-2 text-sm font-medium ${activeTab === 'drafts-po' ? 'active-tab-dark' : ''}`}>Drafts PO</a>
                        <a href="#" onClick={() => setActiveTab('active-po')} className={`tab-link-dark whitespace-nowrap py-4 px-3 md:px-4 border-b-2 text-sm font-medium ${activeTab === 'active-po' ? 'active-tab-dark' : ''}`}>Active PO</a>
                        <a href="#" onClick={() => setActiveTab('auditing-po')} className={`tab-link-dark whitespace-nowrap py-4 px-3 md:px-4 border-b-2 text-sm font-medium ${activeTab === 'auditing-po' ? 'active-tab-dark' : ''}`}>Auditing PO</a>
                        <a href="#" onClick={() => setActiveTab('audited-po')} className={`tab-link-dark whitespace-nowrap py-4 px-3 md:px-4 border-b-2 text-sm font-medium ${activeTab === 'audited-po' ? 'active-tab-dark' : ''}`}>Audited PO</a>
                    </nav>
                </Card>
                
                {activeTab === 'create-po' && <PORequestPage poDataToEdit={poDataForEdit} setPage={handleSetPage} userProfile={userProfile} />}
                {activeTab === 'drafts-po' && <POList pos={allPOs} loading={posLoading} status="draft" setPage={handleSetPage} userProfile={userProfile} />}
                {activeTab === 'active-po' && <POList pos={allPOs} loading={posLoading} status="submitted" setPage={handleSetPage} userProfile={userProfile} />}
                {activeTab === 'auditing-po' && <POList pos={allPOs} loading={posLoading} status="auditing" setPage={handleSetPage} userProfile={userProfile} />}
                {activeTab === 'audited-po' && <POList pos={allPOs} loading={posLoading} status="audited" setPage={handleSetPage} userProfile={userProfile} />}
            </div>
        );
    };

    // --- 8.3 PO List Component (used in PO Center) ---
    const POList = ({ status, setPage, userProfile, pos, loading }) => {
        const { shops } = useData();
        // The useCollection hook is now removed from here and passed in via props.
        const [modal, setModal] = useState({ type: null, data: null, title: '', message: '' });
        const [viewPO, setViewPO] = useState(null);

        const [shopFilter, setShopFilter] = useState('');
        const [dateFilter, setDateFilter] = useState('');
        const [monthFilter, setMonthFilter] = useState('');
        const [yearFilter, setYearFilter] = useState('');
        const [searchTerm, setSearchTerm] = useState(''); // Added search state

        const debouncedSearch = useDebounce(searchTerm, 300); // Debounce search input
        
        const filteredPOs = useMemo(() => {
            let filtered = pos.filter(p => p.status === status);

            // Filter by assigned shops for non-admins
            if (userProfile.role !== 'Admin') {
                const assignedShops = userProfile.assignedShops || [];
                filtered = filtered.filter(p => assignedShops.includes(p.shopId));
            }

            if (shopFilter) filtered = filtered.filter(p => p.shopId === shopFilter);

            // Filter by Search Term (PO Number)
            if (debouncedSearch) {
                const lowerSearch = debouncedSearch.toLowerCase();
                filtered = filtered.filter(p => p.poNumber.toLowerCase().includes(lowerSearch));
            }

            if (dateFilter) {
                const now = new Date();
                let startDate, endDate;
                switch(dateFilter) {
                    case 'today':
                        startDate = new Date(now.setHours(0, 0, 0, 0));
                        endDate = new Date(now.setHours(23, 59, 59, 999));
                        break;
                    case 'thisWeek':
                        const firstDayOfWeek = now.getDate() - now.getDay();
                        startDate = new Date(now.setDate(firstDayOfWeek));
                        startDate.setHours(0, 0, 0, 0);
                        endDate = new Date(startDate);
                        endDate.setDate(startDate.getDate() + 6);
                        endDate.setHours(23, 59, 59, 999);
                        break;
                    case 'thisMonth':
                        startDate = new Date(now.getFullYear(), now.getMonth(), 1);
                        endDate = new Date(now.getFullYear(), now.getMonth() + 1, 0, 23, 59, 59, 999);
                        break;
                    case 'lastMonth':
                        startDate = new Date(now.getFullYear(), now.getMonth() - 1, 1);
                        endDate = new Date(now.getFullYear(), now.getMonth(), 0, 23, 59, 59, 999);
                        break;
                }
                if (startDate && endDate) {
                    filtered = filtered.filter(p => {
                        const poDate = safeToDate(p.requestDate);
                        return poDate && poDate >= startDate && poDate <= endDate;
                    });
                }
            } else if (monthFilter && yearFilter) {
                const startDate = new Date(yearFilter, monthFilter, 1);
                const endDate = new Date(yearFilter, parseInt(monthFilter) + 1, 0, 23, 59, 59, 999);
                filtered = filtered.filter(p => {
                    const poDate = safeToDate(p.requestDate);
                    return poDate && poDate >= startDate && poDate <= endDate;
                });
            }

            // Sort by the most recent activity date (updatedAt, fallback to createdAt)
            filtered.sort((a, b) => {
                const dateA = safeToDate(a.updatedAt || a.createdAt);
                const dateB = safeToDate(b.updatedAt || b.createdAt);
                if (!dateB) return -1;
                if (!dateA) return 1;
                return dateB - dateA;
            });
            
            return filtered;
        }, [pos, status, shopFilter, dateFilter, monthFilter, yearFilter, userProfile, debouncedSearch]);

        const clearFilters = () => {
            setShopFilter(''); setDateFilter(''); setMonthFilter(''); setYearFilter(''); setSearchTerm('');
        };
        
        const handleDelete = async (poId) => {
            try {
                await db.collection("purchaseOrders").doc(poId).delete();
                setModal({ type: 'message', data: { title: 'Success', message: 'PO deleted successfully.' } });
            } catch (error) {
                setModal({ type: 'message', data: { title: 'Error', message: 'Failed to delete PO.', isError: true } });
            }
        };

        // FIX: Redirect to inventory
        const handleEdit = (poData) => setPage('inventory', { activeTab: 'create-po', poData: poData });
        
        const openDeleteModal = (po) => setModal({ type: 'confirmDelete', data: po.id, title: `Delete PO`, message: `Are you sure you want to permanently delete PO #${po.poNumber}?` });

        const statusStyles = {
            draft: 'bg-yellow-500/20 text-yellow-300 border border-yellow-500/30',
            submitted: 'bg-blue-500/20 text-blue-300 border border-blue-500/30',
            auditing: 'bg-purple-500/20 text-purple-300 border border-purple-500/30',
            audited: 'bg-green-500/20 text-green-300 border border-green-500/30'
        };
        
        return (
            <React.Fragment>
                <MessageModal {...modal.data} show={modal.type === 'message'} onClose={() => setModal({ type: null })} />
                <ConfirmationModal 
                    title={modal.title} message={modal.message} show={modal.type === 'confirmDelete'} 
                    onConfirm={() => {handleDelete(modal.data); setModal({type: null})}} 
                    onCancel={() => setModal({ type: null })} 
                />
                {viewPO && <POPreviewModal po={viewPO} onClose={() => setViewPO(null)} />}
                
                <Card>
                    <div className="mb-4 border-b border-slate-700 pb-4">
                        <label className="block text-sm font-medium text-slate-300 mb-1">
                            <i className="fas fa-hashtag text-purple-400 mr-2"></i>Search PO Number
                        </label>
                        <div className="relative">
                            <input 
                                type="text" 
                                value={searchTerm} 
                                onChange={e => setSearchTerm(e.target.value)} 
                                className="w-full bg-slate-700 text-slate-100 px-3 py-2 pl-10 border border-slate-600 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none" 
                                placeholder="Search by PO Number..." 
                            />
                            <i className="fas fa-search absolute left-3 top-3 text-slate-400"></i>
                        </div>
                    </div>

                    <div className="grid grid-cols-1 lg:grid-cols-12 gap-4 items-end">
                        <div className="lg:col-span-3">
                            <label className="block text-sm font-medium text-slate-300 mb-1">
                                <i className="fas fa-store-alt text-orange-400 mr-2"></i>Filter by Shop
                            </label>
                                <select value={shopFilter} onChange={e => setShopFilter(e.target.value)} className="w-full bg-slate-700 text-slate-100 px-3 py-2 border border-slate-600 rounded-md">
                                    <option value="">All Assigned Shops</option>
                                    {shops
                                        .filter(s => userProfile.role === 'Admin' || (userProfile.assignedShops || []).includes(s.id)) // <-- Added filter here
                                        .map(s => <option key={s.id} value={s.id}>{s.name}</option>)}
                                </select>
                            </div>
                            <div className="lg:col-span-4">
                                <label className="block text-sm font-medium text-slate-300 mb-1">
                                    <i className="fas fa-calendar-day text-blue-400 mr-2"></i>Filter by Date
                                </label>
                                <div className="flex flex-wrap gap-2">
                                    <button onClick={() => setDateFilter('today')} className={`px-3 py-2 text-xs rounded-md ${dateFilter === 'today' ? 'bg-blue-600' : 'bg-slate-600'} hover:bg-slate-500`}>Today</button>
                                    <button onClick={() => setDateFilter('thisWeek')} className={`px-3 py-2 text-xs rounded-md ${dateFilter === 'thisWeek' ? 'bg-blue-600' : 'bg-slate-600'} hover:bg-slate-500`}>This Week</button>
                                    <button onClick={() => setDateFilter('thisMonth')} className={`px-3 py-2 text-xs rounded-md ${dateFilter === 'thisMonth' ? 'bg-blue-600' : 'bg-slate-600'} hover:bg-slate-500`}>This Month</button>
                                    <button onClick={() => setDateFilter('lastMonth')} className={`px-3 py-2 text-xs rounded-md ${dateFilter === 'lastMonth' ? 'bg-blue-600' : 'bg-slate-600'} hover:bg-slate-500`}>Last Month</button>
                                </div>
                            </div>
                            <div className="lg:col-span-3">
                                <label className="block text-sm font-medium text-slate-300 mb-1">
                                    <i className="fas fa-calendar-alt text-emerald-400 mr-2"></i>Filter by Month/Year
                                </label>
                                <div className="flex gap-2">
                                    <select value={monthFilter} onChange={e => {setMonthFilter(e.target.value); setDateFilter('')}} className="w-full bg-slate-700 text-slate-100 px-3 py-2 border border-slate-600 rounded-md">
                                        <option value="">Month</option>
                                        {Array.from({length: 12}, (_, i) => <option key={i} value={i}>{new Date(0, i).toLocaleString('default', { month: 'long' })}</option>)}
                                    </select>
                                    <select value={yearFilter} onChange={e => {setYearFilter(e.target.value); setDateFilter('')}} className="w-full bg-slate-700 text-slate-100 px-3 py-2 border border-slate-600 rounded-md">
                                        <option value="">Year</option>
                                        {Array.from({length: 5}, (_, i) => new Date().getFullYear() - i).map(y => <option key={y} value={y}>{y}</option>)}
                                    </select>
                                </div>
                            </div>
                            <div className="lg:col-span-2">
                                <label className="block text-sm font-medium text-slate-300 mb-1">&nbsp;</label>
                                <button onClick={clearFilters} className="w-full bg-slate-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-slate-400 flex items-center justify-center gap-2">
                                    <i className="fas fa-times-circle"></i> Clear
                                </button>
                            </div>
                        </div>
                    </Card>

                <TableCard title={`${status.charAt(0).toUpperCase() + status.slice(1)} POs`}>
                    {loading ? <p className="text-center p-4 text-slate-400">Loading...</p> : filteredPOs.length === 0 ? <p className="text-center p-4 text-slate-400">No purchase orders found.</p> : (
                        <table className="min-w-full responsive-table">
                            <thead className="bg-slate-900/50">
                                <tr>
                                    <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">PO Number</th>
                                    <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Req Date</th>
                                    <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Shop</th>
                                    <th className="px-4 py-3 text-right text-xs font-semibold text-slate-400 uppercase">Total</th>
                                    <th className="px-4 py-3 text-center text-xs font-semibold text-slate-400 uppercase">Status</th>
                                    <th className="px-4 py-3 text-center text-xs font-semibold text-slate-400 uppercase">Actions</th>
                                </tr>
                            </thead>
                            <tbody className="divide-y divide-slate-700">
                                {filteredPOs.map(po => (
                                    <tr key={po.id} className="hover:bg-slate-700/50">
                                        <td className="px-4 py-3 text-sm text-slate-200" data-label="PO Number">{po.poNumber}</td>
                                        <td className="px-4 py-3 text-sm text-slate-400" data-label="Req Date">{formatDateDDMMYYYY(po.requestDate)}</td>
                                        <td className="px-4 py-3 text-sm text-slate-400" data-label="Shop">{po.shopName}</td>
                                        <td className="px-4 py-3 text-sm text-slate-300 md:text-right" data-label="Total">{khrFormatter.format(po.status === 'audited' && po.totalAuditedAmount ? po.totalAuditedAmount : po.totalAmount)}</td>
                                        <td className="px-4 py-3 md:text-center" data-label="Status"><span className={`px-3 py-1 inline-flex text-xs leading-5 font-semibold rounded-full ${statusStyles[po.status]}`}>{po.status}</span></td>
                                        <td className="px-4 py-3 md:text-center space-x-4 actions-cell" data-label="Actions">
                                            {po.status === 'draft' && (
                                                <>
                                                    <button onClick={() => handleEdit(po)} className="text-blue-400 hover:text-blue-300" title="Edit"><i className="fas fa-edit"></i></button>
                                                    <button onClick={() => openDeleteModal(po)} className="text-red-500 hover:text-red-400" title="Delete"><i className="fas fa-trash"></i></button>
                                                </>
                                            )}
                                            {po.status === 'submitted' && (
                                                <>
                                                    <button onClick={() => setPage('po-audit', po)} className="text-indigo-400 hover:text-indigo-300" title="Audit"><i className="fas fa-check-double"></i></button>
                                                    <button onClick={() => setViewPO(po)} className="text-cyan-400 hover:text-cyan-300" title="View/Print PO"><i className="fas fa-print"></i></button>
                                                    <button onClick={() => openDeleteModal(po)} className="text-red-500 hover:text-red-400" title="Delete"><i className="fas fa-trash"></i></button>
                                                </>
                                            )}
                                            {po.status === 'auditing' && (
                                                <>
                                                    <button onClick={() => setPage('po-audit', po)} className="text-purple-400 hover:text-purple-300" title="Continue Audit"><i className="fas fa-play"></i></button>
                                                    <button onClick={() => setViewPO(po)} className="text-cyan-400 hover:text-cyan-300" title="View/Print PO"><i className="fas fa-print"></i></button>
                                                    <button onClick={() => openDeleteModal(po)} className="text-red-500 hover:text-red-400" title="Delete"><i className="fas fa-trash"></i></button>
                                                </>
                                            )}
                                            {po.status === 'audited' && (
                                                <>
                                                    <button onClick={() => setViewPO(po)} className="text-green-400 hover:text-green-300" title="View/Print PO"><i className="fas fa-print"></i></button>
                                                    {userProfile?.role === 'Admin' && (
                                                        <>
                                                            {/* FIX: Added Edit Audit button for Admins */}
                                                            <button onClick={() => setPage('po-audit', po)} className="text-blue-400 hover:text-blue-300" title="Edit Audit Results"><i className="fas fa-edit"></i></button>
                                                            <button onClick={() => openDeleteModal(po)} className="text-red-500 hover:text-red-400" title="Delete"><i className="fas fa-trash"></i></button>
                                                        </>
                                                    )}
                                                </>
                                            )}
                                        </td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    )}
                </TableCard>
            </React.Fragment>
        );
    };

    // --- 8.4 PO Preview Modal ---
    const POPreviewModal = ({ po, onClose }) => {
        const { shops, vendors } = useData();
        const [loading, setLoading] = useState(false);
        const [isCapturing, setIsCapturing] = useState(false);
        const previewRef = useRef(null);

        const shopDetails = useMemo(() => shops.find(s => s.id === po.shopId) || {}, [shops, po.shopId]);
        const vendorDetails = useMemo(() => vendors.find(v => v.id === po.vendorId) || {}, [vendors, po.vendorId]);

        const handleDownloadImage = () => {
            setLoading(true);
            setIsCapturing(true);
            setTimeout(() => {
                if (previewRef.current) {
                    html2canvas(previewRef.current, { scale: 2, backgroundColor: '#ffffff', useCORS: true })
                    .then(canvas => {
                        const link = document.createElement('a');
                        link.download = `PO-${po.poNumber}.png`;
                        link.href = canvas.toDataURL('image/png');
                        link.click();
                    }).catch(err => console.error("Failed to generate image:", err))
                    .finally(() => { setLoading(false); setIsCapturing(false); });
                } else {
                    setLoading(false);
                    setIsCapturing(false);
                }
            }, 100);
        };

        const handlePrintPdf = () => {
            setLoading(true);
            setIsCapturing(true);
            // Use a short timeout to ensure the DOM is fully rendered before capture
            setTimeout(() => {
                const input = previewRef.current;
                if (!input) {
                    setLoading(false);
                    setIsCapturing(false);
                    return;
                }
                
                // Force text color to black for PDF generation
                const originalColor = input.style.color;
                input.style.color = 'black';

                const canvasOptions = {
                    scale: 2, // OPTIMIZATION: Reduced scale from 3 to 2.
                    backgroundColor: '#ffffff',
                    useCORS: true,
                    windowHeight: input.scrollHeight 
                };

                html2canvas(input, canvasOptions).then(sourceCanvas => {
                    const { jsPDF } = window.jspdf;
                    
                    const pdf = new jsPDF({
                        orientation: 'landscape',
                        unit: 'mm',
                        format: 'a4'
                    });

                    const topMargin = 10, bottomMargin = 10, leftMargin = 10, rightMargin = 10;
                    const pdfWidth = pdf.internal.pageSize.getWidth();
                    const pdfHeight = pdf.internal.pageSize.getHeight();
                    
                    const usableWidth = pdfWidth - leftMargin - rightMargin;
                    const usableHeight = pdfHeight - topMargin - bottomMargin;
                    
                    const sourceCanvasWidth = sourceCanvas.width;
                    const sourceCanvasHeight = sourceCanvas.height;

                    // --- NEW LOGIC TO PREVENT ROW SPLITTING ---

                    // Calculate the height of one PDF page in the same pixel scale as the canvas
                    const pageHeightInPixels = sourceCanvasWidth * (usableHeight / usableWidth);
                    
                    const table = input.querySelector('table');
                    const rows = table ? Array.from(table.querySelectorAll('tbody tr')) : [];
                    
                    // --- FIX: Use getBoundingClientRect for accurate positioning relative to the captured element ---
                    const inputTop = input.getBoundingClientRect().top;
                    const rowBottomsOnCanvas = rows.map(row => (row.getBoundingClientRect().bottom - inputTop) * canvasOptions.scale);
                    const tableTopOnCanvas = table ? (table.getBoundingClientRect().top - inputTop) * canvasOptions.scale : -1;

                    let yOffset = 0;
                    const pages = []; // Store page data before rendering to get total page count

                    // Loop through the canvas, creating page slices that respect row boundaries
                    while (yOffset < sourceCanvasHeight) {
                        let potentialSliceEnd = yOffset + pageHeightInPixels;
                        let actualSliceEnd = potentialSliceEnd;

                        // Adjust slice end to avoid cutting table rows if we are within the table area
                        if (table && potentialSliceEnd > tableTopOnCanvas && potentialSliceEnd < sourceCanvasHeight) {
                            // Find the last row that fits completely within this potential slice
                            const lastFittingRowBottom = rowBottomsOnCanvas
                                .filter(bottom => bottom > yOffset && bottom <= potentialSliceEnd)
                                .pop();
                            
                            if (lastFittingRowBottom) {
                                // If we found a row to break after, set the slice end to its bottom
                                actualSliceEnd = lastFittingRowBottom;
                            }
                            // If no row fits (i.e., a single row is taller than the page), we must cut it, so we revert to the original calculated slice end.
                        }

                        const sliceHeight = Math.min(actualSliceEnd - yOffset, sourceCanvasHeight - yOffset);

                        if (sliceHeight <= 0) {
                            break; // Safety break to prevent infinite loops
                        }

                        // Create a temporary canvas for the current page's slice
                        const tempCanvas = document.createElement('canvas');
                        tempCanvas.width = sourceCanvasWidth;
                        tempCanvas.height = sliceHeight;
                        const tempCtx = tempCanvas.getContext('2d');
                        
                        tempCtx.drawImage(sourceCanvas, 0, yOffset, sourceCanvasWidth, sliceHeight, 0, 0, sourceCanvasWidth, sliceHeight);
                        
                        // Store the image data URL and its height for later rendering
                        pages.push({
                            dataUrl: tempCanvas.toDataURL('image/jpeg', 0.90),
                            height: sliceHeight
                        });

                        yOffset += sliceHeight;
                    }

                    // Now, render all the calculated pages to the PDF with the correct total page count
                    pages.forEach((page, index) => {
                        if (index > 0) {
                            pdf.addPage();
                        }
                        
                        // Use the stored height for each specific page to calculate its dimensions in the PDF
                        const sliceHeightOnPdf = usableWidth / (sourceCanvasWidth / page.height);
                        
                        pdf.addImage(page.dataUrl, 'JPEG', leftMargin, topMargin, usableWidth, sliceHeightOnPdf);
                        
                        // Add page number footer to each page
                        pdf.setFontSize(8);
                        pdf.setTextColor(0);
                        const pageNumberText = `Page ${index + 1} of ${pages.length}`;
                        const textWidth = pdf.getStringUnitWidth(pageNumberText) * pdf.internal.getFontSize() / pdf.internal.scaleFactor;
                        const textX = (pdfWidth - textWidth) / 2; // Center horizontally
                        const textY = pdfHeight - bottomMargin + 4; // Position it within the bottom margin area
                        pdf.text(pageNumberText, textX, textY);
                    });

                    pdf.save(`PO-${po.poNumber}.pdf`);
                }).catch(err => {
                    console.error("Failed to generate PDF:", err);
                }).finally(() => {
                    // Revert text color back to its original state for the UI
                    if (input) {
                        input.style.color = originalColor;
                    }
                    setLoading(false);
                    setIsCapturing(false);
                });
            }, 150);
        };

        const handleExportToExcel = () => {
            const fontStyle = { name: "Arial", sz: 11 };
            const centeredWhiteOnDarkStyle = {
                font: { ...fontStyle, color: { rgb: "FFFFFF" } },
                alignment: { horizontal: "center", vertical: "center" },
                fill: { fgColor: { rgb: "2A3347" } }
            };
            const defaultStyle = { font: fontStyle };
            const headerStyle = { font: { ...fontStyle, bold: true } };

            const formattedDate = formatDateDDMMYYYY(po.requestDate);
            
            const wb = XLSX.utils.book_new();
            const ws_data = [];

            ws_data.push([{v: 'Purchase Order', s: { font: { ...fontStyle, sz: 16, bold: true } } }]);
            if (po.status === 'audited') {
                ws_data.push([{v: 'Audited', s: { font: { ...fontStyle, color: { rgb: "22C55E" }}}}]);
            }
            ws_data.push([]);

            ws_data.push([
                {v: 'Vendor:', s: headerStyle}, {v: vendorDetails.name || po.vendorName, s: defaultStyle}, null,
                {v: 'PO No.:', s: headerStyle}, {v: po.poNumber, s: defaultStyle}
            ]);
            ws_data.push([
                {v: 'Contact:', s: headerStyle}, {v: vendorDetails.contact || 'N/A', s: defaultStyle}, null,
                {v: 'Date:', s: headerStyle}, {v: formattedDate, s: defaultStyle}
            ]);
            if (po.status === 'audited') {
                const formattedAuditedDate = formatDateDDMMYYYY(po.auditedAt);
                ws_data.push([
                    {v: 'Audited By:', s: headerStyle}, {v: po.auditedBy || 'N/A', s: defaultStyle}, null,
                    {v: 'Exchange Rate:', s: headerStyle}, {v: po.exchangeRate || 'N/A', s: defaultStyle}
                ]);
                ws_data.push([{v: 'Audited At:', s: headerStyle}, {v: formattedAuditedDate, s: defaultStyle}]);
            }
            ws_data.push([]);

            let tableHeader;
            if (po.status === 'audited') {
                tableHeader = ['No', 'Product Code', 'Barcode', 'Name', 'Selling Price()', 'Audited QTY', 'Audited T()', 'Audited T($)', 'Cost/Unit()', 'CheckUp'];
            } else {
                tableHeader = ['No', 'Product Code', 'Barcode', 'Name', 'QTY', 'Cost()', 'Cost($)', 'Sub-Total', 'Note'];
            }
            ws_data.push(tableHeader.map(h => ({ v: h, s: headerStyle })));

            po.items.forEach((item, index) => {
                if (po.status === 'audited') {
                    const auditedQty = item.auditedQty ?? 0;
                    const originalCost = item.cost || 0;
                    let costPerUnit = 0;
                    const rate = parseFloat(po.exchangeRate) || 0;

                    if (auditedQty > 0) {
                        if (item.auditedTotalKHR !== '' && item.auditedTotalKHR != null) {
                            costPerUnit = (parseFloat(item.auditedTotalKHR) || 0) / auditedQty;
                        } else if (item.auditedTotalUSD !== '' && item.auditedTotalUSD != null && rate > 0) {
                            costPerUnit = ((parseFloat(item.auditedTotalUSD) || 0) * rate) / auditedQty;
                        }
                    }
                    const checkUp = costPerUnit - originalCost;

                    ws_data.push([
                        { v: index + 1, s: defaultStyle },
                        { v: item.code, s: defaultStyle },
                        { v: item.barcode, s: defaultStyle },
                        { v: item.name, s: defaultStyle },
                        { v: item.price || 0, t: 'n', s: { ...defaultStyle, numFmt: '#,##0' } },
                        { v: auditedQty, t: 'n', s: defaultStyle },
                        { v: item.auditedTotalKHR, t: 'n', s: { ...defaultStyle, numFmt: '#,##0' } },
                        { v: item.auditedTotalUSD, t: 'n', s: { ...defaultStyle, numFmt: '"$"#,##0.00' } },
                        { v: costPerUnit, t: 'n', s: { ...defaultStyle, numFmt: '#,##0' } },
                        { v: checkUp, t: 'n', s: { ...defaultStyle, numFmt: '#,##0.00' } }
                    ]);
                } else {
                     const qty = item.quantity;
                    const cost = item.cost;
                    const subTotal = cost * qty;
                    const costUSD = po.exchangeRate ? (cost / po.exchangeRate) : null;
                    ws_data.push([
                        { v: index + 1, s: defaultStyle }, { v: item.code, s: defaultStyle }, { v: item.barcode, s: defaultStyle },
                        { v: item.name, s: defaultStyle }, { v: qty, t: 'n', s: defaultStyle },
                        { v: cost, t: 'n', s: { ...defaultStyle, numFmt: '#,##0' } },
                        { v: costUSD, t: 'n', s: { ...defaultStyle, numFmt: '"$"#,##0.00' } },
                        { v: subTotal, t: 'n', s: { ...defaultStyle, numFmt: '#,##0' } },
                        { v: item.note || '', s: defaultStyle }
                    ]);
                }
            });
        
            ws_data.push([]);

            const totalAuditedAmountKHR = po.status === 'audited' ? po.items.reduce((sum, item) => {
                const khr = parseFloat(item.auditedTotalKHR) || 0;
                const usdInKhr = (parseFloat(item.auditedTotalUSD) || 0) * (parseFloat(po.exchangeRate) || 0);
                return sum + khr + usdInKhr;
            }, 0) : 0;
            const totalLabel = po.status === 'audited' ? 'Audited Total (KHR):' : 'Total (KHR):';
            const totalValue = po.status === 'audited' ? totalAuditedAmountKHR : po.totalAmount;
            ws_data.push([null, null, null, null, null, null, null, {v: totalLabel, s: headerStyle}, {v: totalValue, t: 'n', s: { ...defaultStyle, numFmt: '""#,##0' }}]);
            if (po.status === 'audited' && po.exchangeRate) {
                ws_data.push([null, null, null, null, null, null, null, {v: 'Audited Total (USD):', s: headerStyle}, {v: totalAuditedAmountKHR / po.exchangeRate, t: 'n', s: { ...defaultStyle, numFmt: '"$"#,##0.00' }}]);
            }

            const ws = XLSX.utils.aoa_to_sheet(ws_data);
             if (po.status === 'audited') {
                ws['!cols'] = [ {wch:5}, {wch:15}, {wch:15}, {wch:40}, {wch:15}, {wch:12}, {wch:15}, {wch:15}, {wch:15}, {wch:15} ];
            } else {
                ws['!cols'] = [ {wch:5}, {wch:15}, {wch:15}, {wch:40}, {wch:8}, {wch:12}, {wch:12}, {wch:15}, {wch:20} ];
            }
            ws['!pageSetup'] = { orientation: 'landscape', paper: 9, margins: { left: 0.6, right: 0.6, top: 0.8, bottom: 0.8, header: 0.8, footer: 0.8 } };

            XLSX.utils.book_append_sheet(wb, ws, 'Purchase Order');
            XLSX.writeFile(wb, `PO-${po.poNumber}.xlsx`);
        };

        const auditedDate = safeToDate(po.auditedAt);
        const formattedDate = formatDateDDMMYYYY(po.requestDate);
        const formattedAuditedDate = formatDateDDMMYYYY(po.auditedAt || po.updatedAt);
        
        // --- NEW: Detailed Breakdown for Audited POs ---
        const sumAuditedKHR = useMemo(() => {
            if (po.status !== 'audited') return 0;
            return po.items.reduce((sum, item) => sum + (parseFloat(item.auditedTotalKHR) || 0), 0);
        }, [po]);

        const sumAuditedUSD = useMemo(() => {
            if (po.status !== 'audited') return 0;
            return po.items.reduce((sum, item) => sum + (parseFloat(item.auditedTotalUSD) || 0), 0);
        }, [po]);

        const totalAuditedAmountKHR = po.status === 'audited' ? 
            sumAuditedKHR + (sumAuditedUSD * (parseFloat(po.exchangeRate) || 0)) 
            : 0;

        return (
            <Modal show={true} maxWidth="max-w-7xl">
                <ModalHeader title={`Purchase Order Preview: ${po.poNumber}`} onClose={onClose} />
                <ModalBody>
                    <div ref={previewRef} className="po-preview-capture">
                        <div>
                            <div className="text-center mb-4">
                                <h1 className="text-2xl font-bold">Purchase Order</h1>
                                {po.status === 'audited' && <h2 className="text-lg font-semibold text-green-600">Audited</h2>}
                            </div>
                            <div className="grid grid-cols-2 gap-x-8 gap-y-1 mb-4 border-y py-2">
                                <span><strong>Vendor:</strong> {vendorDetails.name || po.vendorName}</span>
                                <span><strong>PO No.:</strong> {po.poNumber}</span>
                                <span><strong>Contact:</strong> {vendorDetails.contact || 'N/A'}</span>
                                <span><strong>Date:</strong> {formattedDate}</span>
                                {po.status === 'audited' && (
                                    <>
                                        <span><strong>Audited By:</strong> {po.auditedBy || 'N/A'}</span>
                                        <span><strong>Exchange Rate:</strong> {po.exchangeRate || 'N/A'}</span>
                                        <span className="col-span-2"><strong>Audited At:</strong> {formattedAuditedDate}</span>
                                    </>
                                )}
                            </div>
                        </div>
                        
                        <div className="flex-grow">
                            <table className="w-full text-left border-collapse border border-slate-400">
                                <thead className="bg-slate-200">
                                    <tr>
                                        <th className="border border-slate-300 p-1">No</th>
                                        <th className="border border-slate-300 p-1">Product Code</th>
                                        <th className="border border-slate-300 p-1">Barcode</th>
                                        <th className="border border-slate-300 p-1">Name</th>
                                        {po.status === 'audited' ? (
                                            <>
                                                <th className="border border-slate-300 p-1 text-right">Selling Price()</th>
                                                <th className="border border-slate-300 p-1 text-center">Audited QTY</th>
                                                <th className="border border-slate-300 p-1 text-right">Audited T()</th>
                                                <th className="border border-slate-300 p-1 text-right">Audited T($)</th>
                                                <th className="border border-slate-300 p-1 text-right">Cost/Unit()</th>
                                                <th className="border border-slate-300 p-1 text-right">CheckUp</th>
                                            </>
                                        ) : (
                                            <>
                                                <th className="border border-slate-300 p-1 text-center">QTY</th>
                                                <th className="border border-slate-300 p-1 text-right">Cost()</th>
                                                <th className="border border-slate-300 p-1 text-right">Cost($)</th>
                                                <th className="border border-slate-300 p-1 text-right">Sub-Total</th>
                                                <th className="border border-slate-300 p-1">Note</th>
                                            </>
                                        )}
                                    </tr>
                                </thead>
                                <tbody>
                                    {po.status === 'audited' ? (
                                        po.items.map((item, index) => {
                                            const auditedQty = item.auditedQty ?? 0;
                                            const originalCost = item.cost || 0;
                                            let costPerUnit = 0;
                                            const rate = parseFloat(po.exchangeRate) || 0;

                                            if (auditedQty > 0) {
                                                if (item.auditedTotalKHR !== '' && item.auditedTotalKHR != null) {
                                                    costPerUnit = (parseFloat(item.auditedTotalKHR) || 0) / auditedQty;
                                                } else if (item.auditedTotalUSD !== '' && item.auditedTotalUSD != null && rate > 0) {
                                                    costPerUnit = ((parseFloat(item.auditedTotalUSD) || 0) * rate) / auditedQty;
                                                }
                                            }
                                            const checkUp = costPerUnit - originalCost;
                                            const audTotalKHR = item.auditedTotalKHR != null ? khrFormatter.format(item.auditedTotalKHR) : '';
                                            const audTotalUSD = item.auditedTotalUSD != null ? usdFormatter.format(item.auditedTotalUSD) : '';
                                            
                                            return (
                                                <tr key={index}>
                                                    <td className="border border-slate-300 p-1">{index + 1}</td>
                                                    <td className="border border-slate-300 p-1">{item.code}</td>
                                                    <td className="border border-slate-300 p-1">{item.barcode || ''}</td>
                                                    <td className="border border-slate-300 p-1">{item.name}</td>
                                                    <td className="border border-slate-300 p-1 text-right" style={{ textAlign: 'right' }}>{khrFormatter.format(item.price || 0)}</td>
                                                    <td className="border border-slate-300 p-1 text-center font-bold" style={{ textAlign: 'center' }}>{auditedQty}</td>
                                                    <td className="border border-slate-300 p-1 text-right font-bold bg-slate-100" style={{ textAlign: 'right' }}>{audTotalKHR}</td>
                                                    <td className="border border-slate-300 p-1 text-right font-bold bg-slate-100" style={{ textAlign: 'right' }}>{audTotalUSD}</td>
                                                    <td className="border border-slate-300 p-1 text-right" style={{ textAlign: 'right' }}>{khrFormatter.format(costPerUnit.toFixed(2))}</td>
                                                    <td className="border border-slate-300 p-1 text-right" style={{ textAlign: 'right' }}>{khrFormatter.format(checkUp.toFixed(2))}</td>
                                                </tr>
                                            );
                                        })
                                    ) : (
                                        po.items.map((item, index) => {
                                            const qty = item.quantity;
                                            const costPerUnit = item.cost;
                                            const subTotal = costPerUnit * qty;
                                            return (
                                                <tr key={index}>
                                                    <td className="border border-slate-300 p-1">{index + 1}</td>
                                                    <td className="border border-slate-300 p-1">{item.code}</td>
                                                    <td className="border border-slate-300 p-1">{item.barcode || ''}</td>
                                                    <td className="border border-slate-300 p-1">{item.name}</td>
                                                    <td className="border border-slate-300 p-1 text-center" style={{ textAlign: 'center' }}>{qty}</td>
                                                    <td className="border border-slate-300 p-1 text-right">{khrFormatter.format(costPerUnit)}</td>
                                                    <td className="border border-slate-300 p-1 text-right">{usdFormatter.format(costPerUnit / (po.exchangeRate || 4000))}</td>
                                                    <td className="border border-slate-300 p-1 text-right">{khrFormatter.format(subTotal)}</td>
                                                    <td className="border border-slate-300 p-1">{item.note || ''}</td>
                                                </tr>
                                            );
                                        })
                                    )}
                                </tbody>
                            </table>
                            <div className="flex justify-end mt-4 text-right">
                                <div>
                                    {po.status === 'audited' ? (
                                        <>
                                            {sumAuditedKHR > 0 && (
                                                <p className="font-bold">Audited Total (KHR): {khrFormatter.format(sumAuditedKHR)}</p>
                                            )}
                                            {sumAuditedUSD > 0 && (
                                                <p className="font-bold">Audited Total (USD): {usdFormatter.format(sumAuditedUSD)}</p>
                                            )}
                                            <div className="border-t border-slate-400 my-1"></div>
                                            <p className="font-bold text-lg">
                                                Sub Total (): {khrFormatter.format(totalAuditedAmountKHR)}
                                            </p>
                                        </>
                                    ) : (
                                        <p className="font-bold">
                                            Total (KHR): {khrFormatter.format(po.totalAmount)}
                                        </p>
                                    )}
                                </div>
                            </div>
                        </div>

                        <div className="flex justify-between pt-8 mt-auto">
                            <div>
                                <p className="font-bold">Prepared By:</p>
                                <p className="mt-8 border-t border-slate-400 pt-1">{po.createdByName || 'N/A'}</p>
                            </div>
                            <div>
                                <p className="font-bold">Approved By:</p>
                                <p className="mt-8 border-t border-slate-400 pt-1"></p>
                            </div>
                            {po.status === 'audited' && (
                                <div>
                                    <p className="font-bold">Audited By:</p>
                                    <p className="mt-8 border-t border-slate-400 pt-1">{po.auditedBy || 'N/A'}</p>
                                </div>
                            )}
                        </div>
                    </div>
                </ModalBody>
                <ModalFooter>
                    <button onClick={onClose} type="button" className="bg-slate-600 text-slate-100 font-bold py-2 px-6 rounded-lg hover:bg-slate-500 transition">Close</button>
                    <button onClick={handleExportToExcel} type="button" className="bg-green-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-green-700 transition flex items-center gap-2">
                        <i className="fas fa-file-excel"></i> Export to Excel
                    </button>
                    <button onClick={handlePrintPdf} disabled={loading} type="button" className="bg-red-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-red-700 transition flex items-center gap-2 disabled:bg-red-800">
                        {loading ? <div className="loader"></div> : <i className="fas fa-file-pdf"></i>}
                        {loading ? 'Generating...' : 'Print as PDF'}
                    </button>
                    {po.status !== 'submitted' && (
                        <button onClick={handleDownloadImage} disabled={loading} type="button" className="bg-blue-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-700 transition flex items-center gap-2 disabled:bg-blue-800">
                            {loading ? <div className="loader"></div> : <i className="fas fa-camera"></i>}
                            {loading ? 'Capturing...' : 'Download Image'}
                        </button>
                    )}
                </ModalFooter>
            </Modal>
        );
    };

    // --- 8.5 PO Audit Page ---
    const POAuditPage = ({ poDataToAudit, setPage, userProfile }) => {
        const { shops, products } = useData();
        const [auditedItems, setAuditedItems] = useState([]);
        const [exchangeRate, setExchangeRate] = useState('');
        const [auditedByName, setAuditedByName] = useState(userProfile.name || '');
        const [modalInfo, setModalInfo] = useState({ show: false, title: '', message: '', isError: false });
        
        const [productSearch, setProductSearch] = useState('');
        const [searchResults, setSearchResults] = useState([]);
        const [selectedProduct, setSelectedProduct] = useState(null);
        const [newProductQty, setNewProductQty] = useState(1);
        const [newProductCostKHR, setNewProductCostKHR] = useState('');
        const [newProductCostUSD, setNewProductCostUSD] = useState('');
        
        const fuse = useProductSearch();
        const debouncedSearchTerm = useDebounce(productSearch, 250);

        // Ref to track which PO ID has been initialized to prevent overwriting user input on re-renders
        const initializedPoIdRef = useRef(null);

        const prepareItemsForSave = () => {
            return auditedItems.map(item => {
                let costPerUnit = 0;
                const auditedQty = parseFloat(item.auditedQty) || 0;
                const rate = parseFloat(exchangeRate) || 0;

                if (auditedQty > 0) {
                    if (item.auditedTotalKHR !== '' && item.auditedTotalKHR != null) {
                        const auditedTotalKHR = parseFloat(item.auditedTotalKHR) || 0;
                        costPerUnit = auditedTotalKHR / auditedQty;
                    } else if (item.auditedTotalUSD !== '' && item.auditedTotalUSD != null && rate > 0) {
                        const auditedTotalUSD = parseFloat(item.auditedTotalUSD) || 0;
                        costPerUnit = (auditedTotalUSD * rate) / auditedQty;
                    }
                }
                const checkUp = costPerUnit - (item.originalCost || 0);

                // Explicitly construct the object to be saved to prevent any 'undefined' fields.
                return {
                    productId: item.productId,
                    code: item.code || '',
                    barcode: item.barcode || null,
                    name: item.name || '',
                    vendorName: item.vendorName || '',
                    note: item.note || '',
                    price: item.price || 0,
                    
                    // Original data from PO for archival purposes
                    quantity: item.originalQuantity || 0,
                    cost: item.originalCost || 0,
                    cb4: item.cb4 || 0,

                    // Audited data
                    auditedQty: auditedQty,
                    auditedTotalKHR: item.auditedTotalKHR === '' ? null : (parseFloat(item.auditedTotalKHR) || 0),
                    auditedTotalUSD: item.auditedTotalUSD === '' ? null : (parseFloat(item.auditedTotalUSD) || 0),
                    checkUp: parseFloat(checkUp.toFixed(2)) || 0,
                };
            });
        };

        useEffect(() => {
            if (poDataToAudit?.items) {
                // Prepare product map for O(1) lookups
                const productMap = new Map((products || []).map(p => [p.id, p]));

                // CHECK: Is this a new PO being loaded?
                if (initializedPoIdRef.current !== poDataToAudit.id) {
                    // --- FULL INITIALIZATION ---
                    // This runs ONLY ONCE per PO open. Safe to set default calculations here.
                    const initialAuditedItems = poDataToAudit.items.map(item => {
                        const isFirstAudit = poDataToAudit.status === 'submitted'; 
                        
                        // Prioritize saved audit data. Default to empty string if null/undefined.
                        let initialKHR = item.auditedTotalKHR ?? '';
                        let initialUSD = item.auditedTotalUSD ?? '';

                        // If it's the first audit AND neither audited total exists yet, calculate a default KHR total based on original PO.
                        if (isFirstAudit && initialKHR === '' && initialUSD === '') {
                            initialKHR = (item.cost || 0) * (item.quantity || 0);
                        }

                        return {
                            ...item,
                            price: item.price ?? productMap.get(item.productId)?.price ?? 0,
                            originalQuantity: item.quantity,
                            originalCost: item.cost,
                            auditedQty: item.auditedQty ?? item.quantity,
                            auditedTotalKHR: initialKHR, // Use the determined initial KHR
                            auditedTotalUSD: initialUSD, // Use the determined initial USD
                        };
                    });
                    
                    setAuditedItems(initialAuditedItems);
                    setExchangeRate(poDataToAudit?.exchangeRate || '');
                    setAuditedByName(poDataToAudit?.auditedBy || userProfile.name || '');
                    
                    // Mark this PO as initialized
                    initializedPoIdRef.current = poDataToAudit.id;
                } 
                // CHECK: Same PO, but background products finished loading?
                else if (products && products.length > 0) {
                    // --- SOFT UPDATE ---
                    // Only update MISSING metadata (like barcodes/prices) that might have loaded late.
                    // DO NOT overwrite auditedQty or Totals here.
                    setAuditedItems(prevItems => {
                        return prevItems.map(prevItem => {
                            const p = productMap.get(prevItem.productId);
                            if (!p) return prevItem;
                            
                            // Check if we need to update static info
                            const newPrice = p.price ?? prevItem.price;
                            const newBarcode = p.barcode ?? prevItem.barcode;
                            
                            if (newPrice !== prevItem.price || newBarcode !== prevItem.barcode) {
                                return { ...prevItem, price: newPrice, barcode: newBarcode };
                            }
                            return prevItem;
                        });
                    });
                }
            }
        }, [poDataToAudit, products, userProfile.name]);

        useEffect(() => {
            if (fuse && debouncedSearchTerm.length > 1 && !selectedProduct) {
                const results = fuse.search(debouncedSearchTerm, { limit: 10 });
                setSearchResults(results.map(result => result.item));
            } else {
                setSearchResults([]);
            }
        }, [debouncedSearchTerm, fuse, selectedProduct]);

        const handleItemChange = (index, field, value) => {
            const newItems = auditedItems.map((item, i) => {
                if (i !== index) {
                    return item;
                }
    
                // Create a new object for the item being updated
                const updatedItem = { ...item, [field]: value };
    
                // When one currency total is entered, clear the other
                if (field === 'auditedTotalKHR' && value !== '') {
                    updatedItem.auditedTotalUSD = '';
                } else if (field === 'auditedTotalUSD' && value !== '') {
                    updatedItem.auditedTotalKHR = '';
                }
    
                return updatedItem;
            });
            setAuditedItems(newItems);
        };

        const selectProductForAudit = (product) => {
            setSelectedProduct(product);
            setProductSearch(product.name);
            setSearchResults([]);
        };

        const handleAddItemToAudit = (e) => {
            e.preventDefault();
            if (!selectedProduct) {
                setModalInfo({ show: true, title: 'Error', message: 'Please search and select a product first.', isError: true });
                return;
            }
            if (!newProductQty || (newProductCostKHR === '' && newProductCostUSD === '')) {
                setModalInfo({ show: true, title: 'Validation Error', message: 'Please enter a quantity and at least one cost value (KHR or USD).', isError: true });
                return;
            }

            const productCost = parseFloat(selectedProduct.cost) || 0;
            const productPrice = parseFloat(selectedProduct.price) || 0;
            const qty = parseFloat(newProductQty) || 0;
            const totalKhr = newProductCostKHR !== '' ? parseFloat(newProductCostKHR) : '';
            const totalUsd = newProductCostUSD !== '' ? parseFloat(newProductCostUSD) : '';

            setAuditedItems(prevItems => [
                ...prevItems,
                {
                    productId: selectedProduct.id, code: selectedProduct.code, barcode: selectedProduct.barcode || '',
                    name: selectedProduct.name, vendorName: selectedProduct.vendorName || '',
                    price: productPrice,
                    originalQuantity: 0, originalCost: productCost,
                    auditedQty: qty, auditedTotalKHR: totalKhr, auditedTotalUSD: totalUsd,
                    checkUp: 'New Item'
                }
            ]);
            
            setProductSearch('');
            setSelectedProduct(null);
            setNewProductQty(1);
            setNewProductCostKHR('');
            setNewProductCostUSD('');
        };

        const totalAuditedAmountKHR = useMemo(() => {
            return auditedItems.reduce((sum, item) => {
                const khr = parseFloat(item.auditedTotalKHR) || 0;
                const usdInKhr = (parseFloat(item.auditedTotalUSD) || 0) * (parseFloat(exchangeRate) || 0);
                return sum + khr + usdInKhr;
        }, 0);
        }, [auditedItems, exchangeRate]);

        const totalColumnKHR = useMemo(() => auditedItems.reduce((sum, item) => sum + (parseFloat(item.auditedTotalKHR) || 0), 0), [auditedItems]);
        const totalColumnUSD = useMemo(() => auditedItems.reduce((sum, item) => sum + (parseFloat(item.auditedTotalUSD) || 0), 0), [auditedItems]);

        const handleSaveAudit = async () => {
            if (!exchangeRate || !auditedByName) {
                setModalInfo({ show: true, title: 'Validation Error', message: 'Please enter exchange rate and auditor name.', isError: true });
                return;
            }
            const itemsToSave = prepareItemsForSave();
            try {
                await db.collection("purchaseOrders").doc(poDataToAudit.id).update({
                    status: 'auditing', items: itemsToSave, totalAuditedAmount: totalAuditedAmountKHR,
                    exchangeRate: parseFloat(exchangeRate), auditedBy: auditedByName,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                setModalInfo({ show: true, title: 'Success', message: 'Audit progress saved.' });
                // FIX: Redirect to inventory
                setPage('inventory', { activeTab: 'auditing-po' });
            } catch (error) {
                console.error("Error saving audit:", error);
                setModalInfo({ show: true, title: 'Error', message: 'Failed to save audit progress.', isError: true });
            }
        };

        const handleCompleteAudit = async () => {
            if (!exchangeRate || !auditedByName) {
                setModalInfo({ show: true, title: 'Validation Error', message: 'Please enter exchange rate and auditor name.', isError: true });
                return;
            }
        
            const itemsToSave = prepareItemsForSave();
            try {
                const batch = db.batch();
                const poRef = db.collection("purchaseOrders").doc(poDataToAudit.id);
                
                // Check if this is a correction (Re-Audit)
                const isReAudit = poDataToAudit.status === 'audited';

                batch.update(poRef, {
                    status: 'audited', items: itemsToSave, totalAuditedAmount: totalAuditedAmountKHR,
                    exchangeRate: parseFloat(exchangeRate), auditedBy: auditedByName,
                    auditedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
        
                const shop = shops.find(s => s.id === poDataToAudit.shopId);
                
                itemsToSave.forEach(item => {
                    if (!item.productId) return;
                    const productRef = db.collection("products").doc(item.productId);
                    const newAuditedQty = parseFloat(item.auditedQty) || 0;

                    // Calculate Stock Difference
                    let qtyChange = newAuditedQty;
                    
                    if (isReAudit) {
                        // If re-auditing, compare with the previous saved state to apply only the difference
                        const prevItem = poDataToAudit.items.find(i => i.productId === item.productId);
                        const prevQty = prevItem ? (parseFloat(prevItem.auditedQty) || 0) : 0;
                        qtyChange = newAuditedQty - prevQty;
                    }

                    if (shop?.manageStock && qtyChange !== 0) {
                        batch.update(productRef, { [`stockByShop.${poDataToAudit.shopId}`]: firebase.firestore.FieldValue.increment(qtyChange) });
                    }

                    if (qtyChange !== 0) {
                        // Add product movement log
                        const movementRef = db.collection("productMovement").doc();
                        batch.set(movementRef, {
                            productId: item.productId,
                            productCode: item.code,
                            productName: item.name,
                            type: isReAudit ? 'Audit Correction' : 'PO', // Distinguish correction
                            quantityChange: qtyChange,
                            from: poDataToAudit.vendorName,
                            to: poDataToAudit.shopName,
                            referenceNo: poDataToAudit.poNumber,
                            timestamp: firebase.firestore.FieldValue.serverTimestamp()
                        });
                    }

                    // Cost Update Logic
                    let newCostPerUnit = 0;
                    const auditedTotalKHR = parseFloat(item.auditedTotalKHR) || 0;
                    const auditedTotalUSD = parseFloat(item.auditedTotalUSD) || 0;
                    const rate = parseFloat(exchangeRate) || 0;
                    
                    if (auditedTotalKHR > 0 && newAuditedQty > 0) newCostPerUnit = auditedTotalKHR / newAuditedQty;
                    else if (auditedTotalUSD > 0 && rate > 0 && newAuditedQty > 0) newCostPerUnit = (auditedTotalUSD * rate) / newAuditedQty;

                    // FIX: Compare against CURRENT LIVE COST to prevent duplicate history entries
                    const currentProduct = products.find(p => p.id === item.productId);
                    const currentLiveCost = currentProduct ? (parseFloat(currentProduct.cost) || 0) : 0;

                    if (newCostPerUnit > 0 && Math.abs(newCostPerUnit - currentLiveCost) > 0.01) {
                        batch.update(productRef, { cost: newCostPerUnit });
                        const historyRef = db.collection("costHistory").doc();
                        batch.set(historyRef, {
                            productId: item.productId, poNumber: poDataToAudit.poNumber,
                            oldCost: currentLiveCost, // Use the actual current cost as the 'old' value
                            newCost: newCostPerUnit,
                            type: isReAudit ? 'Correction' : 'Audit',
                            auditedBy: auditedByName, updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                        });
                    }
                });
        
                await batch.commit();
                setModalInfo({ show: true, title: 'Success', message: isReAudit ? 'Audit updated successfully.' : 'PO audited successfully.' });
                // FIX: Redirect to inventory
                setPage('inventory', { activeTab: 'audited-po' });
            } catch (error) {
                console.error("Error submitting audit:", error);
                setModalInfo({ show: true, title: 'Error', message: 'Failed to submit the audit.', isError: true });
            }
        };

        if (!poDataToAudit) return <Card><p className="text-center p-4">No PO data to audit.</p></Card>;
        
        return (
            <div className="space-y-6">
                <MessageModal {...modalInfo} show={modalInfo.show} onClose={() => setModalInfo({ show: false })} />
                <Card>
                    <CardTitle>Audit Purchase Order: {poDataToAudit.poNumber}</CardTitle>
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-6 mb-4">
                        <div>
                            <label className="block text-sm font-medium text-slate-300 mb-1">Exchange Rate (1 USD = ? KHR)</label>
                            <input 
                                type="number" 
                                value={exchangeRate} 
                                onChange={(e) => setExchangeRate(e.target.value)} 
                                className="w-full bg-slate-700 text-slate-100 px-3 py-2 border border-slate-600 rounded-md" 
                                placeholder="4000"
                            />
                        </div>
                        <div>
                            <label className="block text-sm font-medium text-slate-300 mb-1">Audited By</label>
                            <input 
                                type="text" 
                                value={auditedByName} 
                                onChange={(e) => setAuditedByName(e.target.value)} 
                                className="w-full bg-slate-700 text-slate-100 px-3 py-2 border border-slate-600 rounded-md" 
                            />
                        </div>
                        <div className="flex items-end">
                            <div className="text-sm text-slate-400">
                                Vendor: <span className="text-slate-200 font-semibold">{poDataToAudit.vendorName}</span><br/>
                                Date: <span className="text-slate-200 font-semibold">{formatDateDDMMYYYY(poDataToAudit.requestDate)}</span>
                            </div>
                        </div>
                    </div>
                    
                    {/* Add Product for Audit */}
                    <div className="border-t border-slate-600 pt-4 mt-4">
                        <h4 className="text-md font-semibold text-slate-300 mb-3">Add / Audit Extra Item</h4>
                        <form onSubmit={handleAddItemToAudit} className="flex flex-col md:flex-row gap-3 items-end">
                            <div className="flex-1 relative">
                                <label className="block text-xs text-slate-400 mb-1">Product Search</label>
                                <input
                                    type="text"
                                    value={productSearch}
                                    onChange={(e) => {
                                        setProductSearch(e.target.value);
                                        setSelectedProduct(null);
                                    }}
                                    className="w-full bg-slate-700 text-slate-100 px-3 py-2 border border-slate-600 rounded-md"
                                    placeholder="Search by name, code..."
                                    autoComplete="off"
                                />
                                {searchResults.length > 0 && (
                                    <div className="absolute z-20 w-full bg-slate-800 border border-slate-600 rounded-md mt-1 shadow-lg max-h-60 overflow-y-auto">
                                        {searchResults.map(p => (
                                            <div key={p.id} onClick={() => selectProductForAudit(p)} className="p-2 cursor-pointer hover:bg-slate-700">
                                                <p className="font-semibold text-slate-200">{p.name}</p>
                                                <p className="text-sm text-slate-400">Code: {p.code}</p>
                                            </div>
                                        ))}
                                    </div>
                                )}
                            </div>
                            <div className="w-24">
                                <label className="block text-xs text-slate-400 mb-1">Qty</label>
                                <input type="number" value={newProductQty} onChange={(e) => setNewProductQty(e.target.value)} className="w-full bg-slate-700 text-slate-100 px-3 py-2 border border-slate-600 rounded-md" />
                            </div>
                            <div className="w-32">
                                <label className="block text-xs text-slate-400 mb-1">Total Cost ()</label>
                                <input type="number" value={newProductCostKHR} onChange={(e) => { setNewProductCostKHR(e.target.value); if(e.target.value) setNewProductCostUSD(''); }} className="w-full bg-slate-700 text-slate-100 px-3 py-2 border border-slate-600 rounded-md" placeholder="KHR" />
                            </div>
                            <div className="w-32">
                                <label className="block text-xs text-slate-400 mb-1">Total Cost ($)</label>
                                <input type="number" value={newProductCostUSD} onChange={(e) => { setNewProductCostUSD(e.target.value); if(e.target.value) setNewProductCostKHR(''); }} className="w-full bg-slate-700 text-slate-100 px-3 py-2 border border-slate-600 rounded-md" placeholder="USD" />
                            </div>
                            <button type="submit" className="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700">Add</button>
                        </form>
                    </div>
                </Card>

                <TableCard title="Audit Items">
                    <table className="min-w-full divide-y divide-slate-700 text-sm responsive-table">
                        <thead className="bg-slate-900/50">
                            <tr>
                                <th className="px-2 py-3 text-left text-xs font-semibold text-slate-400 uppercase">No</th>
                                <th className="px-2 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Product Code</th>
                                <th className="px-2 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Barcode</th>
                                <th className="px-2 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Name</th>
                                <th className="px-2 py-3 text-right text-xs font-semibold text-slate-400 uppercase">Selling Price</th>
                                <th className="px-2 py-3 text-center text-xs font-semibold text-slate-400 uppercase">Total QTY</th>
                                <th className="px-2 py-3 text-right text-xs font-semibold text-slate-400 uppercase">Total Cost</th>
                                <th className="px-2 py-3 text-center text-xs font-semibold text-slate-400 uppercase">Audited QTY</th>
                                <th className="px-2 py-3 text-center text-xs font-semibold text-slate-400 uppercase">Audited T()</th>
                                <th className="px-2 py-3 text-center text-xs font-semibold text-slate-400 uppercase">Audited T($)</th>
                                <th className="px-2 py-3 text-right text-xs font-semibold text-slate-400 uppercase">Cost/Unit</th>
                                <th className="px-2 py-3 text-right text-xs font-semibold text-slate-400 uppercase">CheckUp</th>
                            </tr>
                        </thead>
                        <tbody className="divide-y divide-slate-700">
                            {auditedItems.map((item, index) => {
                                const originalTotalCost = (item.originalQuantity || 0) * (item.originalCost || 0);
                                let costPerUnit = 0;
                                const auditedQty = parseFloat(item.auditedQty) || 0;

                                if (auditedQty > 0) {
                                    if (item.auditedTotalKHR !== '' && item.auditedTotalKHR != null) {
                                        costPerUnit = (parseFloat(item.auditedTotalKHR) || 0) / auditedQty;
                                    } else if (item.auditedTotalUSD !== '' && item.auditedTotalUSD != null && exchangeRate) {
                                        costPerUnit = ((parseFloat(item.auditedTotalUSD) || 0) * (parseFloat(exchangeRate) || 0)) / auditedQty;
                                    }
                                }
                                
                                const checkUp = costPerUnit - (item.originalCost || 0);
                                const checkUpColor = checkUp > 0 ? 'text-red-400' : checkUp < 0 ? 'text-blue-400' : 'text-slate-300';

                                return (
                                <tr key={index} className="hover:bg-slate-700/50">
                                    <td className="px-2 py-2 text-slate-400" data-label="No">{index + 1}</td>
                                    <td className="px-2 py-2 text-slate-300" data-label="Product Code">{item.code}</td>
                                    <td className="px-2 py-2 text-slate-300" data-label="Barcode">{item.barcode || ''}</td>
                                    <td className="px-2 py-2 text-slate-300" data-label="Name">{item.name}</td>
                                    <td className="px-2 py-2 text-slate-300 text-right" data-label="Selling Price">{khrFormatter.format(item.price)}</td>
                                    <td className="px-2 py-2 text-slate-400 text-center" data-label="Total QTY">{item.originalQuantity}</td>
                                    <td className="px-2 py-2 text-slate-400 text-right" data-label="Total Cost">{khrFormatter.format(originalTotalCost)}</td>
                                    <td className="px-2 py-2 md:text-center" data-label="Audited QTY"><input type="number" value={item.auditedQty} onChange={(e) => handleItemChange(index, 'auditedQty', e.target.value)} className="w-20 bg-slate-700 text-slate-100 px-2 py-1 border border-slate-600 rounded-md text-center"/></td>
                                    <td className="px-2 py-2 md:text-center" data-label="Audited T()">
                                        <input type="number" value={item.auditedTotalKHR} 
                                            onChange={(e) => handleItemChange(index, 'auditedTotalKHR', e.target.value)} 
                                            disabled={item.auditedTotalUSD !== '' && item.auditedTotalUSD != null}
                                            className="w-28 bg-slate-700 text-slate-100 px-2 py-1 border border-slate-600 rounded-md text-right disabled:bg-slate-800 disabled:cursor-not-allowed"/>
                                    </td>
                                    <td className="px-2 py-2 md:text-center" data-label="Audited T($)">
                                        <input type="number" value={item.auditedTotalUSD} 
                                            onChange={(e) => handleItemChange(index, 'auditedTotalUSD', e.target.value)} 
                                            disabled={item.auditedTotalKHR !== '' && item.auditedTotalKHR != null}
                                            className="w-24 bg-slate-700 text-slate-100 px-2 py-1 border border-slate-600 rounded-md text-right disabled:bg-slate-800 disabled:cursor-not-allowed"/>
                                    </td>
                                    <td className="px-2 py-2 text-slate-300 text-right" data-label="Cost/Unit">{khrFormatter.format(costPerUnit.toFixed(2))}</td>
                                    <td className={`px-2 py-2 font-semibold text-right ${checkUpColor}`} data-label="CheckUp">{khrFormatter.format(checkUp.toFixed(2))}</td>
                                </tr>
                            )})}
                        </tbody>
                        <tfoot className="bg-slate-900/50 hidden md:table-footer-group">
                            <tr className="border-t border-slate-700">
                                <td colSpan="8" className="px-2 py-3 text-right font-bold text-slate-400 uppercase">Totals</td>
                                <td className="px-2 py-3 text-right font-bold text-slate-300">{khrFormatter.format(totalColumnKHR)}</td>
                                <td className="px-2 py-3 text-right font-bold text-slate-300">{usdFormatter.format(totalColumnUSD)}</td>
                                <td colSpan="2"></td>
                            </tr>
                            <tr>
                                <td colSpan="11" className="px-2 py-3 text-right font-bold text-slate-300 uppercase">Audited Grand Total (KHR)</td>
                                <td className="px-2 py-3 text-right font-bold text-slate-200">{khrFormatter.format(totalAuditedAmountKHR.toFixed(2))}</td>
                            </tr>
                        </tfoot>
                    </table>
                </TableCard>

                <div className="mt-8 flex flex-col sm:flex-row justify-end gap-3">
                    <button onClick={() => setPage('inventory', { activeTab: 'auditing-po' })} className="bg-slate-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-slate-500 transition">Cancel Audit</button>
                    <button onClick={handleSaveAudit} className="bg-yellow-500 text-white font-bold py-2 px-6 rounded-lg hover:bg-yellow-600 transition">Save Progress</button>
                    <button onClick={handleCompleteAudit} className="bg-indigo-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-indigo-700 transition">
                        {poDataToAudit.status === 'audited' ? 'Update Audit' : 'Complete Audit'}
                    </button>
                </div>
            </div>
        );
    };

    // --- 8.6 Inventory Page (UNIFIED PHASE 2) ---
    // Includes Internal Transfers and Purchase Orders in dual dropdowns

    const TransferReport = ({ title, transfers, loading, onEdit, onViewReq, onDelete, showFilters = false, filters, onFilterChange }) => {
        const { shops } = useData();

        if (loading) {
            return <Card><p className="text-center p-4 text-slate-400">Loading transfers...</p></Card>;
        }
    
        const noTransfersMessage = (showFilters && (filters.fromShop || filters.toShop || filters.dateFilter || filters.searchTerm))
            ? "No transfers found for the current filters."
            : "No transfers found in this category.";
    
        const statusStyles = {
            draft: 'bg-yellow-500/20 text-yellow-300 border border-yellow-500/30',
            active: 'bg-blue-500/20 text-blue-300 border border-blue-500/30',
            done: 'bg-green-500/20 text-green-300 border border-green-500/30'
        };
    
        return (
            <React.Fragment>
                {showFilters && (
                    <Card className="mb-6">
                        <div className="mb-4 border-b border-slate-700 pb-4">
                            <label className="block text-sm font-medium text-slate-300 mb-1">
                                <i className="fas fa-hashtag text-purple-400 mr-2"></i>Search Transfer No
                            </label>
                            <div className="relative">
                                <input 
                                    type="text" 
                                    value={filters.searchTerm || ''} 
                                    onChange={e => onFilterChange.setSearchTerm(e.target.value)} 
                                    className="w-full bg-slate-700 text-slate-100 px-3 py-2 pl-10 border border-slate-600 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none" 
                                    placeholder="Search by Transfer No..." 
                                />
                                <i className="fas fa-search absolute left-3 top-3 text-slate-400"></i>
                            </div>
                        </div>
                        <div className="grid grid-cols-1 md:grid-cols-4 gap-4 items-end">
                             <div>
                                <label className="block text-sm font-medium text-slate-300 mb-1">
                                    <i className="fas fa-store-alt text-orange-400 mr-2"></i>Filter by From Shop
                                </label>
                                <select value={filters.fromShop} onChange={e => onFilterChange.setFromShop(e.target.value)} className="w-full bg-slate-700 text-slate-100 px-3 py-2 border border-slate-600 rounded-md">
                                    <option value="">-</option>
                                    {shops.map(s => <option key={s.id} value={s.id}>{s.name}</option>)}
                                </select>
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-slate-300 mb-1">
                                    <i className="fas fa-map-marker-alt text-emerald-400 mr-2"></i>Filter by To Shop
                                </label>
                                <select value={filters.toShop} onChange={e => onFilterChange.setToShop(e.target.value)} className="w-full bg-slate-700 text-slate-100 px-3 py-2 border border-slate-600 rounded-md">
                                    <option value="">-</option>
                                    {shops.map(s => <option key={s.id} value={s.id}>{s.name}</option>)}
                                </select>
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-slate-300 mb-1">
                                    <i className="fas fa-calendar-day text-blue-400 mr-2"></i>Filter by Date
                                </label>
                                <select value={filters.dateFilter} onChange={e => onFilterChange.setDateFilter(e.target.value)} className="w-full bg-slate-700 text-slate-100 px-3 py-2 border border-slate-600 rounded-md">
                                    <option value="">All Dates</option>
                                    <option value="today">Today</option>
                                    <option value="thisWeek">This Week</option>
                                    <option value="lastWeek">Last Week</option>
                                    <option value="thisMonth">This Month</option>
                                    <option value="lastMonth">Last Month</option>
                                </select>
                            </div>
                            <div>
                                <button onClick={() => { onFilterChange.setFromShop(''); onFilterChange.setToShop(''); onFilterChange.setDateFilter(''); onFilterChange.setSearchTerm(''); }} className="w-full bg-slate-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-slate-400 flex items-center justify-center gap-2">
                                    <i className="fas fa-times-circle"></i> Clear Filters
                                </button>
                            </div>
                        </div>
                    </Card>
                )}
                <TableCard title={title}>
                    {(!transfers || transfers.length === 0) ? (
                         <Card><p className="text-center p-4 text-slate-400">{noTransfersMessage}</p></Card>
                    ) : (
                    <table className="min-w-full responsive-table">
                        <thead className="bg-slate-900/50">
                            <tr>
                                <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Transfer No</th>
                                <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Date</th>
                                <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">From</th>
                                <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">To</th>
                                <th className="px-4 py-3 text-right text-xs font-semibold text-slate-400 uppercase">Total Amount</th>
                                <th className="px-4 py-3 text-center text-xs font-semibold text-slate-400 uppercase">Status</th>
                                <th className="px-4 py-3 text-center text-xs font-semibold text-slate-400 uppercase">Actions</th>
                            </tr>
                        </thead>
                        <tbody className="divide-y divide-slate-700">
                            {transfers.map(t => (
                                <tr key={t.id} className="hover:bg-slate-700/50">
                                    <td data-label="Transfer No" className="px-4 py-3 text-sm text-slate-200">{t.transferNo}</td>
                                    <td data-label="Date" className="px-4 py-3 text-sm text-slate-400">{formatDateDDMMYYYY(t.transferDate)}</td>
                                    <td data-label="From" className="px-4 py-3 text-sm text-slate-400">{t.fromShopName}</td>
                                    <td data-label="To" className="px-4 py-3 text-sm text-slate-400">{t.toShopName}</td>
                                    <td data-label="Total Amount" className="px-4 py-3 text-sm text-slate-300 md:text-right">{khrFormatter.format(t.totalAmount)}</td>
                                    <td data-label="Status" className="px-4 py-3 md:text-center">
                                        <span className={`px-3 py-1 inline-flex text-xs leading-5 font-semibold rounded-full ${statusStyles[t.status]}`}>{t.status}</span>
                                    </td>
                                    <td data-label="Actions" className="px-4 py-3 md:text-center space-x-4 actions-cell">
                                        {t.status === 'draft' && (
                                            <>
                                                <button onClick={() => onEdit(t)} className="text-blue-400 hover:text-blue-300" title="Edit"><i className="fas fa-edit"></i></button>
                                                {onDelete && <button onClick={() => onDelete(t)} className="text-red-500 hover:text-red-400" title="Delete"><i className="fas fa-trash"></i></button>}
                                            </>
                                        )}
                                        {t.status === 'active' && (
                                            <>
                                                <button onClick={() => onViewReq(t)} className="text-indigo-400 hover:text-indigo-300" title="Review"><i className="fas fa-tasks"></i></button>
                                                <button onClick={() => onEdit(t)} className="text-blue-400 hover:text-blue-300" title="Edit"><i className="fas fa-edit"></i></button>
                                                {onDelete && <button onClick={() => onDelete(t)} className="text-red-500 hover:text-red-400" title="Delete"><i className="fas fa-trash"></i></button>}
                                            </>
                                        )}
                                         {t.status === 'done' && (
                                            <button onClick={() => onViewReq(t)} className="text-cyan-400 hover:text-cyan-300" title="View Transfer Log"><i className="fas fa-clipboard-list"></i></button>
                                        )}
                                    </td>
                                </tr>
                            ))}
                        </tbody>
                    </table>
                    )}
                </TableCard>
            </React.Fragment>
        );
    };

    const InventoryPage = ({ setPage, userProfile, pageData }) => {
        const { shops, allPOs, posLoading, allTransfers, transfersLoading } = useData();
        
        // --- Navigation State ---
        // FIX: Set Purchase Order ('create-po') as default
        const [activeTab, setActiveTab] = useState('create-po'); 
        
        // --- Internal Transfer State ---
        const [transferDataToEdit, setTransferDataToEdit] = useState(null);
        const [viewReqTransfer, setViewReqTransfer] = useState(null);
        
        // --- Purchase Order State ---
        const [poDataForEdit, setPoDataForEdit] = useState(null);

        // --- Filter State (Shared) ---
        const [fromShopFilter, setFromShopFilter] = useState('');
        const [toShopFilter, setToShopFilter] = useState('');
        const [dateFilter, setDateFilter] = useState('');
        const [searchTerm, setSearchTerm] = useState('');
        const debouncedSearchTerm = useDebounce(searchTerm, 300);
        const [modal, setModal] = useState({ type: null, data: null });

        // --- Handle External Navigation (e.g. from Dashboard or Edit buttons) ---
        useEffect(() => {
            if (pageData && pageData.activeTab) {
                setActiveTab(pageData.activeTab);
                if (pageData.poData) setPoDataForEdit(pageData.poData);
                if (pageData.transferData) setTransferDataToEdit(pageData.transferData);
            }
        }, [pageData]);

        // --- Tab Change Handler ---
        const handleTabChange = (newTab) => {
            setActiveTab(newTab);
            // Clear editing states when switching main contexts
            if (newTab === 'internal-transfer') setTransferDataToEdit(null);
            if (newTab === 'create-po') setPoDataForEdit(null);
        };

        // --- Helper for Internal Transfers ---
        const getTransfersByStatus = (status) => {
            if (transfersLoading || !allTransfers) return [];
            let filtered = allTransfers.filter(t => t.status === status);
            // Apply Filters
            if (fromShopFilter) filtered = filtered.filter(t => t.fromShopId === fromShopFilter);
            if (toShopFilter) filtered = filtered.filter(t => t.toShopId === toShopFilter);
            if (debouncedSearchTerm) filtered = filtered.filter(t => t.transferNo.toLowerCase().includes(debouncedSearchTerm.toLowerCase()));
            
            // Simple date filtering re-use
            if (dateFilter) {
               const now = new Date();
                let startDate, endDate;
                switch(dateFilter) {
                    case 'today': startDate = new Date(now.setHours(0,0,0,0)); endDate = new Date(now.setHours(23,59,59,999)); break;
                    case 'thisWeek': const d = new Date(now); const day = d.getDay(); const diff = d.getDate() - day + (day === 0 ? -6 : 1); startDate = new Date(d.setDate(diff)); startDate.setHours(0,0,0,0); endDate = new Date(startDate); endDate.setDate(startDate.getDate() + 6); endDate.setHours(23,59,59,999); break;
                    case 'thisMonth': startDate = new Date(now.getFullYear(), now.getMonth(), 1); endDate = new Date(now.getFullYear(), now.getMonth() + 1, 0, 23, 59, 59, 999); break;
                }
                if (startDate && endDate) {
                    filtered = filtered.filter(t => {
                        const d = safeToDate(t.createdAt || t.transferDate);
                        return d && d >= startDate && d <= endDate;
                    });
                }
            }
            return filtered.sort((a, b) => (safeToDate(b.createdAt) || 0) - (safeToDate(a.createdAt) || 0));
        };

        const activeTransfers = getTransfersByStatus('active');

        // --- Handlers ---
        const handleEditTransfer = (data) => { setTransferDataToEdit(data); setActiveTab('internal-transfer'); };
        const handleDeleteTransfer = async (id) => {
            try { await db.collection("internalTransfers").doc(id).delete(); setModal({ type: 'message', data: { title: 'Success', message: 'Transfer deleted.' } }); }
            catch (error) { setModal({ type: 'message', data: { title: 'Error', message: 'Failed.', isError: true } }); }
        };
        const openDeleteTransferModal = (t) => setModal({ type: 'confirmDelete', data: t.id, title: 'Delete Transfer', message: `Delete Transfer #${t.transferNo}?` });

        // --- PO Handlers Wrapper ---
        // Intercept setPage calls from PO components to handle local state transitions
        const handleSetPage = (page, data) => {
            if (page === 'inventory') {
                setActiveTab(data.activeTab || 'create-po');
                if (data.poData) setPoDataForEdit(data.poData);
            } else {
                setPage(page, data); // Delegate to global router for other pages
            }
        };

        // Determine which Dropdown Value to show visually
        const isPOActive = ['create-po', 'drafts-po', 'active-po', 'auditing-po', 'audited-po'].includes(activeTab);
        const isTransferActive = ['internal-transfer', 'drafts', 'active-transfer', 'transfer-report'].includes(activeTab);
        const isProductionActive = ['product-list', 'vendor-list'].includes(activeTab);

        return (
            <div className="space-y-6">
                <MessageModal {...modal.data} show={modal.type === 'message'} onClose={() => setModal({ type: null })} />
                <ConfirmationModal title={modal.title} message={modal.message} show={modal.type === 'confirmDelete'} onConfirm={() => {handleDeleteTransfer(modal.data); setModal({type: null})}} onCancel={() => setModal({ type: null })} />
                
                {renderModalForView(viewReqTransfer, setViewReqTransfer, activeTransfers)}

                <Card>
                    <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        
                        {/* 1. Purchase Order Control (First) */}
                        <div className={`flex flex-row items-center gap-3 p-4 rounded-xl border transition-all duration-200 ${isPOActive ? 'bg-purple-500/10 border-purple-500/50 shadow-lg shadow-purple-900/20' : 'bg-slate-800/50 border-slate-700 hover:bg-slate-800'}`}>
                            <div className={`p-3 rounded-lg hidden sm:flex items-center justify-center w-12 h-12 shrink-0 ${isPOActive ? 'bg-purple-500 text-white shadow-inner' : 'bg-slate-700 text-slate-400'}`}>
                                <i className="fas fa-shopping-cart text-lg"></i>
                            </div>
                            <div className="flex-1 w-full min-w-0">
                                <label className={`block text-xs font-bold uppercase tracking-wider mb-1.5 ${isPOActive ? 'text-purple-300' : 'text-slate-400'}`}>Purchase Order</label>
                                <div className="relative">
                                    <select 
                                        value={isPOActive ? activeTab : ''} 
                                        onChange={(e) => handleTabChange(e.target.value)} 
                                        className={`w-full pl-3 pr-8 py-2 rounded-lg border text-sm font-medium outline-none appearance-none cursor-pointer transition-colors ${isPOActive ? 'bg-slate-900 text-purple-100 border-purple-500/50 focus:ring-1 focus:ring-purple-500' : 'bg-slate-700 text-slate-300 border-slate-600 hover:border-slate-500'}`}
                                    >
                                        {!isPOActive && <option value="" disabled>Select Action...</option>}
                                        <option value="create-po">Create PO</option>
                                        <option value="drafts-po">Drafts PO</option>
                                        <option value="active-po">Active PO</option>
                                        <option value="auditing-po">Auditing PO</option>
                                        <option value="audited-po">Audited PO</option>
                                    </select>
                                    <div className={`absolute inset-y-0 right-0 flex items-center px-2 pointer-events-none ${isPOActive ? 'text-purple-400' : 'text-slate-400'}`}>
                                        <i className="fas fa-chevron-down text-xs"></i>
                                    </div>
                                </div>
                            </div>
                        </div>

                        {/* 2. Internal Transfer Control (Middle) */}
                        <div className={`flex flex-row items-center gap-3 p-4 rounded-xl border transition-all duration-200 ${isTransferActive ? 'bg-blue-500/10 border-blue-500/50 shadow-lg shadow-blue-900/20' : 'bg-slate-800/50 border-slate-700 hover:bg-slate-800'}`}>
                            <div className={`p-3 rounded-lg hidden sm:flex items-center justify-center w-12 h-12 shrink-0 ${isTransferActive ? 'bg-blue-500 text-white shadow-inner' : 'bg-slate-700 text-slate-400'}`}>
                                <i className="fas fa-exchange-alt text-lg"></i>
                            </div>
                            <div className="flex-1 w-full min-w-0">
                                <label className={`block text-xs font-bold uppercase tracking-wider mb-1.5 ${isTransferActive ? 'text-blue-300' : 'text-slate-400'}`}>Internal Transfer</label>
                                <div className="relative">
                                    <select 
                                        value={isTransferActive ? activeTab : ''} 
                                        onChange={(e) => handleTabChange(e.target.value)} 
                                        className={`w-full pl-3 pr-8 py-2 rounded-lg border text-sm font-medium outline-none appearance-none cursor-pointer transition-colors ${isTransferActive ? 'bg-slate-900 text-blue-100 border-blue-500/50 focus:ring-1 focus:ring-blue-500' : 'bg-slate-700 text-slate-300 border-slate-600 hover:border-slate-500'}`}
                                    >
                                        {!isTransferActive && <option value="" disabled>Select Action...</option>}
                                        <option value="internal-transfer">New Request</option>
                                        <option value="drafts">Drafts</option>
                                        <option value="active-transfer">Active Transfers</option>
                                        <option value="transfer-report">Transfer Log</option>
                                    </select>
                                    <div className={`absolute inset-y-0 right-0 flex items-center px-2 pointer-events-none ${isTransferActive ? 'text-blue-400' : 'text-slate-400'}`}>
                                        <i className="fas fa-chevron-down text-xs"></i>
                                    </div>
                                </div>
                            </div>
                        </div>

                        {/* 3. Production Control (Last) */}
                        <div className={`flex flex-row items-center gap-3 p-4 rounded-xl border transition-all duration-200 ${isProductionActive ? 'bg-emerald-500/10 border-emerald-500/50 shadow-lg shadow-emerald-900/20' : 'bg-slate-800/50 border-slate-700 hover:bg-slate-800'}`}>
                            <div className={`p-3 rounded-lg hidden sm:flex items-center justify-center w-12 h-12 shrink-0 ${isProductionActive ? 'bg-emerald-500 text-white shadow-inner' : 'bg-slate-700 text-slate-400'}`}>
                                <i className="fas fa-boxes text-lg"></i>
                            </div>
                            <div className="flex-1 w-full min-w-0">
                                <label className={`block text-xs font-bold uppercase tracking-wider mb-1.5 ${isProductionActive ? 'text-emerald-300' : 'text-slate-400'}`}>Production</label>
                                <div className="relative">
                                    <select 
                                        value={isProductionActive ? activeTab : ''} 
                                        onChange={(e) => handleTabChange(e.target.value)} 
                                        className={`w-full pl-3 pr-8 py-2 rounded-lg border text-sm font-medium outline-none appearance-none cursor-pointer transition-colors ${isProductionActive ? 'bg-slate-900 text-emerald-100 border-emerald-500/50 focus:ring-1 focus:ring-emerald-500' : 'bg-slate-700 text-slate-300 border-slate-600 hover:border-slate-500'}`}
                                    >
                                        {!isProductionActive && <option value="" disabled>Select Action...</option>}
                                        <option value="product-list">Product List</option>
                                        <option value="vendor-list">Vendor List</option>
                                    </select>
                                    <div className={`absolute inset-y-0 right-0 flex items-center px-2 pointer-events-none ${isProductionActive ? 'text-emerald-400' : 'text-slate-400'}`}>
                                        <i className="fas fa-chevron-down text-xs"></i>
                                    </div>
                                </div>
                            </div>
                        </div>

                    </div>
                </Card>
                
                {/* --- RENDER CONTENT BASED ON TAB --- */}

                {/* Internal Transfer Views */}
                {activeTab === 'drafts' && <TransferReport title="Draft Transfers" transfers={getTransfersByStatus('draft')} loading={transfersLoading} onEdit={handleEditTransfer} onViewReq={setViewReqTransfer} onDelete={openDeleteTransferModal} showFilters={true} filters={{ fromShop: fromShopFilter, toShop: toShopFilter, dateFilter: dateFilter, searchTerm: searchTerm }} onFilterChange={{ setFromShop: setFromShopFilter, setToShop: setToShopFilter, setDateFilter: setDateFilter, setSearchTerm: setSearchTerm }} />}
                {activeTab === 'active-transfer' && <TransferReport title="Active Transfers" transfers={getTransfersByStatus('active')} loading={transfersLoading} onEdit={handleEditTransfer} onViewReq={setViewReqTransfer} onDelete={openDeleteTransferModal} showFilters={true} filters={{ fromShop: fromShopFilter, toShop: toShopFilter, dateFilter: dateFilter, searchTerm: searchTerm }} onFilterChange={{ setFromShop: setFromShopFilter, setToShop: setToShopFilter, setDateFilter: setDateFilter, setSearchTerm: setSearchTerm }} />}
                {activeTab === 'transfer-report' && <TransferReport title="Internal Transfer Log" transfers={getTransfersByStatus('done')} loading={transfersLoading} onEdit={handleEditTransfer} onViewReq={setViewReqTransfer} showFilters={true} filters={{ fromShop: fromShopFilter, toShop: toShopFilter, dateFilter: dateFilter, searchTerm: searchTerm }} onFilterChange={{ setFromShop: setFromShopFilter, setToShop: setToShopFilter, setDateFilter: setDateFilter, setSearchTerm: setSearchTerm }} />}
                {activeTab === 'internal-transfer' && <InternalTransfer transferDataToEdit={transferDataToEdit} userProfile={userProfile} setActiveTab={setActiveTab} onEdit={handleEditTransfer} onViewReq={setViewReqTransfer} activeTransfers={activeTransfers} />}
                
                {/* Purchase Order Views (Moved from POCenterPage) */}
                {activeTab === 'create-po' && <PORequestPage poDataToEdit={poDataForEdit} setPage={handleSetPage} userProfile={userProfile} />}
                {activeTab === 'drafts-po' && <POList pos={allPOs} loading={posLoading} status="draft" setPage={handleSetPage} userProfile={userProfile} />}
                {activeTab === 'active-po' && <POList pos={allPOs} loading={posLoading} status="submitted" setPage={handleSetPage} userProfile={userProfile} />}
                {activeTab === 'auditing-po' && <POList pos={allPOs} loading={posLoading} status="auditing" setPage={handleSetPage} userProfile={userProfile} />}
                {activeTab === 'audited-po' && <POList pos={allPOs} loading={posLoading} status="audited" setPage={handleSetPage} userProfile={userProfile} />}

                {/* Production Views */}
                {activeTab === 'product-list' && <ProductList userProfile={userProfile} />}
                {activeTab === 'vendor-list' && <VendorList userProfile={userProfile} />}
            </div>
        );
    };

    // Helper to render transfer modals outside the main flow
    const renderModalForView = (viewReqTransfer, setViewReqTransfer, activeTransfers) => {
        if (!viewReqTransfer) return null;
        if (viewReqTransfer.status === 'done') {
            return <TransferViewModal transferData={viewReqTransfer} onClose={() => setViewReqTransfer(null)} />;
        } else {
            return <TransferAuditModal transferData={viewReqTransfer} activeTransfers={activeTransfers} onClose={() => setViewReqTransfer(null)} />;
        }
    };

    const InternalTransfer = ({ userProfile, setActiveTab, transferDataToEdit, onEdit, onViewReq, activeTransfers }) => {
        const { shops, products } = useData();
        const [transferId, setTransferId] = useState('');
        const [fromShopId, setFromShopId] = useState('');
        const [toShopId, setToShopId] = useState('');
        const [transferNo, setTransferNo] = useState('');
        const [transferDate, setTransferDate] = useState(new Date().toLocaleDateString('en-CA'));
        const [items, setItems] = useState([]);
        const [productSearch, setProductSearch] = useState('');
        const [searchResults, setSearchResults] = useState([]);
        const [selectedProduct, setSelectedProduct] = useState(null);
        const [quantity, setQuantity] = useState(1);
        const [note, setNote] = useState('');
        const [isDropdownOpen, setIsDropdownOpen] = useState(false);
        const [highlightedIndex, setHighlightedIndex] = useState(-1);
        const [modalInfo, setModalInfo] = useState({ show: false, title: '', message: '', isError: false });
        const [availableStockInfo, setAvailableStockInfo] = useState(null);
        
        const searchInputRef = useRef(null);
        const qtyInputRef = useRef(null);
        const noteInputRef = useRef(null);
        const searchContainerRef = useRef(null);

        const fuse = useProductSearch();
        const debouncedSearchTerm = useDebounce(productSearch, 250);

        const demandedStock = useMemo(() => {
            if (!activeTransfers || activeTransfers.length === 0 || !fromShopId) {
                return {};
            }

            const demand = {};
            activeTransfers.forEach(transfer => {
                // Only consider transfers from the currently selected "From" shop
                if (transfer.fromShopId === fromShopId) {
                    transfer.items.forEach(item => {
                        demand[item.productId] = (demand[item.productId] || 0) + item.quantity;
                    });
                }
            });
            return demand;
        }, [activeTransfers, fromShopId]);

        const resetForm = useCallback(() => {
            setTransferId(''); setFromShopId(''); setToShopId(''); setTransferNo('');
            setTransferDate(new Date().toLocaleDateString('en-CA'));
            setItems([]); setProductSearch(''); setSelectedProduct(null); setQuantity(1); setNote('');
        }, []);

        useEffect(() => {
            if (transferDataToEdit) {
                setTransferId(transferDataToEdit.id); setFromShopId(transferDataToEdit.fromShopId);
                setToShopId(transferDataToEdit.toShopId); setTransferNo(transferDataToEdit.transferNo);
                setTransferDate(safeToDate(transferDataToEdit.transferDate)?.toLocaleDateString('en-CA') || '');
                setItems(transferDataToEdit.items || []);
            } else {
                resetForm();
            }
        }, [transferDataToEdit, resetForm]);

        useEffect(() => {
            if (selectedProduct && fromShopId) {
                const fromShop = shops.find(s => s.id === fromShopId);
                if (fromShop?.manageStock) {
                    const physicalStock = selectedProduct.stockByShop?.[fromShopId] || 0;
                    const committedStock = demandedStock[selectedProduct.id] || 0;
                    const available = physicalStock - committedStock;
                    setAvailableStockInfo({ physical: physicalStock, committed: committedStock, available });
                } else {
                    setAvailableStockInfo(null); // Reset if shop doesn't manage stock
                }
            } else {
                setAvailableStockInfo(null); // Reset if no product/shop selected
            }
        }, [selectedProduct, fromShopId, shops, demandedStock]);

        useEffect(() => {
            // This effect handles the auto-generation of the transfer number FOR NEW TRANSFERS ONLY.
            // If transferDataToEdit is present, it means we are editing a draft, and this effect should do nothing,
            // allowing the existing transfer number to be preserved from the initial state setup.
            if (transferDataToEdit) {
                return;
            }

            // Logic for new transfers:
            if (toShopId) {
                const shop = shops.find(s => s.id === toShopId);
                if (shop) {
                    const now = new Date();
                    setTransferNo(`${shop.name.replace(/\s+/g, '')}-${now.toISOString().slice(0, 10).replace(/-/g, '')}-${now.getHours()}${now.getMinutes()}`);
                }
            } else {
                // If it's a new transfer and no 'To Shop' is selected, the number should be blank.
                setTransferNo('');
            }
        }, [toShopId, shops, transferDataToEdit]);

        useEffect(() => {
            if (fuse && debouncedSearchTerm.length > 1 && !selectedProduct) {
                const results = fuse.search(debouncedSearchTerm, { limit: 50 });
                setSearchResults(results.map(result => result.item));
                setIsDropdownOpen(true);
                setHighlightedIndex(-1);
            } else {
                setSearchResults([]);
                setIsDropdownOpen(false);
            }
        }, [debouncedSearchTerm, fuse, selectedProduct]);

        const handleProductSearchChange = (e) => {
            setProductSearch(e.target.value);
            setSelectedProduct(null);
        };

        const selectProduct = (product) => {
            setSelectedProduct(product);
            setProductSearch(product.name);
            setIsDropdownOpen(false);
            setSearchResults([]);
            setTimeout(() => qtyInputRef.current?.focus(), 0);
        };
        
        const handleSearchKeyDown = (e) => {
            if (!isDropdownOpen) return;
            if (e.key === 'ArrowDown') {
                e.preventDefault();
                setHighlightedIndex(prev => (prev < searchResults.length - 1 ? prev + 1 : prev));
            } else if (e.key === 'ArrowUp') {
                e.preventDefault();
                setHighlightedIndex(prev => (prev > 0 ? prev - 1 : 0));
            } else if (e.key === 'Enter' || e.key === 'Tab') {
                if (highlightedIndex > -1 && searchResults[highlightedIndex]) {
                    e.preventDefault();
                    selectProduct(searchResults[highlightedIndex]);
                }
            } else if (e.key === 'Escape') {
                setIsDropdownOpen(false);
            }
        };
        
        const handleFormKeyDown = (e) => {
            if (e.key === 'Enter' && document.activeElement === qtyInputRef.current) {
                e.preventDefault();
                noteInputRef.current?.focus();
            }
        };

        const handleAddItem = (e) => {
            e.preventDefault();
            if (!selectedProduct || !fromShopId) {
                setModalInfo({ show: true, title: 'Error', message: 'Please select a product and a "From" shop first.', isError: true });
                return;
            }

            const fromShop = shops.find(s => s.id === fromShopId);
            const requestedQty = Number(quantity);

            // Only perform stock validation if the 'From' shop is configured to manage stock
            if (fromShop?.manageStock) {
                const physicalStock = selectedProduct?.stockByShop?.[fromShopId] || 0;
                const committedStock = demandedStock[selectedProduct.id] || 0;
                const availableStock = physicalStock - committedStock;

                if (requestedQty > availableStock) {
                    setModalInfo({ 
                        show: true, 
                        title: 'Insufficient Stock', 
                        message: `Cannot transfer ${requestedQty}. Available: ${availableStock} (On Hand: ${physicalStock}, Committed: ${committedStock})`, 
                        isError: true 
                    });
                    return;
                }
            }
            
            setItems(prev => [...prev, {
                productId: selectedProduct.id, code: selectedProduct.code, barcode: selectedProduct.barcode || '', name: selectedProduct.name,
                quantity: requestedQty, cost: selectedProduct.cost, note,
            }]);
            setSelectedProduct(null); setProductSearch(''); setQuantity(1); setNote('');
            searchInputRef.current?.focus();
        };
        
        const handleRemoveItem = (index) => setItems(items.filter((_, i) => i !== index));

        const handleEditItem = (index) => {
            const item = items[index];
            setSelectedProduct({ id: item.productId, name: item.name, code: item.code, barcode: item.barcode || '', cost: item.cost });
            setProductSearch(item.name);
            setQuantity(item.quantity);
            setNote(item.note || '');
            handleRemoveItem(index);
            searchInputRef.current?.focus();
        };

        const handleSaveTransfer = async (status) => {
            if (!fromShopId || !toShopId) {
                setModalInfo({ show: true, title: 'Validation Error', message: 'Please select "From" and "To" shops.', isError: true });
                return;
            }
            if (items.length === 0) {
                setModalInfo({ show: true, title: 'Validation Error', message: 'Please add at least one item.', isError: true });
                return;
            }
            const fromShop = shops.find(s => s.id === fromShopId);
            const toShop = shops.find(s => s.id === toShopId);
            
            // Always recalculate total amount to ensure accuracy
            const finalTotalAmount = items.reduce((sum, item) => sum + (item.cost * item.quantity), 0);

            const transferData = {
                transferNo, fromShopId, fromShopName: fromShop?.name, toShopId, toShopName: toShop?.name,
                transferDate: new Date(transferDate), items, totalAmount: finalTotalAmount, status,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
            };
            try {
                if (transferId) {
                    // Update existing document
                    await db.collection("internalTransfers").doc(transferId).update(transferData);
                } else {
                    // Create new document, setting creator and creation date
                    transferData.createdBy = userProfile.name;
                    transferData.createdAt = firebase.firestore.FieldValue.serverTimestamp();
                    await db.collection("internalTransfers").add(transferData);
                }
                setModalInfo({ show: true, title: 'Success', message: `Transfer saved as ${status}.` });
                resetForm();
                if (status === 'active') {
                    setActiveTab('active-transfer');
                }
                // If status is 'draft', we stay on the current tab.
            } catch (error) {
                setModalInfo({ show: true, title: 'Error', message: 'Failed to save transfer.', isError: true });
            }
        };
        
        const totalAmount = useMemo(() => items.reduce((sum, item) => sum + (item.cost * item.quantity), 0), [items]);

        return (
            <div className="space-y-6 mt-6">
                <MessageModal {...modalInfo} show={modalInfo.show} onClose={() => setModalInfo({ show: false })} />
                
                <Card>
                    {/* ... Internal Transfer Form ... */}
                    <CardTitle>{transferId ? 'Edit Internal Transfer' : 'New Internal Transfer'}</CardTitle>
                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                        <div>
                            <label className="block text-sm font-medium text-slate-300 mb-1">
                                <i className="fas fa-calendar-day text-blue-400 mr-2"></i>Date
                            </label>
                            <input type="date" value={transferDate} onChange={e => setTransferDate(e.target.value)} className="w-full px-3 py-2 border border-slate-600 rounded-md bg-slate-700 text-slate-200" style={{colorScheme: 'dark'}}/>
                        </div>
                        <div>
                            <label className="block text-sm font-medium text-slate-300 mb-1">
                                <i className="fas fa-store-alt text-orange-400 mr-2"></i>From Shop
                            </label>
                            <select value={fromShopId} onChange={(e) => setFromShopId(e.target.value)} className="w-full bg-slate-700 text-slate-100 px-3 py-2 border border-slate-600 rounded-md">
                                <option value="">Select From</option>
                                {shops.map(s => <option key={s.id} value={s.id}>{s.name}</option>)}
                            </select>
                        </div>
                        <div>
                            <label className="block text-sm font-medium text-slate-300 mb-1">
                                <i className="fas fa-map-marker-alt text-emerald-400 mr-2"></i>To Shop
                            </label>
                            <select value={toShopId} onChange={(e) => setToShopId(e.target.value)} className="w-full bg-slate-700 text-slate-100 px-3 py-2 border border-slate-600 rounded-md">
                                <option value="">Select To</option>
                                {shops.filter(s => s.id !== fromShopId).map(s => <option key={s.id} value={s.id}>{s.name}</option>)}
                            </select>
                        </div>
                        <div>
                            <label className="block text-sm font-medium text-slate-300 mb-1">
                                <i className="fas fa-hashtag text-purple-400 mr-2"></i>Transfer No.
                            </label>
                            <input type="text" value={transferNo} readOnly className="w-full px-3 py-2 border border-slate-600 rounded-md bg-slate-700 text-slate-300" />
                        </div>
                    </div>
                </Card>

                <Card>
                    <h4 className="text-xl font-semibold text-slate-200 mb-4">Add Product</h4>
                    {/* ... Rest of Internal Transfer Form Logic is preserved ... */}
                    <form onSubmit={handleAddItem} onKeyDown={handleFormKeyDown}>
                        <div className="grid grid-cols-1 md:grid-cols-12 gap-4 items-end">
                            {/* ... product search inputs ... */}
                            <div className="md:col-span-5 relative" ref={searchContainerRef}>
                                <label className="block text-sm font-medium text-slate-300 mb-1">
                                    <i className="fas fa-search text-teal-400 mr-2"></i>Select Product
                                </label>
                                <input 
                                    ref={searchInputRef} type="text" value={productSearch} 
                                    onChange={handleProductSearchChange} onKeyDown={handleSearchKeyDown}
                                    onFocus={() => setIsDropdownOpen(searchResults.length > 0)}
                                    className="w-full bg-slate-700 text-slate-100 px-3 py-2 border border-slate-600 rounded-md" autoComplete="off" 
                                />
                                {isDropdownOpen && searchResults.length > 0 && (
                                    <div className="absolute z-10 w-full bg-slate-800 border border-slate-600 rounded-md mt-1 shadow-lg max-h-60 overflow-y-auto">
                                        {searchResults.map((p, index) => (
                                            <div key={p.id} onClick={() => selectProduct(p)} className={`p-2 cursor-pointer hover:bg-slate-700 ${index === highlightedIndex ? 'bg-blue-600' : ''}`}>
                                                <p className="font-semibold text-slate-200">{p.name}</p>
                                                <div className="text-sm text-slate-400">
                                                    <div>Code: {p.code}</div>
                                                    <div>Barcode: {p.barcode || 'N/A'}</div>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                )}
                            </div>
                            <div className="md:col-span-2">
                                <label className="block text-sm font-medium text-slate-300 mb-1">
                                    <i className="fas fa-boxes text-indigo-400 mr-2"></i>Available Stock
                                </label>
                                <div className="w-full bg-slate-800 text-slate-300 px-3 py-2 border border-slate-700 rounded-md h-[42px] flex items-center justify-center text-sm">
                                    {availableStockInfo !== null ? (
                                        <div className="text-center" title={`On Hand: ${availableStockInfo.physical}\nCommitted in other transfers: ${availableStockInfo.committed}`}>
                                            <span className={`font-bold text-lg ${availableStockInfo.available > 0 ? 'text-green-400' : 'text-red-400'}`}>
                                                {availableStockInfo.available}
                                            </span>
                                        </div>
                                    ) : (
                                        <span className="text-slate-500">-</span>
                                    )}
                                </div>
                            </div>
                            <div className="md:col-span-1">
                                <label className="block text-sm font-medium text-slate-300 mb-1">
                                    <i className="fas fa-sort-numeric-up text-yellow-400 mr-2"></i>QTY
                                </label>
                                <input ref={qtyInputRef} type="number" value={quantity} onChange={e => setQuantity(e.target.value)} min="1" className="w-full bg-slate-700 text-slate-100 px-3 py-2 border border-slate-600 rounded-md h-[42px]" />
                            </div>
                            <div className="md:col-span-3">
                                <label className="block text-sm font-medium text-slate-300 mb-1">
                                    <i className="fas fa-sticky-note text-pink-400 mr-2"></i>Note
                                </label>
                                <input ref={noteInputRef} type="text" value={note} onChange={e => setNote(e.target.value)} className="w-full bg-slate-700 text-slate-100 px-3 py-2 border border-slate-600 rounded-md h-[42px]" />
                            </div>
                            <div className="md:col-span-1">
                                <button type="submit" className="w-full bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 h-[42px]">Add</button>
                            </div>
                        </div>
                    </form>
                </Card>

                <TableCard title="Transfer Items">
                    <table className="min-w-full divide-y divide-slate-700 responsive-table">
                        <thead className="bg-slate-900/50">
                            <tr>
                                <th className="px-2 py-3 text-left text-xs font-semibold text-slate-400 uppercase">No.</th>
                                <th className="px-2 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Product Code</th>
                                <th className="px-2 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Name</th>
                                <th className="px-2 py-3 text-center text-xs font-semibold text-slate-400 uppercase">Available QTY</th>
                                <th className="px-2 py-3 text-center text-xs font-semibold text-slate-400 uppercase">QTY</th>
                                <th className="px-2 py-3 text-right text-xs font-semibold text-slate-400 uppercase">Cost</th>
                                <th className="px-2 py-3 text-right text-xs font-semibold text-slate-400 uppercase">Sub-Total</th>
                                <th className="px-2 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Note</th>
                                <th className="px-2 py-3 text-center text-xs font-semibold text-slate-400 uppercase">Actions</th>
                            </tr>
                        </thead>
                        <tbody className="divide-y divide-slate-700">
                            {items.map((item, index) => {
                                const product = products.find(p => p.id === item.productId);
                                const physicalStock = product?.stockByShop?.[fromShopId] || 0;
                                const committedStock = demandedStock[item.productId] || 0;
                                const availableStock = physicalStock - committedStock;
                                
                                return (
                                <tr key={index}>
                                    <td data-label="No." className="px-2 py-2 text-sm text-slate-400">{index + 1}</td>
                                    <td data-label="Product Code" className="px-2 py-2 text-sm text-slate-300">{item.code}</td>
                                    <td data-label="Name" className="px-2 py-2 text-sm text-slate-300">{item.name}</td>
                                    <td data-label="Available QTY" className="px-2 py-2 text-sm md:text-center font-bold text-green-400">{availableStock}</td>
                                    <td data-label="QTY" className="px-2 py-2 text-sm md:text-center text-slate-300">{item.quantity}</td>
                                    <td data-label="Cost" className="px-2 py-2 text-sm md:text-right text-slate-300">{khrFormatter.format(item.cost)}</td>
                                    <td data-label="Sub-Total" className="px-2 py-2 text-sm md:text-right text-slate-300">{khrFormatter.format(item.cost * item.quantity)}</td>
                                    <td data-label="Note" className="px-2 py-2 text-sm text-slate-300">{item.note}</td>
                                    <td data-label="Actions" className="px-2 py-2 md:text-center space-x-4 actions-cell">
                                        <button type="button" onClick={() => handleEditItem(index)} className="text-blue-400 hover:text-blue-300"><i className="fas fa-edit"></i></button>
                                        <button type="button" onClick={() => handleRemoveItem(index)} className="text-red-500 hover:text-red-400"><i className="fas fa-trash"></i></button>
                                    </td>
                                </tr>
                            )})}
                        </tbody>
                        <tfoot className="bg-slate-900/50">
                            <tr>
                                <td colSpan="6" className="px-2 py-3 text-right text-sm font-bold text-slate-300 uppercase">Total</td>
                                <td className="px-2 py-3 text-right text-sm font-bold text-slate-200">{khrFormatter.format(totalAmount)}</td>
                                <td colSpan="2"></td>
                            </tr>
                        </tfoot>
                    </table>
                </TableCard>
                <div className="mt-8 flex justify-end gap-3">
                    <button type="button" onClick={() => setActiveTab('transfer-report')} className="bg-slate-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-slate-500">Cancel</button>
                    <button onClick={() => handleSaveTransfer('draft')} className="bg-yellow-500 text-white font-bold py-2 px-6 rounded-lg hover:bg-yellow-600">Save Draft</button>
                    <button onClick={() => handleSaveTransfer('active')} className="bg-green-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-green-700">{transferId ? 'Update' : 'Submit'}</button>
                </div>
            </div>
        );
    };

    // --- Transfer Audit Modal (Restored) ---
    const TransferAuditModal = ({ transferData, activeTransfers, onClose }) => {
        const { shops, products } = useData();
        const [items, setItems] = useState([]);
        const [modalInfo, setModalInfo] = useState({ show: false, title: '', message: '', isError: false });

        const previewRef = useRef(null);
        const [loading, setLoading] = useState(false);
        const [isValidated, setIsValidated] = useState(false); // New state for validation

        // OPTIMIZATION: Create a product map for O(1) lookups instead of O(n) .find() in loops.
        // This dramatically improves performance for large product lists.
        const productMap = useMemo(() => {
            if (!products || products.length === 0) return new Map();
            return new Map(products.map(p => [p.id, p]));
        }, [products]);

        const fromShopId = transferData.fromShopId;
        const demandedStock = useMemo(() => {
            if (!activeTransfers || activeTransfers.length === 0 || !fromShopId) {
                return {};
            }

            const demand = {};
            activeTransfers.forEach(transfer => {
                // Only consider transfers from the currently selected "From" shop
                if (transfer.fromShopId === fromShopId) {
                    transfer.items.forEach(item => {
                        demand[item.productId] = (demand[item.productId] || 0) + item.quantity;
                    });
                }
            });
            return demand;
        }, [activeTransfers, fromShopId]);

        useEffect(() => {
            // Use the memoized productMap for initialization
            if (productMap.size > 0) {
                setItems(transferData.items.map(item => ({
                    ...item,
                    barcode: item.barcode || (productMap.get(item.productId)?.barcode || '')
                })));
            } else {
                setItems(transferData.items.map(item => ({ ...item }))); // Fallback if products aren't loaded yet
            }
        }, [transferData, productMap]); // Depend on productMap now

        const handleQtyChange = (index, newQty) => {
            const newItems = [...items];
            newItems[index].quantity = Number(newQty);
            setItems(newItems);
            setIsValidated(false); // Reset validation on change
        };

        const handleSaveReview = async () => {
            const newTotalAmount = items.reduce((sum, item) => sum + ((item.quantity || 0) * (item.cost || 0)), 0);
            try {
                await db.collection("internalTransfers").doc(transferData.id).update({
                    items: items, // Save the updated quantities
                    totalAmount: newTotalAmount,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    // Status remains 'active'
                });
                setModalInfo({ show: true, title: 'Success', message: 'Review progress has been saved.' });
                // We don't close the modal on save, so the user can continue working.
            } catch (error) {
                console.error("Error saving transfer review:", error);
                setModalInfo({
                    show: true,
                    title: 'Error',
                    message: 'Failed to save review progress.',
                    isError: true
                });
            }
        };

        const handleValidate = () => {
            const validationErrors = [];
            items.forEach((item) => {
                // OPTIMIZATION: Use efficient map lookup
                const product = productMap.get(item.productId);
                if (!product) {
                    validationErrors.push(`Product "${item.name}" could not be found.`);
                    return; 
                }

                const fromShop = shops.find(s => s.id === fromShopId);
                if (!fromShop?.manageStock) {
                    return; // Skip stock check for shops that don't manage it
                }

                const physicalStock = product.stockByShop?.[fromShopId] || 0;
                
                // Find what was originally requested in this transfer to calculate commitments accurately
                const originalItem = transferData.items.find(i => i.productId === item.productId);
                const originalCommittedQty = originalItem ? originalItem.quantity : 0;
                
                // Calculate stock committed to *other* active transfers
                const committedForOtherTransfers = (demandedStock[item.productId] || 0) - originalCommittedQty;
                
                // The stock truly available for *this* specific transfer
                const availableStock = physicalStock - committedForOtherTransfers;
                
                const receivedQty = item.quantity || 0;

                if (receivedQty > availableStock) {
                    validationErrors.push(`- ${item.name}: Trying to receive ${receivedQty}, but only ${availableStock} is available.`);
                }
            });

            if (validationErrors.length > 0) {
                setModalInfo({
                    show: true,
                    title: 'Validation Failed',
                    message: `Please check product lines again. Insufficient stock for:\n${validationErrors.join('\n')}`,
                    isError: true
                });
                setIsValidated(false);
            } else {
                setModalInfo({
                    show: true,
                    title: 'Validation Successful',
                    message: 'All items have sufficient stock and are ready to be transferred.',
                    isError: false
                });
                setIsValidated(true);
            }
        };

        const handleCompleteTransfer = async () => {
            if (!isValidated) {
                setModalInfo({
                    show: true,
                    title: 'Validation Required',
                    message: 'Please validate the transfer quantities before completing.',
                    isError: true
                });
                return;
            }

            setLoading(true);

            try {
                const batch = db.batch();
                const transferRef = db.collection("internalTransfers").doc(transferData.id);

                const newTotalAmount = items.reduce((sum, item) => sum + ((item.quantity || 0) * (item.cost || 0)), 0);

                // 1. Update the transfer document's status and final item quantities
                batch.update(transferRef, {
                    status: 'done',
                    items: items,
                    totalAmount: newTotalAmount,
                    completedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });

                const fromShop = shops.find(s => s.id === transferData.fromShopId);
                const toShop = shops.find(s => s.id === transferData.toShopId);

                // 2. Update stock levels for each item in the transfer
                items.forEach(item => {
                    if (!item.productId) return;

                    const productRef = db.collection("products").doc(item.productId);
                    const receivedQty = item.quantity || 0;

                    if (receivedQty > 0) {
                        // Decrement stock from the 'from' shop if it manages stock
                        if (fromShop?.manageStock) {
                            batch.update(productRef, {
                                [`stockByShop.${transferData.fromShopId}`]: firebase.firestore.FieldValue.increment(-receivedQty)
                            });
                        }
                        // Increment stock in the 'to' shop if it manages stock
                        if (toShop?.manageStock) {
                            batch.update(productRef, {
                                [`stockByShop.${transferData.toShopId}`]: firebase.firestore.FieldValue.increment(receivedQty)
                            });
                        }

                        // Add product movement log for transfer
                        const movementRef = db.collection("productMovement").doc();
                        batch.set(movementRef, {
                            productId: item.productId,
                            productCode: item.code,
                            productName: item.name,
                            type: 'Transfer',
                            quantityChange: receivedQty,
                            from: fromShop?.name || 'N/A',
                            to: toShop?.name || 'N/A',
                            referenceNo: transferData.transferNo,
                            timestamp: firebase.firestore.FieldValue.serverTimestamp()
                        });
                    }
                });

                // 3. Commit all database changes at once
                await batch.commit();
                
                onClose(); // Close the modal on success

            } catch (error) {
                console.error("Error completing transfer:", error);
                setModalInfo({
                    show: true,
                    title: 'Error',
                    message: 'An error occurred while completing the transfer. Stock may not be updated.',
                    isError: true
                });
            } finally {
                setLoading(false);
            }
        };

        const handleExportToExcel = () => {
            const fromShop = shops.find(s => s.id === transferData.fromShopId)?.name || '';
            const toShop = shops.find(s => s.id === transferData.toShopId)?.name || '';
            const transferDate = formatDateDDMMYYYY(transferData.transferDate);
            const wb = XLSX.utils.book_new();
            const ws_data = [];

            const headerStyle = { font: { bold: true } };
            ws_data.push([{v: 'Internal Transfer Review', s: { font: { sz: 16, bold: true } } }]);
            ws_data.push([]);
            ws_data.push([{v: 'From Shop:', s: headerStyle}, fromShop, null, {v: 'Transfer No.:', s: headerStyle}, transferData.transferNo]);
            ws_data.push([{v: 'To Shop:', s: headerStyle}, toShop, null, {v: 'Date:', s: headerStyle}, transferDate]);
            ws_data.push([]);

            const tableHeader = ['No', 'Product Code', 'Barcode', 'Name', 'Req.QTY', 'Rec.QTY', 'Cost ()', 'Sub-Total ()', 'Note'];
            ws_data.push(tableHeader.map(h => ({v: h, s: headerStyle})));

            let totalAmount = 0;
            items.forEach((item, index) => {
                const requestedQty = transferData.items[index]?.quantity || 0;
                const receivedQty = item.quantity || 0;
                const cost = item.cost || 0;
                const subTotal = receivedQty * cost;
                totalAmount += subTotal;
                ws_data.push([
                    index + 1, item.code, item.barcode || '', item.name, requestedQty, receivedQty,
                    { t: 'n', v: cost, z: '#,##0' },
                    { t: 'n', v: subTotal, z: '#,##0' },
                    item.note || ''
                ]);
            });

            ws_data.push([]);
            ws_data.push([null, null, null, null, null, null, {v: 'Total ():', s: headerStyle}, {t: 'n', v: totalAmount, z: '#,##0'}]);
            const ws = XLSX.utils.aoa_to_sheet(ws_data);
            ws['!cols'] = [ {wch:5}, {wch:15}, {wch:15}, {wch:40}, {wch:10}, {wch:10}, {wch:15}, {wch:15}, {wch:20} ];
            XLSX.utils.book_append_sheet(wb, ws, 'Transfer Review');
            XLSX.writeFile(wb, `Transfer-Review-${transferData.transferNo}.xlsx`);
        };

        const handlePrintPdf = () => {
            setLoading(true);
            // Use a short timeout to ensure the DOM is fully rendered before capture
            setTimeout(() => {
                const input = previewRef.current;
                if (!input) {
                    setLoading(false);
                    return;
                }
                
                const originalColor = input.style.color;
                input.style.color = 'black';

                html2canvas(input, {
                    scale: 2,
                    backgroundColor: '#ffffff',
                    useCORS: true,
                    windowHeight: input.scrollHeight 
                }).then(sourceCanvas => {
                    const { jsPDF } = window.jspdf;
                    
                    const pdf = new jsPDF({
                        orientation: 'landscape',
                        unit: 'mm',
                        format: 'a4'
                    });

                    const topMargin = 10, bottomMargin = 10, leftMargin = 10, rightMargin = 10;
                    const pdfWidth = pdf.internal.pageSize.getWidth();
                    const pdfHeight = pdf.internal.pageSize.getHeight();
                    
                    const usableWidth = pdfWidth - leftMargin - rightMargin;
                    const usableHeight = pdfHeight - topMargin - bottomMargin;
                    
                    const sourceCanvasWidth = sourceCanvas.width;
                    const sourceCanvasHeight = sourceCanvas.height;

                    const pageHeightInPixels = sourceCanvasWidth * (usableHeight / usableWidth);
                    const table = input.querySelector('table');
                    const rows = table ? Array.from(table.querySelectorAll('tbody tr')) : [];

                    // --- FIX: Use getBoundingClientRect for accurate positioning relative to the captured element ---
                    const inputTop = input.getBoundingClientRect().top;
                    const rowBottomsOnCanvas = rows.map(row => (row.getBoundingClientRect().bottom - inputTop) * 2); // Scale is 2
                    const tableTopOnCanvas = table ? (table.getBoundingClientRect().top - inputTop) * 2 : -1; // Scale is 2

                    let yOffset = 0;
                    const pages = [];

                    while (yOffset < sourceCanvasHeight) {
                        let potentialSliceEnd = yOffset + pageHeightInPixels;
                        let actualSliceEnd = potentialSliceEnd;

                        if (table && potentialSliceEnd > tableTopOnCanvas && potentialSliceEnd < sourceCanvasHeight) {
                            // Find the last row that fits completely within this potential slice
                            const lastFittingRowBottom = rowBottomsOnCanvas
                                .filter(bottom => bottom > yOffset && bottom <= potentialSliceEnd)
                                .pop();
                            
                            if (lastFittingRowBottom) {
                                // If we found a row to break after, set the slice end to its bottom
                                actualSliceEnd = lastFittingRowBottom;
                            }
                        }

                        const sliceHeight = Math.min(actualSliceEnd - yOffset, sourceCanvasHeight - yOffset);
                        if (sliceHeight <= 0) break;

                        const tempCanvas = document.createElement('canvas');
                        tempCanvas.width = sourceCanvasWidth;
                        tempCanvas.height = sliceHeight;
                        const tempCtx = tempCanvas.getContext('2d');
                        
                        tempCtx.drawImage(sourceCanvas, 0, yOffset, sourceCanvasWidth, sliceHeight, 0, 0, sourceCanvasWidth, sliceHeight);
                        
                        pages.push({
                            dataUrl: tempCanvas.toDataURL('image/jpeg', 0.90),
                            height: sliceHeight
                        });

                        yOffset += sliceHeight;
                    }

                    pages.forEach((page, index) => {
                        if (index > 0) {
                            pdf.addPage();
                        }
                        
                        const sliceHeightOnPdf = usableWidth / (sourceCanvasWidth / page.height);
                        pdf.addImage(page.dataUrl, 'JPEG', leftMargin, topMargin, usableWidth, sliceHeightOnPdf);
                        
                        pdf.setFontSize(8);
                        pdf.setTextColor(0);
                        const pageNumberText = `Page ${index + 1} of ${pages.length}`;
                        const textWidth = pdf.getStringUnitWidth(pageNumberText) * pdf.internal.getFontSize() / pdf.internal.scaleFactor;
                        const textX = (pdfWidth - textWidth) / 2;
                        const textY = pdfHeight - bottomMargin + 4;
                        pdf.text(pageNumberText, textX, textY);
                    });

                    pdf.save(`Transfer-Review-${transferData.transferNo}.pdf`);
                }).catch(err => {
                    console.error("Failed to generate PDF:", err);
                    setModalInfo({ show: true, title: 'Error', message: 'Failed to generate PDF.', isError: true });
                }).finally(() => {
                    if (input) {
                        input.style.color = originalColor;
                    }
                    setLoading(false);
                });
            }, 150);
        };

        const fromShop = shops.find(s => s.id === transferData.fromShopId)?.name || '';
        const toShop = shops.find(s => s.id === transferData.toShopId)?.name || '';
        const transferDate = formatDateDDMMYYYY(transferData.transferDate);
        const newTotalAmount = useMemo(() => items.reduce((sum, item) => sum + ((item.quantity || 0) * (item.cost || 0)), 0), [items]);

        return (
            <Modal show={true} maxWidth="max-w-5xl">
                <MessageModal {...modalInfo} show={modalInfo.show} onClose={() => setModalInfo({ show: false })} />
                <ModalHeader title={`Review Transfer: ${transferData.transferNo}`} onClose={onClose} />
                <ModalBody>
                    <table className="min-w-full divide-y divide-slate-700">
                        <thead className="bg-slate-900/50">
                            <tr>
                                <th className="px-2 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Product Code</th>
                                <th className="px-2 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Barcode</th>
                                <th className="px-2 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Name</th>
                                <th className="px-2 py-3 text-center text-xs font-semibold text-slate-400 uppercase">Available QTY</th>
                                <th className="px-2 py-3 text-center text-xs font-semibold text-slate-400 uppercase">Req.QTY</th>
                                <th className="px-2 py-3 text-center text-xs font-semibold text-slate-400 uppercase">Rec.QTY</th>
                            </tr>
                    </thead>
                    <tbody className="divide-y divide-slate-700">
                        {items.map((item, index) => {
                            // OPTIMIZATION: Use efficient map lookup instead of products.find()
                            const product = productMap.get(item.productId);
                            const physicalStock = product?.stockByShop?.[fromShopId] || 0;
                            
                            // Logic to calculate truly available stock for display
                            const originalItem = transferData.items.find(i => i.productId === item.productId);
                                const originalCommittedQty = originalItem ? originalItem.quantity : 0;
                                const committedForOtherTransfers = (demandedStock[item.productId] || 0) - originalCommittedQty;
                                const availableStock = physicalStock - committedForOtherTransfers;

                                return (
                                <tr key={index}>
                                    <td className="px-2 py-2 text-sm text-slate-300">{item.code}</td>
                                    <td className="px-2 py-2 text-sm text-slate-300">{item.barcode || ''}</td>
                                    <td className="px-2 py-2 text-sm text-slate-300">{item.name}</td>
                                    <td className="px-2 py-2 text-sm text-center font-bold text-green-400" title={`On Hand: ${physicalStock} | Committed to other transfers: ${committedForOtherTransfers}`}>{availableStock}</td>
                                    <td className="px-2 py-2 text-sm text-center text-slate-400">{transferData.items[index].quantity}</td>
                                    <td className="px-2 py-2 text-sm text-center">
                                        <input type="number" value={item.quantity} onChange={(e) => handleQtyChange(index, e.target.value)} className="w-24 bg-slate-700 text-slate-100 px-2 py-1 border border-slate-600 rounded-md text-center"/>
                                    </td>
                                </tr>
                            )})}
                        </tbody>
                    </table>

                    {/* Hidden printable layout */}
                    <div style={{ position: 'absolute', left: '-9999px', top: 'auto' }}>
                        <div ref={previewRef} className="po-preview-capture">
                            <div className="text-center mb-4">
                                <h1 className="text-xl font-bold">Internal Transfer Review</h1>
                            </div>
                            <div className="grid grid-cols-2 gap-x-6 gap-y-1 mb-3 border-y py-2">
                                <span><strong>From Shop:</strong> {fromShop}</span>
                                <span><strong>To Shop:</strong> {toShop}</span>
                                <span><strong>Transfer No.:</strong> {transferData.transferNo}</span>
                                <span><strong>Date:</strong> {transferDate}</span>
                            </div>
                            <table className="w-full text-left border-collapse border border-slate-400">
                                <thead className="bg-slate-200">
                                    <tr>
                                        <th className="border border-slate-300 p-1">No</th>
                                        <th className="border border-slate-300 p-1">Product Code</th>
                                        <th className="border border-slate-300 p-1">Barcode</th>
                                        <th className="border border-slate-300 p-1">Name</th>
                                        <th className="border border-slate-300 p-1 text-center">Req. QTY</th>
                                        <th className="border border-slate-300 p-1 text-center">Rec. QTY</th>
                                        <th className="border border-slate-300 p-1 text-right">Sub-Total</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {items.map((item, index) => (
                                        <tr key={index}>
                                            <td className="border border-slate-300 p-1">{index + 1}</td>
                                            <td className="border border-slate-300 p-1">{item.code}</td>
                                            <td className="border border-slate-300 p-1">{item.barcode || ''}</td>
                                            <td className="border border-slate-300 p-1">{item.name}</td>
                                            <td className="border border-slate-300 p-1 text-center">{transferData.items[index].quantity}</td>
                                            <td className="border border-slate-300 p-1 text-center font-bold">{item.quantity}</td>
                                            <td className="border border-slate-300 p-1 text-right">{khrFormatter.format(item.cost * item.quantity)}</td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                            <div className="flex justify-end mt-4 text-right">
                                <p className="font-bold">Total: {khrFormatter.format(newTotalAmount)}</p>
                            </div>
                            <div className="flex justify-between pt-8 mt-auto">
                                <div><p className="font-bold">Prepared By:</p><p className="mt-8 border-t border-slate-400 pt-1">{transferData.createdBy}</p></div>
                                <div><p className="font-bold">Approved By:</p><p className="mt-8 border-t border-slate-400 pt-1"></p></div>
                                <div><p className="font-bold">Received By:</p><p className="mt-8 border-t border-slate-400 pt-1"></p></div>
                            </div>
                        </div>
                    </div>
                </ModalBody>
                <ModalFooter>
                    <button onClick={onClose} type="button" className="bg-slate-600 text-slate-100 font-bold py-2 px-6 rounded-lg hover:bg-slate-500">Cancel</button>
                    <button onClick={handleSaveReview} type="button" className="bg-yellow-500 text-white font-bold py-2 px-6 rounded-lg hover:bg-yellow-600">Save Progress</button>
                    <button onClick={handlePrintPdf} disabled={loading} type="button" className="bg-red-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-red-700 transition flex items-center gap-2 disabled:bg-red-800">
                        {loading ? <div className="loader"></div> : <i className="fas fa-file-pdf"></i>}
                        {loading ? 'Generating...' : 'Print as PDF'}
                    </button>
                    <button onClick={handleExportToExcel} type="button" className="bg-indigo-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-indigo-700 flex items-center gap-2">
                        <i className="fas fa-file-excel"></i> Export to Excel
                    </button>
                    <button onClick={handleValidate} type="button" className="bg-blue-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-700">
                        Validate
                    </button>
                    <button onClick={handleCompleteTransfer} disabled={!isValidated || loading} type="button" className="bg-green-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-green-700 disabled:bg-green-800 disabled:cursor-not-allowed disabled:text-slate-400">
                         {loading ? <div className="loader"></div> : 'Complete Transfer'}
                    </button>
                </ModalFooter>
            </Modal>
        );
    };

    const TransferViewModal = ({ transferData, onClose }) => {
        const { shops, products } = useData();
        const previewRef = useRef(null);
        const [loading, setLoading] = useState(false);
        const [modalInfo, setModalInfo] = useState({ show: false, title: '', message: '', isError: false });

        const fromShop = shops.find(s => s.id === transferData.fromShopId)?.name || '';
        const toShop = shops.find(s => s.id === transferData.toShopId)?.name || '';
        const transferDate = formatDateDDMMYYYY(transferData.transferDate);
        const totalAmount = useMemo(() => transferData.items.reduce((sum, item) => sum + ((item.quantity || 0) * (item.cost || 0)), 0), [transferData.items]);

        const handleExportToExcel = () => {
            const wb = XLSX.utils.book_new();
            const ws_data = [];
            const headerStyle = { font: { bold: true } };

            ws_data.push([{v: 'Internal Transfer Report', s: { font: { sz: 16, bold: true } } }]);
            ws_data.push([]);
            ws_data.push([{v: 'From Shop:', s: headerStyle}, fromShop, null, {v: 'Transfer No.:', s: headerStyle}, transferData.transferNo]);
            ws_data.push([{v: 'To Shop:', s: headerStyle}, toShop, null, {v: 'Date:', s: headerStyle}, transferDate]);
            ws_data.push([]);
            
            const tableHeader = ['No', 'Product Code', 'Barcode', 'Name', 'Received QTY', 'Cost ()', 'Sub-Total ()', 'Note'];
            ws_data.push(tableHeader.map(h => ({v: h, s: headerStyle})));

            transferData.items.forEach((item, index) => {
                const subTotal = (item.quantity || 0) * (item.cost || 0);
                ws_data.push([
                    index + 1, item.code, item.barcode || '', item.name, item.quantity || 0,
                    { t: 'n', v: item.cost || 0, z: '#,##0' },
                    { t: 'n', v: subTotal, z: '#,##0' },
                    item.note || ''
                ]);
            });

            ws_data.push([]);
            ws_data.push([null, null, null, null, null, {v: 'Total ():', s: headerStyle}, {t: 'n', v: totalAmount, z: '#,##0'}]);
            const ws = XLSX.utils.aoa_to_sheet(ws_data);
            ws['!cols'] = [ {wch:5}, {wch:15}, {wch:15}, {wch:40}, {wch:12}, {wch:15}, {wch:15}, {wch:20} ];
            XLSX.utils.book_append_sheet(wb, ws, 'Transfer Report');
            XLSX.writeFile(wb, `Transfer-Report-${transferData.transferNo}.xlsx`);
        };

        const handlePrintPdf = () => {
            setLoading(true);
            setTimeout(() => {
                const input = previewRef.current;
                if (!input) { setLoading(false); return; }
                const originalColor = input.style.color;
                input.style.color = 'black';
                html2canvas(input, { scale: 2, backgroundColor: '#ffffff', useCORS: true, windowHeight: input.scrollHeight })
                    .then(sourceCanvas => {
                        const { jsPDF } = window.jspdf;
                        const pdf = new jsPDF({ orientation: 'landscape', unit: 'mm', format: 'a4' });
                        
                        const topMargin = 10, bottomMargin = 10, leftMargin = 10, rightMargin = 10;
                        const pdfWidth = pdf.internal.pageSize.getWidth();
                        const pdfHeight = pdf.internal.pageSize.getHeight();
                        
                        const usableWidth = pdfWidth - leftMargin - rightMargin;
                        const usableHeight = pdfHeight - topMargin - bottomMargin;
                        
                        const sourceCanvasWidth = sourceCanvas.width;
                        const sourceCanvasHeight = sourceCanvas.height;

                        const pageHeightInPixels = sourceCanvasWidth * (usableHeight / usableWidth);
                        const table = input.querySelector('table');
                        const rows = table ? Array.from(table.querySelectorAll('tbody tr')) : [];
                        
                        // --- FIX: Use getBoundingClientRect for accurate positioning relative to the captured element ---
                        const inputTop = input.getBoundingClientRect().top;
                        const rowBottomsOnCanvas = rows.map(row => (row.getBoundingClientRect().bottom - inputTop) * 2); // Scale is 2
                        const tableTopOnCanvas = table ? (table.getBoundingClientRect().top - inputTop) * 2 : -1; // Scale is 2

                        let yOffset = 0;
                        const pages = [];

                        while (yOffset < sourceCanvasHeight) {
                            let potentialSliceEnd = yOffset + pageHeightInPixels;
                            let actualSliceEnd = potentialSliceEnd;

                            if (table && potentialSliceEnd > tableTopOnCanvas && potentialSliceEnd < sourceCanvasHeight) {
                                const lastFittingRowBottom = rowBottomsOnCanvas
                                    .filter(bottom => bottom > yOffset && bottom <= potentialSliceEnd)
                                    .pop();
                                
                                if (lastFittingRowBottom) {
                                    actualSliceEnd = lastFittingRowBottom;
                                }
                            }

                            const sliceHeight = Math.min(actualSliceEnd - yOffset, sourceCanvasHeight - yOffset);
                            if (sliceHeight <= 0) break;

                            const tempCanvas = document.createElement('canvas');
                            tempCanvas.width = sourceCanvasWidth;
                            tempCanvas.height = sliceHeight;
                            const tempCtx = tempCanvas.getContext('2d');
                            
                            tempCtx.drawImage(sourceCanvas, 0, yOffset, sourceCanvasWidth, sliceHeight, 0, 0, sourceCanvasWidth, sliceHeight);
                            
                            pages.push({
                                dataUrl: tempCanvas.toDataURL('image/jpeg', 0.90),
                                height: sliceHeight
                            });

                            yOffset += sliceHeight;
                        }

                        pages.forEach((page, index) => {
                            if (index > 0) {
                                pdf.addPage();
                            }
                            
                            const sliceHeightOnPdf = usableWidth / (sourceCanvasWidth / page.height);
                            pdf.addImage(page.dataUrl, 'JPEG', leftMargin, topMargin, usableWidth, sliceHeightOnPdf);
                            
                            pdf.setFontSize(8);
                            pdf.setTextColor(0);
                            const pageNumberText = `Page ${index + 1} of ${pages.length}`;
                            const textWidth = pdf.getStringUnitWidth(pageNumberText) * pdf.internal.getFontSize() / pdf.internal.scaleFactor;
                            const textX = (pdfWidth - textWidth) / 2;
                            const textY = pdfHeight - bottomMargin + 4;
                            pdf.text(pageNumberText, textX, textY);
                        });

                        pdf.save(`Transfer-Report-${transferData.transferNo}.pdf`);
                    }).catch(err => {
                        console.error("Failed to generate PDF:", err);
                        setModalInfo({ show: true, title: 'Error', message: 'Failed to generate PDF.', isError: true });
                    }).finally(() => {
                        if (input) input.style.color = originalColor;
                        setLoading(false);
                    });
            }, 150);
        };

        return (
            <Modal show={true} maxWidth="max-w-5xl">
                <MessageModal {...modalInfo} show={modalInfo.show} onClose={() => setModalInfo({ show: false })} />
                <ModalHeader title={`Transfer Report: ${transferData.transferNo}`} onClose={onClose} />
                <ModalBody>
                     <table className="min-w-full divide-y divide-slate-700">
                        <thead className="bg-slate-900/50">
                            <tr>
                                <th className="px-2 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Product Code</th>
                                <th className="px-2 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Barcode</th>
                                <th className="px-2 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Name</th>
                                <th className="px-2 py-3 text-center text-xs font-semibold text-slate-400 uppercase">Received QTY</th>
                                <th className="px-2 py-3 text-right text-xs font-semibold text-slate-400 uppercase">Cost ()</th>
                                <th className="px-2 py-3 text-right text-xs font-semibold text-slate-400 uppercase">Sub-Total ()</th>
                            </tr>
                        </thead>
                        <tbody className="divide-y divide-slate-700">
                            {transferData.items.map((item, index) => (
                                <tr key={index}>
                                    <td className="px-2 py-2 text-sm text-slate-300">{item.code}</td>
                                    <td className="px-2 py-2 text-sm text-slate-300">{item.barcode || ''}</td>
                                    <td className="px-2 py-2 text-sm text-slate-300">{item.name}</td>
                                    <td className="px-2 py-2 text-sm text-center font-bold text-slate-100">{item.quantity}</td>
                                    <td className="px-2 py-2 text-sm text-right text-slate-400">{khrFormatter.format(item.cost)}</td>
                                    <td className="px-2 py-2 text-sm text-right text-slate-300">{khrFormatter.format(item.cost * item.quantity)}</td>
                                </tr>
                            ))}
                        </tbody>
                         <tfoot className="bg-slate-900/50">
                            <tr>
                                <td colSpan="5" className="px-2 py-3 text-right text-sm font-bold text-slate-300 uppercase">Total</td>
                                <td className="px-2 py-3 text-right text-sm font-bold text-slate-200">{khrFormatter.format(totalAmount)}</td>
                            </tr>
                        </tfoot>
                    </table>
                     {/* Hidden printable layout */}
                    <div style={{ position: 'absolute', left: '-9999px', top: 'auto' }}>
                        <div ref={previewRef} className="po-preview-capture">
                            <div className="text-center mb-4"><h1 className="text-xl font-bold">Internal Transfer Report</h1></div>
                            <div className="grid grid-cols-2 gap-x-6 gap-y-1 mb-3 border-y py-2">
                                <span><strong>From Shop:</strong> {fromShop}</span>
                                <span><strong>To Shop:</strong> {toShop}</span>
                                <span><strong>Transfer No.:</strong> {transferData.transferNo}</span>
                                <span><strong>Date:</strong> {transferDate}</span>
                            </div>
                            <table className="w-full text-left border-collapse border border-slate-400">
                                <thead className="bg-slate-200">
                                    <tr>
                                        <th className="border border-slate-300 p-1">No</th>
                                        <th className="border border-slate-300 p-1">Product Code</th>
                                        <th className="border border-slate-300 p-1">Barcode</th>
                                        <th className="border border-slate-300 p-1">Name</th>
                                        <th className="border border-slate-300 p-1 text-center">Received QTY</th>
                                        <th className="border border-slate-300 p-1 text-right">Sub-Total</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {transferData.items.map((item, index) => (
                                        <tr key={index}>
                                            <td className="border border-slate-300 p-1">{index + 1}</td>
                                            <td className="border border-slate-300 p-1">{item.code}</td>
                                            <td className="border border-slate-300 p-1">{item.barcode || ''}</td>
                                            <td className="border border-slate-300 p-1">{item.name}</td>
                                            <td className="border border-slate-300 p-1 text-center font-bold">{item.quantity}</td>
                                            <td className="border border-slate-300 p-1 text-right">{khrFormatter.format(item.cost * item.quantity)}</td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                            <div className="flex justify-end mt-4 text-right"><p className="font-bold">Total: {khrFormatter.format(totalAmount)}</p></div>
                             <div className="flex justify-between pt-8 mt-auto">
                                <div><p className="font-bold">Prepared By:</p><p className="mt-8 border-t border-slate-400 pt-1">{transferData.createdBy}</p></div>
                                <div><p className="font-bold">Approved By:</p><p className="mt-8 border-t border-slate-400 pt-1"></p></div>
                                <div><p className="font-bold">Received By:</p><p className="mt-8 border-t border-slate-400 pt-1"></p></div>
                            </div>
                        </div>
                    </div>
                </ModalBody>
                <ModalFooter>
                    <button onClick={onClose} type="button" className="bg-slate-600 text-slate-100 font-bold py-2 px-6 rounded-lg hover:bg-slate-500">Close</button>
                    <button onClick={handlePrintPdf} disabled={loading} type="button" className="bg-red-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-red-700 transition flex items-center gap-2 disabled:bg-red-800">
                        {loading ? <div className="loader"></div> : <i className="fas fa-file-pdf"></i>}
                        {loading ? 'Generating...' : 'Print as PDF'}
                    </button>
                    <button onClick={handleExportToExcel} type="button" className="bg-indigo-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-indigo-700 flex items-center gap-2">
                        <i className="fas fa-file-excel"></i> Export to Excel
                    </button>
                </ModalFooter>
            </Modal>
        );
    };


    // --- NEW: Daily Profit Chart Component ---
    const DailyProfitChart = memo(({ salesData }) => {
        const canvasRef = useRef(null);
        const chartRef = useRef(null);

        // Aggregate Data
        const chartData = useMemo(() => {
            const dailyStats = {};
            
            // Sort sales by date ascending
            const validSales = salesData.filter(s => s.status !== 'void').sort((a,b) => {
                const da = safeToDate(a.timestamp);
                const db = safeToDate(b.timestamp);
                return da - db;
            });

            if (validSales.length === 0) return null;

            validSales.forEach(sale => {
                const dateKey = safeToDate(sale.timestamp).toLocaleDateString('en-GB', { day: '2-digit', month: 'short' }); // DD MMM
                if (!dailyStats[dateKey]) {
                    dailyStats[dateKey] = { profit: 0, revenue: 0 };
                }
                dailyStats[dateKey].revenue += sale.grandTotal;
                dailyStats[dateKey].profit += (sale.grandTotal - (sale.totalCost || 0));
            });

            return {
                labels: Object.keys(dailyStats),
                profit: Object.values(dailyStats).map(d => d.profit),
                revenue: Object.values(dailyStats).map(d => d.revenue)
            };
        }, [salesData]);

        useEffect(() => {
            if (!canvasRef.current || !chartData) return;

            // Destroy existing chart if it exists
            if (chartRef.current) {
                chartRef.current.destroy();
            }

            const ctx = canvasRef.current.getContext('2d');
            
            chartRef.current = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: chartData.labels,
                    datasets: [
                        {
                            label: 'Gross Profit',
                            data: chartData.profit,
                            backgroundColor: 'rgba(34, 197, 94, 0.7)', // Green-500 with opacity
                            borderColor: '#22c55e',
                            borderWidth: 1,
                            borderRadius: 4,
                            barPercentage: 0.6,
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            labels: { color: '#94a3b8' }
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed.y !== null) {
                                        label += new Intl.NumberFormat('en-US').format(context.parsed.y) + ' ';
                                    }
                                    return label;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { 
                                color: '#94a3b8',
                                callback: function(value) {
                                    if (value >= 1000000) return (value/1000000).toFixed(1) + 'M';
                                    if (value >= 1000) return (value/1000).toFixed(0) + 'k';
                                    return value;
                                }
                            },
                            grid: { color: '#334155' }
                        },
                        x: {
                            ticks: { color: '#94a3b8' },
                            grid: { display: false }
                        }
                    }
                }
            });

            return () => {
                if (chartRef.current) {
                    chartRef.current.destroy();
                }
            };
        }, [chartData]);

        if (!chartData) return <div className="h-64 flex items-center justify-center text-slate-500 bg-slate-900/30 rounded-lg border border-slate-700">No profit data available for this period.</div>;

        return (
            <div className="relative h-80 w-full bg-slate-900/30 p-4 rounded-lg border border-slate-700">
                <canvas ref={canvasRef}></canvas>
            </div>
        );
    });

    // --- NEW: Sale Report Page ---
    const SaleReportPage = ({ userProfile }) => {
        const { shops } = useData();
        const [activeTab, setActiveTab] = useState('summary');
        const [salesData, setSalesData] = useState([]);
        const [loading, setLoading] = useState(false);
        
        // --- NEW: Lifted Shift State for Export ---
        const [shiftsData, setShiftsData] = useState([]);
        const [shiftsLoading, setShiftsLoading] = useState(false);
        
        // Filter State - Default to Current Month
        const [startDate, setStartDate] = useState(() => {
            const now = new Date();
            return new Date(now.getFullYear(), now.getMonth(), 1).toLocaleDateString('en-CA');
        });
        const [endDate, setEndDate] = useState(() => new Date().toLocaleDateString('en-CA'));
        const [selectedShopId, setSelectedShopId] = useState('');

        // Helper to set quick dates
        const setDateRange = (type) => {
            const today = new Date();
            let start = new Date();
            let end = new Date();

            if (type === 'today') {
                // Default
            } else if (type === 'yesterday') {
                start.setDate(today.getDate() - 1);
                end.setDate(today.getDate() - 1);
            } else if (type === 'thisWeek') {
                const day = today.getDay();
                const diff = today.getDate() - day + (day === 0 ? -6 : 1); // Adjust when day is Sunday
                start.setDate(diff);
            } else if (type === 'lastWeek') {
                const day = today.getDay();
                const diff = today.getDate() - day + (day === 0 ? -6 : 1) - 7;
                start.setDate(diff);
                end.setDate(diff + 6);
            } else if (type === 'thisMonth') {
                start = new Date(today.getFullYear(), today.getMonth(), 1);
            } else if (type === 'lastMonth') {
                start = new Date(today.getFullYear(), today.getMonth() - 1, 1);
                end = new Date(today.getFullYear(), today.getMonth(), 0);
            }

            setStartDate(start.toLocaleDateString('en-CA'));
            setEndDate(end.toLocaleDateString('en-CA'));
        };

        // Fetch Sales Data
        useEffect(() => {
            setLoading(true);
            const start = new Date(startDate);
            start.setHours(0, 0, 0, 0);
            const end = new Date(endDate);
            end.setHours(23, 59, 59, 999);

            let query = db.collection('sales')
                .where('timestamp', '>=', start)
                .where('timestamp', '<=', end);

            if (selectedShopId) {
                query = query.where('shopId', '==', selectedShopId);
            } else if (userProfile.role !== 'Admin' && userProfile.assignedShops?.length > 0) {
                // Basic permission check handled by filtering results below for simplicity with 'in' query limits
            }

            const unsubscribe = query.onSnapshot(snapshot => {
                let fetchedSales = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                if (userProfile.role !== 'Admin' && !selectedShopId) {
                    fetchedSales = fetchedSales.filter(s => (userProfile.assignedShops || []).includes(s.shopId));
                }

                setSalesData(fetchedSales);
                setLoading(false);
            }, err => {
                console.error("Error fetching sales:", err);
                setLoading(false);
            });

            return () => unsubscribe();
        }, [startDate, endDate, selectedShopId, userProfile]);

        // --- NEW: Fetch Shifts Data (Lifted from sub-component) ---
        useEffect(() => {
            setShiftsLoading(true);
            const start = new Date(startDate);
            start.setHours(0, 0, 0, 0);
            const end = new Date(endDate);
            end.setHours(23, 59, 59, 999);

            let query = db.collection('shifts')
                .where('startTime', '>=', start)
                .where('startTime', '<=', end);
            
            if (selectedShopId) {
                query = query.where('shopId', '==', selectedShopId);
            }

            const unsubscribe = query.onSnapshot(snapshot => {
                let shiftData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                // Filter by permission if needed
                if (userProfile.role !== 'Admin' && !selectedShopId) {
                    shiftData = shiftData.filter(s => (userProfile.assignedShops || []).includes(s.shopId));
                }

                setShiftsData(shiftData.sort((a,b) => safeToDate(b.startTime) - safeToDate(a.startTime)));
                setShiftsLoading(false);
            }, err => {
                console.error("Error fetching shifts:", err);
                setShiftsLoading(false);
            });
            return () => unsubscribe();
        }, [startDate, endDate, selectedShopId, userProfile]);

        // --- Aggregation Logic ---
        const summaryStats = useMemo(() => {
            const validSales = salesData.filter(s => s.status !== 'void');
            const totalRevenue = validSales.reduce((sum, s) => sum + s.grandTotal, 0);
            const totalTransactions = validSales.length;
            const avgTicket = totalTransactions > 0 ? totalRevenue / totalTransactions : 0;
            const totalProfit = validSales.reduce((sum, s) => sum + (s.grandTotal - (s.totalCost || 0)), 0);
            
            const paymentMethods = {};
            validSales.forEach(s => {
                paymentMethods[s.paymentMethod] = (paymentMethods[s.paymentMethod] || 0) + s.grandTotal;
            });

            return { totalRevenue, totalTransactions, avgTicket, totalProfit, paymentMethods };
        }, [salesData]);

        const productStats = useMemo(() => {
            const products = {};
            salesData.filter(s => s.status !== 'void').forEach(sale => {
                sale.items.forEach(item => {
                    if (!products[item.productId]) {
                        products[item.productId] = { 
                            name: item.name, 
                            code: item.code, 
                            qty: 0, 
                            revenue: 0,
                            cost: 0 
                        };
                    }
                    products[item.productId].qty += item.quantity;
                    products[item.productId].revenue += (item.price * item.quantity);
                    products[item.productId].cost += (item.cost * item.quantity);
                });
            });
            return Object.values(products).sort((a, b) => b.revenue - a.revenue);
        }, [salesData]);

        const cashierStats = useMemo(() => {
            const cashiers = {};
            salesData.filter(s => s.status !== 'void').forEach(sale => {
                // Group by Shop AND Cashier to show Shop Name clearly
                const key = `${sale.shopId}_${sale.cashierId}`;
                if (!cashiers[key]) {
                    cashiers[key] = { 
                        name: sale.cashierName || 'Unknown', 
                        shopName: sale.shopName || 'Unknown',
                        count: 0, 
                        revenue: 0 
                    };
                }
                cashiers[key].count += 1;
                cashiers[key].revenue += sale.grandTotal;
            });
            return Object.values(cashiers).sort((a, b) => b.revenue - a.revenue);
        }, [salesData]);

        // --- NEW: Sale By Item Aggregation (Detailed Flattened List) ---
        const saleByItems = useMemo(() => {
            const items = [];
            salesData.filter(s => s.status !== 'void').forEach(sale => {
                sale.items.forEach((item, index) => {
                    items.push({
                        uniqueKey: `${sale.id}_${index}`,
                        date: sale.timestamp,
                        receiptNo: sale.receiptNo,
                        shopName: sale.shopName,
                        productName: item.name,
                        code: item.code,
                        quantity: item.quantity,
                        price: item.price,
                        total: item.quantity * item.price
                    });
                });
            });
            // Sort by date descending (newest first)
            return items.sort((a, b) => safeToDate(b.date) - safeToDate(a.date));
        }, [salesData]);

        // --- NEW: Handle Export Logic ---
        const handleExport = () => {
            const wb = XLSX.utils.book_new();
            let ws;
            let filename = `Report_${activeTab}_${startDate}`;

            if (activeTab === 'summary') {
                const data = [
                    ['Sale Summary Report'],
                    ['Period:', `${startDate} to ${endDate}`],
                    ['Shop:', selectedShopId ? shops.find(s=>s.id===selectedShopId)?.name : 'All Shops'],
                    [],
                    ['Total Sales', `${khrFormatter.format(summaryStats.totalRevenue)}`],
                    ['Total Transactions', summaryStats.totalTransactions],
                    ['Average Ticket', `${khrFormatter.format(summaryStats.avgTicket)}`],
                    ['Gross Profit', `${khrFormatter.format(summaryStats.totalProfit)}`],
                    [],
                    ['Payment Method', 'Amount'],
                    ...Object.entries(summaryStats.paymentMethods).map(([k, v]) => [k, v])
                ];
                ws = XLSX.utils.aoa_to_sheet(data);
                ws['!cols'] = [{wch:20}, {wch:20}];
            } 
            else if (activeTab === 'products') {
                const data = productStats.map(p => ({
                    'Product Name': p.name,
                    'Code': p.code,
                    'Qty Sold': p.qty,
                    'Revenue (KHR)': p.revenue,
                    'Profit (KHR)': p.revenue - p.cost
                }));
                ws = XLSX.utils.json_to_sheet(data);
                ws['!cols'] = [{wch:30}, {wch:15}, {wch:10}, {wch:15}, {wch:15}];
            } 
            else if (activeTab === 'items') {
                const data = saleByItems.map(i => ({
                    'Date': i.date ? safeToDate(i.date).toLocaleString() : '',
                    'Receipt #': i.receiptNo,
                    'Shop': i.shopName,
                    'Product': i.productName,
                    'Code': i.code,
                    'Qty': i.quantity,
                    'Price': i.price,
                    'Total': i.total
                }));
                ws = XLSX.utils.json_to_sheet(data);
            } 
            else if (activeTab === 'cashier') {
                const data = cashierStats.map(c => ({
                    'Cashier Name': c.name,
                    'Shop': c.shopName,
                    'Transactions': c.count,
                    'Total Revenue': c.revenue
                }));
                ws = XLSX.utils.json_to_sheet(data);
            } 
            else if (activeTab === 'receipts') {
                const data = salesData.map(s => ({
                    'Date': s.timestamp ? safeToDate(s.timestamp).toLocaleString() : '',
                    'Receipt #': s.receiptNo,
                    'Shop': s.shopName,
                    'Cashier': s.cashierName,
                    'Payment': s.paymentMethod,
                    'Total': s.grandTotal,
                    'Status': s.status
                }));
                ws = XLSX.utils.json_to_sheet(data);
            } 
            else if (activeTab === 'shifts') {
                const data = shiftsData.map(s => {
                    const shop = shops.find(sh => sh.id === s.shopId)?.name || 'Unknown';
                    return {
                        'Shop': shop,
                        'Start Time': s.startTime ? safeToDate(s.startTime).toLocaleString() : '',
                        'End Time': s.endTime ? safeToDate(s.endTime).toLocaleString() : '',
                        'Cashier': s.cashierName,
                        'Tx Count': s.transactionCount,
                        'Start Cash': s.startCash,
                        'Total Sales': s.totalSales,
                        'Actual Cash': s.actualCash,
                        'Variance': s.difference,
                        'Status': s.status
                    };
                });
                ws = XLSX.utils.json_to_sheet(data);
            }

            if (ws) {
                XLSX.utils.book_append_sheet(wb, ws, "Report Data");
                XLSX.writeFile(wb, `${filename}.xlsx`);
            }
        };

        // State for Receipt View Modal
        const [viewReceipt, setViewReceipt] = useState(null);

        return (
            <div className="space-y-6">
                {viewReceipt && (
                    <ReceiptModal 
                        saleData={viewReceipt} 
                        onClose={() => setViewReceipt(null)} 
                    />
                )}

                {/* Filters & Report Type Selector */}
                <Card>
                    <div className="flex flex-col xl:flex-row gap-6 items-end">
                        <div className="flex-1 w-full">
                            {/* ... Date Range UI ... */}
                            <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-2 gap-2">
                                <label className="block text-sm font-medium text-slate-300">
                                    <i className="fas fa-calendar-alt text-blue-400 mr-2"></i>Date Range
                                </label>
                                <div className="flex flex-wrap gap-1 bg-slate-900/50 p-1 rounded-md">
                                    <button onClick={() => setDateRange('today')} className={`px-3 py-1 text-xs font-medium rounded transition-colors whitespace-nowrap ${startDate === new Date().toLocaleDateString('en-CA') && endDate === new Date().toLocaleDateString('en-CA') ? 'bg-blue-600 text-white' : 'text-slate-400 hover:text-slate-200 hover:bg-slate-700'}`}>Today</button>
                                    <button onClick={() => setDateRange('yesterday')} className="px-3 py-1 text-xs font-medium rounded text-slate-400 hover:text-slate-200 hover:bg-slate-700 transition-colors whitespace-nowrap">Yesterday</button>
                                    <button onClick={() => setDateRange('thisWeek')} className="px-3 py-1 text-xs font-medium rounded text-slate-400 hover:text-slate-200 hover:bg-slate-700 transition-colors whitespace-nowrap">This Week</button>
                                    <button onClick={() => setDateRange('lastWeek')} className="px-3 py-1 text-xs font-medium rounded text-slate-400 hover:text-slate-200 hover:bg-slate-700 transition-colors whitespace-nowrap">Last Week</button>
                                    <button onClick={() => setDateRange('thisMonth')} className="px-3 py-1 text-xs font-medium rounded text-slate-400 hover:text-slate-200 hover:bg-slate-700 transition-colors whitespace-nowrap">This Month</button>
                                </div>
                            </div>
                            <div className="flex gap-2 items-center">
                                <input type="date" value={startDate} onChange={e => setStartDate(e.target.value)} className="bg-slate-700 text-slate-100 px-3 py-2 border border-slate-600 rounded-md w-full focus:ring-2 focus:ring-blue-500 outline-none" style={{colorScheme: 'dark'}} />
                                <span className="text-slate-500 font-bold">-</span>
                                <input type="date" value={endDate} onChange={e => setEndDate(e.target.value)} className="bg-slate-700 text-slate-100 px-3 py-2 border border-slate-600 rounded-md w-full focus:ring-2 focus:ring-blue-500 outline-none" style={{colorScheme: 'dark'}} />
                            </div>
                        </div>
                        
                        <div className="flex flex-col sm:flex-row gap-4 w-full xl:w-auto items-end">
                            <div className="w-full sm:w-56">
                                <label className="block text-sm font-medium text-slate-300 mb-1">
                                    <i className="fas fa-store-alt text-orange-400 mr-2"></i>Filter by Shop
                                </label>
                                <select value={selectedShopId} onChange={e => setSelectedShopId(e.target.value)} className="w-full bg-slate-700 text-slate-100 px-3 py-2 border border-slate-600 rounded-md focus:ring-2 focus:ring-blue-500 outline-none cursor-pointer">
                                    <option value="">All Shops</option>
                                    {shops.filter(s => userProfile.role === 'Admin' || (userProfile.assignedShops || []).includes(s.id))
                                          .map(s => <option key={s.id} value={s.id}>{s.name}</option>)}
                                </select>
                            </div>
                            <div className="w-full sm:w-56">
                                <label className="block text-sm font-medium text-slate-300 mb-1">
                                    <i className="fas fa-chart-pie text-purple-400 mr-2"></i>Report Type
                                </label>
                                <select 
                                    value={activeTab} 
                                    onChange={e => setActiveTab(e.target.value)} 
                                    className="w-full bg-slate-700 text-slate-100 px-3 py-2 border border-slate-600 rounded-md focus:ring-2 focus:ring-blue-500 outline-none cursor-pointer font-medium"
                                >
                                    <option value="summary"> Sale Summary</option>
                                    <option value="products"> Sale By Product</option>
                                    <option value="items"> Sale By Item</option>
                                    <option value="cashier"> Sale By Cashier</option>
                                    <option value="receipts"> Receipts</option>
                                    <option value="shifts"> Shift Report</option>
                                </select>
                            </div>
                            {/* NEW: Export Button */}
                            <div>
                                <button 
                                    onClick={handleExport} 
                                    className="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg flex items-center gap-2 transition whitespace-nowrap h-[42px]"
                                    title="Download current report as Excel"
                                >
                                    <i className="fas fa-file-excel"></i> Export
                                </button>
                            </div>
                        </div>
                    </div>
                </Card>

                {/* Loading State */}
                {loading ? (
                    <div className="flex justify-center p-12"><div className="loader"></div></div>
                ) : (
                    <>
                        {/* Phase 1: Sale Summary */}
                        {activeTab === 'summary' && (
                            <div className="space-y-6">
                                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                                    <div className="bg-slate-800 p-6 rounded-lg border border-slate-700 shadow-lg">
                                        <p className="text-slate-400 text-sm uppercase font-bold">Total Sales</p>
                                        <h3 className="text-3xl font-bold text-emerald-400 mt-2">{khrFormatter.format(summaryStats.totalRevenue)}</h3>
                                    </div>
                                    <div className="bg-slate-800 p-6 rounded-lg border border-slate-700 shadow-lg">
                                        <p className="text-slate-400 text-sm uppercase font-bold">Transactions</p>
                                        <h3 className="text-3xl font-bold text-blue-400 mt-2">{summaryStats.totalTransactions}</h3>
                                    </div>
                                    <div className="bg-slate-800 p-6 rounded-lg border border-slate-700 shadow-lg">
                                        <p className="text-slate-400 text-sm uppercase font-bold">Avg Ticket</p>
                                        <h3 className="text-3xl font-bold text-slate-200 mt-2">{khrFormatter.format(summaryStats.avgTicket.toFixed(0))}</h3>
                                    </div>
                                    <div className="bg-slate-800 p-6 rounded-lg border border-slate-700 shadow-lg">
                                        <p className="text-slate-400 text-sm uppercase font-bold">Est. Gross Profit</p>
                                        <h3 className="text-3xl font-bold text-yellow-400 mt-2">{khrFormatter.format(summaryStats.totalProfit)}</h3>
                                        <p className="text-xs text-slate-500 mt-1">Based on product cost</p>
                                    </div>
                                </div>

                                {/* NEW: Gross Profit Trend Chart */}
                                <Card>
                                    <h4 className="text-lg font-bold text-slate-200 mb-4 flex items-center gap-2">
                                        <i className="fas fa-chart-bar text-green-500"></i> Gross Profit Trend
                                    </h4>
                                    <DailyProfitChart salesData={salesData} />
                                </Card>

                                <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <Card>
                                        <h4 className="text-lg font-bold text-slate-200 mb-4">Payment Breakdown</h4>
                                        <div className="space-y-4">
                                            {Object.entries(summaryStats.paymentMethods).map(([method, amount]) => (
                                                <div key={method}>
                                                    <div className="flex justify-between text-sm mb-1">
                                                        <span className="text-slate-300">{method}</span>
                                                        <span className="text-slate-200 font-bold">{khrFormatter.format(amount)}</span>
                                                    </div>
                                                    <div className="w-full bg-slate-700 rounded-full h-2">
                                                        <div 
                                                            className={`h-2 rounded-full ${method === 'Cash' ? 'bg-green-500' : 'bg-blue-500'}`} 
                                                            style={{ width: `${(amount / summaryStats.totalRevenue) * 100}%` }}
                                                        ></div>
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    </Card>
                                </div>
                            </div>
                        )}

                        {/* Phase 2: Sale By Product */}
                        {activeTab === 'products' && (
                            <TableCard title="Sales by Product">
                                <table className="min-w-full divide-y divide-slate-700">
                                    <thead className="bg-slate-900/50">
                                        <tr>
                                            <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Product</th>
                                            <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Code</th>
                                            <th className="px-4 py-3 text-center text-xs font-semibold text-slate-400 uppercase">Qty Sold</th>
                                            <th className="px-4 py-3 text-right text-xs font-semibold text-slate-400 uppercase">Total Revenue</th>
                                            <th className="px-4 py-3 text-right text-xs font-semibold text-slate-400 uppercase">Profit</th>
                                        </tr>
                                    </thead>
                                    <tbody className="divide-y divide-slate-700">
                                        {productStats.map((p, idx) => (
                                            <tr key={idx} className="hover:bg-slate-700/50">
                                                <td className="px-4 py-3 text-sm text-slate-200">{p.name}</td>
                                                <td className="px-4 py-3 text-sm text-slate-400">{p.code}</td>
                                                <td className="px-4 py-3 text-sm text-center text-slate-300">{p.qty}</td>
                                                <td className="px-4 py-3 text-sm text-right text-emerald-400 font-bold">{khrFormatter.format(p.revenue)}</td>
                                                <td className="px-4 py-3 text-sm text-right text-yellow-400">{khrFormatter.format(p.revenue - p.cost)}</td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </TableCard>
                        )}

                        {/* NEW: Phase 5 - Sale By Item (Detailed) */}
                        {activeTab === 'items' && (
                            <TableCard title="Sale Details by Item">
                                <table className="min-w-full divide-y divide-slate-700">
                                    <thead className="bg-slate-900/50">
                                        <tr>
                                            <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Date</th>
                                            <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Receipt</th>
                                            <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Shop</th>
                                            <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Product</th>
                                            <th className="px-4 py-3 text-center text-xs font-semibold text-slate-400 uppercase">Qty</th>
                                            <th className="px-4 py-3 text-right text-xs font-semibold text-slate-400 uppercase">Price</th>
                                            <th className="px-4 py-3 text-right text-xs font-semibold text-slate-400 uppercase">Total</th>
                                        </tr>
                                    </thead>
                                    <tbody className="divide-y divide-slate-700">
                                        {saleByItems.map((item) => (
                                            <tr key={item.uniqueKey} className="hover:bg-slate-700/50">
                                                <td className="px-4 py-3 text-sm text-slate-400">{item.date ? safeToDate(item.date).toLocaleString() : '-'}</td>
                                                <td className="px-4 py-3 text-sm text-slate-300 font-mono">{item.receiptNo}</td>
                                                <td className="px-4 py-3 text-sm text-slate-400">{item.shopName}</td>
                                                <td className="px-4 py-3 text-sm text-slate-200">
                                                    <div className="font-medium">{item.productName}</div>
                                                    <div className="text-xs text-slate-500">{item.code}</div>
                                                </td>
                                                <td className="px-4 py-3 text-sm text-center text-slate-300">{item.quantity}</td>
                                                <td className="px-4 py-3 text-sm text-right text-slate-400">{khrFormatter.format(item.price)}</td>
                                                <td className="px-4 py-3 text-sm text-right text-emerald-400 font-bold">{khrFormatter.format(item.total)}</td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </TableCard>
                        )}

                        {/* Phase 3: Sale By Cashier */}
                        {activeTab === 'cashier' && (
                            <TableCard title="Performance by Cashier">
                                <table className="min-w-full divide-y divide-slate-700">
                                    <thead className="bg-slate-900/50">
                                        <tr>
                                            <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Cashier Name</th>
                                            <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Shop</th>
                                            <th className="px-4 py-3 text-center text-xs font-semibold text-slate-400 uppercase">Transactions</th>
                                            <th className="px-4 py-3 text-right text-xs font-semibold text-slate-400 uppercase">Total Collected</th>
                                        </tr>
                                    </thead>
                                    <tbody className="divide-y divide-slate-700">
                                        {cashierStats.map((c, idx) => (
                                            <tr key={idx} className="hover:bg-slate-700/50">
                                                <td className="px-4 py-3 text-sm text-slate-200">{c.name}</td>
                                                <td className="px-4 py-3 text-sm text-slate-400">{c.shopName}</td>
                                                <td className="px-4 py-3 text-sm text-center text-slate-300">{c.count}</td>
                                                <td className="px-4 py-3 text-sm text-right text-emerald-400 font-bold">{khrFormatter.format(c.revenue)}</td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </TableCard>
                        )}

                        {/* Phase 4: Receipts */}
                        {activeTab === 'receipts' && (
                            <TableCard title="Receipt History">
                                <table className="min-w-full divide-y divide-slate-700">
                                    <thead className="bg-slate-900/50">
                                        <tr>
                                            <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Date/Time</th>
                                            <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Receipt No</th>
                                            <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Shop</th>
                                            <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Cashier</th>
                                            <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Payment</th>
                                            <th className="px-4 py-3 text-right text-xs font-semibold text-slate-400 uppercase">Amount</th>
                                            <th className="px-4 py-3 text-center text-xs font-semibold text-slate-400 uppercase">Status</th>
                                            <th className="px-4 py-3 text-center text-xs font-semibold text-slate-400 uppercase">Action</th>
                                        </tr>
                                    </thead>
                                    <tbody className="divide-y divide-slate-700">
                                        {salesData.sort((a,b) => safeToDate(b.timestamp) - safeToDate(a.timestamp)).map(sale => (
                                            <tr key={sale.id} className={`hover:bg-slate-700/50 ${sale.status === 'void' ? 'opacity-50' : ''}`}>
                                                <td className="px-4 py-3 text-sm text-slate-400">
                                                    {sale.timestamp ? safeToDate(sale.timestamp).toLocaleString() : 'N/A'}
                                                </td>
                                                <td className="px-4 py-3 text-sm text-slate-300 font-mono">{sale.receiptNo}</td>
                                                <td className="px-4 py-3 text-sm text-slate-400">{sale.shopName}</td>
                                                <td className="px-4 py-3 text-sm text-slate-400">{sale.cashierName}</td>
                                                <td className="px-4 py-3 text-sm text-slate-300">{sale.paymentMethod}</td>
                                                <td className="px-4 py-3 text-sm text-right text-emerald-400 font-bold">{khrFormatter.format(sale.grandTotal)}</td>
                                                <td className="px-4 py-3 text-sm text-center">
                                                    {sale.status === 'void' 
                                                        ? <span className="bg-red-900/50 text-red-300 px-2 py-1 rounded text-xs">VOID</span>
                                                        : <span className="bg-green-900/50 text-green-300 px-2 py-1 rounded text-xs">PAID</span>
                                                    }
                                                </td>
                                                <td className="px-4 py-3 text-center">
                                                    <button onClick={() => setViewReceipt(sale)} className="text-blue-400 hover:text-blue-300">
                                                        <i className="fas fa-eye"></i>
                                                    </button>
                                                </td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </TableCard>
                        )}

                        {/* NEW: Phase 5 - Shift Report */}
                        {activeTab === 'shifts' && (
                            <ShiftReportList shifts={shiftsData} loading={shiftsLoading} />
                        )}
                    </>
                )}
            </div>
        );
    };

    // --- UPDATED: Shift Report Sub-Component (Pure Presentation now) ---
    const ShiftReportList = ({ shifts, loading }) => {
        const { shops } = useData(); 
        
        return (
            <TableCard title="Shift Report">
                {loading ? <p className="text-center p-4">Loading shifts...</p> : shifts.length === 0 ? <p className="text-center p-4 text-slate-400">No shifts found in this period.</p> : (
                    <table className="min-w-full divide-y divide-slate-700">
                        <thead className="bg-slate-900/50">
                            <tr>
                                <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Shop</th>
                                <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Start Time</th>
                                <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">End Time</th>
                                <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Cashier</th>
                                <th className="px-4 py-3 text-center text-xs font-semibold text-slate-400 uppercase">Tx Count</th>
                                <th className="px-4 py-3 text-right text-xs font-semibold text-slate-400 uppercase">Start Cash</th>
                                <th className="px-4 py-3 text-right text-xs font-semibold text-slate-400 uppercase">Total Sales</th>
                                <th className="px-4 py-3 text-right text-xs font-semibold text-slate-400 uppercase">Expected Cash</th>
                                <th className="px-4 py-3 text-right text-xs font-semibold text-slate-400 uppercase">Actual Cash</th>
                                <th className="px-4 py-3 text-right text-xs font-semibold text-slate-400 uppercase">Variance</th>
                                <th className="px-4 py-3 text-center text-xs font-semibold text-slate-400 uppercase">Status</th>
                            </tr>
                        </thead>
                        <tbody className="divide-y divide-slate-700">
                            {shifts.map(shift => {
                                const diff = shift.difference || 0;
                                const diffColor = diff < 0 ? 'text-red-400' : diff > 0 ? 'text-green-400' : 'text-slate-400';
                                const shopName = shops.find(s => s.id === shift.shopId)?.name || 'Unknown';
                                
                                return (
                                <tr key={shift.id} className="hover:bg-slate-700/50">
                                    <td className="px-4 py-3 text-sm text-slate-200">{shopName}</td>
                                    <td className="px-4 py-3 text-sm text-slate-300">{safeToDate(shift.startTime).toLocaleString()}</td>
                                    <td className="px-4 py-3 text-sm text-slate-400">{shift.endTime ? safeToDate(shift.endTime).toLocaleString() : '-'}</td>
                                    <td className="px-4 py-3 text-sm text-slate-300">{shift.cashierName}</td>
                                    <td className="px-4 py-3 text-sm text-slate-400 text-center">{shift.transactionCount || 0}</td>
                                    <td className="px-4 py-3 text-sm text-slate-300 text-right">{new Intl.NumberFormat('en-US').format(shift.startCash)}</td>
                                    <td className="px-4 py-3 text-sm text-emerald-400 text-right font-bold">{new Intl.NumberFormat('en-US').format(shift.totalSales || 0)}</td>
                                    <td className="px-4 py-3 text-sm text-slate-400 text-right">{shift.expectedCash ? new Intl.NumberFormat('en-US').format(shift.expectedCash) : '-'}</td>
                                    <td className="px-4 py-3 text-sm text-slate-300 text-right font-bold">{shift.actualCash ? new Intl.NumberFormat('en-US').format(shift.actualCash) : '-'}</td>
                                    <td className={`px-4 py-3 text-sm text-right font-bold ${diffColor}`}>{shift.difference ? new Intl.NumberFormat('en-US').format(shift.difference) : '-'}</td>
                                    <td className="px-4 py-3 text-sm text-center">
                                        <span className={`px-2 py-1 text-xs rounded-full ${shift.status === 'open' ? 'bg-green-500/20 text-green-400' : 'bg-slate-600/20 text-slate-400'}`}>
                                            {shift.status.toUpperCase()}
                                        </span>
                                    </td>
                                </tr>
                            )})}
                        </tbody>
                    </table>
                )}
            </TableCard>
        );
    };

    // ** REFACTORED ProductList and its sub-components **

    const ProductLabelModal = ({ product, onClose }) => {
        // Core State
        const [labelType, setLabelType] = useState('barcode');
        const [paperWidth, setPaperWidth] = useState(30);
        const [paperHeight, setPaperHeight] = useState(20);
        const [showAdvanced, setShowAdvanced] = useState(false);
        const [isPrinting, setIsPrinting] = useState(false); // New state for PDF generation

        // Advanced Settings State
        const [priceTextSize, setPriceTextSize] = useState(20);
        const [vendorTextSize, setVendorTextSize] = useState(14);
        const [barcodeFontSize, setBarcodeFontSize] = useState(14);
        const [barcodeWidth, setBarcodeWidth] = useState(1.5);
        const [barcodeHeight, setBarcodeHeight] = useState(40);

        // Preset Management State
        const [presets, setPresets] = useState([]);
        const [selectedPreset, setSelectedPreset] = useState('');
        const [showSavePresetModal, setShowSavePresetModal] = useState(false);
        const [showDeletePresetModal, setShowDeletePresetModal] = useState(false);
        const [newPresetName, setNewPresetName] = useState('');

        // Refs for barcode/QR generation
        const labelRef = useRef(null);
        const barcodeRef = useRef(null);
        const qrCodeRef = useRef(null);

        // --- Preset Logic ---
        const PRESET_STORAGE_KEY = 'productLabelPresets_v1';
        const defaultPresets = useMemo(() => [
            { name: 'Standard 30x20mm', isDefault: true, settings: { paperWidth: 30, paperHeight: 20, priceTextSize: 20, vendorTextSize: 14, barcodeFontSize: 14, barcodeWidth: 1.5, barcodeHeight: 40 } },
            { name: 'Large Shelf Tag 50x30mm', isDefault: true, settings: { paperWidth: 50, paperHeight: 30, priceTextSize: 14, vendorTextSize: 8, barcodeFontSize: 12, barcodeWidth: 1.5, barcodeHeight: 50 } },
        ], []);

        useEffect(() => {
            try {
                const savedPresets = JSON.parse(localStorage.getItem(PRESET_STORAGE_KEY)) || [];
                setPresets([...defaultPresets, ...savedPresets]);
            } catch (e) {
                console.error("Failed to load presets:", e);
                setPresets(defaultPresets);
            }
        }, [defaultPresets]);

        const applyPreset = useCallback((preset) => {
            if (!preset) return;
            const { settings } = preset;
            setPaperWidth(settings.paperWidth);
            setPaperHeight(settings.paperHeight);
            setPriceTextSize(settings.priceTextSize);
            setVendorTextSize(settings.vendorTextSize);
            setBarcodeFontSize(settings.barcodeFontSize);
            setBarcodeWidth(settings.barcodeWidth);
            setBarcodeHeight(settings.barcodeHeight);
            setSelectedPreset(preset.name);
        }, []);

        // This effect runs when presets are loaded to apply the default one.
        useEffect(() => {
            if (presets.length > 0) {
                const defaultPreset = presets.find(p => p.name === 'Standard 30x20mm');
                if (defaultPreset) {
                    applyPreset(defaultPreset);
                }
            }
        }, [presets, applyPreset]);

        const handlePresetChange = (e) => {
            const presetName = e.target.value;
            const selected = presets.find(p => p.name === presetName);
            if (selected) applyPreset(selected);
            else setSelectedPreset('');
        };

        const handleSavePreset = () => {
            if (!newPresetName.trim()) return;
            const currentSettings = { paperWidth, paperHeight, priceTextSize, vendorTextSize, barcodeFontSize, barcodeWidth, barcodeHeight };
            const newPreset = { name: newPresetName.trim(), settings: currentSettings };

            setPresets(prev => {
                const updatedPresets = [...prev.filter(p => p.name !== newPreset.name), newPreset];
                const customPresets = updatedPresets.filter(p => !p.isDefault);
                localStorage.setItem(PRESET_STORAGE_KEY, JSON.stringify(customPresets));
                return updatedPresets;
            });

            setSelectedPreset(newPreset.name);
            setShowSavePresetModal(false);
            setNewPresetName('');
        };

        const handleDeletePreset = () => {
            if (!selectedPreset || presets.find(p => p.name === selectedPreset)?.isDefault) return;
            setPresets(prev => {
                const updatedPresets = prev.filter(p => p.name !== selectedPreset);
                const customPresets = updatedPresets.filter(p => !p.isDefault);
                localStorage.setItem(PRESET_STORAGE_KEY, JSON.stringify(customPresets));
                return updatedPresets;
            });
            applyPreset(defaultPresets[0]);
            setShowDeletePresetModal(false);
        };


        // This useEffect handles the generation of the barcode or QR code image
        useEffect(() => {
            const codeToEncode = product?.barcode || product?.code || '';
            if (!codeToEncode) return;

            if (labelType === 'barcode' && barcodeRef.current) {
                try {
                    JsBarcode(barcodeRef.current, codeToEncode, {
                        format: "CODE128", displayValue: true, fontSize: barcodeFontSize,
                        width: barcodeWidth, height: barcodeHeight, margin: 0, textMargin: 0
                    });
                } catch (e) { console.error("JsBarcode error:", e); }
            }
            if (labelType === 'qrcode' && qrCodeRef.current) {
                try {
                    const qr = qrcode(0, 'L');
                    qr.addData(codeToEncode);
                    qr.make();
                    qrCodeRef.current.innerHTML = qr.createImgTag(3, 4);
                } catch (e) { console.error("QRCode error:", e); }
            }
        }, [product, labelType, barcodeFontSize, barcodeWidth, barcodeHeight]);

        const handlePrint = () => {
            const labelContent = labelRef.current;
            if (!labelContent || isPrinting) return;

            setIsPrinting(true);

            // Temporarily force all text within the label to black for high-quality PDF output
            const elementsToBlacken = labelContent.querySelectorAll('p, h3');
            const originalColors = [];
            elementsToBlacken.forEach(el => {
                originalColors.push({ el, color: el.style.color });
                // Force pure black color for capture
                el.style.color = '#000000';
            });

            html2canvas(labelContent, {
                scale: 6, // Increased scale for better resolution in the PDF
                backgroundColor: '#ffffff',
                useCORS: true
            }).then(canvas => {
                const { jsPDF } = window.jspdf;
                
                // Create a PDF with the exact dimensions from the state
                const pdf = new jsPDF({
                    orientation: paperWidth > paperHeight ? 'landscape' : 'portrait',
                    unit: 'mm',
                    format: [paperWidth, paperHeight]
                });

                const imgData = canvas.toDataURL('image/png');
                
                // Add the captured image to the PDF, stretching it to fill the page
                pdf.addImage(imgData, 'PNG', 0, 0, paperWidth, paperHeight);
                
                // Trigger the download of the PDF file with the new naming convention
                const fileName = labelType === 'barcode'
                    ? `Barcode-${product.barcode || product.code || 'product'}.pdf`
                    : `QRcode-${product.barcode || product.code || 'product'}.pdf`;
                pdf.save(fileName);
            }).catch(err => {
                console.error("Failed to generate PDF:", err);
                // In a real app, you would show an error message to the user here.
            }).finally(() => {
                // Restore original text colors after capture
                originalColors.forEach(item => {
                    item.el.style.color = item.color;
                });
                setIsPrinting(false);
            });
        };

        if (!product) return null;
        
        const aspectRatio = (paperWidth > 0 && paperHeight > 0) ? paperHeight / paperWidth : 2/3;
        const previewWidth = 150;
        const previewHeight = previewWidth * aspectRatio;
        const isCustomPresetSelected = selectedPreset && !presets.find(p => p.name === selectedPreset)?.isDefault;

        return (
            <Modal show={true} onClose={onClose} maxWidth="max-w-md">
                {/* Modals for Preset Actions */}
                {showSavePresetModal && (
                    <Modal show={true} onClose={() => setShowSavePresetModal(false)} maxWidth="max-w-sm">
                        <ModalHeader title="Save Preset" onClose={() => setShowSavePresetModal(false)} />
                        <ModalBody>
                            <label className="block text-sm font-medium text-slate-300 mb-1">Preset Name</label>
                            <input type="text" value={newPresetName} onChange={(e) => setNewPresetName(e.target.value)} className="w-full bg-slate-700 text-slate-100 px-3 py-2 border border-slate-600 rounded-md" placeholder="e.g., My Custom Label" />
                        </ModalBody>
                        <ModalFooter>
                            <button onClick={() => setShowSavePresetModal(false)} type="button" className="bg-slate-600 font-bold py-2 px-4 rounded-lg">Cancel</button>
                            <button onClick={handleSavePreset} type="button" className="bg-blue-600 font-bold py-2 px-4 rounded-lg">Save</button>
                        </ModalFooter>
                    </Modal>
                )}
                {showDeletePresetModal && (
                    <ConfirmationModal show={true} title="Delete Preset" message={`Are you sure you want to delete "${selectedPreset}"?`} onConfirm={handleDeletePreset} onCancel={() => setShowDeletePresetModal(false)} />
                )}

                <ModalHeader title="Print Product Label" onClose={onClose} />
                <ModalBody>
                    <div className="border-b border-slate-700 mb-4 pb-4">
                        <h4 className="text-md font-semibold text-slate-200 mb-2">Preset Management</h4>
                        <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            <div>
                                <label className="block text-sm font-medium text-slate-300 mb-1">Load Preset</label>
                                <div className="flex gap-2">
                                    <select value={selectedPreset} onChange={handlePresetChange} className="w-full bg-slate-700 text-slate-100 px-3 py-2 border border-slate-600 rounded-md">
                                        <option value="" disabled>-- Select a Preset --</option>
                                        {presets.map(p => <option key={p.name} value={p.name}>{p.name}</option>)}
                                    </select>
                                    {isCustomPresetSelected && (
                                        <button onClick={() => setShowDeletePresetModal(true)} title="Delete Preset" className="px-3 bg-red-600 text-white rounded-md hover:bg-red-700 transition">
                                            <i className="fas fa-trash"></i>
                                        </button>
                                    )}
                                </div>
                            </div>
                             <div>
                                <label className="block text-sm font-medium text-slate-300 mb-1">&nbsp;</label>
                                <button onClick={() => setShowSavePresetModal(true)} className="w-full bg-green-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-700 flex items-center justify-center gap-2">
                                    <i className="fas fa-save"></i> Save Current
                                </button>
                            </div>
                        </div>
                    </div>
                
                    {/* Paper Size Inputs */}
                    <div className="grid grid-cols-2 gap-4 mb-4">
                        <div>
                            <label className="block text-sm font-medium text-slate-300 mb-1">Width (mm)</label>
                            <input type="number" value={paperWidth} onChange={(e) => setPaperWidth(e.target.value)} className="w-full bg-slate-700 text-slate-100 px-3 py-2 border border-slate-600 rounded-md" />
                        </div>
                        <div>
                            <label className="block text-sm font-medium text-slate-300 mb-1">Height (mm)</label>
                            <input type="number" value={paperHeight} onChange={(e) => setPaperHeight(e.target.value)} className="w-full bg-slate-700 text-slate-100 px-3 py-2 border border-slate-600 rounded-md" />
                        </div>
                    </div>

                    <div className="flex justify-center mb-4 rounded-lg bg-slate-700 p-1">
                        <button onClick={() => setLabelType('barcode')} className={`w-1/2 py-2 text-sm font-medium rounded-md transition-colors ${labelType === 'barcode' ? 'bg-blue-600 text-white' : 'text-slate-300 hover:bg-slate-600'}`}>Barcode</button>
                        <button onClick={() => setLabelType('qrcode')} className={`w-1/2 py-2 text-sm font-medium rounded-md transition-colors ${labelType === 'qrcode' ? 'bg-blue-600 text-white' : 'text-slate-300 hover:bg-slate-600'}`}>QR Code</button>
                    </div>

                    <div className="flex items-center justify-center p-2 bg-slate-900/50 rounded-lg">
                        <div ref={labelRef} className="p-1 bg-white text-black rounded-sm flex flex-col items-center justify-between transition-all" style={{ width: `${previewWidth}px`, height: `${previewHeight}px` }}>
                            {labelType === 'barcode' ? (
                                <>
                                    <p className="price font-bold" style={{ fontSize: `${priceTextSize * 0.75}pt`, lineHeight: 1.1 }}>{khrFormatter.format(product.price)}</p>
                                    <h3 className="product-name font-normal" style={{ fontSize: `${vendorTextSize * 0.75}pt`, lineHeight: 1.1, marginBottom: '4px' }}>{product.vendorName || 'No Vendor'}</h3>
                                    <div className="code-container w-full flex-grow flex flex-col justify-center items-center">
                                        {product.code ? <svg ref={barcodeRef} className="max-w-full"></svg> : <p className="text-xs text-slate-500">(No Code)</p>}
                                    </div>
                                </>
                            ) : (
                                <div className="two-sided-label flex w-full h-full items-stretch">
                                    {/* Left Side: Price, Barcode Number, and Vendor Name (Rotated) */}
                                    <div className="left-side w-1/2 flex flex-col justify-center items-center text-center p-1 border-r border-dashed border-slate-500" style={{ overflow: 'hidden' }}>
                                        <div style={{ transform: 'rotate(-90deg)', whiteSpace: 'nowrap' }}>
                                            <p className="price-text font-bold" style={{ fontSize: `${priceTextSize * 0.75}pt`, lineHeight: 1.1, marginBottom: '4px' }}>
                                                {khrFormatter.format(product.price)}
                                            </p>
                                            <p className="code-text font-mono" style={{ fontSize: '10pt', lineHeight: 1 }}>
                                                {
                                                    (() => {
                                                        const code = product.barcode || product.code || 'N/A';
                                                        return code.length > 9 ? code.substring(0, 6) : code;
                                                    })()
                                                }
                                            </p>
                                            <p className="vendor-name-text text-slate-600" style={{ fontSize: '10pt', lineHeight: 1, marginTop: '4px' }}>
                                                {product.vendorName || 'No Vendor'}
                                            </p>
                                        </div>
                                    </div>
                                    {/* Right Side: QR Code */}
                                    <div className="right-side w-1/2 flex flex-col justify-center items-center p-1">
                                        <div ref={qrCodeRef} className="flex-grow flex items-center justify-center"></div>
                                    </div>
                                </div>
                            )}
                        </div>
                    </div>

                     <div className="border-t border-slate-700 mt-4 pt-4">
                        <button onClick={() => setShowAdvanced(!showAdvanced)} className="w-full text-left font-semibold text-slate-300 hover:text-white flex justify-between items-center">
                            <span>Advanced Settings</span>
                            <i className={`fas fa-chevron-down transition-transform ${showAdvanced ? 'rotate-180' : ''}`}></i>
                        </button>
                        {showAdvanced && (
                            <div className="mt-4 space-y-3 animate-fade-in-up">
                                <div className="grid grid-cols-2 gap-4">
                                    <div><label className="block text-xs font-medium text-slate-400">Price Size (pt)</label><input type="number" value={priceTextSize} onChange={(e) => setPriceTextSize(e.target.value)} className="w-full bg-slate-700 text-slate-100 px-2 py-1 border border-slate-600 rounded-md text-sm" /></div>
                                    <div><label className="block text-xs font-medium text-slate-400">Vendor Size (pt)</label><input type="number" value={vendorTextSize} onChange={(e) => setVendorTextSize(e.target.value)} className="w-full bg-slate-700 text-slate-100 px-2 py-1 border border-slate-600 rounded-md text-sm" /></div>
                                    <div><label className="block text-xs font-medium text-slate-400">Barcode Font (pt)</label><input type="number" value={barcodeFontSize} onChange={(e) => setBarcodeFontSize(e.target.value)} className="w-full bg-slate-700 text-slate-100 px-2 py-1 border border-slate-600 rounded-md text-sm" /></div>
                                    <div><label className="block text-xs font-medium text-slate-400">Barcode Width</label><input type="number" step="0.1" value={barcodeWidth} onChange={(e) => setBarcodeWidth(e.target.value)} className="w-full bg-slate-700 text-slate-100 px-2 py-1 border border-slate-600 rounded-md text-sm" /></div>
                                    <div className="col-span-2"><label className="block text-xs font-medium text-slate-400">Barcode Height</label><input type="number" value={barcodeHeight} onChange={(e) => setBarcodeHeight(e.target.value)} className="w-full bg-slate-700 text-slate-100 px-2 py-1 border border-slate-600 rounded-md text-sm" /></div>
                                </div>
                            </div>
                        )}
                    </div>
                </ModalBody>
                <ModalFooter>
                    <button onClick={onClose} type="button" className="bg-slate-600 text-slate-100 font-bold py-2 px-6 rounded-lg hover:bg-slate-500 transition">Close</button>
                    <button onClick={handlePrint} disabled={isPrinting} type="button" className="bg-blue-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-700 transition flex items-center gap-2 disabled:bg-blue-800 disabled:cursor-wait">
                        {isPrinting ? <div className="loader"></div> : <i className="fas fa-file-pdf"></i>}
                        {isPrinting ? 'Generating...' : 'Save as PDF'}
                    </button>
                </ModalFooter>
            </Modal>
        );
    };

    // --- NEW COMPONENT: Stock Adjustment Modal ---
    const StockAdjustmentModal = ({ product, initialShopId, onClose, userProfile }) => {
        const { shops } = useData();
        const [shopId, setShopId] = useState(initialShopId || '');
        const [actionType, setActionType] = useState('add'); // add, remove, set
        const [quantity, setQuantity] = useState('');
        const [reason, setReason] = useState('Inventory Count');
        const [note, setNote] = useState('');
        const [loading, setLoading] = useState(false);
        const [modalInfo, setModalInfo] = useState({ show: false, title: '', message: '', isError: false });

        const managedShops = useMemo(() => shops.filter(s => s.manageStock), [shops]);
        const selectedShop = shops.find(s => s.id === shopId);
        const currentStock = product.stockByShop?.[shopId] || 0;

        // Calculate new stock for display preview
        const newStock = useMemo(() => {
            const qty = parseInt(quantity) || 0;
            if (actionType === 'add') return currentStock + qty;
            if (actionType === 'remove') return Math.max(0, currentStock - qty);
            if (actionType === 'set') return qty;
            return currentStock;
        }, [currentStock, quantity, actionType]);

        const handleSubmit = async (e) => {
            e.preventDefault();
            const qty = parseInt(quantity);
            if (isNaN(qty) || qty <= 0) {
                setModalInfo({ show: true, title: 'Validation Error', message: 'Please enter a valid positive quantity.', isError: true });
                return;
            }
            if (!shopId) {
                setModalInfo({ show: true, title: 'Validation Error', message: 'Please select a shop.', isError: true });
                return;
            }

            setLoading(true);
            try {
                const batch = db.batch();
                const productRef = db.collection('products').doc(product.id);
                const movementRef = db.collection('productMovement').doc();

                // 1. Update Product Stock
                let newStockValue = 0;
                let quantityChange = 0;

                if (actionType === 'add') {
                    newStockValue = currentStock + qty;
                    quantityChange = qty;
                } else if (actionType === 'remove') {
                    newStockValue = Math.max(0, currentStock - qty);
                    quantityChange = -qty; // Negative for removal
                } else if (actionType === 'set') {
                    newStockValue = qty;
                    quantityChange = qty - currentStock; // Difference
                }

                batch.update(productRef, {
                    [`stockByShop.${shopId}`]: newStockValue,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });

                // 2. Log Movement
                // Only log if there's an actual change
                if (quantityChange !== 0) {
                    batch.set(movementRef, {
                        productId: product.id,
                        productCode: product.code,
                        productName: product.name,
                        type: 'Adjustment', // Specific type for manual adjustments
                        reason: reason,
                        quantityChange: quantityChange,
                        from: actionType === 'add' ? 'Adjustment' : selectedShop?.name,
                        to: actionType === 'add' ? selectedShop?.name : 'Adjustment',
                        referenceNo: `ADJ-${new Date().toISOString().slice(0,10)}-${Math.floor(Math.random()*1000)}`,
                        note: note,
                        performedBy: userProfile.name,
                        performedByUid: userProfile.uid,
                        timestamp: firebase.firestore.FieldValue.serverTimestamp()
                    });
                }

                await batch.commit();
                setLoading(false);
                setModalInfo({ show: true, title: 'Success', message: 'Stock adjusted successfully.' });
                setTimeout(() => onClose(), 1500); // Close after success message
            } catch (error) {
                console.error("Adjustment Error:", error);
                setLoading(false);
                setModalInfo({ show: true, title: 'Error', message: 'Failed to adjust stock.', isError: true });
            }
        };

        return (
            <Modal show={true} onClose={onClose} maxWidth="max-w-lg">
                <MessageModal {...modalInfo} show={modalInfo.show} onClose={() => setModalInfo({ show: false })} />
                <ModalHeader title={`Adjust Stock: ${product.name}`} onClose={onClose} />
                <form onSubmit={handleSubmit} className="p-6">
                    <div className="space-y-4">
                        {/* Shop Selection */}
                        <div>
                            <label className="block text-sm font-medium text-slate-300 mb-1">Shop</label>
                            <select value={shopId} onChange={(e) => setShopId(e.target.value)} className="w-full bg-slate-700 text-slate-100 px-3 py-2 border border-slate-600 rounded-md">
                                {managedShops.map(s => <option key={s.id} value={s.id}>{s.name}</option>)}
                            </select>
                        </div>

                        {/* Current Stock Display */}
                        <div className="flex justify-between items-center bg-slate-800 p-3 rounded-lg border border-slate-700">
                            <span className="text-slate-400">Current Stock:</span>
                            <span className="text-xl font-bold text-slate-200">{currentStock}</span>
                        </div>

                        {/* Action Type Tabs */}
                        <div>
                            <label className="block text-sm font-medium text-slate-300 mb-1">Action</label>
                            <div className="flex rounded-md shadow-sm">
                                <button type="button" onClick={() => setActionType('add')} className={`flex-1 px-4 py-2 text-sm font-medium rounded-l-lg border border-slate-600 ${actionType === 'add' ? 'bg-green-600 text-white' : 'bg-slate-700 text-slate-300 hover:bg-slate-600'}`}>
                                    <i className="fas fa-plus mr-2"></i> Add
                                </button>
                                <button type="button" onClick={() => setActionType('remove')} className={`flex-1 px-4 py-2 text-sm font-medium border-t border-b border-slate-600 ${actionType === 'remove' ? 'bg-red-600 text-white' : 'bg-slate-700 text-slate-300 hover:bg-slate-600'}`}>
                                    <i className="fas fa-minus mr-2"></i> Remove
                                </button>
                                <button type="button" onClick={() => setActionType('set')} className={`flex-1 px-4 py-2 text-sm font-medium rounded-r-lg border border-slate-600 ${actionType === 'set' ? 'bg-blue-600 text-white' : 'bg-slate-700 text-slate-300 hover:bg-slate-600'}`}>
                                    <i className="fas fa-equals mr-2"></i> Set
                                </button>
                            </div>
                        </div>

                        {/* Quantity Input */}
                        <div>
                            <label className="block text-sm font-medium text-slate-300 mb-1">
                                {actionType === 'set' ? 'New Total Quantity' : 'Quantity to Adjust'}
                            </label>
                            <input 
                                type="number" 
                                value={quantity} 
                                onChange={(e) => setQuantity(e.target.value)} 
                                className="w-full bg-slate-700 text-slate-100 px-3 py-2 border border-slate-600 rounded-md text-lg font-bold" 
                                placeholder="0" 
                                min="1"
                                required
                            />
                        </div>

                        {/* Predicted Result */}
                        <div className="text-right text-sm text-slate-400">
                            Resulting Stock: <span className={`font-bold ${newStock < 0 ? 'text-red-400' : 'text-green-400'}`}>{newStock}</span>
                        </div>

                        {/* Reason Selection */}
                        <div>
                            <label className="block text-sm font-medium text-slate-300 mb-1">Reason</label>
                            <select value={reason} onChange={(e) => setReason(e.target.value)} className="w-full bg-slate-700 text-slate-100 px-3 py-2 border border-slate-600 rounded-md">
                                <option>Inventory Count</option>
                                <option>Damaged / Broken</option>
                                <option>Expired</option>
                                <option>Theft / Loss</option>
                                <option>Internal Use</option>
                                <option>Return to Vendor</option>
                                <option>Other</option>
                            </select>
                        </div>

                        {/* Note */}
                        <div>
                            <label className="block text-sm font-medium text-slate-300 mb-1">Note (Optional)</label>
                            <textarea value={note} onChange={(e) => setNote(e.target.value)} rows="2" className="w-full bg-slate-700 text-slate-100 px-3 py-2 border border-slate-600 rounded-md"></textarea>
                        </div>
                    </div>

                    <div className="mt-6 flex justify-end gap-3">
                        <button type="button" onClick={onClose} className="bg-slate-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-slate-500">Cancel</button>
                        <button type="submit" disabled={loading} className="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 flex items-center gap-2">
                            {loading && <div className="loader w-4 h-4"></div>}
                            Confirm Adjustment
                        </button>
                    </div>
                </form>
            </Modal>
        );
    };

    // Component for handling product filters
    const ProductFilters = memo(({ onFilterChange, onClear }) => {
        const { vendors } = useData();
        const [searchTerm, setSearchTerm] = useState('');
        const [vendorSearch, setVendorSearch] = useState('');
        const [vendorSearchResults, setVendorSearchResults] = useState([]);
        const [selectedVendor, setSelectedVendor] = useState(null);

        const debouncedSearchTerm = useDebounce(searchTerm, 500);
        const debouncedVendorSearch = useDebounce(vendorSearch, 500);
        const vendorFuse = useMemo(() => new Fuse(vendors, { keys: ['name'], threshold: 0.4 }), [vendors]);

        useEffect(() => {
            onFilterChange({ searchTerm: debouncedSearchTerm, vendorId: selectedVendor ? selectedVendor.id : '' });
        }, [debouncedSearchTerm, selectedVendor, onFilterChange]);

        useEffect(() => {
            if (debouncedVendorSearch && !selectedVendor) {
                const results = vendorFuse.search(debouncedVendorSearch);
                setVendorSearchResults(results.map(r => r.item));
            } else {
                setVendorSearchResults([]);
            }
        }, [debouncedVendorSearch, vendorFuse, selectedVendor]);

        const handleClear = () => {
            setSearchTerm('');
            setVendorSearch('');
            setSelectedVendor(null);
            onClear();
        };

        const selectVendor = (vendor) => {
            setSelectedVendor(vendor);
            setVendorSearch(vendor.name);
            setVendorSearchResults([]);
        };

        return (
            <div className="mb-4 px-1 grid grid-cols-1 md:grid-cols-3 gap-4">
                <input 
                    type="text" 
                    placeholder="Search by name, code, barcode..." 
                    value={searchTerm} 
                    onChange={(e) => setSearchTerm(e.target.value)} 
                    className="md:col-span-1 bg-slate-700 text-slate-100 px-4 py-2 border border-slate-600 rounded-md"
                />
                <div className="md:col-span-2 grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div className="relative">
                        <input
                            type="text"
                            placeholder="Search vendor..."
                            value={vendorSearch}
                            onChange={(e) => {
                                setVendorSearch(e.target.value);
                                setSelectedVendor(null);
                            }}
                            className="w-full bg-slate-700 text-slate-100 px-3 py-2 border border-slate-600 rounded-md"
                        />
                        {vendorSearchResults.length > 0 && (
                            <div className="absolute z-20 w-full bg-slate-800 border border-slate-600 rounded-md mt-1 shadow-lg max-h-60 overflow-y-auto">
                                {vendorSearchResults.map(v => (
                                    <div key={v.id} onClick={() => selectVendor(v)} className="p-2 cursor-pointer hover:bg-slate-700">
                                        <p className="font-semibold text-slate-200">{v.name}</p>
                                    </div>
                                ))}
                            </div>
                        )}
                    </div>
                    <button onClick={handleClear} className="bg-slate-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-slate-400 flex items-center justify-center gap-2">
                        <i className="fas fa-times-circle"></i> Clear
                    </button>
                </div>
            </div>
        );
    });

    // Component for handling the main action buttons
    const ProductActions = memo(({ onAddNew, onImport, onExport, onTemplate, onDeleteAll, userProfile, isGeneratingCode }) => {
        const [isImporting, setIsImporting] = useState(false);
        const fileInputRef = useRef(null);

        const handleFileChange = (e) => {
            const file = e.target.files[0];
            if (!file) return;
            setIsImporting(true);
            onImport(file).finally(() => {
                setIsImporting(false);
                if(fileInputRef.current) fileInputRef.current.value = "";
            });
        };

        return (
            <div className="mb-4 px-1 flex flex-wrap gap-2 items-center justify-between">
                <button onClick={onAddNew} disabled={isGeneratingCode} className="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 flex items-center gap-2 disabled:bg-blue-800 disabled:cursor-wait">
                    {isGeneratingCode ? <div className="loader w-4 h-4 mr-2"></div> : <i className="fas fa-plus"></i>}
                    {isGeneratingCode ? 'Generating...' : 'Add Product'}
                </button>
                <div className="flex flex-wrap gap-2 items-center justify-end">
                    <button onClick={onTemplate} className="bg-cyan-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-cyan-700 flex items-center gap-2"><i className="fas fa-download"></i> Template</button>
                    <input type="file" ref={fileInputRef} onChange={handleFileChange} style={{ display: 'none' }} accept=".xlsx, .xls, .csv" />
                    <button onClick={() => fileInputRef.current.click()} disabled={isImporting} className="bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-indigo-700 flex items-center gap-2 disabled:bg-indigo-800">
                        {isImporting ? <div className="loader"></div> : <i className="fas fa-upload"></i>} {isImporting ? 'Importing...' : 'Import'}
                    </button>
                    <button onClick={onExport} className="bg-green-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-700 flex items-center gap-2"><i className="fas fa-file-excel"></i> Export</button>
                    {userProfile?.role === 'Admin' && <button onClick={onDeleteAll} className="bg-red-700 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-800 flex items-center gap-2"><i className="fas fa-exclamation-triangle"></i> Delete All</button>}
                </div>
            </div>
        );
    });

    // Component for rendering the product table
    const ProductTable = memo(({ products, onAction, userProfile }) => {
        const { shops } = useData();
        const managedShops = useMemo(() => shops.filter(s => s.manageStock), [shops]);

        return (
            <table className="min-w-full divide-y divide-slate-700">
                <thead className="bg-slate-900/50">
                    <tr>
                        <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Code</th>
                        <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Barcode</th>
                        <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Name</th>
                        <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Vendor</th>
                        <th className="px-4 py-3 text-center text-xs font-semibold text-slate-400 uppercase">Min Stock</th>
                        <th className="px-4 py-3 text-right text-xs font-semibold text-slate-400 uppercase">Cost</th>
                        <th className="px-4 py-3 text-right text-xs font-semibold text-slate-400 uppercase">Price</th>
                        {managedShops.map(shop => <th key={shop.id} className="px-4 py-3 text-right text-xs font-semibold text-slate-400 uppercase">{shop.name}</th>)}
                        <th className="px-4 py-3 text-center text-xs font-semibold text-slate-400 uppercase">Actions</th>
                    </tr>
                </thead>
                <tbody className="divide-y divide-slate-700">
                    {products.map(p => {
                         // Logic to highlight low stock rows
                        const totalStock = p.stockByShop ? Object.values(p.stockByShop).reduce((a, b) => a + b, 0) : 0;
                        const minStock = parseInt(p.minStock) || 0;
                        const isLowStock = minStock > 0 && totalStock < minStock;

                        return (
                        <tr key={p.id} className={isLowStock ? "bg-red-900/20 hover:bg-red-900/30" : "hover:bg-slate-700/50"}>
                            <td className="px-4 py-3 text-sm text-slate-200">
                                {p.code}
                                {isLowStock && <i className="fas fa-exclamation-triangle text-red-500 ml-2" title={`Low Stock! Total: ${totalStock} < Min: ${minStock}`}></i>}
                            </td>
                            <td className="px-4 py-3 text-sm text-slate-300">{p.barcode || ''}</td>
                            <td className="px-4 py-3 text-sm text-slate-300">{p.name}</td>
                            <td className="px-4 py-3 text-sm text-slate-400">{p.vendorName}</td>
                            <td className="px-4 py-3 text-sm text-slate-400 text-center">{p.minStock || '-'}</td>
                            <td className="px-4 py-3 text-sm text-slate-300 text-right">{khrFormatter.format(p.cost)}</td>
                            <td className="px-4 py-3 text-sm text-slate-300 text-right">{khrFormatter.format(p.price)}</td>
                            {managedShops.map(shop => {
                                const qty = p.stockByShop?.[shop.id] || 0;
                                const stockValue = qty * (p.cost || 0);
                                return (
                                <td key={shop.id} className="px-4 py-3 text-sm text-slate-300 text-right">
                                    <div className="flex flex-col items-end group">
                                        <div className="flex items-center justify-end gap-2">
                                            <span className={`font-semibold ${(minStock > 0 && qty < minStock) ? 'text-red-400' : ''}`}>
                                                {qty}
                                            </span>
                                            {userProfile.role === 'Admin' && (
                                                <button 
                                                    onClick={() => onAction('adjust-stock', { product: p, shopId: shop.id })} 
                                                    className="text-slate-500 hover:text-blue-400 opacity-0 group-hover:opacity-100 transition-opacity"
                                                    title="Adjust Stock"
                                                >
                                                    <i className="fas fa-pen-to-square"></i>
                                                </button>
                                            )}
                                        </div>
                                        {qty > 0 && (
                                            <span className="text-[10px] text-slate-500 group-hover:text-emerald-400 transition-colors" title="Total Cost of Stock">
                                                {khrFormatter.format(stockValue)}
                                            </span>
                                        )}
                                    </div>
                                </td>
                            )})}
                            <td className="px-4 py-3 text-center space-x-4">
                                <button onClick={() => onAction('show-label', p)} className="text-teal-400 hover:text-teal-300" title="Print Label"><i className="fas fa-barcode"></i></button>
                                <button onClick={() => onAction('show-history', p)} className="text-green-400 hover:text-green-300" title="Cost History"><i className="fas fa-history"></i></button>
                                <button onClick={() => onAction('show-movement', p)} className="text-cyan-400 hover:text-cyan-300" title="Movement History"><i className="fas fa-truck"></i></button>
                                <button onClick={() => onAction('view', p)} className="text-blue-400 hover:text-blue-300" title="View/Edit"><i className="fas fa-eye"></i></button>
                                <button onClick={() => onAction('delete', p)} className="text-red-500 hover:text-red-400" title="Delete"><i className="fas fa-trash"></i></button>
                            </td>
                        </tr>
                    )})}
                </tbody>
            </table>
        );
    });

    // Component for handling pagination controls
    const ProductPagination = memo(({ currentPage, totalPages, onNext, onPrev, totalResults, itemsPerPage }) => {
        if (totalResults === 0) return null;

        const startItem = (currentPage - 1) * itemsPerPage + 1;
        const endItem = Math.min(currentPage * itemsPerPage, totalResults);

        return (
            <div className="flex justify-between items-center mt-4 px-4 py-2 bg-slate-900/50 rounded-b-lg">
                <span className="text-sm text-slate-400">
                    Showing {startItem} to {endItem} of {totalResults} results
                </span>
                <div className="flex items-center gap-2">
                    <button
                        onClick={onPrev}
                        disabled={currentPage === 1}
                        className="px-3 py-1 bg-slate-700 rounded-md disabled:opacity-50 disabled:cursor-not-allowed hover:bg-slate-600 transition"
                    >
                        <i className="fas fa-chevron-left"></i>
                    </button>
                    <span className="text-sm text-slate-300 font-semibold px-2">
                        Page {currentPage} of {totalPages}
                    </span>
                    <button
                        onClick={onNext}
                        disabled={currentPage === totalPages}
                        className="px-3 py-1 bg-slate-700 rounded-md disabled:opacity-50 disabled:cursor-not-allowed hover:bg-slate-600 transition"
                    >
                        <i className="fas fa-chevron-right"></i>
                    </button>
                </div>
            </div>
        );
    });


    // Main ProductList component, now using client-side filtering
    const ProductList = ({ userProfile }) => {
        const { products: allProducts, vendors, shops, isLoading: dataLoading } = useData();
        
        const [filters, setFilters] = useState({ searchTerm: '', vendorId: '' });
        const [currentPage, setCurrentPage] = useState(1);
        const [itemsPerPage] = useState(20);
        
        const [modal, setModal] = useState({ type: null, data: null });
        const [productModal, setProductModal] = useState({ show: false, product: null, mode: 'edit' });
        const [isGeneratingCode, setIsGeneratingCode] = useState(false);
        
        const initialFormState = { code: '', barcode: '', name: '', vendorId: '', cost: 0, price: 0, note: '', minStock: 0, stockByShop: {} }; // Added minStock

        // Identify managed shops for calculation
        const managedShops = useMemo(() => shops.filter(s => s.manageStock), [shops]);

        const fuse = useMemo(() => {
            if (!allProducts) return null;
            return new Fuse(allProducts, {
                keys: ['name', 'code', 'barcode'],
                includeScore: true,
                threshold: 0.3,
                minMatchCharLength: 2,
            });
        }, [allProducts]);

        const filteredProducts = useMemo(() => {
            if (!allProducts) return [];
            const { searchTerm, vendorId } = filters;
            
            let results = [...allProducts]; // Create a mutable copy

            if (vendorId) {
                results = results.filter(p => p.vendorId === vendorId);
            }

            // If a search term is present, use Fuse for relevance-based results.
            if (searchTerm.trim() && fuse) {
                const searchInstance = vendorId ? new Fuse(results, { keys: ['name', 'code', 'barcode'], threshold: 0.3 }) : fuse;
                return searchInstance.search(searchTerm.trim()).map(result => result.item);
            }
            
            // Otherwise, sort the results alphabetically by name.
            return results.sort((a, b) => a.name.localeCompare(b.name));
        }, [filters, allProducts, fuse]);

        useEffect(() => {
            setCurrentPage(1);
        }, [filters]);

        const totalPages = Math.ceil(filteredProducts.length / itemsPerPage);
        const paginatedProducts = useMemo(() => {
            const startIndex = (currentPage - 1) * itemsPerPage;
            return filteredProducts.slice(startIndex, startIndex + itemsPerPage);
        }, [filteredProducts, currentPage, itemsPerPage]);

        const handleNextPage = () => setCurrentPage(prev => Math.min(prev + 1, totalPages));
        const handlePrevPage = () => setCurrentPage(prev => Math.max(prev - 1, 1));

        const handleAddNew = async () => {
            setIsGeneratingCode(true);
            try {
                const newCode = await generateUniqueProductCode();
                setProductModal({ show: true, product: { ...initialFormState, code: newCode }, mode: 'edit' });
            } catch (error) {
                handleAction('show-message', { title: 'Error', message: error.message, isError: true });
            } finally {
                setIsGeneratingCode(false);
            }
        };

        const handleAction = useCallback((type, data) => {
            switch (type) {
                case 'view': setProductModal({ show: true, product: data, mode: 'view' }); break;
                case 'edit': setProductModal({ show: true, product: data, mode: 'edit' }); break;
                case 'delete': setModal({ type: 'confirmDelete', data: data.id, title: 'Delete Product', message: `Delete ${data.name}?` }); break;
                case 'show-history': setModal({ type: 'history', data }); break;
                case 'show-label': setModal({ type: 'label', data }); break;
                case 'show-movement': setModal({ type: 'movement', data }); break;
                case 'show-message': setModal({ type: 'message', data }); break;
                // NEW ACTION
                case 'adjust-stock': setModal({ type: 'stock-adjust', data: data }); break;
            }
        }, []);

        const handleFilterChange = useCallback((newFilters) => {
            setFilters(newFilters);
        }, []);
        
        const refresh = useCallback(() => {
            setFilters({ searchTerm: '', vendorId: '' });
        }, []);

        const handleDelete = async (id) => {
            try {
                await db.collection("products").doc(id).delete();
                handleAction('show-message', { title: 'Success', message: 'Product deleted.' });
            } catch (error) {
                handleAction('show-message', { title: 'Error', message: 'Failed to delete product.', isError: true });
            }
        };
        
        const handleSaveProduct = async (formData, editId) => {
            const selectedVendor = vendors.find(v => v.id === formData.vendorId);
            const dataToSave = { 
                ...formData, 
                cost: parseFloat(formData.cost), 
                price: parseFloat(formData.price), 
                minStock: parseInt(formData.minStock) || 0, // Ensure minStock is saved
                vendorName: selectedVendor?.name || '' 
            };
            try {
                if (editId) {
                    await db.collection("products").doc(editId).update(dataToSave);
                } else {
                    // --- FIX START: Add creator info for new products ---
                    dataToSave.createdByName = userProfile.name;
                    dataToSave.createdByUID = userProfile.uid;
                    dataToSave.createdAt = firebase.firestore.FieldValue.serverTimestamp();
                    // --- FIX END ---
                    await db.collection("products").add(dataToSave);
                }
                handleAction('show-message', { title: 'Success', message: `Product ${editId ? 'updated' : 'added'}.` });
                setProductModal({ show: false, product: null });
            } catch (error) {
                handleAction('show-message', { title: 'Error', message: 'Failed to save product.', isError: true });
            }
        };

        const handleImport = async (file) => {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = async (evt) => {
                    try {
                        const workbook = XLSX.read(evt.target.result, { type: 'buffer' });
                        const json = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);
                        if (json.length === 0) throw new Error("File is empty or wrong format.");
                        
                        let created = 0, updated = 0, errors = 0;
                        const managedShops = shops.filter(s => s.manageStock); // Get managed shops to check for columns

                        for (const row of json) {
                            try {
                                if (!row.code) { errors++; continue; } // Code is mandatory

                                // Helper to find vendor if provided
                                let vendorId = '';
                                let vendorName = '';
                                if (row.vendorName) {
                                    const vendor = vendors.find(v => v.name === row.vendorName);
                                    if (vendor) {
                                        vendorId = vendor.id;
                                        vendorName = vendor.name;
                                    }
                                }

                                const productQuery = await db.collection("products").where("code", "==", row.code).limit(1).get();
                                
                                if (!productQuery.empty) {
                                    // --- UPDATE LOGIC (FIXED) ---
                                    const docId = productQuery.docs[0].id;
                                    const existingData = productQuery.docs[0].data();
                                    const updateData = {};

                                    // Only update basic fields if they exist in the Excel row
                                    if (row.barcode !== undefined) updateData.barcode = row.barcode;
                                    if (row.name !== undefined) updateData.name = row.name;
                                    if (row.cost !== undefined) updateData.cost = parseFloat(row.cost) || 0;
                                    if (row.price !== undefined) updateData.price = parseFloat(row.price) || 0;
                                    if (row.minStock !== undefined) updateData.minStock = parseInt(row.minStock) || 0; // <--- Added Min Stock update
                                    if (row.note !== undefined) updateData.note = row.note;
                                    
                                    // Update vendor only if a valid new vendor is provided
                                    if (vendorId) {
                                        updateData.vendorId = vendorId;
                                        updateData.vendorName = vendorName;
                                    }

                                    // --- CRITICAL STOCK FIX ---
                                    // Merge existing stock with any new stock values found in the Excel columns.
                                    // If the Excel does not have a column for a shop, keep the existing stock.
                                    let newStockByShop = { ...(existingData.stockByShop || {}) };
                                    let hasStockUpdate = false;

                                    managedShops.forEach(shop => {
                                        // Check if the shop name exists as a column in the row
                                        if (row[shop.name] !== undefined && row[shop.name] !== null && row[shop.name] !== '') {
                                            newStockByShop[shop.id] = parseInt(row[shop.name]) || 0;
                                            hasStockUpdate = true;
                                        }
                                    });

                                    // Only include stockByShop in the update if we actually found stock columns to update.
                                    // Otherwise, we leave the existing stockByShop field entirely alone.
                                    if (hasStockUpdate) {
                                        updateData.stockByShop = newStockByShop;
                                    }

                                    await db.collection("products").doc(docId).update(updateData);
                                    updated++;
                                } else {
                                    // --- CREATE LOGIC ---
                                    // For new products, vendor is required
                                    if (!vendorId && row.vendorName) { 
                                        // Try to find vendor again or skip if missing
                                        const v = vendors.find(v => v.name === row.vendorName);
                                        if (!v) { errors++; continue; }
                                        vendorId = v.id; vendorName = v.name;
                                    } else if (!vendorId) {
                                        errors++; continue;
                                    }

                                    const initialStock = {};
                                    managedShops.forEach(shop => {
                                        if (row[shop.name] !== undefined) {
                                            initialStock[shop.id] = parseInt(row[shop.name]) || 0;
                                        }
                                    });

                                    const productData = {
                                        code: row.code, 
                                        barcode: row.barcode || '', 
                                        name: row.name || '',
                                        vendorId: vendorId, 
                                        vendorName: vendorName, 
                                        cost: parseFloat(row.cost) || 0,
                                        price: parseFloat(row.price) || 0, 
                                        minStock: parseInt(row.minStock) || 0, // <--- Added Min Stock for new products
                                        note: row.note || '', 
                                        stockByShop: initialStock,
                                        createdByName: userProfile.name,
                                        createdByUID: userProfile.uid,
                                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                                    };
                                    await db.collection("products").add(productData);
                                    created++;
                                }
                            } catch (e) { 
                                console.error("Error processing row", e);
                                errors++; 
                            }
                        }
                        handleAction('show-message', { title: 'Import Complete', message: `${created} created, ${updated} updated, ${errors} failed.` });
                        resolve();
                    } catch (error) {
                        handleAction('show-message', { title: 'Import Error', message: error.message, isError: true });
                        reject(error);
                    }
                };
                reader.readAsArrayBuffer(file);
            });
        };
        
        const handleExport = async () => {
            const managedShops = shops.filter(s => s.manageStock);
            const headers = ['Code', 'Barcode', 'Name', 'Vendor', 'Min Stock', 'Cost', 'Price', 'Note', ...managedShops.map(s => s.name)]; // Added Min Stock header

            const data = filteredProducts.map(p => {
                const row = { 'Code': p.code, 'Barcode': p.barcode, 'Name': p.name, 'Vendor': p.vendorName, 'Min Stock': p.minStock || 0, 'Cost': p.cost, 'Price': p.price, 'Note': p.note }; // Added Min Stock data
                managedShops.forEach(shop => { row[shop.name] = p.stockByShop?.[shop.id] || 0; });
                return row;
            });

            const ws = XLSX.utils.json_to_sheet(data, { header: headers });
            ws['!cols'] = [ {wch:15}, {wch:15}, {wch:40}, {wch:20}, {wch:10}, {wch:12}, {wch:12}, {wch:20}, ...managedShops.map(() => ({wch: 15}))]; // Added width for Min Stock
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Products");
            XLSX.writeFile(wb, "products_export.xlsx");
        };

        const handleDownloadTemplate = () => {
            // Get shops that manage stock
            const managedShops = shops.filter(s => s.manageStock);
            
            // Create a sample row with basic fields
            const sampleRow = { 
                code: 'P001', 
                barcode: '885000000001', 
                name: 'Sample Product', 
                vendorName: 'Sample Vendor', 
                minStock: 10, // <--- Added Min Stock sample value
                cost: 10000, 
                price: 15000, 
                note: 'Sample' 
            };

            // Dynamically add a column for each managed shop with a sample value of 0
            managedShops.forEach(shop => {
                sampleRow[shop.name] = 0;
            });

            const ws = XLSX.utils.json_to_sheet([sampleRow]);
            
            // Set nice column widths
            const wscols = [
                {wch: 15}, // Code
                {wch: 15}, // Barcode
                {wch: 30}, // Name
                {wch: 20}, // Vendor
                {wch: 10}, // Min Stock <--- Added Min Stock width
                {wch: 10}, // Cost
                {wch: 10}, // Price
                {wch: 20}  // Note
            ];
            // Add width for each shop column
            managedShops.forEach(() => wscols.push({wch: 15}));
            
            ws['!cols'] = wscols;

            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Products");
            XLSX.writeFile(wb, "product_import_template.xlsx");
        };
        
        const handleDeleteAll = async () => {
            handleAction('show-message', { title: 'Processing...', message: 'Deleting all products...' });
            try {
                const productsRef = db.collection("products");
                let querySnapshot = await productsRef.limit(500).get();
                while (querySnapshot.size > 0) {
                    const batch = db.batch();
                    querySnapshot.docs.forEach(doc => batch.delete(doc.ref));
                    await batch.commit();
                    querySnapshot = await productsRef.limit(500).get();
                }
                handleAction('show-message', { title: 'Success', message: `All products deleted.` });
            } catch (error) {
                handleAction('show-message', { title: 'Error', message: 'An error occurred while deleting products.', isError: true });
            }
        };
        
        return (
            <div className="space-y-6">
                {modal.type === 'message' && <MessageModal {...modal.data} show={true} onClose={() => setModal({ type: null })} />}
                {modal.type === 'confirmDelete' && <ConfirmationModal {...modal} show={true} onConfirm={() => { handleDelete(modal.data); setModal({ type: null }); }} onCancel={() => setModal({ type: null })} />}
                {modal.type === 'confirmDeleteAll' && <ConfirmationModal {...modal} show={true} onConfirm={() => { handleDeleteAll(); setModal({ type: null }); }} onCancel={() => setModal({ type: null })} />}
                {modal.type === 'history' && <CostHistoryModal product={modal.data} onClose={() => setModal({ type: null })} />}
                {modal.type === 'label' && <ProductLabelModal product={modal.data} onClose={() => setModal({ type: null })} />}
                {modal.type === 'movement' && <ProductMovementHistoryModal product={modal.data} onClose={() => setModal({ type: null })} />}
                
                {/* NEW MODAL RENDER */}
                {modal.type === 'stock-adjust' && (
                    <StockAdjustmentModal 
                        product={modal.data.product} 
                        initialShopId={modal.data.shopId} 
                        userProfile={userProfile} 
                        onClose={() => setModal({ type: null })} 
                    />
                )}

                {productModal.show && <ProductModal 
                    show={true} 
                    productToEdit={productModal.product} 
                    mode={productModal.mode}
                    onSave={handleSaveProduct} 
                    onClose={() => setProductModal({ show: false, product: null, mode: 'edit' })} 
                />}

                <TableCard title={`Existing Products - ${filteredProducts.length}`}>
                    <ProductFilters onFilterChange={handleFilterChange} onClear={refresh} />
                    <ProductActions 
                        onAddNew={handleAddNew}
                        onImport={handleImport}
                        onExport={handleExport}
                        onTemplate={handleDownloadTemplate}
                        onDeleteAll={() => setModal({ type: 'confirmDeleteAll', title: 'DANGER: Delete All Products', message: 'Are you sure you want to delete ALL products? This cannot be undone.'})}
                        userProfile={userProfile}
                        isGeneratingCode={isGeneratingCode}
                    />
                    {dataLoading ? (
                        <div className="flex justify-center p-8"><div className="loader"></div></div>
                    ) : filteredProducts.length === 0 ? (
                        <p className="text-center p-4 text-slate-400">No products found for the current filters.</p>
                    ) : (
                        <>
                            <ProductTable products={paginatedProducts} onAction={handleAction} userProfile={userProfile} />
                            <ProductPagination 
                                currentPage={currentPage}
                                totalPages={totalPages}
                                onNext={handleNextPage}
                                onPrev={handlePrevPage}
                                totalResults={filteredProducts.length}
                                itemsPerPage={itemsPerPage}
                            />
                        </>
                    )}
                </TableCard>
            </div>
        );
    };


    const ProductModal = ({ show, onClose, productToEdit, onSave, mode = 'edit' }) => {
        const { vendors, shops } = useData(); // <-- Added shops
        // PHASE 1: Added category field
        const initialFormState = { code: '', barcode: '', name: '', category: 'General', vendorId: '', cost: 0, price: 0, note: '', minStock: 0, stockByShop: {} };
        const [formData, setFormData] = useState(initialFormState);
        
        const managedShops = useMemo(() => shops.filter(s => s.manageStock).sort((a,b) => a.name.localeCompare(b.name)), [shops]);

        // State for vendor search functionality
        const [vendorSearch, setVendorSearch] = useState('');
        const [vendorSearchResults, setVendorSearchResults] = useState([]);
        const vendorFuse = useMemo(() => new Fuse(vendors, { keys: ['name'], threshold: 0.4 }), [vendors]);
        const debouncedVendorSearch = useDebounce(vendorSearch, 300);

        // --- New state for barcode validation ---
        const [barcodeValidation, setBarcodeValidation] = useState({ status: 'idle', message: '' }); // idle, validating, valid, invalid
        const debouncedBarcode = useDebounce(formData.barcode, 500); // Debounce barcode input
        const [modalInfo, setModalInfo] = useState({ show: false, title: '', message: '', isError: false });

        // --- New state for view/edit mode ---
        const [isViewMode, setIsViewMode] = useState(mode === 'view');

        useEffect(() => {
            if (productToEdit) {
                const initialVendor = vendors.find(v => v.id === productToEdit.vendorId);
                setVendorSearch(initialVendor ? initialVendor.name : '');
                setFormData({ ...initialFormState, ...productToEdit });
                // When editing, the initial barcode is considered valid.
                setBarcodeValidation({ status: 'idle', message: '' }); 
            } else {
                setFormData(initialFormState);
                setVendorSearch('');
                setBarcodeValidation({ status: 'idle', message: '' });
            }
            // Reset mode when props change
            setIsViewMode(mode === 'view');
        }, [productToEdit, show, vendors, mode]);

        // --- New effect for barcode validation ---
        useEffect(() => {
            const validateBarcode = async () => {
                const barcode = debouncedBarcode?.trim();

                if (!barcode) {
                    setBarcodeValidation({ status: 'idle', message: '' }); // No barcode, so it's fine (or use 'idle')
                    return;
                }

                // If we are editing and the barcode hasn't changed, it's valid.
                if (productToEdit && productToEdit.barcode === barcode) {
                    setBarcodeValidation({ status: 'valid', message: '' });
                    return;
                }

                setBarcodeValidation({ status: 'validating', message: '' });

                try {
                    const snapshot = await db.collection("products").where("barcode", "==", barcode).limit(1).get();
                    if (!snapshot.empty) {
                        const doc = snapshot.docs[0].data();
                        setBarcodeValidation({ status: 'invalid', message: `Barcode already in use by: ${doc.name}` });
                    } else {
                        setBarcodeValidation({ status: 'valid', message: '' });
                    }
                } catch (error) {
                    console.error("Barcode validation error:", error);
                    // Don't block saving if validation fails, but log it.
                    setBarcodeValidation({ status: 'idle', message: 'Could not validate barcode.' }); 
                }
            };

            // Only validate if not in view mode
            if (!isViewMode) {
                validateBarcode();
            } else {
                setBarcodeValidation({ status: 'idle', message: '' });
            }
        }, [debouncedBarcode, productToEdit, isViewMode]);


        useEffect(() => {
            if (debouncedVendorSearch && !formData.vendorId && !isViewMode) {
                const results = vendorFuse.search(debouncedVendorSearch);
                setVendorSearchResults(results.map(r => r.item));
            } else {
                setVendorSearchResults([]);
            }
        }, [debouncedVendorSearch, vendorFuse, formData.vendorId, isViewMode]);
        
        const handleInputChange = (e) => {
            setFormData(prev => ({ ...prev, [e.target.name]: e.target.value }));
            if (e.target.name === 'barcode') {
                 // Reset validation on key press, let debouncer handle it
                setBarcodeValidation({ status: 'validating', message: '' });
            }
        };

        const handleStockChange = (e, shopId) => {
            const { value } = e.target;
            const newQty = parseInt(value, 10);

            if (value === '') {
                // Allow empty string to clear the field, store as 0
                setFormData(prev => ({ ...prev, stockByShop: { ...prev.stockByShop, [shopId]: 0 } }));
            } else if (!isNaN(newQty) && newQty >= 0) {
                setFormData(prev => ({ ...prev, stockByShop: { ...prev.stockByShop, [shopId]: newQty } }));
            }
            // This logic prevents negative numbers or invalid text from updating state
        };

        const handleSubmit = (e) => { 
            e.preventDefault(); 
            
            // --- FIX START ---
            // If this function is somehow triggered by the 'Edit' button while in view mode,
            // stop it from proceeding.
            if (isViewMode) {
                return;
            }
            // --- FIX END ---

            // --- Check validation before saving ---
            if (barcodeValidation.status === 'invalid') {
                setModalInfo({ show: true, title: "Validation Error", message: "Cannot save: The barcode is already in use by another product.", isError: true });
                return;
            }
            if (barcodeValidation.status === 'validating') {
                setModalInfo({ show: true, title: "Validation Error", message: "Please wait, barcode is currently being validated.", isError: true });
                return;
            }
            onSave(formData, productToEdit?.id); 
        };

        const handleInputKeyDown = (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                const form = e.target.form;
                if (form) {
                    const index = Array.prototype.indexOf.call(form, e.target);
                    const nextElement = form.elements[index + 1];
                    if (nextElement) {
                        nextElement.focus();
                    }
                }
            }
        };
        
        const selectVendor = (vendor) => {
            setFormData(prev => ({ ...prev, vendorId: vendor.id }));
            setVendorSearch(vendor.name);
            setVendorSearchResults([]);
        };

        return (
            <Modal show={show} onClose={onClose} maxWidth="max-w-4xl">
                <MessageModal {...modalInfo} show={modalInfo.show} onClose={() => setModalInfo({ show: false })} />
                <form onSubmit={handleSubmit} className="flex flex-col flex-1 h-full">
                    <ModalHeader title={productToEdit?.id ? "Edit Product" : "Add New Product"} onClose={onClose} />
                    <ModalBody>
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-6">
                            
                            {/* --- Left Column --- */}
                            <div className="flex flex-col gap-y-6">
                                <div>
                                    <label className="block text-sm font-medium text-slate-300 mb-1">Product Code</label>
                                    <input type="text" name="code" value={formData.code} onChange={handleInputChange} className="w-full bg-slate-700 text-slate-100 px-3 py-2 border border-slate-600 rounded-md read-only:bg-slate-800 read-only:text-slate-400" required readOnly={true} />
                                </div>
                                
                                <div>
                                    <label className="block text-sm font-medium text-slate-300 mb-1">Barcode</label>
                                    <input type="text" name="barcode" value={formData.barcode || ''} onChange={handleInputChange} onKeyDown={handleInputKeyDown} className="w-full bg-slate-700 text-slate-100 px-3 py-2 border border-slate-600 rounded-md read-only:bg-slate-800 read-only:text-slate-400" readOnly={isViewMode} />
                                    {/* --- Validation Feedback --- */}
                                    <div className="h-4 mt-1 text-xs">
                                        {!isViewMode && barcodeValidation.status === 'validating' && (
                                            <div className="flex items-center text-blue-400">
                                                <div className="loader w-3 h-3 mr-2 border-2"></div>
                                                Checking...
                                            </div>
                                        )}
                                        {!isViewMode && barcodeValidation.status === 'invalid' && (
                                            <p className="text-red-400">{barcodeValidation.message}</p>
                                        )}
                                        {!isViewMode && barcodeValidation.status === 'valid' && formData.barcode && (
                                            <p className="text-green-400">Barcode is unique.</p>
                                        )}
                                    </div>
                                </div>
                                
                                <div>
                                    <label className="block text-sm font-medium text-slate-300 mb-1">Product Name</label>
                                    <input type="text" name="name" value={formData.name} onChange={handleInputChange} onKeyDown={handleInputKeyDown} className="w-full bg-slate-700 text-slate-100 px-3 py-2 border border-slate-600 rounded-md read-only:bg-slate-800 read-only:text-slate-400" required readOnly={isViewMode} />
                                </div>
                                
                                {/* PHASE 1: Category Input */}
                                <div>
                                    <label className="block text-sm font-medium text-slate-300 mb-1">Category</label>
                                    <input 
                                        type="text" 
                                        name="category" 
                                        list="category-suggestions" 
                                        value={formData.category} 
                                        onChange={handleInputChange} 
                                        onKeyDown={handleInputKeyDown} 
                                        className="w-full bg-slate-700 text-slate-100 px-3 py-2 border border-slate-600 rounded-md read-only:bg-slate-800 read-only:text-slate-400" 
                                        readOnly={isViewMode} 
                                        placeholder="e.g. Drinks, Snacks"
                                    />
                                    <datalist id="category-suggestions">
                                        <option value="General" />
                                        <option value="Drinks" />
                                        <option value="Snacks" />
                                        <option value="Household" />
                                        <option value="Electronics" />
                                    </datalist>
                                </div>
                                
                                <div className="relative">
                                    <label className="block text-sm font-medium text-slate-300 mb-1">Vendor</label>
                                    <input
                                        type="text"
                                        value={vendorSearch}
                                        onChange={(e) => {
                                            setVendorSearch(e.target.value);
                                            if (formData.vendorId) {
                                                setFormData(prev => ({ ...prev, vendorId: '' }));
                                            }
                                        }}
                                        onKeyDown={handleInputKeyDown}
                                        className="w-full bg-slate-700 text-slate-100 px-3 py-2 border border-slate-600 rounded-md read-only:bg-slate-800 read-only:text-slate-400"
                                        required
                                        autoComplete="off"
                                        placeholder="Search for a vendor..."
                                        readOnly={isViewMode}
                                    />
                                    {vendorSearchResults.length > 0 && !isViewMode && (
                                        <div className="absolute z-20 w-full bg-slate-800 border border-slate-600 rounded-md mt-1 shadow-lg max-h-40 overflow-y-auto">
                                            {vendorSearchResults.map(v => (
                                                <div key={v.id} onClick={() => selectVendor(v)} className="p-2 cursor-pointer hover:bg-slate-700">
                                                    <p className="font-semibold text-slate-200">{v.name}</p>
                                                </div>
                                            ))}
                                        </div>
                                    )}
                                </div>

                                {/* --- Min Stock Field --- */}
                                <div>
                                    <label className="block text-sm font-medium text-slate-300 mb-1">Min Stock Alert Level</label>
                                    <input 
                                        type="number" 
                                        name="minStock" 
                                        value={formData.minStock} 
                                        onChange={handleInputChange} 
                                        className="w-full bg-slate-700 text-slate-100 px-3 py-2 border border-slate-600 rounded-md read-only:bg-slate-800 read-only:text-slate-400" 
                                        readOnly={isViewMode} 
                                        min="0"
                                        placeholder="0 for no alert"
                                    />
                                    <p className="text-xs text-slate-500 mt-1">Alert when stock falls below this amount.</p>
                                </div>
                                
                                <div>
                                    <label className="block text-sm font-medium text-slate-300 mb-1">Note</label>
                                    <textarea name="note" value={formData.note || ''} onChange={handleInputChange} rows="4" className="w-full bg-slate-700 text-slate-100 px-3 py-2 border border-slate-600 rounded-md read-only:bg-slate-800 read-only:text-slate-400" readOnly={isViewMode}></textarea>
                                </div>
                            </div>
                            
                            {/* --- Right Column --- */}
                            <div className="flex flex-col gap-y-6">
                                <div className="grid grid-cols-2 gap-x-4">
                                    <div>
                                        <label className="block text-sm font-medium text-slate-300 mb-1">Cost</label>
                                        <input type="number" name="cost" value={formData.cost} onChange={handleInputChange} onKeyDown={handleInputKeyDown} className="w-full bg-slate-700 text-slate-100 px-3 py-2 border border-slate-600 rounded-md read-only:bg-slate-800 read-only:text-slate-400" required readOnly={isViewMode} />
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium text-slate-300 mb-1">Sale Price</label>
                                        <input type="number" name="price" value={formData.price} onChange={handleInputChange} onKeyDown={handleInputKeyDown} className="w-full bg-slate-700 text-slate-100 px-3 py-2 border border-slate-600 rounded-md read-only:bg-slate-800 read-only:text-slate-400" required readOnly={isViewMode} />
                                    </div>
                                </div>

                                {/* --- Stock by Shop Section --- */}
                                <div>
                                    <label className="block text-sm font-medium text-slate-300 mb-2">Stock by Shop</label>
                                    <div className="grid grid-cols-2 lg:grid-cols-3 gap-4 p-4 border border-slate-700 rounded-md bg-slate-900/30">
                                        {managedShops.length === 0 && (
                                            <p className="text-sm text-slate-400 col-span-full">No shops are set to manage stock. (Add/Edit in Settings -> Shop Management)</p>
                                        )}
                                        {managedShops.map(shop => (
                                            <div key={shop.id}>
                                                <label className="block text-xs font-medium text-slate-400 mb-1 truncate" title={shop.name}>{shop.name}</label>
                                                <input 
                                                    type="number" 
                                                    value={formData.stockByShop?.[shop.id] || 0}
                                                    onChange={(e) => handleStockChange(e, shop.id)}
                                                    className="w-full bg-slate-700 text-slate-100 px-3 py-2 border border-slate-600 rounded-md read-only:bg-slate-800 read-only:text-slate-400"
                                                    readOnly={isViewMode}
                                                    min="0"
                                                />
                                            </div>
                                        ))}
                                    </div>
                                </div>

                                {/* --- Creator Info Section --- */}
                                {productToEdit?.id && (
                                    <div className="pt-4 border-t border-slate-700">
                                        <p className="text-xs text-slate-400">
                                            Product Created By: <span className="font-medium text-slate-300">{formData.createdByName || 'N/A'}</span>
                                        </p>
                                        <p className="text-xs text-slate-400">
                                            Created On: <span className="font-medium text-slate-300">{formData.createdAt ? formatDateDDMMYYYY(formData.createdAt) : 'N/A'}</span>
                                        </p>
                                    </div>
                                )}
                            </div>
                        </div>
                    </ModalBody>
                    <ModalFooter>
                        <button type="button" onClick={onClose} className="bg-slate-600 text-slate-100 font-bold py-2 px-6 rounded-lg hover:bg-slate-500">
                            {isViewMode ? 'Close' : 'Cancel'}
                        </button>
                        {isViewMode ? (
                            <button 
                                type="button" 
                                onClick={(e) => {
                                    e.preventDefault(); // Explicitly prevent any form submission
                                    setIsViewMode(false);
                                }}
                                className="bg-blue-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-700"
                            >
                                <i className="fas fa-edit mr-2"></i>Edit
                            </button>
                        ) : (
                            <button 
                                type="submit" 
                                disabled={barcodeValidation.status === 'invalid' || barcodeValidation.status === 'validating'}
                                className={`${productToEdit?.id ? 'bg-green-600 hover:bg-green-700' : 'bg-blue-600 hover:bg-blue-700'} text-white font-bold py-2 px-6 rounded-lg disabled:bg-slate-700 disabled:cursor-not-allowed`}
                            >
                                {productToEdit?.id ? 'Update Product' : 'Add Product'}
                            </button>
                        )}
                    </ModalFooter>
                </form>
            </Modal>
        );
    };

    const ProductMovementHistoryModal = ({ product, onClose }) => {
        const { data: history, loading } = useCollection('productMovement', { query: [['productId', '==', product.id]] });
        const sortedHistory = useMemo(() => {
            if (!history) return [];
            return [...history].sort((a, b) => {
                const dateA = safeToDate(a.timestamp);
                const dateB = safeToDate(b.timestamp);
                if (!dateB) return -1;
                if (!dateA) return 1;
                return dateB - dateA;
            });
        }, [history]);

        const typeStyles = {
            PO: 'bg-green-500/20 text-green-300',
            Transfer: 'bg-blue-500/20 text-blue-300',
        };

        return (
            <Modal show={true} onClose={onClose} maxWidth="max-w-4xl">
                <ModalHeader title={`Movement History: ${product.name}`} onClose={onClose} />
                <ModalBody>
                    {loading ? <p className="text-center">Loading history...</p> : sortedHistory.length === 0 ? <p className="text-center text-slate-400">No movement history found for this product.</p> : (
                        <table className="min-w-full divide-y divide-slate-700">
                            <thead className="bg-slate-900/50">
                                <tr>
                                    <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Date</th>
                                    <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Type</th>
                                    <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Reference No.</th>
                                    <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">From</th>
                                    <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">To</th>
                                    <th className="px-4 py-3 text-right text-xs font-semibold text-slate-400 uppercase">Quantity</th>
                                </tr>
                            </thead>
                            <tbody className="divide-y divide-slate-700">
                                {sortedHistory.map(entry => (
                                    <tr key={entry.id} className="hover:bg-slate-700/50">
                                        <td className="px-4 py-3 text-sm text-slate-400">{formatDateDDMMYYYY(entry.timestamp)}</td>
                                        <td className="px-4 py-3 text-sm text-left">
                                            <span className={`px-2 py-1 text-xs font-medium rounded-md ${typeStyles[entry.type]}`}>
                                                {entry.type}
                                            </span>
                                        </td>
                                        <td className="px-4 py-3 text-sm text-slate-300">{entry.referenceNo}</td>
                                        <td className="px-4 py-3 text-sm text-slate-400">{entry.from}</td>
                                        <td className="px-4 py-3 text-sm text-slate-400">{entry.to}</td>
                                        <td className="px-4 py-3 text-sm text-green-400 text-right font-bold">+{khrFormatter.format(entry.quantityChange)}</td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    )}
                </ModalBody>
                <ModalFooter>
                    <button onClick={onClose} type="button" className="bg-slate-600 font-bold py-2 px-6 rounded-lg hover:bg-slate-500">Close</button>
                </ModalFooter>
            </Modal>
        );
    };

    const CostHistoryModal = ({ product, onClose }) => {
        const { data: history, loading } = useCollection('costHistory', { query: [['productId', '==', product.id]] });
        const sortedHistory = useMemo(() => history ? [...history].sort((a, b) => safeToDate(b.updatedAt) - safeToDate(a.updatedAt)) : [], [history]);

        return (
            <Modal show={true} onClose={onClose} maxWidth="max-w-3xl">
                <ModalHeader title={`Cost History: ${product.name}`} onClose={onClose} />
                <ModalBody>
                    {loading ? <p className="text-center">Loading...</p> : sortedHistory.length === 0 ? <p className="text-center text-slate-400">No cost history found.</p> : (
                        <table className="min-w-full divide-y divide-slate-700">
                            <thead className="bg-slate-900/50">
                                <tr>
                                    <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Date</th>
                                    <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">PO Number</th>
                                    <th className="px-4 py-3 text-right text-xs font-semibold text-slate-400 uppercase">Old Cost</th>
                                    <th className="px-4 py-3 text-right text-xs font-semibold text-slate-400 uppercase">New Cost</th>
                                    <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Audited By</th>
                                </tr>
                            </thead>
                            <tbody className="divide-y divide-slate-700">
                                {sortedHistory.map(entry => (
                                    <tr key={entry.id} className="hover:bg-slate-700/50">
                                        <td className="px-4 py-3 text-sm text-slate-400">{formatDateDDMMYYYY(entry.updatedAt)}</td>
                                        <td className="px-4 py-3 text-sm text-slate-300">{entry.poNumber}</td>
                                        <td className="px-4 py-3 text-sm text-slate-400 text-right">{khrFormatter.format(entry.oldCost)}</td>
                                        <td className="px-4 py-3 text-sm text-green-400 text-right">{khrFormatter.format(entry.newCost)}</td>
                                        <td className="px-4 py-3 text-sm text-slate-400">{entry.auditedBy}</td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    )}
                </ModalBody>
                <ModalFooter>
                    <button onClick={onClose} type="button" className="bg-slate-600 font-bold py-2 px-6 rounded-lg hover:bg-slate-500">Close</button>
                </ModalFooter>
            </Modal>
        );
    };

    const VendorList = ({ userProfile }) => {
        const { vendors, products } = useData();
        const [formData, setFormData] = useState({ name: '', contact: '', priority: 'Low' });
        const [editId, setEditId] = useState(null);
        const [modal, setModal] = useState({ type: null, data: null });
        const [searchTerm, setSearchTerm] = useState('');

        const filteredVendors = useMemo(() => {
            const priorityOrder = { 'High': 1, 'Medium': 2, 'Low': 3 };
            
            let filtered = searchTerm 
                ? vendors.filter(v => v.name.toLowerCase().includes(searchTerm.toLowerCase()) || v.contact?.toLowerCase().includes(searchTerm.toLowerCase())) 
                : [...vendors]; // Create a copy to sort

            return filtered.sort((a, b) => {
                const priorityA = priorityOrder[a.priority || 'Low'];
                const priorityB = priorityOrder[b.priority || 'Low'];
                if (priorityA === priorityB) {
                    return a.name.localeCompare(b.name); // Secondary sort by name
                }
                return priorityA - priorityB;
            });
        }, [vendors, searchTerm]);

        const productCounts = useMemo(() => {
            if (!products) return {};
            return products.reduce((acc, product) => {
                if (product.vendorId) {
                    acc[product.vendorId] = (acc[product.vendorId] || 0) + 1;
                }
                return acc;
            }, {});
        }, [products]);

        const handleInputChange = (e) => setFormData(prev => ({ ...prev, [e.target.name]: e.target.value }));
        const resetForm = () => { setFormData({ name: '', contact: '', priority: 'Low' }); setEditId(null); };
        const handleEdit = (vendor) => { setEditId(vendor.id); setFormData({ name: vendor.name, contact: vendor.contact, priority: vendor.priority || 'Low' }); window.scrollTo(0, 0); };

        const handleDelete = async (id) => {
            try {
                await db.collection("vendors").doc(id).delete();
                setModal({ type: 'message', data: { title: 'Success', message: 'Vendor deleted.' } });
            } catch (error) {
                setModal({ type: 'message', data: { title: 'Error', message: 'Failed to delete vendor.', isError: true } });
            }
        };

        const handleSubmit = async (e) => {
            e.preventDefault();
            try {
                if (editId) await db.collection("vendors").doc(editId).update(formData);
                else await db.collection("vendors").add(formData);
                setModal({ type: 'message', data: { title: 'Success', message: `Vendor ${editId ? 'updated' : 'added'}.` } });
                resetForm();
            } catch (error) {
                setModal({ type: 'message', data: { title: 'Error', message: 'Failed to save vendor.', isError: true } });
            }
        };

        const priorityStyles = {
            High: 'bg-red-500/20 text-red-300 border border-red-500/30',
            Medium: 'bg-yellow-500/20 text-yellow-300 border border-yellow-500/30',
            Low: 'bg-blue-500/20 text-blue-300 border border-blue-500/30',
        };

        return (
            <div className="space-y-6">
                <MessageModal {...modal.data} show={modal.type === 'message'} onClose={() => setModal({ type: null })} />
                <ConfirmationModal title="Delete Shop" message="Are you sure?" show={modal.type === 'confirmDelete'} onConfirm={() => {handleDelete(modal.data); setModal({type: null})}} onCancel={() => setModal({ type: null })} />

                <Card>
                    <h4 className="text-xl font-semibold mb-4 text-slate-200">{editId ? "Edit Vendor" : "Add New Vendor"}</h4>
                    <form onSubmit={handleSubmit} className="p-6 bg-slate-900/50 rounded-lg border border-slate-700">
                        <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <div>
                                <label className="block text-sm font-medium text-slate-300 mb-1">
                                    <i className="fas fa-building text-orange-400 mr-2"></i>Vendor Name
                                </label>
                                <input type="text" name="name" placeholder="Vendor Name" value={formData.name} onChange={handleInputChange} className="w-full bg-slate-700 text-slate-100 px-3 py-2 border border-slate-600 rounded-md" required />
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-slate-300 mb-1">
                                    <i className="fas fa-address-book text-blue-400 mr-2"></i>Contact Info
                                </label>
                                <input type="text" name="contact" placeholder="Contact Info" value={formData.contact} onChange={handleInputChange} className="w-full bg-slate-700 text-slate-100 px-3 py-2 border border-slate-600 rounded-md" required />
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-slate-300 mb-1">
                                    <i className="fas fa-flag text-red-400 mr-2"></i>Priority
                                </label>
                                <select name="priority" value={formData.priority} onChange={handleInputChange} className="w-full bg-slate-700 text-slate-100 px-3 py-2 border border-slate-600 rounded-md h-[42px]">
                                    <option value="High">High</option>
                                    <option value="Medium">Medium</option>
                                    <option value="Low">Low</option>
                                </select>
                            </div>
                        </div>
                        <div className="mt-6 text-right space-x-3">
                            {editId && <button type="button" onClick={resetForm} className="bg-slate-600 font-bold py-2 px-6 rounded-lg hover:bg-slate-500">Cancel</button>}
                            <button type="submit" className={`${editId ? 'bg-green-600 hover:bg-green-700' : 'bg-blue-600 hover:bg-blue-700'} text-white font-bold py-2 px-6 rounded-lg`}>
                                {editId ? 'Update' : 'Add'}
                            </button>
                        </div>
                    </form>
                </Card>

                <TableCard title="Existing Vendors">
                    <div className="mb-4 border-b border-slate-700 pb-4">
                        <label className="block text-sm font-medium text-slate-300 mb-1">
                            <i className="fas fa-search text-purple-400 mr-2"></i>Search Vendor
                        </label>
                        <div className="relative max-w-sm">
                            <input 
                                type="text" 
                                placeholder="Search by name or contact..." 
                                value={searchTerm} 
                                onChange={(e) => setSearchTerm(e.target.value)} 
                                className="w-full bg-slate-700 text-slate-100 px-3 py-2 pl-10 border border-slate-600 rounded-md focus:ring-2 focus:ring-blue-500 outline-none"
                            />
                            <i className="fas fa-search absolute left-3 top-3 text-slate-400"></i>
                        </div>
                    </div>
                    {filteredVendors.length === 0 ? <p className="text-center p-4 text-slate-400">No vendors found.</p> : (
                        <table className="min-w-full divide-y divide-slate-700">
                            <thead className="bg-slate-900/50">
                                <tr>
                                    <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Name</th>
                                    <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Contact</th>
                                    <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Priority</th>
                                    <th className="px-4 py-3 text-center text-xs font-semibold text-slate-400 uppercase">Actions</th>
                                </tr>
                            </thead>
                            <tbody className="divide-y divide-slate-700">
                                {filteredVendors.map(vendor => (
                                    <tr key={vendor.id} className="hover:bg-slate-700/50">
                                        <td className="px-4 py-3 text-sm text-slate-200">{vendor.name}</td>
                                        <td className="px-4 py-3 text-sm text-slate-400">{vendor.contact || '-'}</td>
                                        <td className="px-4 py-3 text-sm text-left">
                                            <span className={`px-2 py-1 text-xs font-medium rounded-md ${priorityStyles[vendor.priority || 'Low']}`}>
                                                {vendor.priority || 'Low'}
                                            </span>
                                        </td>
                                        <td className="px-4 py-3 text-center space-x-4">
                                            <button onClick={() => handleEdit(vendor)} className="text-blue-400 hover:text-blue-300"><i className="fas fa-edit"></i></button>
                                            <button onClick={() => setModal({ type: 'confirmDelete', data: vendor.id })} className="text-red-500 hover:text-red-400"><i className="fas fa-trash"></i></button>
                                        </td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    )}
                </TableCard>
            </div>
        );
    };

    // --- 8.8 Settings Page (Redesigned) ---
    const SettingsPage = () => {
        const [activeTab, setActiveTab] = useState('general');
        
        const tabs = [
            { id: 'general', label: 'General', subLabel: 'App Name & Config', icon: 'fa-sliders-h' },
            { id: 'users', label: 'Users & Permissions', subLabel: 'Manage Staff Access', icon: 'fa-users-cog' },
            { id: 'shops', label: 'Shops & Locations', subLabel: 'Manage Outlets', icon: 'fa-store-alt' },
            { id: 'devices', label: 'Devices & Terminals', subLabel: 'POS Hardware Setup', icon: 'fa-desktop' },
            { id: 'sys-config', label: 'System Health', subLabel: 'Database Indexes', icon: 'fa-heartbeat' }
        ];

        return (
            <div className="flex flex-col lg:flex-row gap-6 items-start">
                {/* Navigation Sidebar */}
                <div className="w-full lg:w-72 flex-shrink-0 sticky top-0">
                    <Card className="p-2">
                        <div className="px-4 py-3 border-b border-slate-700 mb-2">
                            <h3 className="text-sm font-bold text-slate-400 uppercase tracking-wider">Settings Menu</h3>
                        </div>
                        <nav className="space-y-1">
                            {tabs.map(tab => (
                                <button
                                    key={tab.id}
                                    onClick={() => setActiveTab(tab.id)}
                                    className={`w-full flex items-center px-4 py-3 rounded-lg transition-all duration-200 group text-left ${
                                        activeTab === tab.id 
                                            ? 'bg-blue-600 text-white shadow-lg shadow-blue-900/20' 
                                            : 'text-slate-400 hover:bg-slate-800 hover:text-slate-200'
                                    }`}
                                >
                                    <div className={`w-10 h-10 rounded-lg flex items-center justify-center mr-3 transition-colors shrink-0 ${
                                        activeTab === tab.id ? 'bg-white/20' : 'bg-slate-800 group-hover:bg-slate-700'
                                    }`}>
                                        <i className={`fas ${tab.icon} ${activeTab === tab.id ? 'text-white' : 'text-slate-400 group-hover:text-blue-400'}`}></i>
                                    </div>
                                    <div className="flex-1 min-w-0">
                                        <div className={`font-semibold text-sm truncate ${activeTab === tab.id ? 'text-white' : 'text-slate-200'}`}>
                                            {tab.label}
                                        </div>
                                        <div className={`text-xs truncate ${activeTab === tab.id ? 'text-blue-100' : 'text-slate-500'}`}>
                                            {tab.subLabel}
                                        </div>
                                    </div>
                                    {activeTab === tab.id && <i className="fas fa-chevron-right ml-2 text-xs opacity-70"></i>}
                                </button>
                            ))}
                        </nav>
                    </Card>
                </div>

                {/* Content Area */}
                <div className="flex-1 w-full min-w-0">
                    <div className="animate-fade-in-up">
                        {activeTab === 'general' && <GeneralSettings />}
                        {activeTab === 'users' && <UserManagement />}
                        {activeTab === 'shops' && <ShopManagement />}
                        {activeTab === 'devices' && <DeviceManagement />}
                        {activeTab === 'sys-config' && <SystemConfiguration />}
                    </div>
                </div>
            </div>
        );
    };

    // --- NEW: General Settings Component ---
    const GeneralSettings = () => {
        const { systemConfig } = useData();
        const [appName, setAppName] = useState('');
        const [loading, setLoading] = useState(false);
        const [modal, setModal] = useState({ type: null, data: null });

        useEffect(() => {
            if (systemConfig) {
                setAppName(systemConfig.appName || '');
            }
        }, [systemConfig]);

        const handleSave = async (e) => {
            e.preventDefault();
            setLoading(true);
            try {
                await db.collection('system').doc('config').set({
                    appName: appName
                }, { merge: true });
                
                document.title = appName; 
                setModal({ type: 'message', data: { title: 'Success', message: 'Application settings updated.' } });
            } catch (error) {
                console.error("Settings save error:", error);
                setModal({ type: 'message', data: { title: 'Error', message: 'Failed to save settings.', isError: true } });
            } finally {
                setLoading(false);
            }
        };

        return (
            <div className="max-w-2xl">
                <MessageModal {...modal.data} show={modal.type === 'message'} onClose={() => setModal({ type: null })} />
                <Card>
                    <h3 className="text-xl font-bold text-slate-200 mb-6">General Application Settings</h3>
                    <form onSubmit={handleSave} className="space-y-6">
                        {/* App Name Section */}
                        <div className="pb-6 border-b border-slate-700">
                            <label className="block text-sm font-medium text-slate-300 mb-2">
                                <i className="fas fa-font text-blue-400 mr-2"></i> Application Name
                            </label>
                            <input 
                                type="text" 
                                value={appName} 
                                onChange={(e) => setAppName(e.target.value)} 
                                className="w-full bg-slate-700 text-white px-4 py-3 rounded-lg border border-slate-600 focus:ring-2 focus:ring-blue-500 outline-none transition" 
                                placeholder="Enter App Name" 
                                required
                            />
                            <p className="text-xs text-slate-500 mt-2">
                                This name will appear on the Login screen, Sidebar, and Browser Tab.
                            </p>
                        </div>
                        
                        <div className="pt-4 border-t border-slate-700 flex justify-end">
                            <button 
                                type="submit" 
                                disabled={loading} 
                                className="bg-blue-600 text-white font-bold py-3 px-8 rounded-lg hover:bg-blue-700 transition flex items-center gap-2 disabled:bg-blue-800 disabled:cursor-not-allowed shadow-lg shadow-blue-900/20"
                            >
                                {loading ? <div className="loader w-4 h-4"></div> : <i className="fas fa-save"></i>}
                                Save Changes
                            </button>
                        </div>
                    </form>
                </Card>
            </div>
        );
    };

    // --- NEW: Device Management Component ---
    const DeviceManagement = () => {
        const { devices, shops, systemConfig, currentDeviceId, setLocalDevice } = useData();
        const [formData, setFormData] = useState({ name: '', shopId: '', code: '' });
        const [editId, setEditId] = useState(null);
        const [modal, setModal] = useState({ type: null, data: null });
        const [showDeviceModal, setShowDeviceModal] = useState(false);

        // Configuration State
        const [loyaltyRate, setLoyaltyRate] = useState(0);
        const [configLoading, setConfigLoading] = useState(false);

        useEffect(() => {
            if (systemConfig) {
                setLoyaltyRate(systemConfig.loyaltyRate || 0);
            }
        }, [systemConfig]);

        const handleSaveConfig = async (e) => {
            e.preventDefault();
            setConfigLoading(true);
            try {
                await db.collection('system').doc('config').set({
                    loyaltyRate: parseFloat(loyaltyRate)
                }, { merge: true });
                setModal({ type: 'message', data: { title: 'Success', message: 'Loyalty configuration saved.' } });
            } catch (error) {
                setModal({ type: 'message', data: { title: 'Error', message: 'Failed to save configuration.', isError: true } });
            } finally {
                setConfigLoading(false);
            }
        };

        const activeDevice = devices.find(d => d.id === currentDeviceId);
        const activeShopName = activeDevice ? shops.find(s => s.id === activeDevice.shopId)?.name : '';

        const resetForm = () => {
            setFormData({ name: '', shopId: '', code: '' });
            setEditId(null);
            setShowDeviceModal(false);
        };

        const handleAddNew = () => {
            resetForm();
            setShowDeviceModal(true);
        };

        const handleEdit = (dev) => {
            setFormData({ name: dev.name, shopId: dev.shopId, code: dev.code || '' });
            setEditId(dev.id);
            setShowDeviceModal(true);
        };

        const handleSubmit = async (e) => {
            e.preventDefault();
            try {
                if (editId) await db.collection('devices').doc(editId).update(formData);
                else await db.collection('devices').add(formData);
                setModal({ type: 'message', data: { title: 'Success', message: 'Device saved.' } });
                resetForm();
            } catch (err) {
                setModal({ type: 'message', data: { title: 'Error', message: 'Failed to save device.', isError: true } });
            }
        };

        const handleDelete = async (id) => {
            try {
                await db.collection('devices').doc(id).delete();
                setModal({ type: 'message', data: { title: 'Success', message: 'Device deleted.' } });
            } catch (err) {
                setModal({ type: 'message', data: { title: 'Error', message: 'Failed to delete device.', isError: true } });
            }
        };

        return (
            <div className="space-y-6">
                <MessageModal {...modal.data} show={modal.type === 'message'} onClose={() => setModal({ type: null })} />
                <ConfirmationModal title="Delete Device" message="Are you sure?" show={modal.type === 'confirmDelete'} onConfirm={() => {handleDelete(modal.data); setModal({type: null})}} onCancel={() => setModal({ type: null })} />

                {/* --- Configuration Section --- */}
                <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    
                    {/* 1. Device Identity Status */}
                    <Card className="flex flex-col h-full">
                        <h3 className="text-xl font-bold text-slate-200 mb-6 flex items-center gap-2">
                            <i className="fas fa-desktop text-cyan-400"></i> Terminal Identity
                        </h3>
                        <div className="flex-1 flex flex-col justify-center space-y-6">
                            <div className="bg-slate-900/50 p-4 rounded-lg border border-slate-700">
                                <p className="text-sm text-slate-400 mb-4">
                                    This setting links this specific browser/computer to a registered terminal for cash drawer tracking.
                                </p>
                                {currentDeviceId && activeDevice ? (
                                    <div className="bg-green-900/20 border border-green-500/30 rounded-lg p-4 flex justify-between items-center transition-all">
                                        <div>
                                            <h4 className="text-green-400 font-bold flex items-center gap-2 text-lg">
                                                <i className="fas fa-check-circle"></i> {activeDevice.name}
                                            </h4>
                                            <p className="text-sm text-green-300/70 mt-1">
                                                <i className="fas fa-store mr-1"></i> {activeShopName}
                                            </p>
                                        </div>
                                        <button 
                                            type="button"
                                            onClick={() => {
                                                if(confirm("Disconnect this terminal? You will need to re-initialize it to use POS.")) {
                                                    setLocalDevice('');
                                                }
                                            }}
                                            className="text-xs bg-slate-800 text-slate-300 hover:text-white px-4 py-2 rounded border border-slate-600 hover:bg-red-600 hover:border-red-500 transition shadow-sm"
                                        >
                                            Disconnect
                                        </button>
                                    </div>
                                ) : (
                                    <div className="space-y-3">
                                        <select 
                                            value={currentDeviceId} 
                                            onChange={(e) => setLocalDevice(e.target.value)} 
                                            className="w-full bg-slate-700 text-white px-4 py-3 rounded-lg border border-slate-600 focus:ring-2 focus:ring-cyan-500 outline-none transition cursor-pointer hover:bg-slate-650"
                                        >
                                            <option value="">-- Select Identity --</option>
                                            {devices.map(d => {
                                                const shopName = shops.find(s => s.id === d.shopId)?.name || 'Unknown Shop';
                                                return <option key={d.id} value={d.id}>{d.name} ({shopName})</option>;
                                            })}
                                        </select>
                                        <p className="text-xs text-slate-500 italic flex items-center gap-1">
                                            <i className="fas fa-info-circle"></i> Select from available devices below.
                                        </p>
                                    </div>
                                )}
                            </div>
                        </div>
                    </Card>

                    {/* 2. Loyalty Program Config */}
                    <Card className="flex flex-col h-full">
                        <form onSubmit={handleSaveConfig} className="flex flex-col h-full">
                            <h3 className="text-xl font-bold text-slate-200 mb-6 flex items-center gap-2">
                                <i className="fas fa-gift text-orange-400"></i> Loyalty Configuration
                            </h3>
                            
                            <div className="flex-1 space-y-6">
                                <div className="bg-slate-900/50 p-4 rounded-lg border border-slate-700 flex items-start gap-4">
                                    <div className="p-3 bg-orange-500/20 text-orange-400 rounded-lg shrink-0 mt-1">
                                        <i className="fas fa-percentage text-xl"></i>
                                    </div>
                                    <div className="flex-1">
                                        <label className="block text-sm font-medium text-slate-300 mb-2">
                                            Points Earning Rate
                                        </label>
                                        <div className="flex items-center shadow-sm">
                                            <input 
                                                type="number" 
                                                value={loyaltyRate} 
                                                onChange={(e) => setLoyaltyRate(e.target.value)} 
                                                className="w-full bg-slate-700 text-white px-4 py-3 rounded-l-lg border border-r-0 border-slate-600 focus:ring-2 focus:ring-orange-500 outline-none transition font-bold text-lg text-right" 
                                                placeholder="0" 
                                                step="0.01"
                                                min="0"
                                            />
                                            <div className="bg-slate-600 px-4 py-3 rounded-r-lg border border-l-0 border-slate-600 text-slate-300 font-bold flex items-center justify-center">
                                                %
                                            </div>
                                        </div>
                                        <p className="text-xs text-slate-500 mt-2 leading-relaxed">
                                            Customers earn credit based on this percentage of the total receipt value.
                                        </p>
                                    </div>
                                </div>

                                {/* Calculation Example Box */}
                                <div className="bg-blue-900/10 border border-blue-500/20 rounded-lg p-4">
                                    <h5 className="text-xs font-bold text-blue-400 uppercase mb-2 tracking-wider">Example Calculation</h5>
                                    <div className="flex justify-between items-center text-sm text-slate-300 bg-slate-800/50 p-3 rounded">
                                        <div>
                                            <span className="block text-xs text-slate-500 uppercase">Total Sale</span>
                                            <span className="text-white font-bold text-base">100,000 </span>
                                        </div>
                                        <i className="fas fa-arrow-right text-slate-500 text-sm"></i>
                                        <div className="text-right">
                                            <span className="block text-xs text-slate-500 uppercase">Customer Earns</span>
                                            <span className="text-orange-400 font-bold text-xl">
                                                {new Intl.NumberFormat('en-US').format(100000 * ((parseFloat(loyaltyRate)||0)/100))} 
                                            </span>
                                            <span className="text-[10px] text-green-400 block">(Redeemable Value)</span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div className="mt-6 pt-4 border-t border-slate-700 flex justify-end">
                                <button 
                                    type="submit" 
                                    disabled={configLoading} 
                                    className="bg-orange-600 hover:bg-orange-700 text-white font-bold py-2 px-6 rounded-lg transition flex items-center gap-2 shadow-lg shadow-orange-900/20 disabled:opacity-50 disabled:cursor-not-allowed"
                                >
                                    {configLoading ? <div className="loader w-4 h-4"></div> : <i className="fas fa-save"></i>}
                                    Save Configuration
                                </button>
                            </div>
                        </form>
                    </Card>
                </div>

                {/* Device Form Modal */}
                {showDeviceModal && (
                    <Modal show={true} onClose={resetForm} maxWidth="max-w-md">
                        <ModalHeader title={editId ? "Edit Device" : "Add New POS Device"} onClose={resetForm} />
                        <form onSubmit={handleSubmit} className="flex flex-col h-full">
                            <ModalBody>
                                <div className="space-y-4 p-2">
                                    <div>
                                        <label className="block text-sm font-medium text-slate-300 mb-1">
                                            <i className="fas fa-desktop text-cyan-400 mr-2"></i>Device Name
                                        </label>
                                        <input type="text" value={formData.name} onChange={e => setFormData({...formData, name: e.target.value})} className="w-full bg-slate-700 text-white px-3 py-2 rounded-md border border-slate-600 focus:border-blue-500 outline-none" placeholder="e.g. Counter 1" required />
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium text-slate-300 mb-1">
                                            <i className="fas fa-store-alt text-orange-400 mr-2"></i>Assigned Shop
                                        </label>
                                        <select value={formData.shopId} onChange={e => setFormData({...formData, shopId: e.target.value})} className="w-full bg-slate-700 text-white px-3 py-2 rounded-md border border-slate-600 focus:border-blue-500 outline-none" required>
                                            <option value="">Select Shop</option>
                                            {shops.map(s => <option key={s.id} value={s.id}>{s.name}</option>)}
                                        </select>
                                    </div>
                                </div>
                            </ModalBody>
                            <ModalFooter>
                                <button type="button" onClick={resetForm} className="bg-slate-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-slate-500 transition">Cancel</button>
                                <button type="submit" className="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 transition shadow-lg shadow-blue-500/20">{editId ? 'Update' : 'Add Device'}</button>
                            </ModalFooter>
                        </form>
                    </Modal>
                )}

                <TableCard title="Registered Devices">
                    <div className="mb-4 pb-4 border-b border-slate-700 flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                        <p className="text-sm text-slate-400">Manage POS terminals and link them to shops.</p>
                        <button onClick={handleAddNew} className="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition flex items-center gap-2 shrink-0">
                            <i className="fas fa-plus"></i> Add New Device
                        </button>
                    </div>
                    
                    <table className="min-w-full divide-y divide-slate-700">
                        <thead className="bg-slate-900/50">
                            <tr>
                                <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Device Name</th>
                                <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Shop</th>
                                <th className="px-4 py-3 text-center text-xs font-semibold text-slate-400 uppercase">Actions</th>
                            </tr>
                        </thead>
                        <tbody className="divide-y divide-slate-700">
                            {devices && devices.map(dev => (
                                <tr key={dev.id} className="hover:bg-slate-700/50">
                                    <td className="px-4 py-3 text-sm text-slate-200 font-bold">{dev.name}</td>
                                    <td className="px-4 py-3 text-sm text-slate-400">{shops.find(s => s.id === dev.shopId)?.name || 'Unknown'}</td>
                                    <td className="px-4 py-3 text-center space-x-4">
                                        <button onClick={() => handleEdit(dev)} className="text-blue-400 hover:text-blue-300"><i className="fas fa-edit"></i></button>
                                        <button onClick={() => setModal({ type: 'confirmDelete', data: dev.id })} className="text-red-500 hover:text-red-400"><i className="fas fa-trash"></i></button>
                                    </td>
                                </tr>
                            ))}
                            {(!devices || devices.length === 0) && (
                                <tr>
                                    <td colSpan="3" className="px-4 py-8 text-center text-slate-500">No devices found. Add one to get started.</td>
                                </tr>
                            )}
                        </tbody>
                    </table>
                </TableCard>
            </div>
        );
    };

    // --- NEW: System Configuration Component ---
    const SystemConfiguration = () => {
        const [checks, setChecks] = useState([
            { 
                id: 1, 
                name: 'Sales History', 
                description: 'Required for POS "History" tab to show latest sales for a specific shop.',
                collection: 'sales',
                status: 'pending', // pending, active, missing
                link: null,
                runCheck: async () => {
                    // Query: where shopId == 'x', orderBy timestamp desc
                    return db.collection('sales').where('shopId', '==', 'test_check').orderBy('timestamp', 'desc').limit(1).get();
                }
            },
            { 
                id: 2, 
                name: 'Sale Report (Date Range)', 
                description: 'Required for "Sale Report" to filter sales by Shop AND Date range.',
                collection: 'sales',
                status: 'pending',
                link: null,
                runCheck: async () => {
                    // Query: where shopId == 'x', where timestamp >= date
                    const d = new Date();
                    return db.collection('sales').where('shopId', '==', 'test_check').where('timestamp', '>=', d).limit(1).get();
                }
            },
            { 
                id: 3, 
                name: 'Shift Report', 
                description: 'Required for "Shift Report" to filter shifts by Shop AND Start Time.',
                collection: 'shifts',
                status: 'pending',
                link: null,
                runCheck: async () => {
                    // Query: where shopId == 'x', where startTime >= date
                    const d = new Date();
                    return db.collection('shifts').where('shopId', '==', 'test_check').where('startTime', '>=', d).limit(1).get();
                }
            },
            {
                id: 4,
                name: 'Cost History',
                description: 'Required to sort Cost History by date for a product.',
                collection: 'costHistory',
                status: 'pending',
                link: null,
                runCheck: async () => {
                    // Query: where productId == 'x', orderBy updatedAt desc (Usually single field index works, but composite might be needed if strictly ordered)
                    return db.collection('costHistory').where('productId', '==', 'test_check').orderBy('updatedAt', 'desc').limit(1).get();
                }
            }
        ]);

        const handleCheck = async (id) => {
            const checkItem = checks.find(c => c.id === id);
            if (!checkItem) return;

            setChecks(prev => prev.map(c => c.id === id ? { ...c, status: 'checking' } : c));

            try {
                await checkItem.runCheck();
                // If successful
                setChecks(prev => prev.map(c => c.id === id ? { ...c, status: 'active', link: null } : c));
            } catch (error) {
                console.error("Index Check Error:", error);
                // Check if it's a missing index error
                if (error.code === 'failed-precondition' && error.message.includes('index')) {
                    // Extract the URL from the error message
                    // The error message text usually contains the URL: "The query requires an index. You can create it here: https://..."
                    const match = error.message.match(/https:\/\/console\.firebase\.google\.com[^\s]*/);
                    const link = match ? match[0] : null;
                    
                    setChecks(prev => prev.map(c => c.id === id ? { ...c, status: 'missing', link: link } : c));
                } else {
                    // Other error (permission etc)
                    setChecks(prev => prev.map(c => c.id === id ? { ...c, status: 'error', link: null } : c));
                }
            }
        };

        const handleCheckAll = () => {
            checks.forEach(c => handleCheck(c.id));
        };

        return (
            <div className="space-y-6">
                <Card>
                    <div className="flex justify-between items-center mb-6">
                        <div>
                            <h3 className="text-xl font-bold text-slate-100">
                                <i className="fas fa-database text-purple-400 mr-2"></i>Database Index Optimization
                            </h3>
                            <p className="text-slate-400 text-sm mt-1">
                                Complex queries in POS and Reports require "Composite Indexes" in Firestore. 
                                Run the check below to verify if they exist.
                            </p>
                        </div>
                        <button onClick={handleCheckAll} className="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-lg transition">
                            <i className="fas fa-stethoscope mr-2"></i> Check All
                        </button>
                    </div>

                    <div className="overflow-hidden rounded-lg border border-slate-700">
                        <table className="min-w-full divide-y divide-slate-700">
                            <thead className="bg-slate-900/50">
                                <tr>
                                    <th className="px-6 py-4 text-left text-xs font-semibold text-slate-400 uppercase">
                                        <i className="fas fa-cube text-blue-400 mr-2"></i>Feature Name
                                    </th>
                                    <th className="px-6 py-4 text-left text-xs font-semibold text-slate-400 uppercase">
                                        <i className="fas fa-folder-open text-orange-400 mr-2"></i>Collection
                                    </th>
                                    <th className="px-6 py-4 text-center text-xs font-semibold text-slate-400 uppercase">
                                        <i className="fas fa-signal text-emerald-400 mr-2"></i>Status
                                    </th>
                                    <th className="px-6 py-4 text-right text-xs font-semibold text-slate-400 uppercase">
                                        <i className="fas fa-bolt text-yellow-400 mr-2"></i>Action
                                    </th>
                                </tr>
                            </thead>
                            <tbody className="divide-y divide-slate-700 bg-slate-800/30">
                                {checks.map(check => (
                                    <tr key={check.id} className="hover:bg-slate-700/30 transition">
                                        <td className="px-6 py-4">
                                            <div className="text-sm font-medium text-slate-200">{check.name}</div>
                                            <div className="text-xs text-slate-500 mt-1">{check.description}</div>
                                        </td>
                                        <td className="px-6 py-4 text-sm text-slate-400 font-mono">
                                            {check.collection}
                                        </td>
                                        <td className="px-6 py-4 text-center">
                                            {check.status === 'pending' && <span className="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-slate-700 text-slate-300">Not Checked</span>}
                                            {check.status === 'checking' && <span className="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-900/50 text-blue-300"><div className="loader w-3 h-3 border-2 mr-2"></div> Checking...</span>}
                                            {check.status === 'active' && <span className="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-900/50 text-green-400"><i className="fas fa-check-circle mr-1"></i> Active</span>}
                                            {check.status === 'missing' && <span className="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-900/50 text-red-400"><i className="fas fa-exclamation-triangle mr-1"></i> Missing Index</span>}
                                            {check.status === 'error' && <span className="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-yellow-900/50 text-yellow-400">Error</span>}
                                        </td>
                                        <td className="px-6 py-4 text-right">
                                            {check.status === 'missing' && check.link ? (
                                                <a 
                                                    href={check.link} 
                                                    target="_blank" 
                                                    rel="noopener noreferrer"
                                                    className="inline-flex items-center px-3 py-2 border border-transparent text-sm leading-4 font-medium rounded-md text-white bg-red-600 hover:bg-red-700 focus:outline-none shadow-lg shadow-red-500/30"
                                                >
                                                    <i className="fas fa-plus mr-2"></i> Create Index
                                                </a>
                                            ) : (
                                                <button 
                                                    onClick={() => handleCheck(check.id)} 
                                                    disabled={check.status === 'checking'}
                                                    className="text-blue-400 hover:text-blue-300 font-medium text-sm disabled:opacity-50"
                                                >
                                                    {check.status === 'active' ? 'Re-Check' : 'Check Status'}
                                                </button>
                                            )}
                                        </td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                </Card>
            </div>
        );
    };

    // --- 8.9 Dashboard (Home Page) ---
    const HomePage = ({ setPage, userProfile }) => {
        const { allPOs, allTransfers, products, shops, isLoading } = useData();

        // --- KPI CALCULATIONS ---
        const stats = useMemo(() => {
            if (isLoading) return null;

            const assignedShops = userProfile.role === 'Admin' ? shops.map(s => s.id) : (userProfile.assignedShops || []);

            // 1. Pending Actions
            const pendingAuditPOs = allPOs.filter(po => 
                (po.status === 'submitted' || po.status === 'auditing') && 
                (userProfile.role === 'Admin' || assignedShops.includes(po.shopId))
            ).length;

            const incomingTransfers = allTransfers.filter(t => 
                t.status === 'active' && 
                assignedShops.includes(t.toShopId)
            ).length;

            const draftPOs = allPOs.filter(po => 
                po.status === 'draft' && 
                (userProfile.role === 'Admin' || po.createdBy === userProfile.uid)
            ).length;

            // 2. Financials (Current Month Spend)
            const now = new Date();
            const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
            const thisMonthPOs = allPOs.filter(po => {
                const date = safeToDate(po.requestDate);
                return date >= startOfMonth && (po.status === 'submitted' || po.status === 'audited');
            });
            const totalSpend = thisMonthPOs.reduce((sum, po) => sum + (po.status === 'audited' ? po.totalAuditedAmount : po.totalAmount), 0);

            // 3. Low Stock Alerts
            const lowStockItems = [];
            products.forEach(p => {
                const minStock = parseInt(p.minStock) || 0;
                if (minStock > 0) {
                    assignedShops.forEach(shopId => {
                        const currentStock = p.stockByShop?.[shopId] || 0;
                        if (currentStock < minStock) {
                            const shopName = shops.find(s => s.id === shopId)?.name || 'Unknown Shop';
                            lowStockItems.push({
                                ...p,
                                alertShopId: shopId,
                                alertShopName: shopName,
                                currentStock,
                                minStock
                            });
                        }
                    });
                }
            });

            // 4. Recent Activity Feed (New Phase 2 Feature)
            const activities = [];
            allPOs.forEach(po => {
                activities.push({
                    type: 'PO',
                    id: po.id,
                    reference: po.poNumber,
                    status: po.status,
                    date: po.updatedAt || po.createdAt,
                    description: `PO ${po.status} for ${po.shopName}`,
                    detail: po.vendorName,
                    amount: po.totalAuditedAmount || po.totalAmount,
                    rawPO: po // Store ref for clicking
                });
            });
            allTransfers.forEach(t => {
                activities.push({
                    type: 'Transfer',
                    id: t.id,
                    reference: t.transferNo,
                    status: t.status,
                    date: t.updatedAt || t.createdAt,
                    description: `Transfer ${t.status} to ${t.toShopName}`,
                    detail: `From: ${t.fromShopName}`,
                    amount: t.totalAmount,
                    rawTransfer: t // Store ref for clicking
                });
            });
            // Sort by date desc and take top 10
            const recentActivity = activities.sort((a, b) => safeToDate(b.date) - safeToDate(a.date)).slice(0, 10);

            // 5. Top Vendors by Spend (New Phase 2 Feature)
            const vendorSpend = {};
            let maxVendorSpend = 0;
            allPOs.forEach(po => {
                if (po.status === 'audited' || po.status === 'submitted') {
                    const amount = po.totalAuditedAmount || po.totalAmount || 0;
                    vendorSpend[po.vendorName] = (vendorSpend[po.vendorName] || 0) + amount;
                }
            });
            const topVendors = Object.entries(vendorSpend)
                .map(([name, amount]) => {
                    if (amount > maxVendorSpend) maxVendorSpend = amount;
                    return { name, amount };
                })
                .sort((a, b) => b.amount - a.amount)
                .slice(0, 5);

            return { pendingAuditPOs, incomingTransfers, draftPOs, totalSpend, lowStockItems, recentActivity, topVendors, maxVendorSpend };
        }, [allPOs, allTransfers, products, shops, userProfile, isLoading]);

        // --- Calculate Total Stock Value per Shop ---
        const shopInventoryStats = useMemo(() => {
            if (!products || !shops) return [];
            const managedShops = shops.filter(s => s.manageStock);
            
            const visibleShops = userProfile.role === 'Admin' 
                ? managedShops 
                : managedShops.filter(s => (userProfile.assignedShops || []).includes(s.id));

            const stats = visibleShops.map(shop => ({ id: shop.id, name: shop.name, count: 0, value: 0 }));
            const statsMap = {};
            stats.forEach((s, i) => statsMap[s.id] = i);

            products.forEach(p => {
                const cost = p.cost || 0;
                visibleShops.forEach(shop => {
                    const qty = p.stockByShop?.[shop.id] || 0;
                    if (qty > 0) {
                        const idx = statsMap[shop.id];
                        stats[idx].count += qty;
                        stats[idx].value += (qty * cost);
                    }
                });
            });
            return stats;
        }, [products, shops, userProfile]);

        const getStatusColor = (status) => {
            switch(status) {
                case 'draft': return 'text-yellow-400 bg-yellow-400/10';
                case 'submitted': return 'text-blue-400 bg-blue-400/10';
                case 'active': return 'text-blue-400 bg-blue-400/10';
                case 'auditing': return 'text-purple-400 bg-purple-400/10';
                case 'audited': return 'text-green-400 bg-green-400/10';
                case 'done': return 'text-green-400 bg-green-400/10';
                default: return 'text-slate-400 bg-slate-400/10';
            }
        };

        if (isLoading) return <div className="flex justify-center p-12"><div className="loader"></div></div>;

        return (
            <div className="space-y-6">
                {/* Welcome Section */}
                <div className="flex flex-col md:flex-row justify-end items-start md:items-center mb-6">
                    <div className="mt-4 md:mt-0 bg-slate-800 px-4 py-2 rounded-lg border border-slate-700 text-slate-300 text-sm">
                        <i className="far fa-calendar-alt mr-2"></i>
                        {new Date().toLocaleDateString(undefined, { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}
                    </div>
                </div>

                {/* KPI Cards */}
                <div className="grid grid-cols-2 lg:grid-cols-4 gap-3 md:gap-6">
                    <div onClick={() => setPage('po-center', { activeTab: 'auditing-po' })} className="bg-gradient-to-br from-indigo-600/20 to-indigo-900/20 border border-indigo-500/30 p-3 md:p-6 rounded-xl shadow-lg cursor-pointer hover:border-indigo-500/60 transition group">
                        <div className="flex justify-between items-start">
                            <div>
                                <p className="text-indigo-300 text-xs md:text-base font-medium mb-1">Pending Audits</p>
                                <h3 className="text-xl md:text-3xl font-bold text-white group-hover:scale-105 transition-transform">{stats.pendingAuditPOs}</h3>
                            </div>
                            <div className="bg-indigo-500/20 p-2 md:p-3 rounded-lg text-indigo-400 group-hover:bg-indigo-500 group-hover:text-white transition">
                                <i className="fas fa-clipboard-check text-lg md:text-xl"></i>
                            </div>
                        </div>
                        <p className="text-[10px] md:text-xs text-indigo-400/60 mt-2 md:mt-4">POs waiting approval</p>
                    </div>

                    <div onClick={() => setPage('inventory', { activeTab: 'active-transfer' })} className="bg-gradient-to-br from-blue-600/20 to-blue-900/20 border border-blue-500/30 p-3 md:p-6 rounded-xl shadow-lg cursor-pointer hover:border-blue-500/60 transition group">
                        <div className="flex justify-between items-start">
                            <div>
                                <p className="text-blue-300 text-xs md:text-base font-medium mb-1">Incoming Transfer</p>
                                <h3 className="text-xl md:text-3xl font-bold text-white group-hover:scale-105 transition-transform">{stats.incomingTransfers}</h3>
                            </div>
                            <div className="bg-blue-500/20 p-2 md:p-3 rounded-lg text-blue-400 group-hover:bg-blue-500 group-hover:text-white transition">
                                <i className="fas fa-truck-loading text-lg md:text-xl"></i>
                            </div>
                        </div>
                        <p className="text-[10px] md:text-xs text-blue-400/60 mt-2 md:mt-4">Stock arriving soon</p>
                    </div>

                    <div className="bg-gradient-to-br from-emerald-600/20 to-emerald-900/20 border border-emerald-500/30 p-3 md:p-6 rounded-xl shadow-lg">
                        <div className="flex justify-between items-start">
                            <div>
                                <p className="text-emerald-300 text-xs md:text-base font-medium mb-1">Month Spend</p>
                                <h3 className="text-lg md:text-2xl font-bold text-white">{(stats.totalSpend / 1000000).toFixed(2)}M</h3>
                            </div>
                            <div className="bg-emerald-500/20 p-2 md:p-3 rounded-lg text-emerald-400">
                                <i className="fas fa-coins text-lg md:text-xl"></i>
                            </div>
                        </div>
                        <p className="text-[10px] md:text-xs text-emerald-400/60 mt-2 md:mt-4">Est. Value (Millions)</p>
                    </div>

                    <div onClick={() => setPage('po-center', { activeTab: 'drafts-po' })} className="bg-gradient-to-br from-yellow-600/20 to-yellow-900/20 border border-yellow-500/30 p-3 md:p-6 rounded-xl shadow-lg cursor-pointer hover:border-yellow-500/60 transition group">
                        <div className="flex justify-between items-start">
                            <div>
                                <p className="text-yellow-300 text-xs md:text-base font-medium mb-1">Draft POs</p>
                                <h3 className="text-xl md:text-3xl font-bold text-white group-hover:scale-105 transition-transform">{stats.draftPOs}</h3>
                            </div>
                            <div className="bg-yellow-500/20 p-2 md:p-3 rounded-lg text-yellow-400 group-hover:bg-yellow-500 group-hover:text-white transition">
                                <i className="fas fa-pencil-alt text-lg md:text-xl"></i>
                            </div>
                        </div>
                        <p className="text-[10px] md:text-xs text-yellow-400/60 mt-2 md:mt-4">Work in progress</p>
                    </div>
                </div>

                {/* Inventory Value Summary Dashboard */}
                <h3 className="text-lg font-bold text-slate-200 mt-4 mb-2">Inventory Value by Shop</h3>
                <div className="grid grid-cols-2 lg:grid-cols-4 gap-3 md:gap-4">
                    {shopInventoryStats.map(stat => (
                        <div key={stat.id} className="bg-slate-800 p-3 md:p-4 rounded-lg border border-slate-700 shadow-lg hover:bg-slate-700 transition flex flex-col justify-between">
                            <div className="flex justify-between items-center mb-2">
                                <h5 className="text-slate-400 text-[10px] md:text-xs font-bold uppercase tracking-wider truncate mr-1" title={stat.name}>{stat.name}</h5>
                                <i className="fas fa-warehouse text-slate-600 text-xs opacity-50"></i>
                            </div>
                            
                            <div>
                                <div className="mb-2 md:mb-3">
                                    <p className="text-[10px] text-slate-500 uppercase mb-0.5">Total Cost Value</p>
                                    <div className="text-base md:text-lg lg:text-xl font-bold text-emerald-400 truncate" title={`${khrFormatter.format(stat.value)}`}>
                                        {khrFormatter.format(stat.value)}
                                    </div>
                                </div>
                                
                                <div className="flex justify-between items-center border-t border-slate-700 pt-2">
                                    <span className="text-[10px] text-slate-400 uppercase">Stock Units</span>
                                    <span className="text-xs md:text-sm font-semibold text-blue-300">{khrFormatter.format(stat.count)}</span>
                                </div>
                            </div>
                        </div>
                    ))}
                </div>

                <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    {/* Left Column (2/3 width) - Order 2 on Mobile, Order 1 on Desktop */}
                    <div className="lg:col-span-2 space-y-6 order-2 lg:order-1">
                        {/* Low Stock Alerts Table */}
                        <Card>
                            <div className="flex justify-between items-center mb-4">
                                <h3 className="text-lg font-bold text-slate-200 flex items-center gap-2">
                                    <i className="fas fa-exclamation-triangle text-red-500"></i> Low Stock Alerts
                                </h3>
                                <button onClick={() => setPage('product-data')} className="text-sm text-blue-400 hover:text-blue-300">View All</button>
                            </div>
                            
                            {stats.lowStockItems.length === 0 ? (
                                <div className="text-center py-8 text-slate-500">
                                    <i className="fas fa-check-circle text-4xl mb-3 text-green-500/50"></i>
                                    <p>Stock levels are healthy.</p>
                                </div>
                            ) : (
                                <div className="overflow-x-auto">
                                    <table className="min-w-full text-sm">
                                        <thead className="bg-slate-900/50 text-slate-400 uppercase text-xs">
                                            <tr>
                                                <th className="px-3 py-2 text-left">Product</th>
                                                <th className="px-3 py-2 text-left">Shop</th>
                                                <th className="px-3 py-2 text-center">Min</th>
                                                <th className="px-3 py-2 text-center">Current</th>
                                                <th className="px-3 py-2 text-right">Action</th>
                                            </tr>
                                        </thead>
                                        <tbody className="divide-y divide-slate-700">
                                            {stats.lowStockItems.slice(0, 5).map((item, idx) => (
                                                <tr key={`${item.id}-${idx}`} className="hover:bg-slate-700/30">
                                                    <td className="px-3 py-2">
                                                        <div className="font-medium text-slate-200">{item.name}</div>
                                                        <div className="text-xs text-slate-500">{item.code}</div>
                                                    </td>
                                                    <td className="px-3 py-2 text-slate-400">{item.alertShopName}</td>
                                                    <td className="px-3 py-2 text-center text-slate-400">{item.minStock}</td>
                                                    <td className="px-3 py-2 text-center font-bold text-red-400">{item.currentStock}</td>
                                                    <td className="px-3 py-2 text-right">
                                                        <button 
                                                            onClick={() => setPage('po-center', { activeTab: 'create-po' })}
                                                            className="text-xs bg-red-500/20 text-red-300 px-2 py-1 rounded hover:bg-red-500 hover:text-white transition"
                                                        >
                                                            Order
                                                        </button>
                                                    </td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                    {stats.lowStockItems.length > 5 && (
                                        <div className="text-center mt-3 text-xs text-slate-500">
                                            + {stats.lowStockItems.length - 5} more items below minimum stock
                                        </div>
                                    )}
                                </div>
                            )}
                        </Card>

                        {/* Recent Activity Feed (Phase 2) */}
                        <Card>
                            <h3 className="text-lg font-bold text-slate-200 mb-4 flex items-center gap-2">
                                <i className="fas fa-history text-slate-400"></i> Recent Activity
                            </h3>
                            <div className="space-y-0">
                                {stats.recentActivity.length === 0 ? (
                                    <p className="text-center text-slate-500 py-4">No recent activity found.</p>
                                ) : (
                                    stats.recentActivity.map((activity, idx) => (
                                        <div key={`${activity.type}-${activity.id}-${idx}`} className="flex items-start py-3 border-b border-slate-700 last:border-0 hover:bg-slate-700/30 px-2 rounded transition cursor-default">
                                            <div className={`mt-1 mr-3 w-8 h-8 rounded-full flex items-center justify-center flex-shrink-0 ${activity.type === 'PO' ? 'bg-purple-500/20 text-purple-400' : 'bg-blue-500/20 text-blue-400'}`}>
                                                <i className={`fas ${activity.type === 'PO' ? 'fa-file-invoice' : 'fa-exchange-alt'} text-sm`}></i>
                                            </div>
                                            <div className="flex-1 min-w-0">
                                                <div className="flex justify-between items-start">
                                                    <p className="text-sm font-medium text-slate-200 truncate pr-2">
                                                        {activity.description}
                                                    </p>
                                                    <span className={`text-[10px] px-2 py-0.5 rounded-full uppercase tracking-wider font-bold ${getStatusColor(activity.status)}`}>
                                                        {activity.status}
                                                    </span>
                                                </div>
                                                <p className="text-xs text-slate-400 mt-0.5">
                                                    {activity.detail} <span className="mx-1"></span> {formatDateDDMMYYYY(activity.date)}
                                                </p>
                                            </div>
                                            <div className="ml-3 text-right">
                                                <p className="text-sm font-bold text-slate-300">{khrFormatter.format(activity.amount)}</p>
                                                <button 
                                                    onClick={() => activity.type === 'PO' ? setPage('po-center', { activeTab: 'active-po' }) : setPage('inventory', { activeTab: 'transfer-report' })}
                                                    className="text-[10px] text-blue-400 hover:text-blue-300 mt-1"
                                                >
                                                    View
                                                </button>
                                            </div>
                                        </div>
                                    ))
                                )}
                            </div>
                        </Card>
                    </div>

                    {/* Right Column (1/3 width) - Order 1 on Mobile, Order 2 on Desktop */}
                    <div className="lg:col-span-1 space-y-6 order-1 lg:order-2">
                        {/* Quick Actions */}
                        <Card>
                            <h3 className="text-lg font-bold text-slate-200 mb-4">Quick Actions</h3>
                            <div className="space-y-3">
                                <button onClick={() => setPage('po-center', { activeTab: 'create-po' })} className="w-full bg-slate-700 hover:bg-blue-600 hover:text-white text-slate-300 p-3 rounded-lg flex items-center transition group">
                                    <div className="bg-slate-800 p-2 rounded mr-3 group-hover:bg-blue-500/20"><i className="fas fa-plus"></i></div>
                                    <div className="text-left">
                                        <div className="font-semibold">Create Purchase Order</div>
                                        <div className="text-xs opacity-70">Order new stock from vendors</div>
                                    </div>
                                </button>
                                <button onClick={() => setPage('inventory')} className="w-full bg-slate-700 hover:bg-cyan-600 hover:text-white text-slate-300 p-3 rounded-lg flex items-center transition group">
                                    <div className="bg-slate-800 p-2 rounded mr-3 group-hover:bg-cyan-500/20"><i className="fas fa-exchange-alt"></i></div>
                                    <div className="text-left">
                                        <div className="font-semibold">Internal Transfer</div>
                                        <div className="text-xs opacity-70">Move stock between shops</div>
                                    </div>
                                </button>
                                <button onClick={() => setPage('product-data')} className="w-full bg-slate-700 hover:bg-purple-600 hover:text-white text-slate-300 p-3 rounded-lg flex items-center transition group">
                                    <div className="bg-slate-800 p-2 rounded mr-3 group-hover:bg-purple-500/20"><i className="fas fa-box"></i></div>
                                    <div className="text-left">
                                        <div className="font-semibold">Manage Products</div>
                                        <div className="text-xs opacity-70">View items, adjust stock</div>
                                    </div>
                                </button>
                            </div>
                        </Card>

                        {/* Top Vendors (Phase 2) */}
                        <Card>
                            <h3 className="text-lg font-bold text-slate-200 mb-4 flex items-center gap-2">
                                <i className="fas fa-trophy text-yellow-500"></i> Top Vendors
                            </h3>
                            <div className="space-y-4">
                                {stats.topVendors.length === 0 ? (
                                    <p className="text-center text-slate-500 text-sm">No spend data available yet.</p>
                                ) : (
                                    stats.topVendors.map((vendor, idx) => (
                                        <div key={idx} className="relative">
                                            <div className="flex justify-between text-sm mb-1">
                                                <span className="text-slate-300 font-medium truncate w-2/3">{vendor.name}</span>
                                                <span className="text-emerald-400 font-bold">{khrFormatter.format(vendor.amount)}</span>
                                            </div>
                                            <div className="w-full bg-slate-700 rounded-full h-1.5">
                                                <div 
                                                    className="bg-emerald-500 h-1.5 rounded-full" 
                                                    style={{ width: `${(vendor.amount / stats.maxVendorSpend) * 100}%` }}
                                                ></div>
                                            </div>
                                        </div>
                                    ))
                                )}
                            </div>
                            <div className="mt-4 pt-4 border-t border-slate-700 text-center">
                                <button onClick={() => setPage('product-data', { activeTab: 'vendor-list' })} className="text-xs text-blue-400 hover:text-blue-300">
                                    Manage Vendors
                                </button>
                            </div>
                        </Card>
                    </div>
                </div>
            </div>
        );
    };

    const ShopManagement = () => {
        const { shops, loading } = useData();
        const initialFormState = { name: '', location: '', manageStock: true };
        const [formData, setFormData] = useState(initialFormState);
        const [editId, setEditId] = useState(null);
        const [modal, setModal] = useState({ type: null, data: null });
        const [searchTerm, setSearchTerm] = useState(''); // Added search state
        const [showShopModal, setShowShopModal] = useState(false); // NEW: State for Shop Modal
        
        const filteredShops = useMemo(() => {
            if (!searchTerm) return shops;
            const lower = searchTerm.toLowerCase();
            return shops.filter(s => s.name.toLowerCase().includes(lower) || (s.location && s.location.toLowerCase().includes(lower)));
        }, [shops, searchTerm]);
    
        const handleInputChange = (e) => {
            const { name, value, type, checked } = e.target;
            setFormData(prev => ({ ...prev, [name]: type === 'checkbox' ? checked : value }));
        };
    
        const resetForm = () => { setFormData(initialFormState); setEditId(null); setShowShopModal(false); };
        const handleEdit = (shop) => { setEditId(shop.id); setFormData({ ...initialFormState, ...shop }); setShowShopModal(true); };
        const handleAddNew = () => { setFormData(initialFormState); setEditId(null); setShowShopModal(true); };
    
        const handleDelete = async (id) => {
            try {
                await db.collection("shops").doc(id).delete();
                setModal({ type: 'message', data: { title: 'Success', message: 'Shop deleted.' } });
            } catch (error) {
                setModal({ type: 'message', data: { title: 'Error', message: 'Failed to delete shop.', isError: true } });
            }
        };
    
        const handleSubmit = async (e) => {
            e.preventDefault();
            try {
                if (editId) await db.collection("shops").doc(editId).update(formData);
                else await db.collection("shops").add(formData);
                setModal({ type: 'message', data: { title: 'Success', message: `Shop ${editId ? 'updated' : 'added'}.` } });
                resetForm(); // This will close the modal
            } catch (error) {
                setModal({ type: 'message', data: { title: 'Error', message: 'Failed to save shop.', isError: true } });
            }
        };
    
        return (
            <div className="space-y-6">
                <MessageModal {...modal.data} show={modal.type === 'message'} onClose={() => setModal({ type: null })} />
                <ConfirmationModal title="Delete Shop" message="Are you sure?" show={modal.type === 'confirmDelete'} onConfirm={() => {handleDelete(modal.data); setModal({type: null})}} onCancel={() => setModal({ type: null })} />

                {/* NEW: Shop Form Modal */}
                {showShopModal && (
                    <Modal show={true} onClose={resetForm} maxWidth="max-w-2xl">
                        <ModalHeader title={editId ? "Edit Shop" : "Add New Shop"} onClose={resetForm} />
                        <form onSubmit={handleSubmit} className="flex flex-col h-full">
                            <ModalBody>
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-6 items-start p-2">
                                    <div>
                                        <label className="block text-sm font-medium text-slate-300 mb-1">
                                            <i className="fas fa-store text-orange-400 mr-2"></i>Shop Name
                                        </label>
                                        <input type="text" name="name" placeholder="e.g. Main Branch" value={formData.name} onChange={handleInputChange} className="w-full bg-slate-700 text-slate-100 px-3 py-2 border border-slate-600 rounded-md focus:ring-2 focus:ring-blue-500 outline-none transition" required />
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium text-slate-300 mb-1">
                                            <i className="fas fa-map-marker-alt text-emerald-400 mr-2"></i>Location
                                        </label>
                                        <input type="text" name="location" placeholder="e.g. City Center" value={formData.location} onChange={handleInputChange} className="w-full bg-slate-700 text-slate-100 px-3 py-2 border border-slate-600 rounded-md focus:ring-2 focus:ring-blue-500 outline-none transition" />
                                    </div>
                                    <div className="md:col-span-2 flex items-center bg-slate-800/50 p-4 rounded-lg border border-slate-700">
                                        <input type="checkbox" name="manageStock" id="manageStock" checked={formData.manageStock} onChange={handleInputChange} className="h-5 w-5 text-blue-500 bg-slate-600 border-slate-500 rounded mr-3 cursor-pointer" />
                                        <label htmlFor="manageStock" className="text-sm font-medium text-slate-300 cursor-pointer flex items-center">
                                            <i className="fas fa-boxes text-blue-400 mr-2 text-lg"></i>
                                            This shop manages its own stock levels (Inventory Tracking)
                                        </label>
                                    </div>
                                </div>
                            </ModalBody>
                            <ModalFooter>
                                <button type="button" onClick={resetForm} className="bg-slate-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-slate-500 transition">Cancel</button>
                                <button type="submit" className={`${editId ? 'bg-green-600 hover:bg-green-700' : 'bg-blue-600 hover:bg-blue-700'} text-white font-bold py-2 px-6 rounded-lg transition shadow-lg`}>
                                    {editId ? 'Update Shop' : 'Add Shop'}
                                </button>
                            </ModalFooter>
                        </form>
                    </Modal>
                )}

                <TableCard title="Shop Management">
                    <div className="mb-4 pb-4 border-b border-slate-700 flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                        <div className="flex-1 w-full max-w-sm">
                            <label className="block text-sm font-medium text-slate-300 mb-1">
                                <i className="fas fa-search text-purple-400 mr-2"></i>Search Shop
                            </label>
                            <div className="relative">
                                <input 
                                    type="text" 
                                    placeholder="Search by name or location..." 
                                    value={searchTerm} 
                                    onChange={(e) => setSearchTerm(e.target.value)} 
                                    className="w-full bg-slate-700 text-slate-100 px-3 py-2 pl-10 border border-slate-600 rounded-md focus:ring-2 focus:ring-blue-500 outline-none"
                                />
                                <i className="fas fa-search absolute left-3 top-3 text-slate-400"></i>
                            </div>
                        </div>
                        <button onClick={handleAddNew} className="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition flex items-center gap-2 shrink-0">
                            <i className="fas fa-plus"></i> Add New Shop
                        </button>
                    </div>
                    {loading ? <p className="text-center p-4">Loading...</p> : filteredShops.length === 0 ? <p className="text-center p-4 text-slate-400">No shops found.</p> : (
                        <table className="min-w-full divide-y divide-slate-700">
                            <thead className="bg-slate-900/50">
                                <tr>
                                    <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Name</th>
                                    <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Location</th>
                                    <th className="px-4 py-3 text-center text-xs font-semibold text-slate-400 uppercase">Manages Stock</th>
                                    <th className="px-4 py-3 text-center text-xs font-semibold text-slate-400 uppercase">Actions</th>
                                </tr>
                            </thead>
                            <tbody className="divide-y divide-slate-700">
                                {filteredShops.map(shop => (
                                    <tr key={shop.id} className="hover:bg-slate-700/50">
                                        <td className="px-4 py-3 text-sm text-slate-200">{shop.name}</td>
                                        <td className="px-4 py-3 text-sm text-slate-400">{shop.location || '-'}</td>
                                        <td className="px-4 py-3 text-sm text-center">{shop.manageStock ? <i className="fas fa-check-circle text-green-500"></i> : <i className="fas fa-times-circle text-slate-500"></i>}</td>
                                        <td className="px-4 py-3 text-center space-x-4">
                                            <button onClick={() => handleEdit(shop)} className="text-blue-400 hover:text-blue-300"><i className="fas fa-edit"></i></button>
                                            <button onClick={() => setModal({ type: 'confirmDelete', data: shop.id })} className="text-red-500 hover:text-red-400"><i className="fas fa-trash"></i></button>
                                        </td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    )}
                </TableCard>
            </div>
        );
    };

    const UserManagement = () => {
        const { shops, users, usersLoading: loading } = useData();
        const initialFormState = { name: '', email: '', role: 'Staff', uid: '', assignedShops: [], permissions: [] };
        const [formData, setFormData] = useState(initialFormState);
        const [editId, setEditId] = useState(null);
        const [modal, setModal] = useState({ type: null, data: null });
        const [showUserModal, setShowUserModal] = useState(false); // NEW: State for User Modal

        // Updated permissions list
        const permissionOptions = ['pos-terminal', 'sales-report', 'customer-management', 'inventory', 'settings'];

        const handleInputChange = (e) => setFormData(prev => ({ ...prev, [e.target.name]: e.target.value }));
        const handleCheckboxChange = (e, field) => {
            const { value, checked } = e.target;
            setFormData(prev => ({ ...prev, [field]: checked ? [...(prev[field] || []), value] : (prev[field] || []).filter(item => item !== value) }));
        };

        const resetForm = () => { setFormData(initialFormState); setEditId(null); setShowUserModal(false); };
        const handleEdit = (user) => { setEditId(user.id); setFormData({ ...initialFormState, ...user }); setShowUserModal(true); };
        const handleAddNew = () => { setFormData(initialFormState); setEditId(null); setShowUserModal(true); };

        const handleDelete = async (id) => {
            try {
                await db.collection("users").doc(id).delete();
                setModal({ type: 'message', data: { title: 'Success', message: 'User deleted.' } });
            } catch (error) {
                setModal({ type: 'message', data: { title: 'Error', message: 'Failed to delete user.', isError: true } });
            }
        };

        const handleSubmit = async (e) => {
            e.preventDefault();
            if (!formData.name || !formData.email) {
                setModal({ type: 'message', data: { title: 'Validation Error', message: 'Name and Email are required.', isError: true } });
                return;
            }
            try {
                if (editId) await db.collection("users").doc(editId).update(formData);
                else await db.collection("users").add(formData);
                setModal({ type: 'message', data: { title: 'Success', message: `User ${editId ? 'updated' : 'added'}.` } });
                resetForm(); // This will also close the modal
            } catch (error) {
                setModal({ type: 'message', data: { title: 'Error', message: 'Failed to save user.', isError: true } });
            }
        };

        return (
            <div className="space-y-6">
                <MessageModal {...modal.data} show={modal.type === 'message'} onClose={() => setModal({ type: null })} />
                <ConfirmationModal title="Delete User" message="Are you sure?" show={modal.type === 'confirmDelete'} onConfirm={() => {handleDelete(modal.data); setModal({type: null})}} onCancel={() => setModal({ type: null })} />

                {/* NEW: User Form Modal */}
                {showUserModal && (
                    <Modal show={true} onClose={resetForm} maxWidth="max-w-3xl">
                        <ModalHeader title={editId ? "Edit User" : "Add New User"} onClose={resetForm} />
                        <form onSubmit={handleSubmit} className="flex flex-col h-full">
                            <ModalBody>
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-6 p-2">
                                    <div>
                                        <label className="block text-sm font-medium text-slate-300 mb-1">
                                            <i className="fas fa-user text-blue-400 mr-2"></i>Name
                                        </label>
                                        <input type="text" name="name" value={formData.name} onChange={handleInputChange} className="w-full bg-slate-700 text-slate-100 px-3 py-2 border border-slate-600 rounded-md focus:border-blue-500 focus:ring-2 outline-none" required />
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium text-slate-300 mb-1">
                                            <i className="fas fa-envelope text-orange-400 mr-2"></i>Email
                                        </label>
                                        <input type="email" name="email" value={formData.email} onChange={handleInputChange} className="w-full bg-slate-700 text-slate-100 px-3 py-2 border border-slate-600 rounded-md focus:border-blue-500 focus:ring-2 outline-none" required />
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium text-slate-300 mb-1">
                                            <i className="fas fa-user-tag text-purple-400 mr-2"></i>Role
                                        </label>
                                        <select name="role" value={formData.role} onChange={handleInputChange} className="w-full bg-slate-700 text-slate-100 px-3 py-2 border border-slate-600 rounded-md h-[42px] focus:border-blue-500 focus:ring-2 outline-none">
                                            <option>Admin</option><option>Shop Manager</option><option>Staff</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium text-slate-300 mb-1">
                                            <i className="fas fa-id-card text-emerald-400 mr-2"></i>Linked Auth UID
                                        </label>
                                        <input type="text" name="uid" value={formData.uid} onChange={handleInputChange} className="w-full bg-slate-700 text-slate-100 px-3 py-2 border border-slate-600 rounded-md focus:border-blue-500 focus:ring-2 outline-none" placeholder="Firebase Auth UID" />
                                    </div>
                                    <div className="md:col-span-2">
                                        <label className="block text-sm font-medium text-slate-300 mb-2">
                                            <i className="fas fa-store text-yellow-400 mr-2"></i>Assigned Shops
                                        </label>
                                        <div className="space-y-2 p-4 border border-slate-700 rounded-md max-h-32 overflow-y-auto bg-slate-900/50">
                                            {shops.map(shop => (
                                                <label key={shop.id} className="flex items-center text-slate-300 hover:text-white cursor-pointer">
                                                    <input type="checkbox" value={shop.id} checked={formData.assignedShops.includes(shop.id)} onChange={e => handleCheckboxChange(e, 'assignedShops')} className="h-4 w-4 text-blue-500 bg-slate-600 border-slate-500 rounded mr-3" />
                                                    {shop.name}
                                                </label>
                                            ))}
                                        </div>
                                    </div>
                                    <div className="md:col-span-2">
                                        <label className="block text-sm font-medium text-slate-300 mb-2">
                                            <i className="fas fa-key text-red-400 mr-2"></i>Page Permissions
                                        </label>
                                        <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-2 p-4 border border-slate-700 rounded-md max-h-48 overflow-y-auto bg-slate-900/50">
                                            {permissionOptions.map(p => (
                                                <label key={p} className="flex items-center text-slate-300 hover:text-white cursor-pointer">
                                                    <input type="checkbox" value={p} checked={formData.permissions.includes(p)} onChange={e => handleCheckboxChange(e, 'permissions')} className="h-4 w-4 text-blue-500 bg-slate-600 border-slate-500 rounded mr-3" />
                                                    <span className="truncate">{p.split('-').map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' ')}</span>
                                                </label>
                                            ))}
                                        </div>
                                    </div>
                                </div>
                            </ModalBody>
                            <ModalFooter>
                                <button type="button" onClick={resetForm} className="bg-slate-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-slate-500 transition">Cancel</button>
                                <button type="submit" className={`${editId ? 'bg-green-600 hover:bg-green-700' : 'bg-blue-600 hover:bg-blue-700'} text-white font-bold py-2 px-6 rounded-lg transition`}>
                                    {editId ? 'Update User' : 'Add User'}
                                </button>
                            </ModalFooter>
                        </form>
                    </Modal>
                )}

                <TableCard title="User Management">
                    <div className="mb-4 pb-4 border-b border-slate-700 flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                        <p className="text-sm text-slate-400">Manage application users, roles, and permissions.</p>
                        <button onClick={handleAddNew} className="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition flex items-center gap-2 shrink-0">
                            <i className="fas fa-user-plus"></i> Add New User
                        </button>
                    </div>
                    {loading ? <p className="text-center p-4">Loading...</p> : users.length === 0 ? <p className="text-center p-4">No users found.</p> : (
                        <table className="min-w-full divide-y divide-slate-700">
                            <thead className="bg-slate-900/50">
                                <tr>
                                    <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Name</th>
                                    <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Role</th>
                                    <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Email</th>
                                    <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">UID</th>
                                    <th className="px-4 py-3 text-center text-xs font-semibold text-slate-400 uppercase">Actions</th>
                                </tr>
                            </thead>
                            <tbody className="divide-y divide-slate-700">
                                {users.map(user => (
                                    <tr key={user.id} className="hover:bg-slate-700/50">
                                        <td className="px-4 py-3 text-sm text-slate-200">{user.name}</td>
                                        <td className="px-4 py-3 text-sm text-slate-400">{user.role}</td>
                                        <td className="px-4 py-3 text-sm text-slate-400">{user.email}</td>
                                        <td className="px-4 py-3 text-sm text-slate-400 truncate" style={{maxWidth: '150px'}} title={user.uid}>{user.uid || 'N/A'}</td>
                                        <td className="px-4 py-3 text-center space-x-4">
                                            <button onClick={() => handleEdit(user)} className="text-blue-400 hover:text-blue-300"><i className="fas fa-edit"></i></button>
                                            <button onClick={() => setModal({ type: 'confirmDelete', data: user.id })} className="text-red-500 hover:text-red-400"><i className="fas fa-trash"></i></button>
                                        </td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    )}
                </TableCard>
            </div>
        );
    };

    // --- 8.9 Dashboard (Layout) COMPONENT ---

    const Dashboard = ({ userProfile }) => {
        const [isSidebarOpen, setSidebarOpen] = useState(false);
        const [activePage, setActivePage] = useState(null);
        const [pageData, setPageData] = useState(null);
        const { backgroundFetchInitiated, backgroundLoadComplete, systemConfig } = useData(); // Get config

        // --- NEW: Update Document Title on Dashboard Load ---
        useEffect(() => {
            if (systemConfig?.appName) {
                document.title = systemConfig.appName;
            }
        }, [systemConfig]);

        useEffect(() => {
            const permissions = userProfile?.permissions || [];
            // Set default page: POS Terminal if allowed/assigned, otherwise first allowed page
            if (userProfile.role === 'Admin' || (userProfile.assignedShops && userProfile.assignedShops.length > 0) || permissions.includes('pos-terminal')) {
                setActivePage('pos-terminal');
            } else {
                setActivePage(permissions[0] || null);
            }
        }, [userProfile]);

        const toggleSidebar = () => setSidebarOpen(!isSidebarOpen);
        
        const setPage = useCallback((page, data = null) => {
            setActivePage(page);
            setPageData(data);
            if (window.innerWidth < 768 && isSidebarOpen) toggleSidebar();
        }, [isSidebarOpen]);

        const pageTitles = {
            'pos-terminal': 'POS Terminal',
            'sales-report': 'Sale Report',
            'customer-management': 'Customer Management',
            'inventory': 'Inventory', 
            'settings': 'Settings',
            'po-audit': 'Audit Purchase Order'
        };

        const renderActivePage = () => {
            if (!activePage) return <Card><div className="text-center p-8"><i className="fas fa-exclamation-triangle text-5xl text-red-400 mb-4"></i><h3 className="text-3xl font-bold">No Pages Assigned</h3><p className="text-slate-400 mt-2">Contact an administrator for access.</p></div></Card>;
            
            // Basic permission check
            const hasPermission = (userProfile.role === 'Admin') || 
                                  (activePage === 'pos-terminal' && userProfile.assignedShops?.length > 0) ||
                                  (activePage === 'po-audit' && userProfile.permissions?.includes('po-center')) || 
                                  // Backward compatibility mappings
                                  (activePage === 'inventory' && (userProfile.permissions?.includes('inventory') || userProfile.permissions?.includes('po-center') || userProfile.permissions?.includes('product-data'))) ||
                                  userProfile.permissions?.includes(activePage);

            if (!hasPermission) return <Card><div className="text-center p-8"><i className="fas fa-lock text-5xl text-yellow-400 mb-4"></i><h3 className="text-3xl font-bold">No Access</h3><p className="text-slate-400 mt-2">You do not have permission to view this page.</p></div></Card>;
            
            switch (activePage) {
                case 'pos-terminal': return <POSTerminal userProfile={userProfile} />;
                case 'sales-report': return <SaleReportPage userProfile={userProfile} />;
                case 'customer-management': return <CustomerManagement />;
                case 'inventory': return <InventoryPage setPage={setPage} userProfile={userProfile} pageData={pageData} />; 
                case 'settings': return <SettingsPage />;
                case 'po-audit': return <POAuditPage poDataToAudit={pageData} setPage={setPage} userProfile={userProfile} />;
                default: return <Card><div className="text-center p-8"><i className="fas fa-exclamation-triangle text-5xl text-red-400 mb-4"></i><h3 className="text-3xl font-bold">Page Not Found</h3></div></Card>;
            }
        };

        return (
            <div className="flex h-screen bg-slate-900 text-slate-300">
                <Sidebar activePage={activePage} setActivePage={setPage} userProfile={userProfile} isSidebarOpen={isSidebarOpen} toggleSidebar={toggleSidebar} />
                {isSidebarOpen && <div onClick={toggleSidebar} className="fixed inset-0 bg-black opacity-50 z-30 md:hidden"></div>}
                
                <div className="flex-1 flex flex-col overflow-hidden">
                    <Header pageTitle={pageTitles[activePage] || ''} userProfile={userProfile} toggleSidebar={toggleSidebar} />
                    <main className="flex-1 overflow-x-hidden overflow-y-auto bg-slate-800 p-4 sm:p-6">
                        <SearchProvider>
                            {renderActivePage()}
                        </SearchProvider>
                    </main>
                    {backgroundFetchInitiated && <LoadingStatusToast isComplete={backgroundLoadComplete} />}
                </div>
            </div>
        );
    };

    // --- 10. ROOT APP COMPONENT ---

    function App() {
        const [authState, setAuthState] = useState({ loading: true, userProfile: null });

        useEffect(() => {
            const unsubscribe = auth.onAuthStateChanged(async (firebaseUser) => {
                if (firebaseUser) {
                    try {
                        const querySnapshot = await db.collection("users").where("uid", "==", firebaseUser.uid).get();
                        if (!querySnapshot.empty) {
                            const userDoc = querySnapshot.docs[0];
                            setAuthState({ loading: false, userProfile: { id: userDoc.id, ...userDoc.data() } });
                        } else {
                            await auth.signOut();
                        }
                    } catch (error) {
                        await auth.signOut();
                    }
                } else {
                    setAuthState({ loading: false, userProfile: null });
                }
            });
            return () => unsubscribe();
        }, []);

        if (authState.loading) {
            return (
                <div className="flex items-center justify-center h-screen bg-slate-900">
                    <div className="text-center">
                        <i className="fas fa-spinner fa-spin text-5xl text-blue-500 mb-4"></i>
                        <h3 className="text-3xl font-bold text-slate-200">Authenticating...</h3>
                    </div>
                </div>
            );
        }

        return authState.userProfile ? (
            <DataProvider>
                <Dashboard userProfile={authState.userProfile} />
            </DataProvider>
        ) : <LoginPage />;
    }

    // --- 11. RENDER THE APP ---
    const container = document.getElementById('root');
    const root = ReactDOM.createRoot(container);
    root.render(<App />);

        </script>
    </body>
    </html>
