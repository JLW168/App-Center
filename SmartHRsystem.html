<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Smart HR Management System</title>
    
    <!-- External Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" xintegrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js" xintegrity="sha512-BNaRQnYJYiPSqHHDb58B0yaPfCu+Wgds8Gp/gU33kqBtgNS4tSPHuGibyoVBL5gI9kLmbG0C+wFjr8bCqwY2SA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <!-- Custom Styles & Fonts -->
    <style>
        @import url('https://rsms.me/inter/inter.css');
        html, body { 
            font-family: 'Inter', sans-serif;
            overflow-x: hidden; /* Prevents horizontal scrolling */
        }
        /* Base input styles for a consistent look */
        .input, .select {
            margin-top: 0.25rem; display: block; width: 100%; padding: 0.5rem 0.75rem;
            border-width: 1px; border-color: #475569; border-radius: 0.375rem;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); line-height: 1.5;
            background-color: #334155; color: #f1f5f9;
        }
        .input:focus, .select:focus {
            outline: 2px solid transparent; outline-offset: 2px;
            --tw-ring-color: #2563eb; border-color: #2563eb;
        }
        .input[disabled], .select[disabled] {
            background-color: #475569;
            cursor: not-allowed;
            opacity: 0.7;
        }
        input[type="checkbox"]:disabled {
            cursor: not-allowed;
            opacity: 0.5;
        }
    </style>
</head>
<body class="bg-slate-900 text-slate-300">
    <div id="root"></div>

    <!-- Firebase SDK Module -->
    <script type="module">
        // Firebase SDK imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, doc, addDoc, updateDoc, deleteDoc, query, where, serverTimestamp, getDocs, writeBatch, enableIndexedDbPersistence, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Make Firebase SDK available globally for the Babel script
        window.firebaseSDK = {
            initializeApp, getAuth, getFirestore, collection, onSnapshot,
            doc, addDoc, updateDoc, deleteDoc, query, where, serverTimestamp,
            signInWithEmailAndPassword, onAuthStateChanged, signOut, getDocs, writeBatch,
            enableIndexedDbPersistence, setDoc
        };
    </script>
    
    <!-- React Application Script -->
    <script type="text/babel">
        // --- START REACT & FIREBASE SETUP ---
        const { useState, useEffect, useMemo, useCallback, createContext, useContext, memo } = React;

        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyB7_pnmwHj6aOeZRTykPvNusNFYReaTY6Q",
            authDomain: "hrsm-j.firebaseapp.com",
            projectId: "hrsm-j",
            storageBucket: "hrsm-j.appspot.com",
            messagingSenderId: "45063715478",
            appId: "1:45063715478:web:cc2dd21b83dd195771e0b7",
            measurementId: "G-8HQDG2LTKP"
        };

        // Firebase Context for providing db and auth instances throughout the app
        const FirebaseContext = createContext(null);
        const useFirebase = () => useContext(FirebaseContext);

        const FirebaseProvider = ({ children }) => {
            const [db, setDb] = useState(null);
            const [auth, setAuth] = useState(null);
            const [currentUser, setCurrentUser] = useState(null);
            const [userProfile, setUserProfile] = useState(null);
            const [loading, setLoading] = useState(true);

            // Initialize Firebase and Auth state listener
            useEffect(() => {
                try {
                    const { initializeApp, getFirestore, getAuth, onAuthStateChanged, enableIndexedDbPersistence } = window.firebaseSDK;
                    const app = initializeApp(firebaseConfig);
                    const dbInstance = getFirestore(app);
                    
                    // Enable offline persistence
                    enableIndexedDbPersistence(dbInstance).catch((err) => {
                        if (err.code === 'failed-precondition') console.warn("Firestore persistence failed: Multiple tabs open.");
                        else if (err.code === 'unimplemented') console.warn("Firestore persistence failed: Browser does not support it.");
                    });

                    const authInstance = getAuth(app);
                    setAuth(authInstance);
                    setDb(dbInstance);

                    const unsubscribe = onAuthStateChanged(authInstance, (user) => {
                        setCurrentUser(user);
                        if (!user) {
                            setUserProfile(null);
                            setLoading(false);
                        }
                    });
                    return () => unsubscribe();
                } catch (error) { 
                    console.error("Firebase initialization error:", error); 
                    setLoading(false);
                } 
            }, []);

            // Fetch user profile from Firestore when auth state changes
            useEffect(() => {
                if (!db || !currentUser) {
                    if (!currentUser) setLoading(false);
                    setUserProfile(null);
                    return;
                }

                setLoading(true);
                const { collection, query, where, onSnapshot } = window.firebaseSDK;
                const q = query(collection(db, "employees"), where("uid", "==", currentUser.uid));
                
                const unsubscribe = onSnapshot(q, (snapshot) => {
                    if (!snapshot.empty) {
                        const userDoc = snapshot.docs[0];
                        setUserProfile({ id: userDoc.id, ...userDoc.data() });
                    } else {
                        console.warn("Authenticated user has no employee profile in Firestore.");
                        setUserProfile(null);
                    }
                    setLoading(false);
                }, (error) => {
                    console.error("Error fetching user profile:", error);
                    setLoading(false);
                });

                return () => unsubscribe();
            }, [db, currentUser]);

            const value = { db, auth, currentUser, userProfile, loading };
            return <FirebaseContext.Provider value={value}>{children}</FirebaseContext.Provider>;
        };
        
        // Custom hook for real-time Firestore collection data
        const useCollection = (collectionName, queryConstraints = []) => {
            const { db } = useFirebase();
            const [data, setData] = useState([]);
            const [loading, setLoading] = useState(true);

            useEffect(() => {
                if (!db) return;
                setLoading(true);
                const { collection, onSnapshot, query } = window.firebaseSDK;
                const q = query(collection(db, collectionName), ...queryConstraints);
                const unsubscribe = onSnapshot(q, (querySnapshot) => {
                    const items = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    setData(items);
                    setLoading(false);
                }, (error) => {
                    console.error(`Error fetching collection ${collectionName}:`, error);
                    setLoading(false);
                });
                return () => unsubscribe();
            }, [db, collectionName, JSON.stringify(queryConstraints)]); // JSON.stringify to safely memoize the array dependency
            return { data, loading };
        };
        // --- END REACT & FIREBASE SETUP ---

        // --- START UTILITY FUNCTIONS ---
        const Utils = {
            formatCurrency: (value, currency = 'KHR') => {
                if (value === null || value === undefined) return '';
                const num = parseFloat(String(value).replace(/[^0-9.-]/g, ''));
                if (isNaN(num)) return '';
                const options = { style: 'currency', currency: currency, minimumFractionDigits: currency === 'KHR' ? 0 : 2, maximumFractionDigits: currency === 'KHR' ? 0 : 2 };
                const locale = currency === 'KHR' ? 'km-KH' : 'en-US';
                let formatted = new Intl.NumberFormat(locale, options).format(num);
                if (currency === 'KHR') { formatted = formatted.replace('KHR', '៛').trim(); }
                return formatted;
            },
            formatRequestDate: (timestamp) => {
                if (!timestamp || !timestamp.toDate) return 'N/A';
                const date = timestamp.toDate();
                return `${date.toLocaleDateString('en-GB', { day: '2-digit', month: '2-digit', year: '2-digit' })} | ${date.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: true })}`;
            },
            formatISOToDisplay: (isoDate) => {
                if (!isoDate || typeof isoDate !== 'string' || !isoDate.includes('-')) return isoDate || '';
                const [year, month, day] = isoDate.split('-');
                return `${day}-${month}-${year}`;
            },
            calculateWorkedDuration: (joinedDate) => {
                if (!joinedDate) return 'N/A';
                const start = new Date(joinedDate);
                if (isNaN(start.getTime())) return 'N/A';
                const now = new Date();
                let years = now.getFullYear() - start.getFullYear();
                let months = now.getMonth() - start.getMonth();
                let days = now.getDate() - start.getDate();
                if (days < 0) { months--; days += new Date(now.getFullYear(), now.getMonth(), 0).getDate(); }
                if (months < 0) { years--; months += 12; }
                return `${years}Y ${months}M ${days}D`;
            },
            // Haversine formula to calculate distance between two lat/lon points
            getDistance: (lat1, lon1, lat2, lon2) => {
                const R = 6371e3; // Earth's radius in metres
                const φ1 = lat1 * Math.PI/180; const φ2 = lat2 * Math.PI/180;
                const Δφ = (lat2-lat1) * Math.PI/180; const Δλ = (lon2-lon1) * Math.PI/180;
                const a = Math.sin(Δφ/2) * Math.sin(Δφ/2) + Math.cos(φ1) * Math.cos(φ2) * Math.sin(Δλ/2) * Math.sin(Δλ/2);
                const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
                return R * c; // Distance in metres
            }
        };
        // --- END UTILITY FUNCTIONS ---

        // --- START REUSABLE UI COMPONENTS ---
        const Card = memo(({ children, className = '' }) => (<div className={`bg-slate-800/50 p-4 sm:p-6 rounded-lg shadow-lg border border-slate-700 ${className}`}>{children}</div>));
        const CardTitle = memo(({ children }) => (<h2 className="text-2xl font-semibold text-slate-100 mb-4 pb-4 border-b border-slate-700">{children}</h2>));
        const UnderConstructionPage = memo(({ title }) => (<Card><div className="text-center p-4 sm:p-8"><i className="fas fa-tools text-5xl text-yellow-400 mb-6"></i><h3 className="text-2xl sm:text-3xl font-bold text-slate-100">{title}</h3><p className="text-slate-400 mt-2">This page is under construction.</p></div></Card>));
        const Modal = ({ isOpen, onClose, children, maxWidth = "max-w-4xl" }) => { if (!isOpen) return null; return (<div className="fixed inset-0 bg-black bg-opacity-70 z-50 flex justify-center items-start sm:items-center p-4 overflow-y-auto"><div className={`bg-slate-800 rounded-lg shadow-2xl w-full ${maxWidth} flex flex-col border border-slate-600 my-auto`}>{children}</div></div>); };
        const ModalHeader = memo(({ title, onClose }) => (<div className="p-5 border-b border-slate-700 flex justify-between items-center flex-shrink-0"><h3 className="text-xl font-semibold text-slate-100">{title}</h3><button onClick={onClose} className="text-slate-400 hover:text-white text-2xl p-1">&times;</button></div>));
        const ModalBody = memo(({ children }) => (<div className="p-6 flex-grow overflow-y-auto max-h-[calc(90vh-140px)]">{children}</div>));
        const ModalFooter = memo(({ children }) => (<div className="p-4 bg-slate-900/50 border-t border-slate-700 flex justify-end gap-4 rounded-b-lg flex-shrink-0">{children}</div>));
        const ConfirmationModal = ({ isOpen, onClose, onConfirm, title, message }) => { if (!isOpen) return null; return (<div className="fixed inset-0 bg-black bg-opacity-70 z-50 flex justify-center items-center p-4"><div className="bg-slate-800 rounded-lg shadow-2xl w-full max-w-sm border border-slate-600"><div className="p-6"><h3 className="text-lg font-bold text-slate-100">{title}</h3><p className="mt-2 text-sm text-slate-400">{message}</p></div><div className="p-4 bg-slate-900/50 border-t border-slate-700 flex justify-end gap-4 rounded-b-lg"><button onClick={onClose} className="bg-slate-600 text-slate-200 px-4 py-2 rounded-lg hover:bg-slate-500">Cancel</button><button onClick={onConfirm} className="bg-red-600 text-white px-4 py-2 rounded-lg shadow hover:bg-red-700">Confirm</button></div></div></div>); };
        const TabbedPage = memo(({ tabs, activeTab, setActiveTab, children }) => {
            const renderContent = () => React.Children.toArray(children).find(child => child.props.id === activeTab) || <UnderConstructionPage title={tabs[activeTab]} />;
            return (<div><div className="mb-6 overflow-x-auto"><nav className="flex space-x-2 sm:space-x-4" aria-label="Tabs">{Object.entries(tabs).map(([key, title]) => (<a href="#" key={key} onClick={(e) => { e.preventDefault(); setActiveTab(key); }} className={`whitespace-nowrap rounded-md px-3 py-2 text-sm font-medium transition-colors ${activeTab === key ? 'bg-blue-600 text-white shadow' : 'text-slate-400 hover:bg-slate-700/50 hover:text-slate-200'}`}>{title}</a>))}</nav></div>{renderContent()}</div>);
        });
        const NotificationBell = ({ pendingLeaves = [], pendingOTs = [], onNotificationClick }) => {
            const [isOpen, setIsOpen] = useState(false);
            const totalCount = pendingLeaves.length + pendingOTs.length;

            const handleLeaveClick = () => {
                onNotificationClick('leaveRequest');
                setIsOpen(false);
            };

            const handleOTClick = () => {
                onNotificationClick('otRequest');
                setIsOpen(false);
            };

            return (
                <div className="relative">
                    <button onClick={() => setIsOpen(!isOpen)} className="relative text-slate-400 hover:text-white focus:outline-none">
                        <i className="fas fa-bell text-xl"></i>
                        {totalCount > 0 && (
                            <span className="absolute -top-2 -right-2 flex h-5 w-5 items-center justify-center rounded-full bg-red-500 text-xs font-bold text-white">
                                {totalCount}
                            </span>
                        )}
                    </button>
                    {isOpen && (
                        <div className="absolute right-0 mt-2 w-80 origin-top-right rounded-md bg-slate-800 shadow-lg ring-1 ring-black ring-opacity-5 focus:outline-none border border-slate-700">
                            <div className="py-1">
                                <div className="px-4 py-2 text-sm font-semibold text-slate-100 border-b border-slate-700">Notifications</div>
                                {totalCount === 0 ? (
                                    <div className="px-4 py-3 text-sm text-slate-400">No new notifications</div>
                                ) : (
                                    <>
                                        {pendingLeaves.map(req => (
                                            <a href="#" key={req.id} onClick={handleLeaveClick} className="block px-4 py-3 text-sm text-slate-300 hover:bg-slate-700">
                                                <p className="font-medium text-slate-200">New Leave Request</p>
                                                <p className="text-xs text-slate-400">{req.staffName} - {req.numberOfDays} day(s)</p>
                                            </a>
                                        ))}
                                        {pendingOTs.map(req => (
                                            <a href="#" key={req.id} onClick={handleOTClick} className="block px-4 py-3 text-sm text-slate-300 hover:bg-slate-700">
                                                <p className="font-medium text-slate-200">New OT Request</p>
                                                <p className="text-xs text-slate-400">{req.numberOfOTDays} day(s)</p>
                                            </a>
                                        ))}
                                    </>
                                )}
                            </div>
                        </div>
                    )}
                </div>
            );
        };
        // --- END REUSABLE UI COMPONENTS ---

        // --- START AUTHENTICATION PAGE ---
        const LoginPage = () => {
            const { auth, db } = useFirebase();
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [error, setError] = useState('');
            const [loading, setLoading] = useState(false);
            const [showPassword, setShowPassword] = useState(false);

            const handleLogin = useCallback(async (e) => {
                e.preventDefault();
                if (!auth || !db) { setError("System not ready. Please try again."); return; }
                setLoading(true);
                setError('');
                try {
                    const { signInWithEmailAndPassword, signOut, collection, query, where, getDocs, doc, updateDoc } = window.firebaseSDK;
                    const userCredential = await signInWithEmailAndPassword(auth, email, password);
                    const user = userCredential.user;
                    
                    // Verify user has an active employee profile by email
                    const q = query(collection(db, "employees"), where("email", "==", user.email));
                    const querySnapshot = await getDocs(q);

                    if (querySnapshot.empty) {
                        await signOut(auth);
                        setError("No employee record found for this user.");
                    } else {
                        const employeeDoc = querySnapshot.docs[0];
                        const employeeData = employeeDoc.data();

                        if (employeeData.status !== 'Active') {
                            await signOut(auth);
                            setError("Your account is inactive. Please contact HR.");
                        } else {
                            // Automatically link UID if it's missing or incorrect.
                            if (!employeeData.uid || employeeData.uid !== user.uid) {
                                const employeeDocRef = doc(db, 'employees', employeeDoc.id);
                                await updateDoc(employeeDocRef, { uid: user.uid });
                            }
                            // Login is successful; onAuthStateChanged will handle profile loading.
                        }
                    }
                } catch (err) {
                    setError('Failed to login. Please check your credentials.');
                    console.error(err);
                } finally {
                    setLoading(false);
                }
            }, [auth, db, email, password]);

            return (
                <div className="flex items-center justify-center min-h-screen bg-slate-900">
                    <div className="w-full max-w-md p-8 space-y-8 bg-slate-800 rounded-2xl shadow-lg border border-slate-700">
                        <div className="text-center"><i className="fas fa-building-user text-5xl text-blue-500"></i><h2 className="mt-6 text-3xl font-bold text-white">HR Management System</h2><p className="mt-2 text-sm text-slate-400">Sign in to your account</p></div>
                        <form className="mt-8 space-y-6" onSubmit={handleLogin}>
                            <div className="rounded-md shadow-sm -space-y-px">
                                <div><input id="email-address" name="email" type="email" autoComplete="email" required className="appearance-none rounded-none relative block w-full px-3 py-3 border border-slate-600 bg-slate-700 text-white placeholder-slate-400 rounded-t-md focus:outline-none focus:ring-blue-500 focus:border-blue-500 focus:z-10 sm:text-sm" placeholder="Email address" value={email} onChange={(e) => setEmail(e.target.value)} /></div>
                                <div className="relative"><input id="password" name="password" type={showPassword ? "text" : "password"} autoComplete="current-password" required className="appearance-none rounded-none relative block w-full px-3 py-3 border border-slate-600 bg-slate-700 text-white placeholder-slate-400 rounded-b-md focus:outline-none focus:ring-blue-500 focus:border-blue-500 focus:z-10 sm:text-sm" placeholder="Password" value={password} onChange={(e) => setPassword(e.target.value)} /><button type="button" onClick={() => setShowPassword(!showPassword)} className="absolute inset-y-0 right-0 pr-3 flex items-center text-sm leading-5"><i className={`fas ${showPassword ? 'fa-eye-slash' : 'fa-eye'} text-slate-400 hover:text-slate-200`}></i></button></div>
                            </div>
                            {error && <p className="text-red-500 text-sm text-center">{error}</p>}
                            <div><button type="submit" disabled={loading} className="group relative w-full flex justify-center py-3 px-4 border border-transparent text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 focus:ring-offset-slate-800 disabled:bg-blue-800 disabled:cursor-not-allowed">{loading ? <i className="fas fa-spinner fa-spin"></i> : 'Sign in'}</button></div>
                        </form>
                    </div>
                </div>
            );
        };
        // --- END AUTHENTICATION PAGE ---

        // --- START EMPLOYEES PAGE ---
        const EmployeesPage = ({ userProfile }) => {
            const [activeTab, setActiveTab] = useState('active');
            return (
                <TabbedPage tabs={{ active: 'Active Employees', salaryReport: 'Salary Revise Report', former: 'Resigned/Terminated' }} activeTab={activeTab} setActiveTab={setActiveTab}>
                    <div id="active"><ActiveEmployeesTab userProfile={userProfile} /></div>
                    <div id="salaryReport"><SalaryReviseReportTab userProfile={userProfile} /></div>
                    <div id="former"><FormerEmployeesTab userProfile={userProfile} /></div>
                </TabbedPage>
            );
        };

        const ActiveEmployeesTab = ({ userProfile }) => {
            const { db, auth } = useFirebase();
            const [isModalOpen, setModalOpen] = useState(false);
            const [editingEmployee, setEditingEmployee] = useState(null);
            const [employeeToDelete, setEmployeeToDelete] = useState(null);
            const [selectedShop, setSelectedShop] = useState('');
            const [searchTerm, setSearchTerm] = useState('');
            const { where } = window.firebaseSDK;
            const { data: shops } = useCollection('shops');

            // Define query constraints based on user role
            const queryConstraints = useMemo(() => {
                if (!auth.currentUser) return [where("uid", "==", "null")]; // No user, no data
                if (userProfile?.role === 'Admin') return []; // Admin sees all
                // If Shop Manager has an array of shops, use 'in' query to find employees in any of those shops.
                if (userProfile?.role === 'Shop Manager' && Array.isArray(userProfile.shop) && userProfile.shop.length > 0) {
                    return [where("shop", "in", userProfile.shop)];
                }
                if (userProfile?.shop) return [where("shop", "==", userProfile.shop)]; // Fallback for single shop
                return [where("uid", "==", auth.currentUser.uid)]; // Staff sees only themselves
            }, [userProfile, auth.currentUser]);

            const { data: employees } = useCollection('employees', queryConstraints);
            
            // Memoized filtering for performance
            const filteredEmployees = useMemo(() => {
                const filtered = employees.filter(e => 
                    e.status === 'Active' && 
                    // Check if employee's shop (string) is selected, or if their shop array includes the selected shop.
                    (!selectedShop || (Array.isArray(e.shop) ? e.shop.includes(selectedShop) : e.shop === selectedShop)) && 
                    (e.name.toLowerCase().includes(searchTerm.toLowerCase()))
                );
                
                // Sort by shop name, then by employee name
                return filtered.sort((a, b) => {
                    const shopA = Array.isArray(a.shop) ? a.shop[0] || '' : a.shop || '';
                    const shopB = Array.isArray(b.shop) ? b.shop[0] || '' : b.shop || '';
                    if (shopA < shopB) return -1;
                    if (shopA > shopB) return 1;
                    if (a.name < b.name) return -1;
                    if (a.name > b.name) return 1;
                    return 0;
                });
            }, [employees, selectedShop, searchTerm]);

            const handleOpenModal = useCallback((employee = null) => { setEditingEmployee(employee); setModalOpen(true); }, []);
            const handleCloseModal = useCallback(() => { setModalOpen(false); setEditingEmployee(null); }, []);

            const handleSaveEmployee = useCallback(async (employeeData) => {
                const { doc, updateDoc, addDoc, collection, serverTimestamp, getDocs, query, where, writeBatch } = window.firebaseSDK;
                // Sanitize salary before saving
                const salaryToSave = parseFloat(String(employeeData.salary).replace(/[^0-9.-]/g, '')) || 0;
                const dataToSave = { ...employeeData, salary: salaryToSave };
                try {
                    let savedEmployeeId;
                    let savedEmployeeName = dataToSave.name;
                    let savedEmployeeShop = dataToSave.shop;

                    if (dataToSave.id) {
                        savedEmployeeId = dataToSave.id;
                        const { id, ...data } = dataToSave;
                        const originalData = employees.find(e => e.id === id);
                        await updateDoc(doc(db, 'employees', id), data);
                        // Log the update action
                        await addDoc(collection(db, "userLogs"), { 
                            userId: auth.currentUser.uid, 
                            action: 'Update Employee',
                            targetId: id,
                            targetName: data.name,
                            timestamp: serverTimestamp(), 
                            originalData, 
                            updatedData: data 
                        });
                    } else {
                        const newDocRef = await addDoc(collection(db, 'employees'), dataToSave);
                        savedEmployeeId = newDocRef.id;
                        // Log the add action
                        await addDoc(collection(db, "userLogs"), { 
                            userId: auth.currentUser.uid, 
                            action: 'Add Employee',
                            targetId: newDocRef.id,
                            targetName: dataToSave.name,
                            timestamp: serverTimestamp(), 
                            originalData: null, 
                            updatedData: dataToSave 
                        });
                    }

                    // Auto-update supervisor for the shop(s) if the saved employee is a Shop Manager
                    if (dataToSave.role === 'Shop Manager' && dataToSave.shop) {
                        const shopsToUpdate = Array.isArray(dataToSave.shop) ? dataToSave.shop : [dataToSave.shop];
                        if (shopsToUpdate.length > 0) {
                            console.log(`Updating supervisors for shops: ${shopsToUpdate.join(', ')} to ${savedEmployeeName}`);
                            const batch = writeBatch(db);
                            await Promise.all(shopsToUpdate.map(async (shopName) => {
                                const shopEmployeesQuery = query(collection(db, "employees"), where("shop", "==", shopName));
                                const querySnapshot = await getDocs(shopEmployeesQuery);
                                querySnapshot.forEach((employeeDoc) => {
                                    if (employeeDoc.id !== savedEmployeeId) {
                                        const empRef = doc(db, 'employees', employeeDoc.id);
                                        batch.update(empRef, { supervisor: savedEmployeeName });
                                    }
                                });
                            }));
                            await batch.commit();
                            console.log("Batch update for supervisors completed.");
                        }
                    }

                    handleCloseModal();
                } catch (e) { console.error("Error saving employee:", e); }
            }, [db, auth, employees, handleCloseModal]);
            
            const handleDeleteConfirm = useCallback(async () => {
                if (!employeeToDelete) return;
                try { 
                    await window.firebaseSDK.deleteDoc(window.firebaseSDK.doc(db, 'employees', employeeToDelete.id)); 
                    const { addDoc, collection, serverTimestamp } = window.firebaseSDK;
                    // Log the delete action
                    await addDoc(collection(db, "userLogs"), { 
                        userId: auth.currentUser.uid, 
                        action: 'Delete Employee',
                        targetId: employeeToDelete.id,
                        targetName: employeeToDelete.name,
                        timestamp: serverTimestamp(), 
                        originalData: employeeToDelete, 
                        updatedData: null 
                    });
                } catch (e) { 
                    console.error(`Error deleting employee:`, e); 
                } finally {
                    setEmployeeToDelete(null);
                }
            }, [db, auth, employeeToDelete]);

            const handleExportExcel = useCallback(() => {
                const dataToExport = filteredEmployees.map(emp => ({ 
                    'Name': emp.name, 'Position': emp.position, 'Role': emp.role, 'Shop': emp.shop, 
                    'Join Date': emp.joinedDate, 'Worked Duration': Utils.calculateWorkedDuration(emp.joinedDate), 
                    'Shift': emp.shift, 'Telephone': emp.tel, 'Email': emp.email, 
                    'Salary (KHR)': parseFloat(String(emp.salary).replace(/[^0-9.-]/g, '')) || 0 
                }));
                const worksheet = XLSX.utils.json_to_sheet(dataToExport);
                const workbook = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(workbook, worksheet, "Active Employees");
                // Set column widths for better readability
                worksheet["!cols"] = [ { wch: 25 }, { wch: 20 }, { wch: 15 }, { wch: 15 }, { wch: 12 }, { wch: 15 }, { wch: 10 }, { wch: 15 }, { wch: 30 }, { wch: 15 } ];
                XLSX.writeFile(workbook, "Active_Employees.xlsx");
            }, [filteredEmployees]);

            return (
                <Card>
                    <div className="flex flex-wrap gap-4 justify-between items-center mb-6">
                        <h3 className="text-xl font-semibold text-slate-100 flex items-center gap-2">
                            <span>Active Employee List</span>
                            <span className="text-blue-400 font-bold text-2xl"> : {filteredEmployees.length}</span>
                        </h3>
                        <div className="flex flex-wrap gap-4 items-center">
                             <input type="text" placeholder="Search by name..." value={searchTerm} onChange={e => setSearchTerm(e.target.value)} className="input w-full sm:w-auto" />
                            {userProfile?.role === 'Admin' && (<select value={selectedShop} onChange={e => setSelectedShop(e.target.value)} className="select w-full sm:w-auto"><option value="">All Shops</option>{shops.map(s => <option key={s.id} value={s.name}>{s.name}</option>)}</select>)}
                            <button onClick={handleExportExcel} className="bg-green-600 text-white px-4 py-2 rounded-lg shadow hover:bg-green-700 transition-colors flex items-center gap-2"><i className="fas fa-file-excel"></i> Excel</button>
                            <button onClick={() => handleOpenModal()} className="bg-blue-600 text-white px-4 py-2 rounded-lg shadow hover:bg-blue-700 transition-colors flex items-center gap-2"><i className="fas fa-plus"></i> Add</button>
                        </div>
                    </div>
                    {/* Desktop Table View */}
                    <div className="overflow-x-auto hidden md:block"><table className="min-w-full divide-y divide-slate-700"><thead className="bg-slate-900/50"><tr><th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Name</th><th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Position</th><th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Shop</th><th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Join Date</th><th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Worked Dur.</th><th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Shift</th><th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Tel</th><th className="px-4 py-3 text-right text-xs font-semibold text-slate-400 uppercase">Salary</th><th className="px-4 py-3 text-center text-xs font-semibold text-slate-400 uppercase">Actions</th></tr></thead><tbody className="divide-y divide-slate-700">{filteredEmployees.map(emp => (<tr key={emp.id} className="hover:bg-slate-700/50"><td className="px-4 py-4 text-sm text-slate-200 whitespace-nowrap">{emp.name}</td><td className="px-4 py-4 text-sm text-slate-300 whitespace-nowrap">{emp.position}</td><td className="px-4 py-4 text-sm text-slate-300 whitespace-nowrap">{Array.isArray(emp.shop) ? emp.shop.join(', ') : emp.shop}</td><td className="px-4 py-4 text-sm text-slate-300 whitespace-nowrap">{emp.joinedDate}</td><td className="px-4 py-4 text-sm text-slate-300 whitespace-nowrap">{Utils.calculateWorkedDuration(emp.joinedDate)}</td><td className="px-4 py-4 text-sm text-slate-300 whitespace-nowrap">{emp.shift}</td><td className="px-4 py-4 text-sm text-slate-300 whitespace-nowrap">{emp.tel}</td><td className="px-4 py-4 text-sm text-slate-300 text-right whitespace-nowrap">{Utils.formatCurrency(emp.salary)}</td><td className="px-4 py-4 text-center whitespace-nowrap">{userProfile?.role === 'Admin' && (<><button onClick={() => handleOpenModal(emp)} className="text-blue-400 hover:text-blue-300 mr-4"><i className="fas fa-edit"></i></button><button onClick={() => setEmployeeToDelete(emp)} className="text-red-500 hover:text-red-400"><i className="fas fa-trash"></i></button></>)}</td></tr>))}</tbody></table></div>
                    {/* Mobile Card View */}
                    <div className="grid grid-cols-1 gap-4 md:hidden">{filteredEmployees.map(emp => (<div key={emp.id} className="bg-slate-700/50 rounded-lg p-4 space-y-3"><div className="flex justify-between items-start"><div><p className="font-bold text-lg text-slate-100">{emp.name}</p><p className="text-sm text-slate-300">{emp.position}</p></div><div className="flex space-x-3">{userProfile?.role === 'Admin' && (<><button onClick={() => handleOpenModal(emp)} className="text-blue-400 hover:text-blue-300"><i className="fas fa-edit"></i></button><button onClick={() => setEmployeeToDelete(emp)} className="text-red-500 hover:text-red-400"><i className="fas fa-trash"></i></button></>)}</div></div><div className="grid grid-cols-2 gap-x-4 gap-y-2 text-sm pt-2 border-t border-slate-600"><div><p className="text-slate-400">Shop</p><p className="text-slate-200 font-medium">{Array.isArray(emp.shop) ? emp.shop.join(', ') : emp.shop}</p></div><div><p className="text-slate-400">Shift</p><p className="text-slate-200 font-medium">{emp.shift}</p></div><div><p className="text-slate-400">Joined Date</p><p className="text-slate-200 font-medium">{emp.joinedDate}</p></div><div><p className="text-slate-400">Salary</p><p className="text-slate-200 font-medium">{Utils.formatCurrency(emp.salary)}</p></div><div><p className="text-slate-400">Tel</p><p className="text-slate-200 font-medium">{emp.tel}</p></div><div><p className="text-slate-400">Worked Dur.</p><p className="text-slate-200 font-medium">{Utils.calculateWorkedDuration(emp.joinedDate)}</p></div></div></div>))}</div>
                    <EmployeeModal isOpen={isModalOpen} onClose={handleCloseModal} onSave={handleSaveEmployee} employee={editingEmployee} userProfile={userProfile} />
                    <ConfirmationModal isOpen={!!employeeToDelete} onClose={() => setEmployeeToDelete(null)} onConfirm={handleDeleteConfirm} title="Delete Employee" message={`Are you sure you want to delete ${employeeToDelete?.name}? This action cannot be undone.`} />
                </Card>
            );
        };

        const EmployeeModal = ({ isOpen, onClose, onSave, employee, userProfile }) => {
            const [formData, setFormData] = useState({});
            const { data: shops } = useCollection('shops');
            const { data: positions } = useCollection('positions');
            const { data: employees } = useCollection('employees');
            
            const supervisors = useMemo(() => employees.filter(e => e.role === 'Shop Manager' && e.status === 'Active'), [employees]);

            const availablePages = useMemo(() => [
                { key: 'employees', label: 'Employees' }, { key: 'checkinme', label: 'CheckInMe' },
                { key: 'attendanceReport', label: 'Attendance Report' }, { key: 'loanManager', label: 'Loan Manager' },
                { key: 'payroll', label: 'Payroll' }, { key: 'expenseReport', label: 'Expense Report' },
                { key: 'userActivity', label: 'User Activity' }, { key: 'settings', label: 'Settings' },
            ], []);

            // Initialize form data when modal opens or employee data changes
            useEffect(() => {
                const initialData = employee 
                    ? { ...employee, permissions: employee.permissions || [] } 
                    : { name: '', sex: 'M', dob: '', nationId: '', tel: '', shop: '', joinedDate: '', salary: '', position: '', shift: 'AM', supervisor: '', status: 'Active', email: '', uid: '', role: 'Staff', address: '', permissions: [], statusChangeDate: '', reasonForLeaving: '' };

                // When editing, ensure shop is in the right format based on role
                if (employee) {
                    if (employee.role === 'Shop Manager' || employee.role === 'Admin') {
                        initialData.shop = Array.isArray(employee.shop) ? employee.shop : (employee.shop ? [employee.shop] : []);
                    } else {
                        initialData.shop = Array.isArray(employee.shop) ? employee.shop[0] || '' : employee.shop || '';
                    }
                } else {
                    // For new employee, default based on Staff role
                    initialData.shop = '';
                }

                setFormData(initialData);
            }, [employee, isOpen]);
            
            // Automatically grant 'checkinme' permission to Staff role
            useEffect(() => {
                if (formData.role === 'Staff' && !formData.permissions?.includes('checkinme')) {
                    setFormData(prev => ({ ...prev, permissions: [...new Set([...(prev.permissions || []), 'checkinme'])] }));
                }
            }, [formData.role]);

            const handleChange = useCallback((e) => {
                const { name, value, type, checked } = e.target;
                
                if (name === 'role') {
                    // When role changes, convert shop data structure accordingly
                    setFormData(prev => {
                        const newRole = value;
                        let newShopValue = prev.shop;
                        if (newRole === 'Shop Manager' || newRole === 'Admin') {
                            // convert to array if it's a string
                            newShopValue = Array.isArray(prev.shop) ? prev.shop : (prev.shop ? [prev.shop] : []);
                        } else {
                            // convert to string (first element) if it's an array
                            newShopValue = Array.isArray(prev.shop) ? prev.shop[0] || '' : prev.shop;
                        }
                        return { ...prev, role: newRole, shop: newShopValue };
                    });
                } else if (type === 'checkbox') {
                    if (name === 'shop') { // Handling shop multi-select
                        setFormData(prev => {
                            const shopArray = Array.isArray(prev.shop) ? prev.shop : [];
                            const newShops = checked ? [...shopArray, value] : shopArray.filter(s => s !== value);
                            return { ...prev, shop: newShops };
                        });
                    } else { // Handling permissions
                        setFormData(prev => ({ ...prev, permissions: checked ? [...(prev.permissions || []), value] : (prev.permissions || []).filter(p => p !== value) }));
                    }
                } else {
                    setFormData(prev => ({ ...prev, [name]: value }));
                }
            }, []);

            // Handlers for salary input to allow typing numbers and format on blur
            const handleSalaryChange = useCallback((e) => { setFormData(prev => ({ ...prev, salary: e.target.value.replace(/[^0-9.]/g, '') })); }, []);
            const handleSalaryBlur = useCallback((e) => { setFormData(prev => ({ ...prev, salary: Utils.formatCurrency(e.target.value) })); }, []);
            const handleSubmit = useCallback((e) => { 
                e.preventDefault(); 
                const dataToSave = { ...formData };
                // Final check to ensure staff have a string for shop, not array
                if (dataToSave.role !== 'Shop Manager' && dataToSave.role !== 'Admin') {
                    dataToSave.shop = Array.isArray(dataToSave.shop) ? dataToSave.shop[0] || '' : dataToSave.shop;
                }
                onSave(dataToSave); 
            }, [onSave, formData]);
            const isFormerEmployee = formData.status === 'Terminated' || formData.status === 'Resigned';

            return (
                <Modal isOpen={isOpen} onClose={onClose}>
                    <form onSubmit={handleSubmit}>
                        <ModalHeader title={employee ? 'Edit Employee' : 'Add New Employee'} onClose={onClose} />
                        <ModalBody>
                            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                {/* Employee Personal & Job Details */}
                                <div><label className="text-sm font-medium text-slate-400">Name</label><input name="name" value={formData.name || ''} onChange={handleChange} className="input" required /></div>
                                <div><label className="text-sm font-medium text-slate-400">Sex</label><select name="sex" value={formData.sex || 'M'} onChange={handleChange} className="select"><option value="M">Male</option><option value="F">Female</option></select></div>
                                <div><label className="text-sm font-medium text-slate-400">Date of Birth</label><input type="date" name="dob" value={formData.dob || ''} onChange={handleChange} className="input" /></div>
                                <div><label className="text-sm font-medium text-slate-400">Nation ID</label><input name="nationId" value={formData.nationId || ''} onChange={handleChange} className="input" /></div>
                                <div><label className="text-sm font-medium text-slate-400">Tel No</label><input name="tel" value={formData.tel || ''} onChange={handleChange} className="input" /></div>
                                
                                {(formData.role === 'Shop Manager' || formData.role === 'Admin') ? (
                                    <div className="md:col-span-full">
                                        <label className="text-sm font-medium text-slate-400">Shops</label>
                                        <div className="mt-2 grid grid-cols-2 sm:grid-cols-3 gap-4 p-4 border border-slate-600 rounded-lg bg-slate-700/50">
                                            {shops.map(shop => (
                                                <div key={shop.id} className="flex items-center">
                                                    <input id={`shop-${shop.id}`} name="shop" type="checkbox" value={shop.name} checked={(Array.isArray(formData.shop) ? formData.shop : []).includes(shop.name)} onChange={handleChange} className="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500 bg-slate-600" />
                                                    <label htmlFor={`shop-${shop.id}`} className="ml-3 text-sm text-slate-300">{shop.name}</label>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                ) : (
                                    <div>
                                        <label className="text-sm font-medium text-slate-400">Shop</label>
                                        <select name="shop" value={formData.shop || ''} onChange={handleChange} className="select">
                                            <option value="">Select Shop</option>
                                            {shops.map(s => <option key={s.id} value={s.name}>{s.name}</option>)}
                                        </select>
                                    </div>
                                )}

                                <div><label className="text-sm font-medium text-slate-400">Joined Date</label><input type="date" name="joinedDate" value={formData.joinedDate || ''} onChange={handleChange} className="input" /></div>
                                <div><label className="text-sm font-medium text-slate-400">Salary</label><input name="salary" value={formData.salary || ''} onChange={handleSalaryChange} onBlur={handleSalaryBlur} className="input" /></div>
                                <div><label className="text-sm font-medium text-slate-400">Position</label><select name="position" value={formData.position || ''} onChange={handleChange} className="select"><option value="">Select Position</option>{positions.map(p => <option key={p.id} value={p.position}>{p.position}</option>)}</select></div>
                                <div><label className="text-sm font-medium text-slate-400">Shift</label><select name="shift" value={formData.shift || 'AM'} onChange={handleChange} className="select"><option>AM</option><option>PM</option><option>APM</option></select></div>
                                <div><label className="text-sm font-medium text-slate-400">Supervisor</label><select name="supervisor" value={formData.supervisor || ''} onChange={handleChange} className="select"><option value="">Select Supervisor</option>{supervisors.map(e => <option key={e.id} value={e.name}>{e.name}</option>)}</select></div>
                                <div><label className="text-sm font-medium text-slate-400">Staff Status</label><select name="status" value={formData.status || 'Active'} onChange={handleChange} className="select"><option>Active</option><option>Terminated</option><option>Resigned</option></select></div>
                                {isFormerEmployee && (
                                    <>
                                        <div><label className="text-sm font-medium text-slate-400">Status Change Date</label><input type="date" name="statusChangeDate" value={formData.statusChangeDate || ''} onChange={handleChange} className="input" /></div>
                                        <div className="md:col-span-2"><label className="text-sm font-medium text-slate-400">Reason for Leaving</label><textarea name="reasonForLeaving" value={formData.reasonForLeaving || ''} onChange={handleChange} className="input" rows="2"></textarea></div>
                                    </>
                                )}
                                <div className="md:col-span-full"><hr className="border-slate-700 my-2"/></div>
                                {/* System & Permissions */}
                                <div><label className="text-sm font-medium text-slate-400">Email</label><input type="email" name="email" value={formData.email || ''} onChange={handleChange} className="input" /></div>
                                <div><label className="text-sm font-medium text-slate-400">Role</label><select name="role" value={formData.role || 'Staff'} onChange={handleChange} className="select"><option>Admin</option><option>Shop Manager</option><option>Staff</option></select></div>
                                <div className="md:col-span-2 lg:col-span-3"><label className="text-sm font-medium text-slate-400">Address</label><textarea name="address" value={formData.address || ''} onChange={handleChange} className="input" rows="3"></textarea></div>
                                <div className="md:col-span-2 lg:col-span-3">
                                    <label className="text-sm font-medium text-slate-400">Page Permissions</label>
                                    <div className="mt-2 grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4 p-4 border border-slate-600 rounded-lg bg-slate-700/50">
                                        {availablePages.map(page => {
                                            const isRestricted = userProfile?.role === 'Shop Manager' && ['expenseReport', 'userActivity', 'settings'].includes(page.key);
                                            const isForced = page.key === 'checkinme' && formData.role === 'Staff';
                                            const isDisabled = userProfile?.role !== 'Admin' && (isRestricted || isForced);
                                            return (
                                                <div key={page.key} className="flex items-center">
                                                    <input id={`perm-${page.key}`} type="checkbox" value={page.key} checked={formData.permissions?.includes(page.key)} onChange={handleChange} disabled={isDisabled} className="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500 bg-slate-600" />
                                                    <label htmlFor={`perm-${page.key}`} className={`ml-3 text-sm ${isDisabled ? 'text-slate-500' : 'text-slate-300'}`}>{page.label}</label>
                                                </div>
                                            );
                                        })}
                                    </div>
                                </div>
                            </div>
                        </ModalBody>
                        <ModalFooter>
                            <button type="button" onClick={onClose} className="bg-slate-600 text-slate-200 px-4 py-2 rounded-lg hover:bg-slate-500 transition-colors">Cancel</button>
                            <button type="submit" className="bg-blue-600 text-white px-6 py-2 rounded-lg shadow hover:bg-blue-700 transition-colors">Save</button>
                        </ModalFooter>
                    </form>
                </Modal>
            );
        };
        
        const FormerEmployeesTab = ({ userProfile }) => {
            const { db, auth } = useFirebase();
            const [isModalOpen, setModalOpen] = useState(false);
            const [editingEmployee, setEditingEmployee] = useState(null);
            const [employeeToDelete, setEmployeeToDelete] = useState(null);
            const { data: employees } = useCollection('employees');

            const formerEmployees = useMemo(() => employees.filter(e => e.status === 'Resigned' || e.status === 'Terminated'), [employees]);

            const handleOpenModal = useCallback((employee = null) => { setEditingEmployee(employee); setModalOpen(true); }, []);
            const handleCloseModal = useCallback(() => { setModalOpen(false); setEditingEmployee(null); }, []);
            
            const handleSaveEmployee = useCallback(async (employeeData) => {
                const { doc, updateDoc, addDoc, collection, serverTimestamp } = window.firebaseSDK;
                const salaryToSave = parseFloat(String(employeeData.salary).replace(/[^0-9.-]/g, '')) || 0;
                const dataToSave = { ...employeeData, salary: salaryToSave };
                try {
                    if (dataToSave.id) {
                        const { id, ...data } = dataToSave;
                        const originalData = employees.find(e => e.id === id);
                        await updateDoc(doc(db, 'employees', id), data);
                        await addDoc(collection(db, "userLogs"), { 
                            userId: auth.currentUser.uid, 
                            action: 'Update Former Employee',
                            targetId: id,
                            targetName: data.name,
                            timestamp: serverTimestamp(), 
                            originalData, 
                            updatedData: data 
                        });
                    }
                    handleCloseModal();
                } catch (e) { console.error("Error saving employee:", e); }
            }, [db, auth, employees, handleCloseModal]);
            
            const handleDeleteConfirm = useCallback(async () => {
                if (!employeeToDelete) return;
                try { 
                    await window.firebaseSDK.deleteDoc(window.firebaseSDK.doc(db, 'employees', employeeToDelete.id)); 
                    const { addDoc, collection, serverTimestamp } = window.firebaseSDK;
                    await addDoc(collection(db, "userLogs"), { 
                        userId: auth.currentUser.uid, 
                        action: 'Delete Employee Record',
                        targetId: employeeToDelete.id,
                        targetName: employeeToDelete.name,
                        timestamp: serverTimestamp(), 
                        originalData: employeeToDelete, 
                        updatedData: null 
                    });
                } catch (e) { 
                    console.error(`Error deleting employee:`, e); 
                } finally {
                    setEmployeeToDelete(null);
                }
            }, [db, auth, employeeToDelete]);

            return (
                <Card>
                    <h3 className="text-xl font-semibold text-slate-100 mb-6">Resigned/Terminated Employees</h3>
                    {/* Desktop Table */}
                    <div className="overflow-x-auto hidden md:block"><table className="min-w-full divide-y divide-slate-700"><thead className="bg-slate-900/50"><tr><th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Date</th><th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Shop Name</th><th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Staff</th><th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Status</th><th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Reason</th><th className="px-4 py-3 text-center text-xs font-semibold text-slate-400 uppercase">Actions</th></tr></thead><tbody className="divide-y divide-slate-700">{formerEmployees.map(emp => (<tr key={emp.id} className="hover:bg-slate-700/50"><td className="px-4 py-4 text-sm text-slate-300 whitespace-nowrap">{emp.statusChangeDate || 'N/A'}</td><td className="px-4 py-4 text-sm text-slate-300 whitespace-nowrap">{emp.shop}</td><td className="px-4 py-4 text-sm text-slate-200 whitespace-nowrap">{emp.name}</td><td className="px-4 py-4 text-sm text-slate-300 whitespace-nowrap"><span className={`px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${emp.status === 'Resigned' ? 'bg-yellow-100 text-yellow-800' : 'bg-red-100 text-red-800'}`}>{emp.status}</span></td><td className="px-4 py-4 text-sm text-slate-300">{emp.reasonForLeaving}</td><td className="px-4 py-4 text-center whitespace-nowrap">{userProfile?.role === 'Admin' && (<><button onClick={() => handleOpenModal(emp)} className="text-blue-400 hover:text-blue-300 mr-4"><i className="fas fa-edit"></i></button><button onClick={() => setEmployeeToDelete(emp)} className="text-red-500 hover:text-red-400"><i className="fas fa-trash"></i></button></>)}</td></tr>))}</tbody></table></div>
                    {/* Mobile Cards */}
                    <div className="grid grid-cols-1 gap-4 md:hidden">{formerEmployees.map(emp => (<div key={emp.id} className="bg-slate-700/50 rounded-lg p-4 space-y-3"><div className="flex justify-between items-start"><div><p className="font-bold text-lg text-slate-100">{emp.name}</p><p className="text-sm text-slate-300">{emp.shop}</p></div><div className="flex items-center space-x-3"><span className={`px-2 py-1 text-xs font-semibold rounded-full ${emp.status === 'Resigned' ? 'bg-yellow-200 text-yellow-900' : 'bg-red-200 text-red-900'}`}>{emp.status}</span>{userProfile?.role === 'Admin' && (<><button onClick={() => handleOpenModal(emp)} className="text-blue-400 hover:text-blue-300"><i className="fas fa-edit"></i></button><button onClick={() => setEmployeeToDelete(emp)} className="text-red-500 hover:text-red-400"><i className="fas fa-trash"></i></button></>)}</div></div><div className="text-sm pt-2 border-t border-slate-600"><p><span className="text-slate-400">Date: </span><span className="text-slate-200 font-medium">{emp.statusChangeDate || 'N/A'}</span></p><p><span className="text-slate-400">Reason: </span><span className="text-slate-200 font-medium">{emp.reasonForLeaving || 'N/A'}</span></p></div></div>))}</div>
                    <EmployeeModal isOpen={isModalOpen} onClose={handleCloseModal} onSave={handleSaveEmployee} employee={editingEmployee} userProfile={userProfile} />
                    <ConfirmationModal isOpen={!!employeeToDelete} onClose={() => setEmployeeToDelete(null)} onConfirm={handleDeleteConfirm} title="Delete Employee Record" message={`Are you sure you want to permanently delete the record for ${employeeToDelete?.name}? This action cannot be undone.`} />
                </Card>
            );
        };

        const SalaryReviseReportTab = ({ userProfile }) => {
            const { db } = useFirebase();
            const [isModalOpen, setModalOpen] = useState(false);
            const [editingRevision, setEditingRevision] = useState(null);
            const [revisionToDelete, setRevisionToDelete] = useState(null);
            const { where } = window.firebaseSDK;
            
            const queryConstraints = useMemo(() => {
                if (!userProfile) return [where("shopName", "==", "null")];
                if (userProfile.role === 'Admin') return [];
                if (userProfile.role === 'Shop Manager') {
                    const shops = Array.isArray(userProfile.shop) ? userProfile.shop : (userProfile.shop ? [userProfile.shop] : []);
                    if (shops.length > 0) {
                        return [where("shopName", "in", shops)];
                    }
                    return [where("shopName", "==", "null")]; // No shops assigned
                }
                return [where("shopName", "==", userProfile.shop || null)];
            }, [userProfile]);

            const { data: revisions } = useCollection('salaryRevisions', queryConstraints);
            const { data: shops } = useCollection('shops');
            const [selectedShop, setSelectedShop] = useState('');
            const [selectedMonth, setSelectedMonth] = useState(new Date().toISOString().slice(0, 7));

            useEffect(() => {
                if (userProfile && userProfile.role !== 'Admin') {
                    setSelectedShop(Array.isArray(userProfile.shop) ? '' : userProfile.shop || '');
                }
            }, [userProfile]);

            const availableShops = useMemo(() => {
                if (userProfile?.role === 'Admin') return shops;
                if (userProfile?.role === 'Shop Manager' && Array.isArray(userProfile.shop)) {
                    return userProfile.shop.map(name => ({ id: name, name: name }));
                }
                return []; 
            }, [shops, userProfile]);

            const filteredRevisions = useMemo(() => {
                return revisions.filter(rev => 
                    (!selectedShop || rev.shopName === selectedShop) && 
                    (!selectedMonth || rev.date.startsWith(selectedMonth))
                );
            }, [revisions, selectedShop, selectedMonth]);

            const handleOpenModal = useCallback((revision = null) => { setEditingRevision(revision); setModalOpen(true); }, []);
            const handleCloseModal = useCallback(() => { setEditingRevision(null); setModalOpen(false); }, []);

            const handleSaveRevision = useCallback(async (revisionData) => {
                const { doc, updateDoc, addDoc, collection } = window.firebaseSDK;
                // Destructure all needed properties from the incoming data
                const { id, staffId, date, shopName, staffName, reviseAmount, updatedSalary, effectiveDate } = revisionData;

                // Explicitly build the object that will be saved to Firestore.
                // This prevents any temporary or calculated fields (like baseSalary) from being saved.
                const dataToSave = {
                    date,
                    shopName,
                    staffId,
                    staffName,
                    reviseAmount: parseFloat(reviseAmount) || 0,
                    updatedSalary: updatedSalary || 0, // Ensure the crucial field is saved
                    effectiveDate: effectiveDate || date // Default effective date to revision date if not set
                };

                try {
                    if (id) {
                        // If an ID exists, we are updating an existing document
                        await updateDoc(doc(db, 'salaryRevisions', id), dataToSave);
                    } else {
                        // Otherwise, we are adding a new document
                        await addDoc(collection(db, 'salaryRevisions'), dataToSave);
                    }
                    
                    // REMOVED: Immediate update to employee's salary is no longer done here.
                    // The salary will be considered during payroll calculation based on the effective date.
                    
                    handleCloseModal(); // Close the modal on success
                } catch (error) { console.error("Error saving salary revision:", error); }
            }, [db, handleCloseModal]);
            
            const handleDeleteRevision = useCallback(async () => {
                if (!revisionToDelete) return;
                try {
                    await window.firebaseSDK.deleteDoc(window.firebaseSDK.doc(db, 'salaryRevisions', revisionToDelete.id));
                } catch (error) { 
                    console.error("Error deleting revision:", error); 
                } finally {
                    setRevisionToDelete(null);
                }
            }, [db, revisionToDelete]);

            return (
                <Card>
                    <div className="flex flex-wrap gap-4 justify-between items-center mb-6">
                        <h3 className="text-xl font-semibold text-slate-100">Revise Tracking Report</h3>
                        <div className="flex flex-wrap gap-4 items-center">
                            {(userProfile.role === 'Admin' || (userProfile.role === 'Shop Manager' && Array.isArray(userProfile.shop))) && (
                                <select value={selectedShop} onChange={e => setSelectedShop(e.target.value)} className="select w-full sm:w-auto">
                                    <option value="">{userProfile.role === 'Admin' ? 'All Shops' : 'All My Shops'}</option>
                                    {availableShops.map(s => <option key={s.id} value={s.name}>{s.name}</option>)}
                                </select>
                            )}
                            <input type="month" value={selectedMonth} onChange={e => setSelectedMonth(e.target.value)} className="input w-full sm:w-auto" />
                            <button onClick={() => handleOpenModal()} className="bg-blue-600 text-white px-4 py-2 rounded-lg shadow hover:bg-blue-700 transition-colors flex items-center gap-2"><i className="fas fa-plus"></i> Add</button>
                        </div>
                    </div>
                    <div className="overflow-x-auto"><table className="min-w-full divide-y divide-slate-700"><thead className="bg-slate-900/50"><tr><th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Date</th><th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Effective Date</th><th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Staff Name</th><th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Shop Name</th><th className="px-4 py-3 text-right text-xs font-semibold text-slate-400 uppercase">Amount Revised</th><th className="px-4 py-3 text-right text-xs font-semibold text-slate-400 uppercase">Updated Salary</th><th className="px-4 py-3 text-center text-xs font-semibold text-slate-400 uppercase">Actions</th></tr></thead><tbody className="divide-y divide-slate-700">{filteredRevisions.map(rev => (<tr key={rev.id} className="hover:bg-slate-700/50"><td className="px-4 py-4 text-sm text-slate-200">{rev.date}</td><td className="px-4 py-4 text-sm font-semibold text-blue-300">{rev.effectiveDate}</td><td className="px-4 py-4 text-sm text-slate-200">{rev.staffName}</td><td className="px-4 py-4 text-sm text-slate-300">{rev.shopName}</td><td className={`px-4 py-4 text-sm text-right font-semibold ${parseFloat(rev.reviseAmount) < 0 ? 'text-red-400' : 'text-blue-400'}`}>{Utils.formatCurrency(rev.reviseAmount)}</td><td className="px-4 py-4 text-sm text-slate-300 text-right">{Utils.formatCurrency(rev.updatedSalary)}</td><td className="px-4 py-4 text-center whitespace-nowrap"><button onClick={() => handleOpenModal(rev)} className="text-blue-400 hover:text-blue-300 mr-4"><i className="fas fa-edit"></i></button><button onClick={() => setRevisionToDelete(rev)} className="text-red-500 hover:text-red-400"><i className="fas fa-trash"></i></button></td></tr>))}</tbody></table></div>
                    <SalaryReviseModal isOpen={isModalOpen} onClose={handleCloseModal} onSave={handleSaveRevision} revision={editingRevision} />
                    <ConfirmationModal isOpen={!!revisionToDelete} onClose={() => setRevisionToDelete(null)} onConfirm={handleDeleteRevision} title="Delete Salary Revision" message="Are you sure you want to delete this revision record? This action cannot be undone."/>
                </Card>
            );
        };

        const SalaryReviseModal = ({ isOpen, onClose, onSave, revision }) => {
            const [formData, setFormData] = useState({});
            const { data: shops } = useCollection('shops');
            const { data: employees } = useCollection('employees');
            const [selectedShop, setSelectedShop] = useState('');

            useEffect(() => {
                const today = new Date().toISOString().substring(0, 10);
                const initialData = revision 
                    ? { ...revision, effectiveDate: revision.effectiveDate || revision.date } 
                    : { date: today, effectiveDate: today, shopName: '', staffId: '', reviseAmount: '' };
                setFormData(initialData);
                setSelectedShop(initialData.shopName);
            }, [revision, isOpen]);

            const employeesInShop = useMemo(() => employees.filter(emp => emp.status === 'Active' && (Array.isArray(emp.shop) ? emp.shop.includes(selectedShop) : emp.shop === selectedShop)), [selectedShop, employees]);
            const selectedEmployee = useMemo(() => employees.find(emp => emp.id === formData.staffId), [formData.staffId, employees]);
            const baseSalary = selectedEmployee ? selectedEmployee.salary : 0;
            
            // Robust calculation to prevent errors with empty inputs
            const updatedSalary = useMemo(() => {
                const base = parseFloat(String(baseSalary).replace(/[^0-9.-]/g, '')) || 0;
                const revisionAmount = parseFloat(formData.reviseAmount) || 0; // Treat empty/invalid input as 0
                return base + revisionAmount;
            }, [baseSalary, formData.reviseAmount]);
            
            const handleChange = useCallback((e) => {
                const { name, value } = e.target;
                setFormData(prev => ({ ...prev, [name]: value }));
                if (name === 'shopName') { setSelectedShop(value); setFormData(prev => ({ ...prev, staffId: '' })); }
            }, []);
            
            const handleSubmit = useCallback((e) => {
                e.preventDefault();
                const staffName = selectedEmployee?.name || '';
                onSave({ ...formData, baseSalary, updatedSalary, staffName });
            }, [onSave, formData, selectedEmployee, baseSalary, updatedSalary]);

            return (
                <Modal isOpen={isOpen} onClose={onClose} maxWidth="max-w-2xl">
                    <form onSubmit={handleSubmit}>
                        <ModalHeader title={revision ? "Edit Salary Revision" : "New Salary Revision"} onClose={onClose} />
                        <ModalBody>
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div><label className="text-sm font-medium text-slate-400">Date</label><input type="date" name="date" value={formData.date || ''} onChange={handleChange} className="input" /></div>
                                <div><label className="text-sm font-medium text-slate-400">Effective Date</label><input type="date" name="effectiveDate" value={formData.effectiveDate || ''} onChange={handleChange} className="input" /></div>
                                <div><label className="text-sm font-medium text-slate-400">Shop Name</label><select name="shopName" value={formData.shopName || ''} onChange={handleChange} className="select"><option value="">Select Shop</option>{shops.map(s => <option key={s.id} value={s.name}>{s.name}</option>)}</select></div>
                                <div><label className="text-sm font-medium text-slate-400">Staff Name</label><select name="staffId" value={formData.staffId || ''} onChange={handleChange} className="select" disabled={!selectedShop}><option value="">Select Staff</option>{employeesInShop.map(e => <option key={e.id} value={e.id}>{e.name}</option>)}</select></div>
                                <div className="md:col-span-2"><label className="text-sm font-medium text-slate-400">Amount to Revise</label><input type="number" name="reviseAmount" value={formData.reviseAmount || ''} onChange={handleChange} className="input" /></div>
                                <div className="bg-slate-700/50 p-4 rounded-lg"><label className="text-sm font-medium text-slate-400">Base Salary</label><input value={Utils.formatCurrency(baseSalary)} className="input mt-1" disabled /></div>
                                <div className="bg-slate-700/50 p-4 rounded-lg"><label className="text-sm font-medium text-slate-400">Updated Salary</label><input value={Utils.formatCurrency(updatedSalary)} className="input mt-1" disabled /></div>
                            </div>
                        </ModalBody>
                        <ModalFooter><button type="button" onClick={onClose} className="bg-slate-600 text-slate-200 px-4 py-2 rounded-lg hover:bg-slate-500">Cancel</button><button type="submit" className="bg-blue-600 text-white px-6 py-2 rounded-lg shadow hover:bg-blue-700">Submit</button></ModalFooter>
                    </form>
                </Modal>
            );
        };
        
        // --- END EMPLOYEES PAGE ---

        // --- START CHECKINME PAGE ---
        const CheckInMePage = ({ userProfile, initialTab = 'checkInOut' }) => {
            const [activeTab, setActiveTab] = useState(initialTab);

            useEffect(() => {
                setActiveTab(initialTab);
            }, [initialTab]);

            return (
                <TabbedPage tabs={{ checkInOut: 'Check In/Out', leaveRequest: 'Leave Request', otRequest: 'OT Request' }} activeTab={activeTab} setActiveTab={setActiveTab}>
                    <div id="checkInOut"><CheckInOutTab userProfile={userProfile} /></div>
                    <div id="leaveRequest"><LeaveRequestTab userProfile={userProfile}/></div>
                    <div id="otRequest"><OTRequestTab userProfile={userProfile}/></div>
                </TabbedPage>
            );
        };

        const CheckInOutTab = ({ userProfile }) => {
            const { db } = useFirebase();
            const [currentTime, setCurrentTime] = useState(new Date());
            const [location, setLocation] = useState(null);
            const [status, setStatus] = useState('Getting your location...');
            const [loading, setLoading] = useState(false);
            const [distance, setDistance] = useState(null);
            const [selectedShopForCheckIn, setSelectedShopForCheckIn] = useState('');
            
            const { data: shops } = useCollection('shops');
            const { data: attendance } = useCollection('attendance');
            
            const isMultiShopManager = userProfile.role === 'Shop Manager' && Array.isArray(userProfile.shop);

            // Set the default shop for check-in
            useEffect(() => {
                if (!isMultiShopManager) {
                    setSelectedShopForCheckIn(userProfile.shop);
                }
            }, [userProfile, isMultiShopManager]);

            const userShop = useMemo(() => {
                if (!selectedShopForCheckIn) return null;
                return shops.find(s => s.name === selectedShopForCheckIn);
            }, [selectedShopForCheckIn, shops]);

            const today = useMemo(() => new Date().toISOString().split('T')[0], []);
            const userAttendanceToday = useMemo(() => attendance.filter(a => a.employeeId === userProfile.id && a.timestamp?.toDate().toISOString().startsWith(today)).sort((a, b) => b.timestamp?.toDate() - a.timestamp?.toDate()), [userProfile, attendance, today]);
            const lastAction = userAttendanceToday[0] || null;

            // Update time every second
            useEffect(() => { const timerId = setInterval(() => setCurrentTime(new Date()), 1000); return () => clearInterval(timerId); }, []);
            
            // Get user's location and check distance from shop
            const getLocation = useCallback(() => {
                if (!userShop) { 
                    setStatus(isMultiShopManager ? "Please select a shop to enable check-in." : "Your assigned shop could not be found."); 
                    return; 
                }
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const { latitude, longitude } = position.coords;
                        setLocation({ latitude, longitude });
                        const dist = Utils.getDistance(latitude, longitude, parseFloat(userShop.latitude), parseFloat(userShop.longitude));
                        setDistance(dist);
                        setStatus(dist > (parseFloat(userShop.radius) || 500) 
                            ? `You are ${Math.round(dist)}m from the shop. Check-in is disabled.`
                            : `You are ${Math.round(dist)}m from the shop. Check-in is enabled.`
                        );
                    },
                    (error) => setStatus(error.code === 1 ? "Location permission denied." : "Could not get your location."), 
                    { enableHighAccuracy: true }
                );
            }, [userShop, isMultiShopManager]);

            // Periodically refresh location
            useEffect(() => { 
                getLocation(); 
                const interval = setInterval(getLocation, 30000); 
                return () => clearInterval(interval); 
            }, [getLocation]);

            const handleCheckAction = useCallback(async () => {
                if (!location || !userShop || distance > (userShop.radius || 500)) { setStatus("Cannot check-in. You are not within the allowed radius."); return; }
                setLoading(true);
                const { addDoc, collection, serverTimestamp } = window.firebaseSDK;
                const nextActionType = lastAction?.type === 'in' ? 'out' : 'in';
                try {
                    const checkInTimestamp = new Date();
                    await addDoc(collection(db, 'attendance'), { employeeId: userProfile.id, employeeName: userProfile.name, shop: selectedShopForCheckIn, timestamp: serverTimestamp(), type: nextActionType, location });
                    
                    // Logic for automatic late deduction
                    if (nextActionType === 'in') {
                        const shift = userProfile.shift || 'AM';
                        const checkInHour = checkInTimestamp.getHours(); 
                        const checkInMinute = checkInTimestamp.getMinutes();
                        // Late if after 7:35 AM for AM/APM shifts, or after 12:35 PM for PM shifts
                        let isLate = (shift === 'AM' || shift === 'APM') ? (checkInHour > 7 || (checkInHour === 7 && checkInMinute >= 35)) : (shift === 'PM') ? (checkInHour > 12 || (checkInHour === 12 && checkInMinute >= 35)) : false;
                        
                        if (isLate) {
                            const todayStr = checkInTimestamp.toISOString().split('T')[0];
                            const formattedTime = checkInTimestamp.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: true });
                            // Create a deduction record in Firestore
                            await addDoc(collection(db, 'employeeStates'), { 
                                staffId: userProfile.id, 
                                staffName: userProfile.name, 
                                shop: selectedShopForCheckIn, 
                                date: todayStr, 
                                statusState: 'Deduction', 
                                amount: 5000, 
                                note: `CheckIn Late @${formattedTime}`
                            });
                        }
                    }
                    setStatus(`Successfully checked ${nextActionType} at ${checkInTimestamp.toLocaleTimeString()}`);
                } catch (error) { console.error("Error recording attendance:", error); setStatus("Failed to record attendance."); }
                setLoading(false);
            }, [db, location, userShop, distance, lastAction, userProfile, selectedShopForCheckIn]);

            const canCheck = distance !== null && userShop && distance <= (parseFloat(userShop.radius) || 500);

            return (
                <Card className="max-w-2xl mx-auto"><div className="flex flex-col items-center justify-center p-4 sm:p-8 space-y-8">
                    <div className="text-center">
                        <p className="text-4xl sm:text-7xl font-bold text-slate-100 tracking-wider">{currentTime.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: true })}</p>
                        <p className="text-xl text-slate-400 mt-2">{currentTime.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}</p>
                    </div>
                    {isMultiShopManager && (
                        <div className="w-full max-w-md">
                            <label className="text-sm font-medium text-slate-400">Select Shop for Check-in</label>
                            <select value={selectedShopForCheckIn} onChange={e => setSelectedShopForCheckIn(e.target.value)} className="select">
                                <option value="">-- Select Your Shop --</option>
                                {userProfile.shop.map(shopName => <option key={shopName} value={shopName}>{shopName}</option>)}
                            </select>
                        </div>
                    )}
                    <div className="flex gap-4"><button onClick={handleCheckAction} disabled={lastAction?.type === 'in' || !canCheck || loading} className={`px-8 py-3 text-lg font-semibold rounded-lg shadow-md transition-colors transform hover:scale-105 ${lastAction?.type === 'in' || !canCheck || loading ? 'bg-slate-700 text-slate-500 cursor-not-allowed' : 'bg-green-600 text-white hover:bg-green-700'}`}>{loading && lastAction?.type !== 'in' ? <i className="fas fa-spinner fa-spin"></i> : 'Check In'}</button><button onClick={handleCheckAction} disabled={lastAction?.type !== 'in' || !canCheck || loading} className={`px-8 py-3 text-lg font-semibold rounded-lg shadow-md transition-colors transform hover:scale-105 ${lastAction?.type !== 'in' || !canCheck || loading ? 'bg-slate-700 text-slate-500 cursor-not-allowed' : 'bg-slate-600 text-white hover:bg-slate-500'}`}>{loading && lastAction?.type === 'in' ? <i className="fas fa-spinner fa-spin"></i> : 'Check Out'}</button></div><div className={`p-4 rounded-lg text-center w-full max-w-md ${canCheck ? 'bg-green-900/50 border-green-700' : 'bg-red-900/50 border-red-700'} border`}><p className="font-medium text-lg text-slate-100">{status}</p></div><div className="text-center text-sm text-slate-400"><p>Welcome, <span className="font-bold text-slate-200">{userProfile?.name}</span></p><p>Your selected shop is <span className="font-bold text-slate-200">{selectedShopForCheckIn || 'N/A'}</span></p>{lastAction && (<p className="mt-2">Last action: Checked <span className="font-semibold text-slate-200">{lastAction.type}</span> at <span className="font-semibold text-slate-200">{lastAction.timestamp?.toDate().toLocaleTimeString()}</span></p>)}</div></div></Card>
            );
        };

        const LeaveRequestModal = ({ isOpen, onClose, onSave, request, userProfile }) => {
            const [formData, setFormData] = useState({});
            
            const isMultiShopStaff = useMemo(() => Array.isArray(userProfile?.shop), [userProfile]);
            
            useEffect(() => {
                const initialData = request 
                    ? { ...request } 
                    : (userProfile 
                        ? { 
                            leaveDate: new Date().toISOString().substring(0, 10), 
                            returnDate: new Date().toISOString().substring(0, 10),
                            shop: isMultiShopStaff ? '' : (userProfile.shop || ''), 
                            staffId: userProfile.id || '', 
                            supervisor: userProfile.supervisor || '', 
                            numberOfDays: 1, 
                            leaveSession: 'Full Day',
                            leaveType: 'Annual Leave',
                            reason: '' 
                          } 
                        : {});
                setFormData(initialData);
            }, [request, userProfile, isOpen, isMultiShopStaff]);

            const dateDiffInDays = useMemo(() => {
                if (formData.leaveDate && formData.returnDate) {
                    const start = new Date(formData.leaveDate);
                    const end = new Date(formData.returnDate);
                    if (end <= start) return 0;
                    const diffTime = end.getTime() - start.getTime();
                    return Math.round(diffTime / (1000 * 60 * 60 * 24));
                }
                return 0;
            }, [formData.leaveDate, formData.returnDate]);

            const isMultiDayLeave = dateDiffInDays > 1;

            const handleChange = useCallback((e) => {
                const { name, value } = e.target;
                const newFormData = { ...formData, [name]: value };

                // Recalculate days based on dates and session.
                const { leaveDate, returnDate, leaveSession } = newFormData;

                if (leaveDate && returnDate) {
                    const start = new Date(leaveDate);
                    const end = new Date(returnDate);
                    start.setHours(0, 0, 0, 0); // Normalize to avoid timezone issues
                    end.setHours(0, 0, 0, 0);

                    if (end < start) {
                        newFormData.numberOfDays = 0;
                    } else {
                        const diffTime = end.getTime() - start.getTime();
                        const diffDays = Math.round(diffTime / (1000 * 60 * 60 * 24));

                        // Case: User selects same leave and return date. We interpret this as a single-day event.
                        if (diffDays === 0) {
                            if (leaveSession === 'Full Day') { newFormData.numberOfDays = 1; } 
                            else { newFormData.numberOfDays = 0.5; }
                        } 
                        // Case: Standard single day leave (e.g., leave Mon, return Tue)
                        else if (diffDays === 1) {
                            if (leaveSession === 'Full Day') { newFormData.numberOfDays = 1; } 
                            else { newFormData.numberOfDays = 0.5; }
                        } 
                        // Case: Multi-day leave
                        else {
                            newFormData.numberOfDays = diffDays;
                            newFormData.leaveSession = 'Full Day'; // Force full day for multi-day leaves
                        }
                    }
                } else {
                    newFormData.numberOfDays = 0;
                }
                
                setFormData(newFormData);
            }, [formData]);
            
            const handleSubmit = useCallback((e) => { 
                e.preventDefault(); 
                if (isMultiShopStaff && !formData.shop) {
                    alert("Please select a shop for the leave request.");
                    return;
                }
                const dataToSave = { ...formData };
                // If leave date and return date are the same, it implies a single day of leave.
                // The attendance report logic requires returnDate to be the day *after* the leave ends.
                // So, we adjust the returnDate before saving to ensure report accuracy.
                if (dataToSave.leaveDate && dataToSave.leaveDate === dataToSave.returnDate) {
                    const returnDate = new Date(dataToSave.returnDate);
                    returnDate.setDate(returnDate.getDate() + 1);
                    dataToSave.returnDate = returnDate.toISOString().substring(0, 10);
                }
                onSave(dataToSave); 
            }, [onSave, formData, isMultiShopStaff]);
            
            return (
                <Modal isOpen={isOpen} onClose={onClose} maxWidth="max-w-4xl">
                    <form onSubmit={handleSubmit}>
                        <ModalHeader title={request ? "Edit Leave Request" : "New Leave Request"} onClose={onClose} />
                        <ModalBody>
                            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                <div><label className="text-sm">Leave Date</label><input type="date" name="leaveDate" value={formData.leaveDate || ''} onChange={handleChange} className="input" required /></div>
                                <div><label className="text-sm">Return Date</label><input type="date" name="returnDate" value={formData.returnDate || ''} onChange={handleChange} className="input" required /></div>
                                
                                <div>
                                    <label className="text-sm">Session</label>
                                    <select name="leaveSession" value={formData.leaveSession || 'Full Day'} onChange={handleChange} className="select" disabled={isMultiDayLeave}>
                                        <option value="Full Day">Full Day</option>
                                        <option value="AM">AM (Morning)</option>
                                        <option value="PM">PM (Afternoon)</option>
                                    </select>
                                </div>
                                <div>
                                    <label className="text-sm">No. Day(s)</label>
                                    <input 
                                        type="number"
                                        name="numberOfDays" 
                                        value={formData.numberOfDays || ''} 
                                        className="input" required 
                                        disabled
                                    />
                                </div>
                                
                                {isMultiShopStaff ? (
                                    <div>
                                        <label className="text-sm">Shop Name</label>
                                        <select name="shop" value={formData.shop || ''} onChange={handleChange} className="select" required>
                                            <option value="">Select Shop</option>
                                            {(userProfile.shop || []).map(shopName => <option key={shopName} value={shopName}>{shopName}</option>)}
                                        </select>
                                    </div>
                                ) : (
                                    <div><label className="text-sm">Shop Name</label><input value={formData.shop || ''} className="input" disabled /></div>
                                )}
                                <div><label className="text-sm">Staff Name</label><input value={userProfile?.name || ''} className="input" disabled /></div>
                                <div><label className="text-sm">Supervisor</label><input value={formData.supervisor || ''} className="input" disabled /></div>

                                <div className="lg:col-span-3"><label className="text-sm">Leave Type</label>
                                    <select name="leaveType" value={formData.leaveType || 'Annual Leave'} onChange={handleChange} className="select" required>
                                        <option>Relaxing Leave</option>
                                        <option>Sick Leave</option>
                                        <option>Emergency Leave</option>
                
                                    </select>
                                </div>
                                <div className="lg:col-span-3"><label className="text-sm">Reason</label><textarea name="reason" value={formData.reason || ''} onChange={handleChange} className="input" rows="3" required></textarea></div>
                            </div>
                        </ModalBody>
                        <ModalFooter>
                            <button type="button" onClick={onClose} className="bg-slate-600 text-slate-200 px-4 py-2 rounded-lg hover:bg-slate-500">Cancel</button>
                            <button type="submit" className="bg-blue-600 text-white px-6 py-2 rounded-lg shadow hover:bg-blue-700">Submit Request</button>
                        </ModalFooter>
                    </form>
                </Modal>
            );
        };

        const LeaveRequestTab = ({ userProfile }) => {
            const { db } = useFirebase();
            const [isModalOpen, setModalOpen] = useState(false);
            const [editingRequest, setEditingRequest] = useState(null);
            const [requestToDelete, setRequestToDelete] = useState(null);
            const [reasonToView, setReasonToView] = useState(null);
            const { where } = window.firebaseSDK;
            const { data: shops } = useCollection('shops');
            const { data: employees } = useCollection('employees');
            const [selectedShop, setSelectedShop] = useState('');
            const [filterPeriod, setFilterPeriod] = useState('thisMonth');
            const [customDate, setCustomDate] = useState(new Date().toISOString().slice(0, 10));
            const [selectedEmployeeId, setSelectedEmployeeId] = useState('');

            useEffect(() => {
                if (userProfile && userProfile.role !== 'Admin') {
                    setSelectedShop(Array.isArray(userProfile.shop) ? '' : userProfile.shop || '');
                }
            }, [userProfile]);

            const queryConstraints = useMemo(() => {
                if (!userProfile) return [where("staffId", "==", "null")];
                if (userProfile.role === 'Admin') return [];
                if (userProfile.role === 'Shop Manager') {
                    // Normalize shop to an array for the 'in' query.
                    const shops = Array.isArray(userProfile.shop) ? userProfile.shop : (userProfile.shop ? [userProfile.shop] : []);
                    if (shops.length > 0) {
                        return [where("shop", "in", shops)];
                    }
                    return [where("staffId", "==", "null")]; // No shops assigned, so return no requests.
                }
                return [where("staffId", "==", userProfile.id)];
            }, [userProfile]);
            const { data: leaveRequests } = useCollection('leaveRequests', queryConstraints);
            
            const employeesInShop = useMemo(() => {
                if (!selectedShop) return [];
                return employees.filter(emp => emp.shop === selectedShop && emp.status === 'Active');
            }, [selectedShop, employees]);

            const { pendingRequests, historyRequests } = useMemo(() => {
                const filtered = leaveRequests.filter(req => {
                    if (!req.leaveDate) return false;

                    const now = new Date();
                    let dateMatch = false;

                    switch (filterPeriod) {
                        case 'thisWeek':
                            const startOfWeek = new Date(now);
                            startOfWeek.setDate(now.getDate() - now.getDay()); // Sunday
                            startOfWeek.setHours(0, 0, 0, 0);
                            
                            const endOfWeek = new Date(startOfWeek);
                            endOfWeek.setDate(startOfWeek.getDate() + 6);
                            endOfWeek.setHours(23, 59, 59, 999);

                            const leaveDate = new Date(req.leaveDate);
                            dateMatch = leaveDate >= startOfWeek && leaveDate <= endOfWeek;
                            break;
                        case 'thisMonth':
                            dateMatch = req.leaveDate.startsWith(new Date().toISOString().slice(0, 7));
                            break;
                        case 'lastMonth':
                            const lastMonthDate = new Date();
                            lastMonthDate.setMonth(lastMonthDate.getMonth() - 1);
                            dateMatch = req.leaveDate.startsWith(lastMonthDate.toISOString().slice(0, 7));
                            break;
                        case 'thisYear':
                            dateMatch = req.leaveDate.startsWith(new Date().getFullYear().toString());
                            break;
                        case 'custom':
                            dateMatch = req.leaveDate === customDate;
                            break;
                        default:
                            dateMatch = true;
                    }

                    return dateMatch &&
                        (!selectedShop || req.shop === selectedShop) &&
                        (!selectedEmployeeId || req.staffId === selectedEmployeeId);
                });

                const pending = filtered.filter(req => req.status === 'Pending').sort((a, b) => (b.requestDate?.toDate() || 0) - (a.requestDate?.toDate() || 0));
                const history = filtered.filter(req => req.status !== 'Pending').sort((a, b) => {
                    // Primary sort: shop name (alphabetical)
                    if ((a.shop || '') < (b.shop || '')) return -1;
                    if ((a.shop || '') > (b.shop || '')) return 1;
                    // Secondary sort: request date (newest first)
                    return (b.requestDate?.toDate() || 0) - (a.requestDate?.toDate() || 0);
                });

                return {
                    pendingRequests: pending,
                    historyRequests: history
                };
            }, [leaveRequests, selectedShop, selectedEmployeeId, filterPeriod, customDate]);
            
            const handleOpenModal = useCallback((request = null) => { setEditingRequest(request); setModalOpen(true); }, []);
            const handleCloseModal = useCallback(() => { setEditingRequest(null); setModalOpen(false); }, []);
            const handleSaveRequest = useCallback(async (formData) => {
                const { doc, addDoc, updateDoc, collection, serverTimestamp } = window.firebaseSDK;
                const staffName = employees.find(e => e.id === formData.staffId)?.name || '';
                try {
                    if (formData.id) { const { id, ...dataToUpdate } = formData; await updateDoc(doc(db, 'leaveRequests', id), { ...dataToUpdate, staffName }); } 
                    else { await addDoc(collection(db, 'leaveRequests'), { ...formData, staffName, requestDate: serverTimestamp(), status: 'Pending' }); }
                    handleCloseModal();
                } catch (error) { console.error("Error saving leave request:", error); }
            }, [db, employees, handleCloseModal]);
            const handleUpdateRequestStatus = useCallback(async (id, status) => { try { await window.firebaseSDK.updateDoc(window.firebaseSDK.doc(db, 'leaveRequests', id), { status }); } catch (error) { console.error(`Error updating status for request ${id}:`, error); } }, [db]);
            const confirmDelete = useCallback(async () => { if (requestToDelete) { try { await window.firebaseSDK.deleteDoc(window.firebaseSDK.doc(db, 'leaveRequests', requestToDelete)); } catch (error) { console.error(`Error deleting request ${requestToDelete}:`, error); } finally { setRequestToDelete(null); } } }, [db, requestToDelete]);
            
            return (
                <Card>
                    <div className="flex flex-wrap gap-4 justify-between items-center mb-6">
                        <h3 className="text-xl font-semibold text-slate-100">Leave Requests</h3>
                        <div className="flex flex-wrap gap-4 items-center">
                            {(userProfile.role === 'Admin' || (userProfile.role === 'Shop Manager' && Array.isArray(userProfile.shop))) && (
                                <select value={selectedShop} onChange={e => { setSelectedShop(e.target.value); setSelectedEmployeeId(''); }} className="select w-full sm:w-auto">
                                    <option value="">{userProfile.role === 'Admin' ? 'All Shops' : 'All My Shops'}</option>
                                    {(userProfile.role === 'Admin' ? shops : (userProfile.shop || []).map(name => ({ id: name, name: name }))).map(s => <option key={s.id} value={s.name}>{s.name}</option>)}
                                </select>
                            )}
                            {(userProfile.role === 'Admin' || userProfile.role === 'Shop Manager') && selectedShop && (
                                <select value={selectedEmployeeId} onChange={e => setSelectedEmployeeId(e.target.value)} className="select w-full sm:w-auto">
                                    <option value="">All Staff</option>
                                    {employeesInShop.map(e => <option key={e.id} value={e.id}>{e.name}</option>)}
                                </select>
                            )}
                            {(userProfile.role === 'Admin' || userProfile.role === 'Shop Manager') && (
                                <select value={filterPeriod} onChange={e => setFilterPeriod(e.target.value)} className="select w-full sm:w-auto">
                                    <option value="thisWeek">This Week</option>
                                    <option value="thisMonth">This Month</option>
                                    <option value="lastMonth">Last Month</option>
                                    <option value="thisYear">This Year</option>
                                    <option value="custom">Custom Date</option>
                                </select>
                            )}
                            {filterPeriod === 'custom' && (
                                <input type="date" value={customDate} onChange={e => setCustomDate(e.target.value)} className="input w-full sm:w-auto" />
                            )}
                            <button onClick={() => handleOpenModal()} className="bg-blue-600 text-white px-4 py-2 rounded-lg shadow hover:bg-blue-700 transition-colors flex items-center gap-2"><i className="fas fa-plus"></i> New Request</button>
                        </div>
                    </div>

                    {pendingRequests.length > 0 && (
                        <div className="mb-8">
                            <h4 className="text-lg font-semibold text-slate-200 mb-4">Pending Requests</h4>
                            <div className="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-4">
                                {pendingRequests.map(req => (<div key={req.id} className="bg-slate-700/50 rounded-lg p-4 space-y-3 flex flex-col"><div className="flex justify-between items-start"><div><p className="font-bold text-lg text-slate-100">{req.staffName}</p><p className="text-sm text-slate-300">{req.shop}</p></div><span className={`px-2 py-1 text-xs font-semibold rounded-full bg-yellow-200 text-yellow-900`}>{req.status}</span></div><div className="grid grid-cols-2 gap-x-4 gap-y-2 text-sm pt-2 border-t border-slate-600 flex-grow"><div><p className="text-slate-400">Leave Date</p><p className="text-slate-200 font-medium">{Utils.formatISOToDisplay(req.leaveDate)}</p></div><div><p className="text-slate-400">Return Date</p><p className="text-slate-200 font-medium">{Utils.formatISOToDisplay(req.returnDate)}</p></div><div><p className="text-slate-400">Days</p><p className="text-slate-200 font-medium">{req.numberOfDays}</p></div><div><p className="text-slate-400">Session</p><p className="text-slate-200 font-medium">{req.leaveSession || '-'}</p></div><div><p className="text-slate-400">Supervisor</p><p className="text-slate-200 font-medium">{req.supervisor}</p></div><div><p className="text-slate-400">Submitted</p><p className="text-slate-200 font-medium">{Utils.formatRequestDate(req.requestDate)}</p></div><div><p className="text-slate-400">Type</p><p className="text-slate-200 font-medium">{req.leaveType}</p></div><div><p className="text-slate-400">Reason</p><p className="text-slate-200 font-medium whitespace-pre-wrap">{req.reason}</p></div></div><div className="flex justify-end space-x-3 pt-2">{(userProfile?.role === 'Admin' || (userProfile?.role === 'Shop Manager' && userProfile.id !== req.staffId)) && req.status === 'Pending' && (<><button onClick={() => handleUpdateRequestStatus(req.id, 'Approved')} className="text-green-400 hover:text-green-300" title="Approve"><i className="fas fa-check-circle fa-lg"></i></button><button onClick={() => handleUpdateRequestStatus(req.id, 'Rejected')} className="text-orange-400 hover:text-orange-300" title="Reject"><i className="fas fa-times-circle fa-lg"></i></button></>)}<button onClick={() => handleOpenModal(req)} className="text-indigo-400 hover:text-indigo-300" title="Edit"><i className="fas fa-edit fa-lg"></i></button><button onClick={() => setRequestToDelete(req.id)} className="text-red-400 hover:text-red-300" title="Delete"><i className="fas fa-trash fa-lg"></i></button></div></div>))}
                            </div>
                        </div>
                    )}

                    <div>
                        <h4 className="text-lg font-semibold text-slate-200 mb-4">Leave History</h4>
                        <div className="overflow-x-auto">
                            <table className="min-w-full divide-y divide-slate-700">
                                <thead className="bg-slate-900/50">
                                    <tr>
                                        <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Request Date</th>
                                        <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Shop</th>
                                        <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Name</th>
                                        <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Leave Date</th>
                                        <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Return Date</th>
                                        <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">No. Days</th>
                                        <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Session</th>
                                        <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Leave Type</th>
                                        <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Supervisor</th>
                                        <th className="px-4 py-3 text-center text-xs font-semibold text-slate-400 uppercase">Reason</th>
                                        <th className="px-4 py-3 text-center text-xs font-semibold text-slate-400 uppercase">Status</th>
                                        <th className="px-4 py-3 text-center text-xs font-semibold text-slate-400 uppercase">Actions</th>
                                    </tr>
                                </thead>
                                <tbody className="divide-y divide-slate-700">
                                    {historyRequests.map(req => (
                                        <tr key={req.id} className="hover:bg-slate-700/50">
                                            <td className="px-4 py-4 text-sm text-slate-300">{Utils.formatRequestDate(req.requestDate)}</td>
                                            <td className="px-4 py-4 text-sm text-slate-300">{req.shop}</td>
                                            <td className="px-4 py-4 text-sm text-slate-200">{req.staffName}</td>
                                            <td className="px-4 py-4 text-sm text-slate-300">{Utils.formatISOToDisplay(req.leaveDate)}</td>
                                            <td className="px-4 py-4 text-sm text-slate-300">{Utils.formatISOToDisplay(req.returnDate)}</td>
                                            <td className="px-4 py-4 text-sm text-slate-300">{req.numberOfDays}</td>
                                            <td className="px-4 py-4 text-sm text-slate-300">{req.leaveSession || '-'}</td>
                                            <td className="px-4 py-4 text-sm text-slate-300">{req.leaveType}</td>
                                            <td className="px-4 py-4 text-sm text-slate-300">{req.supervisor}</td>
                                            <td className="px-4 py-4 text-center text-sm"><button onClick={() => setReasonToView(req.reason)} className="text-blue-400 hover:text-blue-300"><i className="fas fa-eye"></i></button></td>
                                            <td className="px-4 py-4 text-center text-sm"><span className={`px-2 py-1 text-xs font-semibold rounded-full ${req.status === 'Approved' ? 'bg-green-200 text-green-900' : 'bg-red-200 text-red-900'}`}>{req.status}</span></td>
                                            <td className="px-4 py-4 text-center whitespace-nowrap">
                                                <button onClick={() => handleOpenModal(req)} className="text-indigo-400 hover:text-indigo-300 mx-2" title="Edit"><i className="fas fa-edit"></i></button>
                                                <button onClick={() => setRequestToDelete(req.id)} className="text-red-400 hover:text-red-300" title="Delete"><i className="fas fa-trash"></i></button>
                                            </td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <LeaveRequestModal isOpen={isModalOpen} onClose={handleCloseModal} onSave={handleSaveRequest} request={editingRequest} userProfile={userProfile} />
                    <ConfirmationModal isOpen={!!requestToDelete} onClose={() => setRequestToDelete(null)} onConfirm={confirmDelete} title="Delete Leave Request" message="Are you sure you want to permanently delete this leave request?" />
                    <Modal isOpen={!!reasonToView} onClose={() => setReasonToView(null)} maxWidth="max-w-md">
                        <ModalHeader title="Leave Request Reason" onClose={() => setReasonToView(null)} />
                        <ModalBody>
                            <p className="text-slate-300">{reasonToView}</p>
                        </ModalBody>
                        <ModalFooter>
                            <button onClick={() => setReasonToView(null)} className="bg-slate-600 text-slate-200 px-4 py-2 rounded-lg hover:bg-slate-500">Close</button>
                        </ModalFooter>
                    </Modal>
                </Card>
            );
        };
        
        const OTRequestTab = ({ userProfile }) => {
            const { db } = useFirebase();
            const [isModalOpen, setModalOpen] = useState(false);
            const [editingRequest, setEditingRequest] = useState(null);
            const [requestToDelete, setRequestToDelete] = useState(null);
            const [reasonToView, setReasonToView] = useState(null);
            const { where } = window.firebaseSDK;
            const { data: shops } = useCollection('shops');
            const { data: employees } = useCollection('employees');
            const [selectedShop, setSelectedShop] = useState('');
            const [filterPeriod, setFilterPeriod] = useState('thisMonth');
            const [customDate, setCustomDate] = useState(new Date().toISOString().slice(0, 10));
            const [selectedEmployeeId, setSelectedEmployeeId] = useState('');

            const queryConstraints = useMemo(() => {
                if (!userProfile) return [where("staffId", "==", "null")];
                if (userProfile.role === 'Admin') return [];
                if (userProfile.role === 'Shop Manager') {
                    // Normalize shop to an array for the 'in' query.
                    const shops = Array.isArray(userProfile.shop) ? userProfile.shop : (userProfile.shop ? [userProfile.shop] : []);
                    if (shops.length > 0) {
                        return [where("shop", "in", shops)];
                    }
                    return [where("staffId", "==", "null")]; // No shops assigned, so return no requests.
                }
                return [where("staffId", "==", userProfile.id)];
            }, [userProfile]);
            const { data: otRequests } = useCollection('otRequests', queryConstraints);
            
            const employeesInShop = useMemo(() => {
                if (!selectedShop) return [];
                return employees.filter(emp => emp.shop === selectedShop && emp.status === 'Active');
            }, [selectedShop, employees]);

            const { pendingRequests, historyRequests } = useMemo(() => {
                const filtered = otRequests.filter(req => {
                    if (!req.reqDate) return false;

                    const now = new Date();
                    let dateMatch = false;

                    switch (filterPeriod) {
                        case 'thisWeek':
                            const startOfWeek = new Date(now);
                            startOfWeek.setDate(now.getDate() - now.getDay()); // Sunday
                            startOfWeek.setHours(0, 0, 0, 0);
                            
                            const endOfWeek = new Date(startOfWeek);
                            endOfWeek.setDate(startOfWeek.getDate() + 6);
                            endOfWeek.setHours(23, 59, 59, 999);

                            const reqDate = new Date(req.reqDate);
                            dateMatch = reqDate >= startOfWeek && reqDate <= endOfWeek;
                            break;
                        case 'thisMonth':
                            dateMatch = req.reqDate.startsWith(new Date().toISOString().slice(0, 7));
                            break;
                        case 'lastMonth':
                            const lastMonthDate = new Date();
                            lastMonthDate.setMonth(lastMonthDate.getMonth() - 1);
                            dateMatch = req.reqDate.startsWith(lastMonthDate.toISOString().slice(0, 7));
                            break;
                        case 'thisYear':
                            dateMatch = req.reqDate.startsWith(new Date().getFullYear().toString());
                            break;
                        case 'custom':
                            dateMatch = req.reqDate === customDate;
                            break;
                        default:
                            dateMatch = true;
                    }

                    return dateMatch &&
                        (!selectedShop || req.shop === selectedShop) &&
                        (!selectedEmployeeId || req.staffId === selectedEmployeeId);
                });
                
                const pending = filtered.filter(req => req.status === 'Pending').sort((a, b) => (b.submissionDate?.toDate() || 0) - (a.submissionDate?.toDate() || 0));
                const history = filtered.filter(req => req.status !== 'Pending').sort((a, b) => {
                    // Primary sort: shop name (alphabetical)
                    if ((a.shop || '') < (b.shop || '')) return -1;
                    if ((a.shop || '') > (b.shop || '')) return 1;
                    // Secondary sort: submission date (newest first)
                    return (b.submissionDate?.toDate() || 0) - (a.submissionDate?.toDate() || 0);
                });

                return {
                    pendingRequests: pending,
                    historyRequests: history
                };
            }, [otRequests, selectedShop, selectedEmployeeId, filterPeriod, customDate]);
            
            const handleOpenModal = useCallback((request = null) => { setEditingRequest(request); setModalOpen(true); }, []);
            const handleCloseModal = useCallback(() => { setEditingRequest(null); setModalOpen(false); }, []);
            const handleSaveRequest = useCallback(async (formData) => {
                const { doc, addDoc, updateDoc, collection, serverTimestamp } = window.firebaseSDK;
                const staffName = employees.find(e => e.id === formData.staffId)?.name || '';
                try {
                    if (formData.id) { const { id, ...dataToUpdate } = formData; await updateDoc(doc(db, 'otRequests', id), { ...dataToUpdate, staffName }); } 
                    else { await addDoc(collection(db, 'otRequests'), { ...formData, staffName, submissionDate: serverTimestamp(), status: 'Pending' }); }
                    handleCloseModal();
                } catch (error) { console.error("Error saving OT request:", error); }
            }, [db, employees, handleCloseModal]);
            const handleUpdateRequestStatus = useCallback(async (id, status) => { try { await window.firebaseSDK.updateDoc(window.firebaseSDK.doc(db, 'otRequests', id), { status }); } catch (error) { console.error(`Error updating status for request ${id}:`, error); } }, [db]);
            const confirmDelete = useCallback(async () => { if (requestToDelete) { try { await window.firebaseSDK.deleteDoc(window.firebaseSDK.doc(db, 'otRequests', requestToDelete)); } catch (error) { console.error(`Error deleting request ${requestToDelete}:`, error); } finally { setRequestToDelete(null); } } }, [db, requestToDelete]);
            
            return (
                <Card>
                    <div className="flex flex-wrap gap-4 justify-between items-center mb-6">
                        <h3 className="text-xl font-semibold text-slate-100">OT Requests</h3>
                        <div className="flex flex-wrap gap-4 items-center">
                            {userProfile.role === 'Admin' && (<select value={selectedShop} onChange={e => { setSelectedShop(e.target.value); setSelectedEmployeeId(''); }} className="select w-full sm:w-auto"><option value="">All Shops</option>{shops.map(s => <option key={s.id} value={s.name}>{s.name}</option>)}</select>)}
                            {(userProfile.role === 'Admin' || userProfile.role === 'Shop Manager') && selectedShop && (
                                <select value={selectedEmployeeId} onChange={e => setSelectedEmployeeId(e.target.value)} className="select w-full sm:w-auto">
                                    <option value="">All Staff</option>
                                    {employeesInShop.map(e => <option key={e.id} value={e.id}>{e.name}</option>)}
                                </select>
                            )}
                            {(userProfile.role === 'Admin' || userProfile.role === 'Shop Manager') && (
                                <select value={filterPeriod} onChange={e => setFilterPeriod(e.target.value)} className="select w-full sm:w-auto">
                                    <option value="thisWeek">This Week</option>
                                    <option value="thisMonth">This Month</option>
                                    <option value="lastMonth">Last Month</option>
                                    <option value="thisYear">This Year</option>
                                    <option value="custom">Custom Date</option>
                                </select>
                            )}
                            {filterPeriod === 'custom' && (
                                <input type="date" value={customDate} onChange={e => setCustomDate(e.target.value)} className="input w-full sm:w-auto" />
                            )}
                            <button onClick={() => handleOpenModal()} className="bg-blue-600 text-white px-4 py-2 rounded-lg shadow hover:bg-blue-700 transition-colors flex items-center gap-2"><i className="fas fa-plus"></i> New Request</button>
                        </div>
                    </div>

                    {pendingRequests.length > 0 && (
                        <div className="mb-8">
                            <h4 className="text-lg font-semibold text-slate-200 mb-4">Pending Requests</h4>
                            <div className="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-4">
                                {pendingRequests.map(req => (<div key={req.id} className="bg-slate-700/50 rounded-lg p-4 space-y-3 flex flex-col"><div className="flex justify-between items-start"><div><p className="font-bold text-lg text-slate-100">{req.staffName}</p><p className="text-sm text-slate-300">{req.shop}</p></div><span className={`px-2 py-1 text-xs font-semibold rounded-full bg-yellow-200 text-yellow-900`}>{req.status}</span></div><div className="grid grid-cols-2 gap-x-4 gap-y-2 text-sm pt-2 border-t border-slate-600 flex-grow"><div><p className="text-slate-400">OT Date</p><p className="text-slate-200 font-medium">{Utils.formatISOToDisplay(req.reqDate)}</p></div><div><p className="text-slate-400">Days</p><p className="text-slate-200 font-medium">{req.numberOfOTDays}</p></div><div><p className="text-slate-400">Start Time</p><p className="text-slate-200 font-medium">{req.startTime || 'N/A'}</p></div><div><p className="text-slate-400">End Time</p><p className="text-slate-200 font-medium">{req.endTime || 'N/A'}</p></div><div><p className="text-slate-400">Supervisor</p><p className="text-slate-200 font-medium">{req.supervisor}</p></div><div><p className="text-slate-400">Submitted</p><p className="text-slate-200 font-medium">{Utils.formatRequestDate(req.submissionDate)}</p></div><div className="col-span-2"><p className="text-slate-400">Reason</p><p className="text-slate-200 font-medium whitespace-pre-wrap">{req.reason}</p></div></div><div className="flex justify-end space-x-3 pt-2">{(userProfile?.role === 'Admin' || (userProfile?.role === 'Shop Manager' && userProfile.id !== req.staffId)) && req.status === 'Pending' && (<><button onClick={() => handleUpdateRequestStatus(req.id, 'Approved')} className="text-green-400 hover:text-green-300" title="Approve"><i className="fas fa-check-circle fa-lg"></i></button><button onClick={() => handleUpdateRequestStatus(req.id, 'Rejected')} className="text-orange-400 hover:text-orange-300" title="Reject"><i className="fas fa-times-circle fa-lg"></i></button></>)}<button onClick={() => handleOpenModal(req)} className="text-indigo-400 hover:text-indigo-300" title="Edit"><i className="fas fa-edit fa-lg"></i></button><button onClick={() => setRequestToDelete(req.id)} className="text-red-400 hover:text-red-300" title="Delete"><i className="fas fa-trash fa-lg"></i></button></div></div>))}
                            </div>
                        </div>
                    )}

                    <div>
                        <h4 className="text-lg font-semibold text-slate-200 mb-4">OT History</h4>
                        <div className="overflow-x-auto">
                            <table className="min-w-full divide-y divide-slate-700">
                                <thead className="bg-slate-900/50">
                                    <tr>
                                        <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Request Date</th>
                                        <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Shop</th>
                                        <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Name</th>
                                        <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">OT Date</th>
                                        <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Start Time</th>
                                        <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">End Time</th>
                                        <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">No. OT Days</th>
                                        <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Supervisor</th>
                                        <th className="px-4 py-3 text-center text-xs font-semibold text-slate-400 uppercase">Reason</th>
                                        <th className="px-4 py-3 text-center text-xs font-semibold text-slate-400 uppercase">Status</th>
                                        <th className="px-4 py-3 text-center text-xs font-semibold text-slate-400 uppercase">Actions</th>
                                    </tr>
                                </thead>
                                <tbody className="divide-y divide-slate-700">
                                    {historyRequests.map(req => (
                                        <tr key={req.id} className="hover:bg-slate-700/50">
                                            <td className="px-4 py-4 text-sm text-slate-300">{Utils.formatRequestDate(req.submissionDate)}</td>
                                            <td className="px-4 py-4 text-sm text-slate-300">{req.shop}</td>
                                            <td className="px-4 py-4 text-sm text-slate-200">{req.staffName}</td>
                                            <td className="px-4 py-4 text-sm text-slate-300">{Utils.formatISOToDisplay(req.reqDate)}</td>
                                            <td className="px-4 py-4 text-sm text-slate-300">{req.startTime || 'N/A'}</td>
                                            <td className="px-4 py-4 text-sm text-slate-300">{req.endTime || 'N/A'}</td>
                                            <td className="px-4 py-4 text-sm text-slate-300">{req.numberOfOTDays}</td>
                                            <td className="px-4 py-4 text-sm text-slate-300">{req.supervisor}</td>
                                            <td className="px-4 py-4 text-center text-sm"><button onClick={() => setReasonToView(req.reason)} className="text-blue-400 hover:text-blue-300"><i className="fas fa-eye"></i></button></td>
                                            <td className="px-4 py-4 text-center text-sm"><span className={`px-2 py-1 text-xs font-semibold rounded-full ${req.status === 'Approved' ? 'bg-green-200 text-green-900' : 'bg-red-200 text-red-900'}`}>{req.status}</span></td>
                                            <td className="px-4 py-4 text-center whitespace-nowrap">
                                                <button onClick={() => handleOpenModal(req)} className="text-indigo-400 hover:text-indigo-300 mx-2" title="Edit"><i className="fas fa-edit"></i></button>
                                                <button onClick={() => setRequestToDelete(req.id)} className="text-red-400 hover:text-red-300" title="Delete"><i className="fas fa-trash"></i></button>
                                            </td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <OTRequestModal isOpen={isModalOpen} onClose={handleCloseModal} onSave={handleSaveRequest} request={editingRequest} userProfile={userProfile} />
                    <ConfirmationModal isOpen={!!requestToDelete} onClose={() => setRequestToDelete(null)} onConfirm={confirmDelete} title="Delete OT Request" message="Are you sure you want to permanently delete this OT request?" />
                    <Modal isOpen={!!reasonToView} onClose={() => setReasonToView(null)} maxWidth="max-w-md">
                        <ModalHeader title="OT Request Reason" onClose={() => setReasonToView(null)} />
                        <ModalBody>
                            <p className="text-slate-300">{reasonToView}</p>
                        </ModalBody>
                        <ModalFooter>
                            <button onClick={() => setReasonToView(null)} className="bg-slate-600 text-slate-200 px-4 py-2 rounded-lg hover:bg-slate-500">Close</button>
                        </ModalFooter>
                    </Modal>
                </Card>
            );
        };

        const OTRequestModal = ({ isOpen, onClose, onSave, request, userProfile }) => {
            const [formData, setFormData] = useState({});
            
            const isMultiShopStaff = useMemo(() => Array.isArray(userProfile?.shop), [userProfile]);

            // Initialize form data
            useEffect(() => {
                const initialData = request 
                    ? { ...request } 
                    : (userProfile 
                        ? { 
                            reqDate: new Date().toISOString().substring(0, 10), 
                            shop: isMultiShopStaff ? '' : (userProfile.shop || ''), 
                            staffId: userProfile.id || '', 
                            supervisor: userProfile.supervisor || '', 
                            startTime: '', 
                            endTime: '', 
                            numberOfOTDays: 0, 
                            reason: '' 
                          } 
                        : {});
                setFormData(initialData);
            }, [request, userProfile, isOpen, isMultiShopStaff]);

            // Calculate OT days from start and end times
            useEffect(() => {
                if (formData.startTime && formData.endTime) {
                    const [startHour, startMinute] = formData.startTime.split(':').map(Number);
                    const [endHour, endMinute] = formData.endTime.split(':').map(Number);

                    if (!isNaN(startHour) && !isNaN(startMinute) && !isNaN(endHour) && !isNaN(endMinute)) {
                        const startDate = new Date(0, 0, 0, startHour, startMinute, 0);
                        let endDate = new Date(0, 0, 0, endHour, endMinute, 0);

                        // Handle overnight OT
                        if (endDate < startDate) {
                            endDate.setDate(endDate.getDate() + 1);
                        }

                        const diffMillis = endDate - startDate;
                        const diffHours = diffMillis / (1000 * 60 * 60);
                        
                        // REVISED LOGIC: Per user request, specific durations are handled differently.
                        // 4 hours (e.g. 5pm-9pm) and 5 hours (e.g. 7:30am-12:30pm) both count as 0.5 days.
                        // Durations between 4 and 5 hours are treated as a half day.
                        // Other durations are calculated against a standard 8-hour OT day.
                        let otDays = 0;
                        const OT_HOURS_PER_DAY = 8;

                        if (diffHours >= 4 && diffHours <= 5) {
                            otDays = 0.5;
                        } else {
                            otDays = diffHours / OT_HOURS_PER_DAY;
                        }
                        
                        setFormData(prev => ({ ...prev, numberOfOTDays: otDays > 0 ? otDays.toFixed(2) : 0 }));
                    }
                }
            }, [formData.startTime, formData.endTime]);

            const handleChange = useCallback((e) => { 
                setFormData(prev => ({ ...prev, [e.target.name]: e.target.value })); 
            }, []);
            
            const handleSubmit = useCallback((e) => { 
                e.preventDefault(); 
                if (isMultiShopStaff && !formData.shop) {
                    alert("Please select a shop for the OT request.");
                    return;
                }
                onSave(formData); 
            }, [onSave, formData, isMultiShopStaff]);
            
            return (
                <Modal isOpen={isOpen} onClose={onClose} maxWidth="max-w-4xl">
                    <form onSubmit={handleSubmit}>
                        <ModalHeader title={request ? "Edit OT Request" : "New OT Request"} onClose={onClose} />
                        <ModalBody>
                            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                <div><label className="text-sm">OT Date</label><input type="date" name="reqDate" value={formData.reqDate || ''} onChange={handleChange} className="input" required /></div>
                                <div><label className="text-sm">Start Hour</label><input type="time" name="startTime" value={formData.startTime || ''} onChange={handleChange} className="input" required /></div>
                                <div><label className="text-sm">End Hour</label><input type="time" name="endTime" value={formData.endTime || ''} onChange={handleChange} className="input" required /></div>
                                
                                {isMultiShopStaff ? (
                                    <div>
                                        <label className="text-sm">Shop Name</label>
                                        <select name="shop" value={formData.shop || ''} onChange={handleChange} className="select" required>
                                            <option value="">Select Shop</option>
                                            {(userProfile.shop || []).map(shopName => <option key={shopName} value={shopName}>{shopName}</option>)}
                                        </select>
                                    </div>
                                ) : (
                                    <div><label className="text-sm">Shop Name</label><input value={formData.shop || ''} className="input" disabled /></div>
                                )}
                                
                                <div><label className="text-sm">Staff Name</label><input value={userProfile?.name || ''} className="input" disabled /></div>
                                <div><label className="text-sm">Supervisor</label><input value={formData.supervisor || ''} className="input" disabled /></div>
                                
                                <div className="lg:col-span-3"><label className="text-sm">No. OT Day(s)</label><input type="number" name="numberOfOTDays" value={formData.numberOfOTDays || ''} className="input" disabled /></div>
                                <div className="lg:col-span-3"><label className="text-sm">Reason</label><textarea name="reason" value={formData.reason || ''} onChange={handleChange} className="input" rows="3" required></textarea></div>
                            </div>
                        </ModalBody>
                        <ModalFooter>
                            <button type="button" onClick={onClose} className="bg-slate-600 text-slate-200 px-4 py-2 rounded-lg hover:bg-slate-500">Cancel</button>
                            <button type="submit" className="bg-blue-600 text-white px-6 py-2 rounded-lg shadow hover:bg-blue-700">Submit Request</button>
                        </ModalFooter>
                    </form>
                </Modal>
            );
        };
        // --- END CHECKINME PAGE ---

        // --- START ATTENDANCE REPORT PAGE ---
        const AttendanceReportPage = ({ userProfile }) => {
            const [activeTab, setActiveTab] = useState('daily');
            const { data: leaveRequests } = useCollection('leaveRequests');
            const { data: otRequests } = useCollection('otRequests');
            return (
                <TabbedPage tabs={{ daily: 'Daily Report', monthly: 'No. Work Day' }} activeTab={activeTab} setActiveTab={setActiveTab}>
                    <div id="daily"><DailyReportTab userProfile={userProfile} leaveRequests={leaveRequests} otRequests={otRequests} /></div>
                    <div id="monthly"><WorkDayReportTab userProfile={userProfile} leaveRequests={leaveRequests} otRequests={otRequests} /></div>
                </TabbedPage>
            );
        };

        const DailyReportTab = ({ userProfile, leaveRequests, otRequests }) => {
            const { db } = useFirebase();
            const { data: attendance } = useCollection('attendance');
            const { data: shops } = useCollection('shops');
            const { data: employees } = useCollection('employees');
            const [selectedShop, setSelectedShop] = useState('');
            const [filterType, setFilterType] = useState('today');
            const [customDate, setCustomDate] = useState(new Date().toISOString().slice(0, 10));
            const [selectedEmployeeId, setSelectedEmployeeId] = useState('');
            const [recordToDelete, setRecordToDelete] = useState(null);

            useEffect(() => {
                if (userProfile && userProfile.role !== 'Admin') {
                    // For managers with multiple shops, default to showing all their shops.
                    // For single-shop users, their shop is pre-selected.
                    setSelectedShop(Array.isArray(userProfile.shop) ? '' : userProfile.shop || '');
                }
            }, [userProfile]);
            
            // Admins see all shops, Managers see their assigned shops for filtering.
            const availableShops = useMemo(() => {
                if (userProfile?.role === 'Admin') return shops;
                if (userProfile?.role === 'Shop Manager' && Array.isArray(userProfile.shop)) {
                    return shops.filter(s => userProfile.shop.includes(s.name));
                }
                return []; // Not used for other roles in the UI dropdown
            }, [shops, userProfile]);

            const employeesInShop = useMemo(() => {
                if (!selectedShop) return [];
                return employees.filter(emp => {
                    const employeeShops = Array.isArray(emp.shop) ? emp.shop : [emp.shop];
                    return employeeShops.includes(selectedShop) && emp.status === 'Active';
                });
            }, [selectedShop, employees]);

            const attendanceReport = useMemo(() => {
                const startDate = new Date();
                const endDate = new Date();

                switch (filterType) {
                    case 'today':
                        startDate.setHours(0, 0, 0, 0);
                        endDate.setHours(23, 59, 59, 999);
                        break;
                    case 'yesterday':
                        startDate.setDate(startDate.getDate() - 1);
                        startDate.setHours(0, 0, 0, 0);
                        endDate.setDate(endDate.getDate() - 1);
                        endDate.setHours(23, 59, 59, 999);
                        break;
                    case 'thisMonth':
                        startDate.setDate(1);
                        startDate.setHours(0, 0, 0, 0);
                        endDate.setMonth(endDate.getMonth() + 1);
                        endDate.setDate(0);
                        endDate.setHours(23, 59, 59, 999);
                        break;
                    case 'lastMonth':
                        startDate.setMonth(startDate.getMonth() - 1);
                        startDate.setDate(1);
                        startDate.setHours(0, 0, 0, 0);
                        endDate.setDate(0);
                        endDate.setHours(23, 59, 59, 999);
                        break;
                    case 'custom':
                        const [year, month, day] = customDate.split('-').map(Number);
                        if (year && month && day) {
                            startDate.setFullYear(year, month - 1, day);
                            startDate.setHours(0, 0, 0, 0);
                            endDate.setFullYear(year, month - 1, day);
                            endDate.setHours(23, 59, 59, 999);
                        }
                        break;
                }
                
                const isMultiShopManager = userProfile.role === 'Shop Manager' && Array.isArray(userProfile.shop);

                // 1. Get a list of employees to report on
                const relevantEmployees = employees.filter(emp => {
                    const employeeShops = Array.isArray(emp.shop) ? emp.shop : (emp.shop ? [emp.shop] : []);
                    let shopMatch = false;

                    if (userProfile.role === 'Admin') {
                        shopMatch = !selectedShop || employeeShops.includes(selectedShop);
                    } else if (isMultiShopManager) {
                        // Check if the employee's shops intersect with the manager's shops
                        const isManaged = employeeShops.some(s => userProfile.shop.includes(s));
                        // And if a filter is applied, the employee must be in that specific shop
                        shopMatch = isManaged && (!selectedShop || employeeShops.includes(selectedShop));
                    } else { // Single shop user
                        shopMatch = employeeShops.includes(userProfile.shop);
                    }
                    return emp.status === 'Active' && shopMatch && (!selectedEmployeeId || emp.id === selectedEmployeeId);
                });

                // 2. Initialize a report entry for each employee for each day in the range
                const reportMap = new Map();
                const currentDate = new Date(startDate);
                while (currentDate <= endDate) {
                    const dateKey = `${currentDate.getFullYear()}-${String(currentDate.getMonth() + 1).padStart(2, '0')}-${String(currentDate.getDate()).padStart(2, '0')}`;
                    for (const employee of relevantEmployees) {
                        const reportKey = `${employee.id}_${dateKey}`;
                        reportMap.set(reportKey, { 
                            date: dateKey, 
                            employeeId: employee.id, 
                            employeeName: employee.name, 
                            assignedShop: Array.isArray(employee.shop) ? employee.shop.join(', ') : employee.shop,
                            shop: '', // This will hold the actual check-in shop
                            checkIn: null, 
                            checkOut: null, 
                            docIds: [] 
                        });
                    }
                    currentDate.setDate(currentDate.getDate() + 1);
                }
                
                // 3. Filter attendance records once
                const filteredAttendance = attendance.filter(record => {
                    if (!record.timestamp) return false;
                    const recordDate = record.timestamp.toDate();
                    if (!(recordDate >= startDate && recordDate <= endDate)) return false;

                    let shopMatch = false;
                    if (userProfile.role === 'Admin') {
                        shopMatch = !selectedShop || record.shop === selectedShop;
                    } else if (isMultiShopManager) {
                        shopMatch = userProfile.shop.includes(record.shop) && (!selectedShop || record.shop === selectedShop);
                    } else {
                        shopMatch = record.shop === userProfile.shop;
                    }

                    return shopMatch && (!selectedEmployeeId || record.employeeId === selectedEmployeeId);
                });

                // 4. Populate the report map with attendance data
                filteredAttendance.forEach(record => {
                    const date = record.timestamp.toDate();
                    const dateKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
                    const reportKey = `${record.employeeId}_${dateKey}`;

                    if (reportMap.has(reportKey)) {
                        const entry = reportMap.get(reportKey);
                        if (record.type === 'in' && (!entry.checkIn || date < entry.checkIn)) {
                            entry.checkIn = date;
                            entry.shop = record.shop; // Capture shop from the earliest check-in
                        }
                        if (record.type === 'out' && (!entry.checkOut || date > entry.checkOut)) {
                            entry.checkOut = date;
                            // If no check-in record set the shop, use the shop from the latest check-out
                            if (!entry.shop) {
                                entry.shop = record.shop;
                            }
                        }
                        entry.docIds.push(record.id);
                    }
                });
                
                // 5. Finalize calculations (hours, leave, OT, etc.) for each entry
                const reportArray = Array.from(reportMap.values()).map(report => {
                    const employee = employees.find(e => e.id === report.employeeId);
                    
                    let isLate = false;
                    if (report.checkIn && employee) {
                        const shift = employee.shift || 'AM';
                        const checkInHour = report.checkIn.getHours(); const checkInMinute = report.checkIn.getMinutes();
                        if ((shift === 'AM' || shift === 'APM') && (checkInHour > 7 || (checkInHour === 7 && checkInMinute >= 35))) isLate = true;
                        else if (shift === 'PM' && (checkInHour > 12 || (checkInHour === 12 && checkInMinute >= 35))) isLate = true;
                    }

                    const hasActivity = report.checkIn || report.checkOut;
                    const reportDate = new Date(report.date);
                    reportDate.setHours(23, 59, 59, 999); // Set to end of day for comparison
                    const today = new Date();

                    // Check for approved leave first, then check for absence on past days
                    const approvedLeave = leaveRequests.find(lr => lr.staffId === report.employeeId && lr.status === 'Approved' && report.date >= lr.leaveDate && report.date < lr.returnDate);
                    let isOnLeave = 'N'; // This variable now represents the general status for the "Leave Status" column
                    if (approvedLeave) { 
                        isOnLeave = approvedLeave.leaveSession === 'Full Day' ? 'Y-Full Day' : `Y-${approvedLeave.leaveSession}`; 
                    } else if (!hasActivity && reportDate < today) {
                        // If there's no activity and the day has passed, mark as Absent
                        isOnLeave = 'Absent';
                    }

                    const isOnOT = otRequests.some(ot => ot.staffId === report.employeeId && ot.status === 'Approved' && ot.reqDate === report.date);
                    const otStatus = isOnOT ? 'Y' : 'N';
                    
                    const isSingleDayView = filterType === 'today' || filterType === 'yesterday' || filterType === 'custom';
                    
                    const displayShop = report.shop || report.assignedShop;

                    // Only show records that have activity, have a specific status (Leave/Absent), or are in a single-day view.
                    // This prevents showing future empty rows in multi-day reports.
                    if (hasActivity || isOnLeave !== 'N' || isSingleDayView) {
                        return { ...report, shop: displayShop, shift: employee?.shift, checkIn: report.checkIn ? report.checkIn.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: true }) : '', checkOut: report.checkOut ? report.checkOut.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: true }) : '', isLate, isOnLeave, otStatus };
                    }
                    return null;
                }).filter(Boolean); // Remove null entries
                
                // 6. Sort the final array
                return reportArray.sort((a, b) => (a.shop || '').localeCompare(b.shop || '') || b.date.localeCompare(a.date) || a.employeeName.localeCompare(b.employeeName));
            }, [attendance, selectedShop, filterType, customDate, selectedEmployeeId, employees, leaveRequests, otRequests]);

            const handleDelete = async () => {
                if (!recordToDelete?.docIds) return;
                const { doc, writeBatch } = window.firebaseSDK;
                const batch = writeBatch(db);
                // Delete all attendance docs for that employee on that day
                recordToDelete.docIds.forEach(id => batch.delete(doc(db, 'attendance', id)));
                try { await batch.commit(); } catch (error) { console.error("Error deleting attendance records: ", error); } 
                finally { setRecordToDelete(null); }
            };

            const handleExportExcel = useCallback(() => {
                const dataToExport = attendanceReport.map(report => ({
                    'Date': report.date,
                    'Staff Name': report.employeeName,
                    'Shop Name': report.shop,
                    'Shift': report.shift,
                    'Check In': report.checkIn,
                    'Check Out': report.checkOut,
                    'On Leave': report.isOnLeave,
                    'OT Status': report.otStatus,
                    'Late Check-In': report.isLate ? 'Yes' : 'No'
                }));

                const getReportFilename = () => {
                    const todayStr = new Date().toISOString().slice(0, 10);
                    switch (filterType) {
                        case 'today': return `Daily_Attendance_Report_Today_${todayStr}.xlsx`;
                        case 'yesterday': 
                            const yesterday = new Date();
                            yesterday.setDate(yesterday.getDate() - 1);
                            return `Daily_Attendance_Report_Yesterday_${yesterday.toISOString().slice(0, 10)}.xlsx`;
                        case 'thisMonth': return `Daily_Attendance_Report_ThisMonth_${new Date().toISOString().slice(0, 7)}.xlsx`;
                        case 'lastMonth': 
                            const lastMonth = new Date();
                            lastMonth.setMonth(lastMonth.getMonth() - 1);
                            return `Daily_Attendance_Report_LastMonth_${lastMonth.toISOString().slice(0, 7)}.xlsx`;
                        case 'custom': return `Daily_Attendance_Report_${customDate}.xlsx`;
                        default: return 'Daily_Attendance_Report.xlsx';
                    }
                };

                const worksheet = XLSX.utils.json_to_sheet(dataToExport);
                const workbook = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(workbook, worksheet, "Daily Attendance");

                worksheet["!cols"] = [ { wch: 12 }, { wch: 25 }, { wch: 15 }, { wch: 10 }, { wch: 15 }, { wch: 15 }, { wch: 15 }, { wch: 12 }, { wch: 15 } ];
                
                XLSX.writeFile(workbook, getReportFilename());
            }, [attendanceReport, filterType, customDate]);

            return (
                <Card>
                    <div className="flex flex-wrap gap-4 justify-between items-center mb-6">
                        <CardTitle>Daily Attendance Report</CardTitle>
                        <div className="flex flex-wrap gap-4 items-center">
                            {(userProfile?.role === 'Admin' || (userProfile?.role === 'Shop Manager' && Array.isArray(userProfile.shop))) && (
                                <select value={selectedShop} onChange={e => { setSelectedShop(e.target.value); setSelectedEmployeeId(''); }} className="select w-full sm:w-auto">
                                    <option value="">All My Shops</option>
                                    {availableShops.map(s => <option key={s.id} value={s.name}>{s.name}</option>)}
                                </select>
                            )}
                            {userProfile?.role !== 'Staff' && selectedShop && (
                                <select value={selectedEmployeeId} onChange={e => setSelectedEmployeeId(e.target.value)} className="select w-full sm:w-auto">
                                    <option value="">All Staff</option>
                                    {employeesInShop.map(e => <option key={e.id} value={e.id}>{e.name}</option>)}
                                </select>
                            )}
                            <select value={filterType} onChange={e => setFilterType(e.target.value)} className="select w-full sm:w-auto">
                                <option value="today">Today</option>
                                <option value="yesterday">Yesterday</option>
                                <option value="thisMonth">This Month</option>
                                <option value="lastMonth">Last Month</option>
                                <option value="custom">Custom Date</option>
                            </select>
                            {filterType === 'custom' && (
                                <input type="date" value={customDate} onChange={e => setCustomDate(e.target.value)} className="input w-full sm:w-auto" />
                            )}
                            <button onClick={handleExportExcel} className="bg-green-600 text-white px-4 py-2 rounded-lg shadow hover:bg-green-700 transition-colors flex items-center gap-2"><i className="fas fa-file-excel"></i> Excel</button>
                        </div>
                    </div>
                    <div className="overflow-x-auto"><table className="min-w-full divide-y divide-slate-700"><thead className="bg-slate-900/50"><tr><th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Date</th><th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Staff Name</th><th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Shop Name</th><th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Shift</th><th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Check In</th><th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Check Out</th><th className="px-4 py-3 text-center text-xs font-semibold text-slate-400 uppercase">Leave Status</th><th className="px-4 py-3 text-center text-xs font-semibold text-slate-400 uppercase">OT Status</th><th className="px-4 py-3 text-center text-xs font-semibold text-slate-400 uppercase">Actions</th></tr></thead><tbody className="divide-y divide-slate-700">{attendanceReport.map((report) => (<tr key={`${report.employeeId}-${report.date}`} className="transition-colors hover:bg-slate-700/50"><td className="px-4 py-4 text-sm text-slate-200">{report.date}</td><td className="px-4 py-4 text-sm text-slate-200">{report.employeeName}</td><td className="px-4 py-4 text-sm text-slate-300">{report.shop}</td><td className="px-4 py-4 text-sm text-slate-300">{report.shift}</td><td className={`px-4 py-4 text-sm font-semibold ${report.isLate ? 'text-orange-400' : 'text-slate-300 font-normal'}`}>{report.checkIn}</td><td className="px-4 py-4 text-sm text-slate-300">{report.checkOut}</td><td className={`px-4 py-4 text-sm text-center ${report.isOnLeave === 'Absent' ? 'text-red-400 font-semibold' : 'text-slate-300'}`}>{report.isOnLeave}</td><td className="px-4 py-4 text-sm text-center text-slate-300">{report.otStatus}</td><td className="px-4 py-4 text-center whitespace-nowrap">{userProfile?.role === 'Admin' && report.docIds.length > 0 && (<button onClick={() => setRecordToDelete(report)} className="text-red-500 hover:text-red-400" title="Delete"><i className="fas fa-trash"></i></button>)}</td></tr>))}</tbody></table></div>
                    <ConfirmationModal isOpen={!!recordToDelete} onClose={() => setRecordToDelete(null)} onConfirm={handleDelete} title="Delete Attendance Record" message={`Are you sure you want to delete all attendance records for ${recordToDelete?.employeeName} on ${recordToDelete?.date}? This action cannot be undone.`} />
                </Card>
            );
        };
        
        const WorkDayReportTab = ({ userProfile, leaveRequests, otRequests }) => {
            const { data: attendance } = useCollection('attendance');
            const { data: shops } = useCollection('shops');
            const { data: employees } = useCollection('employees');
            const { data: employeeStates } = useCollection('employeeStates'); // Fetch employee states for late calculation
            const [selectedShop, setSelectedShop] = useState('');
            const [filterType, setFilterType] = useState('thisMonth');
            const [selectedMonth, setSelectedMonth] = useState(new Date().toISOString().slice(0, 7));
            const [selectedEmployeeId, setSelectedEmployeeId] = useState('');
            
            useEffect(() => {
                if (userProfile && userProfile.role !== 'Admin') {
                     // For managers with multiple shops, default to showing all their shops.
                    setSelectedShop(Array.isArray(userProfile.shop) ? '' : userProfile.shop || '');
                }
            }, [userProfile]);

            // Admins see all shops, Managers see their assigned shops for filtering.
            const availableShops = useMemo(() => {
                if (userProfile?.role === 'Admin') return shops;
                if (userProfile?.role === 'Shop Manager' && Array.isArray(userProfile.shop)) {
                    return shops.filter(s => userProfile.shop.includes(s.name));
                }
                return []; // Not used for other roles in the UI dropdown
            }, [shops, userProfile]);

            const employeesInShop = useMemo(() => {
                if (!selectedShop) return [];
                return employees.filter(emp => {
                    const employeeShops = Array.isArray(emp.shop) ? emp.shop : [emp.shop];
                    return employeeShops.includes(selectedShop) && emp.status === 'Active';
                });
            }, [selectedShop, employees]);

            const workDayReport = useMemo(() => {
                let targetMonth;
                const now = new Date();
                switch (filterType) {
                    case 'lastMonth':
                        const lastMonthDate = new Date(now.getFullYear(), now.getMonth() - 1, 1);
                        targetMonth = lastMonthDate.toISOString().slice(0, 7);
                        break;
                    case 'custom':
                        targetMonth = selectedMonth;
                        break;
                    case 'thisMonth':
                    default:
                        targetMonth = now.toISOString().slice(0, 7);
                        break;
                }

                const isMultiShopManager = userProfile.role === 'Shop Manager' && Array.isArray(userProfile.shop);

                const recordsByEmployeeMonth = {};
                const filteredAttendance = attendance.filter(record => {
                    if (!record.timestamp) return false;
                    if (!targetMonth || !record.timestamp.toDate().toISOString().startsWith(targetMonth)) return false;

                    let shopMatch = false;
                    if (userProfile.role === 'Admin') {
                        shopMatch = !selectedShop || record.shop === selectedShop;
                    } else if (isMultiShopManager) {
                        shopMatch = userProfile.shop.includes(record.shop) && (!selectedShop || record.shop === selectedShop);
                    } else {
                        shopMatch = record.shop === userProfile.shop;
                    }

                    return shopMatch && (!selectedEmployeeId || record.employeeId === selectedEmployeeId);
                });
                
                filteredAttendance.forEach(record => {
                    const date = record.timestamp.toDate();
                    const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                    const employeeMonthKey = `${record.employeeId}_${monthKey}`;
                    if (!recordsByEmployeeMonth[employeeMonthKey]) {
                        recordsByEmployeeMonth[employeeMonthKey] = { 
                            employeeId: record.employeeId, 
                            employeeName: record.employeeName, 
                            shop: record.shop, 
                            month: monthKey, 
                            records: [] 
                        };
                    }
                    recordsByEmployeeMonth[employeeMonthKey].records.push({ date: date, type: record.type });
                });

                const report = Object.values(recordsByEmployeeMonth).map(group => {
                    const employeeLeaves = leaveRequests.filter(
                        lr => lr.staffId === group.employeeId &&
                              lr.status === 'Approved' &&
                              lr.leaveDate.startsWith(group.month)
                    );
                    const totalLeave = employeeLeaves.reduce((acc, curr) => acc + (parseFloat(curr.numberOfDays) || 0), 0);

                    const employeeOTs = otRequests.filter(
                        ot => ot.staffId === group.employeeId &&
                              ot.status === 'Approved' &&
                              ot.reqDate.startsWith(group.month)
                    );
                    const totalOT = employeeOTs.reduce((acc, curr) => acc + (parseFloat(curr.numberOfOTDays) || 0), 0);
                    
                    // Calculate total late days for the month from employeeStates
                    const totalLate = employeeStates.filter(es =>
                        es.staffId === group.employeeId &&
                        es.date.startsWith(group.month) &&
                        es.statusState === 'Deduction' &&
                        es.note && es.note.includes('CheckIn Late')
                    ).length;

                    const dailyRecords = {};
                    group.records.forEach(rec => {
                        const dayKey = rec.date.toISOString().split('T')[0];
                        if (!dailyRecords[dayKey]) dailyRecords[dayKey] = [];
                        dailyRecords[dayKey].push(rec);
                    });

                    let workDays = 0;
                    Object.values(dailyRecords).forEach(dayRecords => {
                        const checkIns = dayRecords.filter(r => r.type === 'in').sort((a, b) => a.date - b.date);
                        const checkOuts = dayRecords.filter(r => r.type === 'out').sort((a, b) => b.date - a.date);
                        if (checkIns.length > 0 && checkOuts.length > 0) {
                            const diff = (checkOuts[0].date.getTime() - checkIns[0].date.getTime()) / 3600000;
                            // Business rule: Over 4 hours is a full day, otherwise a half day.
                            if (diff >= 4) workDays += 1;
                            else if (diff > 1) workDays += 0.5;
                        }
                    });

                    const [year, month] = group.month.split('-');
                    return { 
                        dueTime: `${month}-${year.substring(2)}`, 
                        shopName: group.shop, 
                        staffName: group.employeeName, 
                        workDays,
                        totalOT,
                        totalLeave,
                        totalLate
                    };
                });
                
                return report.sort((a, b) => (a.shopName || '').localeCompare(b.shopName || '') || (a.staffName || '').localeCompare(b.staffName || ''));

            }, [attendance, leaveRequests, otRequests, selectedShop, filterType, selectedMonth, selectedEmployeeId, employeeStates]);

            const handleExportExcel = useCallback(() => {
                const dataToExport = workDayReport.map(rec => ({
                    'Due Time (MM-YY)': rec.dueTime,
                    'Shop Name': rec.shopName,
                    'Staff Name': rec.staffName,
                    'No. Work Day': rec.workDays,
                    'Total OT': rec.totalOT,
                    'Total Leave No': rec.totalLeave,
                    'Total LATE': rec.totalLate,
                }));

                const getReportFilename = () => {
                    const now = new Date();
                    switch (filterType) {
                        case 'thisMonth': return `Monthly_Work_Day_Report_${now.toISOString().slice(0, 7)}.xlsx`;
                        case 'lastMonth': 
                            const lastMonthDate = new Date(now.getFullYear(), now.getMonth() - 1, 1);
                            return `Monthly_Work_Day_Report_${lastMonthDate.toISOString().slice(0, 7)}.xlsx`;
                        case 'custom': return `Monthly_Work_Day_Report_${selectedMonth}.xlsx`;
                        default: return 'Monthly_Work_Day_Report.xlsx';
                    }
                };

                const worksheet = XLSX.utils.json_to_sheet(dataToExport);
                const workbook = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(workbook, worksheet, "Monthly Work Day Report");
                
                worksheet["!cols"] = [ { wch: 18 }, { wch: 20 }, { wch: 25 }, { wch: 15 }, { wch: 15 }, { wch: 15 }, { wch: 15 } ];
                
                XLSX.writeFile(workbook, getReportFilename());
            }, [workDayReport, filterType, selectedMonth]);

            return (
                <Card>
                    <div className="flex flex-wrap gap-4 justify-between items-center mb-6">
                        <CardTitle>Monthly Work Day Report</CardTitle>
                        <div className="flex flex-wrap gap-4 items-center">
                            {(userProfile?.role === 'Admin' || (userProfile?.role === 'Shop Manager' && Array.isArray(userProfile.shop))) && (
                                <select value={selectedShop} onChange={e => { setSelectedShop(e.target.value); setSelectedEmployeeId(''); }} className="select w-full sm:w-auto">
                                    <option value="">All My Shops</option>
                                    {availableShops.map(s => <option key={s.id} value={s.name}>{s.name}</option>)}
                                </select>
                            )}
                             {userProfile?.role !== 'Staff' && selectedShop && (
                                <select value={selectedEmployeeId} onChange={e => setSelectedEmployeeId(e.target.value)} className="select w-full sm:w-auto">
                                    <option value="">All Staff</option>
                                    {employeesInShop.map(e => <option key={e.id} value={e.id}>{e.name}</option>)}
                                </select>
                            )}
                            <select value={filterType} onChange={e => setFilterType(e.target.value)} className="select w-full sm:w-auto">
                                <option value="thisMonth">This Month</option>
                                <option value="lastMonth">Last Month</option>
                                <option value="custom">Custom Month</option>
                            </select>
                            {filterType === 'custom' && (
                                <input type="month" value={selectedMonth} onChange={e => setSelectedMonth(e.target.value)} className="input w-full sm:w-auto" />
                            )}
                            <button onClick={handleExportExcel} className="bg-green-600 text-white px-4 py-2 rounded-lg shadow hover:bg-green-700 transition-colors flex items-center gap-2"><i className="fas fa-file-excel"></i> Excel</button>
                        </div>
                    </div>
                    <div className="overflow-x-auto"><table className="min-w-full divide-y divide-slate-700"><thead className="bg-slate-900/50"><tr><th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Date</th><th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Shop Name</th><th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Staff Name</th><th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">No. Work Day</th><th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Total OT</th><th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Total Leave No</th><th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Total LATE</th></tr></thead><tbody className="divide-y divide-slate-700">{workDayReport.map((report, index) => (<tr key={index} className="hover:bg-slate-700/50"><td className="px-4 py-4 text-sm text-slate-200">{report.dueTime}</td><td className="px-4 py-4 text-sm text-slate-300">{report.shopName}</td><td className="px-4 py-4 text-sm text-slate-200">{report.staffName}</td><td className="px-4 py-4 text-sm font-semibold text-blue-400">{report.workDays}</td><td className="px-4 py-4 text-sm font-semibold text-green-400">{report.totalOT > 0 ? report.totalOT.toFixed(2) : 0}</td><td className="px-4 py-4 text-sm font-semibold text-yellow-400">{report.totalLeave}</td><td className="px-4 py-4 text-sm font-semibold text-red-400">{report.totalLate}</td></tr>))}</tbody></table></div>
                </Card>
            );
        };
        // --- END ATTENDANCE REPORT PAGE ---

        // --- START LOAN MANAGER PAGE ---
        const LoanManagerPage = ({ userProfile }) => {
            const [activeTab, setActiveTab] = useState('management');
            return (
                <TabbedPage tabs={{ management: 'Loan Management', history: 'Loan History' }} activeTab={activeTab} setActiveTab={setActiveTab}>
                    <div id="management"><LoanManagementTab userProfile={userProfile} /></div>
                    <div id="history"><LoanHistoryTab userProfile={userProfile} /></div>
                </TabbedPage>
            );
        };

        const LoanManagementTab = ({ userProfile }) => {
            const { db } = useFirebase();
            const [isModalOpen, setModalOpen] = useState(false);
            const [editingLoan, setEditingLoan] = useState(null);
            const [loanToDelete, setLoanToDelete] = useState(null);
            const { where } = window.firebaseSDK;
            
            const queryConstraints = useMemo(() => {
                if (!userProfile) return [where("shop", "==", "null")];
                if (userProfile.role === 'Admin') return [];
                if (userProfile.role === 'Shop Manager') {
                    const shops = Array.isArray(userProfile.shop) ? userProfile.shop : (userProfile.shop ? [userProfile.shop] : []);
                    if (shops.length > 0) {
                        return [where("shop", "in", shops)];
                    }
                    return [where("staffId", "==", "null")]; // No shops, no data
                }
                return [where("shop", "==", userProfile.shop || null)];
            }, [userProfile]);

            const { data: loans } = useCollection('staffLoans', queryConstraints);
            const { data: shops } = useCollection('shops');
            const { data: employees } = useCollection('employees');
            const [selectedShop, setSelectedShop] = useState(''); // For the modal's employee list
            const [formData, setFormData] = useState({});
            const [filterShop, setFilterShop] = useState(''); // For filtering the main list

            useEffect(() => {
                if (userProfile && userProfile.role !== 'Admin') {
                    setFilterShop(Array.isArray(userProfile.shop) ? '' : userProfile.shop || '');
                }
            }, [userProfile]);

            const availableShopsForFilter = useMemo(() => {
                if (userProfile?.role === 'Admin') return shops;
                if (userProfile?.role === 'Shop Manager' && Array.isArray(userProfile.shop)) {
                    return shops.filter(s => userProfile.shop.includes(s.name));
                }
                return [];
            }, [shops, userProfile]);

            const filteredLoans = useMemo(() => {
                return loans.filter(loan => (!filterShop || loan.shop === filterShop));
            }, [loans, filterShop]);

            const employeesInShop = useMemo(() => employees.filter(emp => emp.shop === selectedShop && emp.status === 'Active'), [selectedShop, employees]);
            
            const availableShopsForModal = useMemo(() => {
                if (userProfile?.role === 'Admin') return shops;
                if (userProfile?.role === 'Shop Manager') {
                    const managedShops = Array.isArray(userProfile.shop) ? userProfile.shop : [userProfile.shop];
                    return shops.filter(s => managedShops.includes(s.name));
                }
                return [];
            }, [shops, userProfile]);

            const canSelectShopInModal = userProfile?.role === 'Admin' || userProfile?.role === 'Shop Manager';

            const handleOpenModal = (loan = null) => {
                setEditingLoan(loan);
                let initialShop = '';
                if (userProfile.role === 'Shop Manager') {
                    const managedShops = Array.isArray(userProfile.shop) ? userProfile.shop : [userProfile.shop];
                    if (managedShops.length === 1) initialShop = managedShops[0];
                } else if (userProfile.role !== 'Admin') {
                    initialShop = userProfile.shop || '';
                }

                const initialData = loan ? { ...loan } : { loanDate: new Date().toISOString().substring(0, 10), shop: initialShop, staffId: '', loanAmount: '', agreedMonthlyDeduction: '', reason: '', totalPaid: 0, status: 'Active' };
                setFormData(initialData);
                setSelectedShop(initialData.shop || '');
                setModalOpen(true);
            };

            const handleCloseModal = () => { setModalOpen(false); setEditingLoan(null); };
            const handleChange = (e) => {
                const { name, value } = e.target;
                setFormData(prev => ({ ...prev, [name]: value }));
                if (name === 'shop') { setSelectedShop(value); setFormData(prev => ({...prev, staffId: ''})); }
            };
            const handleSave = async () => {
                const { addDoc, updateDoc, doc, collection } = window.firebaseSDK;
                const dataToSave = { ...formData, loanAmount: parseFloat(formData.loanAmount) || 0, agreedMonthlyDeduction: parseFloat(formData.agreedMonthlyDeduction) || 0, staffName: employees.find(e => e.id === formData.staffId)?.name || '' };
                try {
                    if (editingLoan) { await updateDoc(doc(db, 'staffLoans', editingLoan.id), dataToSave); } 
                    else { await addDoc(collection(db, 'staffLoans'), dataToSave); }
                    handleCloseModal();
                } catch (error) { console.error("Error saving loan:", error); }
            };
            const confirmDelete = async () => {
                if (!loanToDelete) return;
                try {
                    await window.firebaseSDK.deleteDoc(window.firebaseSDK.doc(db, 'staffLoans', loanToDelete.id));
                    setLoanToDelete(null);
                } catch (error) { console.error("Error deleting loan:", error); }
            };
            
            return (
                 <Card>
                    <div className="flex flex-wrap gap-4 justify-between items-center mb-6">
                        <h3 className="text-xl font-semibold text-slate-100">Loan Management</h3>
                        <div className="flex flex-wrap gap-4 items-center">
                            {(userProfile?.role === 'Admin' || (userProfile?.role === 'Shop Manager' && Array.isArray(userProfile.shop))) && (
                                <select value={filterShop} onChange={e => setFilterShop(e.target.value)} className="select w-full sm:w-auto">
                                    <option value="">{userProfile.role === 'Admin' ? 'All Shops' : 'All My Shops'}</option>
                                    {availableShopsForFilter.map(s => <option key={s.id} value={s.name}>{s.name}</option>)}
                                </select>
                            )}
                            <button onClick={() => handleOpenModal()} className="bg-blue-600 text-white px-4 py-2 rounded-lg shadow hover:bg-blue-700 transition-colors flex items-center gap-2"><i className="fas fa-plus"></i> Add New Loan</button>
                        </div>
                    </div>
                    <div className="overflow-x-auto"><table className="min-w-full divide-y divide-slate-700"><thead className="bg-slate-900/50"><tr><th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Staff Name</th><th className="px-4 py-3 text-right text-xs font-semibold text-slate-400 uppercase">Loan Amount</th><th className="px-4 py-3 text-right text-xs font-semibold text-slate-400 uppercase">Total Paid</th><th className="px-4 py-3 text-right text-xs font-semibold text-slate-400 uppercase">Balance</th><th className="px-4 py-3 text-center text-xs font-semibold text-slate-400 uppercase">Status</th><th className="px-4 py-3 text-center text-xs font-semibold text-slate-400 uppercase">Actions</th></tr></thead><tbody className="divide-y divide-slate-700">{filteredLoans.map(loan => { const balance = loan.loanAmount - loan.totalPaid; return (<tr key={loan.id} className="hover:bg-slate-700/50"><td className="px-4 py-4 text-sm text-slate-200">{loan.staffName}</td><td className="px-4 py-4 text-sm text-slate-300 text-right">{Utils.formatCurrency(loan.loanAmount)}</td><td className="px-4 py-4 text-sm text-slate-300 text-right">{Utils.formatCurrency(loan.totalPaid)}</td><td className="px-4 py-4 text-sm text-slate-300 text-right">{Utils.formatCurrency(balance)}</td><td className="px-4 py-4 text-center text-sm"><span className={`px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${balance <= 0 ? 'bg-green-100 text-green-800' : 'bg-blue-100 text-blue-800'}`}>{balance <= 0 ? 'Paid Off' : 'Active'}</span></td><td className="px-4 py-4 text-center whitespace-nowrap"><button onClick={() => handleOpenModal(loan)} className="text-blue-400 hover:text-blue-300 mr-4" title="Edit"><i className="fas fa-edit"></i></button><button onClick={() => setLoanToDelete(loan)} className="text-red-500 hover:text-red-400" title="Delete"><i className="fas fa-trash"></i></button></td></tr>); })}</tbody></table></div>
                    <Modal isOpen={isModalOpen} onClose={handleCloseModal}><ModalHeader title={editingLoan ? "Edit Loan" : "Add New Loan"} onClose={handleCloseModal} /><ModalBody><div className="space-y-4"><div><label className="text-sm">Shop</label><select name="shop" value={formData.shop || ''} onChange={handleChange} className="select" disabled={!canSelectShopInModal}><option value="">Select Shop</option>{availableShopsForModal.map(s => <option key={s.id} value={s.name}>{s.name}</option>)}</select></div><div><label className="text-sm">Staff</label><select name="staffId" value={formData.staffId || ''} onChange={handleChange} className="select" disabled={!selectedShop}><option value="">Select Staff</option>{employeesInShop.map(e => <option key={e.id} value={e.id}>{e.name}</option>)}</select></div><div><label className="text-sm">Loan Date</label><input type="date" name="loanDate" value={formData.loanDate || ''} onChange={handleChange} className="input"/></div><div><label className="text-sm">Loan Amount</label><input type="number" name="loanAmount" value={formData.loanAmount || ''} onChange={handleChange} className="input"/></div><div><label className="text-sm">Agreed Monthly Deduction</label><input type="number" name="agreedMonthlyDeduction" value={formData.agreedMonthlyDeduction || ''} onChange={handleChange} className="input"/></div><div><label className="text-sm">Reason</label><textarea name="reason" value={formData.reason || ''} onChange={handleChange} className="input" rows="3"></textarea></div></div></ModalBody><ModalFooter><button type="button" onClick={handleCloseModal} className="bg-slate-600 text-slate-200 px-4 py-2 rounded-lg hover:bg-slate-500">Cancel</button><button type="button" onClick={handleSave} className="bg-blue-600 text-white px-6 py-2 rounded-lg shadow hover:bg-blue-700">Save Loan</button></ModalFooter></Modal>
                    <ConfirmationModal isOpen={!!loanToDelete} onClose={() => setLoanToDelete(null)} onConfirm={confirmDelete} title="Delete Loan" message="Are you sure you want to delete this loan record?" />
                </Card>
            );
        };
        
        const LoanHistoryTab = ({ userProfile }) => {
            const { db } = useFirebase();
            const { where } = window.firebaseSDK;
            const [selectedShop, setSelectedShop] = useState('');
            const { data: shops } = useCollection('shops');

            useEffect(() => {
                if (userProfile && userProfile.role !== 'Admin') {
                    setSelectedShop(Array.isArray(userProfile.shop) ? '' : userProfile.shop || '');
                }
            }, [userProfile]);

            const queryConstraints = useMemo(() => {
                if (!userProfile) return [where("shop", "==", "null")];
                if (userProfile.role === 'Admin') {
                    return selectedShop ? [where("shop", "==", selectedShop)] : [];
                }
                if (userProfile.role === 'Shop Manager') {
                    const managedShops = Array.isArray(userProfile.shop) ? userProfile.shop : (userProfile.shop ? [userProfile.shop] : []);
                    if (managedShops.length === 0) return [where("shop", "==", "null")];
                    if (selectedShop) {
                        return [where("shop", "==", selectedShop)];
                    }
                    return [where("shop", "in", managedShops)];
                }
                return [where("shop", "==", userProfile.shop || null)];
            }, [userProfile, selectedShop]);
            
            const { data: loanPayments } = useCollection('loanPayments', queryConstraints);
            const { data: staffLoans } = useCollection('staffLoans');
            const [paymentToDelete, setPaymentToDelete] = useState(null);

            const confirmDelete = async () => {
                if (!paymentToDelete) return;
                const { doc, updateDoc, deleteDoc } = window.firebaseSDK;
                try {
                    // Revert the loan's totalPaid amount
                    const loan = staffLoans.find(l => l.id === paymentToDelete.loanId);
                    if (loan) {
                        const newTotalPaid = (loan.totalPaid || 0) - paymentToDelete.amountPaid;
                        const newStatus = newTotalPaid >= loan.loanAmount ? 'Paid Off' : 'Active';
                        await updateDoc(doc(db, 'staffLoans', loan.id), { totalPaid: newTotalPaid, status: newStatus });
                    }
                    await deleteDoc(doc(db, 'loanPayments', paymentToDelete.id));
                } catch (error) { console.error("Error deleting loan payment:", error); alert("Failed to delete loan payment."); } 
                finally { setPaymentToDelete(null); }
            };
            
            const availableShops = useMemo(() => {
                if (userProfile?.role === 'Admin') return shops;
                if (userProfile?.role === 'Shop Manager' && Array.isArray(userProfile.shop)) {
                    return shops.filter(s => userProfile.shop.includes(s.name));
                }
                return [];
            }, [shops, userProfile]);

            return (
                 <Card>
                    <div className="flex flex-wrap gap-4 justify-between items-center mb-6">
                        <h3 className="text-xl font-semibold text-slate-100">Loan Payment History</h3>
                        {(userProfile?.role === 'Admin' || (userProfile?.role === 'Shop Manager' && Array.isArray(userProfile.shop))) && (
                            <select value={selectedShop} onChange={e => setSelectedShop(e.target.value)} className="select w-full sm:w-auto">
                                <option value="">{userProfile.role === 'Admin' ? 'All Shops' : 'All My Shops'}</option>
                                {availableShops.map(s => <option key={s.id} value={s.name}>{s.name}</option>)}
                            </select>
                        )}
                    </div>
                    <div className="overflow-x-auto"><table className="min-w-full divide-y divide-slate-700"><thead className="bg-slate-900/50"><tr><th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Payment Date</th><th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Staff Name</th><th className="px-4 py-3 text-right text-xs font-semibold text-slate-400 uppercase">Amount Paid</th><th className="px-4 py-3 text-right text-xs font-semibold text-slate-400 uppercase">Remaining Balance</th><th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Note</th><th className="px-4 py-3 text-center text-xs font-semibold text-slate-400 uppercase">Actions</th></tr></thead><tbody className="divide-y divide-slate-700">{loanPayments.map(payment => (<tr key={payment.id} className="hover:bg-slate-700/50"><td className="px-4 py-4 text-sm text-slate-200">{payment.paymentDate}</td><td className="px-4 py-4 text-sm text-slate-300">{payment.staffName}</td><td className="px-4 py-4 text-sm text-slate-300 text-right">{Utils.formatCurrency(payment.amountPaid)}</td><td className="px-4 py-4 text-sm text-slate-300 text-right">{Utils.formatCurrency(payment.remainingBalance)}</td><td className="px-4 py-4 text-sm text-slate-300">{payment.note}</td><td className="px-4 py-4 text-center whitespace-nowrap"><button onClick={() => setPaymentToDelete(payment)} className="text-red-500 hover:text-red-400" title="Delete"><i className="fas fa-trash"></i></button></td></tr>))}</tbody></table></div>
                    <ConfirmationModal isOpen={!!paymentToDelete} onClose={() => setPaymentToDelete(null)} onConfirm={confirmDelete} title="Delete Loan Payment" message="Are you sure you want to delete this payment record? This will also update the loan's total paid amount." />
                </Card>
            );
        };
        // --- END LOAN MANAGER PAGE ---

        // --- START PAYROLL PAGE ---
        const PayrollPage = ({ userProfile }) => {
            const [activeTab, setActiveTab] = useState('calculator');
            const [editingRecord, setEditingRecord] = useState(null);
            const [initialHistoryMonth, setInitialHistoryMonth] = useState(new Date().toISOString().slice(0, 7));
            
            // Function to switch to calculator tab and load record for editing
            const handleEdit = (record) => { 
                setEditingRecord(record); 
                setActiveTab('calculator'); 
            };

            // Function to handle successful save, switch to history tab
            const handleSaveSuccess = (savedMonth) => { 
                setEditingRecord(null); 
                if (savedMonth) setInitialHistoryMonth(savedMonth); 
                setActiveTab('history'); 
            };

            return (
                <TabbedPage tabs={{ calculator: 'Payroll Calculator', history: 'Payroll History', employeeState: 'Employee State' }} activeTab={activeTab} setActiveTab={setActiveTab}>
                   <div id="calculator"><PayrollCalculatorTab userProfile={userProfile} editingRecord={editingRecord} onSaveSuccess={handleSaveSuccess} /></div>
                    <div id="history"><PayrollHistoryTab onEdit={handleEdit} initialMonth={initialHistoryMonth} userProfile={userProfile} /></div>
                    <div id="employeeState"><EmployeeStateTab userProfile={userProfile} /></div>
                </TabbedPage>
            );
        };

        const PayrollCalculatorTab = ({ userProfile, editingRecord, onSaveSuccess }) => {
            const { db } = useFirebase();
            const currentMonth = new Date().toISOString().slice(0, 7);
            const [selectedMonth, setSelectedMonth] = useState(currentMonth);
            const [selectedShop, setSelectedShop] = useState('');
            const [selectedEmployeeId, setSelectedEmployeeId] = useState('');
            const { data: shops } = useCollection('shops');
            const { data: employees } = useCollection('employees');
            const { data: attendance } = useCollection('attendance');
            const { data: leaveRequests } = useCollection('leaveRequests');
            const { data: otRequests } = useCollection('otRequests');
            const { data: staffLoans } = useCollection('staffLoans');
            const { data: employeeStates } = useCollection('employeeStates');
            const { data: salaryRevisions } = useCollection('salaryRevisions'); // Fetch all salary revisions
            const [manualInputs, setManualInputs] = useState({ workDays: '', givenOffDays: '', otDays: 0, leaveDays: 0, loanDeduction: 0, totalLateDays: 0 });
        
            // Normalize the shops managed by the user into an array.
            // This handles cases where a manager might be assigned a single shop as a string.
            const managedShops = useMemo(() => {
                if (!userProfile?.shop) return [];
                return Array.isArray(userProfile.shop) ? userProfile.shop : [userProfile.shop];
            }, [userProfile]);
        
            const isShopManager = userProfile?.role === 'Shop Manager';

            // Load editing record or reset form
            useEffect(() => {
                if (editingRecord) {
                    setSelectedMonth(editingRecord.month); setSelectedShop(editingRecord.shop); setSelectedEmployeeId(editingRecord.employeeId);
                    setManualInputs(editingRecord.manualInputs || { workDays: '', givenOffDays: '', otDays: 0, leaveDays: 0, loanDeduction: 0, totalLateDays: 0 });
                } else if (userProfile) {
                    // Admin or Shop Manager can select shops
                    if (userProfile.role === 'Admin' || isShopManager) {
                        setSelectedShop('');
                    } else {
                        // Staff are locked to their single shop
                        setSelectedShop(userProfile.shop || '');
                    }
                    setSelectedEmployeeId(''); setSelectedMonth(currentMonth);
                    setManualInputs({ workDays: '', givenOffDays: '', otDays: 0, leaveDays: 0, loanDeduction: 0, totalLateDays: 0 });
                }
            }, [editingRecord, userProfile, currentMonth, isShopManager]);
        
            const handleManualInputChange = (e) => { setManualInputs(prev => ({ ...prev, [e.target.name]: e.target.value })); };
            
            const availableShops = useMemo(() => {
                if (userProfile?.role === 'Admin') return shops;
                if (isShopManager) {
                    return shops.filter(s => managedShops.includes(s.name));
                }
                return [];
            }, [shops, userProfile, isShopManager, managedShops]);

            const employeesForDropdown = useMemo(() => {
                let relevantEmployees = [];
                if (userProfile?.role === 'Admin') {
                     relevantEmployees = selectedShop 
                        ? employees.filter(e => Array.isArray(e.shop) ? e.shop.includes(selectedShop) : e.shop === selectedShop)
                        : employees;
                } else if (isShopManager) {
                    const shopsToFilter = selectedShop ? [selectedShop] : managedShops;
                    relevantEmployees = employees.filter(e => {
                        const employeeShops = Array.isArray(e.shop) ? e.shop : [e.shop];
                        return employeeShops.some(s => shopsToFilter.includes(s));
                    });
                } else { // Staff
                    relevantEmployees = employees.filter(e => e.shop === userProfile.shop);
                }
                return relevantEmployees.filter(e => e.status === 'Active');
            }, [selectedShop, employees, userProfile, isShopManager, managedShops]);

            const selectedEmployee = useMemo(() => employees.find(emp => emp.id === selectedEmployeeId), [selectedEmployeeId, employees]);
        
            // Auto-populate form with data from other collections
            useEffect(() => {
                if (!selectedEmployee || !selectedMonth) { setManualInputs({ workDays: '', givenOffDays: '', otDays: 0, leaveDays: 0, loanDeduction: 0, totalLateDays: 0 }); return; };
                const leaveDays = leaveRequests.filter(lr => lr.staffId === selectedEmployee.id && lr.status === 'Approved' && lr.leaveDate.startsWith(selectedMonth)).reduce((acc, curr) => acc + (parseFloat(curr.numberOfDays) || 0), 0);
                const otDays = otRequests.filter(ot => ot.staffId === selectedEmployee.id && ot.status === 'Approved' && ot.reqDate.startsWith(selectedMonth)).reduce((acc, curr) => acc + (parseFloat(curr.numberOfOTDays) || 0), 0);
                const activeLoan = staffLoans.find(loan => loan.staffId === selectedEmployee.id && loan.status === 'Active');
                const loanDeduction = activeLoan ? parseFloat(activeLoan.agreedMonthlyDeduction) || 0 : 0;
                
                // Calculate total late days for the month
                const totalLateDays = employeeStates.filter(es =>
                    es.staffId === selectedEmployee.id &&
                    es.date.startsWith(selectedMonth) &&
                    es.statusState === 'Deduction' &&
                    es.note && es.note.includes('CheckIn Late')
                ).length;

                // New Work Day Calculation based on hours
                const filteredAttendance = attendance.filter(record => record.timestamp && record.employeeId === selectedEmployee.id && record.timestamp.toDate().toISOString().startsWith(selectedMonth));
                const dailyRecords = {};
                filteredAttendance.forEach(rec => { const dayKey = rec.timestamp.toDate().toISOString().split('T')[0]; if (!dailyRecords[dayKey]) dailyRecords[dayKey] = []; dailyRecords[dayKey].push({ date: rec.timestamp.toDate(), type: rec.type }); });
                
                let calculatedWorkDays = 0;
                Object.values(dailyRecords).forEach(dayRecords => {
                    const checkIns = dayRecords.filter(r => r.type === 'in').sort((a,b) => a.date - b.date);
                    const checkOuts = dayRecords.filter(r => r.type === 'out').sort((a,b) => b.date - a.date);
                    if(checkIns.length > 0 && checkOuts.length > 0) {
                        const diffHours = (checkOuts[0].date.getTime() - checkIns[0].date.getTime()) / 3600000;
                        if (diffHours >= 4) calculatedWorkDays += 1;
                        else if (diffHours > 1) calculatedWorkDays += 0.5;
                    }
                });

                // Also calculate given off days based on the new work days
                let calculatedOffDays = 0;
                if (calculatedWorkDays >= 28) calculatedOffDays = 4;
                else if (calculatedWorkDays >= 21) calculatedOffDays = 3;
                else if (calculatedWorkDays >= 14) calculatedOffDays = 2;
                else if (calculatedWorkDays >= 7) calculatedOffDays = 1;

                setManualInputs({ workDays: calculatedWorkDays, givenOffDays: calculatedOffDays, otDays, leaveDays, loanDeduction, totalLateDays });
            }, [selectedEmployee, selectedMonth, leaveRequests, otRequests, staffLoans, attendance, employeeStates]);
        
            // Perform all payroll calculations
            const calculations = useMemo(() => {
                if (!selectedEmployee) return {};

                // Determine the correct base salary based on effective revision dates
                const applicableRevisions = (salaryRevisions || [])
                    .filter(rev => rev.staffId === selectedEmployee.id && rev.effectiveDate && rev.effectiveDate <= `${selectedMonth}-31`)
                    .sort((a, b) => b.effectiveDate.localeCompare(a.effectiveDate));
                
                const baseSalary = applicableRevisions.length > 0
                    ? (parseFloat(String(applicableRevisions[0].updatedSalary).replace(/[^0-9.-]/g, '')) || 0)
                    : (parseFloat(String(selectedEmployee.salary).replace(/[^0-9.-]/g, '')) || 0);

                const [year, month] = selectedMonth.split('-');
                const daysInMonth = new Date(year, month, 0).getDate();
                const salaryPerDay = baseSalary / daysInMonth;
                const monthStates = employeeStates.filter(es => es.staffId === selectedEmployee.id && es.date.startsWith(selectedMonth));
                const engagements = monthStates.filter(es => es.statusState === 'Engagement' && es.status === 'Approved').reduce((sum, item) => sum + (parseFloat(item.amount) || 0), 0);
                
                const lateDeductionsAmount = monthStates
                    .filter(es => es.statusState === 'Deduction' && es.note?.includes('CheckIn Late'))
                    .reduce((sum, item) => sum + (parseFloat(item.amount) || 0), 0);
                
                const otherDeductions = monthStates
                    .filter(es => es.statusState === 'Deduction' && !es.note?.includes('CheckIn Late'))
                    .reduce((sum, item) => sum + (parseFloat(item.amount) || 0), 0);

                // ** NEW LOGIC AS PER YOUR FORMULA **
                // Leave days are now subtracted from the days to be paid.
                const daysToPayFor = (parseFloat(manualInputs.workDays) || 0) + (parseFloat(manualInputs.givenOffDays) || 0) - (parseFloat(manualInputs.leaveDays) || 0);
                const baseSalaryEarned = salaryPerDay * (daysToPayFor > 0 ? daysToPayFor : 0);
                
                const otSalary = salaryPerDay * (parseFloat(manualInputs.otDays) || 0);
                // Gross salary includes earnings from work, OT, and engagements.
                const grossSalary = baseSalaryEarned + otSalary + engagements;
                
                // Total deductions now follow the simplified formula.
                const totalDeductions = (parseFloat(manualInputs.loanDeduction) || 0) + lateDeductionsAmount + otherDeductions;
                
                const netSalary = grossSalary - totalDeductions;

                return { baseSalary, salaryPerDay, daysInMonth, baseSalaryEarned, otSalary, engagements, grossSalary, otherDeductions, totalDeductions, netSalary, lateDeductionsAmount };
            }, [selectedEmployee, selectedMonth, manualInputs, employeeStates]);
        
            const handleSavePayroll = async () => {
                if (!selectedEmployee || calculations.netSalary === undefined) { alert("Cannot save. Please ensure an employee is selected and payroll is calculated."); return; }
                const { addDoc, collection, serverTimestamp, doc, updateDoc } = window.firebaseSDK;
                const payrollData = { month: selectedMonth, shop: selectedEmployee.shop, employeeId: selectedEmployee.id, employeeName: selectedEmployee.name, baseSalary: calculations.baseSalary, netSalary: calculations.netSalary, manualInputs: manualInputs, calculations: calculations };
                try {
                    if (editingRecord) { await updateDoc(doc(db, 'payrollHistory', editingRecord.id), payrollData); } 
                    else { await addDoc(collection(db, 'payrollHistory'), { ...payrollData, createdAt: serverTimestamp() }); }
                    // If a loan deduction was made, update the loan and create a payment history record
                    if (manualInputs.loanDeduction > 0) {
                        const activeLoan = staffLoans.find(loan => loan.staffId === selectedEmployee.id && loan.status === 'Active');
                        if (activeLoan) {
                            const newTotalPaid = (activeLoan.totalPaid || 0) + manualInputs.loanDeduction;
                            const newBalance = activeLoan.loanAmount - newTotalPaid;
                            const newStatus = newBalance <= 0 ? 'Paid Off' : 'Active';
                            await updateDoc(doc(db, 'staffLoans', activeLoan.id), { totalPaid: newTotalPaid, status: newStatus });
                            await addDoc(collection(db, 'loanPayments'), { paymentDate: `${selectedMonth}-${new Date(selectedMonth.split('-')[0], selectedMonth.split('-')[1], 0).getDate()}`, staffId: selectedEmployee.id, staffName: selectedEmployee.name, shop: selectedEmployee.shop, loanId: activeLoan.id, amountPaid: manualInputs.loanDeduction, remainingBalance: newBalance, note: "Paid via payroll" });
                        }
                    }
                    alert('Payroll saved successfully!'); onSaveSuccess(selectedMonth);
                } catch (error) { console.error("Error saving payroll: ", error); alert('Failed to save payroll.'); }
            };
        
            const handleDownloadPayslip = () => {
                const payslipElement = document.getElementById('payslip-preview');
                if (!payslipElement || !selectedEmployee) { alert("Please select an employee to generate a payslip."); return; }
                const [year, month] = selectedMonth.split('-');
                html2canvas(payslipElement, { backgroundColor: '#ffffff', scale: 2 }).then(canvas => {
                    const link = document.createElement('a');
                    link.download = `${selectedEmployee.shop}-${selectedEmployee.name}-${month}-${year.substring(2)}.png`;
                    link.href = canvas.toDataURL('image/png'); link.click();
                });
            };
           
            const canSelectShop = (userProfile?.role === 'Admin' || isShopManager) && !editingRecord;
        
            return (
                <div className="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <Card><CardTitle>Payroll Calculator</CardTitle><div className="space-y-6"><div className="grid grid-cols-1 md:grid-cols-3 gap-4"><div><label className="text-sm font-medium text-slate-400">Month</label><input type="month" value={selectedMonth} onChange={e => setSelectedMonth(e.target.value)} className="input" /></div><div><label className="text-sm font-medium text-slate-400">Shop</label>{canSelectShop ? (<select value={selectedShop} onChange={e => { setSelectedShop(e.target.value); setSelectedEmployeeId(''); }} className="select"><option value="">{userProfile?.role === 'Admin' ? 'All Shops' : 'All My Shops'}</option>{availableShops.map(s => <option key={s.id} value={s.name}>{s.name}</option>)}</select>) : (<input value={selectedShop} className="input" disabled />)}</div><div><label className="text-sm font-medium text-slate-400">Employee</label><select value={selectedEmployeeId} onChange={e => setSelectedEmployeeId(e.target.value)} className="select" disabled={employeesForDropdown.length === 0}><option value="">Select Employee</option>{employeesForDropdown.map(e => <option key={e.id} value={e.id}>{e.name}</option>)}</select></div></div>{selectedEmployee && (<><div className="grid grid-cols-1 md:grid-cols-3 gap-4 pt-6 border-t border-slate-700"><h3 className="md:col-span-3 text-lg font-semibold text-slate-200">Attendance & Deductions</h3><div><label className="text-sm">Work Days</label><input type="number" name="workDays" value={manualInputs.workDays} className="input" disabled /></div><div><label className="text-sm">Given Off Days</label><input type="number" name="givenOffDays" value={manualInputs.givenOffDays} className="input" disabled /></div><div><label className="text-sm">OT Days</label><input type="number" name="otDays" value={manualInputs.otDays} className="input" disabled /></div><div><label className="text-sm">Leave Days</label><input type="number" name="leaveDays" value={manualInputs.leaveDays} className="input" disabled /></div><div><label className="text-sm">Total Late Days</label><input type="number" name="totalLateDays" value={manualInputs.totalLateDays || 0} className="input" disabled /></div><div><label className="text-sm">Loan Deduction</label><input type="number" name="loanDeduction" value={manualInputs.loanDeduction} onChange={handleManualInputChange} className="input" /></div></div><div className="pt-6 border-t border-slate-700 flex flex-col sm:flex-row gap-4"><button onClick={handleSavePayroll} className="flex-1 bg-blue-600 text-white px-4 py-2 rounded-lg shadow hover:bg-blue-700 transition-colors flex items-center justify-center gap-2"><i className="fas fa-save"></i> Save Payroll</button><button onClick={handleDownloadPayslip} className="flex-1 bg-green-600 text-white px-4 py-2 rounded-lg shadow hover:bg-green-700 transition-colors flex items-center justify-center gap-2"><i className="fas fa-download"></i> Download Payslip</button></div></>)}</div></Card>
                        <div id="payslip-preview" className="bg-white text-slate-800 p-6 rounded-lg shadow-2xl">
                        <div className="text-center mb-6">
                            <h2 className="text-2xl font-bold">PAYSLIP</h2>
                            <p className="text-slate-500">For the month of {selectedMonth}</p>
                        </div>
                        {selectedEmployee ? (
                        <>
                            <div className="grid grid-cols-2 gap-4 mb-6 text-sm">
                                <div>
                                    <p className="font-bold">{selectedEmployee.name}</p>
                                    <p>{selectedEmployee.position}</p>
                                    <p>Shift: {selectedEmployee.shift}</p>
                                </div>
                                <div className="text-right">
                                    <p>Shop: {selectedEmployee.shop}</p>
                                    <p>Base Salary: {Utils.formatCurrency(calculations.baseSalary)}</p>
                                    <p>Worked Dur.: {Utils.calculateWorkedDuration(selectedEmployee.joinedDate)}</p>
                                </div>
                            </div>
                            <div className="grid grid-cols-2 gap-6">
                                <div className="space-y-2 p-4 border-t-4 border-green-500 bg-green-50 rounded-b-lg">
                                    <h3 className="text-lg font-semibold text-slate-900">Earnings</h3>
                                    <div className="flex justify-between text-sm"><p>Work Days</p><p>{manualInputs.workDays || 0}</p></div>
                                    <div className="flex justify-between text-sm"><p>Given Off Days</p><p>{manualInputs.givenOffDays || 0}</p></div>
                                    <div className="flex justify-between text-sm pt-2 border-t border-slate-200"><p>Base Salary Earned</p><p>{Utils.formatCurrency(calculations.baseSalaryEarned)}</p></div>
                                    <div className="flex justify-between text-sm"><p>OT Salary</p><p>{Utils.formatCurrency(calculations.otSalary)}</p></div>
                                    <div className="flex justify-between text-sm"><p>Engagements</p><p>{Utils.formatCurrency(calculations.engagements)}</p></div>
                                    <div className="flex justify-between font-bold pt-2 border-t border-slate-300"><p>Gross Salary</p><p>{Utils.formatCurrency(calculations.grossSalary)}</p></div>
                                </div>
                                <div className="space-y-2 p-4 border-t-4 border-red-500 bg-red-50 rounded-b-lg">
                                    <h3 className="text-lg font-semibold text-slate-900">Deductions</h3>
                                    <div className="flex justify-between text-sm"><p>Leave Days</p><p className="text-red-600">-{manualInputs.leaveDays || 0}</p></div>
                                    <div className="flex justify-between text-sm"><p>No.of Late ({manualInputs.totalLateDays || 0} Days)</p><p>{Utils.formatCurrency(calculations.lateDeductionsAmount)}</p></div>
                                    <div className="flex justify-between text-sm"><p>Loan Deduction</p><p>{Utils.formatCurrency(manualInputs.loanDeduction)}</p></div>
                                    <div className="flex justify-between text-sm"><p>Other Deductions</p><p>{Utils.formatCurrency(calculations.otherDeductions)}</p></div>
                                    <div className="flex justify-between font-bold pt-2 border-t border-slate-300"><p>Total Deductions</p><p className="text-red-600">{Utils.formatCurrency(calculations.totalDeductions)}</p></div>
                                </div>
                            </div>
                            <div className="mt-6 p-4 bg-blue-100 border border-blue-300 rounded-lg text-center">
                                <p className="text-sm font-semibold text-blue-800">NET SALARY</p>
                                <p className="text-3xl font-bold text-blue-900">{Utils.formatCurrency(calculations.netSalary)}</p>
                            </div>
                        </>
                        ) : (
                            <div className="text-center py-20 text-slate-500"><i className="fas fa-file-invoice-dollar text-4xl mb-4"></i><p>Please select an employee to view the payslip.</p></div>
                        )}
                    </div>
                </div>
            );
        };

        const PayrollHistoryTab = ({ onEdit, initialMonth, userProfile }) => {
            const { db } = useFirebase();
            const { data: history } = useCollection('payrollHistory');
            const { data: shops } = useCollection('shops');
            const [recordToDelete, setRecordToDelete] = useState(null);
            const [selectedShop, setSelectedShop] = useState('');
            const [filterPeriod, setFilterPeriod] = useState('thisMonth');
            const [customMonth, setCustomMonth] = useState(new Date().toISOString().slice(0, 7));
            
            useEffect(() => { 
                if (initialMonth) {
                    setFilterPeriod('custom');
                    setCustomMonth(initialMonth);
                }
            }, [initialMonth]);
            useEffect(() => { if (userProfile && userProfile.role !== 'Admin') setSelectedShop(userProfile.shop || ''); }, [userProfile]);

            const { filteredHistory, totals } = useMemo(() => {
                const now = new Date();
                const thisMonthStr = now.toISOString().slice(0, 7);
                const lastMonthDate = new Date(now.getFullYear(), now.getMonth() - 1, 1);
                const lastMonthStr = lastMonthDate.toISOString().slice(0, 7);
                const thisYearStr = now.getFullYear().toString();

                const filtered = history.filter(rec => {
                    if (!rec.month) return false;
                    let dateMatch = false;
                    switch(filterPeriod) {
                        case 'thisMonth':
                            dateMatch = rec.month === thisMonthStr;
                            break;
                        case 'lastMonth':
                            dateMatch = rec.month === lastMonthStr;
                            break;
                        case 'thisYear':
                            dateMatch = rec.month.startsWith(thisYearStr);
                            break;
                        case 'custom':
                            dateMatch = rec.month === customMonth;
                            break;
                        default:
                            dateMatch = true;
                    }
                    return dateMatch && (!selectedShop || rec.shop === selectedShop);
                });

                const sorted = [...filtered].sort((a,b) => (b.createdAt?.toDate() || 0) - (a.createdAt?.toDate() || 0));
                const totals = sorted.reduce((acc, curr) => { acc.baseSalary += curr.baseSalary || 0; acc.loanDeduction += curr.manualInputs?.loanDeduction || 0; acc.netSalary += curr.netSalary || 0; return acc; }, { baseSalary: 0, loanDeduction: 0, netSalary: 0 });
                return { filteredHistory: sorted, totals };
            }, [history, selectedShop, filterPeriod, customMonth]);

            const handleDelete = async () => {
                if (!recordToDelete) return;
                try { await window.firebaseSDK.deleteDoc(window.firebaseSDK.doc(db, 'payrollHistory', recordToDelete.id)); setRecordToDelete(null); } 
                catch (error) { console.error("Error deleting payroll record:", error); setRecordToDelete(null); }
            };

            return (
                <Card>
                    <div className="flex flex-wrap gap-4 justify-between items-center mb-6"><CardTitle>Payroll History</CardTitle><div className="flex flex-wrap gap-4 items-center">{userProfile?.role === 'Admin' && (<select value={selectedShop} onChange={e => setSelectedShop(e.target.value)} className="select w-full sm:w-auto"><option value="">All Shops</option>{shops.map(s => <option key={s.id} value={s.name}>{s.name}</option>)}</select>)}
                        <select value={filterPeriod} onChange={e => setFilterPeriod(e.target.value)} className="select w-full sm:w-auto">
                            <option value="thisMonth">This Month</option>
                            <option value="lastMonth">Last Month</option>
                            <option value="thisYear">This Year</option>
                            <option value="custom">Custom Month</option>
                        </select>
                        {filterPeriod === 'custom' && (
                            <input type="month" value={customMonth} onChange={e => setCustomMonth(e.target.value)} className="input w-full sm:w-auto" />
                        )}
                    </div></div>
                    <div className="overflow-x-auto"><table className="min-w-full divide-y divide-slate-700"><thead className="bg-slate-900/50"><tr><th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Date</th><th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Shop Name</th><th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Employee</th><th className="px-4 py-3 text-right text-xs font-semibold text-slate-400 uppercase">Base Salary</th><th className="px-4 py-3 text-right text-xs font-semibold text-slate-400 uppercase">Loan Deduction</th><th className="px-4 py-3 text-right text-xs font-semibold text-slate-400 uppercase">Final Salary</th><th className="px-4 py-3 text-center text-xs font-semibold text-slate-400 uppercase">Actions</th></tr></thead><tbody className="divide-y divide-slate-700">{filteredHistory.map(rec => (<tr key={rec.id} className="hover:bg-slate-700/50"><td className="px-4 py-4 text-sm text-slate-200">{rec.month}</td><td className="px-4 py-4 text-sm text-slate-300">{rec.shop}</td><td className="px-4 py-4 text-sm text-slate-300">{rec.employeeName}</td><td className="px-4 py-4 text-sm text-slate-300 text-right">{Utils.formatCurrency(rec.baseSalary)}</td><td className="px-4 py-4 text-sm text-slate-300 text-right">{Utils.formatCurrency(rec.manualInputs?.loanDeduction)}</td><td className="px-4 py-4 text-sm text-slate-300 text-right font-semibold">{Utils.formatCurrency(rec.netSalary)}</td><td className="px-4 py-4 text-center whitespace-nowrap"><button onClick={() => onEdit(rec)} className="text-blue-400 hover:text-blue-300 mr-4" title="Edit"><i className="fas fa-edit"></i></button><button onClick={() => setRecordToDelete(rec)} className="text-red-500 hover:text-red-400" title="Delete"><i className="fas fa-trash"></i></button></td></tr>))}</tbody><tfoot className="bg-slate-900/50"><tr><td colSpan="3" className="px-4 py-3 text-right font-bold text-slate-300 uppercase">Sub-Total</td><td className="px-4 py-3 text-right font-bold text-slate-300">{Utils.formatCurrency(totals.baseSalary)}</td><td className="px-4 py-3 text-right font-bold text-slate-300">{Utils.formatCurrency(totals.loanDeduction)}</td><td className="px-4 py-3 text-right font-bold text-slate-300">{Utils.formatCurrency(totals.netSalary)}</td><td></td></tr></tfoot></table></div>
                    <ConfirmationModal isOpen={!!recordToDelete} onClose={() => setRecordToDelete(null)} onConfirm={handleDelete} title="Delete Payroll Record" message="Are you sure you want to delete this payroll record? This action cannot be undone." />
                </Card>
            );
        };

        const EmployeeStateTab = ({ userProfile }) => {
            const { db } = useFirebase();
            const [isModalOpen, setModalOpen] = useState(false);
            const [editingRecord, setEditingRecord] = useState(null);
            const [recordToDelete, setRecordToDelete] = useState(null);
            const { where } = window.firebaseSDK;

            const queryConstraints = useMemo(() => {
                if (!userProfile) return [where("shop", "==", "null")];
                if (userProfile.role === 'Admin') return [];
                if (userProfile.role === 'Shop Manager') {
                    const shops = Array.isArray(userProfile.shop) ? userProfile.shop : (userProfile.shop ? [userProfile.shop] : []);
                    if (shops.length > 0) {
                        return [where("shop", "in", shops)];
                    }
                    return [where("staffId", "==", "null")]; // No shops, no data
                }
                return [where("shop", "==", userProfile.shop || null)];
            }, [userProfile]);

            const { data: employeeStates } = useCollection('employeeStates', queryConstraints);
            const { data: shops } = useCollection('shops');
            const { data: employees } = useCollection('employees');
            const [selectedShop, setSelectedShop] = useState('');
            const [selectedMonth, setSelectedMonth] = useState(new Date().toISOString().slice(0, 7));
            const [selectedEmployeeId, setSelectedEmployeeId] = useState('');

            useEffect(() => {
                if (userProfile && userProfile.role !== 'Admin') {
                    // For managers with multiple shops, default to showing all their shops.
                    // For single-shop users, their shop is pre-selected.
                    setSelectedShop(Array.isArray(userProfile.shop) ? '' : userProfile.shop || '');
                }
            }, [userProfile]);

            const availableShops = useMemo(() => {
                if (userProfile?.role === 'Admin') return shops;
                if (userProfile?.role === 'Shop Manager' && Array.isArray(userProfile.shop)) {
                    return shops.filter(s => userProfile.shop.includes(s.name));
                }
                return [];
            }, [shops, userProfile]);

            const employeesInShop = useMemo(() => {
                if (!selectedShop) return [];
                return employees.filter(emp => emp.shop === selectedShop && emp.status === 'Active');
            }, [selectedShop, employees]);

            const filteredRecords = useMemo(() => {
                const records = employeeStates.filter(rec => 
                    (!selectedShop || rec.shop === selectedShop) &&
                    (!selectedMonth || rec.date.startsWith(selectedMonth)) &&
                    (!selectedEmployeeId || rec.staffId === selectedEmployeeId)
                );
                
                // Sort records: Pending first, then by date descending
                return records.sort((a, b) => {
                    if (a.status === 'Pending' && b.status !== 'Pending') return -1;
                    if (a.status !== 'Pending' && b.status === 'Pending') return 1;
                    return new Date(b.date) - new Date(a.date);
                });
            }, [employeeStates, selectedShop, selectedMonth, selectedEmployeeId]);
            
            const handleOpenModal = (record = null) => { setEditingRecord(record); setModalOpen(true); };
            const handleCloseModal = () => { setEditingRecord(null); setModalOpen(false); };

            const handleSave = async (formData) => {
                const { addDoc, collection, doc, updateDoc } = window.firebaseSDK;
                const staffName = employees.find(e => e.id === formData.staffId)?.name || '';
                const dataToSave = { ...formData, amount: parseFloat(formData.amount) || 0, staffName: staffName };

                // Add approval status for new records
                if (!formData.id) {
                    dataToSave.status = dataToSave.statusState === 'Engagement' ? 'Pending' : 'Approved';
                }

                try {
                    if (formData.id) { const { id, ...data } = dataToSave; await updateDoc(doc(db, 'employeeStates', id), data); } 
                    else { await addDoc(collection(db, 'employeeStates'), dataToSave); }
                    handleCloseModal();
                } catch (error) { console.error("Error saving employee state:", error); }
            };

            const handleDelete = async () => {
                if (!recordToDelete) return;
                try {
                    await window.firebaseSDK.deleteDoc(window.firebaseSDK.doc(db, 'employeeStates', recordToDelete.id));
                    setRecordToDelete(null);
                } catch (error) { console.error("Error deleting record:", error); setRecordToDelete(null); }
            };

            const handleUpdateStatus = useCallback(async (recordId, newStatus) => {
                if (!recordId || !newStatus) return;
                try {
                    await window.firebaseSDK.updateDoc(window.firebaseSDK.doc(db, 'employeeStates', recordId), { status: newStatus });
                } catch (error) {
                    console.error(`Error updating record ${recordId} status:`, error);
                }
            }, [db]);

            const handleExportExcel = useCallback(() => {
                const dataToExport = filteredRecords.map(rec => ({
                    'Date': rec.date,
                    'Shop': rec.shop,
                    'Staff Name': rec.staffName,
                    'Status': rec.statusState,
                    'Amount (KHR)': parseFloat(String(rec.amount).replace(/[^0-9.-]/g, '')) || 0,
                    'Reason / Note': rec.note,
                }));
                const worksheet = XLSX.utils.json_to_sheet(dataToExport);
                const workbook = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(workbook, worksheet, "Employee States");
                
                worksheet["!cols"] = [ { wch: 12 }, { wch: 15 }, { wch: 25 }, { wch: 15 }, { wch: 15 }, { wch: 40 } ];
                
                XLSX.writeFile(workbook, `Employee_State_Report_${selectedMonth}.xlsx`);
            }, [filteredRecords, selectedMonth]);
            
            return (
                <Card>
                    <div className="flex flex-wrap gap-4 justify-between items-center mb-6">
                        <h3 className="text-xl font-semibold text-slate-100">Employee State Records</h3>
                        <div className="flex flex-wrap gap-4 items-center">
                            {(userProfile?.role === 'Admin' || (userProfile?.role === 'Shop Manager' && Array.isArray(userProfile.shop))) && (
                                <select value={selectedShop} onChange={e => { setSelectedShop(e.target.value); setSelectedEmployeeId(''); }} className="select w-full sm:w-auto">
                                    <option value="">{userProfile.role === 'Admin' ? 'All Shops' : 'All My Shops'}</option>
                                    {availableShops.map(s => <option key={s.id} value={s.name}>{s.name}</option>)}
                                </select>
                            )}
                            {(userProfile?.role === 'Admin' || userProfile?.role === 'Shop Manager') && selectedShop && (
                                <select value={selectedEmployeeId} onChange={e => setSelectedEmployeeId(e.target.value)} className="select w-full sm:w-auto">
                                    <option value="">All Staff</option>
                                    {employeesInShop.map(e => <option key={e.id} value={e.id}>{e.name}</option>)}
                                </select>
                            )}
                            <input type="month" value={selectedMonth} onChange={e => setSelectedMonth(e.target.value)} className="input w-full sm:w-auto" />
                            <button onClick={handleExportExcel} className="bg-green-600 text-white px-4 py-2 rounded-lg shadow hover:bg-green-700 transition-colors flex items-center gap-2"><i className="fas fa-file-excel"></i> Excel</button>
                            <button onClick={() => handleOpenModal()} className="bg-blue-600 text-white px-4 py-2 rounded-lg shadow hover:bg-blue-700 transition-colors flex items-center gap-2"><i className="fas fa-plus"></i> Add</button>
                        </div>
                    </div>
                    {/* Desktop Table */}
                    <div className="overflow-x-auto hidden md:block"><table className="min-w-full divide-y divide-slate-700"><thead className="bg-slate-900/50"><tr><th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Date</th><th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Shop</th><th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Staff</th><th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Type</th><th className="px-4 py-3 text-right text-xs font-semibold text-slate-400 uppercase">Amount</th><th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Reason</th><th className="px-4 py-3 text-center text-xs font-semibold text-slate-400 uppercase">Status</th><th className="px-4 py-3 text-center text-xs font-semibold text-slate-400 uppercase">Actions</th></tr></thead><tbody className="divide-y divide-slate-700">{filteredRecords.map(record => (<tr key={record.id} className="hover:bg-slate-700/50"><td className="px-4 py-4 text-sm text-slate-200">{record.date}</td><td className="px-4 py-4 text-sm text-slate-300">{record.shop}</td><td className="px-4 py-4 text-sm text-slate-300">{record.staffName}</td><td className="px-4 py-4 text-sm text-slate-300">{record.statusState}</td><td className="px-4 py-4 text-sm text-slate-300 text-right">{Utils.formatCurrency(record.amount)}</td><td className="px-4 py-4 text-sm text-slate-300">{record.note}</td><td className="px-4 py-4 text-center text-sm">{record.statusState === 'Engagement' && (<span className={`px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${ record.status === 'Approved' ? 'bg-green-100 text-green-800' : record.status === 'Rejected' ? 'bg-red-100 text-red-800' : 'bg-yellow-100 text-yellow-800' }`}>{record.status || 'Pending'}</span>)}</td><td className="px-4 py-4 text-center whitespace-nowrap">{userProfile?.role === 'Admin' && record.statusState === 'Engagement' && record.status === 'Pending' && (<><button onClick={() => handleUpdateStatus(record.id, 'Approved')} className="text-green-400 hover:text-green-300 mr-3" title="Approve"><i className="fas fa-check-circle"></i></button><button onClick={() => handleUpdateStatus(record.id, 'Rejected')} className="text-orange-400 hover:text-orange-300 mr-3" title="Reject"><i className="fas fa-times-circle"></i></button></>)}{userProfile?.role === 'Admin' && (<><button onClick={() => handleOpenModal(record)} className="text-blue-400 hover:text-blue-300 mr-4"><i className="fas fa-edit"></i></button><button onClick={() => setRecordToDelete(record)} className="text-red-500 hover:text-red-400"><i className="fas fa-trash"></i></button></>)}</td></tr>))}</tbody></table></div>
                    {/* Mobile Cards */}
                    <div className="grid grid-cols-1 gap-4 md:hidden">{filteredRecords.map(record => (<div key={record.id} className="bg-slate-700/50 rounded-lg p-4 space-y-3"><div className="flex justify-between items-start"><div><p className="font-bold text-lg text-slate-100">{record.staffName}</p><p className="text-sm text-slate-300">{record.shop}</p></div><div className="flex space-x-3">{userProfile?.role === 'Admin' && (<><button onClick={() => handleOpenModal(record)} className="text-blue-400 hover:text-blue-300"><i className="fas fa-edit"></i></button><button onClick={() => setRecordToDelete(record)} className="text-red-500 hover:text-red-400"><i className="fas fa-trash"></i></button></>)}</div></div><div className="grid grid-cols-2 gap-x-4 gap-y-2 text-sm pt-2 border-t border-slate-600"><div><p className="text-slate-400">Date</p><p className="text-slate-200 font-medium">{record.date}</p></div><div><p className="text-slate-400">Type</p><p className="text-slate-200 font-medium">{record.statusState}</p></div><div><p className="text-slate-400">Amount</p><p className="text-slate-200 font-medium">{Utils.formatCurrency(record.amount)}</p></div>{record.statusState === 'Engagement' && (<div><p className="text-slate-400">Status</p><p className="text-slate-200 font-medium"><span className={`px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${ record.status === 'Approved' ? 'bg-green-100 text-green-800' : record.status === 'Rejected' ? 'bg-red-100 text-red-800' : 'bg-yellow-100 text-yellow-800' }`}>{record.status || 'Pending'}</span></p></div>)}<div className="col-span-2"><p className="text-slate-400">Reason</p><p className="text-slate-200 font-medium">{record.note || 'N/A'}</p></div></div>{userProfile?.role === 'Admin' && record.statusState === 'Engagement' && record.status === 'Pending' && (<div className="flex justify-end space-x-4 pt-3 border-t border-slate-600"><button onClick={() => handleUpdateStatus(record.id, 'Rejected')} className="bg-orange-600 text-white px-4 py-2 text-sm rounded-lg hover:bg-orange-700">Reject</button><button onClick={() => handleUpdateStatus(record.id, 'Approved')} className="bg-green-600 text-white px-4 py-2 text-sm rounded-lg hover:bg-green-700">Approve</button></div>)}</div>))}</div>
                    <EmployeeStateModal isOpen={isModalOpen} onClose={handleCloseModal} onSave={handleSave} record={editingRecord} userProfile={userProfile} />
                    <ConfirmationModal isOpen={!!recordToDelete} onClose={() => setRecordToDelete(null)} onConfirm={handleDelete} title="Delete Record" message="Are you sure you want to delete this record?" />
                </Card>
            );
        };

        const EmployeeStateModal = ({ isOpen, onClose, onSave, record, userProfile }) => {
            const [formData, setFormData] = useState({});
            const [selectedShop, setSelectedShop] = useState('');
            const { data: shops } = useCollection('shops');
            const { data: employees } = useCollection('employees');

            const availableShops = useMemo(() => {
                if (!userProfile) return [];
                if (userProfile.role === 'Admin') return shops;
                
                const managedShops = Array.isArray(userProfile.shop) ? userProfile.shop : (userProfile.shop ? [userProfile.shop] : []);
                if (managedShops.length > 0) {
                    return shops.filter(s => managedShops.includes(s.name));
                }
                return [];
            }, [shops, userProfile]);

            const canSelectShop = useMemo(() => {
                if (!userProfile) return false;
                if (userProfile.role === 'Admin') return true;
                if (userProfile.role === 'Shop Manager' && Array.isArray(userProfile.shop) && userProfile.shop.length > 1) return true;
                return false;
            }, [userProfile]);

            useEffect(() => {
                let initialShop = '';
                if (!record && userProfile) { // Set default shop for NEW records based on user profile
                     if (userProfile.role !== 'Admin') {
                        const managedShops = Array.isArray(userProfile.shop) ? userProfile.shop : (userProfile.shop ? [userProfile.shop] : []);
                        if (managedShops.length === 1) {
                            initialShop = managedShops[0];
                        }
                     }
                }

                const initialData = record 
                    ? { ...record } 
                    : { date: new Date().toISOString().substring(0, 10), shop: initialShop, staffId: '', statusState: 'Deduction', amount: '', note: '' };
                
                setFormData(initialData);
                setSelectedShop(initialData.shop || '');
            }, [record, isOpen, userProfile]);
            
            const employeesInShop = useMemo(() => {
                if (!selectedShop) return [];
                return employees.filter(emp => {
                    const employeeShops = Array.isArray(emp.shop) ? emp.shop : [emp.shop];
                    return employeeShops.includes(selectedShop) && emp.status === 'Active';
                });
            }, [selectedShop, employees]);
            
            const handleChange = (e) => {
                const { name, value } = e.target;
                setFormData(prev => ({ ...prev, [name]: value }));
                if (name === 'shop') { 
                    setSelectedShop(value); 
                    setFormData(prev => ({ ...prev, staffId: '' })); // Reset staff selection when shop changes
                }
            };

            const handleSubmit = (e) => { 
                e.preventDefault(); 
                if (!formData.shop || !formData.staffId || !formData.amount) { 
                    alert("Please fill all required fields."); 
                    return; 
                } 
                onSave(formData); 
            };

            return (
                <Modal isOpen={isOpen} onClose={onClose}>
                    <form onSubmit={handleSubmit}>
                        <ModalHeader title={record ? "Edit Record" : "Add New Record"} onClose={onClose} />
                        <ModalBody>
                            <div className="space-y-4">
                                <div><label className="text-sm">Date</label><input type="date" name="date" value={formData.date || ''} onChange={handleChange} className="input"/></div>
                                <div>
                                    <label className="text-sm">Shop</label>
                                    <select name="shop" value={formData.shop || ''} onChange={handleChange} className="select" disabled={!canSelectShop}>
                                        <option value="">Select Shop</option>
                                        {availableShops.map(s => <option key={s.id} value={s.name}>{s.name}</option>)}
                                    </select>
                                </div>
                                <div><label className="text-sm">Staff</label><select name="staffId" value={formData.staffId || ''} onChange={handleChange} className="select" disabled={!selectedShop}><option value="">Select Staff</option>{employeesInShop.map(e => <option key={e.id} value={e.id}>{e.name}</option>)}</select></div>
                                <div><label className="text-sm">Status State</label><select name="statusState" value={formData.statusState || 'Deduction'} onChange={handleChange} className="select"><option>Deduction</option><option>Engagement</option></select></div>
                                <div><label className="text-sm">Amount (KHR)</label><input type="number" name="amount" value={formData.amount || ''} onChange={handleChange} className="input"/></div>
                                <div><label className="text-sm">Reason / Note</label><textarea name="note" value={formData.note || ''} onChange={handleChange} className="input" rows="3"></textarea></div>
                            </div>
                        </ModalBody>
                        <ModalFooter>
                            <button type="button" onClick={onClose} className="bg-slate-600 text-slate-200 px-4 py-2 rounded-lg hover:bg-slate-500">Cancel</button>
                            <button type="submit" className="bg-blue-600 text-white px-6 py-2 rounded-lg shadow hover:bg-blue-700">Save Record</button>
                        </ModalFooter>
                    </form>
                </Modal>
            );
        };
        // --- END PAYROLL PAGE ---

        // --- START EXPENSE REPORT PAGE ---
        const ExpenseReportPage = () => {
            const { data: payrollHistory } = useCollection('payrollHistory');
            const { data: shops } = useCollection('shops');
            const [selectedShop, setSelectedShop] = useState('');
            const [selectedMonth, setSelectedMonth] = useState(new Date().toISOString().slice(0, 7));

            const { expenseSummary, totals } = useMemo(() => {
                if (!payrollHistory.length) return { expenseSummary: [], totals: {} };
                const filteredHistory = payrollHistory.filter(rec => (!selectedShop || rec.shop === selectedShop) && (!selectedMonth || rec.month === selectedMonth));
                
                // Group payroll records by shop and month
                const summary = filteredHistory.reduce((acc, rec) => {
                    if (!rec.shop || !rec.month) return acc;
                    const key = `${rec.shop}_${rec.month}`;
                    if (!acc[key]) { acc[key] = { month: rec.month, shopName: rec.shop, totalLoanDed: 0, totalOtherDed: 0, totalFinalSalary: 0 }; }
                    acc[key].totalLoanDed += parseFloat(rec.manualInputs?.loanDeduction) || 0;
                    acc[key].totalOtherDed += parseFloat(rec.calculations?.otherDeductions) || 0;
                    acc[key].totalFinalSalary += parseFloat(rec.netSalary) || 0;
                    return acc;
                }, {});

                const summaryArray = Object.values(summary).map(item => {
                    const accountNote = (item.totalFinalSalary || 0) + (item.totalLoanDed || 0) + (item.totalOtherDed || 0);
                    return { ...item, accountNote };
                }).sort((a, b) => b.month.localeCompare(a.month) || a.shopName.localeCompare(b.shopName));

                const totals = summaryArray.reduce((acc, curr) => { 
                    acc.totalLoanDed += curr.totalLoanDed; 
                    acc.totalOtherDed += curr.totalOtherDed; 
                    acc.totalFinalSalary += curr.totalFinalSalary; 
                    acc.totalAccountNote += curr.accountNote;
                    return acc; 
                }, { totalLoanDed: 0, totalOtherDed: 0, totalFinalSalary: 0, totalAccountNote: 0 });
                
                return { expenseSummary: summaryArray, totals };
            }, [payrollHistory, selectedShop, selectedMonth]);

            return (
                <Card>
                    <div className="flex flex-wrap gap-4 justify-between items-center mb-6"><CardTitle>Expense Report Summary</CardTitle><div className="flex flex-wrap gap-4 items-center"><select value={selectedShop} onChange={e => setSelectedShop(e.target.value)} className="select w-full sm:w-auto"><option value="">All Shops</option>{shops.map(s => <option key={s.id} value={s.name}>{s.name}</option>)}</select><input type="month" value={selectedMonth} onChange={e => setSelectedMonth(e.target.value)} className="input w-full sm:w-auto" /></div></div>
                    <div className="overflow-x-auto"><table className="min-w-full divide-y divide-slate-700"><thead className="bg-slate-900/50"><tr><th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Month (MM-YYYY)</th><th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Shop Name</th><th className="px-4 py-3 text-right text-xs font-semibold text-slate-400 uppercase">Total Loan Ded.</th><th className="px-4 py-3 text-right text-xs font-semibold text-slate-400 uppercase">Total Other Ded.</th><th className="px-4 py-3 text-right text-xs font-semibold text-slate-400 uppercase">Total Final Salary</th><th className="px-4 py-3 text-right text-xs font-semibold text-slate-400 uppercase">Account Note</th></tr></thead><tbody className="divide-y divide-slate-700">{expenseSummary.map((item, index) => (<tr key={index} className="hover:bg-slate-700/50"><td className="px-4 py-4 text-sm text-slate-200">{item.month}</td><td className="px-4 py-4 text-sm text-slate-300">{item.shopName}</td><td className="px-4 py-4 text-sm text-slate-300 text-right">{Utils.formatCurrency(item.totalLoanDed)}</td><td className="px-4 py-4 text-sm text-slate-300 text-right">{Utils.formatCurrency(item.totalOtherDed)}</td><td className="px-4 py-4 text-sm text-slate-300 text-right font-semibold">{Utils.formatCurrency(item.totalFinalSalary)}</td><td className="px-4 py-4 text-sm text-slate-300 text-right font-semibold">{Utils.formatCurrency(item.accountNote)}</td></tr>))}</tbody><tfoot className="bg-slate-900/50"><tr><td colSpan="2" className="px-4 py-3 text-right font-bold text-slate-300 uppercase">Sub-Total</td><td className="px-4 py-3 text-right font-bold text-slate-300">{Utils.formatCurrency(totals.totalLoanDed)}</td><td className="px-4 py-3 text-right font-bold text-slate-300">{Utils.formatCurrency(totals.totalOtherDed)}</td><td className="px-4 py-3 text-right font-bold text-slate-300">{Utils.formatCurrency(totals.totalFinalSalary)}</td><td className="px-4 py-3 text-right font-bold text-slate-300">{Utils.formatCurrency(totals.totalAccountNote)}</td></tr></tfoot></table></div>
                </Card>
            );
        };
        // --- END EXPENSE REPORT PAGE ---

        // --- START USER ACTIVITY PAGE ---
        const UserActivityPage = () => {
            const { data: logs } = useCollection('userLogs');
            const { data: employees } = useCollection('employees');
            const employeeNameMap = useMemo(() => employees.reduce((acc, emp) => { if (emp.uid) acc[emp.uid] = emp.name; return acc; }, {}), [employees]);
            
            // Function to format log details for better readability
            const formatActivityDetails = (log) => {
                const { originalData, updatedData, action } = log;
                if (action === 'Add Employee' || action === 'Delete Employee') {
                    return `Details for ${log.targetName}`;
                }
                if (originalData && updatedData) {
                    const changes = [];
                    const allKeys = new Set([...Object.keys(originalData), ...Object.keys(updatedData)]);
                    
                    const formatValue = (val) => {
                        if (val === undefined || val === null) return 'empty';
                        if (Array.isArray(val)) return `[${val.join(', ')}]`;
                        return String(val);
                    };

                    allKeys.forEach(key => {
                        if (key === 'id') return;
                        const originalValue = formatValue(originalData[key]);
                        const updatedValue = formatValue(updatedData[key]);
                        if (originalValue !== updatedValue) {
                            changes.push(`${key}: from '${originalValue}' to '${updatedValue}'`);
                        }
                    });
                    return changes.length > 0 ? changes.join('; ') : 'No detailed changes detected.';
                }
                return log.action || 'Unknown Action';
            };
            
            return (<Card><CardTitle>User Activity Log</CardTitle><div className="overflow-x-auto"><table className="min-w-full divide-y divide-slate-700"><thead className="bg-slate-900/50"><tr><th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Timestamp</th><th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">User</th><th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Action</th><th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Target</th><th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Activity Details</th></tr></thead><tbody className="divide-y divide-slate-700">{logs.sort((a, b) => (b.timestamp?.toDate() || 0) - (a.timestamp?.toDate() || 0)).map(log => (<tr key={log.id} className="hover:bg-slate-700/50"><td className="px-4 py-4 text-sm text-slate-200 whitespace-nowrap">{log.timestamp ? log.timestamp.toDate().toLocaleString() : 'No date'}</td><td className="px-4 py-4 text-sm text-slate-300">{employeeNameMap[log.userId] || log.userId}</td><td className="px-4 py-4 text-sm text-slate-300">{log.action}</td><td className="px-4 py-4 text-sm text-slate-300">{log.targetName || 'N/A'}</td><td className="px-4 py-4 text-sm text-slate-300">{formatActivityDetails(log)}</td></tr>))}</tbody></table></div></Card>);
        };
        // --- END USER ACTIVITY PAGE ---

        // --- START SETTINGS PAGE ---
        const MemoAlertTab = () => {
            const { db } = useFirebase();
            const [memoContent, setMemoContent] = useState('');
            const [memoStatus, setMemoStatus] = useState('Deactive');
            const [loading, setLoading] = useState(true);
            const [saving, setSaving] = useState(false);

            useEffect(() => {
                if (!db) return;
                const { doc, onSnapshot } = window.firebaseSDK;
                const memoRef = doc(db, "settings", "memoAlert");
                const unsubscribe = onSnapshot(memoRef, (doc) => {
                    if (doc.exists()) {
                        const data = doc.data();
                        setMemoContent(data.content || '');
                        setMemoStatus(data.status || 'Deactive');
                    }
                    setLoading(false);
                }, (error) => {
                    console.error("Error fetching memo: ", error);
                    setLoading(false);
                });
                return () => unsubscribe();
            }, [db]);

            const handleSave = async () => {
                if (!db) return;
                setSaving(true);
                const { doc, setDoc } = window.firebaseSDK;
                const memoRef = doc(db, "settings", "memoAlert");
                try {
                    await setDoc(memoRef, { content: memoContent, status: memoStatus }, { merge: true });
                } catch (error) {
                    console.error("Error saving memo: ", error);
                } finally {
                    setSaving(false);
                }
            };

            if (loading) {
                return <Card><CardTitle>Memo Alert</CardTitle><div>Loading...</div></Card>;
            }

            return (
                <Card>
                    <CardTitle>Memo Alert Settings</CardTitle>
                    <div className="space-y-6">
                        <div>
                            <label htmlFor="memoContent" className="block text-sm font-medium text-slate-400">Memo Content (5-6 lines recommended)</label>
                            <textarea
                                id="memoContent"
                                name="memoContent"
                                rows="6"
                                className="input mt-1"
                                value={memoContent}
                                onChange={(e) => setMemoContent(e.target.value)}
                                placeholder="Enter your memo alert here..."
                            ></textarea>
                        </div>
                        <div>
                            <label className="block text-sm font-medium text-slate-400">Popup Status</label>
                            <div className="mt-2 space-y-2">
                                <div className="flex items-center">
                                    <input id="status-all" name="status" type="radio" value="Active All" checked={memoStatus === 'Active All'} onChange={(e) => setMemoStatus(e.target.value)} className="h-4 w-4 text-blue-600 border-gray-300 focus:ring-blue-500 bg-slate-600" />
                                    <label htmlFor="status-all" className="ml-3 block text-sm font-medium text-slate-300">Active All (Show to everyone)</label>
                                </div>
                                <div className="flex items-center">
                                    <input id="status-manager" name="status" type="radio" value="Active Shop Manager" checked={memoStatus === 'Active Shop Manager'} onChange={(e) => setMemoStatus(e.target.value)} className="h-4 w-4 text-blue-600 border-gray-300 focus:ring-blue-500 bg-slate-600" />
                                    <label htmlFor="status-manager" className="ml-3 block text-sm font-medium text-slate-300">Active Shop Manager (Only for Shop Managers)</label>
                                </div>
                                <div className="flex items-center">
                                    <input id="status-deactive" name="status" type="radio" value="Deactive" checked={memoStatus === 'Deactive'} onChange={(e) => setMemoStatus(e.target.value)} className="h-4 w-4 text-blue-600 border-gray-300 focus:ring-blue-500 bg-slate-600" />
                                    <label htmlFor="status-deactive" className="ml-3 block text-sm font-medium text-slate-300">Deactive (Do not show popup)</label>
                                </div>
                            </div>
                        </div>
                        <div className="flex justify-end">
                            <button
                                onClick={handleSave}
                                disabled={saving}
                                className="bg-blue-600 text-white px-6 py-2 rounded-lg shadow hover:bg-blue-700 transition-colors disabled:bg-blue-800 disabled:cursor-not-allowed flex items-center gap-2"
                            >
                                {saving ? <><i className="fas fa-spinner fa-spin"></i> Saving...</> : 'Save Memo'}
                            </button>
                        </div>
                    </div>
                </Card>
            );
        };

        const SettingsPage = () => {
            const { data: shops } = useCollection('shops');
            const { data: positions } = useCollection('positions');
            const [activeTab, setActiveTab] = useState('shop');

            // Configuration for the generic CRUD component for Shops
            const shopFormFields = [{ name: 'name', label: 'Shop Name', required: true }, { name: 'latitude', label: 'Latitude' }, { name: 'longitude', label: 'Longitude' }, { name: 'radius', label: 'Radius (m)', type: 'number' }, { name: 'note', label: 'Note', fullWidth: true }];
            const shopListColumns = [{ header: 'Shop Name', accessor: 'name' }, { header: 'Latitude', accessor: 'latitude' }, { header: 'Longitude', accessor: 'longitude' }, { header: 'Radius (m)', accessor: 'radius' }, { header: 'Note', accessor: 'note' }];
            
            // Configuration for the generic CRUD component for Positions
            const positionFormFields = [{ name: 'position', label: 'Position', required: true }, { name: 'note', label: 'Note', fullWidth: true }];
            const positionListColumns = [{ header: 'Position', accessor: 'position' }, { header: 'Note', accessor: 'note' }];

            return (
                <TabbedPage tabs={{ shop: 'Shop Properties', position: 'Position Management', memo: 'Memo Alert' }} activeTab={activeTab} setActiveTab={setActiveTab}>
                    <div id="shop"><SettingsCRUD title="Shop" collectionName="shops" items={shops} formFields={shopFormFields} listColumns={shopListColumns} /></div>
                    <div id="position"><SettingsCRUD title="Position" collectionName="positions" items={positions} formFields={positionFormFields} listColumns={positionListColumns} /></div>
                    <div id="memo"><MemoAlertTab /></div>
                </TabbedPage>
            );
        }

        // Generic component for CRUD operations (Create, Read, Update, Delete)
        function SettingsCRUD({ title, collectionName, items, formFields, listColumns }) {
            const { db } = useFirebase();
            const [editingItem, setEditingItem] = useState(null);
            const [itemToDelete, setItemToDelete] = useState(null);
            const getInitialState = useCallback(() => formFields.reduce((acc, field) => ({...acc, [field.name]: '' }), {}), [formFields]);
            const [newItem, setNewItem] = useState(getInitialState());

            useEffect(() => { setNewItem(getInitialState()); }, [getInitialState]);

            const handleSave = useCallback(async (item) => {
                const { doc, updateDoc, addDoc, collection } = window.firebaseSDK;
                try {
                    if (item.id) { const { id, ...data } = item; await updateDoc(doc(db, collectionName, id), data); } 
                    else { await addDoc(collection(db, collectionName), item); }
                    setEditingItem(null); setNewItem(getInitialState());
                } catch (e) { console.error(`Error saving ${collectionName}:`, e); }
            }, [db, collectionName, getInitialState]);
            
            const handleDelete = useCallback(async () => {
                if (!itemToDelete) return;
                try { 
                    await window.firebaseSDK.deleteDoc(window.firebaseSDK.doc(db, collectionName, itemToDelete.id)); 
                } catch (e) { 
                    console.error(`Error deleting ${collectionName}:`, e); 
                } finally {
                    setItemToDelete(null);
                }
            }, [db, collectionName, itemToDelete]);

            // Reusable form renderer
            const renderForm = (item, setItem, isNew = false) => (<form onSubmit={(e) => { e.preventDefault(); handleSave(item); }} className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-4 items-end p-4 bg-slate-800/50 rounded-lg mb-6 border border-slate-700">{formFields.map(field => (<div key={field.name} className={field.fullWidth ? 'col-span-full' : 'sm:col-span-1'}><label className="block text-sm font-medium text-slate-400">{field.label}</label><input type={field.type || 'text'} name={field.name} value={item[field.name] || ''} onChange={(e) => setItem({...item, [field.name]: e.target.value})} className="input" required={field.required} /></div>))}<div className="flex space-x-2 col-span-full md:col-span-1 self-end mt-4 md:mt-0"><button type="submit" className="w-full bg-blue-600 text-white px-4 py-2 rounded-lg shadow hover:bg-blue-700 transition-colors">{isNew ? `Add ${title}` : 'Save'}</button>{!isNew && <button type="button" onClick={() => setEditingItem(null)} className="w-full bg-slate-600 text-slate-200 px-4 py-2 rounded-lg hover:bg-slate-500">Cancel</button>}</div></form>);

            return (<Card><CardTitle>{title} Management</CardTitle>{renderForm(newItem, setNewItem, true)}<div className="overflow-x-auto"><table className="min-w-full divide-y divide-slate-700"><thead className="bg-slate-900/50"><tr>{listColumns.map(col => <th key={col.accessor} className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">{col.header}</th>)}<th className="px-4 py-3 text-right text-xs font-semibold text-slate-400 uppercase">Actions</th></tr></thead><tbody className="divide-y divide-slate-700">{items.map(item => (<tr key={item.id} className="hover:bg-slate-700/50">{editingItem?.id === item.id ? (<td colSpan={listColumns.length + 1} className="p-0">{renderForm(editingItem, setEditingItem)}</td>) : (<>{listColumns.map(col => <td key={col.accessor} className="px-4 py-4 text-sm text-slate-300">{item[col.accessor]}</td>)}<td className="px-4 py-4 text-right text-sm"><button onClick={() => setEditingItem({ ...item })} className="text-blue-400 hover:text-blue-300 mr-3"><i className="fas fa-edit"></i></button><button onClick={() => setItemToDelete(item)} className="text-red-500 hover:text-red-400"><i className="fas fa-trash"></i></button></td></>)}</tr>))}</tbody></table></div><ConfirmationModal isOpen={!!itemToDelete} onClose={() => setItemToDelete(null)} onConfirm={handleDelete} title={`Delete ${title}`} message="Are you sure you want to delete this item?" /></Card>);
        }
        // --- END SETTINGS PAGE ---

        // --- START LAYOUT & MAIN APP COMPONENTS ---
        const Sidebar = memo(({ activePage, setActivePage, isSidebarOpen, toggleSidebar, userProfile }) => {
            const sidebarLinks = useMemo(() => [ 
                { key: 'employees', icon: 'fa-users', label: 'Employees' }, 
                { key: 'checkinme', icon: 'fa-user-clock', label: 'CheckInMe' }, 
                { key: 'attendanceReport', icon: 'fa-file-alt', label: 'Attendance Report' }, 
                { key: 'loanManager', icon: 'fa-hand-holding-usd', label: 'Loan Manager' }, 
                { key: 'payroll', icon: 'fa-money-check-dollar', label: 'Payroll' }, 
                { key: 'expenseReport', icon: 'fa-file-invoice-dollar', label: 'Expense Report' }, 
                { key: 'userActivity', icon: 'fa-chart-line', label: 'User Activity' }, 
                { key: 'settings', icon: 'fa-cog', label: 'Settings' }, 
            ], []);

            // Filter sidebar links based on user permissions
            const availableLinks = useMemo(() => {
                if (userProfile?.role === 'Admin') return sidebarLinks;
                if (!userProfile?.permissions) return [];
                return sidebarLinks.filter(link => userProfile.permissions.includes(link.key));
            }, [userProfile, sidebarLinks]);

             const handleLinkClick = useCallback((pageKey) => { 
                setActivePage(pageKey); 
                if (window.innerWidth < 768) toggleSidebar(); // Close sidebar on mobile after navigation
            }, [setActivePage, toggleSidebar]);

            return (<aside className={`w-64 bg-slate-900 text-slate-300 p-4 flex flex-col transform ${isSidebarOpen ? 'translate-x-0' : '-translate-x-full'} md:translate-x-0 transition-transform duration-300 ease-in-out z-40 fixed md:relative h-full border-r border-slate-700`}><div className="flex items-center mb-10 px-2"><i className="fas fa-building-user text-3xl text-blue-500 mr-3"></i><h1 className="text-2xl font-bold text-white">HR System</h1></div><nav className="flex-grow">{availableLinks.map(link => (<a href="#" key={link.key} onClick={() => handleLinkClick(link.key)} className={`flex items-center py-3 px-4 rounded-lg transition duration-200 mt-2 ${activePage === link.key ? 'bg-blue-600 text-white shadow-lg' : 'hover:bg-slate-700/50'}`}><i className={`fas ${link.icon} w-6 mr-4`}></i><span className="font-medium">{link.label}</span></a>))}</nav></aside>);
        });

        const Header = memo(({ pageTitle, toggleSidebar, userProfile, pendingLeaves, pendingOTs, onNotificationClick }) => {
            const { auth } = useFirebase();
            const handleLogout = useCallback(async () => { 
                try { await window.firebaseSDK.signOut(auth); } 
                catch (error) { console.error("Error signing out: ", error); } 
            }, [auth]);

            const showNotifications = userProfile?.role === 'Admin' || userProfile?.role === 'Shop Manager';

            return (
                <header className="bg-slate-800/80 backdrop-blur-sm shadow-md p-4 flex justify-between items-center z-30 border-b border-slate-700 sticky top-0">
                    <div className="flex items-center">
                        <button onClick={toggleSidebar} className="text-slate-400 focus:outline-none md:hidden mr-4"><i className="fas fa-bars text-2xl"></i></button>
                        <h2 className="text-xl sm:text-2xl font-bold text-slate-100">{pageTitle}</h2>
                    </div>
                    <div className="flex items-center gap-4">
                        {userProfile && (<div className="text-right hidden sm:block"><span className="text-sm text-slate-400">Welcome, </span><span className="font-medium text-slate-200">{userProfile.name}</span></div>)}
                        {showNotifications && <NotificationBell pendingLeaves={pendingLeaves} pendingOTs={pendingOTs} onNotificationClick={onNotificationClick} />}
                        <button onClick={handleLogout} title="Logout" className="bg-slate-700 text-slate-300 w-10 h-10 rounded-full hover:bg-slate-600 hover:text-white transition duration-150 flex items-center justify-center flex-shrink-0"><i className="fas fa-sign-out-alt"></i></button>
                    </div>
                </header>
            );
        });
        
        const Dashboard = ({ userProfile }) => {
            const [isSidebarOpen, setSidebarOpen] = useState(false);
            const [activePage, setActivePage] = useState('');
            const [initialCheckInMeTab, setInitialCheckInMeTab] = useState('checkInOut');
            const [showNotificationModal, setShowNotificationModal] = useState(true);
            const [memoAlert, setMemoAlert] = useState(null);
            const [isMemoVisible, setMemoVisible] = useState(false);
            const [memoShownThisSession, setMemoShownThisSession] = useState(false);
            const { db } = useFirebase();

            // Fetch memo alert data
            useEffect(() => {
                if (!db) return;
                const { doc, onSnapshot } = window.firebaseSDK;
                const memoRef = doc(db, "settings", "memoAlert");
                const unsubscribe = onSnapshot(memoRef, (doc) => {
                    if (doc.exists()) {
                        setMemoAlert(doc.data());
                    } else {
                        setMemoAlert(null);
                    }
                });
                return () => unsubscribe();
            }, [db]);

            // Logic to show memo modal
            useEffect(() => {
                if (memoAlert && userProfile && !memoShownThisSession) {
                    const shouldShow = 
                        (memoAlert.status === 'Active All') ||
                        (memoAlert.status === 'Active Shop Manager' && userProfile.role === 'Shop Manager');

                    if (shouldShow) {
                        setMemoVisible(true);
                        setMemoShownThisSession(true); // Ensure it only shows once per session/reload
                    }
                }
            }, [memoAlert, userProfile, memoShownThisSession]);
            
            // Set the default page based on user role and permissions
            useEffect(() => {
                if (userProfile) {
                    const defaultPage = userProfile.role === 'Admin' ? 'employees' : userProfile.permissions?.[0] || 'checkinme';
                    setActivePage(defaultPage);
                }
            }, [userProfile]);

            const toggleSidebar = useCallback(() => setSidebarOpen(prev => !prev), []);
            
            const { where } = window.firebaseSDK;
            const requestQueryConstraints = useMemo(() => {
                // This logic determines which pending requests to fetch for notifications.
                if (userProfile?.role === 'Admin') {
                    // Admin sees all pending requests from all shops.
                    return [where("status", "==", "Pending")];
                }
                if (userProfile?.role === 'Shop Manager') {
                    // Shop Manager is restricted to see pending requests only from their assigned shop.
                    return [
                        where("status", "==", "Pending"),
                        where("shop", "==", userProfile.shop || null) // Using || null for safety.
                    ];
                }
                // For any other role (e.g., Staff), return a query that will match no documents.
                // This prevents fetching unnecessary data for users who won't see the notifications.
                return [where("status", "==", "non-existent-status")];
            }, [userProfile]);

            const { data: pendingLeaves } = useCollection('leaveRequests', requestQueryConstraints);
            const { data: pendingOTs } = useCollection('otRequests', requestQueryConstraints);

            const handleNotificationClick = useCallback((targetTab) => {
                setActivePage('checkinme');
                setInitialCheckInMeTab(targetTab);
                setShowNotificationModal(false);
            }, []);

            const pageTitles = useMemo(() => ({ 
                employees: 'Employees', checkinme: 'CheckInMe', attendanceReport: 'Attendance Report', 
                loanManager: 'Loan Manager', payroll: 'Payroll', expenseReport: 'Expense Report', 
                userActivity: 'User Activity', settings: 'Settings' 
            }), []);
            
            const totalPending = pendingLeaves.length + pendingOTs.length;

            // Renders the component for the currently active page
            const renderActivePage = useCallback(() => {
                const hasPermission = userProfile?.role === 'Admin' || userProfile?.permissions?.includes(activePage);
                if (!activePage) return null;
                if (!hasPermission) return <Card><CardTitle>Access Denied</CardTitle><p>You do not have permission to view this page.</p></Card>;
                
                switch(activePage) {
                    case 'employees': return <EmployeesPage userProfile={userProfile} />;
                    case 'checkinme': return <CheckInMePage userProfile={userProfile} initialTab={initialCheckInMeTab} />;
                    case 'attendanceReport': return <AttendanceReportPage userProfile={userProfile} />;
                    case 'loanManager': return <LoanManagerPage userProfile={userProfile} />;
                    case 'payroll': return <PayrollPage userProfile={userProfile} />;
                    case 'expenseReport': return <ExpenseReportPage />;
                    case 'userActivity': return <UserActivityPage />;
                    case 'settings': return <SettingsPage />;
                    default: return <UnderConstructionPage title="Page Not Found" />;
                }
            }, [activePage, userProfile, initialCheckInMeTab]);

            return (
                <div className="flex h-screen bg-slate-900 text-slate-300">
                    <Sidebar activePage={activePage} setActivePage={setActivePage} isSidebarOpen={isSidebarOpen} toggleSidebar={toggleSidebar} userProfile={userProfile} />
                    <div className="flex-1 flex flex-col overflow-hidden">
                        <Header 
                            pageTitle={pageTitles[activePage] || 'Dashboard'} 
                            toggleSidebar={toggleSidebar} 
                            userProfile={userProfile}
                            pendingLeaves={pendingLeaves}
                            pendingOTs={pendingOTs}
                            onNotificationClick={handleNotificationClick}
                        />
                        <main className="flex-1 overflow-x-hidden overflow-y-auto bg-slate-800 p-4 sm:p-6">
                            {renderActivePage()}
                        </main>
                        <Modal isOpen={showNotificationModal && totalPending > 0 && userProfile?.role !== 'Staff'} onClose={() => setShowNotificationModal(false)} maxWidth="max-w-md">
                            <ModalHeader title="Pending Approvals" onClose={() => setShowNotificationModal(false)} />
                            <ModalBody>
                                <p className="text-slate-300">You have {totalPending} new request(s) waiting for your approval.</p>
                                <ul className="mt-4 space-y-2">
                                    {pendingLeaves.length > 0 && <li><span className="font-semibold">{pendingLeaves.length}</span> Leave Request(s)</li>}
                                    {pendingOTs.length > 0 && <li><span className="font-semibold">{pendingOTs.length}</span> OT Request(s)</li>}
                                </ul>
                            </ModalBody>
                            <ModalFooter>
                                <button onClick={() => setShowNotificationModal(false)} className="bg-slate-600 text-slate-200 px-4 py-2 rounded-lg hover:bg-slate-500">Dismiss</button>
                                <button onClick={() => handleNotificationClick('leaveRequest')} className="bg-blue-600 text-white px-4 py-2 rounded-lg shadow hover:bg-blue-700">View Requests</button>
                            </ModalFooter>
                        </Modal>
                        {memoAlert && (
                            <Modal isOpen={isMemoVisible} onClose={() => setMemoVisible(false)} maxWidth="max-w-lg">
                                <ModalHeader title="ដំណឹងប្រាប់ពត៏មាន" onClose={() => setMemoVisible(false)} />
                                <ModalBody>
                                    <pre className="text-slate-300 whitespace-pre-wrap font-sans">{memoAlert.content}</pre>
                                </ModalBody>
                                <ModalFooter>
                                    <button onClick={() => setMemoVisible(false)} className="bg-blue-600 text-white px-4 py-2 rounded-lg shadow hover:bg-blue-700">ទទួលបាន</button>
                                </ModalFooter>
                            </Modal>
                        )}
                    </div>
                </div>
            );
        };

        // Main App Component: Decides whether to show Login or Dashboard
        function AppContent() {
            const { currentUser, userProfile, loading } = useFirebase();
            if (loading) return <div className="flex items-center justify-center h-screen text-lg text-slate-300">Loading Application...</div>;
            return currentUser ? <Dashboard userProfile={userProfile} /> : <LoginPage />;
        }

        // Root Component with Firebase Provider
        function App() {
            return (
                <FirebaseProvider>
                    <AppContent />
                </FirebaseProvider>
            );
        }

        // Render the application
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
        // --- END LAYOUT & MAIN APP COMPONENTS ---
    </script>
</body>
</html>






