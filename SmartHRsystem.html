<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Smart HR Management System</title>
    
    <!-- External Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" xintegrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js" xintegrity="sha512-BNaRQnYJYiPSqHHDb58B0yaPfCu+Wgds8Gp/gU33kqBtgNS4tSPHuGibyoVBL5gI9kLmbG0C+wFjr8bCqwY2SA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <!-- Quill Rich Text Editor -->
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
    
    <!-- Custom Styles & Fonts -->
    <style>
        @import url('https://rsms.me/inter/inter.css');
        html, body { 
            font-family: 'Inter', sans-serif;
            overflow-x: hidden; /* Prevents horizontal scrolling */
        }
        /* Base input styles for a consistent look */
        .input, .select {
            margin-top: 0.25rem; display: block; width: 100%; padding: 0.5rem 0.75rem;
            border-width: 1px; border-color: #475569; border-radius: 0.375rem;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); line-height: 1.5;
            background-color: #334155; color: #f1f5f9;
        }
        .input:focus, .select:focus {
            outline: 2px solid transparent; outline-offset: 2px;
            --tw-ring-color: #2563eb; border-color: #2563eb;
        }
        .input[disabled], .select[disabled] {
            background-color: #475569;
            cursor: not-allowed;
            opacity: 0.7;
        }
        input[type="checkbox"]:disabled {
            cursor: not-allowed;
            opacity: 0.5;
        }
        /* Styles for rendered policy content */
        .policy-content p { margin-bottom: 1rem; line-height: 1.6; }
        .policy-content h1, .policy-content h2, .policy-content h3 { font-weight: bold; margin-top: 1.5rem; margin-bottom: 0.5rem; color: #f1f5f9; border-bottom: 1px solid #475569; padding-bottom: 0.25rem; }
        .policy-content h1 { font-size: 1.5em; }
        .policy-content h2 { font-size: 1.25em; }
        .policy-content h3 { font-size: 1.1em; }
        .policy-content ul, .policy-content ol { margin-left: 1.5rem; margin-bottom: 1rem; }
        .policy-content ul { list-style-type: disc; }
        .policy-content ol { list-style-type: decimal; }
        .policy-content a { color: #60a5fa; text-decoration: underline; }
        .policy-content strong { font-weight: bold; }
        .policy-content em { font-style: italic; }
        .policy-content u { text-decoration: underline; }
        .policy-content pre { background-color: #1e293b; padding: 1rem; border-radius: 0.5rem; white-space: pre-wrap; }
        .policy-content blockquote { border-left: 4px solid #475569; padding-left: 1rem; margin-left: 0; color: #94a3b8; }
    </style>
</head>
<body class="bg-slate-900 text-slate-300">
    <div id="root"></div>

    <!-- Firebase SDK Module -->
    <script type="module">
        // Firebase SDK imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, doc, addDoc, updateDoc, deleteDoc, query, where, serverTimestamp, getDocs, writeBatch, enableIndexedDbPersistence, setDoc, orderBy, limit, startAfter } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Make Firebase SDK available globally for the Babel script
        window.firebaseSDK = {
            initializeApp, getAuth, getFirestore, collection, onSnapshot,
            doc, addDoc, updateDoc, deleteDoc, query, where, serverTimestamp,
            signInWithEmailAndPassword, onAuthStateChanged, signOut, getDocs, writeBatch,
            enableIndexedDbPersistence, setDoc,
            orderBy, limit, startAfter // Added missing functions for pagination
        };
    </script>
    
    <!-- React Application Script -->
    <script type="text/babel">
        // --- START REACT & FIREBASE SETUP ---
        const { useState, useEffect, useMemo, useCallback, createContext, useContext, memo, useRef } = React;

        // NEW: Connectivity Context for online/offline status
        const ConnectivityContext = createContext(null);
        const useConnectivity = () => useContext(ConnectivityContext);
        const ConnectivityProvider = ({ children }) => {
            const [isOnline, setIsOnline] = useState(navigator.onLine);

            useEffect(() => {
                const handleOnline = () => setIsOnline(true);
                const handleOffline = () => setIsOnline(false);

                window.addEventListener('online', handleOnline);
                window.addEventListener('offline', handleOffline);

                return () => {
                    window.removeEventListener('online', handleOnline);
                    window.removeEventListener('offline', handleOffline);
                };
            }, []);

            return (
                <ConnectivityContext.Provider value={{ isOnline }}>
                    {children}
                </ConnectivityContext.Provider>
            );
        };

        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyB7_pnmwHj6aOeZRTykPvNusNFYReaTY6Q",
            authDomain: "hrsm-j.firebaseapp.com",
            projectId: "hrsm-j",
            storageBucket: "hrsm-j.appspot.com",
            messagingSenderId: "45063715478",
            appId: "1:45063715478:web:cc2dd21b83dd195771e0b7",
            measurementId: "G-8HQDG2LTKP"
        };

        // Firebase Context for providing db and auth instances throughout the app
        const FirebaseContext = createContext(null);
        const useFirebase = () => useContext(FirebaseContext);

        const FirebaseProvider = ({ children }) => {
            const [db, setDb] = useState(null);
            const [auth, setAuth] = useState(null);
            const [currentUser, setCurrentUser] = useState(null);
            const [userProfile, setUserProfile] = useState(null);
            const [loading, setLoading] = useState(true);

            // Initialize Firebase and Auth state listener
            useEffect(() => {
                try {
                    const { initializeApp, getFirestore, getAuth, onAuthStateChanged, enableIndexedDbPersistence } = window.firebaseSDK;
                    const app = initializeApp(firebaseConfig);
                    const dbInstance = getFirestore(app);
                    
                    // Enable offline persistence
                    enableIndexedDbPersistence(dbInstance).catch((err) => {
                        if (err.code === 'failed-precondition') console.warn("Firestore persistence failed: Multiple tabs open.");
                        else if (err.code === 'unimplemented') console.warn("Firestore persistence failed: Browser does not support it.");
                    });

                    const authInstance = getAuth(app);
                    setAuth(authInstance);
                    setDb(dbInstance);

                    const unsubscribe = onAuthStateChanged(authInstance, (user) => {
                        setCurrentUser(user);
                        if (!user) {
                            setUserProfile(null);
                            setLoading(false);
                        }
                    });
                    return () => unsubscribe();
                } catch (error) { 
                    console.error("Firebase initialization error:", error); 
                    setLoading(false);
                } 
            }, []);

            // Fetch user profile from Firestore when auth state changes
            useEffect(() => {
                if (!db || !currentUser) {
                    if (!currentUser) setLoading(false);
                    setUserProfile(null);
                    return;
                }

                setLoading(true);
                const { collection, query, where, onSnapshot } = window.firebaseSDK;
                const q = query(collection(db, "employees"), where("uid", "==", currentUser.uid));
                
                const unsubscribe = onSnapshot(q, (snapshot) => {
                    if (!snapshot.empty) {
                        const userDoc = snapshot.docs[0];
                        setUserProfile({ id: userDoc.id, ...userDoc.data() });
                    } else {
                        console.warn("Authenticated user has no employee profile in Firestore.");
                        setUserProfile(null);
                    }
                    setLoading(false);
                }, (error) => {
                    console.error("Error fetching user profile:", error);
                    setLoading(false);
                });

                return () => unsubscribe();
            }, [db, currentUser]);

            const value = { db, auth, currentUser, userProfile, loading };
            return <FirebaseContext.Provider value={value}>{children}</FirebaseContext.Provider>;
        };
        
        // Custom hook for real-time Firestore collection data
        const useCollection = (collectionName, queryConstraints = []) => {
            const { db } = useFirebase();
            const [data, setData] = useState([]);
            const [loading, setLoading] = useState(true);

            useEffect(() => {
                if (!db) return;
                setLoading(true);
                const { collection, onSnapshot, query } = window.firebaseSDK;
                const q = query(collection(db, collectionName), ...queryConstraints);
                const unsubscribe = onSnapshot(q, (querySnapshot) => {
                    const items = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    setData(items);
                    setLoading(false);
                }, (error) => {
                    console.error(`Error fetching collection ${collectionName}:`, error);
                    setLoading(false);
                });
                return () => unsubscribe();
            }, [db, collectionName, JSON.stringify(queryConstraints)]); // JSON.stringify to safely memoize the array dependency
            return { data, loading };
        };

        // Custom hook for one-time Firestore collection data fetch
        const useStaticCollection = (collectionName) => {
            const { db } = useFirebase();
            const [data, setData] = useState([]);
            const [loading, setLoading] = useState(true);

            useEffect(() => {
                if (!db) return;
                
                const fetchData = async () => {
                    setLoading(true);
                    try {
                        const { collection, getDocs } = window.firebaseSDK;
                        const querySnapshot = await getDocs(collection(db, collectionName));
                        const items = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        setData(items);
                    } catch (error) {
                        console.error(`Error performing one-time fetch for ${collectionName}:`, error);
                    } finally {
                        setLoading(false);
                    }
                };

                fetchData();
            }, [db, collectionName]);

            return { data, loading };
        };
        
        // NEW: Standalone payroll calculation logic
        const calculatePayrollForEmployee = (employee, selectedMonth, allData, manualLoanDeduction) => {
            if (!employee || !selectedMonth) return { inputs: {}, calculations: {} };

            const { attendance, leaveRequests, otRequests, staffLoans, employeeStates, salaryRevisions } = allData;

            // --- 1. Filter data for the selected employee and month ---
            const monthAttendance = (attendance || []).filter(r => r.employeeId === employee.id && r.timestamp?.toDate().toISOString().startsWith(selectedMonth));
            const monthLeave = (leaveRequests || []).filter(r => r.staffId === employee.id && r.status === 'Approved' && r.leaveDate.startsWith(selectedMonth));
            const monthOT = (otRequests || []).filter(r => r.staffId === employee.id && r.status === 'Approved' && r.reqDate.startsWith(selectedMonth));
            const monthStates = (employeeStates || []).filter(r => r.staffId === employee.id && r.date.startsWith(selectedMonth));
            const activeLoan = (staffLoans || []).find(l => l.staffId === employee.id && l.status === 'Active' && (!l.effectiveDate || l.effectiveDate.slice(0, 7) <= selectedMonth));

            // --- MOVED UP: Calculate Base Salary & Salary Per Day first, as it's needed for penalty calculation ---
            const [year, month] = selectedMonth.split('-').map(Number);
            const daysInMonth = new Date(year, month, 0).getDate();
            const applicableRevisions = (salaryRevisions || [])
                .filter(rev => rev.staffId === employee.id && rev.effectiveDate && rev.effectiveDate <= `${selectedMonth}-31` && rev.status === 'Approved')
                .sort((a, b) => b.effectiveDate.localeCompare(a.effectiveDate));
            
            const baseSalary = applicableRevisions.length > 0
                ? (parseFloat(String(applicableRevisions[0].updatedSalary).replace(/[^0-9.-]/g, '')) || 0)
                : (parseFloat(String(employee.salary).replace(/[^0-9.-]/g, '')) || 0);
            
            const salaryPerDay = baseSalary > 0 && daysInMonth > 0 ? baseSalary / daysInMonth : 0;


            // --- 2. Calculate inputs automatically ---
            const leaveDays = monthLeave.reduce((sum, r) => sum + (parseFloat(r.numberOfDays) || 0), 0);
            const otDays = monthOT.reduce((sum, r) => sum + (parseFloat(r.numberOfOTDays) || 0), 0);
            const loanDeduction = manualLoanDeduction !== undefined ? parseFloat(manualLoanDeduction) : (activeLoan ? parseFloat(activeLoan.agreedMonthlyDeduction) || 0 : 0);
            const totalLateDays = monthStates.filter(es => es.statusState === 'Deduction' && es.note?.includes('Late @')).length;

            const dailyRecords = {};
            monthAttendance.forEach(rec => {
                // FIX: Format date key in local timezone to avoid UTC conversion issues.
                const date = rec.timestamp.toDate();
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                const dayKey = `${year}-${month}-${day}`;
                
                if (!dailyRecords[dayKey]) dailyRecords[dayKey] = [];
                dailyRecords[dayKey].push({ date: date, type: rec.type });
            });
            
            let workDays = 0;
            let noCheckOutCount = 0;
            // FIX: Format today's date string in local timezone.
            const todayDate = new Date();
            const today_year = todayDate.getFullYear();
            const today_month = String(todayDate.getMonth() + 1).padStart(2, '0');
            const today_day = String(todayDate.getDate()).padStart(2, '0');
            const todayStr = `${today_year}-${today_month}-${today_day}`;


            Object.entries(dailyRecords).forEach(([dayKey, dayRecs]) => {
                const ins = dayRecs.filter(r => r.type === 'in').sort((a,b) => a.date - b.date);
                const outs = dayRecs.filter(r => r.type === 'out').sort((a,b) => b.date - a.date);
                if (ins.length > 0 && outs.length > 0) {
                    const diffHours = (outs[0].date.getTime() - ins[0].date.getTime()) / 3600000;
                    if (diffHours >= 7) workDays += 1;
                    else if (diffHours >= 4) workDays += 0.5;
                } else if (ins.length > 0 && dayKey < todayStr) {
                    noCheckOutCount += 1;
                }
            });

            // NEW: Calculate Absent days & Penalty for absence on a rejected leave day.
            const attendedDays = new Set(Object.keys(dailyRecords));
            let absentDays = 0;
            let rejectedLeavePenaltyAmount = 0; // Initialize penalty amount
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            for (let day = 1; day <= daysInMonth; day++) {
                const currentDay = new Date(year, month - 1, day);
                if (currentDay >= today) break; // Don't count today or future days

                const loop_year = currentDay.getFullYear();
                const loop_month = String(currentDay.getMonth() + 1).padStart(2, '0');
                const loop_day = String(currentDay.getDate()).padStart(2, '0');
                const dayKey = `${loop_year}-${loop_month}-${loop_day}`;

                // An absence is a past day with no attendance record.
                if (!attendedDays.has(dayKey)) {
                    absentDays++;

                    // Check if there was a REJECTED leave request for this absent day.
                    const hadRejectedLeave = (leaveRequests || []).some(
                        lr => lr.staffId === employee.id &&
                              lr.status === 'Rejected' &&
                              // Check if the absent day falls within the rejected leave period.
                              dayKey >= lr.leaveDate && dayKey < lr.returnDate 
                    );
                    
                    if (hadRejectedLeave) {
                        // Apply penalty: Salary per day x 2
                        rejectedLeavePenaltyAmount += (salaryPerDay * 2);
                    }
                }
            }
            
            const noAttendance = absentDays + noCheckOutCount;

            // NEW: Calculate "Given Off Days" based on the total number of work days.
            const givenOffDays = Math.floor(workDays / 7);

            // FIX: Create the autoInputs object to be returned, now including noAttendance.
            const autoInputs = { workDays, givenOffDays, otDays, leaveDays, totalLateDays, noCheckOutCount, loanDeduction, noAttendance };

            // --- 3. Perform Final Salary Calculations ---
            const engagements = monthStates.filter(es => es.statusState === 'Engagement' && es.status === 'Approved').reduce((sum, item) => sum + (parseFloat(item.amount) || 0), 0);
            
            const lateDeductionsAmount = monthStates.filter(es => {
                if (!(es.statusState === 'Deduction' && es.note?.includes('Late @'))) return false;
                const hasLeave = (leaveRequests || []).some(lr => lr.staffId === es.staffId && lr.status === 'Approved' && es.date >= lr.leaveDate && es.date < lr.returnDate);
                return !hasLeave;
            }).reduce((sum, item) => sum + (parseFloat(item.amount) || 0), 0);
            
            const otherDeductions = monthStates.filter(es => es.statusState === 'Deduction' && !es.note?.includes('Late @')).reduce((sum, item) => sum + (parseFloat(item.amount) || 0), 0);

            // "No-CheckOut" is informational. Any associated monetary deduction is handled via the "Other Deductions" from Employee States.
            const daysToPayFor = (workDays || 0) + (givenOffDays || 0) - (leaveDays || 0);
            const baseSalaryEarned = salaryPerDay * (daysToPayFor > 0 ? daysToPayFor : 0);
            const otSalary = salaryPerDay * (otDays || 0);
            const grossSalary = baseSalaryEarned + otSalary + engagements;
            // CORRECTED & UPDATED: Added the new penalty to total deductions.
            const totalDeductions = loanDeduction + lateDeductionsAmount + otherDeductions + rejectedLeavePenaltyAmount;
            const netSalary = grossSalary - totalDeductions;

            // CORRECTED & UPDATED: Added new penalty amount to the returned calculations object.
            const calculations = { baseSalary, salaryPerDay, daysInMonth, baseSalaryEarned, otSalary, engagements, grossSalary, otherDeductions, totalDeductions, netSalary, lateDeductionsAmount, rejectedLeavePenaltyAmount };

            return { inputs: autoInputs, calculations };
        };
        
        // NEW: Centralized Payroll Calculator Hook
        const usePayrollCalculator = (employee, selectedMonth, allData, manualLoanDeduction) => {
            return useMemo(() => {
                // The complex logic is now in a separate function.
                return calculatePayrollForEmployee(employee, selectedMonth, allData, manualLoanDeduction);
            }, [employee, selectedMonth, allData, manualLoanDeduction]);
        };
        // --- END REACT & FIREBASE SETUP ---

        // --- START UTILITY FUNCTIONS ---
        const Utils = {
            formatCurrency: (value, currency = 'KHR') => {
                if (value === null || value === undefined) return '';
                const num = parseFloat(String(value).replace(/[^0-9.-]/g, ''));
                if (isNaN(num)) return '';
                const options = { style: 'currency', currency: currency, minimumFractionDigits: currency === 'KHR' ? 0 : 2, maximumFractionDigits: currency === 'KHR' ? 0 : 2 };
                const locale = currency === 'KHR' ? 'km-KH' : 'en-US';
                let formatted = new Intl.NumberFormat(locale, options).format(num);
                if (currency === 'KHR') { formatted = formatted.replace('KHR', '៛').trim(); }
                return formatted;
            },
            formatRequestDate: (timestamp) => {
                if (!timestamp || !timestamp.toDate) return 'N/A';
                const date = timestamp.toDate();
                return `${date.toLocaleDateString('en-GB', { day: '2-digit', month: '2-digit', year: '2-digit' })} | ${date.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: true })}`;
            },
            formatISOToDisplay: (isoDate) => {
                if (!isoDate || typeof isoDate !== 'string' || !isoDate.includes('-')) return isoDate || '';
                const [year, month, day] = isoDate.split('-');
                return `${day}-${month}-${year}`;
            },
            calculateWorkedDuration: (joinedDate) => {
                if (!joinedDate) return 'N/A';
                const start = new Date(joinedDate);
                if (isNaN(start.getTime())) return 'N/A';
                const now = new Date();
                let years = now.getFullYear() - start.getFullYear();
                let months = now.getMonth() - start.getMonth();
                let days = now.getDate() - start.getDate();
                if (days < 0) { months--; days += new Date(now.getFullYear(), now.getMonth(), 0).getDate(); }
                if (months < 0) { years--; months += 12; }
                return `${years}Y ${months}M ${days}D`;
            },
            // Haversine formula to calculate distance between two lat/lon points
            getDistance: (lat1, lon1, lat2, lon2) => {
                const R = 6371e3; // Earth's radius in metres
                const φ1 = lat1 * Math.PI/180; const φ2 = lat2 * Math.PI/180;
                const Δφ = (lat2-lat1) * Math.PI/180; const Δλ = (lon2-lon1) * Math.PI/180;
                const a = Math.sin(Δφ/2) * Math.sin(Δφ/2) + Math.cos(φ1) * Math.cos(φ2) * Math.sin(Δλ/2) * Math.sin(Δλ/2);
                const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
                return R * c; // Distance in metres
            }
        };
        // --- END UTILITY FUNCTIONS ---

        // --- START REUSABLE UI COMPONENTS ---
        const Card = memo(({ children, className = '' }) => (<div className={`bg-slate-800/50 p-4 sm:p-6 rounded-lg shadow-lg border border-slate-700 ${className}`}>{children}</div>));
        const CardTitle = memo(({ children }) => (<h2 className="text-2xl font-semibold text-slate-100 mb-4 pb-4 border-b border-slate-700">{children}</h2>));
        const UnderConstructionPage = memo(({ title }) => (<Card><div className="text-center p-4 sm:p-8"><i className="fas fa-tools text-5xl text-yellow-400 mb-6"></i><h3 className="text-2xl sm:text-3xl font-bold text-slate-100">{title}</h3><p className="text-slate-400 mt-2">This page is under construction.</p></div></Card>));
        const Modal = ({ isOpen, onClose, children, maxWidth = "max-w-4xl" }) => { if (!isOpen) return null; return (<div className="fixed inset-0 bg-black bg-opacity-70 z-50 flex justify-center items-start sm:items-center p-4 overflow-y-auto"><div className={`bg-slate-800 rounded-lg shadow-2xl w-full ${maxWidth} flex flex-col border border-slate-600`}>{children}</div></div>); };
        const ModalHeader = memo(({ title, onClose }) => (<div className="p-5 border-b border-slate-700 flex justify-between items-center flex-shrink-0"><h3 className="text-xl font-semibold text-slate-100">{title}</h3><Button variant="icon-close" onClick={onClose} className="text-2xl p-1">&times;</Button></div>));
        const ModalBody = memo(({ children }) => (<div className="p-6 flex-grow overflow-y-auto max-h-[calc(90vh-140px)]">{children}</div>));
        const ModalFooter = memo(({ children }) => (<div className="p-4 bg-slate-900/50 border-t border-slate-700 flex justify-end gap-4 rounded-b-lg flex-shrink-0">{children}</div>));
        
        // NEW: Reusable Button Component
        const Button = memo(({ children, onClick, variant = 'primary', icon, disabled = false, type = 'button', className = '', title = '' }) => {
            const baseClasses = 'font-medium rounded-lg shadow-sm transition-colors flex items-center justify-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-slate-800';
            
            const variantStyles = {
                primary: 'bg-blue-600 text-white hover:bg-blue-700 focus:ring-blue-500 px-4 py-2',
                secondary: 'bg-slate-600 text-slate-200 hover:bg-slate-500 focus:ring-slate-400 px-4 py-2',
                danger: 'bg-red-600 text-white hover:bg-red-700 focus:ring-red-500 px-4 py-2',
                success: 'bg-green-600 text-white hover:bg-green-700 focus:ring-green-500 px-4 py-2',
                'icon-edit': 'text-blue-400 hover:text-blue-300',
                'icon-delete': 'text-red-500 hover:text-red-400',
                'icon-approve': 'text-green-400 hover:text-green-300',
                'icon-reject': 'text-orange-400 hover:text-orange-300',
                'icon-view': 'text-blue-400 hover:text-blue-300',
                'icon-edit-alt': 'text-indigo-400 hover:text-indigo-300',
                'icon-close': 'text-slate-400 hover:text-white',
                'icon-add-time': 'text-teal-400 hover:text-teal-300', // New variant for the manual check-out icon
            };

            const finalClasses = `${baseClasses} ${variantStyles[variant] || variantStyles.primary} ${className}`;

            return (
                <button type={type} onClick={onClick} disabled={disabled} className={finalClasses} title={title}>
                    {icon && <i className={`fas ${icon}`}></i>}
                    {children}
                </button>
            );
        });

        const ConfirmationModal = ({ isOpen, onClose, onConfirm, title, message }) => { if (!isOpen) return null; return (<div className="fixed inset-0 bg-black bg-opacity-70 z-50 flex justify-center items-center p-4"><div className="bg-slate-800 rounded-lg shadow-2xl w-full max-w-sm border border-slate-600"><div className="p-6"><h3 className="text-lg font-bold text-slate-100">{title}</h3><p className="mt-2 text-sm text-slate-400">{message}</p></div><div className="p-4 bg-slate-900/50 border-t border-slate-700 flex justify-end gap-4 rounded-b-lg"><Button variant="secondary" onClick={onClose}>Cancel</Button><Button variant="danger" onClick={onConfirm}>Confirm</Button></div></div></div>); };
        const TabbedPage = memo(({ tabs, activeTab, setActiveTab, children }) => {
            const renderContent = () => React.Children.toArray(children).find(child => child.props.id === activeTab) || <UnderConstructionPage title={tabs[activeTab]} />;
            return (<div><div className="mb-6 overflow-x-auto"><nav className="flex space-x-2 sm:space-x-4" aria-label="Tabs">{Object.entries(tabs).map(([key, title]) => (<a href="#" key={key} onClick={(e) => { e.preventDefault(); setActiveTab(key); }} className={`whitespace-nowrap rounded-md px-3 py-2 text-sm font-medium transition-colors ${activeTab === key ? 'bg-blue-600 text-white shadow' : 'text-slate-400 hover:bg-slate-700/50 hover:text-slate-200'}`}>{title}</a>))}</nav></div>{renderContent()}</div>);
        });
        const NotificationBell = ({ pendingLeaves = [], pendingOTs = [], onNotificationClick }) => {
            const [isOpen, setIsOpen] = useState(false);
            const totalCount = pendingLeaves.length + pendingOTs.length;

            const handleLeaveClick = () => {
                onNotificationClick('leaveRequest');
                setIsOpen(false);
            };

            const handleOTClick = () => {
                onNotificationClick('otRequest');
                setIsOpen(false);
            };

            return (
                <div className="relative">
                    <button onClick={() => setIsOpen(!isOpen)} className="relative text-slate-400 hover:text-white focus:outline-none">
                        <i className="fas fa-bell text-xl"></i>
                        {totalCount > 0 && (
                            <span className="absolute -top-2 -right-2 flex h-5 w-5 items-center justify-center rounded-full bg-red-500 text-xs font-bold text-white">
                                {totalCount}
                            </span>
                        )}
                    </button>
                    {isOpen && (
                        <div className="absolute right-0 mt-2 w-80 origin-top-right rounded-md bg-slate-800 shadow-lg ring-1 ring-black ring-opacity-5 focus:outline-none border border-slate-700">
                            <div className="py-1">
                                <div className="px-4 py-2 text-sm font-semibold text-slate-100 border-b border-slate-700">Notifications</div>
                                {totalCount === 0 ? (
                                    <div className="px-4 py-3 text-sm text-slate-400">No new notifications</div>
                                ) : (
                                    <>
                                        {pendingLeaves.map(req => (
                                            <a href="#" key={req.id} onClick={handleLeaveClick} className="block px-4 py-3 text-sm text-slate-300 hover:bg-slate-700">
                                                <p className="font-medium text-slate-200">New Leave Request</p>
                                                <p className="text-xs text-slate-400">{req.staffName} - {req.numberOfDays} day(s)</p>
                                            </a>
                                        ))}
                                        {pendingOTs.map(req => (
                                            <a href="#" key={req.id} onClick={handleOTClick} className="block px-4 py-3 text-sm text-slate-300 hover:bg-slate-700">
                                                <p className="font-medium text-slate-200">New OT Request</p>
                                                <p className="text-xs text-slate-400">{req.numberOfOTDays} day(s)</p>
                                            </a>
                                        ))}
                                    </>
                                )}
                            </div>
                        </div>
                    )}
                </div>
            );
        };
        // --- END REUSABLE UI COMPONENTS ---

        // --- START AUTHENTICATION PAGE ---
        const LoginPage = () => {
            const { auth, db } = useFirebase();
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [error, setError] = useState('');
            const [loading, setLoading] = useState(false);
            const [showPassword, setShowPassword] = useState(false);

            const handleLogin = useCallback(async (e) => {
                e.preventDefault();
                if (!auth || !db) { setError("System not ready. Please try again."); return; }
                setLoading(true);
                setError('');
                try {
                    const { signInWithEmailAndPassword, signOut, collection, query, where, getDocs, doc, updateDoc } = window.firebaseSDK;
                    const userCredential = await signInWithEmailAndPassword(auth, email, password);
                    const user = userCredential.user;
                    
                    // Verify user has an active employee profile by email
                    const q = query(collection(db, "employees"), where("email", "==", user.email));
                    const querySnapshot = await getDocs(q);

                    if (querySnapshot.empty) {
                        await signOut(auth);
                        setError("No employee record found for this user.");
                    } else {
                        const employeeDoc = querySnapshot.docs[0];
                        const employeeData = employeeDoc.data();

                        if (employeeData.status !== 'Active') {
                            await signOut(auth);
                            setError("Your account is inactive. Please contact HR.");
                        } else {
                            // Automatically link UID if it's missing or incorrect.
                            if (!employeeData.uid || employeeData.uid !== user.uid) {
                                const employeeDocRef = doc(db, 'employees', employeeDoc.id);
                                await updateDoc(employeeDocRef, { uid: user.uid });
                            }
                            // Login is successful; onAuthStateChanged will handle profile loading.
                        }
                    }
                } catch (err) {
                    setError('Failed to login. Please check your credentials.');
                    console.error(err);
                } finally {
                    setLoading(false);
                }
            }, [auth, db, email, password]);

            return (
                <div className="flex items-center justify-center min-h-screen bg-slate-900">
                    <div className="w-full max-w-md p-8 space-y-8 bg-slate-800 rounded-2xl shadow-lg border border-slate-700">
                        <div className="text-center"><i className="fas fa-building-user text-5xl text-blue-500"></i><h2 className="mt-6 text-3xl font-bold text-white">HR Management System</h2><p className="mt-2 text-sm text-slate-400">Sign in to your account</p></div>
                        <form className="mt-8 space-y-6" onSubmit={handleLogin}>
                            <div className="rounded-md shadow-sm -space-y-px">
                                <div><input id="email-address" name="email" type="email" autoComplete="email" required className="appearance-none rounded-none relative block w-full px-3 py-3 border border-slate-600 bg-slate-700 text-white placeholder-slate-400 rounded-t-md focus:outline-none focus:ring-blue-500 focus:border-blue-500 focus:z-10 sm:text-sm" placeholder="Email address" value={email} onChange={(e) => setEmail(e.target.value)} /></div>
                                <div className="relative"><input id="password" name="password" type={showPassword ? "text" : "password"} autoComplete="current-password" required className="appearance-none rounded-none relative block w-full px-3 py-3 border border-slate-600 bg-slate-700 text-white placeholder-slate-400 rounded-b-md focus:outline-none focus:ring-blue-500 focus:border-blue-500 focus:z-10 sm:text-sm" placeholder="Password" value={password} onChange={(e) => setPassword(e.target.value)} /><button type="button" onClick={() => setShowPassword(!showPassword)} className="absolute inset-y-0 right-0 pr-3 flex items-center text-sm leading-5"><i className={`fas ${showPassword ? 'fa-eye-slash' : 'fa-eye'} text-slate-400 hover:text-slate-200`}></i></button></div>
                            </div>
                            {error && <p className="text-red-500 text-sm text-center">{error}</p>}
                            <div>
                                <Button type="submit" variant="primary" disabled={loading} className="w-full py-3">
                                    {loading ? <i className="fas fa-spinner fa-spin"></i> : 'Sign in'}
                                </Button>
                            </div>
                        </form>
                    </div>
                </div>
            );
        };
        // --- END AUTHENTICATION PAGE ---

        // --- START EMPLOYEES PAGE COMPONENTS ---

        // Component: Employee Modal (Add/Edit Form)
        const EmployeeModal = ({ isOpen, onClose, onSave, employee, userProfile, allEmployees = [], isViewOnly = false, onSwitchToEdit }) => {
            const [formData, setFormData] = useState({});
            const { data: shops } = useStaticCollection('shops'); // Use one-time fetch
            const { data: positions } = useStaticCollection('positions'); // Use one-time fetch
            
            const supervisors = useMemo(() => allEmployees.filter(e => e.role === 'Shop Manager' && e.status === 'Active'), [allEmployees]);

            const availablePages = useMemo(() => [
                { key: 'employees', label: 'Employees' }, { key: 'checkinme', label: 'CheckInMe' },
                { key: 'attendanceReport', label: 'Attendance Report' }, { key: 'loanManager', label: 'Loan Manager' },
                { key: 'payroll', label: 'Payroll' }, { key: 'expenseReport', label: 'Expense Report' },
                { key: 'userActivity', label: 'User Activity' }, { key: 'settings', label: 'Settings' },
            ], []);

            // Initialize form data when modal opens or employee data changes
            useEffect(() => {
                const initialData = employee 
                    ? { ...employee, permissions: employee.permissions || [] } 
                    : { name: '', sex: 'M', dob: '', nationId: '', tel: '', shop: '', joinedDate: '', salary: '', position: '', shift: 'AM', supervisor: '', status: 'Active', email: '', uid: '', role: 'Staff', address: '', permissions: [], statusChangeDate: '', reasonForLeaving: '' };

                // When editing, ensure shop is in the right format based on role
                if (employee) {
                    if (employee.role === 'Shop Manager' || employee.role === 'Admin') {
                        initialData.shop = Array.isArray(employee.shop) ? employee.shop : (employee.shop ? [employee.shop] : []);
                    } else {
                        initialData.shop = Array.isArray(employee.shop) ? employee.shop[0] || '' : employee.shop || '';
                    }
                } else {
                    // For new employee, default based on Staff role
                    initialData.shop = '';
                }

                setFormData(initialData);
            }, [employee, isOpen]);
            
            // Automatically grant 'checkinme' permission to Staff role
            useEffect(() => {
                if (formData.role === 'Staff' && !formData.permissions?.includes('checkinme')) {
                    setFormData(prev => ({ ...prev, permissions: [...new Set([...(prev.permissions || []), 'checkinme'])] }));
                }
            }, [formData.role]);

            const handleChange = useCallback((e) => {
                const { name, value, type, checked } = e.target;
                
                if (name === 'role') {
                    // When role changes, convert shop data structure accordingly
                    setFormData(prev => {
                        const newRole = value;
                        let newShopValue = prev.shop;
                        if (newRole === 'Shop Manager' || newRole === 'Admin') {
                            // convert to array if it's a string
                            newShopValue = Array.isArray(prev.shop) ? prev.shop : (prev.shop ? [prev.shop] : []);
                        } else {
                            // convert to string (first element) if it's an array
                            newShopValue = Array.isArray(prev.shop) ? prev.shop[0] || '' : prev.shop;
                        }
                        return { ...prev, role: newRole, shop: newShopValue };
                    });
                } else if (type === 'checkbox') {
                    if (name === 'shop') { // Handling shop multi-select
                        setFormData(prev => {
                            const shopArray = Array.isArray(prev.shop) ? prev.shop : [];
                            const newShops = checked ? [...shopArray, value] : shopArray.filter(s => s !== value);
                            return { ...prev, shop: newShops };
                        });
                    } else { // Handling permissions
                        setFormData(prev => ({ ...prev, permissions: checked ? [...(prev.permissions || []), value] : (prev.permissions || []).filter(p => p !== value) }));
                    }
                } else {
                    setFormData(prev => ({ ...prev, [name]: value }));
                }
            }, []);

            // Handlers for salary input to allow typing numbers and format on blur
            const handleSalaryChange = useCallback((e) => { setFormData(prev => ({ ...prev, salary: e.target.value.replace(/[^0-9.]/g, '') })); }, []);
            const handleSalaryBlur = useCallback((e) => { setFormData(prev => ({ ...prev, salary: Utils.formatCurrency(e.target.value) })); }, []);
            const handleSubmit = useCallback((e) => { 
                e.preventDefault(); 
                const dataToSave = { ...formData };
                // Final check to ensure staff have a string for shop, not array
                if (dataToSave.role !== 'Shop Manager' && dataToSave.role !== 'Admin') {
                    dataToSave.shop = Array.isArray(dataToSave.shop) ? dataToSave.shop[0] || '' : dataToSave.shop;
                }
                onSave(dataToSave); 
            }, [onSave, formData]);
            const isFormerEmployee = formData.status === 'Terminated' || formData.status === 'Resigned';

            return (
                <Modal isOpen={isOpen} onClose={onClose}>
                    <form onSubmit={handleSubmit}>
                        <ModalHeader title={isViewOnly ? 'View Employee Details' : (employee ? 'Edit Employee' : 'Add New Employee')} onClose={onClose} />
                        <ModalBody>
                            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                {/* Employee Personal & Job Details */}
                                <div><label className="text-sm font-medium text-slate-400">Name</label><input name="name" value={formData.name || ''} onChange={handleChange} className="input" required disabled={isViewOnly} /></div>
                                <div><label className="text-sm font-medium text-slate-400">Sex</label><select name="sex" value={formData.sex || 'M'} onChange={handleChange} className="select" disabled={isViewOnly}><option value="M">Male</option><option value="F">Female</option></select></div>
                                <div><label className="text-sm font-medium text-slate-400">Date of Birth</label><input type="date" name="dob" value={formData.dob || ''} onChange={handleChange} className="input" disabled={isViewOnly} /></div>
                                <div><label className="text-sm font-medium text-slate-400">Nation ID</label><input name="nationId" value={formData.nationId || ''} onChange={handleChange} className="input" disabled={isViewOnly} /></div>
                                <div><label className="text-sm font-medium text-slate-400">Tel No</label><input name="tel" value={formData.tel || ''} onChange={handleChange} className="input" disabled={isViewOnly} /></div>
                                
                                {(formData.role === 'Shop Manager' || formData.role === 'Admin') ? (
                                    <div className="md:col-span-full">
                                        <label className="text-sm font-medium text-slate-400">Shops</label>
                                        <div className="mt-2 grid grid-cols-2 sm:grid-cols-3 gap-4 p-4 border border-slate-600 rounded-lg bg-slate-700/50">
                                            {shops.map(shop => (
                                                <div key={shop.id} className="flex items-center">
                                                    <input id={`shop-${shop.id}`} name="shop" type="checkbox" value={shop.name} checked={(Array.isArray(formData.shop) ? formData.shop : []).includes(shop.name)} onChange={handleChange} className="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500 bg-slate-600" disabled={isViewOnly} />
                                                    <label htmlFor={`shop-${shop.id}`} className="ml-3 text-sm text-slate-300">{shop.name}</label>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                ) : (
                                    <div>
                                        <label className="text-sm font-medium text-slate-400">Shop</label>
                                        <select name="shop" value={formData.shop || ''} onChange={handleChange} className="select" disabled={isViewOnly}>
                                            <option value="">Select Shop</option>
                                            {shops.map(s => <option key={s.id} value={s.name}>{s.name}</option>)}
                                        </select>
                                    </div>
                                )}

                                <div><label className="text-sm font-medium text-slate-400">Joined Date</label><input type="date" name="joinedDate" value={formData.joinedDate || ''} onChange={handleChange} className="input" disabled={isViewOnly} /></div>
                                <div><label className="text-sm font-medium text-slate-400">Salary</label><input name="salary" value={formData.salary || ''} onChange={handleSalaryChange} onBlur={handleSalaryBlur} className="input" disabled={isViewOnly || userProfile?.role === 'Shop Manager'} /></div>
                                <div><label className="text-sm font-medium text-slate-400">Position</label><select name="position" value={formData.position || ''} onChange={handleChange} className="select" disabled={isViewOnly}><option value="">Select Position</option>{positions.map(p => <option key={p.id} value={p.position}>{p.position}</option>)}</select></div>
                                <div><label className="text-sm font-medium text-slate-400">Shift</label><select name="shift" value={formData.shift || 'AM'} onChange={handleChange} className="select" disabled={isViewOnly}><option>AM</option><option>PM</option><option>APM</option></select></div>
                                <div><label className="text-sm font-medium text-slate-400">Supervisor</label><select name="supervisor" value={formData.supervisor || ''} onChange={handleChange} className="select" disabled={isViewOnly}><option value="">Select Supervisor</option>{supervisors.map(e => <option key={e.id} value={e.name}>{e.name}</option>)}</select></div>
                                <div><label className="text-sm font-medium text-slate-400">Staff Status</label><select name="status" value={formData.status || 'Active'} onChange={handleChange} className="select" disabled={isViewOnly}><option>Active</option><option>Terminated</option><option>Resigned</option></select></div>
                                {isFormerEmployee && (
                                    <>
                                        <div><label className="text-sm font-medium text-slate-400">Status Change Date</label><input type="date" name="statusChangeDate" value={formData.statusChangeDate || ''} onChange={handleChange} className="input" disabled={isViewOnly} /></div>
                                        <div className="md:col-span-2"><label className="text-sm font-medium text-slate-400">Reason for Leaving</label><textarea name="reasonForLeaving" value={formData.reasonForLeaving || ''} onChange={handleChange} className="input" rows="2" disabled={isViewOnly}></textarea></div>
                                    </>
                                )}
                                <div className="md:col-span-full"><hr className="border-slate-700 my-2"/></div>
                                {/* System & Permissions */}
                                <div><label className="text-sm font-medium text-slate-400">Email</label><input type="email" name="email" value={formData.email || ''} onChange={handleChange} className="input" disabled={isViewOnly || userProfile?.role === 'Shop Manager'} /></div>
                                <div><label className="text-sm font-medium text-slate-400">Role</label><select name="role" value={formData.role || 'Staff'} onChange={handleChange} className="select" disabled={isViewOnly || userProfile?.role === 'Shop Manager'}><option>Admin</option><option>Shop Manager</option><option>Staff</option></select></div>
                                <div className="md:col-span-2 lg:col-span-3"><label className="text-sm font-medium text-slate-400">Address</label><textarea name="address" value={formData.address || ''} onChange={handleChange} className="input" rows="3" disabled={isViewOnly}></textarea></div>
                                <div className="md:col-span-2 lg:col-span-3">
                                    <label className="text-sm font-medium text-slate-400">Page Permissions</label>
                                    <div className="mt-2 grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4 p-4 border border-slate-600 rounded-lg bg-slate-700/50">
                                        {availablePages.map(page => {
                                            const isRestricted = userProfile?.role === 'Shop Manager' && ['expenseReport', 'userActivity', 'settings'].includes(page.key);
                                            const isForced = page.key === 'checkinme' && formData.role === 'Staff';
                                            const isDisabled = isViewOnly || userProfile?.role === 'Shop Manager' || (userProfile?.role !== 'Admin' && isForced);
                                            return (
                                                <div key={page.key} className="flex items-center">
                                                    <input id={`perm-${page.key}`} type="checkbox" value={page.key} checked={formData.permissions?.includes(page.key)} onChange={handleChange} disabled={isDisabled} className="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500 bg-slate-600" />
                                                    <label htmlFor={`perm-${page.key}`} className={`ml-3 text-sm ${isDisabled ? 'text-slate-500' : 'text-slate-300'}`}>{page.label}</label>
                                                </div>
                                            );
                                        })}
                                    </div>
                                </div>
                            </div>
                        </ModalBody>
                        <ModalFooter>
                            {isViewOnly ? (
                                <>
                                    <Button type="button" variant="secondary" onClick={onClose}>Close</Button>
                                    {(userProfile?.role === 'Admin' || userProfile?.role === 'Shop Manager') && (
                                        <Button type="button" variant="primary" icon="fa-edit" onClick={(e) => { e.preventDefault(); onSwitchToEdit(); }}>Edit</Button>
                                    )}
                                </>
                            ) : (
                                <>
                                    <Button type="button" variant="secondary" onClick={onClose}>Cancel</Button>
                                    <Button type="submit" variant="primary" className="px-6">Save</Button>
                                </>
                            )}
                        </ModalFooter>
                    </form>
                </Modal>
            );
        };
        
        // Component: Active Employees Tab
        const ActiveEmployeesTab = ({ userProfile }) => {
            const { db, auth } = useFirebase();
            const [isModalOpen, setModalOpen] = useState(false);
            const [editingEmployee, setEditingEmployee] = useState(null);
            const [isViewOnly, setIsViewOnly] = useState(false); // NEW: State for view-only mode
            const [employeeToDelete, setEmployeeToDelete] = useState(null);
            const [selectedShop, setSelectedShop] = useState('');
            const [searchTerm, setSearchTerm] = useState('');
            const { data: shops } = useStaticCollection('shops'); // Use one-time fetch
            const [employees, setEmployees] = useState([]);
            const [loading, setLoading] = useState(true);

            // New optimized data fetching logic
            useEffect(() => {
                if (!db || !userProfile) return;
                
                const { collection, query, where, onSnapshot } = window.firebaseSDK;
                setLoading(true);
                let unsub1 = () => {};
                let unsub2 = () => {};

                // Helper to merge and de-duplicate results from two listeners
                const mergeResults = (res1, res2) => {
                    const combined = new Map();
                    res1.forEach(item => combined.set(item.id, item));
                    res2.forEach(item => combined.set(item.id, item));
                    setEmployees(Array.from(combined.values()));
                    setLoading(false);
                };

                const role = userProfile.role;
                
                if (role === 'Admin') {
                    let results1 = [], results2 = [];
                    // If filtering by shop, use efficient queries
                    if (selectedShop) {
                        // Query 1: For staff with shop as a string
                        const q1 = query(collection(db, "employees"), where("shop", "==", selectedShop));
                        unsub1 = onSnapshot(q1, snap => {
                            results1 = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                            mergeResults(results1, results2);
                        }, err => console.error("Admin query 1 failed:", err));
                        
                        // Query 2: For managers with shop as an array
                        const q2 = query(collection(db, "employees"), where("shop", "array-contains", selectedShop));
                        unsub2 = onSnapshot(q2, snap => {
                            results2 = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                            mergeResults(results1, results2);
                        }, err => console.error("Admin query 2 failed:", err));
                    } else {
                        // No shop filter, get all employees
                        const q1 = query(collection(db, "employees"));
                        unsub1 = onSnapshot(q1, snap => {
                            setEmployees(snap.docs.map(doc => ({ id: doc.id, ...doc.data() })));
                            setLoading(false);
                        }, err => console.error("Admin all employees query failed:", err));
                    }
                } else if (role === 'Shop Manager') {
                    const managedShops = Array.isArray(userProfile.shop) ? userProfile.shop : (userProfile.shop ? [userProfile.shop] : []);
                    if (managedShops.length > 0) {
                        let results1 = [], results2 = [];
                        // Query 1: Staff in any of the manager's shops (shop is a string)
                        const q1 = query(collection(db, "employees"), where("shop", "in", managedShops));
                        unsub1 = onSnapshot(q1, snap => {
                            results1 = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                            mergeResults(results1, results2);
                        }, err => console.error("Manager query 1 failed:", err));
                        
                        // Query 2: Other managers whose shops overlap (shop is an array)
                        const q2 = query(collection(db, "employees"), where("shop", "array-contains-any", managedShops));
                        unsub2 = onSnapshot(q2, snap => {
                            results2 = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                            mergeResults(results1, results2);
                        }, err => console.error("Manager query 2 failed:", err));
                    } else {
                        // Manager with no shops, only see themselves
                        const q1 = query(collection(db, "employees"), where("uid", "==", userProfile.uid));
                        unsub1 = onSnapshot(q1, snap => {
                            setEmployees(snap.docs.map(doc => ({ id: doc.id, ...doc.data() })));
                            setLoading(false);
                        }, err => console.error("Manager self-query failed:", err));
                    }
                } else { // Staff role
                    const q1 = query(collection(db, "employees"), where("uid", "==", auth.currentUser.uid));
                    unsub1 = onSnapshot(q1, snap => {
                        setEmployees(snap.docs.map(doc => ({ id: doc.id, ...doc.data() })));
                        setLoading(false);
                    }, err => console.error("Staff query failed:", err));
                }

                return () => { unsub1(); unsub2(); };
            }, [db, userProfile, auth.currentUser, selectedShop]);
            
            // Memoized filtering for performance (now only for status and search term)
            const filteredEmployees = useMemo(() => {
                const filtered = employees.filter(e => 
                    e.status === 'Active' && 
                    (e.name.toLowerCase().includes(searchTerm.toLowerCase()))
                );
                
                // Sort by shop name, then by employee name
                return filtered.sort((a, b) => {
                    const shopA = Array.isArray(a.shop) ? a.shop[0] || '' : a.shop || '';
                    const shopB = Array.isArray(b.shop) ? b.shop[0] || '' : b.shop || '';
                    if (shopA < shopB) return -1;
                    if (shopA > b.shop) return 1;
                    if (a.name < b.name) return -1;
                    if (a.name > b.name) return 1;
                    return 0;
                });
            }, [employees, searchTerm]);

            const handleOpenModal = useCallback((employee = null) => { setEditingEmployee(employee); setModalOpen(true); }, []);
            
            // NEW: Handler for viewing employee details
            const handleViewModal = useCallback((employee) => {
                setIsViewOnly(true);
                handleOpenModal(employee);
            }, [handleOpenModal]);
            
            const handleCloseModal = useCallback(() => {
                setModalOpen(false);
                setEditingEmployee(null);
                setIsViewOnly(false); // Reset view mode on close
            }, []);

            // NEW: Function to switch from view-only to edit mode
            const handleSwitchToEdit = useCallback(() => {
                setIsViewOnly(false);
            }, []);

            const handleSaveEmployee = useCallback(async (employeeData) => {
                const { doc, updateDoc, addDoc, collection, serverTimestamp, getDocs, query, where, writeBatch } = window.firebaseSDK;
                // Sanitize salary before saving
                const salaryToSave = parseFloat(String(employeeData.salary).replace(/[^0-9.-]/g, '')) || 0;
                const dataToSave = { ...employeeData, salary: salaryToSave };
                try {
                    let savedEmployeeId;
                    let savedEmployeeName = dataToSave.name;
                    let savedEmployeeShop = dataToSave.shop;

                    if (dataToSave.id) {
                        savedEmployeeId = dataToSave.id;
                        const { id, ...data } = dataToSave;
                        const originalData = employees.find(e => e.id === id);
                        await updateDoc(doc(db, 'employees', id), data);
                        // Log the update action
                        await addDoc(collection(db, "userLogs"), { 
                            userId: auth.currentUser.uid, 
                            action: 'Update Employee',
                            targetId: id,
                            targetName: data.name,
                            timestamp: serverTimestamp(), 
                            originalData, 
                            updatedData: data 
                        });
                    } else {
                        const newDocRef = await addDoc(collection(db, 'employees'), dataToSave);
                        savedEmployeeId = newDocRef.id;
                        // Log the add action
                        await addDoc(collection(db, "userLogs"), { 
                            userId: auth.currentUser.uid, 
                            action: 'Add Employee',
                            targetId: newDocRef.id,
                            targetName: dataToSave.name,
                            timestamp: serverTimestamp(), 
                            originalData: null, 
                            updatedData: dataToSave 
                        });
                    }

                    // Auto-update supervisor for the shop(s) if the saved employee is a Shop Manager
                    if (dataToSave.role === 'Shop Manager' && dataToSave.shop) {
                        const shopsToUpdate = Array.isArray(dataToSave.shop) ? dataToSave.shop : [dataToSave.shop];
                        if (shopsToUpdate.length > 0) {
                            console.log(`Updating supervisors for shops: ${shopsToUpdate.join(', ')} to ${savedEmployeeName}`);
                            const batch = writeBatch(db);
                            await Promise.all(shopsToUpdate.map(async (shopName) => {
                                const shopEmployeesQuery = query(collection(db, "employees"), where("shop", "==", shopName));
                                const querySnapshot = await getDocs(shopEmployeesQuery);
                                querySnapshot.forEach((employeeDoc) => {
                                    if (employeeDoc.id !== savedEmployeeId) {
                                        const empRef = doc(db, 'employees', employeeDoc.id);
                                        batch.update(empRef, { supervisor: savedEmployeeName });
                                    }
                                });
                            }));
                            await batch.commit();
                            console.log("Batch update for supervisors completed.");
                        }
                    }

                    handleCloseModal();
                } catch (e) { console.error("Error saving employee:", e); }
            }, [db, auth, employees, handleCloseModal]);
            
            const handleDeleteConfirm = useCallback(async () => {
                if (!employeeToDelete) return;
                try { 
                    await window.firebaseSDK.deleteDoc(window.firebaseSDK.doc(db, 'employees', employeeToDelete.id)); 
                    const { addDoc, collection, serverTimestamp } = window.firebaseSDK;
                    // Log the delete action
                    await addDoc(collection(db, "userLogs"), { 
                        userId: auth.currentUser.uid, 
                        action: 'Delete Employee',
                        targetId: employeeToDelete.id,
                        targetName: employeeToDelete.name,
                        timestamp: serverTimestamp(), 
                        originalData: employeeToDelete, 
                        updatedData: null 
                    });
                } catch (e) { 
                    console.error(`Error deleting employee:`, e); 
                } finally {
                    setEmployeeToDelete(null);
                }
            }, [db, auth, employeeToDelete]);

            const handleExportExcel = useCallback(() => {
                const dataToExport = filteredEmployees.map(emp => ({ 
                    'Name': emp.name, 'Position': emp.position, 'Role': emp.role, 'Shop': emp.shop, 
                    'Join Date': emp.joinedDate, 'Worked Duration': Utils.calculateWorkedDuration(emp.joinedDate), 
                    'Shift': emp.shift, 'Telephone': emp.tel, 'Email': emp.email, 
                    'Salary (KHR)': parseFloat(String(emp.salary).replace(/[^0-9.-]/g, '')) || 0 
                }));
                const worksheet = XLSX.utils.json_to_sheet(dataToExport);
                const workbook = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(workbook, worksheet, "Active Employees");
                // Set column widths for better readability
                worksheet["!cols"] = [ { wch: 25 }, { wch: 20 }, { wch: 15 }, { wch: 15 }, { wch: 12 }, { wch: 15 }, { wch: 10 }, { wch: 15 }, { wch: 30 }, { wch: 15 } ];
                XLSX.writeFile(workbook, "Active_Employees.xlsx");
            }, [filteredEmployees]);

            return (
                <Card>
                    <div className="flex flex-wrap gap-4 justify-between items-center mb-6">
                        <h3 className="text-xl font-semibold text-slate-100 flex items-center gap-2">
                            <span>Active Employee List</span>
                            <span className="text-blue-400 font-bold text-2xl"> : {filteredEmployees.length}</span>
                        </h3>
                        <div className="flex flex-wrap gap-4 items-center">
                             <input type="text" placeholder="Search by name..." value={searchTerm} onChange={e => setSearchTerm(e.target.value)} className="input w-full sm:w-auto" />
                            {userProfile?.role === 'Admin' && (<select value={selectedShop} onChange={e => setSelectedShop(e.target.value)} className="select w-full sm:w-auto"><option value="">All Shops</option>{shops.map(s => <option key={s.id} value={s.name}>{s.name}</option>)}</select>)}
                            <Button variant="success" icon="fa-file-excel" onClick={handleExportExcel}>Excel</Button>
                            <Button variant="primary" icon="fa-plus" onClick={() => handleOpenModal()}>Add</Button>
                        </div>
                    </div>
                    {loading ? (
                        <div className="text-center py-10"><i className="fas fa-spinner fa-spin text-3xl text-blue-400"></i><p className="mt-2 text-slate-400">Loading Employees...</p></div>
                    ) : (
                        <>
                            {/* Desktop Table View */}
                            <div className="overflow-x-auto"><table className="min-w-full divide-y divide-slate-700"><thead className="bg-slate-900/50"><tr><th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Name</th><th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Position</th><th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Shop</th><th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Join Date</th><th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Worked Dur.</th><th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Shift</th><th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Tel</th><th className="px-4 py-3 text-right text-xs font-semibold text-slate-400 uppercase">Salary</th><th className="px-4 py-3 text-center text-xs font-semibold text-slate-400 uppercase">Actions</th></tr></thead><tbody className="divide-y divide-slate-700">{filteredEmployees.map(emp => (<tr key={emp.id} className="hover:bg-slate-700/50"><td className="px-4 py-4 text-sm text-slate-200 whitespace-nowrap">{emp.name}</td><td className="px-4 py-4 text-sm text-slate-300 whitespace-nowrap">{emp.position}</td><td className="px-4 py-4 text-sm text-slate-300 whitespace-nowrap">{Array.isArray(emp.shop) ? emp.shop.join(', ') : emp.shop}</td><td className="px-4 py-4 text-sm text-slate-300 whitespace-nowrap">{emp.joinedDate}</td><td className="px-4 py-4 text-sm text-slate-300 whitespace-nowrap">{Utils.calculateWorkedDuration(emp.joinedDate)}</td><td className="px-4 py-4 text-sm text-slate-300 whitespace-nowrap">{emp.shift}</td><td className="px-4 py-4 text-sm text-slate-300 whitespace-nowrap">{emp.tel}</td><td className="px-4 py-4 text-sm text-slate-300 text-right whitespace-nowrap">{Utils.formatCurrency(emp.salary)}</td><td className="px-4 py-4 text-center whitespace-nowrap"><div className="flex items-center justify-center gap-4"><Button variant="icon-view" icon="fa-eye" onClick={() => handleViewModal(emp)} />{(userProfile?.role === 'Admin' || userProfile?.role === 'Shop Manager') && (<Button variant="icon-delete" icon="fa-trash" onClick={() => setEmployeeToDelete(emp)} />)}</div></td></tr>))}</tbody></table></div>
                        </>
                    )}
                    <EmployeeModal isOpen={isModalOpen} onClose={handleCloseModal} onSave={handleSaveEmployee} employee={editingEmployee} userProfile={userProfile} allEmployees={employees} isViewOnly={isViewOnly} onSwitchToEdit={handleSwitchToEdit} />
                    <ConfirmationModal isOpen={!!employeeToDelete} onClose={() => setEmployeeToDelete(null)} onConfirm={handleDeleteConfirm} title="Delete Employee" message={`Are you sure you want to delete ${employeeToDelete?.name}? This action cannot be undone.`} />
                </Card>
            );
        };
        
        // Component: Former Employees Tab
        const FormerEmployeesTab = ({ userProfile }) => {
            const { db, auth } = useFirebase();
            const [isModalOpen, setModalOpen] = useState(false);
            const [editingEmployee, setEditingEmployee] = useState(null);
            const [employeeToDelete, setEmployeeToDelete] = useState(null);
            const { data: employees } = useCollection('employees');

            const formerEmployees = useMemo(() => employees.filter(e => e.status === 'Resigned' || e.status === 'Terminated'), [employees]);

            const handleOpenModal = useCallback((employee = null) => { setEditingEmployee(employee); setModalOpen(true); }, []);
            const handleCloseModal = useCallback(() => { setModalOpen(false); setEditingEmployee(null); }, []);
            
            const handleSaveEmployee = useCallback(async (employeeData) => {
                const { doc, updateDoc, addDoc, collection, serverTimestamp } = window.firebaseSDK;
                const salaryToSave = parseFloat(String(employeeData.salary).replace(/[^0-9.-]/g, '')) || 0;
                const dataToSave = { ...employeeData, salary: salaryToSave };
                try {
                    if (dataToSave.id) {
                        const { id, ...data } = dataToSave;
                        const originalData = employees.find(e => e.id === id);
                        await updateDoc(doc(db, 'employees', id), data);
                        await addDoc(collection(db, "userLogs"), { 
                            userId: auth.currentUser.uid, 
                            action: 'Update Former Employee',
                            targetId: id,
                            targetName: data.name,
                            timestamp: serverTimestamp(), 
                            originalData, 
                            updatedData: data 
                        });
                    }
                    handleCloseModal();
                } catch (e) { console.error("Error saving employee:", e); }
            }, [db, auth, employees, handleCloseModal]);
            
            const handleDeleteConfirm = useCallback(async () => {
                if (!employeeToDelete) return;
                try { 
                    await window.firebaseSDK.deleteDoc(window.firebaseSDK.doc(db, 'employees', employeeToDelete.id)); 
                    const { addDoc, collection, serverTimestamp } = window.firebaseSDK;
                    await addDoc(collection(db, "userLogs"), { 
                        userId: auth.currentUser.uid, 
                        action: 'Delete Employee Record',
                        targetId: employeeToDelete.id,
                        targetName: employeeToDelete.name,
                        timestamp: serverTimestamp(), 
                        originalData: employeeToDelete, 
                        updatedData: null 
                    });
                } catch (e) { 
                    console.error(`Error deleting employee:`, e); 
                } finally {
                    setEmployeeToDelete(null);
                }
            }, [db, auth, employeeToDelete]);

            return (
                <Card>
                    <h3 className="text-xl font-semibold text-slate-100 mb-6">Resigned/Terminated Employees</h3>
                    {/* Desktop Table */}
                    <div className="overflow-x-auto hidden md:block"><table className="min-w-full divide-y divide-slate-700"><thead className="bg-slate-900/50"><tr><th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Date</th><th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Shop Name</th><th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Staff</th><th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Status</th><th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Reason</th><th className="px-4 py-3 text-center text-xs font-semibold text-slate-400 uppercase">Actions</th></tr></thead><tbody className="divide-y divide-slate-700">{formerEmployees.map(emp => (<tr key={emp.id} className="hover:bg-slate-700/50"><td className="px-4 py-4 text-sm text-slate-300 whitespace-nowrap">{emp.statusChangeDate || 'N/A'}</td><td className="px-4 py-4 text-sm text-slate-300 whitespace-nowrap">{emp.shop}</td><td className="px-4 py-4 text-sm text-slate-200 whitespace-nowrap">{emp.name}</td><td className="px-4 py-4 text-sm text-slate-300 whitespace-nowrap"><span className={`px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${emp.status === 'Resigned' ? 'bg-yellow-100 text-yellow-800' : 'bg-red-100 text-red-800'}`}>{emp.status}</span></td><td className="px-4 py-4 text-sm text-slate-300">{emp.reasonForLeaving}</td><td className="px-4 py-4 text-center whitespace-nowrap"><div className="flex items-center justify-center gap-4">{(userProfile?.role === 'Admin' || userProfile?.role === 'Shop Manager') && (<><Button variant="icon-edit" icon="fa-edit" onClick={() => handleOpenModal(emp)} title="Edit Record" /><Button variant="icon-delete" icon="fa-trash" onClick={() => setEmployeeToDelete(emp)} title="Delete Record" /></>)}</div></td></tr>))}</tbody></table></div>
                    {/* Mobile Cards */}
                    <div className="grid grid-cols-1 gap-4 md:hidden">{formerEmployees.map(emp => (<div key={emp.id} className="bg-slate-700/50 rounded-lg p-4 space-y-3"><div className="flex justify-between items-start"><div><p className="font-bold text-lg text-slate-100">{emp.name}</p><p className="text-sm text-slate-300">{emp.shop}</p></div><div className="flex items-center space-x-3"><span className={`px-2 py-1 text-xs font-semibold rounded-full ${emp.status === 'Resigned' ? 'bg-yellow-200 text-yellow-900' : 'bg-red-200 text-red-900'}`}>{emp.status}</span>{(userProfile?.role === 'Admin' || userProfile?.role === 'Shop Manager') && (<><Button variant="icon-edit" icon="fa-edit" onClick={() => handleOpenModal(emp)} title="Edit Record" /><Button variant="icon-delete" icon="fa-trash" onClick={() => setEmployeeToDelete(emp)} title="Delete Record" /></>)}</div></div><div className="text-sm pt-2 border-t border-slate-600"><p><span className="text-slate-400">Date: </span><span className="text-slate-200 font-medium">{emp.statusChangeDate || 'N/A'}</span></p><p><span className="text-slate-400">Reason: </span><span className="text-slate-200 font-medium">{emp.reasonForLeaving || 'N/A'}</span></p></div></div>))}</div>
                    <EmployeeModal isOpen={isModalOpen} onClose={handleCloseModal} onSave={handleSaveEmployee} employee={editingEmployee} userProfile={userProfile} allEmployees={employees} />
                    <ConfirmationModal isOpen={!!employeeToDelete} onClose={() => setEmployeeToDelete(null)} onConfirm={handleDeleteConfirm} title="Delete Employee Record" message={`Are you sure you want to permanently delete the record for ${employeeToDelete?.name}? This action cannot be undone.`} />
                </Card>
            );
        };
        
        // Component: Salary Revise Report Tab
        const SalaryReviseReportTab = ({ userProfile }) => {
            const { db } = useFirebase();
            const [isModalOpen, setModalOpen] = useState(false);
            const [editingRevision, setEditingRevision] = useState(null);
            const [revisionToDelete, setRevisionToDelete] = useState(null);
            const { where } = window.firebaseSDK;
            
            const queryConstraints = useMemo(() => {
                if (!userProfile) return [where("shopName", "==", "null")];
                if (userProfile.role === 'Admin') return [];
                if (userProfile.role === 'Shop Manager') {
                    const shops = Array.isArray(userProfile.shop) ? userProfile.shop : (userProfile.shop ? [userProfile.shop] : []);
                    if (shops.length > 0) {
                        return [where("shopName", "in", shops)];
                    }
                    return [where("shopName", "==", "null")]; // No shops assigned
                }
                return [where("shopName", "==", userProfile.shop || null)];
            }, [userProfile]);

            const { data: revisions } = useCollection('salaryRevisions', queryConstraints);
            const { data: shops } = useCollection('shops');
            const [selectedShop, setSelectedShop] = useState('');
            const [selectedMonth, setSelectedMonth] = useState(new Date().toISOString().slice(0, 7));

            useEffect(() => {
                if (userProfile && userProfile.role !== 'Admin') {
                    setSelectedShop(Array.isArray(userProfile.shop) ? '' : userProfile.shop || '');
                }
            }, [userProfile]);

            const availableShops = useMemo(() => {
                if (userProfile?.role === 'Admin') return shops;
                if (userProfile?.role === 'Shop Manager' && Array.isArray(userProfile.shop)) {
                    return userProfile.shop.map(name => ({ id: name, name: name }));
                }
                return []; 
            }, [shops, userProfile]);

            const filteredRevisions = useMemo(() => {
                return revisions.filter(rev => 
                    (!selectedShop || rev.shopName === selectedShop) && 
                    (!selectedMonth || rev.date.startsWith(selectedMonth))
                );
            }, [revisions, selectedShop, selectedMonth]);

            const handleOpenModal = useCallback((revision = null) => { setEditingRevision(revision); setModalOpen(true); }, []);
            const handleCloseModal = useCallback(() => { setEditingRevision(null); setModalOpen(false); }, []);

            const handleSaveRevision = useCallback(async (revisionData) => {
                const { doc, updateDoc, addDoc, collection } = window.firebaseSDK;
                // Destructure all needed properties from the incoming data
                const { id, staffId, date, shopName, staffName, reviseAmount, updatedSalary, effectiveDate } = revisionData;

                // Explicitly build the object that will be saved to Firestore.
                const dataToSave = {
                    date,
                    shopName,
                    staffId,
                    staffName,
                    reviseAmount: parseFloat(reviseAmount) || 0,
                    updatedSalary: updatedSalary || 0, // Ensure the crucial field is saved
                    effectiveDate: effectiveDate || date // Default effective date to revision date if not set
                };

                try {
                    if (id) {
                        // When updating an existing record, always reset its status to 'Pending' for re-approval.
                        dataToSave.status = 'Pending';
                        await updateDoc(doc(db, 'salaryRevisions', id), dataToSave);
                    } else {
                        // Otherwise, we are adding a new document with 'Pending' status
                        dataToSave.status = 'Pending';
                        await addDoc(collection(db, 'salaryRevisions'), dataToSave);
                    }
                    
                    handleCloseModal(); // Close the modal on success
                } catch (error) { console.error("Error saving salary revision:", error); }
            }, [db, handleCloseModal]);
            
            const handleDeleteRevision = useCallback(async () => {
                if (!revisionToDelete) return;
                try {
                    await window.firebaseSDK.deleteDoc(window.firebaseSDK.doc(db, 'salaryRevisions', revisionToDelete.id));
                } catch (error) { 
                    console.error("Error deleting revision:", error); 
                } finally {
                    setRevisionToDelete(null);
                }
            }, [db, revisionToDelete]);

            const handleUpdateStatus = useCallback(async (revisionId, newStatus) => {
                if (!revisionId || !newStatus) return;
                try {
                    await window.firebaseSDK.updateDoc(window.firebaseSDK.doc(db, 'salaryRevisions', revisionId), { status: newStatus });
                } catch (error) {
                    console.error(`Error updating revision status:`, error);
                }
            }, [db]);

            return (
                <Card>
                    <div className="flex flex-wrap gap-4 justify-between items-center mb-6">
                        <h3 className="text-xl font-semibold text-slate-100">Revise Tracking Report</h3>
                        <div className="flex flex-wrap gap-4 items-center">
                            {(userProfile.role === 'Admin' || (userProfile.role === 'Shop Manager' && Array.isArray(userProfile.shop))) && (
                                <select value={selectedShop} onChange={e => setSelectedShop(e.target.value)} className="select w-full sm:w-auto">
                                    <option value="">{userProfile.role === 'Admin' ? 'All Shops' : 'All My Shops'}</option>
                                    {availableShops.map(s => <option key={s.id} value={s.name}>{s.name}</option>)}
                                </select>
                            )}
                            <input type="month" value={selectedMonth} onChange={e => setSelectedMonth(e.target.value)} className="input w-full sm:w-auto" />
                            {(userProfile.role === 'Admin' || userProfile.role === 'Shop Manager') && (
                                <Button variant="primary" icon="fa-plus" onClick={() => handleOpenModal()}>Add</Button>
                            )}
                        </div>
                    </div>
                    <div className="overflow-x-auto"><table className="min-w-full divide-y divide-slate-700"><thead className="bg-slate-900/50"><tr><th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Date</th><th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Effective Date</th><th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Staff Name</th><th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Shop Name</th><th className="px-4 py-3 text-right text-xs font-semibold text-slate-400 uppercase">Amount Revised</th><th className="px-4 py-3 text-right text-xs font-semibold text-slate-400 uppercase">Updated Salary</th><th className="px-4 py-3 text-center text-xs font-semibold text-slate-400 uppercase">Status</th><th className="px-4 py-3 text-center text-xs font-semibold text-slate-400 uppercase">Actions</th></tr></thead><tbody className="divide-y divide-slate-700">{filteredRevisions.map(rev => {
                        const isActionable = rev.status !== 'Approved' && rev.status !== 'Rejected';
                        return (<tr key={rev.id} className="hover:bg-slate-700/50">
                            <td className="px-4 py-4 text-sm text-slate-200">{rev.date}</td>
                            <td className="px-4 py-4 text-sm font-semibold text-blue-300">{rev.effectiveDate}</td>
                            <td className="px-4 py-4 text-sm text-slate-200">{rev.staffName}</td>
                            <td className="px-4 py-4 text-sm text-slate-300">{rev.shopName}</td>
                            <td className={`px-4 py-4 text-sm text-right font-semibold ${parseFloat(rev.reviseAmount) < 0 ? 'text-red-400' : 'text-blue-400'}`}>{Utils.formatCurrency(rev.reviseAmount)}</td>
                            <td className="px-4 py-4 text-sm text-slate-300 text-right">{Utils.formatCurrency(rev.updatedSalary)}</td>
                            <td className="px-4 py-4 text-center text-sm"><span className={`px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${ rev.status === 'Approved' ? 'bg-green-100 text-green-800' : rev.status === 'Rejected' ? 'bg-red-100 text-red-800' : 'bg-yellow-100 text-yellow-800' }`}>{rev.status || 'Pending'}</span></td>
                            <td className="px-4 py-4 text-center whitespace-nowrap">
                                <div className="flex items-center justify-center gap-4">
                                    {/* Approve/Reject for Admin on actionable items */}
                                    {userProfile?.role === 'Admin' && isActionable && (
                                        <>
                                            <Button variant="icon-approve" icon="fa-check-circle" onClick={() => handleUpdateStatus(rev.id, 'Approved')} title="Approve" />
                                            <Button variant="icon-reject" icon="fa-times-circle" onClick={() => handleUpdateStatus(rev.id, 'Rejected')} title="Reject" />
                                        </>
                                    )}
                                    {/* Edit/Delete buttons with role-based conditions */}
                                    {(userProfile?.role === 'Admin' || (userProfile?.role === 'Shop Manager' && isActionable)) && (
                                        <>
                                            <Button variant="icon-edit" icon="fa-edit" onClick={() => handleOpenModal(rev)} title="Edit Revision" />
                                            <Button variant="icon-delete" icon="fa-trash" onClick={() => setRevisionToDelete(rev)} title="Delete Revision" />
                                        </>
                                    )}
                                </div>
                            </td>
                        </tr>);
                    })}</tbody></table></div>
                    <SalaryReviseModal isOpen={isModalOpen} onClose={handleCloseModal} onSave={handleSaveRevision} revision={editingRevision} userProfile={userProfile} />
                    <ConfirmationModal isOpen={!!revisionToDelete} onClose={() => setRevisionToDelete(null)} onConfirm={handleDeleteRevision} title="Delete Salary Revision" message="Are you sure you want to delete this revision record? This action cannot be undone."/>
                </Card>
            );
        };

        // Component: Salary Revise Modal
        const SalaryReviseModal = ({ isOpen, onClose, onSave, revision, userProfile }) => {
            const [formData, setFormData] = useState({});
            const { data: allShops } = useCollection('shops');
            const { data: employees } = useCollection('employees');
            const [selectedShop, setSelectedShop] = useState('');

            const availableShops = useMemo(() => {
                if (!userProfile) return [];
                if (userProfile.role === 'Admin') return allShops;
                
                const managedShops = Array.isArray(userProfile.shop) ? userProfile.shop : (userProfile.shop ? [userProfile.shop] : []);
                if (managedShops.length > 0) {
                    return allShops.filter(s => managedShops.includes(s.name));
                }
                return [];
            }, [allShops, userProfile]);

            useEffect(() => {
                const today = new Date().toISOString().substring(0, 10);
                const initialData = revision 
                    ? { ...revision, effectiveDate: revision.effectiveDate || revision.date } 
                    : { date: today, effectiveDate: today, shopName: '', staffId: '', reviseAmount: '' };
                setFormData(initialData);
                setSelectedShop(initialData.shopName);
            }, [revision, isOpen]);

            const employeesInShop = useMemo(() => employees.filter(emp => emp.status === 'Active' && (Array.isArray(emp.shop) ? emp.shop.includes(selectedShop) : emp.shop === selectedShop)), [selectedShop, employees]);
            const selectedEmployee = useMemo(() => employees.find(emp => emp.id === formData.staffId), [formData.staffId, employees]);
            const baseSalary = selectedEmployee ? selectedEmployee.salary : 0;
            
            // Robust calculation to prevent errors with empty inputs
            const updatedSalary = useMemo(() => {
                const base = parseFloat(String(baseSalary).replace(/[^0-9.-]/g, '')) || 0;
                const revisionAmount = parseFloat(formData.reviseAmount) || 0; // Treat empty/invalid input as 0
                return base + revisionAmount;
            }, [baseSalary, formData.reviseAmount]);
            
            const handleChange = useCallback((e) => {
                const { name, value } = e.target;
                setFormData(prev => ({ ...prev, [name]: value }));
                if (name === 'shopName') { setSelectedShop(value); setFormData(prev => ({ ...prev, staffId: '' })); }
            }, []);
            
            const handleSubmit = useCallback((e) => {
                e.preventDefault();
                const staffName = selectedEmployee?.name || '';
                onSave({ ...formData, baseSalary, updatedSalary, staffName });
            }, [onSave, formData, selectedEmployee, baseSalary, updatedSalary]);

            return (
                <Modal isOpen={isOpen} onClose={onClose} maxWidth="max-w-2xl">
                    <form onSubmit={handleSubmit}>
                        <ModalHeader title={revision ? "Edit Salary Revision" : "New Salary Revision"} onClose={onClose} />
                        <ModalBody>
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div><label className="text-sm font-medium text-slate-400">Date</label><input type="date" name="date" value={formData.date || ''} onChange={handleChange} className="input" /></div>
                                <div><label className="text-sm font-medium text-slate-400">Effective Date</label><input type="date" name="effectiveDate" value={formData.effectiveDate || ''} onChange={handleChange} className="input" /></div>
                                <div><label className="text-sm font-medium text-slate-400">Shop Name</label><select name="shopName" value={formData.shopName || ''} onChange={handleChange} className="select"><option value="">Select Shop</option>{availableShops.map(s => <option key={s.id} value={s.name}>{s.name}</option>)}</select></div>
                                <div><label className="text-sm font-medium text-slate-400">Staff Name</label><select name="staffId" value={formData.staffId || ''} onChange={handleChange} className="select" disabled={!selectedShop}><option value="">Select Staff</option>{employeesInShop.map(e => <option key={e.id} value={e.id}>{e.name}</option>)}</select></div>
                                <div className="md:col-span-2"><label className="text-sm font-medium text-slate-400">Amount to Revise</label><input type="number" name="reviseAmount" value={formData.reviseAmount || ''} onChange={handleChange} className="input" /></div>
                                <div className="bg-slate-700/50 p-4 rounded-lg"><label className="text-sm font-medium text-slate-400">Base Salary</label><input value={Utils.formatCurrency(baseSalary)} className="input mt-1" disabled /></div>
                                <div className="bg-slate-700/50 p-4 rounded-lg"><label className="text-sm font-medium text-slate-400">Updated Salary</label><input value={Utils.formatCurrency(updatedSalary)} className="input mt-1" disabled /></div>
                            </div>
                        </ModalBody>
                        <ModalFooter><Button type="button" variant="secondary" onClick={onClose}>Cancel</Button><Button type="submit" variant="primary" className="px-6">Submit</Button></ModalFooter>
                    </form>
                </Modal>
            );
        };

        // Component: Main Employees Page (Tab Container)
        const EmployeesPage = ({ userProfile }) => {
            const [activeTab, setActiveTab] = useState('active');
            return (
                <TabbedPage tabs={{ active: 'Active Employees', salaryReport: 'Salary Revise Report', former: 'Resigned/Terminated' }} activeTab={activeTab} setActiveTab={setActiveTab}>
                    <div id="active"><ActiveEmployeesTab userProfile={userProfile} /></div>
                    <div id="salaryReport"><SalaryReviseReportTab userProfile={userProfile} /></div>
                    <div id="former"><FormerEmployeesTab userProfile={userProfile} /></div>
                </TabbedPage>
            );
        };
        // --- END EMPLOYEES PAGE COMPONENTS ---

        // --- START CHECKINME PAGE COMPONENTS ---

        // Component: Check In / Out Tab
        const CheckInOutTab = ({ userProfile }) => {
            const { db } = useFirebase();
            const [currentTime, setCurrentTime] = useState(new Date());
            const [location, setLocation] = useState(null);
            const [accuracy, setAccuracy] = useState(null); // NEW: State for location accuracy
            const [status, setStatus] = useState('សូមចុច "Refresh Location" ដើម្បីចាប់ផ្តើម!');
            const [loading, setLoading] = useState(false);
            const [distance, setDistance] = useState(null);
            const [selectedShopForCheckIn, setSelectedShopForCheckIn] = useState('');
            const [alertModal, setAlertModal] = useState({ isOpen: false, message: '' }); // State for the new alert modal
            
            // FIX: Set the month filter to default to the current month, respecting the user's local timezone.
            const [selectedMonth, setSelectedMonth] = useState(() => {
                const now = new Date();
                const year = now.getFullYear();
                const month = String(now.getMonth() + 1).padStart(2, '0');
                return `${year}-${month}`;
            });

            // Fetch all data needed for the payroll hook
            const allData = {
                shops: useCollection('shops').data,
                attendance: useCollection('attendance').data,
                leaveRequests: useCollection('leaveRequests').data,
                otRequests: useCollection('otRequests').data,
                staffLoans: useCollection('staffLoans').data,
                employeeStates: useCollection('employeeStates').data,
                salaryRevisions: useCollection('salaryRevisions').data,
            };
            
            const isMultiShopManager = userProfile.role === 'Shop Manager' && Array.isArray(userProfile.shop);

            // Set the default shop for check-in
            useEffect(() => {
                if (!isMultiShopManager) {
                    setSelectedShopForCheckIn(userProfile.shop);
                }
            }, [userProfile, isMultiShopManager]);

            const userShop = useMemo(() => {
                if (!selectedShopForCheckIn) return null;
                return allData.shops.find(s => s.name === selectedShopForCheckIn);
            }, [selectedShopForCheckIn, allData.shops]);

            const today = useMemo(() => new Date().toISOString().split('T')[0], []);
            const userAttendanceToday = useMemo(() => (allData.attendance || []).filter(a => a.employeeId === userProfile.id && a.timestamp?.toDate().toISOString().startsWith(today)).sort((a, b) => b.timestamp?.toDate() - a.timestamp?.toDate()), [userProfile, allData.attendance, today]);
            const lastAction = userAttendanceToday[0] || null;

            // Update time every second
            useEffect(() => { const timerId = setInterval(() => setCurrentTime(new Date()), 1000); return () => clearInterval(timerId); }, []);
            
            // Get user's location and check distance from shop
            const getLocation = useCallback((isCheckAction = false) => {
                if (!userShop) { 
                    setStatus(isMultiShopManager ? "Please select a shop to enable check-in." : "Your assigned shop could not be found."); 
                    setLoading(false);
                    return Promise.reject("No user shop selected"); 
                }
                
                setStatus("Getting your current location...");
                setLoading(true);

                return new Promise((resolve, reject) => {
                    navigator.geolocation.getCurrentPosition(
                        (position) => {
                            const { latitude, longitude, accuracy: posAccuracy } = position.coords;
                            const newLocation = { latitude, longitude };
                            setLocation(newLocation);
                            setAccuracy(posAccuracy);
                            
                            const dist = Utils.getDistance(latitude, longitude, parseFloat(userShop.latitude), parseFloat(userShop.longitude));
                            setDistance(dist);
                            
                            const radius = parseFloat(userShop.radius) || 500;
                            const isInRange = dist <= radius;
                            
                            setStatus(isInRange 
                                ? `You are ${Math.round(dist)}m from the shop. Check-in is enabled.`
                                : `You are ${Math.round(dist)}m from the shop. Check-in is disabled.`
                            );
                            setLoading(false);
                            // Resolve with location data for the check-in handler to use
                            resolve({ location: newLocation, distance: dist, shop: userShop });
                        },
                        (error) => {
                            setStatus(error.code === 1 ? "Location permission denied." : "Could not get your location."); 
                            setLoading(false);
                            reject(error);
                        }, 
                        { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 } // Optimized options
                    );
                });
            }, [userShop, isMultiShopManager]);

            const handleCheckAction = useCallback(async () => {
                setLoading(true);
                setStatus("Getting fresh location for check action...");
                
                try {
                    // Step 1: Get a fresh location reading.
                    const { location: freshLocation, distance: freshDistance, shop } = await getLocation(true);

                    // Step 2: Verify the user is still in range.
                    if (freshDistance > (parseFloat(shop.radius) || 500)) {
                        setStatus(`Cannot check-in. You are ${Math.round(freshDistance)}m away.`);
                        setLoading(false);
                        return;
                    }
                    
                    // Step 3: Proceed with saving the attendance record.
                    const { addDoc, collection, serverTimestamp } = window.firebaseSDK;
                    const nextActionType = lastAction?.type === 'in' ? 'out' : 'in';
                    const checkInTimestamp = new Date();
                    
                    await addDoc(collection(db, 'attendance'), { employeeId: userProfile.id, employeeName: userProfile.name, shop: selectedShopForCheckIn, timestamp: serverTimestamp(), type: nextActionType, location: freshLocation });
                    
                    // Step 4: Handle late check-in logic if applicable.
                    if (nextActionType === 'in') {
                        const shift = userProfile.shift || 'AM';
                        const checkInHour = checkInTimestamp.getHours(); 
                        const checkInMinute = checkInTimestamp.getMinutes();
                        let isLate = (shift === 'AM' || shift === 'APM') ? (checkInHour > 7 || (checkInHour === 7 && checkInMinute >= 35)) : (shift === 'PM') ? (checkInHour > 12 || (checkInHour === 12 && checkInMinute >= 35)) : false;
                        
                        if (isLate) {
                            const todayStr = checkInTimestamp.toISOString().split('T')[0];
                            const approvedLeaveToday = (allData.leaveRequests || []).find(lr => lr.staffId === userProfile.id && lr.status === 'Approved' && todayStr >= lr.leaveDate && todayStr < lr.returnDate);
                            if (!approvedLeaveToday) {
                                const pendingLeaveToday = (allData.leaveRequests || []).find(lr => lr.staffId === userProfile.id && lr.status === 'Pending' && lr.leaveDate === todayStr);
                                if (pendingLeaveToday) { setAlertModal({ isOpen: true, message: 'Your leave request for today is pending. A late deduction has been applied.' }); }
                                const formattedTime = checkInTimestamp.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: true });
                                await addDoc(collection(db, 'employeeStates'), { staffId: userProfile.id, staffName: userProfile.name, shop: selectedShopForCheckIn, date: todayStr, statusState: 'Deduction', amount: 5000, note: `Late @${formattedTime}` });
                            }
                        }
                    }
                    // REVISED: Show a success alert modal instead of just updating the status text.
                    setAlertModal({ isOpen: true, message: `Successfully checked ${nextActionType} at ${checkInTimestamp.toLocaleTimeString()}.` });
                    setStatus(`Last action: Checked ${nextActionType}.`); // Keep a simple status for the main display
                } catch (error) {
                    // Error is already set by getLocation, but we can add a fallback.
                    if (!status.includes('permission') && !status.includes('Could not get')) {
                        setStatus("Failed to record attendance.");
                    }
                    console.error("Error during check action:", error);
                } finally {
                    setLoading(false);
                }
            }, [db, lastAction, userProfile, selectedShopForCheckIn, allData.leaveRequests, getLocation]);

            const canCheck = distance !== null && userShop && distance <= (parseFloat(userShop.radius) || 500);

            // Use the new centralized hook with the selected month
            const { inputs, calculations } = usePayrollCalculator(userProfile, selectedMonth, allData);

            return (
                <Card className="max-w-2xl mx-auto"><div className="flex flex-col items-center justify-center p-4 sm:p-8 space-y-8">
                    <div className="text-center">
                        <p className="text-4xl sm:text-7xl font-bold text-slate-100 tracking-wider">{currentTime.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: true })}</p>
                        <p className="text-xl text-slate-400 mt-2">{currentTime.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}</p>
                    </div>
                    {isMultiShopManager && (
                        <div className="w-full max-w-md">
                            <label className="text-sm font-medium text-slate-400">Select Shop for Check-in</label>
                            <select value={selectedShopForCheckIn} onChange={e => setSelectedShopForCheckIn(e.target.value)} className="select">
                                <option value="">-- Select Your Shop --</option>
                                {userProfile.shop.map(shopName => <option key={shopName} value={shopName}>{shopName}</option>)}
                            </select>
                        </div>
                    )}
                    <div className="flex gap-4">
                        <button onClick={handleCheckAction} disabled={lastAction?.type === 'in' || loading} className={`px-8 py-3 text-lg font-semibold rounded-lg shadow-md transition-colors transform hover:scale-105 ${lastAction?.type === 'in' || loading ? 'bg-slate-700 text-slate-500 cursor-not-allowed' : 'bg-green-600 text-white hover:bg-green-700'}`}>{loading && lastAction?.type !== 'in' ? <i className="fas fa-spinner fa-spin"></i> : 'Check In'}</button>
                        <button onClick={handleCheckAction} disabled={lastAction?.type !== 'in' || loading} className={`px-8 py-3 text-lg font-semibold rounded-lg shadow-md transition-colors transform hover:scale-105 ${lastAction?.type !== 'in' || loading ? 'bg-slate-700 text-slate-500 cursor-not-allowed' : 'bg-slate-600 text-white hover:bg-slate-500'}`}>{loading && lastAction?.type === 'in' ? <i className="fas fa-spinner fa-spin"></i> : 'Check Out'}</button>
                    </div>
                    <div className="w-full max-w-md">
                        <Button onClick={() => getLocation(false)} disabled={loading || !userShop} variant="secondary" className="w-full">
                            {loading ? 'Refreshing...' : 'Refresh Location'}
                        </Button>
                    </div>
                    <div className={`p-4 rounded-lg text-center w-full max-w-md ${canCheck ? 'bg-green-900/50 border-green-700' : 'bg-red-900/50 border-red-700'} border`}>
                        <p className="font-medium text-lg text-slate-100">{status}</p>
                        {accuracy && <p className="text-xs text-slate-400 mt-1">Accuracy: {Math.round(accuracy)}m</p>}
                    </div>
                    <div className="text-center text-sm text-slate-400"><p>Welcome, <span className="font-bold text-slate-200">{userProfile?.name}</span></p><p>Your selected shop is <span className="font-bold text-slate-200">{selectedShopForCheckIn || 'N/A'}</span></p>{lastAction && (<p className="mt-2">Last action: Checked <span className="font-semibold text-slate-200">{lastAction.type}</span> at <span className="font-semibold text-slate-200">{lastAction.timestamp?.toDate().toLocaleTimeString()}</span></p>)}</div>
                    {/* New Salary Preview Section */}
                    <div className="w-full max-w-md mt-8 p-4 bg-slate-700/50 border border-slate-600 rounded-lg">
                        <div className="flex justify-between items-center mb-4">
                             <h4 className="text-lg font-semibold text-slate-100">ប្រាក់ខែរកបាន</h4>
                             <input type="month" value={selectedMonth} onChange={e => setSelectedMonth(e.target.value)} className="input !mt-0 w-auto" />
                        </div>
                        <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            {/* Earnings Column */}
                            <div className="space-y-2">
                                <h5 className="font-semibold text-slate-200 border-b border-slate-600 pb-1 mb-2">ប្រាក់ចំណូល :</h5>
                                <div className="flex justify-between items-center text-sm"><span className="text-slate-400">ថ្ងៃធ្វើការ :</span><span className="font-semibold text-slate-200">{inputs.workDays || 0}</span></div>
                                <div className="flex justify-between items-center text-sm"><span className="text-slate-400">ផ្តល់ជូន :</span><span className="font-semibold text-slate-200">{inputs.givenOffDays || 0}</span></div>
                                <div className="flex justify-between items-center text-sm"><span className="text-slate-400">ថែមម៉ោង :</span><span className="font-semibold text-slate-200">{inputs.otDays || 0}</span></div>
                                <div className="flex justify-between items-center text-sm"><span className="text-slate-400">ប្រាក់បន្ថែម :</span><span className="font-semibold text-slate-200">{Utils.formatCurrency(calculations.engagements)}</span></div>
                                <div className="pt-2 border-t border-slate-600 flex justify-between items-center text-sm"><span className="font-bold text-green-400">ប្រាក់ចំណូលសរុប :</span><span className="font-bold text-green-400">{Utils.formatCurrency(calculations.grossSalary)}</span></div>
                            </div>
                            {/* Deductions Column */}
                            <div className="space-y-2">
                                <h5 className="font-semibold text-slate-200 border-b border-slate-600 pb-1 mb-2">ការកាត់ប្រាក់ :</h5>
                                <div className="flex justify-between items-center text-sm"><span className="text-slate-400">ថ្ងៃឈប់សម្រាក :</span><span className="font-semibold text-slate-200">{inputs.leaveDays || 0}</span></div>
                                <div className="flex justify-between items-center text-sm"><span className="text-slate-400">មកយឺតសរុប :</span><span className="font-semibold text-slate-200">{inputs.totalLateDays || 0}</span></div>
                                <div className="flex justify-between items-center text-sm" title="អវត្តមាន + ភ្លេចចុចចេញ"><span className="text-slate-400">អវត្តមាន :</span><span className="font-semibold text-slate-200">{inputs.noAttendance || 0}</span></div>
                                <div className="flex justify-between items-center text-sm"><span className="text-slate-400">បំណុលរំលួស :</span><span className="font-semibold text-slate-200">{Utils.formatCurrency(inputs.loanDeduction)}</span></div>
                                <div className="flex justify-between items-center text-sm"><span className="text-slate-400">ការកាត់ផ្សេងៗ :</span><span className="font-semibold text-slate-200">{Utils.formatCurrency(calculations.otherDeductions)}</span></div>
                                <div className="pt-2 border-t border-slate-600 flex justify-between items-center text-sm"><span className="font-bold text-red-400">ការកាត់ប្រាក់សរុប :</span><span className="font-bold text-red-400">{Utils.formatCurrency(calculations.totalDeductions)}</span></div>
                            </div>
                        </div>
                        <div className="mt-4 pt-4 border-t border-slate-600 flex justify-between items-center">
                            <span className="font-bold text-slate-200">ប្រាក់ខែសុទ្ធរហូតមកដល់ពេលនេះ :</span>
                            <span className="text-xl font-bold text-blue-400">{Utils.formatCurrency(calculations.netSalary)}</span>
                        </div>
                    </div>
                </div>
                {/* Alert Modal for Pending Leave */}
                <Modal isOpen={alertModal.isOpen} onClose={() => setAlertModal({ isOpen: false, message: '' })} maxWidth="max-w-sm">
                    <ModalHeader title="Notification" onClose={() => setAlertModal({ isOpen: false, message: '' })} />
                    <ModalBody><p className="text-slate-300">{alertModal.message}</p></ModalBody>
                    <ModalFooter><Button variant="primary" onClick={() => setAlertModal({ isOpen: false, message: '' })}>OK</Button></ModalFooter>
                </Modal>
                </Card>
            );
        };
        
        // Component: Leave Request Modal
        const LeaveRequestModal = ({ isOpen, onClose, onSave, request, userProfile, shops }) => {
            const [formData, setFormData] = useState({});
            
            const canSelectShop = useMemo(() => userProfile?.role === 'Admin' || Array.isArray(userProfile?.shop), [userProfile]);
            
            useEffect(() => {
                const initialData = request 
                    ? { ...request } 
                    : (userProfile 
                        ? { 
                            leaveDate: new Date().toISOString().substring(0, 10), 
                            returnDate: new Date().toISOString().substring(0, 10),
                            shop: canSelectShop ? '' : (userProfile.shop || ''), 
                            staffId: userProfile.id || '', 
                            staffName: userProfile.name || '',
                            supervisor: userProfile.supervisor || '', 
                            numberOfDays: 1, 
                            leaveSession: 'Full Day',
                            leaveType: 'Annual Leave',
                            reason: '' 
                          } 
                        : {});
                setFormData(initialData);
            }, [request, userProfile, isOpen, canSelectShop]);

            const dateDiffInDays = useMemo(() => {
                if (formData.leaveDate && formData.returnDate) {
                    const start = new Date(formData.leaveDate);
                    const end = new Date(formData.returnDate);
                    if (end <= start) return 0;
                    const diffTime = end.getTime() - start.getTime();
                    return Math.round(diffTime / (1000 * 60 * 60 * 24));
                }
                return 0;
            }, [formData.leaveDate, formData.returnDate]);

            const isMultiDayLeave = dateDiffInDays > 1;

            const handleChange = useCallback((e) => {
                const { name, value } = e.target;
                const newFormData = { ...formData, [name]: value };

                // Recalculate days based on dates and session.
                const { leaveDate, returnDate, leaveSession } = newFormData;

                if (leaveDate && returnDate) {
                    const start = new Date(leaveDate);
                    const end = new Date(returnDate);
                    start.setHours(0, 0, 0, 0); // Normalize to avoid timezone issues
                    end.setHours(0, 0, 0, 0);

                    if (end < start) {
                        newFormData.numberOfDays = 0;
                    } else {
                        const diffTime = end.getTime() - start.getTime();
                        const diffDays = Math.round(diffTime / (1000 * 60 * 60 * 24));

                        // Case: User selects same leave and return date. We interpret this as a single-day event.
                        if (diffDays === 0) {
                            if (leaveSession === 'Full Day') { newFormData.numberOfDays = 1; } 
                            else { newFormData.numberOfDays = 0.5; }
                        } 
                        // Case: Standard single day leave (e.g., leave Mon, return Tue)
                        else if (diffDays === 1) {
                            if (leaveSession === 'Full Day') { newFormData.numberOfDays = 1; } 
                            else { newFormData.numberOfDays = 0.5; }
                        } 
                        // Case: Multi-day leave
                        else {
                            newFormData.numberOfDays = diffDays;
                            newFormData.leaveSession = 'Full Day'; // Force full day for multi-day leaves
                        }
                    }
                } else {
                    newFormData.numberOfDays = 0;
                }
                
                setFormData(newFormData);
            }, [formData]);
            
            const handleSubmit = useCallback((e) => { 
                e.preventDefault(); 
                if (canSelectShop && !formData.shop) {
                    alert("Please select a shop for the leave request.");
                    return;
                }
                const dataToSave = { ...formData };
                // If leave date and return date are the same, it implies a single day of leave.
                // The attendance report logic requires returnDate to be the day *after* the leave ends.
                // So, we adjust the returnDate before saving to ensure report accuracy.
                if (dataToSave.leaveDate && dataToSave.leaveDate === dataToSave.returnDate) {
                    const returnDate = new Date(dataToSave.returnDate);
                    returnDate.setDate(returnDate.getDate() + 1);
                    dataToSave.returnDate = returnDate.toISOString().substring(0, 10);
                }
                onSave(dataToSave); 
            }, [onSave, formData, canSelectShop]);
            
            return (
                <Modal isOpen={isOpen} onClose={onClose} maxWidth="max-w-4xl">
                    <form onSubmit={handleSubmit}>
                        <ModalHeader title={request ? "Edit Leave Request" : "New Leave Request"} onClose={onClose} />
                        <ModalBody>
                            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                <div><label className="text-sm">Leave Date</label><input type="date" name="leaveDate" value={formData.leaveDate || ''} onChange={handleChange} className="input" required /></div>
                                <div><label className="text-sm">Return Date</label><input type="date" name="returnDate" value={formData.returnDate || ''} onChange={handleChange} className="input" required /></div>
                                
                                <div>
                                    <label className="text-sm">Session</label>
                                    <select name="leaveSession" value={formData.leaveSession || 'Full Day'} onChange={handleChange} className="select" disabled={isMultiDayLeave}>
                                        <option value="Full Day">Full Day</option>
                                        <option value="AM">AM (Morning)</option>
                                        <option value="PM">PM (Afternoon)</option>
                                    </select>
                                </div>
                                <div>
                                    <label className="text-sm">No. Day(s)</label>
                                    <input 
                                        type="number"
                                        name="numberOfDays" 
                                        value={formData.numberOfDays || ''} 
                                        className="input" required 
                                        disabled
                                    />
                                </div>
                                
                                {canSelectShop ? (
                                    <div>
                                        <label className="text-sm">Shop Name</label>
                                        <select name="shop" value={formData.shop || ''} onChange={handleChange} className="select" required>
                                            <option value="">Select Shop</option>
                                            {
                                                userProfile.role === 'Admin' 
                                                ? shops.map(shop => <option key={shop.id} value={shop.name}>{shop.name}</option>)
                                                : (Array.isArray(userProfile.shop) ? userProfile.shop : []).map(shopName => <option key={shopName} value={shopName}>{shopName}</option>)
                                            }
                                        </select>
                                    </div>
                                ) : (
                                    <div><label className="text-sm">Shop Name</label><input value={formData.shop || ''} className="input" disabled /></div>
                                )}
                                <div><label className="text-sm">Staff Name</label><input value={formData.staffName || ''} className="input" disabled /></div>
                                <div><label className="text-sm">Supervisor</label><input value={formData.supervisor || ''} className="input" disabled /></div>

                                <div className="lg:col-span-3"><label className="text-sm">Leave Type</label>
                                    <select name="leaveType" value={formData.leaveType || 'Annual Leave'} onChange={handleChange} className="select" required>
                                        <option>Relaxing Leave</option>
                                        <option>Sick Leave</option>
                                        <option>Emergency Leave</option>
                
                                    </select>
                                </div>
                                <div className="lg:col-span-3"><label className="text-sm">Reason</label><textarea name="reason" value={formData.reason || ''} onChange={handleChange} className="input" rows="3" required></textarea></div>
                            </div>
                        </ModalBody>
                        <ModalFooter>
                            <Button type="button" variant="secondary" onClick={onClose}>Cancel</Button>
                            <Button type="submit" variant="primary" className="px-6">Submit Request</Button>
                        </ModalFooter>
                    </form>
                </Modal>
            );
        };

        // Component: OT Request Modal
        const OTRequestModal = ({ isOpen, onClose, onSave, request, userProfile, shops }) => {
            const [formData, setFormData] = useState({});
            
            const canSelectShop = useMemo(() => userProfile?.role === 'Admin' || Array.isArray(userProfile?.shop), [userProfile]);

            // Initialize form data
            useEffect(() => {
                const initialData = request 
                    ? { ...request } 
                    : (userProfile 
                        ? { 
                            reqDate: new Date().toISOString().substring(0, 10), 
                            shop: canSelectShop ? '' : (userProfile.shop || ''), 
                            staffId: userProfile.id || '', 
                            staffName: userProfile.name || '',
                            supervisor: userProfile.supervisor || '', 
                            startTime: '', 
                            endTime: '', 
                            numberOfOTDays: 0, 
                            reason: '' 
                          } 
                        : {});
                setFormData(initialData);
            }, [request, userProfile, isOpen, canSelectShop]);

            // Calculate OT days from start and end times
            useEffect(() => {
                if (formData.startTime && formData.endTime) {
                    const [startHour, startMinute] = formData.startTime.split(':').map(Number);
                    const [endHour, endMinute] = formData.endTime.split(':').map(Number);

                    if (!isNaN(startHour) && !isNaN(startMinute) && !isNaN(endHour) && !isNaN(endMinute)) {
                        const startDate = new Date(0, 0, 0, startHour, startMinute, 0);
                        let endDate = new Date(0, 0, 0, endHour, endMinute, 0);

                        // Handle overnight OT
                        if (endDate < startDate) {
                            endDate.setDate(endDate.getDate() + 1);
                        }

                        const diffMillis = endDate - startDate;
                        const diffHours = diffMillis / (1000 * 60 * 60);
                        
                        // REVISED LOGIC: Per user request, specific durations are handled differently.
                        // 4 hours (e.g. 5pm-9pm) and 5 hours (e.g. 7:30am-12:30pm) both count as 0.5 days.
                        // Durations between 4 and 5 hours are treated as a half day.
                        // Other durations are calculated against a standard 8-hour OT day.
                        let otDays = 0;
                        const OT_HOURS_PER_DAY = 8;

                        if (diffHours >= 4 && diffHours <= 5) {
                            otDays = 0.5;
                        } else {
                            otDays = diffHours / OT_HOURS_PER_DAY;
                        }
                        
                        setFormData(prev => ({ ...prev, numberOfOTDays: otDays > 0 ? otDays.toFixed(2) : 0 }));
                    }
                }
            }, [formData.startTime, formData.endTime]);

            const handleChange = useCallback((e) => { 
                setFormData(prev => ({ ...prev, [e.target.name]: e.target.value })); 
            }, []);
            
            const handleSubmit = useCallback((e) => { 
                e.preventDefault(); 
                if (canSelectShop && !formData.shop) {
                    alert("Please select a shop for the OT request.");
                    return;
                }
                onSave(formData); 
            }, [onSave, formData, canSelectShop]);
            
            return (
                <Modal isOpen={isOpen} onClose={onClose} maxWidth="max-w-4xl">
                    <form onSubmit={handleSubmit}>
                        <ModalHeader title={request ? "Edit OT Request" : "New OT Request"} onClose={onClose} />
                        <ModalBody>
                            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                <div><label className="text-sm">OT Date</label><input type="date" name="reqDate" value={formData.reqDate || ''} onChange={handleChange} className="input" required /></div>
                                <div><label className="text-sm">Start Hour</label><input type="time" name="startTime" value={formData.startTime || ''} onChange={handleChange} className="input" required /></div>
                                <div><label className="text-sm">End Hour</label><input type="time" name="endTime" value={formData.endTime || ''} onChange={handleChange} className="input" required /></div>
                                
                                {canSelectShop ? (
                                    <div>
                                        <label className="text-sm">Shop Name</label>
                                        <select name="shop" value={formData.shop || ''} onChange={handleChange} className="select" required>
                                            <option value="">Select Shop</option>
                                            {
                                                userProfile.role === 'Admin' 
                                                ? shops.map(shop => <option key={shop.id} value={shop.name}>{shop.name}</option>)
                                                : (Array.isArray(userProfile.shop) ? userProfile.shop : []).map(shopName => <option key={shopName} value={shopName}>{shopName}</option>)
                                            }
                                        </select>
                                    </div>
                                ) : (
                                    <div><label className="text-sm">Shop Name</label><input value={formData.shop || ''} className="input" disabled /></div>
                                )}
                                
                                <div><label className="text-sm">Staff Name</label><input value={formData.staffName || ''} className="input" disabled /></div>
                                <div><label className="text-sm">Supervisor</label><input value={formData.supervisor || ''} className="input" disabled /></div>
                                
                                <div className="lg:col-span-3"><label className="text-sm">No. OT Day(s)</label><input type="number" name="numberOfOTDays" value={formData.numberOfOTDays || ''} className="input" disabled /></div>
                                <div className="lg:col-span-3"><label className="text-sm">Reason</label><textarea name="reason" value={formData.reason || ''} onChange={handleChange} className="input" rows="3" required></textarea></div>
                            </div>
                        </ModalBody>
                        <ModalFooter>
                            <Button type="button" variant="secondary" onClick={onClose}>Cancel</Button>
                            <Button type="submit" variant="primary" className="px-6">Submit Request</Button>
                        </ModalFooter>
                    </form>
                </Modal>
            );
        };
        
        // Component: A single card for displaying a request in the mobile view
        const RequestCard = memo(({ request, userProfile, config, onUpdateStatus, onEdit, onDelete }) => {
            const { cardFields } = config;

            return (
                <div className="bg-slate-700/50 rounded-lg p-4 space-y-3 flex flex-col">
                    <div className="flex justify-between items-start">
                        <div>
                            <p className="font-bold text-lg text-slate-100">{request.staffName}</p>
                            <p className="text-sm text-slate-300">{request.shop}</p>
                        </div>
                        <span className="px-2 py-1 text-xs font-semibold rounded-full bg-yellow-200 text-yellow-900">{request.status}</span>
                    </div>
                    <div className="grid grid-cols-2 gap-x-4 gap-y-2 text-sm pt-2 border-t border-slate-600 flex-grow">
                        {cardFields.map(field => (
                            <div key={field.label}>
                                <p className="text-slate-400">{field.label}</p>
                                <p className="text-slate-200 font-medium">{field.value(request)}</p>
                            </div>
                        ))}
                        <div className="col-span-2">
                            <p className="text-slate-400">Reason</p>
                            <p className="text-slate-200 font-medium whitespace-pre-wrap">{request.reason}</p>
                        </div>
                    </div>
                    <div className="flex justify-end space-x-3 pt-2">
                        {(userProfile?.role === 'Admin' || (userProfile?.role === 'Shop Manager' && userProfile.id !== request.staffId)) && request.status === 'Pending' && (
                            <>
                                <Button variant="icon-approve" icon="fa-check-circle" onClick={() => onUpdateStatus(request.id, 'Approved')} title="Approve" className="text-xl" />
                                <Button variant="icon-reject" icon="fa-times-circle" onClick={() => onUpdateStatus(request.id, 'Rejected')} title="Reject" className="text-xl" />
                            </>
                        )}
                        <Button variant="icon-edit-alt" icon="fa-edit" onClick={() => onEdit(request)} title="Edit" className="text-xl" />
                        <Button variant="icon-delete" icon="fa-trash" onClick={() => onDelete(request.id)} title="Delete" className="text-xl" />
                    </div>
                </div>
            );
        });

        // Component: Generic Tab for managing requests (Leave, OT, etc.)
        const RequestManagementTab = ({ userProfile, config }) => {
            const { collectionName, title, ModalComponent, dateField, submissionDateField, tableColumns } = config;
            const { db } = useFirebase();
            const [isModalOpen, setModalOpen] = useState(false);
            const [editingRequest, setEditingRequest] = useState(null);
            const [requestToDelete, setRequestToDelete] = useState(null);
            const [reasonToView, setReasonToView] = useState(null);
            const { where } = window.firebaseSDK;
            const { data: shops } = useCollection('shops');
            const { data: employees } = useCollection('employees');
            const [selectedShop, setSelectedShop] = useState('');
            const [filterPeriod, setFilterPeriod] = useState('thisMonth');
            const [customDate, setCustomDate] = useState(new Date().toISOString().slice(0, 10));
            const [selectedEmployeeId, setSelectedEmployeeId] = useState('');

            // Set initial shop filter based on user role
            useEffect(() => {
                if (userProfile && userProfile.role !== 'Admin') {
                    setSelectedShop(Array.isArray(userProfile.shop) ? '' : userProfile.shop || '');
                }
            }, [userProfile]);

            // Define query constraints to fetch requests based on user role
            const queryConstraints = useMemo(() => {
                if (!userProfile) return [where("staffId", "==", "null")];
                if (userProfile.role === 'Admin') return [];
                if (userProfile.role === 'Shop Manager') {
                    const shops = Array.isArray(userProfile.shop) ? userProfile.shop : (userProfile.shop ? [userProfile.shop] : []);
                    if (shops.length > 0) return [where("shop", "in", shops)];
                    return [where("staffId", "==", "null")];
                }
                return [where("staffId", "==", userProfile.id)];
            }, [userProfile]);

            const { data: requests } = useCollection(collectionName, queryConstraints);

            // Get employees for the filter dropdown based on selected shop
            const employeesInShop = useMemo(() => {
                if (!selectedShop) return [];
                return employees.filter(emp => {
                    const employeeShops = Array.isArray(emp.shop) ? emp.shop : [emp.shop];
                    return employeeShops.includes(selectedShop) && emp.status === 'Active';
                });
            }, [selectedShop, employees]);

            // Filter and sort requests for display
            const { pendingRequests, historyRequests } = useMemo(() => {
                const filtered = requests.filter(req => {
                    if (!req[dateField]) return false;
                    const now = new Date();
                    let dateMatch = false;
                    switch (filterPeriod) {
                        case 'thisWeek':
                            const startOfWeek = new Date(now);
                            startOfWeek.setDate(now.getDate() - now.getDay());
                            startOfWeek.setHours(0, 0, 0, 0);
                            const endOfWeek = new Date(startOfWeek);
                            endOfWeek.setDate(startOfWeek.getDate() + 6);
                            endOfWeek.setHours(23, 59, 59, 999);
                            const reqDate = new Date(req[dateField]);
                            dateMatch = reqDate >= startOfWeek && reqDate <= endOfWeek;
                            break;
                        case 'thisMonth': dateMatch = req[dateField].startsWith(new Date().toISOString().slice(0, 7)); break;
                        case 'lastMonth': const lastMonthDate = new Date(); lastMonthDate.setMonth(lastMonthDate.getMonth() - 1); dateMatch = req[dateField].startsWith(lastMonthDate.toISOString().slice(0, 7)); break;
                        case 'thisYear': dateMatch = req[dateField].startsWith(new Date().getFullYear().toString()); break;
                        case 'custom': dateMatch = req[dateField] === customDate; break;
                        default: dateMatch = true;
                    }
                    return dateMatch && (!selectedShop || req.shop === selectedShop) && (!selectedEmployeeId || req.staffId === selectedEmployeeId);
                });

                const pending = filtered.filter(req => req.status === 'Pending').sort((a, b) => (b[submissionDateField]?.toDate() || 0) - (a[submissionDateField]?.toDate() || 0));
                const history = filtered.filter(req => req.status !== 'Pending').sort((a, b) => (b[submissionDateField]?.toDate() || 0) - (a[submissionDateField]?.toDate() || 0));
                
                return { pendingRequests: pending, historyRequests: history };
            }, [requests, selectedShop, selectedEmployeeId, filterPeriod, customDate, dateField, submissionDateField]);

            const handleOpenModal = useCallback((request = null) => { setEditingRequest(request); setModalOpen(true); }, []);
            const handleCloseModal = useCallback(() => { setEditingRequest(null); setModalOpen(false); }, []);
            
            const handleSaveRequest = useCallback(async (formData) => {
                const { doc, addDoc, updateDoc, collection, serverTimestamp } = window.firebaseSDK;
                const staffName = employees.find(e => e.id === formData.staffId)?.name || '';
                try {
                    if (formData.id) { 
                        const { id, ...dataToUpdate } = formData; 
                        await updateDoc(doc(db, collectionName, id), { ...dataToUpdate, staffName }); 
                    } else { 
                        const dataToAdd = { ...formData, staffName, status: 'Pending' };
                        dataToAdd[submissionDateField] = serverTimestamp();
                        await addDoc(collection(db, collectionName), dataToAdd); 
                    }
                    handleCloseModal();
                } catch (error) { console.error(`Error saving ${title}:`, error); }
            }, [db, employees, handleCloseModal, collectionName, title, submissionDateField]);

            const handleUpdateRequestStatus = useCallback(async (id, status) => {
                const { doc, updateDoc } = window.firebaseSDK;
                const dataToUpdate = { status };
                if (status === 'Approved') {
                    const now = new Date();
                    const formattedTimestamp = `${String(now.getDate()).padStart(2, '0')}/${String(now.getMonth() + 1).padStart(2, '0')} | ${now.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: true })}`;
                    dataToUpdate.approvalTimestamp = formattedTimestamp;
                }
                try { await updateDoc(doc(db, collectionName, id), dataToUpdate); } 
                catch (error) { console.error(`Error updating status for ${title} ${id}:`, error); }
            }, [db, collectionName, title]);

            const confirmDelete = useCallback(async () => {
                if (!requestToDelete) return;
                try { await window.firebaseSDK.deleteDoc(window.firebaseSDK.doc(db, collectionName, requestToDelete)); } 
                catch (error) { console.error(`Error deleting ${title} ${requestToDelete}:`, error); } 
                finally { setRequestToDelete(null); }
            }, [db, requestToDelete, collectionName, title]);

            return (
                <Card>
                    <div className="flex flex-wrap gap-4 justify-between items-center mb-6">
                        <h3 className="text-xl font-semibold text-slate-100">{title}s</h3>
                        <div className="flex flex-wrap gap-4 items-center">
                            {(userProfile.role === 'Admin' || (userProfile.role === 'Shop Manager' && Array.isArray(userProfile.shop))) && (
                                <select value={selectedShop} onChange={e => { setSelectedShop(e.target.value); setSelectedEmployeeId(''); }} className="select w-full sm:w-auto">
                                    <option value="">{userProfile.role === 'Admin' ? 'All Shops' : 'All My Shops'}</option>
                                    {(userProfile.role === 'Admin' ? shops : (userProfile.shop || []).map(name => ({ id: name, name: name }))).map(s => <option key={s.id} value={s.name}>{s.name}</option>)}
                                </select>
                            )}
                            {(userProfile.role === 'Admin' || userProfile.role === 'Shop Manager') && selectedShop && (
                                <select value={selectedEmployeeId} onChange={e => setSelectedEmployeeId(e.target.value)} className="select w-full sm:w-auto">
                                    <option value="">All Staff</option>
                                    {employeesInShop.map(e => <option key={e.id} value={e.id}>{e.name}</option>)}
                                </select>
                            )}
                            {(userProfile.role === 'Admin' || userProfile.role === 'Shop Manager') && (
                                <select value={filterPeriod} onChange={e => setFilterPeriod(e.target.value)} className="select w-full sm:w-auto">
                                    <option value="thisWeek">This Week</option><option value="thisMonth">This Month</option>
                                    <option value="lastMonth">Last Month</option><option value="thisYear">This Year</option>
                                    <option value="custom">Custom Date</option>
                                </select>
                            )}
                            {filterPeriod === 'custom' && (<input type="date" value={customDate} onChange={e => setCustomDate(e.target.value)} className="input w-full sm:w-auto" />)}
                            <Button variant="primary" icon="fa-plus" onClick={() => handleOpenModal()}>New Request</Button>
                        </div>
                    </div>
                    {pendingRequests.length > 0 && (
                        <div className="mb-8">
                            <h4 className="text-lg font-semibold text-slate-200 mb-4">Pending Requests</h4>
                            <div className="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-4">
                                {pendingRequests.map(req => (
                                    <RequestCard 
                                        key={req.id}
                                        request={req}
                                        userProfile={userProfile}
                                        config={config}
                                        onUpdateStatus={handleUpdateRequestStatus}
                                        onEdit={handleOpenModal}
                                        onDelete={setRequestToDelete}
                                    />
                                ))}
                            </div>
                        </div>
                    )}
                    <div>
                        <h4 className="text-lg font-semibold text-slate-200 mb-4">{title} History</h4>
                        <div className="overflow-x-auto">
                            <table className="min-w-full divide-y divide-slate-700">
                                <thead className="bg-slate-900/50">
                                    <tr>
                                        {tableColumns.map(col => <th key={col.header} className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">{col.header}</th>)}
                                        <th className="px-4 py-3 text-center text-xs font-semibold text-slate-400 uppercase">Reason</th>
                                        <th className="px-4 py-3 text-center text-xs font-semibold text-slate-400 uppercase">Status</th>
                                        <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Approval Time</th>
                                        <th className="px-4 py-3 text-center text-xs font-semibold text-slate-400 uppercase">Actions</th>
                                    </tr>
                                </thead>
                                <tbody className="divide-y divide-slate-700">
                                    {historyRequests.map(req => (
                                        <tr key={req.id} className="hover:bg-slate-700/50">
                                            {tableColumns.map(col => <td key={col.header} className="px-4 py-4 text-sm text-slate-300">{typeof col.accessor === 'function' ? col.accessor(req) : req[col.accessor]}</td>)}
                                            <td className="px-4 py-4 text-center text-sm"><Button variant="icon-view" icon="fa-eye" onClick={() => setReasonToView(req.reason)} /></td>
                                            <td className="px-4 py-4 text-center text-sm"><span className={`px-2 py-1 text-xs font-semibold rounded-full ${req.status === 'Approved' ? 'bg-green-200 text-green-900' : 'bg-red-200 text-red-900'}`}>{req.status}</span></td>
                                            <td className="px-4 py-4 text-sm text-slate-300">{req.status === 'Approved' ? req.approvalTimestamp || '' : ''}</td>
                                            <td className="px-4 py-4 text-center whitespace-nowrap">
                                                <div className="flex items-center justify-center gap-4">
                                                    <Button variant="icon-edit-alt" icon="fa-edit" onClick={() => handleOpenModal(req)} title="Edit" />
                                                    <Button variant="icon-delete" icon="fa-trash" onClick={() => setRequestToDelete(req.id)} title="Delete" />
                                                </div>
                                            </td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <ModalComponent isOpen={isModalOpen} onClose={handleCloseModal} onSave={handleSaveRequest} request={editingRequest} userProfile={userProfile} shops={shops} />
                    <ConfirmationModal isOpen={!!requestToDelete} onClose={() => setRequestToDelete(null)} onConfirm={confirmDelete} title={`Delete ${title}`} message={`Are you sure you want to permanently delete this ${title.toLowerCase()}?`} />
                    <Modal isOpen={!!reasonToView} onClose={() => setReasonToView(null)} maxWidth="max-w-md">
                        <ModalHeader title={`${title} Reason`} onClose={() => setReasonToView(null)} />
                        <ModalBody><p className="text-slate-300">{reasonToView}</p></ModalBody>
                        <ModalFooter><Button variant="secondary" onClick={() => setReasonToView(null)}>Close</Button></ModalFooter>
                    </Modal>
                </Card>
            );
        };
        
        // Component: Main CheckInMe Page (Tab Container)
        const CheckInMePage = ({ userProfile, initialTab = 'checkInOut' }) => {
            const [activeTab, setActiveTab] = useState(initialTab);

            useEffect(() => {
                setActiveTab(initialTab);
            }, [initialTab]);
            
            // Define configurations for our generic request management tab
            const leaveRequestConfig = {
                collectionName: 'leaveRequests',
                title: 'Leave Request',
                ModalComponent: LeaveRequestModal,
                dateField: 'leaveDate',
                submissionDateField: 'requestDate',
                cardFields: [
                    { label: 'Leave Date', value: (req) => Utils.formatISOToDisplay(req.leaveDate) },
                    { label: 'Return Date', value: (req) => Utils.formatISOToDisplay(req.returnDate) },
                    { label: 'Days', value: (req) => req.numberOfDays },
                    { label: 'Session', value: (req) => req.leaveSession || '-' },
                    { label: 'Supervisor', value: (req) => req.supervisor },
                    { label: 'Submitted', value: (req) => Utils.formatRequestDate(req.requestDate) },
                    { label: 'Type', value: (req) => req.leaveType },
                ],
                tableColumns: [
                    { header: 'Request Date', accessor: (req) => Utils.formatRequestDate(req.requestDate) },
                    { header: 'Shop', accessor: 'shop' },
                    { header: 'Name', accessor: 'staffName' },
                    { header: 'Leave Date', accessor: (req) => Utils.formatISOToDisplay(req.leaveDate) },
                    { header: 'Return Date', accessor: (req) => Utils.formatISOToDisplay(req.returnDate) },
                    { header: 'No. Days', accessor: 'numberOfDays' },
                    { header: 'Session', accessor: 'leaveSession' },
                    { header: 'Leave Type', accessor: 'leaveType' },
                    { header: 'Supervisor', accessor: 'supervisor' },
                ]
            };
            
            const otRequestConfig = {
                collectionName: 'otRequests',
                title: 'OT Request',
                ModalComponent: OTRequestModal,
                dateField: 'reqDate',
                submissionDateField: 'submissionDate',
                cardFields: [
                    { label: 'OT Date', value: (req) => Utils.formatISOToDisplay(req.reqDate) },
                    { label: 'Days', value: (req) => req.numberOfOTDays },
                    { label: 'Start Time', value: (req) => req.startTime || 'N/A' },
                    { label: 'End Time', value: (req) => req.endTime || 'N/A' },
                    { label: 'Supervisor', value: (req) => req.supervisor },
                    { label: 'Submitted', value: (req) => Utils.formatRequestDate(req.submissionDate) },
                ],
                tableColumns: [
                    { header: 'Request Date', accessor: (req) => Utils.formatRequestDate(req.submissionDate) },
                    { header: 'Shop', accessor: 'shop' },
                    { header: 'Name', accessor: 'staffName' },
                    { header: 'OT Date', accessor: (req) => Utils.formatISOToDisplay(req.reqDate) },
                    { header: 'Start Time', accessor: 'startTime' },
                    { header: 'End Time', accessor: 'endTime' },
                    { header: 'No. OT Days', accessor: 'numberOfOTDays' },
                    { header: 'Supervisor', accessor: 'supervisor' },
                ]
            };

            return (
                <TabbedPage tabs={{ checkInOut: 'Check In/Out', leaveRequest: 'Leave Request', otRequest: 'OT Request', employeeState: 'Engagements / Deductions' }} activeTab={activeTab} setActiveTab={setActiveTab}>
                    <div id="checkInOut"><CheckInOutTab userProfile={userProfile} /></div>
                    <div id="leaveRequest"><RequestManagementTab userProfile={userProfile} config={leaveRequestConfig} /></div>
                    <div id="otRequest"><RequestManagementTab userProfile={userProfile} config={otRequestConfig} /></div>
                    <div id="employeeState"><EmployeeStateTab userProfile={userProfile} /></div>
                </TabbedPage>
            );
        };
        // --- END CHECKINME PAGE COMPONENTS ---

        // --- START ATTENDANCE REPORT PAGE ---
        const AttendanceReportPage = ({ userProfile }) => {
            const [activeTab, setActiveTab] = useState('daily');
            const { data: leaveRequests } = useCollection('leaveRequests');
            const { data: otRequests } = useCollection('otRequests');
            return (
                <TabbedPage tabs={{ daily: 'Daily Report', monthly: 'No. Work Day' }} activeTab={activeTab} setActiveTab={setActiveTab}>
                    <div id="daily"><DailyReportTab userProfile={userProfile} leaveRequests={leaveRequests} otRequests={otRequests} /></div>
                    <div id="monthly"><WorkDayReportTab userProfile={userProfile} leaveRequests={leaveRequests} otRequests={otRequests} /></div>
                </TabbedPage>
            );
        };

        // NEW: Modal for manually adding a check-out time
        const ManualCheckOutModal = ({ isOpen, onClose, onSave, record }) => {
            const [checkOutTime, setCheckOutTime] = useState('');

            useEffect(() => {
                // Reset time when modal opens for a new record
                if (isOpen) {
                    setCheckOutTime('');
                }
            }, [isOpen]);
            
            const handleSubmit = (e) => {
                e.preventDefault();
                if (record && checkOutTime) {
                    onSave(record, checkOutTime);
                }
            };

            if (!record) return null;

            return (
                <Modal isOpen={isOpen} onClose={onClose} maxWidth="max-w-md">
                    <form onSubmit={handleSubmit}>
                        <ModalHeader title="Add Manual Check-Out" onClose={onClose} />
                        <ModalBody>
                            <div className="space-y-4">
                                <div>
                                    <label className="text-sm font-medium text-slate-400">Employee</label>
                                    <input value={record.employeeName} className="input" disabled />
                                </div>
                                <div>
                                    <label className="text-sm font-medium text-slate-400">Date</label>
                                    <input value={record.date} className="input" disabled />
                                </div>
                                <div>
                                    <label className="text-sm font-medium text-slate-400">Check-Out Time</label>
                                    <input
                                        type="time"
                                        value={checkOutTime}
                                        onChange={(e) => setCheckOutTime(e.target.value)}
                                        className="input"
                                        required
                                    />
                                </div>
                            </div>
                        </ModalBody>
                        <ModalFooter>
                            <Button variant="secondary" onClick={onClose}>Cancel</Button>
                            <Button type="submit" variant="primary">Save Check-Out</Button>
                        </ModalFooter>
                    </form>
                </Modal>
            );
        };

        const DailyReportTab = ({ userProfile, leaveRequests, otRequests }) => {
            const { db } = useFirebase();
            const { data: attendance } = useCollection('attendance');
            const { data: shops } = useCollection('shops');
            const { data: employees } = useCollection('employees');
            const [selectedShop, setSelectedShop] = useState('');
            const [filterType, setFilterType] = useState('today');
            const [customMonth, setCustomMonth] = useState(new Date().toISOString().slice(0, 7));
            const [selectedEmployeeId, setSelectedEmployeeId] = useState('');
            const [recordToDelete, setRecordToDelete] = useState(null);
            const [recordToCorrect, setRecordToCorrect] = useState(null); // State for manual check-out
            const [isCorrectionModalOpen, setCorrectionModalOpen] = useState(false);

            useEffect(() => {
                if (userProfile && userProfile.role !== 'Admin') {
                    // For managers with multiple shops, default to showing all their shops.
                    // For single-shop users, their shop is pre-selected.
                    setSelectedShop(Array.isArray(userProfile.shop) ? '' : userProfile.shop || '');
                }
            }, [userProfile]);
            
            // Admins see all shops, Managers see their assigned shops for filtering.
            const availableShops = useMemo(() => {
                if (userProfile?.role === 'Admin') return shops;
                if (userProfile?.role === 'Shop Manager' && Array.isArray(userProfile.shop)) {
                    return shops.filter(s => userProfile.shop.includes(s.name));
                }
                return []; // Not used for other roles in the UI dropdown
            }, [shops, userProfile]);

            const employeesInShop = useMemo(() => {
                if (!selectedShop) return [];
                return employees.filter(emp => {
                    const employeeShops = Array.isArray(emp.shop) ? emp.shop : [emp.shop];
                    return employeeShops.includes(selectedShop) && emp.status === 'Active';
                });
            }, [selectedShop, employees]);

            const attendanceReport = useMemo(() => {
                const startDate = new Date();
                const endDate = new Date();

                switch (filterType) {
                    case 'today':
                        startDate.setHours(0, 0, 0, 0);
                        endDate.setHours(23, 59, 59, 999);
                        break;
                    case 'yesterday':
                        startDate.setDate(startDate.getDate() - 1);
                        startDate.setHours(0, 0, 0, 0);
                        endDate.setDate(endDate.getDate() - 1);
                        endDate.setHours(23, 59, 59, 999);
                        break;
                    case 'thisMonth':
                        startDate.setDate(1);
                        startDate.setHours(0, 0, 0, 0);
                        endDate.setMonth(endDate.getMonth() + 1);
                        endDate.setDate(0);
                        endDate.setHours(23, 59, 59, 999);
                        break;
                    case 'lastMonth':
                        startDate.setMonth(startDate.getMonth() - 1);
                        startDate.setDate(1);
                        startDate.setHours(0, 0, 0, 0);
                        endDate.setDate(0);
                        endDate.setHours(23, 59, 59, 999);
                        break;
                    case 'custom':
                        const [year, month] = customMonth.split('-').map(Number);
                        if (year && month) {
                            startDate.setFullYear(year, month - 1, 1);
                            startDate.setHours(0, 0, 0, 0);
                            endDate.setFullYear(year, month, 0);
                            endDate.setHours(23, 59, 59, 999);
                        }
                        break;
                }
                
                const isMultiShopManager = userProfile.role === 'Shop Manager' && Array.isArray(userProfile.shop);

                // 1. Get a list of employees to report on
                const relevantEmployees = employees.filter(emp => {
                    const employeeShops = Array.isArray(emp.shop) ? emp.shop : (emp.shop ? [emp.shop] : []);
                    let shopMatch = false;

                    if (userProfile.role === 'Admin') {
                        shopMatch = !selectedShop || employeeShops.includes(selectedShop);
                    } else if (isMultiShopManager) {
                        // Check if the employee's shops intersect with the manager's shops
                        const isManaged = employeeShops.some(s => userProfile.shop.includes(s));
                        // And if a filter is applied, the employee must be in that specific shop
                        shopMatch = isManaged && (!selectedShop || employeeShops.includes(selectedShop));
                    } else { // Single shop user
                        shopMatch = employeeShops.includes(userProfile.shop);
                    }
                    return emp.status === 'Active' && shopMatch && (!selectedEmployeeId || emp.id === selectedEmployeeId);
                });

                // 2. Initialize a report entry for each employee for each day in the range
                const reportMap = new Map();
                const currentDate = new Date(startDate);
                while (currentDate <= endDate) {
                    const dateKey = `${currentDate.getFullYear()}-${String(currentDate.getMonth() + 1).padStart(2, '0')}-${String(currentDate.getDate()).padStart(2, '0')}`;
                    for (const employee of relevantEmployees) {
                        const reportKey = `${employee.id}_${dateKey}`;
                        reportMap.set(reportKey, { 
                            date: dateKey, 
                            employeeId: employee.id, 
                            employeeName: employee.name, 
                            assignedShop: Array.isArray(employee.shop) ? employee.shop.join(', ') : employee.shop,
                            shop: '', // This will hold the actual check-in shop
                            checkIn: null, 
                            checkOut: null, 
                            docIds: [] 
                        });
                    }
                    currentDate.setDate(currentDate.getDate() + 1);
                }
                
                // 3. Filter attendance records once
                const filteredAttendance = attendance.filter(record => {
                    if (!record.timestamp) return false;
                    const recordDate = record.timestamp.toDate();
                    if (!(recordDate >= startDate && recordDate <= endDate)) return false;

                    let shopMatch = false;
                    if (userProfile.role === 'Admin') {
                        shopMatch = !selectedShop || record.shop === selectedShop;
                    } else if (isMultiShopManager) {
                        shopMatch = userProfile.shop.includes(record.shop) && (!selectedShop || record.shop === selectedShop);
                    } else {
                        shopMatch = record.shop === userProfile.shop;
                    }

                    return shopMatch && (!selectedEmployeeId || record.employeeId === selectedEmployeeId);
                });

                // 4. Populate the report map with attendance data
                filteredAttendance.forEach(record => {
                    const date = record.timestamp.toDate();
                    const dateKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
                    const reportKey = `${record.employeeId}_${dateKey}`;

                    if (reportMap.has(reportKey)) {
                        const entry = reportMap.get(reportKey);
                        if (record.type === 'in' && (!entry.checkIn || date < entry.checkIn)) {
                            entry.checkIn = date;
                            entry.shop = record.shop; // Capture shop from the earliest check-in
                        }
                        if (record.type === 'out' && (!entry.checkOut || date > entry.checkOut)) {
                            entry.checkOut = date;
                            // If no check-in record set the shop, use the shop from the latest check-out
                            if (!entry.shop) {
                                entry.shop = record.shop;
                            }
                        }
                        entry.docIds.push(record.id);
                    }
                });
                
                // 5. Finalize calculations (hours, leave, OT, etc.) for each entry
                const reportArray = Array.from(reportMap.values()).map(report => {
                    const employee = employees.find(e => e.id === report.employeeId);
                    
                    let isLate = false;
                    if (report.checkIn && employee) {
                        const shift = employee.shift || 'AM';
                        const checkInHour = report.checkIn.getHours(); const checkInMinute = report.checkIn.getMinutes();
                        if ((shift === 'AM' || shift === 'APM') && (checkInHour > 7 || (checkInHour === 7 && checkInMinute >= 35))) isLate = true;
                        else if (shift === 'PM' && (checkInHour > 12 || (checkInHour === 12 && checkInMinute >= 35))) isLate = true;
                    }

                    const hasActivity = report.checkIn || report.checkOut;
                    const reportDate = new Date(report.date);
                    reportDate.setHours(23, 59, 59, 999); // Set to end of day for comparison
                    const today = new Date();

                    // Check for approved leave first, then check for absence on past days
                    const approvedLeave = leaveRequests.find(lr => lr.staffId === report.employeeId && lr.status === 'Approved' && report.date >= lr.leaveDate && report.date < lr.returnDate);
                    let isOnLeave = 'N'; // This variable now represents the general status for the "Leave Status" column
                    if (approvedLeave) { 
                        isOnLeave = approvedLeave.leaveSession === 'Full Day' ? 'Y-Full Day' : `Y-${approvedLeave.leaveSession}`; 
                    } else if (!hasActivity && reportDate < today) {
                        // If there's no activity and the day has passed, mark as Absent
                        isOnLeave = 'Absent';
                    }

                    const isOnOT = otRequests.some(ot => ot.staffId === report.employeeId && ot.status === 'Approved' && ot.reqDate === report.date);
                    const otStatus = isOnOT ? 'Y' : 'N';
                    
                    const isSingleDayView = filterType === 'today' || filterType === 'yesterday' || filterType === 'custom';
                    
                    const displayShop = report.shop || report.assignedShop;

                    // Only show records that have activity, have a specific status (Leave/Absent), or are in a single-day view.
                    // This prevents showing future empty rows in multi-day reports.
                    if (hasActivity || isOnLeave !== 'N' || isSingleDayView) {
                        return { ...report, shop: displayShop, shift: employee?.shift, checkIn: report.checkIn ? report.checkIn.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: true }) : '', checkOut: report.checkOut ? report.checkOut.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: true }) : '', isLate, isOnLeave, otStatus };
                    }
                    return null;
                }).filter(Boolean); // Remove null entries
                
                // 6. Sort the final array
                return reportArray.sort((a, b) => (a.shop || '').localeCompare(b.shop || '') || b.date.localeCompare(a.date) || a.employeeName.localeCompare(b.employeeName));
            }, [attendance, selectedShop, filterType, customMonth, selectedEmployeeId, employees, leaveRequests, otRequests]);

            const handleDelete = async () => {
                if (!recordToDelete?.docIds) return;
                const { doc, writeBatch } = window.firebaseSDK;
                const batch = writeBatch(db);
                // Delete all attendance docs for that employee on that day
                recordToDelete.docIds.forEach(id => batch.delete(doc(db, 'attendance', id)));
                try { await batch.commit(); } catch (error) { console.error("Error deleting attendance records: ", error); } 
                finally { setRecordToDelete(null); }
            };

            const handleOpenCorrectionModal = useCallback((record) => {
                setRecordToCorrect(record);
                setCorrectionModalOpen(true);
            }, []);

            const handleCloseCorrectionModal = useCallback(() => {
                setRecordToCorrect(null);
                setCorrectionModalOpen(false);
            }, []);
            
            const handleSaveCheckOut = useCallback(async (record, time) => {
                const { addDoc, collection } = window.firebaseSDK;
                const [hour, minute] = time.split(':');
                
                // Important: Use the date from the record and combine it with the new time.
                // The record.date is a string 'YYYY-MM-DD'.
                const checkOutDateTime = new Date(`${record.date}T${time}:00`);

                try {
                    await addDoc(collection(db, 'attendance'), {
                        employeeId: record.employeeId,
                        employeeName: record.employeeName,
                        shop: record.shop,
                        timestamp: checkOutDateTime, // Use the combined date-time object
                        type: 'out',
                        location: { manualEntry: true, note: 'Added by Admin' }
                    });
                    handleCloseCorrectionModal();
                } catch (error) {
                    console.error("Error saving manual check-out:", error);
                    alert("Failed to save the manual check-out time.");
                }
            }, [db, handleCloseCorrectionModal]);

            const handleExportExcel = useCallback(() => {
                const dataToExport = attendanceReport.map(report => ({
                    'Date': report.date,
                    'Shop Name': report.shop,
                    'Staff Name': report.employeeName,
                    'Shift': report.shift,
                    'Check In': report.checkIn,
                    'Check Out': report.checkOut,
                    'On Leave': report.isOnLeave,
                    'OT Status': report.otStatus,
                    'Late Check-In': report.isLate ? 'Yes' : 'No'
                }));

                const getReportFilename = () => {
                    const todayStr = new Date().toISOString().slice(0, 10);
                    switch (filterType) {
                        case 'today': return `Daily_Attendance_Report_Today_${todayStr}.xlsx`;
                        case 'yesterday': 
                            const yesterday = new Date();
                            yesterday.setDate(yesterday.getDate() - 1);
                            return `Daily_Attendance_Report_Yesterday_${yesterday.toISOString().slice(0, 10)}.xlsx`;
                        case 'thisMonth': return `Daily_Attendance_Report_ThisMonth_${new Date().toISOString().slice(0, 7)}.xlsx`;
                        case 'lastMonth': 
                            const lastMonth = new Date();
                            lastMonth.setMonth(lastMonth.getMonth() - 1);
                            return `Daily_Attendance_Report_LastMonth_${lastMonth.toISOString().slice(0, 7)}.xlsx`;
                        case 'custom': return `Daily_Attendance_Report_${customMonth}.xlsx`;
                        default: return 'Daily_Attendance_Report.xlsx';
                    }
                };

                const worksheet = XLSX.utils.json_to_sheet(dataToExport);
                const workbook = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(workbook, worksheet, "Daily Attendance");

                worksheet["!cols"] = [ { wch: 12 }, { wch: 15 }, { wch: 25 }, { wch: 10 }, { wch: 15 }, { wch: 15 }, { wch: 15 }, { wch: 12 }, { wch: 15 } ];
                
                XLSX.writeFile(workbook, getReportFilename());
            }, [attendanceReport, filterType, customMonth]);

            return (
                <Card>
                    <div className="flex flex-wrap gap-4 justify-between items-center mb-6">
                        <CardTitle>Daily Attendance Report</CardTitle>
                        <div className="flex flex-wrap gap-4 items-center">
                            {(userProfile?.role === 'Admin' || (userProfile?.role === 'Shop Manager' && Array.isArray(userProfile.shop))) && (
                                <select value={selectedShop} onChange={e => { setSelectedShop(e.target.value); setSelectedEmployeeId(''); }} className="select w-full sm:w-auto">
                                    <option value="">All My Shops</option>
                                    {availableShops.map(s => <option key={s.id} value={s.name}>{s.name}</option>)}
                                </select>
                            )}
                            {userProfile?.role !== 'Staff' && selectedShop && (
                                <select value={selectedEmployeeId} onChange={e => setSelectedEmployeeId(e.target.value)} className="select w-full sm:w-auto">
                                    <option value="">All Staff</option>
                                    {employeesInShop.map(e => <option key={e.id} value={e.id}>{e.name}</option>)}
                                </select>
                            )}
                            <select value={filterType} onChange={e => setFilterType(e.target.value)} className="select w-full sm:w-auto">
                                <option value="today">Today</option>
                                <option value="yesterday">Yesterday</option>
                                <option value="thisMonth">This Month</option>
                                <option value="lastMonth">Last Month</option>
                                <option value="custom">Custom Month</option>
                            </select>
                            {filterType === 'custom' && (
                                <input type="month" value={customMonth} onChange={e => setCustomMonth(e.target.value)} className="input w-full sm:w-auto" />
                            )}
                            <Button variant="success" icon="fa-file-excel" onClick={handleExportExcel}>Excel</Button>
                        </div>
                    </div>
                    <div className="overflow-x-auto"><table className="min-w-full divide-y divide-slate-700"><thead className="bg-slate-900/50"><tr><th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Date</th><th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Shop Name</th><th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Staff Name</th><th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Shift</th><th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Check In</th><th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Check Out</th><th className="px-4 py-3 text-center text-xs font-semibold text-slate-400 uppercase">Leave Status</th><th className="px-4 py-3 text-center text-xs font-semibold text-slate-400 uppercase">OT Status</th><th className="px-4 py-3 text-center text-xs font-semibold text-slate-400 uppercase">Actions</th></tr></thead><tbody className="divide-y divide-slate-700">{attendanceReport.map((report) => (<tr key={`${report.employeeId}-${report.date}`} className="transition-colors hover:bg-slate-700/50"><td className="px-4 py-4 text-sm text-slate-200">{report.date}</td><td className="px-4 py-4 text-sm text-slate-300">{report.shop}</td><td className="px-4 py-4 text-sm text-slate-200">{report.employeeName}</td><td className="px-4 py-4 text-sm text-slate-300">{report.shift}</td><td className={`px-4 py-4 text-sm font-semibold ${report.isLate ? 'text-orange-400' : 'text-slate-300 font-normal'}`}>{report.checkIn}</td><td className="px-4 py-4 text-sm text-slate-300">{report.checkOut}</td><td className={`px-4 py-4 text-sm text-center ${report.isOnLeave === 'Absent' ? 'text-red-400 font-semibold' : 'text-slate-300'}`}>{report.isOnLeave}</td><td className="px-4 py-4 text-sm text-center text-slate-300">{report.otStatus}</td><td className="px-4 py-4 text-center whitespace-nowrap"><div className="flex items-center justify-center gap-4">{userProfile?.role === 'Admin' && report.checkIn && !report.checkOut && (<Button variant="icon-add-time" icon="fa-clock" onClick={() => handleOpenCorrectionModal(report)} title="Add Check-Out"/>)}{userProfile?.role === 'Admin' && report.docIds.length > 0 && (<Button variant="icon-delete" icon="fa-trash" onClick={() => setRecordToDelete(report)} title="Delete" />)}</div></td></tr>))}</tbody></table></div>
                    <ConfirmationModal isOpen={!!recordToDelete} onClose={() => setRecordToDelete(null)} onConfirm={handleDelete} title="Delete Attendance Record" message={`Are you sure you want to delete all attendance records for ${recordToDelete?.employeeName} on ${recordToDelete?.date}? This action cannot be undone.`} />
                    <ManualCheckOutModal isOpen={isCorrectionModalOpen} onClose={handleCloseCorrectionModal} onSave={handleSaveCheckOut} record={recordToCorrect} />
                </Card>
            );
        };
        
        const WorkDayReportTab = ({ userProfile, leaveRequests, otRequests }) => {
            const { data: attendance } = useCollection('attendance');
            const { data: shops } = useCollection('shops');
            const { data: employees } = useCollection('employees');
            const { data: employeeStates } = useCollection('employeeStates'); // Fetch employee states for late calculation
            const [selectedShop, setSelectedShop] = useState('');
            const [filterType, setFilterType] = useState('thisMonth');
            const [selectedMonth, setSelectedMonth] = useState(new Date().toISOString().slice(0, 7));
            const [selectedEmployeeId, setSelectedEmployeeId] = useState('');
            
            useEffect(() => {
                if (userProfile && userProfile.role !== 'Admin') {
                     // For managers with multiple shops, default to showing all their shops.
                    setSelectedShop(Array.isArray(userProfile.shop) ? '' : userProfile.shop || '');
                }
            }, [userProfile]);

            // Admins see all shops, Managers see their assigned shops for filtering.
            const availableShops = useMemo(() => {
                if (userProfile?.role === 'Admin') return shops;
                if (userProfile?.role === 'Shop Manager' && Array.isArray(userProfile.shop)) {
                    return shops.filter(s => userProfile.shop.includes(s.name));
                }
                return []; // Not used for other roles in the UI dropdown
            }, [shops, userProfile]);

            const employeesInShop = useMemo(() => {
                if (!selectedShop) return [];
                return employees.filter(emp => {
                    const employeeShops = Array.isArray(emp.shop) ? emp.shop : [emp.shop];
                    return employeeShops.includes(selectedShop) && emp.status === 'Active';
                });
            }, [selectedShop, employees]);

            const workDayReport = useMemo(() => {
                let targetMonth;
                const now = new Date();
                switch (filterType) {
                    case 'lastMonth':
                        const lastMonthDate = new Date(now.getFullYear(), now.getMonth() - 1, 1);
                        // FIX: Construct YYYY-MM from local date parts to avoid timezone issues with toISOString().
                        const year_lm = lastMonthDate.getFullYear();
                        const month_lm = String(lastMonthDate.getMonth() + 1).padStart(2, '0');
                        targetMonth = `${year_lm}-${month_lm}`;
                        break;
                    case 'custom':
                        targetMonth = selectedMonth;
                        break;
                    case 'thisMonth':
                    default:
                        // FIX: Construct YYYY-MM from local date parts to avoid timezone issues with toISOString().
                        const year_tm = now.getFullYear();
                        const month_tm = String(now.getMonth() + 1).padStart(2, '0');
                        targetMonth = `${year_tm}-${month_tm}`;
                        break;
                }

                const isMultiShopManager = userProfile.role === 'Shop Manager' && Array.isArray(userProfile.shop);

                const recordsByEmployeeMonth = {};
                const filteredAttendance = attendance.filter(record => {
                    if (!record.timestamp) return false;
                    if (!targetMonth || !record.timestamp.toDate().toISOString().startsWith(targetMonth)) return false;

                    let shopMatch = false;
                    if (userProfile.role === 'Admin') {
                        shopMatch = !selectedShop || record.shop === selectedShop;
                    } else if (isMultiShopManager) {
                        shopMatch = userProfile.shop.includes(record.shop) && (!selectedShop || record.shop === selectedShop);
                    } else {
                        shopMatch = record.shop === userProfile.shop;
                    }

                    return shopMatch && (!selectedEmployeeId || record.employeeId === selectedEmployeeId);
                });
                
                filteredAttendance.forEach(record => {
                    const date = record.timestamp.toDate();
                    const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                    const employeeMonthKey = `${record.employeeId}_${monthKey}`;
                    if (!recordsByEmployeeMonth[employeeMonthKey]) {
                        recordsByEmployeeMonth[employeeMonthKey] = { 
                            employeeId: record.employeeId, 
                            employeeName: record.employeeName, 
                            shop: record.shop, 
                            month: monthKey, 
                            records: [] 
                        };
                    }
                    recordsByEmployeeMonth[employeeMonthKey].records.push({ date: date, type: record.type });
                });

                const report = Object.values(recordsByEmployeeMonth).map(group => {
                    const employeeLeaves = leaveRequests.filter(
                        lr => lr.staffId === group.employeeId &&
                              lr.status === 'Approved' &&
                              lr.leaveDate.startsWith(group.month)
                    );
                    const totalLeave = employeeLeaves.reduce((acc, curr) => acc + (parseFloat(curr.numberOfDays) || 0), 0);

                    const employeeOTs = otRequests.filter(
                        ot => ot.staffId === group.employeeId &&
                              ot.status === 'Approved' &&
                              ot.reqDate.startsWith(group.month)
                    );
                    const totalOT = employeeOTs.reduce((acc, curr) => acc + (parseFloat(curr.numberOfOTDays) || 0), 0);
                    
                    // Calculate total late days for the month from employeeStates
                    const totalLate = employeeStates.filter(es =>
                        es.staffId === group.employeeId &&
                        es.date.startsWith(group.month) &&
                        es.statusState === 'Deduction' &&
                        es.note && es.note.includes('CheckIn Late')
                    ).length;

                    const dailyRecords = {};
                    group.records.forEach(rec => {
                        const dayKey = rec.date.toISOString().split('T')[0];
                        if (!dailyRecords[dayKey]) dailyRecords[dayKey] = [];
                        dailyRecords[dayKey].push(rec);
                    });

                    let workDays = 0;
                    let noCheckOutCount = 0; // Counter for forgotten check-outs
                    const todayStr = new Date().toISOString().split('T')[0]; // Get today's date string

                    Object.entries(dailyRecords).forEach(([dayKey, dayRecords]) => { // Use Object.entries to get the key
                        const checkIns = dayRecords.filter(r => r.type === 'in').sort((a, b) => a.date - b.date);
                        const checkOuts = dayRecords.filter(r => r.type === 'out').sort((a, b) => b.date - a.date);
                        if (checkIns.length > 0 && checkOuts.length > 0) {
                            const diffHours = (checkOuts[0].date.getTime() - checkIns[0].date.getTime()) / 3600000;
                            // Rule: >= 7 hours is 1 day, >= 4 hours is 0.5 day
                            if (diffHours >= 7) {
                                workDays += 1;
                            } else if (diffHours >= 4) {
                                workDays += 0.5;
                            }
                        } else if (checkIns.length > 0 && checkOuts.length === 0) {
                            // If there's a check-in but no check-out, increment the count,
                            // but ONLY if the day is in the past.
                            if (dayKey < todayStr) {
                                noCheckOutCount += 1;
                            }
                        }
                    });

                    // NEW: Calculate absent days (no check-in/out at all on a past day)
                    const [year, month] = group.month.split('-').map(Number);
                    const daysInMonth = new Date(year, month, 0).getDate();
                    const attendedDays = new Set(Object.keys(dailyRecords));
                    let noAbsentCount = 0;
                    const today = new Date();
                    today.setHours(0, 0, 0, 0);
                    for (let day = 1; day <= daysInMonth; day++) {
                        const currentDay = new Date(year, month - 1, day);
                        if (currentDay >= today) break;

                        const dayKey = `${currentDay.getFullYear()}-${String(currentDay.getMonth() + 1).padStart(2, '0')}-${String(currentDay.getDate()).padStart(2, '0')}`;
                        if (!attendedDays.has(dayKey)) {
                            // Check if the employee was on approved leave. If so, it's not an absence.
                            const isOnLeave = employeeLeaves.some(lr => dayKey >= lr.leaveDate && dayKey < lr.returnDate);
                            if (!isOnLeave) {
                                noAbsentCount++;
                            }
                        }
                    }

                    // New calculation for Total-Day
                    const totalDay = workDays + totalLeave + noCheckOutCount;

                    const [reportYear, reportMonth] = group.month.split('-');
                    return { 
                        dueTime: `${reportMonth}-${reportYear.substring(2)}`, 
                        shopName: group.shop, 
                        staffName: group.employeeName, 
                        workDays,
                        totalOT,
                        totalLeave,
                        totalLate,
                        noCheckOutCount,
                        noAbsentCount, // Include the new count in the report data
                        totalDay // Include the new Total-Day calculation
                    };
                });
                
                return report.sort((a, b) => (a.shopName || '').localeCompare(b.shopName || '') || (a.staffName || '').localeCompare(b.staffName || ''));

            }, [attendance, leaveRequests, otRequests, selectedShop, filterType, selectedMonth, selectedEmployeeId, employeeStates]);

            const handleExportExcel = useCallback(() => {
                const dataToExport = workDayReport.map(rec => ({
                    'Due Time (MM-YY)': rec.dueTime,
                    'Shop Name': rec.shopName,
                    'Staff Name': rec.staffName,
                    'No. Work Day': rec.workDays,
                    'Total OT': rec.totalOT,
                    'Total Leave No': rec.totalLeave,
                    'Total LATE': rec.totalLate,
                    'No-CheckOut': rec.noCheckOutCount, // Add to Excel export
                    'No-Absent': rec.noAbsentCount,
                    'Total-Day': rec.totalDay, // Add new column to Excel export
                }));

                const getReportFilename = () => {
                    const now = new Date();
                    switch (filterType) {
                        case 'thisMonth':
                            // FIX: Construct YYYY-MM from local date parts to avoid timezone issues.
                            const year_tm = now.getFullYear();
                            const month_tm = String(now.getMonth() + 1).padStart(2, '0');
                            return `Monthly_Work_Day_Report_${year_tm}-${month_tm}.xlsx`;
                        case 'lastMonth': 
                            const lastMonthDate = new Date(now.getFullYear(), now.getMonth() - 1, 1);
                            // FIX: Construct YYYY-MM from local date parts to avoid timezone issues.
                            const year_lm = lastMonthDate.getFullYear();
                            const month_lm = String(lastMonthDate.getMonth() + 1).padStart(2, '0');
                            return `Monthly_Work_Day_Report_${year_lm}-${month_lm}.xlsx`;
                        case 'custom': return `Monthly_Work_Day_Report_${selectedMonth}.xlsx`;
                        default: return 'Monthly_Work_Day_Report.xlsx';
                    }
                };

                const worksheet = XLSX.utils.json_to_sheet(dataToExport);
                const workbook = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(workbook, worksheet, "Monthly Work Day Report");
                
                worksheet["!cols"] = [ { wch: 18 }, { wch: 20 }, { wch: 25 }, { wch: 15 }, { wch: 15 }, { wch: 15 }, { wch: 15 }, { wch: 15 }, { wch: 15 }, { wch: 15 } ]; // Adjust column widths
                
                XLSX.writeFile(workbook, getReportFilename());
            }, [workDayReport, filterType, selectedMonth]);

            return (
                <Card>
                    <div className="flex flex-wrap gap-4 justify-between items-center mb-6">
                        <CardTitle>Monthly Work Day Report</CardTitle>
                        <div className="flex flex-wrap gap-4 items-center">
                            {(userProfile?.role === 'Admin' || (userProfile?.role === 'Shop Manager' && Array.isArray(userProfile.shop))) && (
                                <select value={selectedShop} onChange={e => { setSelectedShop(e.target.value); setSelectedEmployeeId(''); }} className="select w-full sm:w-auto">
                                    <option value="">All My Shops</option>
                                    {availableShops.map(s => <option key={s.id} value={s.name}>{s.name}</option>)}
                                </select>
                            )}
                             {userProfile?.role !== 'Staff' && selectedShop && (
                                <select value={selectedEmployeeId} onChange={e => setSelectedEmployeeId(e.target.value)} className="select w-full sm:w-auto">
                                    <option value="">All Staff</option>
                                    {employeesInShop.map(e => <option key={e.id} value={e.id}>{e.name}</option>)}
                                </select>
                            )}
                            <select value={filterType} onChange={e => setFilterType(e.target.value)} className="select w-full sm:w-auto">
                                <option value="thisMonth">This Month</option>
                                <option value="lastMonth">Last Month</option>
                                <option value="custom">Custom Month</option>
                            </select>
                            {filterType === 'custom' && (
                                <input type="month" value={selectedMonth} onChange={e => setSelectedMonth(e.target.value)} className="input w-full sm-w-auto" />
                            )}
                            <Button variant="success" icon="fa-file-excel" onClick={handleExportExcel}>Excel</Button>
                        </div>
                    </div>
                    <div className="overflow-x-auto"><table className="min-w-full divide-y divide-slate-700"><thead className="bg-slate-900/50"><tr><th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Date</th><th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Shop Name</th><th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Staff Name</th><th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">No. Work Day</th><th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Total OT</th><th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Total Leave No</th><th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Total LATE</th><th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">No-CheckOut</th><th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">No-Absent</th><th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Total-Day</th></tr></thead><tbody className="divide-y divide-slate-700">{workDayReport.map((report, index) => (<tr key={index} className="hover:bg-slate-700/50"><td className="px-4 py-4 text-sm text-slate-200">{report.dueTime}</td><td className="px-4 py-4 text-sm text-slate-300">{report.shopName}</td><td className="px-4 py-4 text-sm text-slate-200">{report.staffName}</td><td className="px-4 py-4 text-sm font-semibold text-blue-400">{report.workDays}</td><td className="px-4 py-4 text-sm font-semibold text-green-400">{report.totalOT > 0 ? report.totalOT.toFixed(2) : 0}</td><td className="px-4 py-4 text-sm font-semibold text-yellow-400">{report.totalLeave}</td><td className="px-4 py-4 text-sm font-semibold text-red-400">{report.totalLate}</td><td className="px-4 py-4 text-sm font-semibold text-orange-400">{report.noCheckOutCount}</td><td className="px-4 py-4 text-sm font-semibold text-red-500">{report.noAbsentCount}</td><td className="px-4 py-4 text-sm font-semibold text-teal-400">{report.totalDay}</td></tr>))}</tbody></table></div>
                </Card>
            );
        };
        // --- END ATTENDANCE REPORT PAGE ---

        // --- START LOAN MANAGER PAGE ---
        const LoanManagerPage = ({ userProfile }) => {
            const [activeTab, setActiveTab] = useState('management');
            return (
                <TabbedPage tabs={{ management: 'Loan Management', history: 'Loan History' }} activeTab={activeTab} setActiveTab={setActiveTab}>
                    <div id="management"><LoanManagementTab userProfile={userProfile} /></div>
                    <div id="history"><LoanHistoryTab userProfile={userProfile} /></div>
                </TabbedPage>
            );
        };

        const LoanManagementTab = ({ userProfile }) => {
            const { db } = useFirebase();
            const [isModalOpen, setModalOpen] = useState(false);
            const [editingLoan, setEditingLoan] = useState(null);
            const [loanToDelete, setLoanToDelete] = useState(null);
            const { where } = window.firebaseSDK;
            
            const queryConstraints = useMemo(() => {
                if (!userProfile) return [where("shop", "==", "null")];
                if (userProfile.role === 'Admin') return [];
                if (userProfile.role === 'Shop Manager') {
                    const shops = Array.isArray(userProfile.shop) ? userProfile.shop : (userProfile.shop ? [userProfile.shop] : []);
                    if (shops.length > 0) {
                        return [where("shop", "in", shops)];
                    }
                    return [where("staffId", "==", "null")]; // No shops, no data
                }
                return [where("shop", "==", userProfile.shop || null)];
            }, [userProfile]);

            const { data: loans } = useCollection('staffLoans', queryConstraints);
            const { data: shops } = useCollection('shops');
            const { data: employees } = useCollection('employees');
            const [selectedShop, setSelectedShop] = useState(''); // For the modal's employee list
            const [formData, setFormData] = useState({});
            const [filterShop, setFilterShop] = useState(''); // For filtering the main list
            const [searchTerm, setSearchTerm] = useState(''); // State for the search input

            useEffect(() => {
                if (userProfile && userProfile.role !== 'Admin') {
                    setFilterShop(Array.isArray(userProfile.shop) ? '' : userProfile.shop || '');
                }
            }, [userProfile]);

            const availableShopsForFilter = useMemo(() => {
                if (userProfile?.role === 'Admin') return shops;
                if (userProfile?.role === 'Shop Manager' && Array.isArray(userProfile.shop)) {
                    return shops.filter(s => userProfile.shop.includes(s.name));
                }
                return [];
            }, [shops, userProfile]);

            const filteredLoans = useMemo(() => {
                return loans.filter(loan =>
                    (!filterShop || loan.shop === filterShop) &&
                    (loan.staffName.toLowerCase().includes(searchTerm.toLowerCase()))
                );
            }, [loans, filterShop, searchTerm]);

            const employeesInShop = useMemo(() => {
                if (!selectedShop) return [];
                return employees.filter(emp => {
                    const employeeShops = Array.isArray(emp.shop) ? emp.shop : [emp.shop];
                    return employeeShops.includes(selectedShop) && emp.status === 'Active';
                });
            }, [selectedShop, employees]);
            
            const availableShopsForModal = useMemo(() => {
                if (userProfile?.role === 'Admin') return shops;
                if (userProfile?.role === 'Shop Manager') {
                    const managedShops = Array.isArray(userProfile.shop) ? userProfile.shop : [userProfile.shop];
                    return shops.filter(s => managedShops.includes(s.name));
                }
                return [];
            }, [shops, userProfile]);

            const canSelectShopInModal = userProfile?.role === 'Admin' || userProfile?.role === 'Shop Manager';

            const handleOpenModal = (loan = null) => {
                setEditingLoan(loan);
                let initialShop = '';
                if (userProfile.role === 'Shop Manager') {
                    const managedShops = Array.isArray(userProfile.shop) ? userProfile.shop : [userProfile.shop];
                    if (managedShops.length === 1) initialShop = managedShops[0];
                } else if (userProfile.role !== 'Admin') {
                    initialShop = userProfile.shop || '';
                }

                const initialData = loan ? { ...loan } : { loanDate: new Date().toISOString().substring(0, 10), effectiveDate: new Date().toISOString().substring(0, 10), shop: initialShop, staffId: '', loanAmount: '', agreedMonthlyDeduction: '', reason: '', totalPaid: 0, status: 'Active' };
                setFormData(initialData);
                setSelectedShop(initialData.shop || '');
                setModalOpen(true);
            };

            const handleCloseModal = () => { setModalOpen(false); setEditingLoan(null); };
            const handleChange = (e) => {
                const { name, value } = e.target;
                setFormData(prev => ({ ...prev, [name]: value }));
                if (name === 'shop') { setSelectedShop(value); setFormData(prev => ({...prev, staffId: ''})); }
            };
            const handleSave = async () => {
                const { addDoc, updateDoc, doc, collection } = window.firebaseSDK;
                const dataToSave = { ...formData, loanAmount: parseFloat(formData.loanAmount) || 0, agreedMonthlyDeduction: parseFloat(formData.agreedMonthlyDeduction) || 0, staffName: employees.find(e => e.id === formData.staffId)?.name || '' };
                try {
                    if (editingLoan) { await updateDoc(doc(db, 'staffLoans', editingLoan.id), dataToSave); } 
                    else { await addDoc(collection(db, 'staffLoans'), dataToSave); }
                    handleCloseModal();
                } catch (error) { console.error("Error saving loan:", error); }
            };
            const confirmDelete = async () => {
                if (!loanToDelete) return;
                try {
                    await window.firebaseSDK.deleteDoc(window.firebaseSDK.doc(db, 'staffLoans', loanToDelete.id));
                } catch (error) { 
                    console.error("Error deleting loan:", error); 
                } finally {
                    setLoanToDelete(null);
                }
            };
            
            return (
                 <Card>
                    <div className="flex flex-wrap gap-4 justify-between items-center mb-6">
                        <h3 className="text-xl font-semibold text-slate-100">Loan Management</h3>
                        <div className="flex flex-wrap gap-4 items-center">
                            <input
                                type="text"
                                placeholder="Search by staff name..."
                                value={searchTerm}
                                onChange={e => setSearchTerm(e.target.value)}
                                className="input w-full sm:w-auto"
                            />
                            {(userProfile?.role === 'Admin' || (userProfile?.role === 'Shop Manager' && Array.isArray(userProfile.shop))) && (
                                <select value={filterShop} onChange={e => setFilterShop(e.target.value)} className="select w-full sm:w-auto">
                                    <option value="">{userProfile.role === 'Admin' ? 'All Shops' : 'All My Shops'}</option>
                                    {availableShopsForFilter.map(s => <option key={s.id} value={s.name}>{s.name}</option>)}
                                </select>
                            )}
                            <Button variant="primary" icon="fa-plus" onClick={() => handleOpenModal()}>Add New Loan</Button>
                        </div>
                    </div>
                    <div className="overflow-x-auto"><table className="min-w-full divide-y divide-slate-700"><thead className="bg-slate-900/50"><tr><th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Staff Name</th><th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Loan Date</th><th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Effective Date</th><th className="px-4 py-3 text-right text-xs font-semibold text-slate-400 uppercase">Loan Amount</th><th className="px-4 py-3 text-right text-xs font-semibold text-slate-400 uppercase">Agreed Amount</th><th className="px-4 py-3 text-right text-xs font-semibold text-slate-400 uppercase">Total Paid</th><th className="px-4 py-3 text-right text-xs font-semibold text-slate-400 uppercase">Balance</th><th className="px-4 py-3 text-center text-xs font-semibold text-slate-400 uppercase">Status</th><th className="px-4 py-3 text-center text-xs font-semibold text-slate-400 uppercase">Actions</th></tr></thead><tbody className="divide-y divide-slate-700">{filteredLoans.map(loan => { const balance = loan.loanAmount - loan.totalPaid; return (<tr key={loan.id} className="hover:bg-slate-700/50"><td className="px-4 py-4 text-sm text-slate-200">{loan.staffName}</td><td className="px-4 py-4 text-sm text-slate-300">{Utils.formatISOToDisplay(loan.loanDate)}</td><td className="px-4 py-4 text-sm text-slate-300">{Utils.formatISOToDisplay(loan.effectiveDate)}</td><td className="px-4 py-4 text-sm text-slate-300 text-right">{Utils.formatCurrency(loan.loanAmount)}</td><td className="px-4 py-4 text-sm text-slate-300 text-right">{Utils.formatCurrency(loan.agreedMonthlyDeduction)}</td><td className="px-4 py-4 text-sm text-slate-300 text-right">{Utils.formatCurrency(loan.totalPaid)}</td><td className="px-4 py-4 text-sm text-slate-300 text-right">{Utils.formatCurrency(balance)}</td><td className="px-4 py-4 text-center text-sm"><span className={`px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${balance <= 0 ? 'bg-green-100 text-green-800' : 'bg-blue-100 text-blue-800'}`}>{balance <= 0 ? 'Paid Off' : 'Active'}</span></td><td className="px-4 py-4 text-center whitespace-nowrap"><div className="flex items-center justify-center gap-4"><Button variant="icon-edit" icon="fa-edit" onClick={() => handleOpenModal(loan)} title="Edit" /><Button variant="icon-delete" icon="fa-trash" onClick={() => setLoanToDelete(loan)} title="Delete" /></div></td></tr>); })}</tbody></table></div>
                    <Modal isOpen={isModalOpen} onClose={handleCloseModal}><ModalHeader title={editingLoan ? "Edit Loan" : "Add New Loan"} onClose={handleCloseModal} /><ModalBody><div className="space-y-4"><div><label className="text-sm">Shop</label><select name="shop" value={formData.shop || ''} onChange={handleChange} className="select" disabled={!canSelectShopInModal}><option value="">Select Shop</option>{availableShopsForModal.map(s => <option key={s.id} value={s.name}>{s.name}</option>)}</select></div><div><label className="text-sm">Staff</label><select name="staffId" value={formData.staffId || ''} onChange={handleChange} className="select" disabled={!selectedShop}><option value="">Select Staff</option>{employeesInShop.map(e => <option key={e.id} value={e.id}>{e.name}</option>)}</select></div><div><label className="text-sm">Loan Date</label><input type="date" name="loanDate" value={formData.loanDate || ''} onChange={handleChange} className="input"/></div><div><label className="text-sm">Effective Date</label><input type="date" name="effectiveDate" value={formData.effectiveDate || ''} onChange={handleChange} className="input"/></div><div><label className="text-sm">Loan Amount</label><input type="number" name="loanAmount" value={formData.loanAmount || ''} onChange={handleChange} className="input"/></div><div><label className="text-sm">Agreed Monthly Deduction</label><input type="number" name="agreedMonthlyDeduction" value={formData.agreedMonthlyDeduction || ''} onChange={handleChange} className="input"/></div><div><label className="text-sm">Reason</label><textarea name="reason" value={formData.reason || ''} onChange={handleChange} className="input" rows="3"></textarea></div></div></ModalBody><ModalFooter><Button variant="secondary" onClick={handleCloseModal}>Cancel</Button><Button variant="primary" onClick={handleSave} className="px-6">Save Loan</Button></ModalFooter></Modal>
                    <ConfirmationModal isOpen={!!loanToDelete} onClose={() => setLoanToDelete(null)} onConfirm={confirmDelete} title="Delete Loan" message="Are you sure you want to delete this loan record?" />
                </Card>
            );
        };
        
        const LoanHistoryTab = ({ userProfile }) => {
            const { db } = useFirebase();
            const { where } = window.firebaseSDK;
            const [selectedShop, setSelectedShop] = useState('');
            const { data: shops } = useCollection('shops');

            useEffect(() => {
                if (userProfile && userProfile.role !== 'Admin') {
                    setSelectedShop(Array.isArray(userProfile.shop) ? '' : userProfile.shop || '');
                }
            }, [userProfile]);

            const queryConstraints = useMemo(() => {
                if (!userProfile) return [where("shop", "==", "null")];
                if (userProfile.role === 'Admin') {
                    return selectedShop ? [where("shop", "==", selectedShop)] : [];
                }
                if (userProfile.role === 'Shop Manager') {
                    const managedShops = Array.isArray(userProfile.shop) ? userProfile.shop : (userProfile.shop ? [userProfile.shop] : []);
                    if (managedShops.length === 0) return [where("shop", "==", "null")];
                    if (selectedShop) {
                        return [where("shop", "==", selectedShop)];
                    }
                    return [where("shop", "in", managedShops)];
                }
                return [where("shop", "==", userProfile.shop || null)];
            }, [userProfile, selectedShop]);
            
            const { data: loanPayments } = useCollection('loanPayments', queryConstraints);
            const { data: staffLoans } = useCollection('staffLoans');
            const [paymentToDelete, setPaymentToDelete] = useState(null);

            const confirmDelete = async () => {
                if (!paymentToDelete) return;
                const { doc, updateDoc, deleteDoc } = window.firebaseSDK;
                try {
                    // Revert the loan's totalPaid amount
                    const loan = staffLoans.find(l => l.id === paymentToDelete.loanId);
                    if (loan) {
                        const newTotalPaid = (loan.totalPaid || 0) - paymentToDelete.amountPaid;
                        const newStatus = newTotalPaid >= loan.loanAmount ? 'Paid Off' : 'Active';
                        await updateDoc(doc(db, 'staffLoans', loan.id), { totalPaid: newTotalPaid, status: newStatus });
                    }
                    await deleteDoc(doc(db, 'loanPayments', paymentToDelete.id));
                } catch (error) { console.error("Error deleting loan payment:", error); alert("Failed to delete loan payment."); } 
                finally { setPaymentToDelete(null); }
            };
            
            const availableShops = useMemo(() => {
                if (userProfile?.role === 'Admin') return shops;
                if (userProfile?.role === 'Shop Manager' && Array.isArray(userProfile.shop)) {
                    return shops.filter(s => userProfile.shop.includes(s.name));
                }
                return [];
            }, [shops, userProfile]);

            return (
                 <Card>
                    <div className="flex flex-wrap gap-4 justify-between items-center mb-6">
                        <h3 className="text-xl font-semibold text-slate-100">Loan Payment History</h3>
                        {(userProfile?.role === 'Admin' || (userProfile?.role === 'Shop Manager' && Array.isArray(userProfile.shop))) && (
                            <select value={selectedShop} onChange={e => setSelectedShop(e.target.value)} className="select w-full sm:w-auto">
                                <option value="">{userProfile.role === 'Admin' ? 'All Shops' : 'All My Shops'}</option>
                                {availableShops.map(s => <option key={s.id} value={s.name}>{s.name}</option>)}
                            </select>
                        )}
                    </div>
                    <div className="overflow-x-auto"><table className="min-w-full divide-y divide-slate-700"><thead className="bg-slate-900/50"><tr><th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Payment Date</th><th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Staff Name</th><th className="px-4 py-3 text-right text-xs font-semibold text-slate-400 uppercase">Amount Paid</th><th className="px-4 py-3 text-right text-xs font-semibold text-slate-400 uppercase">Remaining Balance</th><th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Note</th><th className="px-4 py-3 text-center text-xs font-semibold text-slate-400 uppercase">Actions</th></tr></thead><tbody className="divide-y divide-slate-700">{loanPayments.map(payment => (<tr key={payment.id} className="hover:bg-slate-700/50"><td className="px-4 py-4 text-sm text-slate-200">{payment.paymentDate}</td><td className="px-4 py-4 text-sm text-slate-300">{payment.staffName}</td><td className="px-4 py-4 text-sm text-slate-300 text-right">{Utils.formatCurrency(payment.amountPaid)}</td><td className="px-4 py-4 text-sm text-slate-300 text-right">{Utils.formatCurrency(payment.remainingBalance)}</td><td className="px-4 py-4 text-sm text-slate-300">{payment.note}</td><td className="px-4 py-4 text-center whitespace-nowrap"><Button variant="icon-delete" icon="fa-trash" onClick={() => setPaymentToDelete(payment)} title="Delete" /></td></tr>))}</tbody></table></div>
                    <ConfirmationModal isOpen={!!paymentToDelete} onClose={() => setPaymentToDelete(null)} onConfirm={confirmDelete} title="Delete Loan Payment" message="Are you sure you want to delete this payment record? This will also update the loan's total paid amount." />
                </Card>
            );
        };
        // --- END LOAN MANAGER PAGE ---

        // --- START PAYROLL PAGE ---
        const PayrollPage = ({ userProfile }) => {
            const [activeTab, setActiveTab] = useState('calculator');
            const [editingRecord, setEditingRecord] = useState(null);
            
            // Function to switch to calculator tab and load record for editing
            const handleEdit = (record) => { 
                setEditingRecord(record); 
                setActiveTab('calculator'); 
            };

            // Function to handle successful save, switch to history tab
            const handleSaveSuccess = () => { 
                setEditingRecord(null); 
                setActiveTab('history'); 
            };

            return (
                <TabbedPage tabs={{ calculator: 'Payroll Calculator', history: 'Payroll History' }} activeTab={activeTab} setActiveTab={setActiveTab}>
                   <div id="calculator"><PayrollCalculatorTab userProfile={userProfile} editingRecord={editingRecord} onSaveSuccess={handleSaveSuccess} /></div>
                    <div id="history"><PayrollHistoryTab onEdit={handleEdit} userProfile={userProfile} /></div>
                </TabbedPage>
            );
        };

        // A dedicated component for rendering the payslip. It only displays data it receives.
        const PayslipPreview = memo(({ selectedEmployee, selectedMonth, manualInputs, calculations }) => {
            return (
                <div id="payslip-preview" className="bg-white text-slate-800 p-6 rounded-lg shadow-2xl font-sans min-h-[600px] flex flex-col">
                    {selectedEmployee ? (
                        <>
                            <div className="text-center mb-6">
                                <h3 className="text-2xl font-bold text-slate-900">Payslip</h3>
                                <p className="text-slate-500">For the month of {selectedMonth}</p>
                            </div>

                            <div className="grid grid-cols-2 gap-4 border-b border-slate-200 pb-4 mb-4">
                                <div>
                                    <p className="text-sm text-slate-500">Employee Name</p>
                                    <p className="font-semibold text-slate-800">{selectedEmployee.name}</p>
                                </div>
                                <div>
                                    <p className="text-sm text-slate-500">Position</p>
                                    <p className="font-semibold text-slate-800">{selectedEmployee.position}</p>
                                </div>
                                <div>
                                    <p className="text-sm text-slate-500">Shop</p>
                                    <p className="font-semibold text-slate-800">{Array.isArray(selectedEmployee.shop) ? selectedEmployee.shop.join(', ') : selectedEmployee.shop}</p>
                                </div>
                                <div>
                                    <p className="text-sm text-slate-500">Month</p>
                                    <p className="font-semibold text-slate-800">{selectedMonth}</p>
                                </div>
                            </div>
                            
                            <div className="flex-grow">
                                <div className="grid grid-cols-2 gap-x-8 gap-y-2">
                                    {/* Earnings */}
                                    <p className="font-semibold text-slate-800 col-span-2 border-b border-slate-200 pb-1 mb-1">Earnings</p>
                                    <p className="text-slate-600">Base Salary</p>
                                    <p className="text-right font-mono text-slate-800">{Utils.formatCurrency(calculations.baseSalary)}</p>

                                    <p className="text-slate-600">Base Salary Earned</p>
                                    <p className="text-right font-mono text-slate-800">{Utils.formatCurrency(calculations.baseSalaryEarned)}</p>

                                    <p className="text-slate-600">OT Salary</p>
                                    <p className="text-right font-mono text-slate-800">{Utils.formatCurrency(calculations.otSalary)}</p>

                                    <p className="text-slate-600">Engagements</p>
                                    <p className="text-right font-mono text-slate-800">{Utils.formatCurrency(calculations.engagements)}</p>

                                    <p className="font-semibold text-slate-800 pt-2 border-t border-slate-200">Gross Salary</p>
                                    <p className="text-right font-semibold font-mono text-slate-800 pt-2 border-t border-slate-200">{Utils.formatCurrency(calculations.grossSalary)}</p>

                                    {/* Deductions */}
                                    <p className="font-semibold text-slate-800 col-span-2 border-b border-slate-200 pb-1 mb-1 mt-4">Deductions</p>
                                    <p className="text-slate-600">Loan Deduction</p>
                                    <p className="text-right font-mono text-red-600">{Utils.formatCurrency(manualInputs.loanDeduction)}</p>

                                    <p className="text-slate-600">Late Deductions</p>
                                    <p className="text-right font-mono text-red-600">{Utils.formatCurrency(calculations.lateDeductionsAmount)}</p>
                                    
                                    <p className="text-slate-600">Rejected Leave Penalty</p>
                                    <p className="text-right font-mono text-red-600">{Utils.formatCurrency(calculations.rejectedLeavePenaltyAmount)}</p>

                                    <p className="text-slate-600">Other Deductions</p>
                                    <p className="text-right font-mono text-red-600">{Utils.formatCurrency(calculations.otherDeductions)}</p>

                                    <p className="font-semibold text-slate-800 pt-2 border-t border-slate-200">Total Deductions</p>
                                    <p className="text-right font-semibold font-mono text-red-600 pt-2 border-t border-slate-200">{Utils.formatCurrency(calculations.totalDeductions)}</p>
                                </div>
                            </div>
                            
                            <div className="mt-6 pt-4 border-t-2 border-dashed border-slate-300 text-right">
                                <p className="text-sm text-slate-600">Net Salary</p>
                                <p className="text-3xl font-bold text-blue-900">{Utils.formatCurrency(calculations.netSalary)}</p>
                            </div>
                        </>
                    ) : (
                        <div className="flex-grow flex items-center justify-center text-center py-20 text-slate-500">
                            <div>
                                <i className="fas fa-file-invoice-dollar text-4xl mb-4"></i>
                                <p>Please select an employee to view the payslip.</p>
                            </div>
                        </div>
                    )}
                </div>
            );
        });

        const PayrollCalculatorTab = ({ userProfile, editingRecord, onSaveSuccess }) => {
            const { db } = useFirebase();
            const currentMonth = new Date().toISOString().slice(0, 7);
            const [selectedMonth, setSelectedMonth] = useState(currentMonth);
            const [selectedShop, setSelectedShop] = useState('');
            const [selectedEmployeeId, setSelectedEmployeeId] = useState('');
            
            const allData = {
                shops: useCollection('shops').data,
                employees: useCollection('employees').data,
                attendance: useCollection('attendance').data,
                leaveRequests: useCollection('leaveRequests').data,
                otRequests: useCollection('otRequests').data,
                staffLoans: useCollection('staffLoans').data,
                employeeStates: useCollection('employeeStates').data,
                salaryRevisions: useCollection('salaryRevisions').data,
            };
            const { employees, shops } = allData;
            const allDataLoading = Object.values(allData).some(d => !d); // Simple check if any data array is missing

            const [manualLoanDeduction, setManualLoanDeduction] = useState(undefined);
            const [isProcessing, setIsProcessing] = useState(false);
            
            // NEW: States for Bulk Trigger functionality
            const [bulkSelectedMonth, setBulkSelectedMonth] = useState(currentMonth);
            const [bulkSelectedShop, setBulkSelectedShop] = useState('');
            const [triggerConfirmed, setTriggerConfirmed] = useState(false);
            const [isBulkProcessing, setIsBulkProcessing] = useState(false);
            const [processLog, setProcessLog] = useState([]);
            const [processComplete, setProcessComplete] = useState(false);
        
            const managedShops = useMemo(() => {
                if (!userProfile?.shop) return [];
                return Array.isArray(userProfile.shop) ? userProfile.shop : [userProfile.shop];
            }, [userProfile]);
        
            const isShopManager = userProfile?.role === 'Shop Manager';

            const selectedEmployee = useMemo(() => employees.find(emp => emp.id === selectedEmployeeId), [selectedEmployeeId, employees]);
            
            // Use the centralized calculator hook
            const { inputs: autoInputs, calculations } = usePayrollCalculator(selectedEmployee, selectedMonth, allData, manualLoanDeduction);

            // Effect to load editing record or reset form
            useEffect(() => {
                if (editingRecord) {
                    setSelectedMonth(editingRecord.month); 
                    setSelectedShop(editingRecord.shop); 
                    setSelectedEmployeeId(editingRecord.employeeId);
                    setManualLoanDeduction(editingRecord.manualInputs.loanDeduction);
                } else if (userProfile) {
                    if (userProfile.role === 'Admin' || isShopManager) { setSelectedShop(''); } 
                    else { setSelectedShop(userProfile.shop || ''); }
                    setSelectedEmployeeId(''); 
                    setSelectedMonth(currentMonth);
                    setManualLoanDeduction(undefined);
                }
            }, [editingRecord, userProfile, currentMonth, isShopManager]);
            
            // Effect to update manual loan deduction when auto-calculated value changes
            useEffect(() => {
                if (autoInputs.loanDeduction !== undefined && manualLoanDeduction === undefined) {
                    setManualLoanDeduction(autoInputs.loanDeduction);
                }
            }, [autoInputs.loanDeduction, manualLoanDeduction]);
            
            const handleManualLoanChange = (e) => {
                const value = e.target.value;
                setManualLoanDeduction(value === '' ? undefined : parseFloat(value));
            };
            
            const availableShops = useMemo(() => {
                if (userProfile?.role === 'Admin') return shops;
                if (isShopManager) {
                    return shops.filter(s => managedShops.includes(s.name));
                }
                return [];
            }, [shops, userProfile, isShopManager, managedShops]);

            const employeesForDropdown = useMemo(() => {
                let relevantEmployees = [];
                if (userProfile?.role === 'Admin') {
                     relevantEmployees = selectedShop 
                        ? employees.filter(e => Array.isArray(e.shop) ? e.shop.includes(selectedShop) : e.shop === selectedShop)
                        : employees;
                } else if (isShopManager) {
                    const shopsToFilter = selectedShop ? [selectedShop] : managedShops;
                    relevantEmployees = employees.filter(e => {
                        const employeeShops = Array.isArray(e.shop) ? e.shop : [e.shop];
                        return employeeShops.some(s => shopsToFilter.includes(s));
                    });
                } else { // Staff
                    relevantEmployees = employees.filter(e => e.shop === userProfile.shop);
                }
                return relevantEmployees.filter(e => e.status === 'Active');
            }, [selectedShop, employees, userProfile, isShopManager, managedShops]);

            const handleDownloadPayslip = () => {
                const payslipElement = document.getElementById('payslip-preview');
                if (!payslipElement || !selectedEmployee) { alert("Please select an employee to generate a payslip."); return; }
                const [year, month] = selectedMonth.split('-');
                const shopName = Array.isArray(selectedEmployee.shop) ? selectedEmployee.shop[0] : selectedEmployee.shop;
                html2canvas(payslipElement, { backgroundColor: '#ffffff', scale: 2 }).then(canvas => {
                    const link = document.createElement('a');
                    link.download = `${shopName}-${selectedEmployee.name}-${month}-${year.substring(2)}.png`;
                    link.href = canvas.toDataURL('image/png'); link.click();
                });
            };

            const handleSaveAndDownload = async () => {
                setIsProcessing(true);
                if (!selectedEmployee || calculations.netSalary === undefined) {
                    alert("Cannot process. Please ensure an employee is selected and payroll is calculated.");
                    setIsProcessing(false);
                    return;
                }
                const shopName = Array.isArray(selectedEmployee.shop) ? selectedEmployee.shop[0] : selectedEmployee.shop;
                const { addDoc, collection, serverTimestamp, doc, updateDoc, getDocs, query, where } = window.firebaseSDK;
                
                // NEW: Check for duplicates before saving, but only if it's NOT an edit
                if (!editingRecord) {
                    const payrollCheckQuery = query(collection(db, "payrollHistory"), where("employeeId", "==", selectedEmployee.id), where("month", "==", selectedMonth));
                    const existingPayrollSnap = await getDocs(payrollCheckQuery);
                    if (!existingPayrollSnap.empty) {
                        alert(`Payroll for ${selectedEmployee.name} for ${selectedMonth} has already been generated and saved.`);
                        setIsProcessing(false);
                        return; // Stop the function to prevent a duplicate
                    }
                }

                const finalInputs = { ...autoInputs, loanDeduction: manualLoanDeduction };
                const payrollData = { month: selectedMonth, shop: shopName, employeeId: selectedEmployee.id, employeeName: selectedEmployee.name, baseSalary: calculations.baseSalary, netSalary: calculations.netSalary, manualInputs: finalInputs, calculations: calculations };
                
                let success = false;
                try {
                    if (editingRecord) { await updateDoc(doc(db, 'payrollHistory', editingRecord.id), payrollData); } 
                    else { await addDoc(collection(db, 'payrollHistory'), { ...payrollData, createdAt: serverTimestamp() }); }
                    
                    if (finalInputs.loanDeduction > 0) {
                        const activeLoan = allData.staffLoans.find(loan => loan.staffId === selectedEmployee.id && loan.status === 'Active');
                        if (activeLoan) {
                            const newTotalPaid = (activeLoan.totalPaid || 0) + finalInputs.loanDeduction;
                            const newBalance = activeLoan.loanAmount - newTotalPaid;
                            const newStatus = newBalance <= 0 ? 'Paid Off' : 'Active';
                            await updateDoc(doc(db, 'staffLoans', activeLoan.id), { totalPaid: newTotalPaid, status: newStatus });
                            await addDoc(collection(db, 'loanPayments'), { paymentDate: `${selectedMonth}-${new Date(selectedMonth.split('-')[0], selectedMonth.split('-')[1], 0).getDate()}`, staffId: selectedEmployee.id, staffName: selectedEmployee.name, shop: shopName, loanId: activeLoan.id, amountPaid: finalInputs.loanDeduction, remainingBalance: newBalance, note: "Paid via payroll" });
                        }
                    }
                    alert('Payroll saved successfully!');
                    success = true;
                } catch (error) {
                    console.error("Error saving payroll: ", error);
                    alert('Failed to save payroll.');
                    success = false;
                }

                if (success) {
                    setTimeout(() => {
                        handleDownloadPayslip();
                        onSaveSuccess(selectedMonth);
                    }, 500);
                } else {
                    setIsProcessing(false);
                }
            };
            
            // NEW: Bulk Trigger Logic (moved from TriggerSalaryTab)
            const handleTriggerPayroll = async () => {
                if (!triggerConfirmed || !bulkSelectedShop || !bulkSelectedMonth) {
                    alert("Please select a shop, month, and confirm the action.");
                    return;
                }

                setIsBulkProcessing(true);
                setProcessLog([]);
                setProcessComplete(false);

                const { writeBatch, collection, doc, serverTimestamp, getDocs, query, where } = window.firebaseSDK;

                let employeesToProcess = [];
                if (bulkSelectedShop === 'ALL_SHOPS') {
                    employeesToProcess = employees.filter(e => e.status === 'Active');
                } else {
                    employeesToProcess = employees.filter(e => e.status === 'Active' && (Array.isArray(e.shop) ? e.shop.includes(bulkSelectedShop) : e.shop === bulkSelectedShop));
                }

                if (employeesToProcess.length === 0) {
                    setProcessLog(['No active employees found for the selected shop.']);
                    setIsBulkProcessing(false);
                    return;
                }
                
                if (bulkSelectedShop !== 'ALL_SHOPS') {
                    const payrollCheckQuery = query(collection(db, "payrollHistory"), where("month", "==", bulkSelectedMonth), where("shop", "==", bulkSelectedShop));
                    const existingPayrollSnap = await getDocs(payrollCheckQuery);
                    if (!existingPayrollSnap.empty) {
                         setProcessLog(prev => [...prev, `Warning: Payroll for ${bulkSelectedShop} for ${bulkSelectedMonth} may already exist. Please check history.`]);
                    }
                }

                setProcessLog(prev => [...prev, `Found ${employeesToProcess.length} employees. Starting payroll generation...`]);

                let successCount = 0;
                for (const employee of employeesToProcess) {
                    await new Promise(res => setTimeout(res, 50)); // Tiny delay for UI to update
                    setProcessLog(prev => [...prev, `[${successCount + 1}/${employeesToProcess.length}] Calculating for ${employee.name}...`]);

                    const { inputs, calculations } = calculatePayrollForEmployee(employee, bulkSelectedMonth, allData);
                    
                    if (calculations.netSalary !== undefined) {
                        const batch = writeBatch(db);
                        
                        const shopName = Array.isArray(employee.shop) ? employee.shop[0] : employee.shop;
                        const payrollData = { month: bulkSelectedMonth, shop: shopName, employeeId: employee.id, employeeName: employee.name, baseSalary: calculations.baseSalary, netSalary: calculations.netSalary, manualInputs: inputs, calculations: calculations, createdAt: serverTimestamp() };
                        
                        const payrollDocRef = doc(collection(db, "payrollHistory"));
                        batch.set(payrollDocRef, payrollData);
                        
                        if (inputs.loanDeduction > 0) {
                            const activeLoan = allData.staffLoans.find(loan => loan.staffId === employee.id && loan.status === 'Active');
                            if (activeLoan) {
                                const newTotalPaid = (activeLoan.totalPaid || 0) + inputs.loanDeduction;
                                const newBalance = activeLoan.loanAmount - newTotalPaid;
                                const newStatus = newBalance <= 0 ? 'Paid Off' : 'Active';
                                
                                const loanDocRef = doc(db, 'staffLoans', activeLoan.id);
                                batch.update(loanDocRef, { totalPaid: newTotalPaid, status: newStatus });
                                
                                const paymentDocRef = doc(collection(db, 'loanPayments'));
                                batch.set(paymentDocRef, { paymentDate: `${bulkSelectedMonth}-${new Date(bulkSelectedMonth.split('-')[0], bulkSelectedMonth.split('-')[1], 0).getDate()}`, staffId: employee.id, staffName: employee.name, shop: shopName, loanId: activeLoan.id, amountPaid: inputs.loanDeduction, remainingBalance: newBalance, note: "Paid via payroll trigger" });
                            }
                        }
                        
                        try {
                            await batch.commit();
                            successCount++;
                            setProcessLog(prev => [...prev.slice(0, -1), `[${successCount}/${employeesToProcess.length}] Successfully saved for ${employee.name}.`]);
                        } catch (error) {
                             setProcessLog(prev => [...prev.slice(0, -1), `[Error] Failed to save for ${employee.name}: ${error.message}`]);
                        }
                    } else {
                         setProcessLog(prev => [...prev.slice(0, -1), `[Skipped] Could not calculate salary for ${employee.name}.`]);
                    }
                }

                setProcessLog(prev => [...prev, `\nProcess finished. Successfully generated payroll for ${successCount} out of ${employeesToProcess.length} employees.`]);
                setIsBulkProcessing(false);
                setProcessComplete(true);
                setTriggerConfirmed(false); // Reset confirmation checkbox
            };
           
            const canSelectShop = (userProfile?.role === 'Admin' || isShopManager) && !editingRecord;
        
            return (
                <>
                    <div className="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <Card><CardTitle>Payroll Calculator</CardTitle><div className="space-y-6"><div className="grid grid-cols-1 md:grid-cols-3 gap-4"><div><label className="text-sm font-medium text-slate-400">Month</label><input type="month" value={selectedMonth} onChange={e => setSelectedMonth(e.target.value)} className="input" /></div><div><label className="text-sm font-medium text-slate-400">Shop</label>{canSelectShop ? (<select value={selectedShop} onChange={e => { setSelectedShop(e.target.value); setSelectedEmployeeId(''); }} className="select"><option value="">{userProfile?.role === 'Admin' ? 'All Shops' : 'All My Shops'}</option>{availableShops.map(s => <option key={s.id} value={s.name}>{s.name}</option>)}</select>) : (<input value={selectedShop} className="input" disabled />)}</div><div><label className="text-sm font-medium text-slate-400">Employee</label><select value={selectedEmployeeId} onChange={e => setSelectedEmployeeId(e.target.value)} className="select" disabled={employeesForDropdown.length === 0}><option value="">Select Employee</option>{employeesForDropdown.map(e => <option key={e.id} value={e.id}>{e.name}</option>)}</select></div></div>{selectedEmployee && (<><div className="grid grid-cols-1 md:grid-cols-3 gap-4 pt-6 border-t border-slate-700"><h3 className="md:col-span-3 text-lg font-semibold text-slate-200">Attendance & Deductions</h3><div><label className="text-sm">Work Days</label><input type="number" name="workDays" value={autoInputs.workDays ?? ''} className="input" disabled /></div><div><label className="text-sm">Given Off Days</label><input type="number" name="givenOffDays" value={autoInputs.givenOffDays ?? ''} className="input" disabled /></div><div><label className="text-sm">OT Days</label><input type="number" name="otDays" value={autoInputs.otDays ?? ''} className="input" disabled /></div><div><label className="text-sm">Leave Days</label><input type="number" name="leaveDays" value={autoInputs.leaveDays ?? ''} className="input" disabled /></div><div><label className="text-sm">Total Late Days</label><input type="number" name="totalLateDays" value={autoInputs.totalLateDays ?? ''} className="input" disabled /></div><div><label className="text-sm">Loan Deduction</label><input type="number" name="loanDeduction" value={manualLoanDeduction ?? ''} onChange={handleManualLoanChange} className="input" /></div></div><div className="pt-6 border-t border-slate-700 flex flex-col sm:flex-row gap-4">
                            <Button variant="primary" onClick={handleSaveAndDownload} disabled={isProcessing} className="flex-1">
                                {isProcessing ? (<><i className="fas fa-spinner fa-spin"></i> Processing...</>) : (<><i className="fas fa-save"></i> Save & Download</>)}
                            </Button>
                        </div></>)}</div></Card>
                        <PayslipPreview 
                            selectedEmployee={selectedEmployee}
                            selectedMonth={selectedMonth}
                            manualInputs={{...autoInputs, loanDeduction: manualLoanDeduction }}
                            calculations={calculations}
                        />
                    </div>
                    
                    {/* NEW: Bulk Trigger Section for Admins */}
                    {userProfile?.role === 'Admin' && (
                        <Card className="mt-8">
                            <CardTitle>Trigger Bulk Salary Calculation</CardTitle>
                            <div className="max-w-xl mx-auto space-y-6">
                                <p className="text-slate-400">This tool allows you to generate payroll for all active employees in a selected shop for a specific month. The results will be saved to the Payroll History.</p>
                                
                                <div>
                                    <label className="text-sm font-medium text-slate-400">Select Month</label>
                                    <input type="month" value={bulkSelectedMonth} onChange={e => setBulkSelectedMonth(e.target.value)} className="input" disabled={isBulkProcessing} />
                                </div>

                                <div>
                                    <label className="text-sm font-medium text-slate-400">Select Shop</label>
                                    <select value={bulkSelectedShop} onChange={e => setBulkSelectedShop(e.target.value)} className="select" disabled={isBulkProcessing}>
                                        <option value="">-- Select a Shop --</option>
                                        <option value="ALL_SHOPS">All Shops</option>
                                        {shops.map(s => <option key={s.id} value={s.name}>{s.name}</option>)}
                                    </select>
                                </div>
                                
                                <div className="p-4 border border-yellow-600 bg-yellow-900/20 rounded-lg space-y-3">
                                    <h4 className="font-bold text-yellow-300">Confirmation</h4>
                                    <div className="flex items-start">
                                        <input id="confirm-trigger" type="checkbox" checked={triggerConfirmed} onChange={e => setTriggerConfirmed(e.target.checked)} className="h-5 w-5 rounded border-gray-300 text-blue-600 focus:ring-blue-500 bg-slate-600 mt-1" disabled={isBulkProcessing} />
                                        <label htmlFor="confirm-trigger" className="ml-3 text-sm text-slate-300">I understand that this action will generate and save payroll records for all employees in the selected shop and month. This does not automatically check for duplicates.</label>
                                    </div>
                                </div>

                                <Button 
                                    onClick={handleTriggerPayroll} 
                                    disabled={!triggerConfirmed || isBulkProcessing || !bulkSelectedShop || allDataLoading}
                                    variant="danger"
                                    className="w-full py-3 text-base"
                                >
                                    {isBulkProcessing ? <><i className="fas fa-spinner fa-spin"></i> Processing...</> : <><i className="fas fa-bolt"></i> Trigger Payroll Generation</>}
                                </Button>
                                
                                {(isBulkProcessing || processLog.length > 0) && (
                                    <div className="mt-6">
                                        <h4 className="font-semibold text-slate-200">Processing Log:</h4>
                                        <pre className="mt-2 bg-slate-900/70 p-4 rounded-lg text-sm text-slate-300 h-64 overflow-y-auto font-mono">
                                            {processLog.join('\n')}
                                        </pre>
                                    </div>
                                )}
                                {processComplete && (
                                     <div className="mt-4 p-4 text-center bg-green-900/50 border border-green-700 rounded-lg">
                                        <p className="font-semibold text-green-300">Process Complete!</p>
                                    </div>
                                )}
                            </div>
                        </Card>
                    )}
                </>
            );
        };

        const PayrollHistoryTab = ({ onEdit, userProfile }) => {
            const { db } = useFirebase();
            const { data: history } = useCollection('payrollHistory');
            const { data: shops } = useCollection('shops');
            const [recordToDelete, setRecordToDelete] = useState(null);
            const [selectedShop, setSelectedShop] = useState('');
            const [selectedMonth, setSelectedMonth] = useState(new Date().toISOString().slice(0, 7));
            
            // NEW: Determine if the user is a multi-shop manager and can filter
            const isMultiShopManager = userProfile?.role === 'Shop Manager' && Array.isArray(userProfile.shop) && userProfile.shop.length > 1;
            const canFilterByShop = userProfile?.role === 'Admin' || isMultiShopManager;

            const availableShopsForFilter = useMemo(() => {
                if (userProfile?.role === 'Admin') return shops;
                if (isMultiShopManager) {
                    // Map shop names to the structure expected by the select dropdown
                    return userProfile.shop.map(name => ({ id: name, name: name }));
                }
                return [];
            }, [shops, userProfile, isMultiShopManager]);
            
            // NEW: Set initial shop state based on user role
            useEffect(() => { if (userProfile && userProfile.role !== 'Admin') setSelectedShop(Array.isArray(userProfile.shop) ? '' : userProfile.shop || ''); }, [userProfile]);

            const { filteredHistory, totals } = useMemo(() => {
                const filtered = history.filter(rec => {
                    if (!rec.month) return false;
                    
                    // Filter by selected month
                    const dateMatch = !selectedMonth || rec.month === selectedMonth;
                    if (!dateMatch) return false;

                    // **BUG FIX**: Implement correct role-based shop filtering
                    if (userProfile.role === 'Admin') {
                        // Admin: If a shop is selected, filter by it. Otherwise, show all.
                        return !selectedShop || rec.shop === selectedShop;
                    } 
                    else if (userProfile.role === 'Shop Manager') {
                        const managedShops = Array.isArray(userProfile.shop) ? userProfile.shop : (userProfile.shop ? [userProfile.shop] : []);
                        if (selectedShop) {
                            // A specific shop is selected from the dropdown
                            return rec.shop === selectedShop;
                        } else {
                            // "All My Shops" is selected, check if record's shop is in the manager's list
                            return managedShops.includes(rec.shop);
                        }
                    }
                    // Default for other roles (e.g., Staff)
                    return !selectedShop || rec.shop === selectedShop;
                });

                const sorted = [...filtered].sort((a,b) => (b.createdAt?.toDate() || 0) - (a.createdAt?.toDate() || 0));
                const totals = sorted.reduce((acc, curr) => { 
                    acc.baseSalary += curr.baseSalary || 0; 
                    acc.engagements += curr.calculations?.engagements || 0;
                    acc.otSalary += curr.calculations?.otSalary || 0;
                    acc.loanDeduction += curr.manualInputs?.loanDeduction || 0; 
                    acc.otherDeductions += curr.calculations?.otherDeductions || 0;
                    acc.netSalary += curr.netSalary || 0; 
                    return acc; 
                }, { baseSalary: 0, engagements: 0, otSalary: 0, loanDeduction: 0, otherDeductions: 0, netSalary: 0 });
                return { filteredHistory: sorted, totals };
            }, [history, selectedShop, selectedMonth, userProfile]);

            const handleDelete = async () => {
                if (!recordToDelete) return;
                try { await window.firebaseSDK.deleteDoc(window.firebaseSDK.doc(db, 'payrollHistory', recordToDelete.id)); setRecordToDelete(null); } 
                catch (error) { console.error("Error deleting payroll record:", error); setRecordToDelete(null); }
            };

            return (
                <Card>
                    <div className="flex flex-wrap gap-4 justify-between items-center mb-6"><CardTitle>Payroll History</CardTitle><div className="flex flex-wrap gap-4 items-center">
                        {canFilterByShop && (
                            <select value={selectedShop} onChange={e => setSelectedShop(e.target.value)} className="select w-full sm:w-auto">
                                <option value="">{userProfile.role === 'Admin' ? 'All Shops' : 'All My Shops'}</option>
                                {availableShopsForFilter.map(s => <option key={s.id} value={s.name}>{s.name}</option>)}
                            </select>
                        )}
                        <input type="month" value={selectedMonth} onChange={e => setSelectedMonth(e.target.value)} className="input w-full sm:w-auto" />
                    </div></div>
                    <div className="overflow-x-auto"><table className="min-w-full divide-y divide-slate-700"><thead className="bg-slate-900/50"><tr><th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Date</th><th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Shop Name</th><th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Employee</th><th className="px-4 py-3 text-right text-xs font-semibold text-slate-400 uppercase">Base Salary</th><th className="px-4 py-3 text-right text-xs font-semibold text-slate-400 uppercase">Engagements</th><th className="px-4 py-3 text-right text-xs font-semibold text-slate-400 uppercase">OT Salary</th><th className="px-4 py-3 text-right text-xs font-semibold text-slate-400 uppercase">Loan Deduction</th><th className="px-4 py-3 text-right text-xs font-semibold text-slate-400 uppercase">Other Deductions</th><th className="px-4 py-3 text-right text-xs font-semibold text-slate-400 uppercase">Final Salary</th><th className="px-4 py-3 text-center text-xs font-semibold text-slate-400 uppercase">Actions</th></tr></thead><tbody className="divide-y divide-slate-700">{filteredHistory.map(rec => (<tr key={rec.id} className="hover:bg-slate-700/50"><td className="px-4 py-4 text-sm text-slate-200">{rec.month}</td><td className="px-4 py-4 text-sm text-slate-300">{rec.shop}</td><td className="px-4 py-4 text-sm text-slate-300">{rec.employeeName}</td><td className="px-4 py-4 text-sm text-slate-300 text-right">{Utils.formatCurrency(rec.baseSalary)}</td><td className="px-4 py-4 text-sm text-slate-300 text-right">{Utils.formatCurrency(rec.calculations?.engagements)}</td><td className="px-4 py-4 text-sm text-slate-300 text-right">{Utils.formatCurrency(rec.calculations?.otSalary)}</td><td className="px-4 py-4 text-sm text-slate-300 text-right">{Utils.formatCurrency(rec.manualInputs?.loanDeduction)}</td><td className="px-4 py-4 text-sm text-slate-300 text-right">{Utils.formatCurrency(rec.calculations?.otherDeductions)}</td><td className="px-4 py-4 text-sm text-slate-300 text-right font-semibold">{Utils.formatCurrency(rec.netSalary)}</td><td className="px-4 py-4 text-center whitespace-nowrap"><div className="flex items-center justify-center gap-4">{(userProfile?.role === 'Admin' || userProfile?.role === 'Shop Manager') && (<><Button variant="icon-edit" icon="fa-edit" onClick={() => onEdit(rec)} title="Edit" /><Button variant="icon-delete" icon="fa-trash" onClick={() => setRecordToDelete(rec)} title="Delete" /></>)}</div></td></tr>))}</tbody><tfoot className="bg-slate-900/50"><tr><td colSpan="3" className="px-4 py-3 text-right font-bold text-slate-300 uppercase">Sub-Total</td><td className="px-4 py-3 text-right font-bold text-slate-300">{Utils.formatCurrency(totals.baseSalary)}</td><td className="px-4 py-3 text-right font-bold text-slate-300">{Utils.formatCurrency(totals.engagements)}</td><td className="px-4 py-3 text-right font-bold text-slate-300">{Utils.formatCurrency(totals.otSalary)}</td><td className="px-4 py-3 text-right font-bold text-slate-300">{Utils.formatCurrency(totals.loanDeduction)}</td><td className="px-4 py-3 text-right font-bold text-slate-300">{Utils.formatCurrency(totals.otherDeductions)}</td><td className="px-4 py-3 text-right font-bold text-slate-300">{Utils.formatCurrency(totals.netSalary)}</td><td></td></tr></tfoot></table></div>
                    <ConfirmationModal isOpen={!!recordToDelete} onClose={() => setRecordToDelete(null)} onConfirm={handleDelete} title="Delete Payroll Record" message="Are you sure you want to delete this payroll record? This action cannot be undone." />
                </Card>
            );
        };

        const EmployeeStateTab = ({ userProfile }) => {
            const { db } = useFirebase();
            const fileInputRef = useRef(null); // For triggering file upload
            const [isImporting, setIsImporting] = useState(false);
            const [importResult, setImportResult] = useState(null);
            const [isModalOpen, setModalOpen] = useState(false);
            const [editingRecord, setEditingRecord] = useState(null);
            const [recordToDelete, setRecordToDelete] = useState(null);
            const { where } = window.firebaseSDK;

            const queryConstraints = useMemo(() => {
                if (!userProfile) return [where("staffId", "==", "null")];
                if (userProfile.role === 'Admin') return [];
                if (userProfile.role === 'Shop Manager') {
                    const shops = Array.isArray(userProfile.shop) ? userProfile.shop : (userProfile.shop ? [userProfile.shop] : []);
                    if (shops.length > 0) {
                        return [where("shop", "in", shops)];
                    }
                    return [where("staffId", "==", "null")]; // No shops, no data
                }
                // Staff can only see their own records.
                return [where("staffId", "==", userProfile.id || null)];
            }, [userProfile]);

            const { data: employeeStates } = useCollection('employeeStates', queryConstraints);
            const { data: shops } = useCollection('shops');
            const { data: employees } = useCollection('employees');
            const [selectedShop, setSelectedShop] = useState('');
            const [selectedMonth, setSelectedMonth] = useState(new Date().toISOString().slice(0, 7));
            const [selectedEmployeeId, setSelectedEmployeeId] = useState('');

            useEffect(() => {
                if (userProfile && userProfile.role !== 'Admin') {
                    // For managers with multiple shops, default to showing all their shops.
                    // For single-shop users, their shop is pre-selected.
                    setSelectedShop(Array.isArray(userProfile.shop) ? '' : userProfile.shop || '');
                }
            }, [userProfile]);

            const availableShops = useMemo(() => {
                if (userProfile?.role === 'Admin') return shops;
                if (userProfile?.role === 'Shop Manager' && Array.isArray(userProfile.shop)) {
                    return shops.filter(s => userProfile.shop.includes(s.name));
                }
                return [];
            }, [shops, userProfile]);

            const employeesInShop = useMemo(() => {
                if (!selectedShop) return [];
                return employees.filter(emp => {
                    const employeeShops = Array.isArray(emp.shop) ? emp.shop : [emp.shop];
                    return employeeShops.includes(selectedShop) && emp.status === 'Active';
                });
            }, [selectedShop, employees]);

            const filteredRecords = useMemo(() => {
                const records = employeeStates.filter(rec => 
                    (!selectedShop || rec.shop === selectedShop) &&
                    (!selectedMonth || rec.date.startsWith(selectedMonth)) &&
                    (!selectedEmployeeId || rec.staffId === selectedEmployeeId)
                );
                
                // Sort records: Pending first, then by date descending
                return records.sort((a, b) => {
                    if (a.status === 'Pending' && b.status !== 'Pending') return -1;
                    if (a.status !== 'Pending' && b.status === 'Pending') return 1;
                    return new Date(b.date) - new Date(a.date);
                });
            }, [employeeStates, selectedShop, selectedMonth, selectedEmployeeId]);
            
            const handleOpenModal = (record = null) => { setEditingRecord(record); setModalOpen(true); };
            const handleCloseModal = () => { setEditingRecord(null); setModalOpen(false); };

            const handleSave = async (formData) => {
                const { addDoc, collection, doc, updateDoc } = window.firebaseSDK;
                const staffName = employees.find(e => e.id === formData.staffId)?.name || '';
                const dataToSave = { ...formData, amount: parseFloat(formData.amount) || 0, staffName: staffName };

                // Add approval status for new records
                if (!formData.id) {
                    dataToSave.status = dataToSave.statusState === 'Engagement' ? 'Pending' : 'Approved';
                }

                try {
                    if (formData.id) { const { id, ...data } = dataToSave; await updateDoc(doc(db, 'employeeStates', id), data); } 
                    else { await addDoc(collection(db, 'employeeStates'), dataToSave); }
                    handleCloseModal();
                } catch (error) { console.error("Error saving employee state:", error); }
            };

            const handleDelete = async () => {
                if (!recordToDelete) return;
                try {
                    await window.firebaseSDK.deleteDoc(window.firebaseSDK.doc(db, 'employeeStates', recordToDelete.id));
                    setRecordToDelete(null);
                } catch (error) { console.error("Error deleting record:", error); setRecordToDelete(null); }
            };

            const handleUpdateStatus = useCallback(async (recordId, newStatus) => {
                if (!recordId || !newStatus) return;
                try {
                    await window.firebaseSDK.updateDoc(window.firebaseSDK.doc(db, 'employeeStates', recordId), { status: newStatus });
                } catch (error) {
                    console.error(`Error updating record ${recordId} status:`, error);
                }
            }, [db]);

            // NEW: Function to download the Excel template
            const handleDownloadTemplate = useCallback(() => {
                const templateData = [
                    { employeeId: '(Optional)', staffName: 'Example Staff Name', shop: 'Example Shop Name', date: '2025-09-26', statusState: 'Deduction', amount: 5000, note: 'Sample reason' },
                ];
                // Explicitly set the header order
                const worksheet = XLSX.utils.json_to_sheet(templateData, { header: ["employeeId", "staffName", "shop", "date", "statusState", "amount", "note"] });
                const workbook = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(workbook, worksheet, "Template");
                worksheet["!cols"] = [ { wch: 20 }, { wch: 25 }, { wch: 20 }, { wch: 12 }, { wch: 15 }, { wch: 15 }, { wch: 40 } ];
                XLSX.writeFile(workbook, "Engagement_Deduction_Template.xlsx");
            }, []);

            // NEW: Function to trigger the hidden file input
            const triggerFileUpload = () => {
                if (fileInputRef.current) {
                    fileInputRef.current.value = ""; // Allow re-uploading the same file
                }
                fileInputRef.current.click();
            };
            
            // NEW: Function to handle the file upload and processing
            const handleFileChange = (e) => {
                const file = e.target.files[0];
                if (!file) return;

                setIsImporting(true);
                setImportResult(null);

                const reader = new FileReader();
                reader.onload = async (event) => {
                    try {
                        const data = new Uint8Array(event.target.result);
                        const workbook = XLSX.read(data, { type: "array", cellDates: true });
                        const sheetName = workbook.SheetNames[0];
                        const worksheet = workbook.Sheets[sheetName];
                        // Convert dates to YYYY-MM-DD format string to avoid timezone issues
                        const json = XLSX.utils.sheet_to_json(worksheet, { raw: false, dateNF: 'yyyy-mm-dd' });

                        if (json.length === 0) {
                            setImportResult({ success: false, message: 'The Excel file is empty or in the wrong format.' });
                            setIsImporting(false);
                            return;
                        }

                        const { collection, writeBatch, doc } = window.firebaseSDK;
                        const batch = writeBatch(db);
                        let errors = [];
                        let successCount = 0;

                        json.forEach((row, index) => {
                            const rowNum = index + 2;
                            const employeeId = row.employeeId?.trim();
                            const staffName = row.staffName?.trim();
                            const shopName = row.shop?.trim();
                            const statusState = row.statusState?.trim();
                            
                            if ((!employeeId && !staffName) || !row.date || !statusState || row.amount === undefined) {
                                errors.push(`Row ${rowNum}: Missing required data (employeeId/staffName, shop, date, statusState, amount).`);
                                return;
                            }
                            
                            let employee;
                            // Prioritize finding employee by ID for accuracy
                            if (employeeId && employeeId !== '(Optional)') {
                                employee = employees.find(e => e.id === employeeId && e.status === 'Active');
                                if (!employee) {
                                    errors.push(`Row ${rowNum}: Active employee with ID "${employeeId}" not found.`);
                                    return;
                                }
                            } else {
                                // Fallback to name if ID is not provided
                                employee = employees.find(e => e.name.toLowerCase() === staffName.toLowerCase() && e.status === 'Active');
                                if (!employee) {
                                    errors.push(`Row ${rowNum}: Active staff member "${staffName}" not found.`);
                                    return;
                                }
                            }

                            if (statusState !== 'Engagement' && statusState !== 'Deduction') {
                                errors.push(`Row ${rowNum}: Invalid statusState "${statusState}". Must be 'Engagement' or 'Deduction'.`);
                                return;
                            }
                            
                            const targetShop = shopName || (Array.isArray(employee.shop) ? employee.shop[0] : employee.shop);
                            if (!targetShop) {
                                errors.push(`Row ${rowNum}: Shop for "${employee.name}" could not be determined. Please specify a shop in the template or employee profile.`);
                                return;
                            }
                             // Validate that the shop from the file is one of the employee's assigned shops
                            const employeeShops = Array.isArray(employee.shop) ? employee.shop : [employee.shop];
                            if (!employeeShops.includes(targetShop)) {
                                errors.push(`Row ${rowNum}: Shop "${targetShop}" is not an assigned shop for ${employee.name}.`);
                                return;
                            }

                            const newRecord = {
                                staffId: employee.id, staffName: employee.name,
                                shop: targetShop,
                                date: row.date, statusState: statusState,
                                amount: parseFloat(row.amount) || 0,
                                note: row.note || '',
                                status: statusState === 'Engagement' ? 'Pending' : 'Approved'
                            };
                            
                            const newDocRef = doc(collection(db, 'employeeStates'));
                            batch.set(newDocRef, newRecord);
                            successCount++;
                        });

                        if (errors.length > 0) {
                            setImportResult({ success: false, message: `Import failed with ${errors.length} error(s):`, errors });
                        } else if (successCount > 0) {
                            await batch.commit();
                            setImportResult({ success: true, message: `Successfully imported ${successCount} records.` });
                        } else {
                             setImportResult({ success: false, message: 'No valid records found to import.' });
                        }
                    } catch (error) {
                        console.error("Error processing Excel file:", error);
                        setImportResult({ success: false, message: `An error occurred during import: ${error.message}` });
                    } finally {
                        setIsImporting(false);
                    }
                };
                reader.readAsArrayBuffer(file);
            };

            const handleExportExcel = useCallback(() => {
                const dataToExport = filteredRecords.map(rec => ({
                    'Date': rec.date,
                    'Shop': rec.shop,
                    'Staff Name': rec.staffName,
                    'Status': rec.statusState,
                    'Amount (KHR)': parseFloat(String(rec.amount).replace(/[^0-9.-]/g, '')) || 0,
                    'Reason / Note': rec.note,
                }));
                const worksheet = XLSX.utils.json_to_sheet(dataToExport);
                const workbook = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(workbook, worksheet, "Employee States");
                
                worksheet["!cols"] = [ { wch: 12 }, { wch: 15 }, { wch: 25 }, { wch: 15 }, { wch: 15 }, { wch: 40 } ];
                
                XLSX.writeFile(workbook, `Employee_State_Report_${selectedMonth}.xlsx`);
            }, [filteredRecords, selectedMonth]);
            
            return (
                <Card>
                    <div className="flex flex-wrap gap-4 justify-between items-center mb-6">
                        <h3 className="text-xl font-semibold text-slate-100">Engagements / Deductions</h3>
                        <div className="flex flex-wrap gap-4 items-center">
                             {(userProfile.role === 'Admin' || (userProfile.role === 'Shop Manager' && Array.isArray(userProfile.shop))) && (
                                <select value={selectedShop} onChange={e => { setSelectedShop(e.target.value); setSelectedEmployeeId(''); }} className="select w-full sm:w-auto">
                                    <option value="">{userProfile.role === 'Admin' ? 'All Shops' : 'All My Shops'}</option>
                                    {availableShops.map(s => <option key={s.id} value={s.name}>{s.name}</option>)}
                                </select>
                            )}
                            {(userProfile.role === 'Admin' || userProfile.role === 'Shop Manager') && selectedShop && (
                                <select value={selectedEmployeeId} onChange={e => setSelectedEmployeeId(e.target.value)} className="select w-full sm:w-auto">
                                    <option value="">All Staff</option>
                                    {employeesInShop.map(e => <option key={e.id} value={e.id}>{e.name}</option>)}
                                </select>
                            )}
                            <input type="month" value={selectedMonth} onChange={e => setSelectedMonth(e.target.value)} className="input w-full sm:w-auto" />
                            {(userProfile?.role === 'Admin' || userProfile?.role === 'Shop Manager') && (
                                <Button variant="primary" icon="fa-plus" onClick={() => handleOpenModal()}>Add New</Button>
                            )}
                            {userProfile?.role === 'Admin' && (
                                <>
                                    <input
                                        type="file"
                                        ref={fileInputRef}
                                        onChange={handleFileChange}
                                        className="hidden"
                                        accept=".xlsx, .xls"
                                    />
                                    <Button 
                                        variant="secondary" 
                                        icon="fa-download"
                                        onClick={handleDownloadTemplate}
                                    >
                                        Template
                                    </Button>
                                    <Button 
                                        variant="secondary" 
                                        icon="fa-upload"
                                        onClick={triggerFileUpload}
                                        disabled={isImporting}
                                    >
                                        {isImporting ? 'Importing...' : 'Import'}
                                    </Button>
                                </>
                            )}
                             <Button variant="success" icon="fa-file-excel" onClick={handleExportExcel}>Excel</Button>
                        </div>
                    </div>
                    {/* Desktop Table */}
                    <div className="overflow-x-auto"><table className="min-w-full divide-y divide-slate-700"><thead className="bg-slate-900/50"><tr><th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Date</th><th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Shop</th><th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Staff</th><th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Type</th><th className="px-4 py-3 text-right text-xs font-semibold text-slate-400 uppercase">Amount</th><th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Reason</th><th className="px-4 py-3 text-center text-xs font-semibold text-slate-400 uppercase">Status</th><th className="px-4 py-3 text-center text-xs font-semibold text-slate-400 uppercase">Actions</th></tr></thead><tbody className="divide-y divide-slate-700">{filteredRecords.map(record => (<tr key={record.id} className="hover:bg-slate-700/50"><td className="px-4 py-4 text-sm text-slate-200">{record.date}</td><td className="px-4 py-4 text-sm text-slate-300">{record.shop}</td><td className="px-4 py-4 text-sm text-slate-300">{record.staffName}</td><td className="px-4 py-4 text-sm text-slate-300">{record.statusState}</td><td className="px-4 py-4 text-sm text-slate-300 text-right">{Utils.formatCurrency(record.amount)}</td><td className="px-4 py-4 text-sm text-slate-300">{record.note}</td><td className="px-4 py-4 text-center text-sm">{record.statusState === 'Engagement' && (<span className={`px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${ record.status === 'Approved' ? 'bg-green-100 text-green-800' : record.status === 'Rejected' ? 'bg-red-100 text-red-800' : 'bg-yellow-100 text-yellow-800' }`}>{record.status || 'Pending'}</span>)}</td><td className="px-4 py-4 text-center whitespace-nowrap"><div className="flex items-center justify-center gap-4">{(userProfile?.role === 'Admin' || userProfile?.role === 'Shop Manager') && record.statusState === 'Engagement' && record.status === 'Pending' && (<><Button variant="icon-approve" icon="fa-check-circle" onClick={() => handleUpdateStatus(record.id, 'Approved')} title="Approve" /><Button variant="icon-reject" icon="fa-times-circle" onClick={() => handleUpdateStatus(record.id, 'Rejected')} title="Reject" /></>)}{(userProfile?.role === 'Admin' || userProfile?.role === 'Shop Manager') && (<><Button variant="icon-edit" icon="fa-edit" onClick={() => handleOpenModal(record)} title="Edit" /><Button variant="icon-delete" icon="fa-trash" onClick={() => setRecordToDelete(record)} title="Delete" /></>)}</div></td></tr>))}</tbody></table></div>
                    <EmployeeStateModal isOpen={isModalOpen} onClose={handleCloseModal} onSave={handleSave} record={editingRecord} userProfile={userProfile} />
                    <ConfirmationModal isOpen={!!recordToDelete} onClose={() => setRecordToDelete(null)} onConfirm={handleDelete} title="Delete Record" message="Are you sure you want to delete this record?" />
                    {/* NEW: Modal to show import results */}
                    <Modal isOpen={!!importResult} onClose={() => setImportResult(null)} maxWidth="max-w-2xl">
                        <ModalHeader title="Import Result" onClose={() => setImportResult(null)} />
                        <ModalBody>
                            {importResult && (
                                <div>
                                    <p className={`font-bold ${importResult.success ? 'text-green-400' : 'text-red-400'}`}>
                                        {importResult.message}
                                    </p>
                                    {importResult.errors && (
                                        <ul className="mt-4 list-disc list-inside space-y-1 text-slate-300 bg-slate-700 p-4 rounded-md max-h-60 overflow-y-auto">
                                            {importResult.errors.map((err, i) => <li key={i}>{err}</li>)}
                                        </ul>
                                    )}
                                </div>
                            )}
                        </ModalBody>
                        <ModalFooter>
                            <Button variant="primary" onClick={() => setImportResult(null)}>Close</Button>
                        </ModalFooter>
                    </Modal>
                </Card>
            );
        };

        const EmployeeStateModal = ({ isOpen, onClose, onSave, record, userProfile }) => {
            const [formData, setFormData] = useState({});
            const [selectedShop, setSelectedShop] = useState('');
            const { data: shops } = useCollection('shops');
            const { data: employees } = useCollection('employees');

            const availableShops = useMemo(() => {
                if (!userProfile) return [];
                if (userProfile.role === 'Admin') return shops;
                
                const managedShops = Array.isArray(userProfile.shop) ? userProfile.shop : (userProfile.shop ? [userProfile.shop] : []);
                if (managedShops.length > 0) {
                    return shops.filter(s => managedShops.includes(s.name));
                }
                return [];
            }, [shops, userProfile]);

            const canSelectShop = useMemo(() => {
                if (!userProfile) return false;
                if (userProfile.role === 'Admin') return true;
                if (userProfile.role === 'Shop Manager' && Array.isArray(userProfile.shop) && userProfile.shop.length > 1) return true;
                return false;
            }, [userProfile]);

            useEffect(() => {
                let initialShop = '';
                if (!record && userProfile) { // Set default shop for NEW records based on user profile
                     if (userProfile.role !== 'Admin') {
                        const managedShops = Array.isArray(userProfile.shop) ? userProfile.shop : (userProfile.shop ? [userProfile.shop] : []);
                        if (managedShops.length === 1) {
                            initialShop = managedShops[0];
                        }
                     }
                }

                const initialData = record 
                    ? { ...record } 
                    : { date: new Date().toISOString().substring(0, 10), shop: initialShop, staffId: '', statusState: 'Deduction', amount: '', note: '' };
                
                setFormData(initialData);
                setSelectedShop(initialData.shop || '');
            }, [record, isOpen, userProfile]);
            
            const employeesInShop = useMemo(() => {
                if (!selectedShop) return [];
                return employees.filter(emp => {
                    const employeeShops = Array.isArray(emp.shop) ? emp.shop : [emp.shop];
                    return employeeShops.includes(selectedShop) && emp.status === 'Active';
                });
            }, [selectedShop, employees]);
            
            const handleChange = (e) => {
                const { name, value } = e.target;
                setFormData(prev => ({ ...prev, [name]: value }));
                if (name === 'shop') { 
                    setSelectedShop(value); 
                    setFormData(prev => ({ ...prev, staffId: '' })); // Reset staff selection when shop changes
                }
            };

            const handleSubmit = (e) => { 
                e.preventDefault(); 
                if (!formData.shop || !formData.staffId || !formData.amount) { 
                    alert("Please fill all required fields."); 
                    return; 
                } 
                onSave(formData); 
            };

            return (
                <Modal isOpen={isOpen} onClose={onClose}>
                    <form onSubmit={handleSubmit}>
                        <ModalHeader title={record ? "Edit Record" : "Add New Record"} onClose={onClose} />
                        <ModalBody>
                            <div className="space-y-4">
                                <div><label className="text-sm">Date</label><input type="date" name="date" value={formData.date || ''} onChange={handleChange} className="input"/></div>
                                <div>
                                    <label className="text-sm">Shop</label>
                                    <select name="shop" value={formData.shop || ''} onChange={handleChange} className="select" disabled={!canSelectShop}>
                                        <option value="">Select Shop</option>
                                        {availableShops.map(s => <option key={s.id} value={s.name}>{s.name}</option>)}
                                    </select>
                                </div>
                                <div><label className="text-sm">Staff</label><select name="staffId" value={formData.staffId || ''} onChange={handleChange} className="select" disabled={!selectedShop}><option value="">Select Staff</option>{employeesInShop.map(e => <option key={e.id} value={e.id}>{e.name}</option>)}</select></div>
                                <div><label className="text-sm">Status State</label><select name="statusState" value={formData.statusState || 'Deduction'} onChange={handleChange} className="select"><option>Deduction</option><option>Engagement</option></select></div>
                                <div><label className="text-sm">Amount (KHR)</label><input type="number" name="amount" value={formData.amount || ''} onChange={handleChange} className="input"/></div>
                                <div><label className="text-sm">Reason / Note</label><textarea name="note" value={formData.note || ''} onChange={handleChange} className="input" rows="3"></textarea></div>
                            </div>
                        </ModalBody>
                        <ModalFooter>
                            <Button variant="secondary" onClick={onClose}>Cancel</Button>
                            <Button type="submit" variant="primary" className="px-6">Save Record</Button>
                        </ModalFooter>
                    </form>
                </Modal>
            );
        };
        // --- END PAYROLL PAGE ---

        // --- START EXPENSE REPORT PAGE ---
        const ExpenseReportPage = () => {
            const { data: payrollHistory } = useCollection('payrollHistory');
            const { data: shops } = useCollection('shops');
            const [selectedShop, setSelectedShop] = useState('');
            const [selectedMonth, setSelectedMonth] = useState(new Date().toISOString().slice(0, 7));

            const { expenseSummary, totals } = useMemo(() => {
                if (!payrollHistory.length) return { expenseSummary: [], totals: {} };
                const filteredHistory = payrollHistory.filter(rec => (!selectedShop || rec.shop === selectedShop) && (!selectedMonth || rec.month === selectedMonth));
                
                // Group payroll records by shop and month
                const summary = filteredHistory.reduce((acc, rec) => {
                    if (!rec.shop || !rec.month) return acc;
                    const key = `${rec.shop}_${rec.month}`;
                    if (!acc[key]) { acc[key] = { month: rec.month, shopName: rec.shop, totalLoanDed: 0, totalOtherDed: 0, totalFinalSalary: 0 }; }
                    acc[key].totalLoanDed += parseFloat(rec.manualInputs?.loanDeduction) || 0;
                    acc[key].totalOtherDed += parseFloat(rec.calculations?.otherDeductions) || 0;
                    acc[key].totalFinalSalary += parseFloat(rec.netSalary) || 0;
                    return acc;
                }, {});

                const summaryArray = Object.values(summary).map(item => {
                    const accountNote = (item.totalFinalSalary || 0) + (item.totalLoanDed || 0) + (item.totalOtherDed || 0);
                    return { ...item, accountNote };
                }).sort((a, b) => b.month.localeCompare(a.month) || a.shopName.localeCompare(b.shopName));

                const totals = summaryArray.reduce((acc, curr) => { 
                    acc.totalLoanDed += curr.totalLoanDed; 
                    acc.totalOtherDed += curr.totalOtherDed; 
                    acc.totalFinalSalary += curr.totalFinalSalary; 
                    acc.totalAccountNote += curr.accountNote;
                    return acc; 
                }, { totalLoanDed: 0, totalOtherDed: 0, totalFinalSalary: 0, totalAccountNote: 0 });
                
                return { expenseSummary: summaryArray, totals };
            }, [payrollHistory, selectedShop, selectedMonth]);

            return (
                <Card>
                    <div className="flex flex-wrap gap-4 justify-between items-center mb-6"><CardTitle>Expense Report Summary</CardTitle><div className="flex flex-wrap gap-4 items-center"><select value={selectedShop} onChange={e => setSelectedShop(e.target.value)} className="select w-full sm:w-auto"><option value="">All Shops</option>{shops.map(s => <option key={s.id} value={s.name}>{s.name}</option>)}</select><input type="month" value={selectedMonth} onChange={e => setSelectedMonth(e.target.value)} className="input w-full sm:w-auto" /></div></div>
                    <div className="overflow-x-auto"><table className="min-w-full divide-y divide-slate-700"><thead className="bg-slate-900/50"><tr><th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Month</th><th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Shop Name</th><th className="px-4 py-3 text-right text-xs font-semibold text-slate-400 uppercase">Total Loan Ded.</th><th className="px-4 py-3 text-right text-xs font-semibold text-slate-400 uppercase">Total Other Ded.</th><th className="px-4 py-3 text-right text-xs font-semibold text-slate-400 uppercase">Total Final Salary</th><th className="px-4 py-3 text-right text-xs font-semibold text-slate-400 uppercase">Account Note</th></tr></thead><tbody className="divide-y divide-slate-700">{expenseSummary.map((item, index) => (<tr key={index} className="hover:bg-slate-700/50"><td className="px-4 py-4 text-sm text-slate-200">{item.month}</td><td className="px-4 py-4 text-sm text-slate-300">{item.shopName}</td><td className="px-4 py-4 text-sm text-slate-300 text-right">{Utils.formatCurrency(item.totalLoanDed)}</td><td className="px-4 py-4 text-sm text-slate-300 text-right">{Utils.formatCurrency(item.totalOtherDed)}</td><td className="px-4 py-4 text-sm text-slate-300 text-right font-semibold">{Utils.formatCurrency(item.totalFinalSalary)}</td><td className="px-4 py-4 text-sm text-slate-300 text-right font-semibold">{Utils.formatCurrency(item.accountNote)}</td></tr>))}</tbody><tfoot className="bg-slate-900/50"><tr><td colSpan="2" className="px-4 py-3 text-right font-bold text-slate-300 uppercase">Sub-Total</td><td className="px-4 py-3 text-right font-bold text-slate-300">{Utils.formatCurrency(totals.totalLoanDed)}</td><td className="px-4 py-3 text-right font-bold text-slate-300">{Utils.formatCurrency(totals.totalOtherDed)}</td><td className="px-4 py-3 text-right font-bold text-slate-300">{Utils.formatCurrency(totals.totalFinalSalary)}</td><td className="px-4 py-3 text-right font-bold text-slate-300">{Utils.formatCurrency(totals.totalAccountNote)}</td></tr></tfoot></table></div>
                </Card>
            );
        };
        // --- END EXPENSE REPORT PAGE ---

        // --- START POLICY BOARD PAGE ---
        const PolicyModal = memo(({ isOpen, onClose, onSave, policy }) => {
            const [formData, setFormData] = useState({});
            const quillRef = useRef(null); // For the container div
            const quillInstanceRef = useRef(null); // For the Quill instance

            // This single effect handles initializing/reseting the form and editor when the modal opens or a new policy is passed.
            useEffect(() => {
                if (isOpen) {
                    // Set the form data state based on the incoming policy prop.
                    const initialData = policy ? { ...policy } : { title: '', category: 'General', content: '' };
                    setFormData(initialData);

                    // Handle the editor instance.
                    if (quillRef.current) {
                        // Initialize Quill if it hasn't been already.
                        if (!quillInstanceRef.current) {
                            quillInstanceRef.current = new Quill(quillRef.current, {
                                theme: 'snow',
                                modules: {
                                    toolbar: [
                                        [{ 'header': [1, 2, 3, false] }],
                                        ['bold', 'italic', 'underline', 'strike'],
                                        [{ 'color': [] }, { 'background': [] }],
                                        [{ 'list': 'ordered' }, { 'list': 'bullet' }],
                                        [{ 'align': [] }],
                                        ['link', 'blockquote', 'code-block'],
                                        ['clean']
                                    ]
                                },
                                placeholder: 'Compose the policy content here...',
                            });

                            // The text-change listener updates the formData state as the user types.
                            quillInstanceRef.current.on('text-change', (delta, oldDelta, source) => {
                                if (source === 'user') {
                                    setFormData(prev => ({ ...prev, content: quillInstanceRef.current.root.innerHTML }));
                                }
                            });
                        }
                        
                        // Sync the editor's content with the new data.
                        // This is crucial for when the user re-opens the editor.
                        const newContent = initialData.content || '';
                        const currentEditorContent = quillInstanceRef.current.root.innerHTML;
                        if (newContent !== currentEditorContent) {
                            quillInstanceRef.current.root.innerHTML = newContent;
                        }
                    }
                }
            }, [isOpen, policy]); // This effect now correctly depends on the external props.

            const handleChange = useCallback((e) => {
                const { name, value } = e.target;
                setFormData(prev => ({ ...prev, [name]: value }));
            }, []);

            const handleSubmit = useCallback(() => {
                onSave(formData);
            }, [onSave, formData]);

            return (
                <Modal isOpen={isOpen} onClose={onClose} maxWidth="max-w-4xl">
                    {/* The <form> tag was removed from here to prevent "Enter" from submitting the form */}
                    <ModalHeader title={policy ? "Edit Policy" : "Add New Policy"} onClose={onClose} />
                    <ModalBody>
                        <div className="space-y-4">
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label className="text-sm font-medium text-slate-400">Title</label>
                                    <input name="title" value={formData.title || ''} onChange={handleChange} className="input" required />
                                </div>
                                <div>
                                    <label className="text-sm font-medium text-slate-400">Category</label>
                                    <input name="category" value={formData.category || ''} onChange={handleChange} className="input" placeholder="e.g., General, Leave" required />
                                </div>
                            </div>
                            <div>
                                <label className="text-sm font-medium text-slate-400">Content</label>
                                <div className="bg-slate-100 text-slate-900 mt-1 rounded-lg overflow-hidden border border-slate-600">
                                    <div ref={quillRef} style={{ height: '300px' }}></div>
                                </div>
                            </div>
                        </div>
                    </ModalBody>
                    <ModalFooter>
                        <Button variant="secondary" onClick={onClose}>Cancel</Button>
                        <Button type="button" variant="primary" onClick={handleSubmit}>Save Policy</Button>
                    </ModalFooter>
                </Modal>
            );
        });

        const PolicyBoardPage = ({ userProfile }) => {
            const { db } = useFirebase();
            const { data: policies, loading } = useCollection('policies');
            const [searchTerm, setSearchTerm] = useState('');
            const [activeCategory, setActiveCategory] = useState(null);
            const [isModalOpen, setModalOpen] = useState(false);
            const [editingPolicy, setEditingPolicy] = useState(null);
            const [policyToDelete, setPolicyToDelete] = useState(null);

            const isAdmin = userProfile?.role === 'Admin';

            // Open the first category by default if it's not set
            useEffect(() => {
                if (activeCategory === null && sortedCategories.length > 0) {
                    setActiveCategory(sortedCategories[0]);
                }
            }, [policies]);


            const categorizedPolicies = useMemo(() => {
                const filtered = policies.filter(p =>
                    (p.title?.toLowerCase() || '').includes(searchTerm.toLowerCase()) ||
                    (p.content?.toLowerCase() || '').includes(searchTerm.toLowerCase())
                );

                const grouped = filtered.reduce((acc, policy) => {
                    const category = policy.category || 'General';
                    if (!acc[category]) {
                        acc[category] = [];
                    }
                    acc[category].push(policy);
                    return acc;
                }, {});

                for (const category in grouped) {
                    grouped[category].sort((a, b) => a.title.localeCompare(b.title));
                }
                return grouped;
            }, [policies, searchTerm]);

            const sortedCategories = useMemo(() => Object.keys(categorizedPolicies).sort(), [categorizedPolicies]);

            const handleOpenModal = useCallback((policy = null) => { setEditingPolicy(policy); setModalOpen(true); }, []);
            const handleCloseModal = useCallback(() => { setEditingPolicy(null); setModalOpen(false); }, []);

            const handleSavePolicy = useCallback(async (policyData) => {
                const { addDoc, updateDoc, doc, collection, serverTimestamp } = window.firebaseSDK;
                const dataToSave = { ...policyData };
                try {
                    if (dataToSave.id) {
                        const { id, ...data } = dataToSave;
                        await updateDoc(doc(db, 'policies', id), { ...data, updatedAt: serverTimestamp() });
                    } else {
                        await addDoc(collection(db, 'policies'), { ...dataToSave, createdAt: serverTimestamp(), updatedAt: serverTimestamp() });
                    }
                    handleCloseModal();
                } catch (error) {
                    console.error("Error saving policy:", error);
                }
            }, [db, handleCloseModal]);

            const handleDeleteConfirm = useCallback(async () => {
                if (!policyToDelete) return;
                try {
                    await window.firebaseSDK.deleteDoc(window.firebaseSDK.doc(db, 'policies', policyToDelete.id));
                } catch (error) {
                    console.error("Error deleting policy:", error);
                } finally {
                    setPolicyToDelete(null);
                }
            }, [db, policyToDelete]);

            const toggleCategory = useCallback((category) => {
                setActiveCategory(activeCategory === category ? null : category);
            }, [activeCategory]);
            
            const formatTimestamp = (timestamp) => {
                if (!timestamp || !timestamp.toDate) return 'N/A';
                return timestamp.toDate().toLocaleDateString('en-GB');
            };

            return (
                <Card>
                    <div className="flex flex-wrap gap-4 justify-between items-center mb-6">
                        <CardTitle>Company Policy Board</CardTitle>
                        <div className="flex flex-wrap gap-4 items-center">
                            <input type="text" placeholder="Search policies..." value={searchTerm} onChange={e => setSearchTerm(e.target.value)} className="input w-full sm:w-auto" />
                            {isAdmin && <Button variant="primary" icon="fa-plus" onClick={() => handleOpenModal()}>Add Policy</Button>}
                        </div>
                    </div>
                    {loading ? (
                        <div className="text-center py-10"><i className="fas fa-spinner fa-spin text-3xl text-blue-400"></i></div>
                    ) : (
                        <div className="space-y-4">
                            {sortedCategories.length > 0 ? sortedCategories.map(category => (
                                <div key={category} className="border border-slate-700 rounded-lg overflow-hidden">
                                    <button onClick={() => toggleCategory(category)} className="w-full flex justify-between items-center p-4 bg-slate-800 hover:bg-slate-700/50 transition-colors">
                                        <h3 className="text-lg font-semibold text-slate-100">{category}</h3>
                                        <i className={`fas fa-chevron-down transform transition-transform ${activeCategory === category ? 'rotate-180' : ''}`}></i>
                                    </button>
                                    {activeCategory === category && (
                                        <div className="p-4 bg-slate-900/50">
                                            {categorizedPolicies[category].map(policy => (
                                                <div key={policy.id} className="p-4 mb-2 border-b border-slate-700 last:border-b-0">
                                                    <div className="flex justify-between items-center">
                                                        <h4 className="text-md font-semibold text-blue-300">{policy.title}</h4>
                                                        {isAdmin && (
                                                            <div className="flex space-x-3">
                                                                <Button variant="icon-edit" icon="fa-edit" onClick={() => handleOpenModal(policy)} title="Edit Policy"/>
                                                                <Button variant="icon-delete" icon="fa-trash" onClick={() => setPolicyToDelete(policy)} title="Delete Policy"/>
                                                            </div>
                                                        )}
                                                    </div>
                                                    <div className="mt-2 text-slate-300 policy-content" dangerouslySetInnerHTML={{ __html: policy.content }}></div>
                                                    <div className="text-xs text-slate-500 mt-3 text-right">
                                                        Last updated: {formatTimestamp(policy.updatedAt || policy.createdAt)}
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    )}
                                </div>
                            )) : <div className="text-center py-10 text-slate-400">No policies found matching your search.</div>}
                        </div>
                    )}
                    <PolicyModal isOpen={isModalOpen} onClose={handleCloseModal} onSave={handleSavePolicy} policy={editingPolicy} />
                    <ConfirmationModal isOpen={!!policyToDelete} onClose={() => setPolicyToDelete(null)} onConfirm={handleDeleteConfirm} title="Delete Policy" message={`Are you sure you want to delete the policy "${policyToDelete?.title}"? This action cannot be undone.`} />
                </Card>
            );
        };
        // --- END POLICY BOARD PAGE ---

        // --- START USER ACTIVITY PAGE ---
        const UserActivityPage = () => {
            const { db } = useFirebase();
            const { data: employees } = useCollection('employees');
            const employeeNameMap = useMemo(() => employees.reduce((acc, emp) => { if (emp.uid) acc[emp.uid] = emp.name; return acc; }, {}), [employees]);
            
            const [logs, setLogs] = useState([]);
            const [loading, setLoading] = useState(true);
            const [currentPage, setCurrentPage] = useState(1);
            const [pageCursors, setPageCursors] = useState({ 1: null }); // Store cursors in an object: { pageNum: cursorDoc }
            const [hasNextPage, setHasNextPage] = useState(false);
            const itemsPerPage = 15;

            // Helper function to safely format Firestore timestamps or other date formats
            const formatTimestamp = (timestamp) => {
                if (!timestamp) return 'No date';
                if (typeof timestamp.toDate === 'function') { return timestamp.toDate().toLocaleString('en-GB', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit', hour12: true }); }
                const date = new Date(timestamp);
                if (!isNaN(date.getTime())) { return date.toLocaleString('en-GB', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit', hour12: true }); }
                return 'Invalid Date';
            };

            // REFACTORED: Data fetching logic is now self-contained within this effect.
            // It only re-runs when the database connection is ready or the page number changes.
            useEffect(() => {
                if (!db) return;

                const fetchLogsForPage = async () => {
                    setLoading(true);
                    const { collection, query, orderBy, limit, startAfter, getDocs } = window.firebaseSDK;
                    
                    // The cursor for the current page is the last document of the *previous* page.
                    const cursor = pageCursors[currentPage - 1];
                    
                    let q = query(
                        collection(db, 'userLogs'),
                        orderBy('timestamp', 'desc'),
                        limit(itemsPerPage + 1)
                    );

                    if (cursor) {
                        q = query(q, startAfter(cursor));
                    }
                    
                    try {
                        const documentSnapshots = await getDocs(q);
                        
                        setHasNextPage(documentSnapshots.docs.length > itemsPerPage);
                        
                        const newLogs = documentSnapshots.docs.slice(0, itemsPerPage).map(doc => ({
                            id: doc.id,
                            ...doc.data()
                        }));
                        setLogs(newLogs);

                        // If there are logs, store the last one as the cursor for the CURRENT page,
                        // which will be used to fetch the NEXT page.
                        if (documentSnapshots.docs.length > 0) {
                            const lastVisible = documentSnapshots.docs[newLogs.length - 1];
                            if (lastVisible) {
                                setPageCursors(prev => ({ ...prev, [currentPage]: lastVisible }));
                            }
                        }
                    } catch (error) {
                        console.error("Error fetching user logs:", error);
                    } finally {
                        setLoading(false);
                    }
                };

                fetchLogsForPage();
            }, [db, currentPage]); // This dependency array is the key to the fix.

            const handleNext = () => {
                if (hasNextPage) {
                    setCurrentPage(prev => prev + 1);
                }
            };
            const handlePrevious = () => {
                if (currentPage > 1) {
                    setCurrentPage(prev => prev - 1);
                }
            };
            
            // Function to format log details for better readability
            const formatActivityDetails = (log) => {
                const { originalData, updatedData, action } = log;
                if (action === 'Add Employee' || action === 'Delete Employee') {
                    return `Details for ${log.targetName}`;
                }
                if (originalData && updatedData) {
                    const changes = [];
                    const allKeys = new Set([...Object.keys(originalData), ...Object.keys(updatedData)]);
                    
                    const formatValue = (val) => {
                        if (val === undefined || val === null) return 'empty';
                        if (Array.isArray(val)) return `[${val.join(', ')}]`;
                        // Handle objects gracefully to avoid "[object Object]"
                        if (typeof val === 'object' && val !== null) return JSON.stringify(val);
                        return String(val);
                    };

                    allKeys.forEach(key => {
                        if (key === 'id') return;
                        const originalValue = formatValue(originalData[key]);
                        const updatedValue = formatValue(updatedData[key]);
                        if (originalValue !== updatedValue) {
                            changes.push(`${key}: from '${originalValue}' to '${updatedValue}'`);
                        }
                    });
                    return changes.length > 0 ? changes.join('; ') : 'No detailed changes detected.';
                }
                return log.action || 'Unknown Action';
            };
            
            return (
                <Card>
                    <CardTitle>User Activity Log</CardTitle>
                    {loading ? (
                         <div className="text-center py-10"><i className="fas fa-spinner fa-spin text-3xl text-blue-400"></i><p className="mt-2 text-slate-400">Loading Logs...</p></div>
                    ) : (
                        <>
                            <div className="overflow-x-auto">
                                <table className="min-w-full divide-y divide-slate-700">
                                    <thead className="bg-slate-900/50"><tr><th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Timestamp</th><th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">User</th><th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Action</th><th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Target</th><th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Activity Details</th></tr></thead>
                                    <tbody className="divide-y divide-slate-700">
                                        {logs.map(log => (<tr key={log.id} className="hover:bg-slate-700/50"><td className="px-4 py-4 text-sm text-slate-200 whitespace-nowrap">{formatTimestamp(log.timestamp)}</td><td className="px-4 py-4 text-sm text-slate-300">{employeeNameMap[log.userId] || log.userId}</td><td className="px-4 py-4 text-sm text-slate-300">{log.action}</td><td className="px-4 py-4 text-sm text-slate-300">{log.targetName || 'N/A'}</td><td className="px-4 py-4 text-sm text-slate-300">{formatActivityDetails(log)}</td></tr>))}
                                    </tbody>
                                </table>
                            </div>
                            <div className="mt-6 flex justify-between items-center">
                                <Button variant="secondary" onClick={handlePrevious} disabled={currentPage === 1 || loading}>
                                    Previous
                                </Button>
                                <span className="text-sm text-slate-400">Page {currentPage}</span>
                                <Button variant="secondary" onClick={handleNext} disabled={!hasNextPage || loading}>
                                    Next
                                </Button>
                            </div>
                        </>
                    )}
                </Card>
            );
        };
        // --- END USER ACTIVITY PAGE ---

        // --- START SETTINGS PAGE ---
        const MemoAlertTab = () => {
            const { db } = useFirebase();
            const [memoContent, setMemoContent] = useState('');
            const [memoStatus, setMemoStatus] = useState('Deactive');
            const [loading, setLoading] = useState(true);
            const [saving, setSaving] = useState(false);

            useEffect(() => {
                if (!db) return;
                const { doc, onSnapshot } = window.firebaseSDK;
                const memoRef = doc(db, "settings", "memoAlert");
                const unsubscribe = onSnapshot(memoRef, (doc) => {
                    if (doc.exists()) {
                        const data = doc.data();
                        setMemoContent(data.content || '');
                        setMemoStatus(data.status || 'Deactive');
                    }
                    setLoading(false);
                }, (error) => {
                    console.error("Error fetching memo: ", error);
                    setLoading(false);
                });
                return () => unsubscribe();
            }, [db]);

            const handleSave = async () => {
                if (!db) return;
                setSaving(true);
                const { doc, setDoc } = window.firebaseSDK;
                const memoRef = doc(db, "settings", "memoAlert");
                try {
                    await setDoc(memoRef, { content: memoContent, status: memoStatus }, { merge: true });
                } catch (error) {
                    console.error("Error saving memo: ", error);
                } finally {
                    setSaving(false);
                }
            };

            if (loading) {
                return <Card><CardTitle>Memo Alert</CardTitle><div>Loading...</div></Card>;
            }

            return (
                <Card>
                    <CardTitle>Memo Alert Settings</CardTitle>
                    <div className="space-y-6">
                        <div>
                            <label htmlFor="memoContent" className="block text-sm font-medium text-slate-400">Memo Content (5-6 lines recommended)</label>
                            <textarea
                                id="memoContent"
                                name="memoContent"
                                rows="6"
                                className="input mt-1"
                                value={memoContent}
                                onChange={(e) => setMemoContent(e.target.value)}
                                placeholder="Enter your memo alert here..."
                            ></textarea>
                        </div>
                        <div>
                            <label className="block text-sm font-medium text-slate-400">Popup Status</label>
                            <div className="mt-2 space-y-2">
                                <div className="flex items-center">
                                    <input id="status-all" name="status" type="radio" value="Active All" checked={memoStatus === 'Active All'} onChange={(e) => setMemoStatus(e.target.value)} className="h-4 w-4 text-blue-600 border-gray-300 focus:ring-blue-500 bg-slate-600" />
                                    <label htmlFor="status-all" className="ml-3 block text-sm font-medium text-slate-300">Active All (Show to everyone)</label>
                                </div>
                                <div className="flex items-center">
                                    <input id="status-manager" name="status" type="radio" value="Active Shop Manager" checked={memoStatus === 'Active Shop Manager'} onChange={(e) => setMemoStatus(e.target.value)} className="h-4 w-4 text-blue-600 border-gray-300 focus:ring-blue-500 bg-slate-600" />
                                    <label htmlFor="status-manager" className="ml-3 block text-sm font-medium text-slate-300">Active Shop Manager (Only for Shop Managers)</label>
                                </div>
                                <div className="flex items-center">
                                    <input id="status-deactive" name="status" type="radio" value="Deactive" checked={memoStatus === 'Deactive'} onChange={(e) => setMemoStatus(e.target.value)} className="h-4 w-4 text-blue-600 border-gray-300 focus:ring-blue-500 bg-slate-600" />
                                    <label htmlFor="status-deactive" className="ml-3 block text-sm font-medium text-slate-300">Deactive (Do not show popup)</label>
                                </div>
                            </div>
                        </div>
                        <div className="flex justify-end">
                            <Button onClick={handleSave} disabled={saving} variant="primary" icon={saving ? 'fa-spinner fa-spin' : null}>
                                {saving ? 'Saving...' : 'Save Memo'}
                            </Button>
                        </div>
                    </div>
                </Card>
            );
        };
        const SettingsPage = ({ initialTab = 'shop' }) => {
            const { data: shops } = useStaticCollection('shops'); // Use one-time fetch
            const { data: positions } = useStaticCollection('positions'); // Use one-time fetch
            const [activeTab, setActiveTab] = useState(initialTab);

            // NEW: Effect to update the active tab if the initialTab prop changes
            // This allows the Dashboard to control which tab is shown.
            useEffect(() => {
                setActiveTab(initialTab);
            }, [initialTab]);

            // Configuration for the generic CRUD component for Shops
            const shopFormFields = [{ name: 'name', label: 'Shop Name', required: true }, { name: 'latitude', label: 'Latitude' }, { name: 'longitude', label: 'Longitude' }, { name: 'radius', label: 'Radius (m)', type: 'number' }, { name: 'note', label: 'Note', fullWidth: true }];
            const shopListColumns = [{ header: 'Shop Name', accessor: 'name' }, { header: 'Latitude', accessor: 'latitude' }, { header: 'Longitude', accessor: 'longitude' }, { header: 'Radius (m)', accessor: 'radius' }, { header: 'Note', accessor: 'note' }];
            
            // Configuration for the generic CRUD component for Positions
            const positionFormFields = [{ name: 'position', label: 'Position', required: true }, { name: 'note', label: 'Note', fullWidth: true }];
            const positionListColumns = [{ header: 'Position', accessor: 'position' }, { header: 'Note', accessor: 'note' }];

            return (
                <TabbedPage tabs={{ shop: 'Shop Properties', position: 'Position Management', memo: 'Memo Alert' }} activeTab={activeTab} setActiveTab={setActiveTab}>
                    <div id="shop"><SettingsCRUD title="Shop" collectionName="shops" items={shops} formFields={shopFormFields} listColumns={shopListColumns} /></div>
                    <div id="position"><SettingsCRUD title="Position" collectionName="positions" items={positions} formFields={positionFormFields} listColumns={positionListColumns} /></div>
                    <div id="memo"><MemoAlertTab /></div>
                </TabbedPage>
            );
        }

        // NEW: Component for manually triggering payroll for a whole shop
        // This component is now removed as its functionality is merged into PayrollCalculatorTab.
        
        // Generic component for CRUD operations (Create, Read, Update, Delete)
        function SettingsCRUD({ title, collectionName, items, formFields, listColumns }) {
            const { db } = useFirebase();
            const [editingItem, setEditingItem] = useState(null);
            const [itemToDelete, setItemToDelete] = useState(null);
            const getInitialState = useCallback(() => formFields.reduce((acc, field) => ({...acc, [field.name]: '' }), {}), [formFields]);
            const [newItem, setNewItem] = useState(getInitialState());

            useEffect(() => { setNewItem(getInitialState()); }, [getInitialState]);

            const handleSave = useCallback(async (item) => {
                const { doc, updateDoc, addDoc, collection } = window.firebaseSDK;
                try {
                    if (item.id) { const { id, ...data } = item; await updateDoc(doc(db, collectionName, id), data); } 
                    else { await addDoc(collection(db, collectionName), item); }
                    setEditingItem(null); setNewItem(getInitialState());
                } catch (e) { console.error(`Error saving ${collectionName}:`, e); }
            }, [db, collectionName, getInitialState]);
            
            const handleDelete = useCallback(async () => {
                if (!itemToDelete) return;
                try { 
                    await window.firebaseSDK.deleteDoc(window.firebaseSDK.doc(db, collectionName, itemToDelete.id)); 
                } catch (e) { 
                    console.error(`Error deleting ${collectionName}:`, e); 
                } finally {
                    setItemToDelete(null);
                }
            }, [db, collectionName, itemToDelete]);

            // Reusable form renderer
            const renderForm = (item, setItem, isNew = false) => (<form onSubmit={(e) => { e.preventDefault(); handleSave(item); }} className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-4 items-end p-4 bg-slate-800/50 rounded-lg mb-6 border border-slate-700">{formFields.map(field => (<div key={field.name} className={field.fullWidth ? 'col-span-full' : 'sm:col-span-1'}><label className="block text-sm font-medium text-slate-400">{field.label}</label><input type={field.type || 'text'} name={field.name} value={item[field.name] || ''} onChange={(e) => setItem({...item, [field.name]: e.target.value})} className="input" required={field.required} /></div>))}<div className="flex space-x-2 col-span-full md:col-span-1 self-end mt-4 md:mt-0"><Button type="submit" variant="primary" className="w-full">{isNew ? `Add ${title}` : 'Save'}</Button>{!isNew && <Button type="button" variant="secondary" onClick={() => setEditingItem(null)} className="w-full">Cancel</Button>}</div></form>);

            return (<Card><CardTitle>{title} Management</CardTitle>{renderForm(newItem, setNewItem, true)}<div className="overflow-x-auto"><table className="min-w-full divide-y divide-slate-700"><thead className="bg-slate-900/50"><tr>{listColumns.map(col => <th key={col.accessor} className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">{col.header}</th>)}<th className="px-4 py-3 text-right text-xs font-semibold text-slate-400 uppercase">Actions</th></tr></thead><tbody className="divide-y divide-slate-700">{items.map(item => (<tr key={item.id} className="hover:bg-slate-700/50">{editingItem?.id === item.id ? (<td colSpan={listColumns.length + 1} className="p-0">{renderForm(editingItem, setEditingItem)}</td>) : (<>{listColumns.map(col => <td key={col.accessor} className="px-4 py-4 text-sm text-slate-300">{item[col.accessor]}</td>)}<td className="px-4 py-4 text-right text-sm"><Button variant="icon-edit" icon="fa-edit" onClick={() => setEditingItem({ ...item })} className="mr-3" /><Button variant="icon-delete" icon="fa-trash" onClick={() => setItemToDelete(item)} /></td></>)}</tr>))}</tbody></table></div><ConfirmationModal isOpen={!!itemToDelete} onClose={() => setItemToDelete(null)} onConfirm={handleDelete} title={`Delete ${title}`} message="Are you sure you want to delete this item?" /></Card>);
        }
        // --- END SETTINGS PAGE ---

        // --- START LAYOUT & MAIN APP COMPONENTS ---
        const Sidebar = memo(({ activePage, setActivePage, isSidebarOpen, toggleSidebar, userProfile }) => {
            const { isOnline } = useConnectivity();
            const sidebarLinks = useMemo(() => [ 
                { key: 'policy', icon: 'fa-book-open', label: 'Policy Board' },
                { key: 'employees', icon: 'fa-users', label: 'Employees' }, 
                { key: 'checkinme', icon: 'fa-user-clock', label: 'CheckInMe' }, 
                { key: 'attendanceReport', icon: 'fa-file-alt', label: 'Attendance Report' }, 
                { key: 'loanManager', icon: 'fa-hand-holding-usd', label: 'Loan Manager' }, 
                { key: 'payroll', icon: 'fa-money-check-dollar', label: 'Payroll' }, 
                { key: 'expenseReport', icon: 'fa-file-invoice-dollar', label: 'Expense Report' }, 
                { key: 'userActivity', icon: 'fa-chart-line', label: 'User Activity' }, 
                { key: 'settings', icon: 'fa-cog', label: 'Settings' }, 
            ], []);

            // Filter sidebar links based on user permissions
            const availableLinks = useMemo(() => {
                if (userProfile?.role === 'Admin') return sidebarLinks; // Admin sees all
                if (!userProfile?.permissions) {
                    // If no permissions array exists, just show the policy board to be safe.
                    return sidebarLinks.filter(link => link.key === 'policy');
                }
                // Create a set of allowed pages, ensuring 'policy' is always included without duplication.
                const allowedPages = new Set(userProfile.permissions);
                allowedPages.add('policy');
        
                return sidebarLinks.filter(link => allowedPages.has(link.key));
            }, [userProfile, sidebarLinks]);

             const handleLinkClick = useCallback((pageKey) => { 
                setActivePage(pageKey); 
                if (window.innerWidth < 768) toggleSidebar(); // Close sidebar on mobile after navigation
            }, [setActivePage, toggleSidebar]);

            return (
                <aside className={`w-64 bg-slate-900 text-slate-300 p-4 flex flex-col transform ${isSidebarOpen ? 'translate-x-0' : '-translate-x-full'} md:translate-x-0 transition-transform duration-300 ease-in-out z-40 fixed md:relative h-full border-r border-slate-700`}>
                    <div className="flex items-center mb-2 px-2">
                        <i className="fas fa-building-user text-3xl text-blue-500 mr-3"></i>
                        <h1 className="text-2xl font-bold text-white">HR System</h1>
                    </div>
                    {/* Desktop Connectivity Status */}
                    <div className="px-2 mb-6 hidden md:block">
                        {isOnline ? (
                            <div className="flex items-center gap-2 text-xs text-green-400 font-medium">
                                <i className="fas fa-circle text-[8px]"></i> Online
                            </div>
                        ) : (
                            <div className="flex items-center gap-2 text-xs text-red-400 font-medium">
                                <i className="fas fa-circle text-[8px]"></i> Offline Mode
                            </div>
                        )}
                    </div>
                    <nav className="flex-grow">{availableLinks.map(link => (<a href="#" key={link.key} onClick={() => handleLinkClick(link.key)} className={`flex items-center py-3 px-4 rounded-lg transition duration-200 mt-2 ${activePage === link.key ? 'bg-blue-600 text-white shadow-lg' : 'hover:bg-slate-700/50'}`}><i className={`fas ${link.icon} w-6 mr-4`}></i><span className="font-medium">{link.label}</span></a>))}</nav>
                </aside>
            );
        });

        const Header = memo(({ pageTitle, toggleSidebar, userProfile, pendingLeaves, pendingOTs, onNotificationClick }) => {
            const { auth } = useFirebase();
            const { isOnline } = useConnectivity();

            const handleLogout = useCallback(async () => { 
                try { await window.firebaseSDK.signOut(auth); } 
                catch (error) { console.error("Error signing out: ", error); } 
            }, [auth]);

            const showNotifications = userProfile?.role === 'Admin' || userProfile?.role === 'Shop Manager';

            return (
                <header className="bg-slate-800/80 backdrop-blur-sm shadow-md p-4 flex justify-between items-center z-30 border-b border-slate-700 sticky top-0">
                    <div className="flex items-center min-w-0">
                        <button onClick={toggleSidebar} className="text-slate-400 focus:outline-none md:hidden mr-4"><i className="fas fa-bars text-2xl"></i></button>
                        <div className="flex flex-col">
                            <h2 className="text-xl sm:text-2xl font-bold text-slate-100 truncate">{pageTitle}</h2>
                             {/* Mobile Connectivity Status */}
                            <div className="md:hidden">
                                {isOnline ? (
                                    <div className="flex items-center gap-1.5 text-xs text-green-400 font-medium">
                                        <i className="fas fa-circle text-[8px]"></i> Online
                                    </div>
                                ) : (
                                    <div className="flex items-center gap-1.5 text-xs text-red-400 font-medium">
                                        <i className="fas fa-circle text-[8px]"></i> Offline Mode
                                    </div>
                                )}
                            </div>
                        </div>
                    </div>
                    <div className="flex items-center gap-2 sm:gap-4 flex-shrink-0">
                        {userProfile && (<div className="text-right hidden sm:block"><span className="text-sm text-slate-400">Welcome, </span><span className="font-medium text-slate-200">{userProfile.name}</span></div>)}
                        {showNotifications && (
                            <NotificationBell
                                pendingLeaves={pendingLeaves}
                                pendingOTs={pendingOTs}
                                onNotificationClick={onNotificationClick}
                            />
                        )}
                        <button onClick={handleLogout} title="Logout" className="bg-slate-700 text-slate-300 w-10 h-10 rounded-full hover:bg-slate-600 hover:text-white transition duration-150 flex items-center justify-center flex-shrink-0"><i className="fas fa-sign-out-alt"></i></button>
                    </div>
                </header>
            );
        });
        
        const Dashboard = ({ userProfile }) => {
            const [isSidebarOpen, setSidebarOpen] = useState(false);
            const [activePage, setActivePage] = useState('');
            const [initialCheckInMeTab, setInitialCheckInMeTab] = useState('checkInOut');
            const [showNotificationModal, setShowNotificationModal] = useState(true);
            const [memoAlert, setMemoAlert] = useState(null);
            const [isMemoVisible, setMemoVisible] = useState(false);
            const [memoShownThisSession, setMemoShownThisSession] = useState(false);
            const { db } = useFirebase();

            // Fetch memo alert data
            useEffect(() => {
                if (!db) return;
                const { doc, onSnapshot } = window.firebaseSDK;
                const memoRef = doc(db, "settings", "memoAlert");
                const unsubscribe = onSnapshot(memoRef, (doc) => {
                    if (doc.exists()) {
                        setMemoAlert(doc.data());
                    } else {
                        setMemoAlert(null);
                    }
                });
                return () => unsubscribe();
            }, [db]);

            // Logic to show memo modal
            useEffect(() => {
                if (memoAlert && userProfile && !memoShownThisSession) {
                    const shouldShow = 
                        (memoAlert.status === 'Active All') ||
                        (memoAlert.status === 'Active Shop Manager' && userProfile.role === 'Shop Manager');

                    if (shouldShow) {
                        setMemoVisible(true);
                        setMemoShownThisSession(true); // Ensure it only shows once per session/reload
                    }
                }
            }, [memoAlert, userProfile, memoShownThisSession]);
            
            // Set the default page based on user role and permissions
            useEffect(() => {
                if (userProfile) {
                    let defaultPage = 'checkinme'; // Fallback for staff
                    if (userProfile.role === 'Admin' || userProfile.role === 'Shop Manager') {
                        // Default Admins/Managers to Employees page if they have access, otherwise their first permission
                        defaultPage = userProfile.permissions?.includes('employees') 
                            ? 'employees' 
                            : userProfile.permissions?.[0] || 'checkinme';
                    } else if (userProfile.permissions && userProfile.permissions.length > 0) {
                        // For other roles, default to their first permission
                        defaultPage = userProfile.permissions[0];
                    }
                    setActivePage(defaultPage);
                }
            }, [userProfile]);

            const toggleSidebar = useCallback(() => setSidebarOpen(prev => !prev), []);
            
            const { where } = window.firebaseSDK;
            const requestQueryConstraints = useMemo(() => {
                // This logic determines which pending requests to fetch for notifications.
                if (userProfile?.role === 'Admin') {
                    // Admin sees all pending requests from all shops.
                    return [where("status", "==", "Pending")];
                }
                if (userProfile?.role === 'Shop Manager') {
                    // Shop Manager is restricted to see pending requests only from their assigned shop.
                    return [
                        where("status", "==", "Pending"),
                        where("shop", "==", userProfile.shop || null) // Using || null for safety.
                    ];
                }
                // For any other role (e.g., Staff), return a query that will match no documents.
                // This prevents fetching unnecessary data for users who won't see the notifications.
                return [where("status", "==", "non-existent-status")];
            }, [userProfile]);

            const { data: pendingLeaves } = useCollection('leaveRequests', requestQueryConstraints);
            const { data: pendingOTs } = useCollection('otRequests', requestQueryConstraints);

            const handleNotificationClick = useCallback((targetTab) => {
                setActivePage('checkinme');
                setInitialCheckInMeTab(targetTab);
                setShowNotificationModal(false);
            }, []);

            const pageTitles = useMemo(() => ({ 
                employees: 'Employees', checkinme: 'CheckInMe', attendanceReport: 'Attendance Report', 
                loanManager: 'Loan Manager', payroll: 'Payroll', expenseReport: 'Expense Report', 
                userActivity: 'User Activity', settings: 'Settings', policy: 'Company Policy Board' 
            }), []);
            
            const totalPending = pendingLeaves.length + pendingOTs.length;
            // Renders the component for the currently active page
            const renderActivePage = useCallback(() => {
                const hasPermission = userProfile?.role === 'Admin' || userProfile?.permissions?.includes(activePage) || activePage === 'policy';
                if (!activePage) return null;
                if (!hasPermission) return <Card><CardTitle>Access Denied</CardTitle><p>You do not have permission to view this page.</p></Card>;
                
                switch(activePage) {
                    case 'employees': return <EmployeesPage userProfile={userProfile} />;
                    case 'checkinme': return <CheckInMePage userProfile={userProfile} initialTab={initialCheckInMeTab} />;
                    case 'attendanceReport': return <AttendanceReportPage userProfile={userProfile} />;
                    case 'loanManager': return <LoanManagerPage userProfile={userProfile} />;
                    case 'payroll': return <PayrollPage userProfile={userProfile} />;
                    case 'expenseReport': return <ExpenseReportPage />;
                    case 'policy': return <PolicyBoardPage userProfile={userProfile} />;
                    case 'userActivity': return <UserActivityPage />;
                    case 'settings': return <SettingsPage />;
                    default: return <UnderConstructionPage title="Page Not Found" />;
                }
            }, [activePage, userProfile, initialCheckInMeTab]);

            return (
                <div className="flex h-screen bg-slate-900 text-slate-300">
                    <Sidebar activePage={activePage} setActivePage={setActivePage} isSidebarOpen={isSidebarOpen} toggleSidebar={toggleSidebar} userProfile={userProfile} />
                    <div className="flex-1 flex flex-col overflow-hidden">
                        <Header 
                            pageTitle={pageTitles[activePage] || 'Dashboard'} 
                            toggleSidebar={toggleSidebar} 
                            userProfile={userProfile}
                            pendingLeaves={pendingLeaves}
                            pendingOTs={pendingOTs}
                            onNotificationClick={handleNotificationClick}
                        />
                        <main className="flex-1 overflow-x-hidden overflow-y-auto bg-slate-800 p-4 sm:p-6">
                            {renderActivePage()}
                        </main>
                        <Modal isOpen={showNotificationModal && totalPending > 0 && userProfile?.role !== 'Staff'} onClose={() => setShowNotificationModal(false)} maxWidth="max-w-md">
                            <ModalHeader title="Pending Approvals" onClose={() => setShowNotificationModal(false)} />
                            <ModalBody>
                                <p className="text-slate-300">You have {totalPending} new request(s) waiting for your approval.</p>
                                <ul className="mt-4 space-y-2">
                                    {pendingLeaves.length > 0 && <li><span className="font-semibold">{pendingLeaves.length}</span> Leave Request(s)</li>}
                                    {pendingOTs.length > 0 && <li><span className="font-semibold">{pendingOTs.length}</span> OT Request(s)</li>}
                                </ul>
                            </ModalBody>
                            <ModalFooter>
                                <Button variant="secondary" onClick={() => setShowNotificationModal(false)}>Dismiss</Button>
                                <Button variant="primary" onClick={() => handleNotificationClick('leaveRequest')}>View Requests</Button>
                            </ModalFooter>
                        </Modal>
                        {memoAlert && (
                            <Modal isOpen={isMemoVisible} onClose={() => setMemoVisible(false)} maxWidth="max-w-lg">
                                <ModalHeader title="ដំណឹងប្រាប់ពត៏មាន" onClose={() => setMemoVisible(false)} />
                                <ModalBody>
                                    <pre className="text-slate-300 whitespace-pre-wrap font-sans">{memoAlert.content}</pre>
                                </ModalBody>
                                <ModalFooter>
                                    <Button variant="primary" onClick={() => setMemoVisible(false)}>ទទួលបាន</Button>
                                </ModalFooter>
                            </Modal>
                        )}
                    </div>
                </div>
            );
        };

        // Main App Component: Decides whether to show Login or Dashboard
        function AppContent() {
            const { currentUser, userProfile, loading } = useFirebase();
            
            if (loading) return <div className="flex items-center justify-center h-screen text-lg text-slate-300">Loading Application...</div>;
            
            return (
                <div>
                    {currentUser ? <Dashboard userProfile={userProfile} /> : <LoginPage />}
                </div>
            );
        }

        // Root Component with Firebase Provider
        function App() {
            return (
                <FirebaseProvider>
                    <AppContent />
                </FirebaseProvider>
            );
        }

        // Render the application
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(
            <ConnectivityProvider>
                <App />
            </ConnectivityProvider>
        );
        // --- END LAYOUT & MAIN APP COMPONENTS ---
    </script>
</body>
</html>



