<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Smart HR Management System</title>
    
    <!-- PWA Manifest Link -->
    <link rel="manifest" href="./manifest.json">
    <meta name="theme-color" content="#0f172a">
    <meta name="apple-mobile-web-app-capable" content="yes">
    
    <!-- FIX: iOS Specific Title (Ensures correct name on Home Screen) -->
    <meta name="apple-mobile-web-app-title" content="HR System">
    
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="https://i.imgur.com/EvYU0AK.jpeg">

    <!-- External Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" xintegrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    
    <!-- NEW: CropperJS CSS for Photo Adjustments -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css" />

    <!-- OPTIMIZATION: Switched to CDNJS for React/Babel (Faster Delivery) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    
    <!-- OPTIMIZATION: Moved heavy, non-critical libraries to the bottom of <body>. 
         This unblocks the initial UI rendering. -->

    <!-- OPTIMIZATION: Preconnect & DNS-Prefetch to critical domains for faster handshake -->
    <link rel="preconnect" href="https://www.gstatic.com">
    <link rel="dns-prefetch" href="https://www.gstatic.com">
    <link rel="preconnect" href="https://firestore.googleapis.com">
    <link rel="dns-prefetch" href="https://firestore.googleapis.com">
    <link rel="preconnect" href="https://cdnjs.cloudflare.com">
    <link rel="preconnect" href="https://unpkg.com">

    <!-- Custom Styles & Fonts -->
    <style>
        @import url('https://rsms.me/inter/inter.css');
        html, body { 
            font-family: 'Inter', sans-serif;
            overflow-x: hidden; /* Prevents horizontal scrolling */
            /* NEW: Prevents browser history swipe navigation on mobile to allow app gestures */
            overscroll-behavior-x: none;
        }

        /* OPTIMIZATION: Splash Screen Styles */
        #splash-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: #0f172a; z-index: 9999;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            transition: opacity 0.5s ease-out, visibility 0.5s;
        }
        .splash-loader {
            width: 48px; height: 48px;
            border: 5px solid #3b82f6; border-bottom-color: transparent;
            border-radius: 50%; display: inline-block;
            box-sizing: border-box; animation: rotation 1s linear infinite;
            margin-bottom: 20px;
        }
        @keyframes rotation { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Base input styles for a consistent look */
        .input, .select {
            margin-top: 0.25rem; display: block; width: 100%; padding: 0.5rem 0.75rem;
            border-width: 1px; border-color: #475569; border-radius: 0.375rem;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); line-height: 1.5;
            background-color: #334155; color: #f1f5f9;
        }
        .input:focus, .select:focus {
            outline: 2px solid transparent; outline-offset: 2px;
            --tw-ring-color: #2563eb; border-color: #2563eb;
        }
        .input[disabled], .select[disabled] {
            background-color: #475569;
            cursor: not-allowed;
            opacity: 0.7;
        }
        input[type="checkbox"]:disabled {
            cursor: not-allowed;
            opacity: 0.5;
        }
        /* Styles for rendered policy content */
        .policy-content p { margin-bottom: 1rem; line-height: 1.6; }
        .policy-content h1, .policy-content h2, .policy-content h3 { font-weight: bold; margin-top: 1.5rem; margin-bottom: 0.5rem; color: #f1f5f9; border-bottom: 1px solid #475569; padding-bottom: 0.25rem; }
        .policy-content h1 { font-size: 1.5em; }
        .policy-content h2 { font-size: 1.25em; }
        .policy-content h3 { font-size: 1.1em; }
        .policy-content ul, .policy-content ol { margin-left: 1.5rem; margin-bottom: 1rem; }
        .policy-content ul { list-style-type: disc; }
        .policy-content ol { list-style-type: decimal; }
        .policy-content a { color: #60a5fa; text-decoration: underline; }
        .policy-content strong { font-weight: bold; }
        .policy-content em { font-style: italic; }
        .policy-content u { text-decoration: underline; }
        .policy-content pre { background-color: #1e293b; padding: 1rem; border-radius: 0.5rem; white-space: pre-wrap; }
        .policy-content blockquote { border-left: 4px solid #475569; padding-left: 1rem; margin-left: 0; color: #94a3b8; }
        
        /* NEW: Correct Animation for Dashboard (Stays Visible) */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in {
            animation: fadeIn 0.6s ease-out forwards;
        }

        /* NEW: Skeleton Loading Animation */
        .skeleton {
            background: #334155;
            background: linear-gradient(to right, #334155 8%, #475569 18%, #334155 33%);
            background-size: 800px 104px;
            animation: shimmer 2s infinite linear;
            border-radius: 0.75rem; /* rounded-xl */
        }
        @keyframes shimmer {
            0% { background-position: -800px 0; }
            100% { background-position: 800px 0; }
        }

        /* NEW: QR Scanner Styles (Step 1) */
        .scanner-box { 
            border-radius: 1rem; 
            overflow: hidden; 
            border: 2px solid #334155; 
            background: #000; 
            min-height: 300px; 
            width: 100%; 
        }

        /* FIX: Custom Scrollbar Styles for Smooth Scrolling on Mobile/Desktop */
        .custom-scrollbar {
            -webkit-overflow-scrolling: touch; /* Key for smooth iOS momentum scrolling */
            scrollbar-width: thin;
            scrollbar-color: #475569 #1e293b;
        }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; height: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #1e293b; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background-color: #475569; border-radius: 20px; }
    </style>
</head>
<body class="bg-slate-900 text-slate-300">
    
    <!-- OPTIMIZATION: Splash Screen HTML -->
    <div id="splash-screen">
        <span class="splash-loader"></span>
        <h2 style="color: white; font-weight: 600; font-family: sans-serif;">Loading System...</h2>
    </div>

    <div id="root"></div>

    <!-- OPTIMIZATION: Load Heavy Libraries Here (Added 'defer' to prevent blocking) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js" xintegrity="sha512-BNaRQnYJYiPSqHHDb58B0yaPfCu+Wgds8Gp/gU33kqBtgNS4tSPHuGibyoVBL5gI9kLmbG0C+wFjr8bCqwY2SA==" crossorigin="anonymous" referrerpolicy="no-referrer" defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js" defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/2.3.10/purify.min.js" xintegrity="sha512-C3B32e/iyn0Lhj3mG4PzKAftE49fXUDf2l2Rk2HM71PaGNm1LpB4i/kXdiG5YkF1r83lWWI41D0OMfVYl43hJg==" crossorigin="anonymous" referrerpolicy="no-referrer" defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js" defer></script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript" defer></script>
    
    <!-- NEW: CropperJS Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js" defer></script>

    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <script src="https://cdn.quilljs.com/1.3.6/quill.js" defer></script>

    <!-- Firebase SDK Module -->
    <script type="module">
        // Firebase SDK imports
        import { initializeApp, deleteApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut, createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        // MODIFIED (STEP 6.C): Added 'collectionGroup'
        // FIX: Added 'increment' to imports to fix Payroll Delete crash
        import { getFirestore, collection, onSnapshot, doc, getDoc, addDoc, updateDoc, deleteDoc, query, where, serverTimestamp, getDocs, writeBatch, enableIndexedDbPersistence, setDoc, orderBy, limit, startAfter, runTransaction, deleteField, collectionGroup, arrayUnion, arrayRemove, increment } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Make Firebase SDK available globally for the Babel script
        window.firebaseSDK = {
            initializeApp, deleteApp, getAuth, getFirestore, collection, onSnapshot,
            doc, getDoc, addDoc, updateDoc, deleteDoc, query, where, serverTimestamp,
            signInWithEmailAndPassword, onAuthStateChanged, signOut, getDocs, writeBatch,
            enableIndexedDbPersistence, setDoc,
            // FIX: Added 'increment' to exports
            orderBy, limit, startAfter, createUserWithEmailAndPassword, runTransaction, deleteField, collectionGroup, arrayUnion, arrayRemove, increment
        };
    </script>
    
    <!-- React Application Script -->
    <script type="text/babel">
        // --- SERVICE WORKER REGISTRATION (ROBUST UPDATE HANDLER) ---
        // This logic runs outside React to ensure it catches updates even if React fails.
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./service-worker.js')
                    .then(registration => {
                        console.log('SW registered: ', registration);
                        
                        // 1. Check for updates immediately
                        registration.update();

                        // 2. Check for updates when app comes to foreground
                        document.addEventListener('visibilitychange', () => {
                            if (document.visibilityState === 'visible') {
                                registration.update();
                            }
                        });

                        // 3. Listen for new updates found
                        registration.onupdatefound = () => {
                            const installingWorker = registration.installing;
                            if (installingWorker == null) return;

                            installingWorker.onstatechange = () => {
                                if (installingWorker.state === 'installed') {
                                    if (navigator.serviceWorker.controller) {
                                        // New content is available; please refresh.
                                        showUpdateBanner(registration);
                                    } else {
                                        console.log('Content is cached for offline use.');
                                    }
                                }
                            };
                        };
                    })
                    .catch(error => console.log('SW Registration failed:', error));
            });

            // 4. Reload page when the new service worker takes control
            let refreshing;
            navigator.serviceWorker.addEventListener('controllerchange', () => {
                if (refreshing) return;
                window.location.reload();
                refreshing = true;
            });
        }

        // Helper: Create a safe, framework-agnostic banner
        const showUpdateBanner = (registration) => {
            if (document.getElementById('pwa-update-banner')) return;

            const banner = document.createElement('div');
            banner.id = 'pwa-update-banner';
            banner.style.cssText = `
                position: fixed; bottom: 20px; left: 20px; right: 20px; z-index: 9999;
                background-color: #2563eb; color: white; padding: 16px; border-radius: 12px;
                box-shadow: 0 10px 25px -5px rgba(0,0,0,0.5); display: flex; justify-content: space-between; align-items: center;
                animation: slideUp 0.5s ease-out; border: 1px solid #60a5fa;
            `;
            banner.innerHTML = `
                <div style="display:flex;align-items:center;gap:12px;">
                    <i class="fas fa-bolt" style="font-size:20px;"></i>
                    <div>
                        <div style="font-weight:bold;font-size:14px;">Update Available</div>
                        <div style="font-size:12px;opacity:0.9;">New features are ready!</div>
                    </div>
                </div>
                <button id="pwa-refresh-btn" style="background:white; color:#2563eb; border:none; padding:8px 16px; border-radius:8px; font-weight:bold; font-size:12px; cursor:pointer;">
                    REFRESH
                </button>
            `;
            
            // Inject styles for animation
            if (!document.getElementById('pwa-styles')) {
                const style = document.createElement('style');
                style.id = 'pwa-styles';
                style.innerHTML = '@keyframes slideUp { from { transform: translateY(100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }';
                document.head.appendChild(style);
            }

            document.body.appendChild(banner);

            document.getElementById('pwa-refresh-btn').onclick = () => {
                // Force unregister to clear old cache logic, then reload
                registration.unregister().then(() => {
                    window.location.reload();
                });
            };
        };

        // --- START REACT & FIREBASE SETUP ---
        const { useState, useEffect, useMemo, useCallback, createContext, useContext, memo, useRef } = React;

        // ... (rest of the React application code)
        // === FIREBASE CONFIGURATION ===
        // To deploy this application for a new company, replace the values in the
        // `firebaseConfig` object below with the new project's configuration details
        // from the Firebase console. This is the ONLY place you need to change it.
        // ===================================================================================
        const firebaseConfig = {
            apiKey: "AIzaSyB7_pnmwHj6aOeZRTykPvNusNFYReaTY6Q",
            authDomain: "hrsm-j.firebaseapp.com",
            projectId: "hrsm-j",
            storageBucket: "hrsm-j.appspot.com",
            messagingSenderId: "45063715478",
            appId: "1:45063715478:web:cc2dd21b83dd195771e0b7",
            measurementId: "G-8HQDG2LTKP"
        };

        // NEW: Dynamic Configuration Loader
        // Checks localStorage for an admin-saved configuration.
        // Falls back to the hardcoded config if nothing is found.
        let activeFirebaseConfig = firebaseConfig;
        try {
            const customConfigStr = localStorage.getItem('customFirebaseConfig');
            if (customConfigStr) {
                const customConfig = JSON.parse(customConfigStr);
                // Basic validation to ensure it's a valid config object
                if (customConfig.apiKey && customConfig.projectId) {
                    activeFirebaseConfig = customConfig;
                    console.log("Using custom Firebase configuration from localStorage.");
                }
            }
        } catch (error) {
            console.error("Failed to parse custom Firebase config, using default.", error);
        }

        // NEW: Connectivity Context for online/offline status
        const ConnectivityContext = createContext(null);
        const useConnectivity = () => useContext(ConnectivityContext);
        const ConnectivityProvider = ({ children }) => {
            const [isOnline, setIsOnline] = useState(navigator.onLine);

            useEffect(() => {
                const updateOnlineStatus = () => {
                    setIsOnline(navigator.onLine);
                };

                window.addEventListener('online', updateOnlineStatus);
                window.addEventListener('offline', updateOnlineStatus);

                // Set up a polling interval as a fallback for iframe environments where
                // the 'online'/'offline' events may not fire reliably. This checks the
                // navigator.onLine property directly every 3 seconds.
                const interval = setInterval(updateOnlineStatus, 3000);

                return () => {
                    window.removeEventListener('online', updateOnlineStatus);
                    window.removeEventListener('offline', updateOnlineStatus);
                    clearInterval(interval); // Cleanup on component unmount
                };
            }, []);

            return (
                <ConnectivityContext.Provider value={{ isOnline }}>
                    {children}
                </ConnectivityContext.Provider>
            );
        };

        // NEW: Offline Banner Component
        const OfflineBanner = () => {
            const { isOnline } = useConnectivity();
            if (isOnline) return null;
            
            return (
                <div className="bg-red-600 text-white text-center py-2 px-4 text-xs font-bold shadow-md animate-fade-in z-50 flex justify-center items-center gap-2">
                    <i className="fas fa-wifi-slash animate-pulse"></i>
                    <span>You are currently offline. Some features may not work and changes may not save immediately.</span>
                </div>
            );
        };

        // NEW: Skeleton Component for Loading States
        const DashboardSkeleton = () => (
            <div className="space-y-6 animate-fade-in pb-10">
                {/* Metrics Row */}
                <div className="grid grid-cols-2 lg:grid-cols-4 gap-3 sm:gap-6">
                    <div className="skeleton h-32 w-full"></div>
                    <div className="skeleton h-32 w-full"></div>
                    <div className="skeleton h-32 w-full"></div>
                    <div className="skeleton h-32 w-full"></div>
                </div>
                {/* Main Widgets Row */}
                <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div className="lg:col-span-2 skeleton h-80 w-full"></div>
                    <div className="lg:col-span-1 skeleton h-80 w-full"></div>
                </div>
                {/* Bottom Row */}
                <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div className="lg:col-span-1 skeleton h-64 w-full"></div>
                    <div className="lg:col-span-2 skeleton h-64 w-full"></div>
                </div>
            </div>
        );

        // Firebase Configuration - MOVED TO TOP OF SCRIPT

        // Firebase Context for providing db and auth instances throughout the app
        const FirebaseContext = createContext(null);
        const useFirebase = () => useContext(FirebaseContext);

        const FirebaseProvider = ({ children }) => {
            const [db, setDb] = useState(null);
            const [auth, setAuth] = useState(null);
            const [currentUser, setCurrentUser] = useState(null);
            
            // OPTIMIZATION: Load cached profile immediately to skip the 8s wait
            const [userProfile, setUserProfile] = useState(() => {
                try {
                    const cached = localStorage.getItem('hr_user_profile');
                    return cached ? JSON.parse(cached) : null;
                } catch(e) { return null; }
            });

            // OPTIMIZATION: If we have a cached profile, we are NOT loading visually.
            // This shows the Dashboard instantly while the network check happens in the background.
            const [loading, setLoading] = useState(!userProfile);

            // Initialize Firebase and Auth state listener
            useEffect(() => {
                try {
                    const { initializeApp, getFirestore, getAuth, onAuthStateChanged, enableIndexedDbPersistence } = window.firebaseSDK;
                    const app = initializeApp(activeFirebaseConfig);
                    const dbInstance = getFirestore(app);
                    
                    // Enable offline persistence
                    enableIndexedDbPersistence(dbInstance).catch((err) => {
                        // console.warn("Persistence error (harmless):", err.code);
                    });

                    const authInstance = getAuth(app);
                    setAuth(authInstance);
                    setDb(dbInstance);

                    const unsubscribe = onAuthStateChanged(authInstance, (user) => {
                        setCurrentUser(user);
                        if (!user) {
                            // User logged out: Clear Cache & State
                            setUserProfile(null);
                            localStorage.removeItem('hr_user_profile'); 
                            setLoading(false);
                        } else {
                            // User logged in: If we don't have a cached profile, we must show loading.
                            // If we DO have a cache, 'loading' stays false (Instant Load).
                            if (!userProfile) setLoading(true);
                        }
                    });
                    return () => unsubscribe();
                } catch (error) { 
                    console.error("Firebase initialization error:", error); 
                    setLoading(false);
                } 
            }, []);

            // Fetch user profile from Firestore when auth state changes
            useEffect(() => {
                if (!db || !currentUser) return;

                // Fetch fresh data silently
                const { collection, query, where, onSnapshot } = window.firebaseSDK;
                const q = query(collection(db, "employees"), where("uid", "==", currentUser.uid));
                
                const unsubscribe = onSnapshot(q, (snapshot) => {
                    if (!snapshot.empty) {
                        const userDoc = snapshot.docs[0];
                        const profileData = { id: userDoc.id, ...userDoc.data() };
                        
                        // Only update state if data actually changed to prevent re-renders
                        // We serialize to compare simply
                        if (JSON.stringify(profileData) !== JSON.stringify(userProfile)) {
                            setUserProfile(profileData);
                            localStorage.setItem('hr_user_profile', JSON.stringify(profileData)); // Update Cache
                        }
                    } else {
                        console.warn("Authenticated user has no employee profile in Firestore.");
                        // Only clear if we really expected one
                        if (userProfile) setUserProfile(null);
                    }
                    // Always turn off loading once the network check completes
                    setLoading(false);
                }, (error) => {
                    console.error("Error fetching user profile:", error);
                    setLoading(false);
                });

                return () => unsubscribe();
            }, [db, currentUser]);

            const value = { db, auth, currentUser, userProfile, loading };
            return <FirebaseContext.Provider value={value}>{children}</FirebaseContext.Provider>;
        };
        
        // Custom hook for real-time Firestore collection data
        // MODIFIED: Added 'persistKey' for instant offline loading (Stale-While-Revalidate pattern)
        const useCollection = (collectionName, queryConstraints = [], persistKey = null) => {
            const { db, currentUser } = useFirebase(); 
            
            // OPTIMIZATION: Initialize state from LocalStorage if key is provided
            const [data, setData] = useState(() => {
                if (persistKey) {
                    try {
                        const cached = localStorage.getItem(persistKey);
                        if (cached) {
                            // console.log(`Loaded ${collectionName} from cache.`);
                            return JSON.parse(cached);
                        }
                    } catch (e) {
                        console.error(`Error parsing cache for ${persistKey}`, e);
                    }
                }
                return [];
            });

            // OPTIMIZATION: If we have cached data, we are NOT loading.
            const [loading, setLoading] = useState(() => {
                if (persistKey && localStorage.getItem(persistKey)) return false;
                return true;
            });
            
            // FIX: Use a ref to store the serialized constraints to prevent effect loops
            const constraintsRef = useRef(JSON.stringify(queryConstraints));
            if (constraintsRef.current !== JSON.stringify(queryConstraints)) {
                constraintsRef.current = JSON.stringify(queryConstraints);
            }

            useEffect(() => {
                // If we have cache, we don't block. If no cache, set loading true.
                if ((!db || !currentUser)) { 
                    if (!persistKey || data.length === 0) setLoading(true);
                    return;
                }

                // Only set loading to true if we don't have cached data to show
                if ((!persistKey || data.length === 0)) setLoading(true);
                
                const { collection, onSnapshot, query } = window.firebaseSDK;
                
                const q = query(collection(db, collectionName), ...queryConstraints);
                
                const unsubscribe = onSnapshot(q, (querySnapshot) => {
                    const items = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    
                    // Update State
                    setData(items);
                    
                    // Update Cache (Silent Background Update)
                    if (persistKey) {
                        try {
                            localStorage.setItem(persistKey, JSON.stringify(items));
                        } catch (e) {
                            // Handle quota exceeded or storage errors silently
                            console.warn("LocalStorage full/error:", e);
                        }
                    }
                    
                    setLoading(false);
                }, (error) => {
                    console.error(`Error fetching collection ${collectionName}:`, error);
                    setLoading(false);
                });
                return () => unsubscribe();
            }, [db, currentUser, collectionName, constraintsRef.current, persistKey]); // Depend on stable string & persistKey
            
            return { data, loading };
        };

        // Custom hook for one-time Firestore collection data fetch
        const useStaticCollection = (collectionName) => {
            const { db, currentUser } = useFirebase();
            const [data, setData] = useState([]);
            const [loading, setLoading] = useState(true);

            useEffect(() => {
                if (!db || !currentUser) {
                    setLoading(true);
                    return;
                }

                const fetchData = async () => {
                    setLoading(true);
                    try {
                        const { collection, getDocs } = window.firebaseSDK;
                        const querySnapshot = await getDocs(collection(db, collectionName));
                        const items = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        setData(items);
                    } catch (error) {
                        console.error(`Error fetching static collection ${collectionName}:`, error);
                    } finally {
                        setLoading(false);
                    }
                };

                fetchData();
            }, [db, currentUser, collectionName]);

            return { data, loading };
        };
        
        // --- NEW: GLOBAL NAVIGATION CONFIGURATION (PHASE 2 - DETAILED MAPPING) ---
        // Defines all modules and their internal tabs for granular control.
        const APP_MODULES = [
            { 
                key: 'dashboard', 
                label: 'Dashboard', 
                icon: 'fa-chart-pie', 
                color: 'text-blue-500', 
                bg: 'bg-blue-500/10',
                tabs: [
                    { key: 'summary', label: 'Summary Widgets' },
                    { key: 'teamStatus', label: 'Team Status' },
                    { key: 'requestTracker', label: 'My Request Tracker' },
                    { key: 'birthdays', label: 'Birthday Celebrations' }
                ]
            },
            { 
                key: 'companyHub', 
                label: 'Company Hub', 
                icon: 'fa-building', 
                color: 'text-indigo-500', 
                bg: 'bg-indigo-500/10',
                tabs: [
                    { key: 'notices', label: 'Notice Board' },
                    { key: 'policies', label: 'Policy Library' }
                ] 
            },
            { 
                key: 'employees', 
                label: 'Employees', 
                icon: 'fa-user-group', 
                color: 'text-purple-500', 
                bg: 'bg-purple-500/10',
                tabs: [
                    { key: 'active', label: 'Active Employees' },
                    { key: 'salaryReport', label: 'Salary Revise Report' },
                    { key: 'former', label: 'Resigned/Terminated' }
                ] 
            },
            { 
                key: 'checkinme', 
                label: 'CheckInMe', 
                icon: 'fa-fingerprint', 
                color: 'text-cyan-400', 
                bg: 'bg-cyan-500/10',
                tabs: [
                    { key: 'checkInOut', label: 'Check In/Out' },
                    { key: 'leaveRequest', label: 'Leave Request' },
                    { key: 'otRequest', label: 'OT Request' },
                    { key: 'employeeState', label: 'Engagements/Deductions' }
                ] 
            },
            { 
                key: 'attendanceReport', 
                label: 'Attendance Report', 
                icon: 'fa-clipboard-user', 
                color: 'text-indigo-400', 
                bg: 'bg-indigo-500/10',
                tabs: [
                    { key: 'daily', label: 'Daily Report' },
                    { key: 'monthly', label: 'Monthly Work Day' }
                ] 
            },
            { 
                key: 'payroll', 
                label: 'Payroll', 
                icon: 'fa-sack-dollar', 
                color: 'text-emerald-400', 
                bg: 'bg-emerald-500/10',
                tabs: [
                    { key: 'calculator', label: 'Payroll Calculator' },
                    { key: 'history', label: 'Payroll History' }
                ] 
            },
            { 
                key: 'hrBanking', 
                label: 'HR Banking', 
                icon: 'fa-landmark', 
                color: 'text-yellow-500', 
                bg: 'bg-yellow-500/10',
                tabs: [
                    { key: 'loans', label: 'Loan Manager' },
                    { key: 'savings', label: 'Savings Program' }
                ] 
            },
            { 
                key: 'expenseReport', 
                label: 'Expense Report', 
                icon: 'fa-receipt', 
                color: 'text-pink-500', 
                bg: 'bg-pink-500/10',
                tabs: [
                    { key: 'payrollExpenses', label: 'Payroll Expenses' },
                    { key: 'operationalExpenses', label: 'Operational Expenses' }
                ] 
            },
            { 
                key: 'assets', 
                label: 'Asset Manager', 
                icon: 'fa-boxes-stacked', 
                color: 'text-orange-500', 
                bg: 'bg-orange-500/10',
                tabs: [
                    { key: 'main', label: 'Asset Dashboard' }
                ] 
            },
            { 
                key: 'tasks', 
                label: 'Task Manager', 
                icon: 'fa-list-check', 
                color: 'text-lime-400', 
                bg: 'bg-lime-500/10',
                tabs: [
                    { key: 'kanban', label: 'Task Board (Kanban)' },
                    { key: 'scorecard', label: 'KPI Scorecard' },
                    { key: 'meetingRoom', label: 'Meeting Room' }
                ] 
            }, 
            { 
                key: 'userActivity', 
                label: 'User Activity', 
                icon: 'fa-timeline', 
                color: 'text-teal-400', 
                bg: 'bg-teal-500/10',
                tabs: [
                    { key: 'logs', label: 'Activity Logs' },
                    { key: 'devices', label: 'Device Audit' } // NEW TAB
                ] 
            },
            { 
                key: 'settings', 
                label: 'Settings', 
                icon: 'fa-sliders', 
                color: 'text-gray-400', 
                bg: 'bg-gray-500/10',
                tabs: [
                    { key: 'shop', label: 'Shop & Shift' },
                    { key: 'position', label: 'Position & KPI' },
                    { key: 'expenses', label: 'Expense Categories' },
                    { key: 'memo', label: 'Memo Alert' },
                    { key: 'sysFeatures', label: 'System Features' },
                    { key: 'sysConfig', label: 'System Config' }
                ] 
            }
        ];
        
        // NEW: Standalone payroll calculation logic
        // MODIFIED: Added 'savingsWithdrawals' as a new argument
        // MODIFIED (STEP 5): Added 'savingsData' as a new argument
        const calculatePayrollForEmployee = (employee, selectedMonth, allData, manualLoanDeduction, savingsWithdrawals = [], savingsData = null) => {
            if (!employee || !selectedMonth) return { inputs: {}, calculations: {} };

            // NEW (Plan Step 1): Log the incoming withdrawal data to confirm it's being received.
            console.log(`[Payroll Calc] Received ${savingsWithdrawals.length} savings withdrawals for ${employee?.name} in ${selectedMonth}`, savingsWithdrawals);

            const { attendance, leaveRequests, otRequests, staffLoans, employeeStates, salaryRevisions, shops, shifts } = allData;

            // --- FIX: MOVED TIMEZONE LOGIC UP ---
            // We must get the employee's timezone *first* to correctly filter attendance by the local month.
            // 1. Determine the correct "home shop" name. Prioritize the new 'primaryShop' field.
            const employeeShopName = employee.primaryShop 
                ? employee.primaryShop // Use the new field if it exists
                : (Array.isArray(employee.shop) ? employee.shop[0] : employee.shop); // Fallback to old logic
            
            // 2. Find the shop details from the allData.shops list
            const employeeShop = (shops || []).find(s => s.name === employeeShopName);
            
            // 3. Get the timezone. This will now be the timezone of the primary shop.
            const employeeShopTimezone = employeeShop?.timezone; // e.g., 'Asia/Phnom_Penh'

            // --- 1. Filter data for the selected employee and month ---
            
            // FIX: The original filter used .toISOString().startsWith(selectedMonth), which is timezone-unaware
            // and caused the bug. This new filter uses the employee's shop timezone to get the correct
            // set of attendance records for their local month.
            const monthAttendance = (attendance || []).filter(r => {
                if (r.employeeId !== employee.id) return false;
                if (!r.timestamp || !r.timestamp.toDate) return false;
                // Get the record's local date (e.g., '2025-11-12') using the employee's primary shop timezone
                const { localDate } = Utils.formatDateInTimezone(r.timestamp, employeeShopTimezone);
                // Check if that local date's month (e.g., '2025-11') matches the selected month
                return localDate.startsWith(selectedMonth);
            });
            const monthLeave = (leaveRequests || []).filter(r => r.staffId === employee.id && r.status === 'Approved' && r.leaveDate.startsWith(selectedMonth));
            const monthOT = (otRequests || []).filter(r => r.staffId === employee.id && r.status === 'Approved' && r.reqDate.startsWith(selectedMonth));
            const monthStates = (employeeStates || []).filter(r => r.staffId === employee.id && r.date.startsWith(selectedMonth));
            
            // --- FIX: Corrected loan-finding logic ---
            // The previous .find() logic was not deterministic and could grab the wrong loan
            // if an employee had multiple active loans.
            // This new logic finds ALL applicable loans and sorts them to get the one
            // with the most recent effectiveDate that is on or before the selected month.
            const applicableLoans = (staffLoans || [])
                .filter(l => l.staffId === employee.id && 
                             l.status === 'Active' && 
                             (!l.effectiveDate || l.effectiveDate.slice(0, 7) <= selectedMonth)
                )
                .sort((a, b) => (b.effectiveDate || '0000-00').localeCompare(a.effectiveDate || '0000-00'));
            
            const activeLoan = applicableLoans.length > 0 ? applicableLoans[0] : null;
            // --- END FIX ---

            // --- MOVED UP: Calculate Base Salary & Salary Per Day first, as it's needed for penalty calculation ---
            const [year, month] = selectedMonth.split('-').map(Number);
            const daysInMonth = new Date(year, month, 0).getDate();
            const applicableRevisions = (salaryRevisions || [])
                .filter(rev => rev.staffId === employee.id && rev.effectiveDate && rev.effectiveDate <= `${selectedMonth}-31` && rev.status === 'Approved')
                .sort((a, b) => b.effectiveDate.localeCompare(a.effectiveDate));
            
            // --- START FIX: Prevent NaN from employee.salary or updatedSalary ---
            // The (parseFloat(...) || 0) pattern is flawed, as (NaN || 0) results in NaN.
            // We must explicitly check for NaN.
            let parsedBaseSalary;
            if (applicableRevisions.length > 0) {
                parsedBaseSalary = parseFloat(String(applicableRevisions[0].updatedSalary).replace(/[^0-9.-]/g, ''));
            } else {
                parsedBaseSalary = parseFloat(String(employee.salary).replace(/[^0-9.-]/g, ''));
            }
            
            const baseSalary = isNaN(parsedBaseSalary) ? 0 : parsedBaseSalary;
            // --- END FIX ---
            
            const salaryPerDay = baseSalary > 0 && daysInMonth > 0 ? baseSalary / daysInMonth : 0;


            // --- 2. Calculate inputs automatically ---
            const leaveDays = monthLeave.reduce((sum, r) => sum + (parseFloat(r.numberOfDays) || 0), 0);
            const otDays = monthOT.reduce((sum, r) => sum + (parseFloat(r.numberOfOTDays) || 0), 0);
            
            // --- FIX: Separate auto-calculation from manual override ---
            // 1. Calculate the "pure" automatic loan deduction first.
            const autoLoanDeduction = (activeLoan ? parseFloat(activeLoan.agreedMonthlyDeduction) || 0 : 0);
            // 2. Use the manual override if it exists, otherwise use the auto-value.
            const loanDeduction = manualLoanDeduction !== undefined ? parseFloat(manualLoanDeduction) : autoLoanDeduction;
            // --- END FIX ---
            
            const totalLateDays = monthStates.filter(es => es.statusState === 'Deduction' && es.note?.includes('CheckIn Late @')).length;

            // --- NEW (STEP 2): Get the employee's primary shop and their assigned timezone. This is crucial for all date calculations. ---
            // 1. Determine the correct "home shop" name. Prioritize the new 'primaryShop' field.
            // --- THIS BLOCK (lines 2198-2207) IS NOW MOVED to line 2158 ---
            /*
            const employeeShopName = employee.primaryShop 
                ? employee.primaryShop // Use the new field if it exists
                : (Array.isArray(employee.shop) ? employee.shop[0] : employee.shop); // Fallback to old logic

            // 2. Find the shop details from the allData.shops list
            const employeeShop = (shops || []).find(s => s.name === employeeShopName);
            
            // 3. Get the timezone. This will now be the timezone of the primary shop.
            const employeeShopTimezone = employeeShop?.timezone; // e.g., 'Asia/Phnom_Penh'
            */

            const dailyRecords = {};
            monthAttendance.forEach(rec => {
                // FIX: Use the timezone-aware utility to get the date key based on the shop's local timezone.
                const { localDate: dayKey } = Utils.formatDateInTimezone(rec.timestamp, employeeShopTimezone);
                
                if (!dailyRecords[dayKey]) dailyRecords[dayKey] = [];
                // Push the original Javascript Date object for time difference calculations.
                dailyRecords[dayKey].push({ date: rec.timestamp.toDate(), type: rec.type });
            });
            
            let workDays = 0;
            let noCheckOutCount = 0;
            // FIX: Get today's date string formatted in the shop's local timezone to correctly identify past vs. present days.
            const { localDate: todayStr } = Utils.formatDateInTimezone({ toDate: () => new Date() }, employeeShopTimezone);


            Object.entries(dailyRecords).forEach(([dayKey, dayRecs]) => {
                const ins = dayRecs.filter(r => r.type === 'in').sort((a,b) => a.date - b.date);
                const outs = dayRecs.filter(r => r.type === 'out').sort((a,b) => b.date - a.date);
                if (ins.length > 0 && outs.length > 0) {
                    const diffHours = (outs[0].date.getTime() - ins[0].date.getTime()) / 3600000;
                    if (diffHours >= 7) workDays += 1;
                    else if (diffHours >= 4) workDays += 0.5;
                } else if (ins.length > 0 && dayKey < todayStr) {
                    noCheckOutCount += 1;
                }
            });

            // NEW: Calculate Absent days & Penalty for absence on a rejected leave day.
            const attendedDays = new Set(Object.keys(dailyRecords));
            let absentDays = 0;
            let rejectedLeavePenaltyAmount = 0; // Initialize penalty amount

            for (let day = 1; day <= daysInMonth; day++) {
                const currentDay = new Date(year, month - 1, day);
                const loop_year = currentDay.getFullYear();
                const loop_month = String(currentDay.getMonth() + 1).padStart(2, '0');
                const loop_day = String(currentDay.getDate()).padStart(2, '0');
                const dayKey = `${loop_year}-${loop_month}-${loop_day}`;

                // FIX: Compare against the timezone-aware 'today' string instead of a local Date object.
                if (dayKey >= todayStr) break; // Don't count today or future days as absent.

                // An absence is a past day with no attendance record.
                if (!attendedDays.has(dayKey)) {
                    // FIX: Check if the employee was on approved leave for this day before marking as absent.
                    const isOnApprovedLeave = monthLeave.some(lr => dayKey >= lr.leaveDate && dayKey < lr.returnDate);
                    
                    if (!isOnApprovedLeave) {
                        absentDays++; // Only count as absent if not on approved leave.

                        // Check if there was a REJECTED leave request for this absent day.
                        const hadRejectedLeave = (leaveRequests || []).some(
                            lr => lr.staffId === employee.id &&
                                  lr.status === 'Rejected' &&
                                  // Check if the absent day falls within the rejected leave period.
                                  dayKey >= lr.leaveDate && dayKey < lr.returnDate 
                        );
                        
                        if (hadRejectedLeave) {
                            // Apply penalty: Salary per day x 2
                            rejectedLeavePenaltyAmount += (salaryPerDay * 2);
                        }
                    }
                }
            }
            
            const noAttendance = absentDays + noCheckOutCount;

            // NEW: Calculate "Given Off Days" based on the total number of work days.
            const givenOffDays = Math.floor(workDays / 6.5);

            // FIX: Create the autoInputs object to be returned, now including noAttendance.
            // --- MODIFIED: Also add the new autoLoanDeduction field ---
            const autoInputs = { workDays, givenOffDays, otDays, leaveDays, totalLateDays, noCheckOutCount, loanDeduction, noAttendance, autoLoanDeduction: autoLoanDeduction };

            // --- 3. Perform Final Salary Calculations ---
            const engagements = monthStates.filter(es => es.statusState === 'Engagement' && es.status === 'Approved').reduce((sum, item) => sum + (parseFloat(item.amount) || 0), 0);
            
            const lateDeductionsAmount = monthStates.filter(es => {
                if (!(es.statusState === 'Deduction' && es.note?.includes('CheckIn Late @'))) return false;
                const hasLeave = (leaveRequests || []).some(lr => lr.staffId === es.staffId && lr.status === 'Approved' && es.date >= lr.leaveDate && es.date < lr.returnDate);
                return !hasLeave;
            }).reduce((sum, item) => sum + (parseFloat(item.amount) || 0), 0);
            
            const otherDeductions = monthStates.filter(es => es.statusState === 'Deduction' && !es.note?.includes('CheckIn Late @')).reduce((sum, item) => sum + (parseFloat(item.amount) || 0), 0);

            // "No-CheckOut" is informational. Any associated monetary deduction is handled via the "Other Deductions" from Employee States.
            const daysToPayFor = (workDays || 0) + (givenOffDays || 0);
            const baseSalaryEarned = salaryPerDay * (daysToPayFor > 0 ? daysToPayFor : 0);
            const otSalary = salaryPerDay * (otDays || 0);
            
            // --- NEW (Plan Step 2, Part B): Calculate total savings withdrawal ---
            // Sum up all withdrawal amounts. This will be added to earnings.
            const totalSavingsWithdrawal = (savingsWithdrawals || []).reduce(
                (sum, tx) => sum + (parseFloat(tx.amountWithdrawn) || 0), 0
            );
            
            // MODIFIED (Plan Step 2, Part B): Add the savings withdrawal to the gross salary.
            const grossSalary = baseSalaryEarned + otSalary + engagements + totalSavingsWithdrawal;

            // --- NEW: Step 3 - Calculate Voluntary Savings Deduction ---
            let savingsDeduction = 0;
            // MODIFIED (STEP 5): This logic is now refactored to use the new 'savingsData' object
            // instead of the deprecated fields on the 'employee' object.
            if (
                savingsData && // Check if savingsData object exists
                savingsData.savingsProgramStatus === 'Active' &&
                parseFloat(savingsData.savingsPercentage) > 0 &&
                savingsData.savingsEffectiveMonth && 
                selectedMonth >= savingsData.savingsEffectiveMonth &&
                totalSavingsWithdrawal === 0 // Only deduct if no withdrawal
            ) {
                const percentage = parseFloat(savingsData.savingsPercentage) / 100;
                // Round the savings deduction
                savingsDeduction = Math.round(grossSalary * percentage);
            }
            // --- END: Step 3 ---
            
            // CORRECTED & UPDATED: Added the new penalty AND savings deduction to total deductions.
            const totalDeductions = loanDeduction + lateDeductionsAmount + otherDeductions + rejectedLeavePenaltyAmount + savingsDeduction;
            
            // FIX (Bug #4): Round the final netSalary to handle potential floating point inaccuracies.
            // Since KHR is the primary currency and has no decimal units, rounding to the nearest
            // whole number ensures a clean, accurate final value.
            const netSalary = Math.round(grossSalary - totalDeductions);

            // CORRECTED & UPDATED: Added new penalty and savings amounts to the returned calculations object.
            // MODIFIED (Plan Step 2): Add 'totalSavingsWithdrawal' to the calculations object.
            const calculations = { baseSalary, salaryPerDay, daysInMonth, baseSalaryEarned, otSalary, engagements, totalSavingsWithdrawal, grossSalary, otherDeductions, totalDeductions, netSalary, lateDeductionsAmount, rejectedLeavePenaltyAmount, savingsDeduction };

            return { inputs: autoInputs, calculations };
        };
        
        // NEW: Centralized Payroll Calculator Hook
        // MODIFIED: Added 'savingsWithdrawals' as a new argument and to the dependency array
        // MODIFIED (STEP 5): Added 'savingsData' as a new argument
        const usePayrollCalculator = (employee, selectedMonth, allData, manualLoanDeduction, savingsWithdrawals, savingsData) => {
            return useMemo(() => {
                // The complex logic is now in a separate function.
                // MODIFIED: Pass 'savingsWithdrawals' to the core function
                // MODIFIED (STEP 5): Pass 'savingsData' to the core function
                return calculatePayrollForEmployee(employee, selectedMonth, allData, manualLoanDeduction, savingsWithdrawals, savingsData);
            }, [employee, selectedMonth, allData, manualLoanDeduction, savingsWithdrawals, savingsData]); // MODIFIED (STEP 5): Added 'savingsData'
        };

        // NEW: Phase 3 - App Data Context for centralizing common data
        const AppDataContext = createContext(null);
        const useAppData = () => useContext(AppDataContext);

        const AppDataProvider = ({ children }) => {
            const { userProfile, db } = useFirebase();
            const { where } = window.firebaseSDK;
            
            // Create role-based query constraints to prevent permission errors.
            const employeeQueryConstraints = useMemo(() => {
                if (!userProfile) {
                    return [where("uid", "==", "null")];
                }
                const { role, uid, shop } = userProfile;

                if (role === 'Admin' || role === 'CEO' || role === 'Shop Manager') {
                    return [];
                }

                // FIX: Staff need to see colleagues for Birthday/Social features.
                if (role === 'Staff') {
                    const shopName = Array.isArray(shop) ? shop[0] : shop;
                    if (shopName) {
                        return [where("shop", "==", shopName), where("status", "==", "Active")];
                    }
                }

                // Fallback: If no shop assigned, only show self
                return [where("uid", "==", uid)];
            }, [userProfile?.role, userProfile?.uid, JSON.stringify(userProfile?.shop)]); // Deep compare shop array

            // FIX: Applied 'persistKey' to all global collections for instant load
            // Employees cache is keyed by User ID to ensure different users don't see wrong cached data on shared devices
            const employeesCacheKey = userProfile ? `hr_cache_employees_${userProfile.uid}` : null;
            
            const { data: employees, loading: employeesLoading } = useCollection('employees', employeeQueryConstraints, employeesCacheKey);
            const { data: shops, loading: shopsLoading } = useCollection('shops', [], 'hr_cache_shops');
            const { data: shifts, loading: shiftsLoading } = useCollection('shifts', [], 'hr_cache_shifts');
            const { data: positions, loading: positionsLoading } = useCollection('positions', [], 'hr_cache_positions');
            
            // NEW: Fetch Expense Categories in real-time
            const { data: expenseCategories, loading: categoriesLoading } = useCollection('expenseCategories', [], 'hr_cache_expense_cats');

            // NEW: Fetch KPIs globally
            const { data: kpis, loading: kpisLoading } = useCollection('kpis', [], 'hr_cache_kpis');

            // --- FIX START: Fetch System Configuration for Feature Toggles ---
            // We use 'systemConfig' collection as the single source of truth for toggles.
            const { data: sysConfigData, loading: configLoading } = useCollection('systemConfig', [], 'hr_cache_sys_config');
            
            const moduleConfig = useMemo(() => {
                if (!sysConfigData) return {};
                const configDoc = sysConfigData.find(d => d.id === 'modules');
                // Return the document data which contains keys like "settings:shop": false
                return configDoc ? configDoc : {};
            }, [sysConfigData]);

            // NEW: Fetch Global System Settings (e.g. Late Deduction Amount)
            const systemSettings = useMemo(() => {
                if (!sysConfigData) return {};
                const configDoc = sysConfigData.find(d => d.id === 'global');
                return configDoc ? configDoc : {};
            }, [sysConfigData]);
            // --- FIX END ---

            // --- NEW: SAFETY TIMEOUT (Resilience Fix) ---
            // If Firebase takes more than 8 seconds to connect (e.g. "Backend didn't respond"), 
            // force the app to load so the user can see the UI (possibly in offline mode with cached data).
            const [forceShow, setForceShow] = useState(false);
            
            useEffect(() => {
                const timer = setTimeout(() => {
                    setForceShow(true);
                }, 8000); // 8 seconds safety valve
                return () => clearTimeout(timer);
            }, []);

            // Combine all loading states into a single flag.
            // If forceShow is true, we ignore individual loading states.
            const isLoading = !forceShow && (employeesLoading || shopsLoading || shiftsLoading || positionsLoading || categoriesLoading || kpisLoading || configLoading);

            const value = useMemo(() => ({
                employees,
                shops,
                shifts,
                positions,
                expenseCategories, 
                kpis,              
                moduleConfig, // Expose the correct config object
                systemSettings, // NEW: Expose global settings
                isLoading
            }), [employees, shops, shifts, positions, expenseCategories, kpis, moduleConfig, systemSettings, isLoading]);

            return (
                <AppDataContext.Provider value={value}>
                    {children}
                </AppDataContext.Provider>
            );
        };
        // --- END REACT & FIREBASE SETUP ---

        // --- START UTILITY FUNCTIONS ---
        const Utils = {
            formatCurrency: (value, currency = 'KHR') => {
                if (value === null || value === undefined) return '';
                const num = parseFloat(String(value).replace(/[^0-9.-]/g, ''));
                if (isNaN(num)) return '';
                const options = { style: 'currency', currency: currency, minimumFractionDigits: currency === 'KHR' ? 0 : 2, maximumFractionDigits: currency === 'KHR' ? 0 : 2 };
                const locale = currency === 'KHR' ? 'km-KH' : 'en-US';
                let formatted = new Intl.NumberFormat(locale, options).format(num);
                if (currency === 'KHR') { formatted = formatted.replace('KHR', '').trim(); }
                return formatted;
            },
            formatRequestDate: (timestamp) => {
                if (!timestamp || !timestamp.toDate) return 'N/A';
                const date = timestamp.toDate();
                return `${date.toLocaleDateString('en-GB', { day: '2-digit', month: '2-digit', year: '2-digit' })} | ${date.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: true })}`;
            },
            formatISOToDisplay: (isoDate) => {
                if (!isoDate || typeof isoDate !== 'string' || !isoDate.includes('-')) return isoDate || '';
                const [year, month, day] = isoDate.split('-');
                return `${day}-${month}-${year}`;
            },
            calculateWorkedDuration: (joinedDate, endDate) => { // Add endDate parameter
                if (!joinedDate) return 'N/A';
                const start = new Date(joinedDate);
                if (isNaN(start.getTime())) return 'N/A';
                const end = endDate ? new Date(endDate) : new Date(); // Use endDate if provided, else use now
                if (isNaN(end.getTime())) return 'N/A'; // Add a check for a valid end date

                let years = end.getFullYear() - start.getFullYear();
                let months = end.getMonth() - start.getMonth();
                let days = end.getDate() - start.getDate();
                if (days < 0) { months--; days += new Date(end.getFullYear(), end.getMonth(), 0).getDate(); }
                if (months < 0) { years--; months += 12; }
                return `${years}Y ${months}M ${days}D`;
            },
            // NEW: Timezone-aware date formatting utility
            formatDateInTimezone: (timestamp, timezone) => {
                // Return defaults if the timestamp is invalid
                if (!timestamp || !timestamp.toDate) {
                    return { localDate: 'N/A', displayDate: 'N/A', localTime: 'N/A' };
                }

                const date = timestamp.toDate();
                // Use the provided timezone, but fall back to the user's browser timezone if it's missing.
                const tz = timezone || Intl.DateTimeFormat().resolvedOptions().timeZone;

                try {
                    // 'sv-SE' (Swedish) locale reliably gives the YYYY-MM-DD format.
                    const localDate = date.toLocaleDateString('sv-SE', { timeZone: tz });
                    
                    // 'en-GB' gives the DD/MM/YYYY format for display purposes.
                    const displayDate = date.toLocaleDateString('en-GB', { day: '2-digit', month: '2-digit', year: 'numeric', timeZone: tz });

                    const localTime = date.toLocaleTimeString('en-US', {
                        hour: '2-digit', minute: '2-digit', hour12: true, timeZone: tz
                    });

                    return { localDate, displayDate, localTime };
                } catch (error) {
                    console.error("Invalid timezone provided to formatter:", timezone, error);
                    // If the provided timezone is invalid, fall back to basic UTC conversion to prevent crashes.
                    const localDate = date.toISOString().split('T')[0];
                    return { localDate, displayDate: localDate, localTime: date.toUTCString() };
                }
            },
            // Haversine formula to calculate distance between two lat/lon points
            getDistance: (lat1, lon1, lat2, lon2) => {
                const R = 6371e3; // Earth's radius in metres
                const 1 = lat1 * Math.PI/180; const 2 = lat2 * Math.PI/180;
                const  = (lat2-lat1) * Math.PI/180; const  = (lon2-lon1) * Math.PI/180;
                const a = Math.sin(/2) * Math.sin(/2) + Math.cos(1) * Math.cos(2) * Math.sin(/2) * Math.sin(/2);
                const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
                return R * c; // Distance in metres
            },

            // --- NEW FUNCTION FOR SALARY SAVING PROGRAM (STEP 1) ---
            // This function transactionally processes a savings contribution to ensure data integrity.
            // It updates the employee's total balance and creates an audit log entry simultaneously.
            // MODIFIED (STEP 3): Added 'shop' parameter for denormalization.
            // MODIFIED (Feature: Cash Deposit): Added 'note' parameter.
            // MODIFIED (Feature: Custom Date): Added 'customDate' parameter.
            manageSavingsContribution: async (db, employeeId, employeeName, shop, amount, payrollId, note, customDate) => {
                // MODIFIED: Switched from runTransaction to writeBatch + increment to avoid Read Quota errors.
                const { doc, collection, serverTimestamp, writeBatch, increment } = window.firebaseSDK;
                const savingsRef = doc(db, 'savingprogram', employeeId);
                const transactionRef = doc(collection(db, 'savingprogram', employeeId, 'transactions'));
        
                try {
                    // NEW: Log the data being passed into the function
                    console.log(`[Savings OPTIMIZED] manageSavingsContribution called:`, { employeeId, employeeName, shop, amount, payrollId, note, customDate });

                    const batch = writeBatch(db);

                    // Operation 1: Atomic Increment of Balance (Requires NO Reads)
                    // If the document doesn't exist, 'set' with merge will create it, treating missing fields as 0 before incrementing.
                    batch.set(savingsRef, { 
                        employeeId: employeeId,
                        employeeName: employeeName,
                        shop: shop || 'N/A',
                        // Atomic increments allow us to update the balance without knowing the current value
                        currentBalance: increment(amount), 
                        mySavingCredit: increment(amount), // Credit tracks total deposited over time
                        lastUpdated: serverTimestamp(),
                        // Ensure status is Active if we are creating a new doc, otherwise merge preserves existing
                        savingsProgramStatus: 'Active' 
                    }, { merge: true });

                    // Operation 2: Create a new transaction log for this specific contribution.
                    // FIX: Append 'T12:00:00' to customDate to force it to Local Noon. 
                    const transactionDate = customDate ? new Date(`${customDate}T12:00:00`) : serverTimestamp();

                    batch.set(transactionRef, {
                        employeeId: employeeId,
                        staffName: employeeName, // Denormalized field
                        shop: shop || 'N/A', // FIX: Prevent undefined 'shop' from failing the transaction
                        date: transactionDate,
                        amountDeducted: amount,
                        type: 'contribution',
                        payrollId: payrollId || null,
                        // MODIFIED (Feature: Cash Deposit): Smart default for the note
                        note: note || (payrollId ? 'Payroll Deduction' : 'Manual Cash Deposit') 
                    });
                    
                    // Commit both operations together
                    await batch.commit();
                    
                    console.log(`[Savings SUCCESS] Savings contribution of ${amount} for ${employeeName} processed successfully.`);
                    return { success: true };
                } catch (error) {
                    console.error("Error within manageSavingsContribution batch: ", error);
                    // NEW: Better error handling for Quota Exceeded
                    if (error.code === 'resource-exhausted') {
                        return { success: false, error: { message: "Daily Quota Exceeded. Writes failed. Please try again tomorrow or upgrade your Firebase plan." } };
                    }
                    return { success: false, error: error };
                }
            },
            // --- NEW FUNCTION FOR SALARY SAVING PROGRAM (STEP 2: Payback) ---
            // This function transactionally processes a savings withdrawal.
            // MODIFIED (STEP 3): Added 'employeeName' and 'shop' parameters for denormalization.
            manageSavingsWithdrawal: async (db, employeeId, employeeName, shop, amount, note) => {
                const { doc, collection, serverTimestamp, runTransaction } = window.firebaseSDK;
                // MODIFIED (STEP 3): Path changed to new '/savingprogram' collection.
                const savingsRef = doc(db, 'savingprogram', employeeId);
                // MODIFIED (STEP 3): Path changed to new '/savingprogram/{id}/transactions' subcollection.
                const transactionRef = doc(collection(db, 'savingprogram', employeeId, 'transactions'));
        
                try {
                    await runTransaction(db, async (transaction) => {
                        const savingsDoc = await transaction.get(savingsRef);
        
                        if (!savingsDoc.exists()) {
                            throw new Error("Employee has no savings record to withdraw from.");
                        }
        
                        // --- BUG FIX: Correctly parse floats, handling NaN/undefined/null ---
                        const parseSafeFloat = (val) => {
                            if (val === null || val === undefined) return 0;
                            const num = parseFloat(val);
                            return isNaN(num) ? 0 : num;
                        };

                        const currentBalance = parseSafeFloat(savingsDoc.data().currentBalance);
                        let currentCredit = parseSafeFloat(savingsDoc.data().mySavingCredit);
                        const currentWithdrawals = parseSafeFloat(savingsDoc.data().mySavingWithdrawalTotal);
                        // --- END BUG FIX ---

                        // --- NEW: Data-Integrity Patch (as requested) ---
                        // This patch detects and fixes legacy data where mySavingCredit was 0
                        // (or null) but currentBalance was correct.
                        if ((currentCredit === 0 || currentCredit === null) && currentBalance > 0) {
                            console.warn(`[Savings Patch: Withdrawal] Fixing inconsistent data for ${employeeId}.`);
                            // Back-calculate the correct total credit.
                            currentCredit = currentBalance + currentWithdrawals;
                            
                            // We also update the database field immediately to fix it permanently.
                            // This is safe because we are already in a transaction.
                            transaction.update(savingsRef, { mySavingCredit: currentCredit });
                        }
                        // --- END: Data-Integrity Patch ---
                        
                        if (amount > currentBalance) {
                            throw new Error("Withdrawal amount cannot exceed the current balance.");
                        }
        
                        // MODIFIED: Implement new logic
                        const newWithdrawals = currentWithdrawals + amount;
                        
                        // --- REVERTING PREVIOUS FIX ---
                        // Now that 'currentCredit' is patched and correct, we can
                        // safely use the original "source of truth" formula.
                        const newBalance = currentCredit - newWithdrawals;
        
                        // Operation 1: Update the employee's total savings balance.
                        transaction.update(savingsRef, { 
                            currentBalance: newBalance, 
                            mySavingWithdrawalTotal: newWithdrawals, // NEW: Set the new withdrawal total
                            lastUpdated: serverTimestamp() 
                        });
        
                        // Operation 2: Create a new transaction log for this withdrawal.
                        // MODIFIED (STEP 3): Added 'staffName' and 'shop' for denormalization.
                        transaction.set(transactionRef, {
                            employeeId: employeeId,
                            staffName: employeeName, // Denormalized field
                            shop: shop, // Denormalized field
                            date: serverTimestamp(),
                            amountWithdrawn: amount,
                            type: 'withdrawal',
                            note: note || 'Manual payback'
                        });
                    });
                    console.log(`Savings withdrawal of ${amount} for ${employeeId} processed successfully.`);
                    return { success: true };
                } catch (error) {
                    console.error("Error within manageSavingsWithdrawal transaction: ", error);
                    return { success: false, error: error };
                }
            },
            
            // --- NEW: Function to REVERSE a savings withdrawal transactionally ---
            reverseSavingsWithdrawal: async (db, txToReverse) => {
                const { doc, serverTimestamp, runTransaction } = window.firebaseSDK;
                
                // Ensure we have the necessary IDs to build document references
                if (!txToReverse || !txToReverse.employeeId || !txToReverse.id) {
                    return { success: false, error: new Error("Invalid transaction data provided.") };
                }

                const savingsRef = doc(db, 'savingprogram', txToReverse.employeeId);
                const transactionRef = doc(db, 'savingprogram', txToReverse.employeeId, 'transactions', txToReverse.id);

                try {
                    await runTransaction(db, async (transaction) => {
                        const savingsDoc = await transaction.get(savingsRef);

                        if (!savingsDoc.exists()) {
                            throw new Error("Employee has no savings record. Cannot reverse.");
                        }

                        // Helper to safely parse floats
                        const parseSafeFloat = (val) => {
                            if (val === null || val === undefined) return 0;
                            const num = parseFloat(val);
                            return isNaN(num) ? 0 : num;
                        };

                        const currentBalance = parseSafeFloat(savingsDoc.data().currentBalance);
                        let currentCredit = parseSafeFloat(savingsDoc.data().mySavingCredit);
                        const currentWithdrawals = parseSafeFloat(savingsDoc.data().mySavingWithdrawalTotal);
                        const amountToReverse = parseSafeFloat(txToReverse.amountWithdrawn);

                        // --- Data-Integrity Patch (same as in other functions) ---
                        if ((currentCredit === 0 || currentCredit === null) && (currentBalance > 0 || currentWithdrawals > 0)) {
                            console.warn(`[Savings Patch: Reversal] Fixing inconsistent data for ${txToReverse.employeeId}.`);
                            currentCredit = currentBalance + currentWithdrawals;
                            // Update the main doc immediately since we're in a transaction
                            transaction.update(savingsRef, { mySavingCredit: currentCredit });
                        }
                        // --- END: Data-Integrity Patch ---
                        
                        // Calculate new totals
                        const newWithdrawalTotal = currentWithdrawals - amountToReverse;
                        
                        // Use the "source of truth" formula to recalculate the balance
                        const newBalance = currentCredit - newWithdrawalTotal;

                        // Operation 1: Update the main savings document
                        transaction.update(savingsRef, {
                            currentBalance: newBalance,
                            mySavingWithdrawalTotal: newWithdrawalTotal,
                            lastUpdated: serverTimestamp()
                        });
                        
                        // Operation 2: Delete the withdrawal transaction log
                        transaction.delete(transactionRef);
                    });
                    
                    console.log(`Savings withdrawal ${txToReverse.id} of ${amountToReverse} for ${txToReverse.employeeId} reversed successfully.`);
                    return { success: true };
                } catch (error) {
                    console.error("Error within reverseSavingsWithdrawal transaction: ", error);
                    return { success: false, error: error };
                }
            },
            
            // --- NEW: Function to log user activity ---
            logUserActivity: async (db, auth, action, targetInfo = {}) => {
                const { addDoc, collection, serverTimestamp } = window.firebaseSDK;
                const userId = auth?.currentUser?.uid;
                if (!db || !userId) {
                    console.warn("User activity logging failed: DB or User not available.");
                    return;
                }

                try {
                    await addDoc(collection(db, 'userLogs'), {
                        userId: userId,
                        action: action, // e.g., "Add Employee"
                        targetId: targetInfo.id || null, // e.g., the employee's ID
                        targetName: targetInfo.name || null, // e.g., the employee's name
                        originalData: targetInfo.originalData || null, // Data *before* the change
                        updatedData: targetInfo.updatedData || null,   // Data *after* the change
                        timestamp: serverTimestamp()
                    });
                } catch (error) {
                    console.error("Failed to write user activity log:", error);
                }
            },

            // FIX: Added missing exportToExcel utility function
            exportToExcel: (data, sheetName, fileName, columnWidths = []) => {
                if (!window.XLSX) {
                    alert("Excel export library is loading. Please wait a moment and try again.");
                    return;
                }
                const worksheet = window.XLSX.utils.json_to_sheet(data);
                const workbook = window.XLSX.utils.book_new();
                window.XLSX.utils.book_append_sheet(workbook, worksheet, sheetName);
                if (columnWidths.length > 0) {
                    worksheet["!cols"] = columnWidths;
                }
                window.XLSX.writeFile(workbook, fileName);
            },

            // FIX: Populated LIBS to ensure lazy loading works for all features
            LIBS: {
                HTML5QR: "https://unpkg.com/html5-qrcode",
                XLSX: "https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js",
                CROPPER: "https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js",
                DOMPURIFY: "https://cdnjs.cloudflare.com/ajax/libs/dompurify/2.3.10/purify.min.js",
                QRIOUS: "https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"
            },
            
            loadScript: (src) => { 
                return new Promise((resolve, reject) => { 
                    if (document.querySelector(`script[src="${src}"]`)) {
                        resolve(); 
                        return; 
                    }
                    const s = document.createElement('script'); 
                    s.src = src; 
                    s.onload = resolve; 
                    s.onerror = reject;
                    document.head.appendChild(s); 
                }); 
            },

            // --- NEW: Enhanced Device Fingerprinting (Brand + Model Name) ---
            getDeviceInfo: async () => {
                let model = "";
                let platform = "";
                const ua = navigator.userAgent;

                // 1. Try Client Hints (Modern Android/Chrome)
                if (navigator.userAgentData && navigator.userAgentData.getHighEntropyValues) {
                    try {
                        const hints = await navigator.userAgentData.getHighEntropyValues(['model', 'platform', 'platformVersion']);
                        if (hints.model) model = hints.model;
                        if (hints.platform) platform = hints.platform;
                        if (hints.platformVersion) platform += ` ${hints.platformVersion}`;
                    } catch (e) { /* Ignore */ }
                }

                // 2. Fallback Parsing (iOS, Desktop, Older Android)
                if (!model) {
                    if (/android/i.test(ua)) {
                        platform = platform || "Android";
                        const match = ua.match(/Android[^;]+;\s([^;]+)\sBuild/);
                        model = match && match[1] ? match[1].trim() : "Android Device"; 
                    } else if (/iPad|iPhone|iPod/.test(ua) || (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1)) {
                        platform = "iOS";
                        if (ua.includes("iPhone")) model = "iPhone";
                        else if (ua.includes("iPad")) model = "iPad";
                        else model = "iOS Device";
                        
                        const osMatch = ua.match(/OS (\d+_\d+)/);
                        if (osMatch) platform += ` ${osMatch[1].replace('_', '.')}`;
                    } else if (/Windows/.test(ua)) {
                        platform = "Windows";
                        model = "PC/Laptop";
                    } else if (/Macintosh/.test(ua)) {
                         platform = "MacOS";
                         model = "Mac";
                    } else {
                        model = "Unknown Device";
                        platform = "Unknown OS";
                    }
                }

                // 3. Smart Brand Mapping (Model Code -> Readable Name)
                // Browsers give us "SM-G991B", we convert to "Samsung (SM-G991B)"
                const mapBrand = (rawModel) => {
                    const m = rawModel.toUpperCase();
                    
                    // Samsung
                    if (m.startsWith('SM-') || m.startsWith('GT-') || m.startsWith('SGH-')) {
                        // Attempt to map common Samsung flagships
                        if (m.includes('S918')) return `Samsung S23 Ultra (${rawModel})`;
                        if (m.includes('S911')) return `Samsung S23 (${rawModel})`;
                        if (m.includes('G998')) return `Samsung S21 Ultra (${rawModel})`;
                        if (m.includes('G991')) return `Samsung S21 (${rawModel})`;
                        if (m.includes('A52')) return `Samsung Galaxy A52 (${rawModel})`;
                        if (m.includes('A53')) return `Samsung Galaxy A53 (${rawModel})`;
                        return `Samsung Galaxy (${rawModel})`;
                    }
                    // Apple
                    if (m === 'IPHONE') return 'Apple iPhone';
                    if (m === 'IPAD') return 'Apple iPad';
                    
                    // Oppo / Realme / OnePlus
                    if (m.startsWith('CPH') || m.startsWith('RMX')) {
                        if (m.startsWith('RMX')) return `Realme (${rawModel})`;
                        if (m.startsWith('CPH')) return `Oppo (${rawModel})`;
                    }
                    // Vivo
                    if (m.startsWith('V2') || m.startsWith('V1')) return `Vivo (${rawModel})`;
                    // Xiaomi / Redmi / Poco
                    if (m.startsWith('M2') || m.startsWith('21') || m.startsWith('22')) return `Xiaomi/Redmi (${rawModel})`;
                    // Google
                    if (m.includes('PIXEL')) return `Google ${rawModel}`;

                    return rawModel; // Return original if no match
                };

                const finalModelName = mapBrand(model);
                
                return { model: finalModelName, platform, userAgent: ua };
            }
        };
        // --- END UTILITY FUNCTIONS ---

        // --- START REUSABLE UI COMPONENTS ---
        const Card = memo(({ children, className = '' }) => (<div className={`bg-slate-800/50 p-4 sm:p-6 rounded-lg shadow-lg border border-slate-700 ${className}`}>{children}</div>));
        const CardTitle = memo(({ children }) => (<h2 className="text-2xl font-semibold text-slate-100 mb-4 pb-4 border-b border-slate-700">{children}</h2>));
        const UnderConstructionPage = memo(({ title }) => (<Card><div className="text-center p-4 sm:p-8"><i className="fas fa-tools text-5xl text-yellow-400 mb-6"></i><h3 className="text-2xl sm:text-3xl font-bold text-slate-100">{title}</h3><p className="text-slate-400 mt-2">This page is under construction.</p></div></Card>));
        
        // NEW: Standardized Page Header to reduce redundancy
        const PageHeader = memo(({ title, children }) => (
            <div className="flex flex-wrap gap-4 justify-between items-center mb-6">
                <h3 className="text-xl font-semibold text-slate-100">{title}</h3>
                <div className="flex flex-wrap gap-4 items-center">
                    {children}
                </div>
            </div>
        ));

        // NEW: Standardized Search Input
        const SearchInput = memo(({ value, onChange, placeholder = "Search..." }) => (
            <input 
                type="text"
                placeholder={placeholder}
                value={value}
                onChange={onChange}
                className="input w-full sm:w-auto"
            />
        ));

        // REVISED: Robust Modal Component (Fixes positioning issues)
        // FIX: Switched to ReactDOM.createPortal to escape parent transforms/animations.
        // This ensures the modal is always fixed to the viewport, not the scrolled content.
        const Modal = ({ isOpen, onClose, children, maxWidth = "max-w-4xl" }) => { 
            if (!isOpen) return null; 
            
            return ReactDOM.createPortal(
                <div className="fixed inset-0 z-[60] overflow-y-auto" aria-labelledby="modal-title" role="dialog" aria-modal="true">
                    <div className="flex min-h-screen items-center justify-center p-4 text-center sm:p-0">
                        {/* Backdrop */}
                        <div className="fixed inset-0 bg-black bg-opacity-75 transition-opacity" aria-hidden="true" onClick={onClose}></div>

                        {/* Modal Panel */}
                        {/* FIX: Changed max-h-[90vh] to max-h-[85vh] and added 'flex flex-col' to the panel itself */}
                        <div className={`relative transform rounded-lg bg-slate-800 text-left shadow-2xl transition-all sm:my-8 w-full ${maxWidth} border border-slate-600 flex flex-col max-h-[85vh] overflow-hidden`}>
                            {children}
                        </div>
                    </div>
                </div>,
                document.body // Target container
            ); 
        };

        const ModalHeader = memo(({ title, onClose }) => (<div className="p-5 border-b border-slate-700 flex justify-between items-center flex-shrink-0"><h3 className="text-xl font-semibold text-slate-100">{title}</h3><Button variant="icon-close" onClick={onClose} className="text-2xl p-1">&times;</Button></div>));
        // FIX: Ensure ModalBody can shrink and grow, enabling scroll
        const ModalBody = memo(({ children }) => (<div className="p-6 flex-1 overflow-y-auto min-h-0">{children}</div>));
        const ModalFooter = memo(({ children }) => (<div className="p-4 bg-slate-900/50 border-t border-slate-700 flex justify-end gap-4 rounded-b-lg flex-shrink-0">{children}</div>));
        
        // NEW: Reusable Button Component
        const Button = memo(({ children, onClick, variant = 'primary', icon, disabled = false, type = 'button', className = '', title = '' }) => {
            const baseClasses = 'font-medium rounded-lg shadow-sm transition-colors flex items-center justify-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-slate-800';
            
            const variantStyles = {
                primary: 'bg-blue-600 text-white hover:bg-blue-700 focus:ring-blue-500 px-4 py-2',
                secondary: 'bg-slate-600 text-slate-200 hover:bg-slate-500 focus:ring-slate-400 px-4 py-2',
                danger: 'bg-red-600 text-white hover:bg-red-700 focus:ring-red-500 px-4 py-2',
                success: 'bg-green-600 text-white hover:bg-green-700 focus:ring-green-500 px-4 py-2',
                'icon-edit': 'text-blue-400 hover:text-blue-300',
                'icon-delete': 'text-red-500 hover:text-red-400',
                'icon-approve': 'text-green-400 hover:text-green-300',
                'icon-reject': 'text-orange-400 hover:text-orange-300',
                'icon-view': 'text-blue-400 hover:text-blue-300',
                'icon-edit-alt': 'text-indigo-400 hover:text-indigo-300',
                'icon-close': 'text-slate-400 hover:text-white',
                'icon-add-time': 'text-teal-400 hover:text-teal-300', // New variant for the manual check-out icon
            };

            const finalClasses = `${baseClasses} ${variantStyles[variant] || variantStyles.primary} ${className}`;

            return (
                <button type={type} onClick={onClick} disabled={disabled} className={finalClasses} title={title}>
                    {icon && <i className={`fas ${icon}`}></i>}
                    {children}
                </button>
            );
        });

        // FIX: Also updated ConfirmationModal to use Portal
        const ConfirmationModal = ({ isOpen, onClose, onConfirm, title, message }) => { 
            if (!isOpen) return null; 
            return ReactDOM.createPortal(
                <div className="fixed inset-0 bg-black bg-opacity-70 z-[70] flex justify-center items-center p-4">
                    <div className="bg-slate-800 rounded-lg shadow-2xl w-full max-w-sm border border-slate-600">
                        <div className="p-6">
                            <h3 className="text-lg font-bold text-slate-100">{title}</h3>
                            <p className="mt-2 text-sm text-slate-400">{message}</p>
                        </div>
                        <div className="p-4 bg-slate-900/50 border-t border-slate-700 flex justify-end gap-4 rounded-b-lg">
                            <Button variant="secondary" onClick={onClose}>Cancel</Button>
                            <Button variant="danger" onClick={onConfirm}>Confirm</Button>
                        </div>
                    </div>
                </div>,
                document.body
            ); 
        };
        const TabbedPage = memo(({ tabs, activeTab, setActiveTab, children }) => {
            const renderContent = () => React.Children.toArray(children).find(child => child.props.id === activeTab) || <UnderConstructionPage title={tabs[activeTab]} />;
            return (<div><div className="mb-6 overflow-x-auto"><nav className="flex space-x-2 sm:space-x-4" aria-label="Tabs">{Object.entries(tabs).map(([key, title]) => (<a href="#" key={key} onClick={(e) => { e.preventDefault(); setActiveTab(key); }} className={`whitespace-nowrap rounded-md px-3 py-2 text-sm font-medium transition-colors ${activeTab === key ? 'bg-blue-600 text-white shadow' : 'text-slate-400 hover:bg-slate-700/50 hover:text-slate-200'}`}>{title}</a>))}</nav></div>{renderContent()}</div>);
        });
        
        // MODIFIED: Updated NotificationBell to accept and display birthdayNotifications
        const NotificationBell = ({ pendingLeaves = [], pendingOTs = [], birthdayNotifications = [], onNotificationClick }) => {
            const [isOpen, setIsOpen] = useState(false);
            // NEW: Ref to track the dropdown container for click-outside detection
            const wrapperRef = useRef(null);

            const totalCount = pendingLeaves.length + pendingOTs.length + (birthdayNotifications ? birthdayNotifications.length : 0);

            // NEW: Effect to close dropdown when clicking outside
            useEffect(() => {
                const handleClickOutside = (event) => {
                    if (wrapperRef.current && !wrapperRef.current.contains(event.target)) {
                        setIsOpen(false);
                    }
                };
                document.addEventListener("mousedown", handleClickOutside);
                return () => {
                    document.removeEventListener("mousedown", handleClickOutside);
                };
            }, [wrapperRef]);

            const handleLeaveClick = () => {
                onNotificationClick('leaveRequest');
                setIsOpen(false);
            };

            const handleOTClick = () => {
                onNotificationClick('otRequest');
                setIsOpen(false);
            };

            return (
                <div className="relative" ref={wrapperRef}>
                    <button onClick={() => setIsOpen(!isOpen)} className="relative text-slate-400 hover:text-white focus:outline-none">
                        <i className="fas fa-bell text-xl"></i>
                        {totalCount > 0 && (
                            <span className="absolute -top-2 -right-2 flex h-5 w-5 items-center justify-center rounded-full bg-red-500 text-xs font-bold text-white">
                                {totalCount}
                            </span>
                        )}
                    </button>
                    {isOpen && (
                        <div className="absolute right-0 mt-2 w-80 origin-top-right rounded-md bg-slate-800 shadow-lg ring-1 ring-black ring-opacity-5 focus:outline-none border border-slate-700 z-50">
                            <div className="py-1">
                                <div className="px-4 py-2 text-sm font-semibold text-slate-100 border-b border-slate-700">Notifications</div>
                                {totalCount === 0 ? (
                                    <div className="px-4 py-3 text-sm text-slate-400">No new notifications</div>
                                ) : (
                                    <>
                                        {/* NEW: Birthday Section in Notifications */}
                                        {birthdayNotifications && birthdayNotifications.length > 0 && (
                                            <div className="border-b border-slate-700 pb-1 mb-1 bg-gradient-to-r from-pink-500/10 to-purple-500/10">
                                                <p className="px-4 py-2 text-xs font-bold text-pink-400 uppercase tracking-wider flex items-center gap-2">
                                                    <i className="fas fa-birthday-cake"></i> Birthdays Today
                                                </p>
                                                {birthdayNotifications.map(emp => (
                                                    <div key={emp.id} className="px-4 py-2 text-sm text-slate-300 flex items-center justify-between">
                                                        <span><strong>{emp.name}</strong></span>
                                                        <span className="text-xs bg-pink-500 text-white px-2 py-0.5 rounded-full">Celebrate!</span>
                                                    </div>
                                                ))}
                                            </div>
                                        )}

                                        {pendingLeaves.map(req => (
                                            <a href="#" key={req.id} onClick={handleLeaveClick} className="block px-4 py-3 text-sm text-slate-300 hover:bg-slate-700">
                                                <p className="font-medium text-slate-200">New Leave Request</p>
                                                <p className="text-xs text-slate-400">{req.staffName} - {req.numberOfDays} day(s)</p>
                                            </a>
                                        ))}
                                        {pendingOTs.map(req => (
                                            <a href="#" key={req.id} onClick={handleOTClick} className="block px-4 py-3 text-sm text-slate-300 hover:bg-slate-700">
                                                <p className="font-medium text-slate-200">New OT Request</p>
                                                <p className="text-xs text-slate-400">{req.numberOfOTDays} day(s)</p>
                                            </a>
                                        ))}
                                    </>
                                )}
                            </div>
                        </div>
                    )}
                </div>
            );
        };
        // --- END REUSABLE UI COMPONENTS ---

        // --- START CUSTOM OPTIMIZATION HOOKS (NEW) ---
        
        // OPTIMIZATION 1: Centralized Shop Permission Logic
        // This replaces the repetitive "if Admin return all, if Manager return subset" logic found in 12+ files.
        const useAllowedShops = (userProfile, shops) => {
            return useMemo(() => {
                if (!userProfile || !shops) return [];
                if (userProfile.role === 'Admin' || userProfile.role === 'CEO') return shops;
                if (userProfile.role === 'Shop Manager' && Array.isArray(userProfile.shop)) {
                    return shops.filter(s => userProfile.shop.includes(s.name));
                }
                return [];
            }, [userProfile, shops]);
        };

        // OPTIMIZATION 2: Shop Dropdown for Headers
        // A reusable dropdown that only appears for Admins/Multi-shop Managers
        const ShopFilterSelect = ({ userProfile, selectedShop, onChange, shops }) => {
            const allowedShops = useAllowedShops(userProfile, shops);
            
            // Don't render if the user only has 1 shop (or none) or is basic staff
            const shouldShow = (userProfile?.role === 'Admin' || userProfile?.role === 'CEO' || (userProfile?.role === 'Shop Manager' && Array.isArray(userProfile.shop)));
            
            if (!shouldShow) return null;

            return (
                <select value={selectedShop} onChange={onChange} className="select w-full sm:w-auto">
                    <option value="">{userProfile.role === 'Admin' || userProfile.role === 'CEO' ? 'All Shops' : 'All My Shops'}</option>
                    {allowedShops.map(s => <option key={s.id} value={s.name}>{s.name}</option>)}
                </select>
            );
        };
        // --- END CUSTOM OPTIMIZATION HOOKS ---

        // --- START AUTHENTICATION PAGE ---
        const LoginPage = () => {
            const { auth, db } = useFirebase();
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [error, setError] = useState('');
            const [loading, setLoading] = useState(false);
            const [showPassword, setShowPassword] = useState(false);

            // --- NEW: State for System Initialization ---
            const [showInitUI, setShowInitUI] = useState(false);
            const [initCode, setInitCode] = useState('');
            const [pendingUser, setPendingUser] = useState(null); // Stores the authenticated user while waiting for the code

            // *** SECURITY CONFIGURATION ***
            // Change this code to something secret before deploying!
            const SYSTEM_INIT_CODE = "HR2025"; 

            const handleLogin = useCallback(async (e) => {
                e.preventDefault();
                if (!auth || !db) { setError("System not ready. Please try again."); return; }
                setLoading(true);
                setError('');
                try {
                    const { signInWithEmailAndPassword, signOut, collection, query, where, getDocs, doc, updateDoc, addDoc, limit } = window.firebaseSDK;
                    
                    // 1. Authenticate with Firebase Auth
                    const userCredential = await signInWithEmailAndPassword(auth, email, password);
                    const user = userCredential.user;
                    
                    // 2. Check if this user has an employee profile
                    const q = query(collection(db, "employees"), where("email", "==", user.email));
                    const querySnapshot = await getDocs(q);

                    if (querySnapshot.empty) {
                        // --- NEW: SYSTEM BOOTSTRAP LOGIC WITH SECURITY CHECK ---
                        // If no profile found, check if the ENTIRE system is empty (fresh install)
                        const allEmployeesQuery = query(collection(db, "employees"), limit(1));
                        const allEmployeesSnap = await getDocs(allEmployeesQuery);

                        if (allEmployeesSnap.empty) {
                            // SYSTEM IS EMPTY: Do NOT create admin yet.
                            // Instead, store the user and show the Initialization Code UI.
                            console.log("Fresh system detected. Requesting Initialization Code...");
                            setPendingUser(user);
                            setShowInitUI(true);
                            setLoading(false); 
                            return; // Stop here and wait for the code
                        } else {
                            // System has users, but THIS user is not one of them.
                            await signOut(auth);
                            setError("No employee record found for this user.");
                        }
                    } else {
                        const employeeDoc = querySnapshot.docs[0];
                        const employeeData = employeeDoc.data();

                        if (employeeData.status !== 'Active') {
                            await signOut(auth);
                            setError("Your account is inactive. Please contact HR.");
                        } else {
                            // Automatically link UID if it's missing or incorrect.
                            if (!employeeData.uid || employeeData.uid !== user.uid) {
                                const employeeDocRef = doc(db, 'employees', employeeDoc.id);
                                await updateDoc(employeeDocRef, { uid: user.uid });
                            }
                            // Login is successful; onAuthStateChanged will handle profile loading.
                        }
                    }
                } catch (err) {
                    if (err.code === 'auth/invalid-credential' || err.code === 'auth/user-not-found' || err.code === 'auth/wrong-password') {
                        setError('Invalid email or password.');
                    } else {
                        setError('Failed to login. Please check connection.');
                        console.error(err);
                    }
                } finally {
                    // Only stop loading if we didn't trigger the Init UI
                    if (!showInitUI) setLoading(false);
                }
            }, [auth, db, email, password, showInitUI]); // Added showInitUI dependency

            // --- NEW: Handler for the Initialization Code Submit ---
            const handleInitSubmit = async (e) => {
                e.preventDefault();
                setError('');
                setLoading(true);

                if (initCode !== SYSTEM_INIT_CODE) {
                    setError("Incorrect Initialization Code.");
                    setLoading(false);
                    return;
                }

                try {
                    const { addDoc, collection } = window.firebaseSDK;
                    
                    // Code is correct! Create the Super Admin profile.
                    console.log("Code verified. Creating Super Admin profile...");
                    
                    await addDoc(collection(db, "employees"), {
                        uid: pendingUser.uid,
                        email: pendingUser.email,
                        name: "System Admin", 
                        role: "Admin",        
                        status: "Active",
                        joinedDate: new Date().toISOString().slice(0, 10),
                        position: "Administrator",
                        shop: "Head Office",
                        salary: 0,
                        permissions: ['policy', 'employees', 'checkinme', 'attendanceReport', 'payroll', 'hrBanking', 'salaryReport', 'expenseReport', 'userActivity', 'settings']
                    });

                    alert("System Initialized Successfully! You are now the Super Admin.");
                    // No need to reload; the onAuthStateChanged listener in AppContent will detect the new profile.
                    // Just reset the UI state to let the Dashboard render.
                    setShowInitUI(false); 
                    
                } catch (err) {
                    console.error("Error creating admin:", err);
                    setError("Failed to create admin profile. Check console.");
                } finally {
                    setLoading(false);
                }
            };

            // --- NEW: Render the Initialization Code Form if triggered ---
            if (showInitUI) {
                return (
                    <div className="flex items-center justify-center min-h-screen bg-slate-900">
                        <div className="w-full max-w-md p-8 space-y-8 bg-slate-800 rounded-2xl shadow-lg border border-yellow-600">
                            <div className="text-center">
                                <i className="fas fa-shield-halved text-5xl text-yellow-500"></i>
                                <h2 className="mt-6 text-3xl font-bold text-white">System Initialization</h2>
                                <p className="mt-2 text-sm text-slate-400">
                                    This database is empty. To claim the <strong>Admin</strong> role, please enter the system initialization code.
                                </p>
                            </div>
                            <form className="mt-8 space-y-6" onSubmit={handleInitSubmit}>
                                <div>
                                    <label htmlFor="init-code" className="sr-only">Initialization Code</label>
                                    <input 
                                        id="init-code" 
                                        name="code" 
                                        type="password" 
                                        required 
                                        className="appearance-none rounded relative block w-full px-3 py-3 border border-slate-600 bg-slate-700 text-white placeholder-slate-400 focus:outline-none focus:ring-yellow-500 focus:border-yellow-500 sm:text-sm text-center tracking-widest" 
                                        placeholder="ENTER CODE" 
                                        value={initCode} 
                                        onChange={(e) => setInitCode(e.target.value)} 
                                    />
                                </div>
                                {error && <p className="text-red-500 text-sm text-center font-bold animate-pulse">{error}</p>}
                                <div>
                                    <Button type="submit" variant="primary" disabled={loading} className="w-full py-3 bg-yellow-600 hover:bg-yellow-700 focus:ring-yellow-500">
                                        {loading ? <i className="fas fa-spinner fa-spin"></i> : 'Verify & Initialize'}
                                    </Button>
                                </div>
                                <div className="text-center">
                                    <button 
                                        type="button" 
                                        onClick={() => { setShowInitUI(false); setPendingUser(null); window.firebaseSDK.signOut(auth); }}
                                        className="text-sm text-slate-500 hover:text-slate-300 underline"
                                    >
                                        Cancel
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                );
            }

            return (
                <div className="flex items-center justify-center min-h-screen bg-slate-900">
                    <div className="w-full max-w-md p-8 space-y-8 bg-slate-800 rounded-2xl shadow-lg border border-slate-700">
                        <div className="text-center"><i className="fas fa-building-user text-5xl text-blue-500"></i><h2 className="mt-6 text-3xl font-bold text-white">HR Management System</h2><p className="mt-2 text-sm text-slate-400">Sign in to your account</p></div>
                        <form className="mt-8 space-y-6" onSubmit={handleLogin}>
                            <div className="rounded-md shadow-sm -space-y-px">
                                <div><input id="email-address" name="email" type="email" autoComplete="email" required className="appearance-none rounded-none relative block w-full px-3 py-3 border border-slate-600 bg-slate-700 text-white placeholder-slate-400 rounded-t-md focus:outline-none focus:ring-blue-500 focus:border-blue-500 focus:z-10 sm:text-sm" placeholder="Email address" value={email} onChange={(e) => setEmail(e.target.value)} /></div>
                                <div className="relative"><input id="password" name="password" type={showPassword ? "text" : "password"} autoComplete="current-password" required className="appearance-none rounded-none relative block w-full px-3 py-3 border border-slate-600 bg-slate-700 text-white placeholder-slate-400 rounded-b-md focus:outline-none focus:ring-blue-500 focus:border-blue-500 focus:z-10 sm:text-sm" placeholder="Password" value={password} onChange={(e) => setPassword(e.target.value)} /><button type="button" onClick={() => setShowPassword(!showPassword)} className="absolute inset-y-0 right-0 pr-3 flex items-center text-sm leading-5"><i className={`fas ${showPassword ? 'fa-eye-slash' : 'fa-eye'} text-slate-400 hover:text-slate-200`}></i></button></div>
                            </div>
                            {error && <p className="text-red-500 text-sm text-center">{error}</p>}
                            <div>
                                <Button type="submit" variant="primary" disabled={loading} className="w-full py-3">
                                    {loading ? <i className="fas fa-spinner fa-spin"></i> : 'Sign in'}
                                </Button>
                            </div>
                        </form>
                    </div>
                </div>
            );
        };
        // --- END AUTHENTICATION PAGE ---

        // --- START EMPLOYEES PAGE COMPONENTS ---

        // NEW: Phase 2 Refactoring - Custom Hook for Employee Fetching Logic
        const useFilteredEmployees = (userProfile, selectedShop) => {
            const { db, auth } = useFirebase();
            const [employees, setEmployees] = useState([]);
            const [loading, setLoading] = useState(true);

            useEffect(() => {
                if (!db || !userProfile || !auth?.currentUser) return () => {};
                
                const { collection, query, where, onSnapshot } = window.firebaseSDK;
                setLoading(true);
                let unsub1 = () => {};
                let unsub2 = () => {};

                const mergeResults = (res1, res2) => {
                    const combined = new Map();
                    res1.forEach(item => combined.set(item.id, item));
                    res2.forEach(item => combined.set(item.id, item));
                    setEmployees(Array.from(combined.values()));
                    setLoading(false);
                };

                const role = userProfile.role;
                
                if (role === 'Admin' || role === 'CEO') {
                    let results1 = [], results2 = [];
                    if (selectedShop) {
                        const q1 = query(collection(db, "employees"), where("shop", "==", selectedShop), where("status", "==", "Active"));
                        unsub1 = onSnapshot(q1, snap => { results1 = snap.docs.map(doc => ({ id: doc.id, ...doc.data() })); mergeResults(results1, results2); }, err => console.error("Admin query 1 failed:", err));
                        const q2 = query(collection(db, "employees"), where("shop", "array-contains", selectedShop), where("status", "==", "Active"));
                        unsub2 = onSnapshot(q2, snap => { results2 = snap.docs.map(doc => ({ id: doc.id, ...doc.data() })); mergeResults(results1, results2); }, err => console.error("Admin query 2 failed:", err));
                    } else {
                        const q1 = query(collection(db, "employees"), where("status", "==", "Active"));
                        unsub1 = onSnapshot(q1, snap => { setEmployees(snap.docs.map(doc => ({ id: doc.id, ...doc.data() }))); setLoading(false); }, err => console.error("Admin all employees query failed:", err));
                    }
                } else if (role === 'Shop Manager') {
                    const managedShops = Array.isArray(userProfile.shop) ? userProfile.shop : (userProfile.shop ? [userProfile.shop] : []);
                    
                    // --- FIX: Filter based on selectedShop if present ---
                    let shopsToQuery = managedShops;
                    if (selectedShop) {
                         // Only allow filtering by shops the manager actually owns
                         if (managedShops.includes(selectedShop)) {
                             shopsToQuery = [selectedShop];
                         }
                    }

                    if (shopsToQuery.length > 0) {
                        let results1 = [], results2 = [];
                        // Query 1: Single shop string matches
                        const q1 = query(collection(db, "employees"), where("shop", "in", shopsToQuery), where("status", "==", "Active"));
                        unsub1 = onSnapshot(q1, snap => { 
                            results1 = snap.docs.map(doc => ({ id: doc.id, ...doc.data() })); 
                            mergeResults(results1, results2); 
                        }, err => console.error("Manager query 1 failed:", err));
                        
                        // Query 2: Array contains...
                        let q2;
                        if (shopsToQuery.length === 1) {
                            // If specific shop selected (or manager only has 1 shop), use array-contains
                            q2 = query(collection(db, "employees"), where("shop", "array-contains", shopsToQuery[0]), where("status", "==", "Active"));
                        } else {
                            // If viewing "All My Shops", use array-contains-any
                            q2 = query(collection(db, "employees"), where("shop", "array-contains-any", shopsToQuery), where("status", "==", "Active"));
                        }

                        unsub2 = onSnapshot(q2, snap => { 
                            results2 = snap.docs.map(doc => ({ id: doc.id, ...doc.data() })); 
                            mergeResults(results1, results2); 
                        }, err => console.error("Manager query 2 failed:", err));
                    } else {
                        setEmployees([]); 
                        setLoading(false); 
                    }
                    // --- END FIX ---

                } else { // Staff role
                    const q1 = query(collection(db, "employees"), where("uid", "==", auth.currentUser.uid), where("status", "==", "Active"));
                    unsub1 = onSnapshot(q1, snap => { setEmployees(snap.docs.map(doc => ({ id: doc.id, ...doc.data() }))); setLoading(false); }, err => console.error("Staff query failed:", err));
                }

                return () => { unsub1(); unsub2(); };
            }, [db, userProfile, auth?.currentUser, selectedShop]);

            return { employees, loading };
        };

        // NEW: Phase 1 Refactoring - Employee Table Component
        // This component is now solely responsible for rendering the list of employees.
        // It receives the filtered list and action handlers as props.
        // MODIFIED: Added onViewHistory prop
        const EmployeeTable = memo(({ employees, userProfile, onView, onDelete, onViewHistory }) => {
            return (
                <div className="overflow-x-auto">
                    <table className="min-w-full divide-y divide-slate-700">
                        <thead className="bg-slate-900/50">
                            <tr>
                                {/* NEW: Added Photo Column */}
                                <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Photo</th>
                                <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Name</th>
                                <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Position</th>
                                <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Shop</th>
                                <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Join Date</th>
                                <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Worked Dur.</th>
                                <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Shift</th>
                                <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Tel</th>
                                <th className="px-4 py-3 text-right text-xs font-semibold text-slate-400 uppercase">Salary</th>
                                <th className="px-4 py-3 text-center text-xs font-semibold text-slate-400 uppercase">Actions</th>
                            </tr>
                        </thead>
                        <tbody className="divide-y divide-slate-700">
                            {employees.map(emp => (
                                <tr key={emp.id} className="hover:bg-slate-700/50">
                                    {/* NEW: Render Photo or Initials */}
                                    <td className="px-4 py-4 whitespace-nowrap">
                                        <div className="flex-shrink-0 h-10 w-10">
                                            {emp.photo ? (
                                                <img className="h-10 w-10 rounded-full object-cover border border-slate-600" src={emp.photo} alt={emp.name} />
                                            ) : (
                                                <div className="h-10 w-10 rounded-full bg-slate-700 flex items-center justify-center text-slate-400 font-bold border border-slate-600">
                                                    {emp.name.charAt(0)}
                                                </div>
                                            )}
                                        </div>
                                    </td>
                                    <td className="px-4 py-4 text-sm text-slate-200 whitespace-nowrap">{emp.name}</td>
                                    <td className="px-4 py-4 text-sm text-slate-300 whitespace-nowrap">{emp.position}</td>
                                    <td className="px-4 py-4 text-sm text-slate-300 whitespace-nowrap">{Array.isArray(emp.shop) ? emp.shop.join(', ') : emp.shop}</td>
                                    <td className="px-4 py-4 text-sm text-slate-300 whitespace-nowrap">{emp.joinedDate}</td>
                                    <td className="px-4 py-4 text-sm text-slate-300 whitespace-nowrap">{Utils.calculateWorkedDuration(emp.joinedDate)}</td>
                                    <td className="px-4 py-4 text-sm text-slate-300 whitespace-nowrap">{emp.shift}</td>
                                    <td className="px-4 py-4 text-sm text-slate-300 whitespace-nowrap">{emp.tel}</td>
                                    <td className="px-4 py-4 text-sm text-slate-300 text-right whitespace-nowrap">{Utils.formatCurrency(emp.salary)}</td>
                                    <td className="px-4 py-4 text-center whitespace-nowrap">
                                        <div className="flex items-center justify-center gap-4">
                                            <Button variant="icon-view" icon="fa-eye" onClick={() => onView(emp)} title="View Details" />
                                            
                                            {/* NEW: Salary History Button */}
                                            {(userProfile?.role === 'Admin' || userProfile?.role === 'CEO' || userProfile?.role === 'Shop Manager') && (
                                                <Button variant="icon-edit-alt" icon="fa-history" onClick={() => onViewHistory(emp)} title="View Salary History" />
                                            )}

                                            {(userProfile?.role === 'Admin' || userProfile?.role === 'CEO' || userProfile?.role === 'Shop Manager') && (
                                                <Button variant="icon-delete" icon="fa-trash" onClick={() => onDelete(emp)} title="Delete Employee" />
                                            )}
                                        </div>
                                    </td>
                                </tr>
                            ))}
                        </tbody>
                    </table>
                </div>
            );
        });

        // --- NEW: Salary History Modal ---
        const SalaryHistoryModal = ({ isOpen, onClose, employee }) => {
            const { db } = useFirebase();
            const [history, setHistory] = useState([]);
            const [loading, setLoading] = useState(true);

            useEffect(() => {
                if (isOpen && employee && db) {
                    const fetchHistory = async () => {
                        setLoading(true);
                        try {
                            const { collection, query, where, orderBy, getDocs } = window.firebaseSDK;
                            // Try ordering first (requires index)
                            try {
                                const q = query(
                                    collection(db, 'salaryRevisions'),
                                    where('staffId', '==', employee.id),
                                    orderBy('effectiveDate', 'desc')
                                );
                                const snap = await getDocs(q);
                                setHistory(snap.docs.map(d => d.data()));
                            } catch (indexError) {
                                // Fallback if index missing: client-side sort
                                console.warn("Index missing for salary history, falling back to client sort.");
                                const q = query(
                                    collection(db, 'salaryRevisions'),
                                    where('staffId', '==', employee.id)
                                );
                                const snap = await getDocs(q);
                                const data = snap.docs.map(d => d.data());
                                data.sort((a,b) => (b.effectiveDate || '').localeCompare(a.effectiveDate || ''));
                                setHistory(data);
                            }
                        } catch (error) {
                            console.error("Error loading salary history:", error);
                        } finally {
                            setLoading(false);
                        }
                    };
                    fetchHistory();
                }
            }, [isOpen, employee, db]);

            if (!isOpen || !employee) return null;

            return (
                <Modal isOpen={isOpen} onClose={onClose} maxWidth="max-w-2xl">
                    <ModalHeader title={`Salary Revision History: ${employee.name}`} onClose={onClose} />
                    <ModalBody>
                        {loading ? (
                            <div className="text-center py-8"><i className="fas fa-spinner fa-spin text-2xl text-blue-500"></i></div>
                        ) : history.length === 0 ? (
                            <div className="text-center py-8 text-slate-500">No salary revisions found for this employee.</div>
                        ) : (
                            <div className="overflow-x-auto">
                                <table className="min-w-full divide-y divide-slate-700">
                                    <thead className="bg-slate-900/50">
                                        <tr>
                                            <th className="px-4 py-2 text-left text-xs font-semibold text-slate-400 uppercase">Effective Date</th>
                                            <th className="px-4 py-2 text-right text-xs font-semibold text-slate-400 uppercase">Old Salary</th>
                                            <th className="px-4 py-2 text-right text-xs font-semibold text-slate-400 uppercase">Change</th>
                                            <th className="px-4 py-2 text-right text-xs font-semibold text-slate-400 uppercase">New Salary</th>
                                            <th className="px-4 py-2 text-center text-xs font-semibold text-slate-400 uppercase">Status</th>
                                        </tr>
                                    </thead>
                                    <tbody className="divide-y divide-slate-700">
                                        {history.map((rev, idx) => (
                                            <tr key={idx} className="hover:bg-slate-700/30">
                                                <td className="px-4 py-2 text-sm text-slate-300">{Utils.formatISOToDisplay(rev.effectiveDate)}</td>
                                                <td className="px-4 py-2 text-sm text-slate-400 text-right">{Utils.formatCurrency(rev.baseSalary)}</td>
                                                <td className={`px-4 py-2 text-sm text-right font-medium ${parseFloat(rev.reviseAmount) >= 0 ? 'text-green-400' : 'text-red-400'}`}>
                                                    {parseFloat(rev.reviseAmount) > 0 ? '+' : ''}{Utils.formatCurrency(rev.reviseAmount)}
                                                </td>
                                                <td className="px-4 py-2 text-sm text-blue-300 font-bold text-right">{Utils.formatCurrency(rev.updatedSalary)}</td>
                                                <td className="px-4 py-2 text-center">
                                                    <span className={`px-2 py-0.5 text-[10px] rounded-full ${
                                                        rev.status === 'Approved' ? 'bg-green-900 text-green-300' :
                                                        rev.status === 'Rejected' ? 'bg-red-900 text-red-300' :
                                                        'bg-yellow-900 text-yellow-300'
                                                    }`}>{rev.status}</span>
                                                </td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </div>
                        )}
                    </ModalBody>
                    <ModalFooter>
                        <Button variant="secondary" onClick={onClose}>Close</Button>
                    </ModalFooter>
                </Modal>
            );
        };

        // --- NEW: Image Cropper Modal Component ---
        const ImageCropperModal = ({ isOpen, onClose, imageSrc, onCropComplete }) => {
            const imageRef = useRef(null);
            const cropperRef = useRef(null);

            useEffect(() => {
                // FIX: Ensure Cropper library is loaded before initializing
                const initCropper = async () => {
                    if (isOpen && imageSrc && imageRef.current) {
                        if (!window.Cropper) {
                            try {
                                await Utils.loadScript(Utils.LIBS.CROPPER);
                            } catch (e) {
                                console.error("Failed to load CropperJS", e);
                                return;
                            }
                        }

                        // Destroy previous instance if it exists to prevent duplicates
                        if (cropperRef.current) {
                            cropperRef.current.destroy();
                        }

                        const cropperInstance = new window.Cropper(imageRef.current, {
                            aspectRatio: 1, // Force Square
                            viewMode: 1, // Restrict crop box to within the canvas
                            dragMode: 'move', // Allow moving the image by default
                            autoCropArea: 1, // Default to full area
                            background: false, // Transparent background
                            modal: true,
                            guides: false, // Clean UI
                            highlight: false,
                            cropBoxMovable: false, // Fix the box, move the image
                            cropBoxResizable: false, // Fixed size
                            toggleDragModeOnDblclick: false,
                            minContainerWidth: 300,
                            minContainerHeight: 300,
                        });
                        cropperRef.current = cropperInstance;
                    }
                };

                initCropper();

                return () => {
                    if (cropperRef.current) {
                        cropperRef.current.destroy();
                        cropperRef.current = null;
                    }
                };
            }, [isOpen, imageSrc]);

            const handleCrop = () => {
                 if (cropperRef.current) {
                    // Get cropped result at high quality
                    const canvas = cropperRef.current.getCroppedCanvas({
                        width: 400, 
                        height: 400,
                        fillColor: '#fff',
                        imageSmoothingEnabled: true,
                        imageSmoothingQuality: 'high',
                    });
                    
                    if (canvas) {
                        onCropComplete(canvas.toDataURL('image/jpeg', 0.85));
                    }
                 }
            };

            if (!isOpen) return null;

            return (
                <Modal isOpen={isOpen} onClose={onClose} maxWidth="max-w-md">
                     <ModalHeader title="Adjust Profile Photo" onClose={onClose} />
                     <ModalBody>
                        <div className="h-80 w-full bg-black flex items-center justify-center overflow-hidden rounded-lg">
                            <img ref={imageRef} src={imageSrc} alt="Crop source" className="max-w-full block" />
                        </div>
                        <div className="mt-4 flex flex-col items-center text-slate-400 text-sm space-y-1">
                            <p className="flex items-center"><i className="fas fa-arrows-alt mr-2 text-blue-400"></i> Drag image to center the face</p>
                            <p className="text-xs opacity-75"><i className="fas fa-search-plus mr-1"></i> Scroll to Zoom In/Out</p>
                        </div>
                     </ModalBody>
                     <ModalFooter>
                        <Button variant="secondary" onClick={onClose}>Cancel</Button>
                        <Button variant="primary" onClick={handleCrop} icon="fa-crop-simple">Save Photo</Button>
                     </ModalFooter>
                </Modal>
            );
        };

        // Component: Employee Modal (Add/Edit Form)
        // MODIFIED: Added 'allEmployees' to props destructuring
        const EmployeeModal = ({ isOpen, onClose, onSave, employee, userProfile, isViewOnly = false, onSwitchToEdit, allEmployees }) => {
            const [formData, setFormData] = useState({});
            const [password, setPassword] = useState(''); // NEW: State for new user password
            const [showPassword, setShowPassword] = useState(false); // NEW: State for password visibility
            const [authError, setAuthError] = useState(''); // NEW: State for auth errors

            // --- NEW: Document Vault & Cropper State ---
            const [activeTab, setActiveTab] = useState('details');
            const [documents, setDocuments] = useState([]);
            const [isUploading, setIsUploading] = useState(false);
            
            // Cropper States
            const [cropImageSrc, setCropImageSrc] = useState(null);
            const [isCropModalOpen, setIsCropModalOpen] = useState(false);

            const { db } = useFirebase(); // Access DB for subcollection
            const { positions, shifts, shops } = useAppData(); // Use global data context

            // Determine available shops for the modal dropdown based on user role
            const availableShopsForModal = useAllowedShops(userProfile, shops);

            // Filter supervisors to only show Shop Managers assigned to the selected shop(s)
            const supervisors = useMemo(() => {
                // Ensure we always work with an array of selected shops
                const selectedShops = Array.isArray(formData.shop) ? formData.shop : (formData.shop ? [formData.shop] : []);

                // If no shop is selected, return empty list
                if (selectedShops.length === 0) return [];

                return (allEmployees || []).filter(e => {
                    if (e.role !== 'Shop Manager' || e.status !== 'Active') return false;
                    
                    // Get the manager's assigned shops
                    const managerShops = Array.isArray(e.shop) ? e.shop : (e.shop ? [e.shop] : []);
                    
                    // Check if the manager covers ANY of the selected shops
                    return managerShops.some(s => selectedShops.includes(s));
                });
            }, [allEmployees, formData.shop]);

            const availablePages = useMemo(() => [
                { key: 'employees', label: 'Employees' },
                { key: 'checkinme', label: 'CheckInMe' },
                // REMOVED: Saving Program permission
                { key: 'attendanceReport', label: 'Attendance Report' },
                { key: 'payroll', label: 'Payroll' },
                { key: 'hrBanking', label: 'HR Banking' },
                { key: 'salaryReport', label: 'Salary Revise Report' },
                { key: 'expenseReport', label: 'Expense Report' },
                { key: 'assets', label: 'Asset Manager' }, // ADDED: Asset Manager Permission
                // MODIFIED: 'tasks' removed from permission list as it is now globally accessible
                // { key: 'tasks', label: 'Task Manager' }, 
                { key: 'userActivity', label: 'User Activity' },
                { key: 'policy', label: 'Policy Board' },
                { key: 'settings', label: 'Settings' },
            ], []);

            // Filter shifts based on the employee's assigned shop(s)
            // MODIFIED: Deduplicate shift names to prevent "locked" select behavior
            const availableShifts = useMemo(() => {
                const employeeShops = Array.isArray(formData.shop) ? formData.shop : (formData.shop ? [formData.shop] : []);
                if (employeeShops.length === 0) return [];
                
                // Get all shifts available in the selected shops
                const relevantShifts = (shifts || []).filter(s => s.shopName && employeeShops.includes(s.shopName));
                
                // Extract unique names only. 
                // e.g. ["AM", "AM", "PM"] -> ["AM", "PM"]
                const uniqueNames = [...new Set(relevantShifts.map(s => s.name))].sort();
                
                return uniqueNames;
            }, [shifts, formData.shop]);

            // Initialize form data when modal opens or employee data changes
            useEffect(() => {
                const initialData = employee 
                    ? { ...employee, permissions: employee.permissions || [] } 
                    : { 
                        name: '', sex: 'M', dob: '', nationId: '', tel: '', shop: '', 
                        joinedDate: '', salary: '', position: '', shift: 'AM', supervisor: '', 
                        status: 'Active', email: '', uid: '', role: 'Staff', address: '', 
                        permissions: [], statusChangeDate: '', reasonForLeaving: '', 
                        savingsProgramStatus: 'Inactive', savingsPercentage: 0, primaryShop: '',
                        enrollInSavings: true, // NEW: Default to true for new employees
                        photo: '' // NEW: Photo field
                    };

                // When editing, ensure shop is in the right format based on role
                if (employee) {
                    if (employee.role === 'Shop Manager' || employee.role === 'Admin') {
                        initialData.shop = Array.isArray(employee.shop) ? employee.shop : (employee.shop ? [employee.shop] : []);
                    } else {
                        initialData.shop = Array.isArray(employee.shop) ? employee.shop[0] || '' : employee.shop || '';
                    }

                    // NEW: Set initial primaryShop
                    let defaultPrimary = '';
                    if (employee.primaryShop) {
                        defaultPrimary = employee.primaryShop;
                    } else if (Array.isArray(initialData.shop)) {
                        defaultPrimary = initialData.shop[0] || ''; // Default to first shop in array
                    } else {
                        defaultPrimary = initialData.shop; // Default to the single shop string
                    }
                    initialData.primaryShop = defaultPrimary;

                } else {
                    // For new employee, default based on Staff role
                    initialData.shop = '';
                    initialData.primaryShop = ''; // NEW
                }

                setFormData(initialData);
                setPassword(''); // NEW: Reset password on open
                setAuthError(''); // NEW: Reset error on open
                setActiveTab('details'); // Reset to details tab
            }, [employee, isOpen]);
            
            // --- NEW: Fetch Documents Logic ---
            useEffect(() => {
                if (!isOpen || !employee || !employee.id || !db) {
                    setDocuments([]);
                    return;
                }
                const { collection, query, orderBy, onSnapshot } = window.firebaseSDK;
                const q = query(collection(db, 'employees', employee.id, 'documents'), orderBy('uploadedAt', 'desc'));
                
                const unsubscribe = onSnapshot(q, (snapshot) => {
                    setDocuments(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
                }, (error) => console.error("Error fetching documents:", error));
                
                return () => unsubscribe();
            }, [employee, isOpen, db]);

            // Automatically grant 'checkinme' permission to Staff and Shop Manager roles
            useEffect(() => {
                if ((formData.role === 'Staff' || formData.role === 'Shop Manager') && !formData.permissions?.includes('checkinme')) {
                    setFormData(prev => ({ ...prev, permissions: [...new Set([...(prev.permissions || []), 'checkinme'])] }));
                }
            }, [formData.role]);

            const handleChange = useCallback((e) => {
                const { name, value, type, checked } = e.target;
                
                if (name === 'role') {
                    // When role changes, convert shop data structure accordingly
                    setFormData(prev => {
                        const newRole = value;
                        let newShopValue = prev.shop;
                        let newPermissions = prev.permissions || []; // Get current permissions
                        let newPrimaryShop = prev.primaryShop; // NEW
                        
                        if (newRole === 'Shop Manager' || newRole === 'Admin' || newRole === 'CEO') {
                            // convert to array if it's a string
                            newShopValue = Array.isArray(prev.shop) ? prev.shop : (prev.shop ? [prev.shop] : []);
                        } else {
                            // convert to string (first element) if it's an array
                            newShopValue = Array.isArray(prev.shop) ? prev.shop[0] || '' : prev.shop;
                            // NEW: If changing to single-shop, primaryShop MUST be that shop
                            newPrimaryShop = newShopValue;
                        }

                        // If role is changed to something other than Admin, remove the sysConfig permission.
                        
                        return { ...prev, role: newRole, shop: newShopValue, permissions: newPermissions, primaryShop: newPrimaryShop }; // NEW: return with newPrimaryShop
                    });
                } else if (type === 'checkbox') {
                    if (name === 'shop') { // Handling shop multi-select
                        setFormData(prev => {
                            const shopArray = Array.isArray(prev.shop) ? prev.shop : [];
                            const newShops = checked ? [...shopArray, value] : shopArray.filter(s => s !== value);
                            
                            // NEW: Check if primaryShop is still valid
                            let newPrimaryShop = prev.primaryShop;
                            if (!newShops.includes(newPrimaryShop)) {
                                newPrimaryShop = newShops[0] || ''; // Reset to first available, or empty
                            }
                            
                            // MODIFIED: Reset supervisor if shop selection changes
                            return { ...prev, shop: newShops, primaryShop: newPrimaryShop, supervisor: '' }; 
                        });
                    } else if (name === 'enrollInSavings') { // NEW: Handle Savings Checkbox
                        setFormData(prev => ({ ...prev, enrollInSavings: checked }));
                    } else { // Handling permissions
                        setFormData(prev => ({ ...prev, permissions: checked ? [...(prev.permissions || []), value] : (prev.permissions || []).filter(p => p !== value) }));
                    }
                } else {
                    // NEW: Handle single-shop change
                    if (name === 'shop') { 
                        // This is for single-shop roles
                        // MODIFIED: Reset supervisor if shop selection changes
                        setFormData(prev => ({ ...prev, [name]: value, primaryShop: value, supervisor: '' })); 
                    } else {
                        // This handles 'primaryShop' dropdown change and all others
                        setFormData(prev => ({ ...prev, [name]: value }));
                    }
                }
            }, []);

            // --- NEW: Document Upload Handler ---
            const handleDocumentUpload = async (e) => {
                const file = e.target.files[0];
                if (!file) return;
                
                // Firestore document limit is 1MB. Use 500KB limit for base64 strings to be safe.
                if (file.size > 500 * 1024) {
                    alert("File too large. Maximum size for documents is 500KB.");
                    return;
                }
                
                setIsUploading(true);
                const reader = new FileReader();
                reader.onload = async (event) => {
                    const base64 = event.target.result;
                    try {
                        const { addDoc, collection, serverTimestamp } = window.firebaseSDK;
                        await addDoc(collection(db, 'employees', employee.id, 'documents'), {
                            name: file.name,
                            type: file.type,
                            size: file.size,
                            data: base64,
                            uploadedAt: serverTimestamp(),
                            uploadedBy: userProfile.name
                        });
                        setIsUploading(false);
                    } catch (err) {
                        console.error("Upload error:", err);
                        alert("Failed to upload document.");
                        setIsUploading(false);
                    }
                };
                reader.readAsDataURL(file);
            };

            const handleDeleteDocument = async (docId) => {
                if(!confirm("Are you sure you want to delete this document?")) return;
                try {
                    const { deleteDoc, doc } = window.firebaseSDK;
                    await deleteDoc(doc(db, 'employees', employee.id, 'documents', docId));
                } catch(err) { console.error("Delete error:", err); }
            };

            // --- MODIFIED: Image Upload Handler (Triggers Cropper) ---
            const handleImageUpload = (e) => {
                const file = e.target.files[0];
                if (!file) return;

                if (file.size > 5 * 1024 * 1024) { // 5MB Limit for source image
                    alert("File size is too large. Please select an image under 5MB.");
                    return;
                }

                const reader = new FileReader();
                reader.onload = (event) => {
                    setCropImageSrc(event.target.result); // Set source for cropper
                    setIsCropModalOpen(true); // Open cropper modal
                    e.target.value = ''; // Reset input
                };
                reader.readAsDataURL(file);
            };

            // --- NEW: Callback when cropping is finished ---
            const handleCropComplete = (croppedDataUrl) => {
                setFormData(prev => ({ ...prev, photo: croppedDataUrl }));
                setIsCropModalOpen(false);
                setCropImageSrc(null);
            };

            // Handlers for salary input to allow typing numbers and format on blur
            const handleSalaryChange = useCallback((e) => { setFormData(prev => ({ ...prev, salary: e.target.value.replace(/[^0-9.]/g, '') })); }, []);
            const handleSalaryBlur = useCallback((e) => { setFormData(prev => ({ ...prev, salary: Utils.formatCurrency(e.target.value) })); }, []);
            const handleSubmit = useCallback(async (e) => { 
                e.preventDefault(); 
                setAuthError(''); // Reset error on each submission attempt
                const dataToSave = { ...formData };
                // Final check to ensure staff have a string for shop, not array
                if (dataToSave.role !== 'Shop Manager' && dataToSave.role !== 'Admin' && dataToSave.role !== 'CEO') {
                    dataToSave.shop = Array.isArray(dataToSave.shop) ? dataToSave.shop[0] : dataToSave.shop;
                }

                // --- MODIFIED: Handle user credential creation without changing global auth state ---
                if (!dataToSave.id && dataToSave.email && password) { // This is a new employee with login details
                    if (password.length < 6) {
                        setAuthError('Password must be at least 6 characters long.');
                        return; // Stop the save process
                    }
                    let tempApp = null;
                    try {
                        const { initializeApp, getAuth, createUserWithEmailAndPassword, deleteApp } = window.firebaseSDK;
                        // Initialize a temporary, secondary Firebase app to create the user.
                        // This prevents the main app's auth state from changing.
                        const tempAppName = `temp-user-creation-${Date.now()}`;
                        tempApp = initializeApp(activeFirebaseConfig, tempAppName);
                        const tempAuth = getAuth(tempApp);

                        // Create the user on the temporary instance.
                        const userCredential = await createUserWithEmailAndPassword(tempAuth, dataToSave.email, password);
                        // Add the new UID to the employee data object that will be saved to Firestore
                        dataToSave.uid = userCredential.user.uid;
                        
                    } catch (error) {
                        console.error("Error creating auth user:", error);
                        if (error.code === 'auth/email-already-in-use') {
                            setAuthError('This email is already in use by another login.');
                        } else {
                            setAuthError('Failed to create user login. Please check the email format.');
                        }
                        return; // Stop the save process if auth creation fails
                    } finally {
                        // Clean up the temporary app instance.
                        if (tempApp) {
                            await window.firebaseSDK.deleteApp(tempApp);
                        }
                    }
                } else if (!dataToSave.id && dataToSave.email && !password) {
                    setAuthError('Password is required when creating a new user with an email address.');
                    return; // Stop the save process
                }
                // --- End modified logic ---

                onSave(dataToSave); 
            }, [onSave, formData, password]);
            const isFormerEmployee = formData.status === 'Terminated' || formData.status === 'Resigned';

            return (
                <>
                <Modal isOpen={isOpen} onClose={onClose}>
                    {/* FIX: Added 'overflow-hidden' to the form to ensure internal scrolling works correctly within the flex container */}
                    <form onSubmit={handleSubmit} className="flex flex-col h-full overflow-hidden">
                        <ModalHeader title={isViewOnly ? 'View Employee Details' : (employee ? 'Edit Employee' : 'Add New Employee')} onClose={onClose} />
                        <ModalBody>
                            {/* --- NEW: Tab Controls --- */}
                            {employee && (
                                <div className="flex space-x-6 border-b border-slate-700 mb-6 sticky top-0 bg-slate-800 z-10 pt-2">
                                    <button
                                        type="button"
                                        className={`pb-2 text-sm font-medium transition-colors border-b-2 ${
                                            activeTab === 'details' ? 'border-blue-500 text-blue-400' : 'border-transparent text-slate-400 hover:text-slate-200'
                                        }`}
                                        onClick={() => setActiveTab('details')}
                                    >
                                        Details
                                    </button>
                                    <button
                                        type="button"
                                        className={`pb-2 text-sm font-medium transition-colors border-b-2 ${
                                            activeTab === 'documents' ? 'border-blue-500 text-blue-400' : 'border-transparent text-slate-400 hover:text-slate-200'
                                        }`}
                                        onClick={() => setActiveTab('documents')}
                                    >
                                        Documents
                                    </button>
                                </div>
                            )}

                            {/* --- TAB CONTENT: DOCUMENTS --- */}
                            {activeTab === 'documents' ? (
                                <div className="space-y-4 h-full overflow-y-auto">
                                    {!isViewOnly && (
                                        <div className="flex flex-col items-center justify-center p-6 border-2 border-slate-600 border-dashed rounded-lg bg-slate-700/30 hover:bg-slate-700/50 transition-colors relative">
                                            {isUploading ? (
                                                <div className="flex flex-col items-center">
                                                    <i className="fas fa-spinner fa-spin text-3xl text-blue-500 mb-2"></i>
                                                    <p className="text-sm text-slate-400">Uploading...</p>
                                                </div>
                                            ) : (
                                                <>
                                                    <i className="fas fa-cloud-upload-alt text-3xl text-slate-400 mb-2"></i>
                                                    <p className="text-sm text-slate-300 font-medium">Click to upload document</p>
                                                    <p className="text-xs text-slate-500 mt-1">PDF, JPG, PNG (Max 500KB)</p>
                                                    <input 
                                                        type="file" 
                                                        accept=".pdf,image/*" 
                                                        onChange={handleDocumentUpload} 
                                                        className="absolute inset-0 w-full h-full opacity-0 cursor-pointer"
                                                    />
                                                </>
                                            )}
                                        </div>
                                    )}

                                    <div className="space-y-2">
                                        <h4 className="text-xs font-bold text-slate-400 uppercase tracking-wider mb-2">Stored Documents</h4>
                                        {documents.length === 0 ? (
                                            <p className="text-center text-slate-500 text-sm py-8 italic">No documents attached to this profile.</p>
                                        ) : (
                                            documents.map(doc => (
                                                <div key={doc.id} className="flex items-center justify-between p-3 bg-slate-800 rounded-lg border border-slate-700 hover:border-slate-600 transition-colors group">
                                                    <div className="flex items-center gap-3 overflow-hidden">
                                                        <div className={`w-10 h-10 rounded flex items-center justify-center shrink-0 ${doc.type.includes('pdf') ? 'bg-red-500/10 text-red-400' : 'bg-blue-500/10 text-blue-400'}`}>
                                                            <i className={`fas ${doc.type.includes('pdf') ? 'fa-file-pdf' : 'fa-file-image'} text-lg`}></i>
                                                        </div>
                                                        <div className="min-w-0">
                                                            <p className="text-sm font-medium text-slate-200 truncate pr-4">{doc.name}</p>
                                                            <p className="text-xs text-slate-500">
                                                                {doc.uploadedAt?.toDate ? doc.uploadedAt.toDate().toLocaleDateString() : 'Just now'}  {Math.round(doc.size / 1024)} KB
                                                            </p>
                                                        </div>
                                                    </div>
                                                    <div className="flex items-center gap-2">
                                                        <a 
                                                            href={doc.data} 
                                                            download={doc.name} 
                                                            className="p-2 text-slate-400 hover:text-blue-400 transition-colors" 
                                                            title="Download"
                                                        >
                                                            <i className="fas fa-download"></i>
                                                        </a>
                                                        {!isViewOnly && (
                                                            <button 
                                                                type="button" 
                                                                onClick={() => handleDeleteDocument(doc.id)} 
                                                                className="p-2 text-slate-400 hover:text-red-400 transition-colors" 
                                                                title="Delete"
                                                            >
                                                                <i className="fas fa-trash"></i>
                                                            </button>
                                                        )}
                                                    </div>
                                                </div>
                                            ))
                                        )}
                                    </div>
                                </div>
                            ) : (
                            // --- TAB CONTENT: DETAILS (Existing Form) ---
                            <>
                            {/* --- NEW: Photo Uploader Section --- */}
                            <div className="flex flex-col items-center justify-center mb-6">
                                <div 
                                    className={`relative w-28 h-28 rounded-full overflow-hidden border-4 border-slate-600 bg-slate-700 flex items-center justify-center shadow-lg group ${!isViewOnly ? 'cursor-pointer hover:border-blue-500' : ''}`}
                                    onClick={() => !isViewOnly && document.getElementById('photo-upload').click()}
                                >
                                    {formData.photo ? (
                                        <img src={formData.photo} alt="Profile" className="w-full h-full object-cover" />
                                    ) : (
                                        <i className="fas fa-user text-5xl text-slate-500"></i>
                                    )}
                                    
                                    {!isViewOnly && (
                                        <div className="absolute inset-0 bg-black/50 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity">
                                            <i className="fas fa-camera text-white text-2xl"></i>
                                        </div>
                                    )}
                                </div>
                                {!isViewOnly && <p className="text-xs text-slate-400 mt-2">Tap to change photo</p>}
                                <input 
                                    type="file" 
                                    id="photo-upload" 
                                    accept="image/*" 
                                    className="hidden" 
                                    onChange={handleImageUpload}
                                    disabled={isViewOnly}
                                />
                            </div>
                            {/* --- End Photo Uploader --- */}

                            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                {/* Employee Personal & Job Details */}
                                <div><label className="text-sm font-medium text-slate-400"><i className="fas fa-user mr-2 text-blue-400"></i>Name</label><input name="name" value={formData.name || ''} onChange={handleChange} className="input" required disabled={isViewOnly} /></div>
                                <div><label className="text-sm font-medium text-slate-400"><i className="fas fa-venus-mars mr-2 text-pink-400"></i>Sex</label><select name="sex" value={formData.sex || 'M'} onChange={handleChange} className="select" disabled={isViewOnly}><option value="M">Male</option><option value="F">Female</option></select></div>
                                <div><label className="text-sm font-medium text-slate-400"><i className="fas fa-birthday-cake mr-2 text-yellow-400"></i>Date of Birth</label><input type="date" name="dob" value={formData.dob || ''} onChange={handleChange} className="input" disabled={isViewOnly} /></div>
                                <div><label className="text-sm font-medium text-slate-400"><i className="fas fa-id-card mr-2 text-green-400"></i>Nation ID</label><input name="nationId" value={formData.nationId || ''} onChange={handleChange} className="input" disabled={isViewOnly} /></div>
                                <div><label className="text-sm font-medium text-slate-400"><i className="fas fa-phone mr-2 text-indigo-400"></i>Tel No</label><input name="tel" value={formData.tel || ''} onChange={handleChange} className="input" disabled={isViewOnly} /></div>
                                
                                {(formData.role === 'Shop Manager' || formData.role === 'Admin' || formData.role === 'CEO') ? (
                                    <div className="md:col-span-full">
                                        <label className="text-sm font-medium text-slate-400"><i className="fas fa-store mr-2 text-cyan-400"></i>Shops</label>
                                        <div className="mt-2 grid grid-cols-2 sm:grid-cols-3 gap-4 p-4 border border-slate-600 rounded-lg bg-slate-700/50">
                                            {(availableShopsForModal || []).map(shop => (
                                                <div key={shop.id} className="flex items-center">
                                                    <input id={`shop-${shop.id}`} name="shop" type="checkbox" value={shop.name} checked={(Array.isArray(formData.shop) ? formData.shop : []).includes(shop.name)} onChange={handleChange} className="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500 bg-slate-600" disabled={isViewOnly} />
                                                    <label htmlFor={`shop-${shop.id}`} className="ml-3 text-sm text-slate-300">{shop.name}</label>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                ) : (
                                    <div>
                                        <label className="text-sm font-medium text-slate-400"><i className="fas fa-store mr-2 text-cyan-400"></i>Shop</label>
                                        <select name="shop" value={formData.shop || ''} onChange={handleChange} className="select" disabled={isViewOnly}>
                                            <option value="">Select Shop</option>
                                            {(availableShopsForModal || []).map(s => <option key={s.id} value={s.name}>{s.name}</option>)}
                                        </select>
                                    </div>
                                )}

                                {/* --- NEW: Primary Shop Dropdown --- */}
                                <div>
                                    <label className="text-sm font-medium text-slate-400"><i className="fas fa-map-pin mr-2 text-red-400"></i>Primary Shop</label>
                                    <select 
                                        name="primaryShop" 
                                        value={formData.primaryShop || ''} 
                                        onChange={handleChange} 
                                        className="select"
                                        // Disable if not a multi-shop role OR if no shops are assigned
                                        disabled={isViewOnly || !(formData.role === 'Shop Manager' || formData.role === 'Admin' || formData.role === 'CEO') || !formData.shop || formData.shop.length === 0}
                                    >
                                        <option value="">Select Primary Shop</option>
                                        {/* Populate options based on whether shop is an array (multi-shop) 
                                          or a string (single-shop, in which case it will be disabled anyway
                                          but this makes it robust).
                                        */}
                                        {Array.isArray(formData.shop) ? (
                                            formData.shop.map(shopName => (
                                                <option key={shopName} value={shopName}>{shopName}</option>
                                            ))
                                        ) : (
                                            formData.shop && <option value={formData.shop}>{formData.shop}</option>
                                        )}
                                    </select>
                                </div>
                                {/* --- END: Primary Shop Dropdown --- */}

                                <div><label className="text-sm font-medium text-slate-400"><i className="fas fa-calendar-check mr-2 text-teal-400"></i>Joined Date</label><input type="date" name="joinedDate" value={formData.joinedDate || ''} onChange={handleChange} className="input" disabled={isViewOnly} /></div>
                                <div><label className="text-sm font-medium text-slate-400"><i className="fas fa-money-bill-wave mr-2 text-green-500"></i>Salary</label><input name="salary" value={formData.salary || ''} onChange={handleSalaryChange} onBlur={handleSalaryBlur} className="input" disabled={isViewOnly || (userProfile?.role === 'Shop Manager' && employee)} /></div>
                                <div><label className="text-sm font-medium text-slate-400"><i className="fas fa-briefcase mr-2 text-orange-400"></i>Position</label><select name="position" value={formData.position || ''} onChange={handleChange} className="select" disabled={isViewOnly}><option value="">Select Position</option>{(positions || []).map(p => <option key={p.id} value={p.position}>{p.position}</option>)}</select></div>
                                <div>
                                    <label className="text-sm font-medium text-slate-400"><i className="fas fa-clock mr-2 text-purple-400"></i>Shift</label>
                                    <select name="shift" value={formData.shift || ''} onChange={handleChange} className="select" disabled={isViewOnly}>
                                        <option value="">Select Shift</option>
                                        {/* MODIFIED: Map over unique strings instead of objects */}
                                        {availableShifts.map(shiftName => (
                                            <option key={shiftName} value={shiftName}>{shiftName}</option>
                                        ))}
                                    </select>
                                </div>
                                <div><label className="text-sm font-medium text-slate-400"><i className="fas fa-user-tie mr-2 text-blue-300"></i>Supervisor</label><select name="supervisor" value={formData.supervisor || ''} onChange={handleChange} className="select" disabled={isViewOnly}><option value="">Select Supervisor</option>{supervisors.map(e => <option key={e.id} value={e.name}>{e.name}</option>)}</select></div>
                                <div><label className="text-sm font-medium text-slate-400"><i className="fas fa-info-circle mr-2 text-gray-400"></i>Staff Status</label><select name="status" value={formData.status || 'Active'} onChange={handleChange} className="select" disabled={isViewOnly}><option>Active</option><option>Terminated</option><option>Resigned</option></select></div>
                                {isFormerEmployee && (
                                    <>
                                        <div><label className="text-sm font-medium text-slate-400"><i className="fas fa-calendar-day mr-2 text-red-300"></i>Status Change Date</label><input type="date" name="statusChangeDate" value={formData.statusChangeDate || ''} onChange={handleChange} className="input" disabled={isViewOnly} /></div>
                                        <div className="md:col-span-2"><label className="text-sm font-medium text-slate-400"><i className="fas fa-comment-dots mr-2 text-yellow-300"></i>Reason for Leaving</label><textarea name="reasonForLeaving" value={formData.reasonForLeaving || ''} onChange={handleChange} className="input" rows="2" disabled={isViewOnly}></textarea></div>
                                    </>
                                )}
                                
                                {/* --- NEW: Savings Program Checkbox (Only for New Employees) --- */}
                                {!employee && !isViewOnly && (
                                    <div className="md:col-span-full">
                                        <div className="flex items-center p-3 border border-slate-600 rounded-lg bg-slate-700/50">
                                            <input 
                                                id="enrollInSavings" 
                                                name="enrollInSavings" 
                                                type="checkbox" 
                                                checked={formData.enrollInSavings !== false} // Default to true if undefined
                                                onChange={handleChange} 
                                                className="h-5 w-5 rounded border-gray-300 text-green-500 focus:ring-green-600 bg-slate-600" 
                                            />
                                            <div className="ml-3">
                                                <label htmlFor="enrollInSavings" className="text-sm font-bold text-green-300 cursor-pointer">
                                                    <i className="fas fa-piggy-bank mr-2"></i> Enroll in Savings Program
                                                </label>
                                                <p className="text-xs text-slate-400 mt-0.5">
                                                    If checked, a savings account will be created automatically with 5% contribution.
                                                </p>
                                            </div>
                                        </div>
                                    </div>
                                )}
                                {/* --- END Savings Checkbox --- */}

                                <div className="md:col-span-full"><hr className="border-slate-700 my-2"/></div>
                                {/* System & Permissions */}
                                <div><label className="text-sm font-medium text-slate-400"><i className="fas fa-envelope mr-2 text-cyan-300"></i>Email</label><input type="email" name="email" value={formData.email || ''} onChange={handleChange} className="input" disabled={isViewOnly} /></div>
                                
                                {/* NEW: Password field for new employee creation */}
                                {!employee && (
                                    <div>
                                        <label className="text-sm font-medium text-slate-400"><i className="fas fa-lock mr-2 text-red-300"></i>Password (new user)</label>
                                        <div className="relative">
                                            <input
                                                type={showPassword ? "text" : "password"}
                                                value={password}
                                                onChange={(e) => setPassword(e.target.value)}
                                                className="input"
                                                placeholder="Min. 6 characters"
                                                disabled={isViewOnly}
                                            />
                                            <button type="button" onClick={() => setShowPassword(!showPassword)} className="absolute inset-y-0 right-0 pr-3 flex items-center text-sm leading-5">
                                                <i className={`fas ${showPassword ? 'fa-eye-slash' : 'fa-eye'} text-slate-400 hover:text-slate-200`}></i>
                                            </button>
                                        </div>
                                    </div>
                                )}
                                
                                <div><label className="text-sm font-medium text-slate-400"><i className="fas fa-user-shield mr-2 text-emerald-300"></i>Role</label><select name="role" value={formData.role || 'Staff'} onChange={handleChange} className="select" disabled={isViewOnly || userProfile?.role === 'Shop Manager'}><option>Admin</option><option>CEO</option><option>Shop Manager</option><option>Staff</option></select></div>
                                <div className="md:col-span-2 lg:col-span-3"><label className="text-sm font-medium text-slate-400"><i className="fas fa-map-marker-alt mr-2 text-red-500"></i>Address</label><textarea name="address" value={formData.address || ''} onChange={handleChange} className="input" rows="3" disabled={isViewOnly}></textarea></div>

                                <div className="md:col-span-2 lg:col-span-3">
                                    <label className="text-sm font-medium text-slate-400"><i className="fas fa-key mr-2 text-yellow-500"></i>Page Permissions</label>
                                    <div className="mt-2 grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4 p-4 border border-slate-600 rounded-lg bg-slate-700/50">
                                        {availablePages.map(page => {
                                            // A Shop Manager cannot grant permissions for these specific pages.
                                            const isRestrictedForManager = userProfile?.role === 'Shop Manager' && ['expenseReport', 'userActivity', 'settings'].includes(page.key);
                                            
                                            // The checkbox is only disabled if the modal is view-only or if a Shop Manager is viewing a restricted permission.
                                            const isDisabled = isViewOnly || isRestrictedForManager;

                                            return (
                                                <div key={page.key} className="flex items-center">
                                                    <input id={`perm-${page.key}`} type="checkbox" value={page.key} checked={formData.permissions?.includes(page.key)} onChange={handleChange} disabled={isDisabled} className="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500 bg-slate-600" />
                                                    <label htmlFor={`perm-${page.key}`} className={`ml-3 text-sm ${isDisabled ? 'text-slate-500' : 'text-slate-300'}`}>{page.label}</label>
                                                </div>
                                            );
                                        })}
                                    </div>
                                </div>
                                {/* NEW: Display auth errors here */}
                                {authError && <p className="text-red-400 text-sm md:col-span-full">{authError}</p>}
                            </div>
                            </>
                            )}
                        </ModalBody>
                        <ModalFooter>
                            {isViewOnly ? (
                                <>
                                    <Button type="button" variant="secondary" onClick={onClose}>Close</Button>
                                    {(userProfile?.role === 'Admin' || userProfile?.role === 'CEO' || userProfile?.role === 'Shop Manager') && (
                                        <Button type="button" variant="primary" icon="fa-edit" onClick={(e) => { e.preventDefault(); onSwitchToEdit(); }}>Edit</Button>
                                    )}
                                </>
                            ) : (
                                <>
                                    <Button type="button" variant="secondary" onClick={onClose}>Cancel</Button>
                                    <Button type="submit" variant="primary" className="px-6">Save</Button>
                                </>
                            )}
                        </ModalFooter>
                    </form>
                </Modal>
                
                {/* Image Cropper Modal Layer */}
                <ImageCropperModal 
                    isOpen={isCropModalOpen} 
                    onClose={() => setIsCropModalOpen(false)} 
                    imageSrc={cropImageSrc} 
                    onCropComplete={handleCropComplete} 
                />
                </>
            );
        };
        
        // NEW: ActiveEmployeesTab component to fix the reference error.
        // MODIFIED: Added 'pageParams' prop to handle auto-actions
        const ActiveEmployeesTab = ({ userProfile, pageParams }) => {
            // MODIFIED: Added 'auth'
            const { db, auth } = useFirebase();
            const [isModalOpen, setIsModalOpen] = useState(false);
            const [isViewOnly, setIsViewOnly] = useState(false);
            const [editingEmployee, setEditingEmployee] = useState(null);
            const [employeeToDelete, setEmployeeToDelete] = useState(null);
            
            // NEW: State for Salary History Modal
            const [historyEmployee, setHistoryEmployee] = useState(null);
            
            // REFACTORED: Get global shops AND global employees data from context
            const { shops, employees: globalEmployees } = useAppData();
            
            const [selectedShop, setSelectedShop] = useState('');
            const [searchTerm, setSearchTerm] = useState(''); // NEW: State for the search term

            // --- NEW: Import State & Refs ---
            const fileInputRef = useRef(null);
            const [importing, setImporting] = useState(false);
            const [importLog, setImportLog] = useState([]);

            // --- NEW: Template Download Handler ---
            const handleDownloadTemplate = async () => {
                if (!window.XLSX) {
                    try { await Utils.loadScript(Utils.LIBS.XLSX); } 
                    catch (e) { alert("Excel library not loaded."); return; }
                }
                
                const headers = [
                    {
                        'Name': 'Sok Dara', 
                        'Email': 'sokdara@example.com', 
                        'Password': 'password123', 
                        'Sex': 'M', 
                        'DOB': '1995-12-31', 
                        'Nation ID': '123456789', 
                        'Tel': '099887766', 
                        'Shop': 'Head Office', 
                        'Primary Shop': '', 
                        'Joined Date': '2024-01-01', 
                        'Salary': 250, 
                        'Position': 'Sales', 
                        'Shift': 'AM', 
                        'Supervisor': '', 
                        'Role': 'Staff', 
                        'Address': '#123, St 456, PP', 
                        'Page Permissions': 'checkinme', // NEW FIELD
                        'Enroll Savings': 'Yes'
                    }
                ];
                
                Utils.exportToExcel(headers, "Template", "Staff_Import_Template.xlsx", [
                    {wch: 20}, {wch: 25}, {wch: 15}, {wch: 5}, {wch: 12}, 
                    {wch: 15}, {wch: 15}, {wch: 15}, {wch: 15}, {wch: 12}, 
                    {wch: 10}, {wch: 15}, {wch: 10}, {wch: 15}, {wch: 10}, 
                    {wch: 30}, {wch: 20}, {wch: 15} // Added width for Permissions
                ]);
            };

            // --- NEW: Import Click Handler ---
            const handleImportClick = () => {
                if (fileInputRef.current) fileInputRef.current.click();
            };

            // --- NEW: File Process Handler ---
            const handleFileChange = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                
                // Reset Log
                setImportLog(["Initializing import..."]);
                setImporting(true);

                if (!window.XLSX) { 
                    alert("Excel library not ready."); 
                    setImporting(false);
                    return; 
                }

                const reader = new FileReader();
                reader.onload = async (evt) => {
                    try {
                        const bstr = evt.target.result;
                        const wb = window.XLSX.read(bstr, { type: 'binary' });
                        const wsname = wb.SheetNames[0];
                        const ws = wb.Sheets[wsname];
                        const data = window.XLSX.utils.sheet_to_json(ws);
                        await processImport(data);
                    } catch (err) {
                        console.error(err);
                        setImportLog(prev => [...prev, "Error reading file."]);
                        // Allow user to see error
                        setTimeout(() => setImporting(false), 3000);
                    }
                };
                reader.readAsBinaryString(file);
                e.target.value = ''; // Reset input so same file can be selected again
            };

            // --- NEW: Import Processing Logic ---
            const processImport = async (data) => {
                const { addDoc, collection, doc, setDoc, serverTimestamp, initializeApp, getAuth, createUserWithEmailAndPassword, deleteApp } = window.firebaseSDK;
                
                let success = 0;
                let failed = 0;
                setImportLog(prev => [...prev, `Found ${data.length} rows. Starting processing...`]);

                for (const row of data) {
                    if (!row['Name']) continue;
                    
                    try {
                        setImportLog(prev => [...prev, `> Processing ${row['Name']}...`]);
                        
                        let uid = '';
                        // 1. Create Auth User (using Secondary App to avoid logging out Admin)
                        if (row['Email'] && row['Password'] && String(row['Password']).length >= 6) {
                             try {
                                const tempName = `import-${Date.now()}-${Math.random()}`;
                                const tempApp = initializeApp(activeFirebaseConfig, tempName);
                                const tempAuth = getAuth(tempApp);
                                const cred = await createUserWithEmailAndPassword(tempAuth, row['Email'], row['Password']);
                                uid = cred.user.uid;
                                await deleteApp(tempApp); // Cleanup temp app
                                setImportLog(prev => [...prev, `   - Login created.`]);
                            } catch (authErr) {
                                setImportLog(prev => [...prev, `   - Auth Warning: ${authErr.code}. Creating profile without login.`]);
                            }
                        }

                        // 2. Map fields
                        
                        // NEW: Handle Permissions Parsing
                        let permissions = ['checkinme']; // Default
                        if (row['Page Permissions']) {
                            // Split by comma and trim whitespace (e.g. "checkinme, payroll" -> ["checkinme", "payroll"])
                            permissions = String(row['Page Permissions']).split(',').map(p => p.trim());
                        }

                        const newEmp = {
                            name: row['Name'],
                            sex: row['Sex'] || 'M',
                            dob: row['DOB'] || '',
                            nationId: String(row['Nation ID'] || ''),
                            tel: String(row['Tel'] || ''),
                            shop: row['Shop'] || '',
                            primaryShop: row['Primary Shop'] || '', 
                            joinedDate: row['Joined Date'] || new Date().toISOString().slice(0,10),
                            salary: parseFloat(row['Salary']) || 0,
                            position: row['Position'] || 'Staff',
                            shift: row['Shift'] || '',
                            supervisor: row['Supervisor'] || '',
                            email: row['Email'] || '',
                            uid: uid,
                            role: row['Role'] || 'Staff',
                            address: row['Address'] || '',
                            status: 'Active',
                            permissions: permissions, // MODIFIED: Use parsed permissions
                            photo: ''
                        };
                        
                        // Handle Shop Array for Manager/Admin (comma separation support)
                        if (['Admin', 'CEO', 'Shop Manager'].includes(newEmp.role)) {
                             if (newEmp.shop && newEmp.shop.includes(',')) {
                                 newEmp.shop = newEmp.shop.split(',').map(s => s.trim());
                             } else {
                                 newEmp.shop = newEmp.shop ? [newEmp.shop] : [];
                             }
                             // Set primary shop if missing but shop array exists
                             if (!newEmp.primaryShop && newEmp.shop.length > 0) newEmp.primaryShop = newEmp.shop[0];
                        }

                        // 3. Save to Firestore
                        const docRef = await addDoc(collection(db, 'employees'), newEmp);
                        
                        // 4. Savings Enrollment
                        if (row['Enroll Savings'] === 'Yes') {
                             const sShop = Array.isArray(newEmp.shop) ? (newEmp.shop[0] || '') : (newEmp.shop || '');
                             await setDoc(doc(db, 'savingprogram', docRef.id), {
                                employeeId: docRef.id,
                                employeeName: newEmp.name,
                                shop: sShop,
                                savingsProgramStatus: 'Active',
                                savingsPercentage: 5,
                                savingsJoinDate: newEmp.joinedDate,
                                savingsEffectiveMonth: newEmp.joinedDate.slice(0, 7),
                                currentBalance: 0,
                                mySavingCredit: 0,
                                mySavingWithdrawalTotal: 0,
                                lastUpdated: serverTimestamp()
                             });
                             setImportLog(prev => [...prev, `   - Enrolled in Savings.`]);
                        }
                        
                        success++;
                    } catch (e) {
                        console.error(e);
                        failed++;
                        setImportLog(prev => [...prev, `   - FAILED: ${e.message}`]);
                    }
                }
                
                setImportLog(prev => [...prev, `--------------------------------`]);
                setImportLog(prev => [...prev, `COMPLETED: ${success} Success, ${failed} Failed.`]);
                
                // Allow user to see logs before closing
                setTimeout(() => {
                    alert(`Import complete.\nSuccess: ${success}\nFailed: ${failed}`);
                    setImporting(false);
                    setImportLog([]);
                }, 1500);
            };

            // --- MODIFIED: Handle Auto-Open Action (Add New OR View Specific) ---
            useEffect(() => {
                if (!pageParams) return;

                if (pageParams.includes('add_new')) {
                    // Slight delay to ensure UI is ready
                    setTimeout(() => {
                        handleOpenModal(); 
                    }, 100);
                } else if (pageParams.includes('view:')) {
                    // Handle "view:{id}" param from Global Search
                    const parts = pageParams.split(':');
                    const targetId = parts[1]; // Get the ID
                    
                    // Use globalEmployees to find the person even if they aren't in the current table filter
                    if (targetId && globalEmployees.length > 0) {
                        const targetEmp = globalEmployees.find(e => e.id === targetId);
                        if (targetEmp) {
                            setTimeout(() => {
                                // Open in View-Only mode
                                handleOpenModal(targetEmp, true); 
                            }, 100);
                        }
                    }
                }
            }, [pageParams, globalEmployees]);

            // Set the initial shop filter based on the user's role and assigned shop(s).
            useEffect(() => {
                if (userProfile && userProfile.role !== 'Admin' && userProfile.role !== 'CEO') {
                    // Managers with multiple shops default to 'All My Shops' (empty string).
                    // Single-shop users default to their assigned shop.
                    setSelectedShop(Array.isArray(userProfile.shop) ? '' : userProfile.shop || '');
                }
            }, [userProfile]);
            
            // Use the custom hook to fetch and filter employees based on the selected shop.
            const { employees, loading } = useFilteredEmployees(userProfile, selectedShop);

            // NEW: Further filter the employees based on the search term.
            const searchedEmployees = useMemo(() => {
                // MODIFIED: Filter out 'Admin' role users from the visible list
                // This keeps the list focused on Staff/Managers and hides System Admins.
                const visibleEmployees = employees.filter(e => e.role !== 'Admin');

                if (!searchTerm) {
                    return visibleEmployees;
                }
                return visibleEmployees.filter(emp => 
                    emp.name.toLowerCase().includes(searchTerm.toLowerCase())
                );
            }, [employees, searchTerm]);
            
            // NEW: Function to handle exporting the current employee list to an Excel file.
            const handleExportExcel = useCallback(() => {
                // Format the data to have more readable headers and select specific fields.
                const dataToExport = searchedEmployees.map(emp => ({ 
                    'Name': emp.name,
                    'Email': emp.email,
                    'Position': emp.position,
                    'Shop': Array.isArray(emp.shop) ? emp.shop.join(', ') : emp.shop,
                    'Join Date': emp.joinedDate,
                    'Worked Duration': Utils.calculateWorkedDuration(emp.joinedDate),
                    'Shift': emp.shift,
                    'Telephone': emp.tel,
                    'Salary (KHR)': parseFloat(String(emp.salary).replace(/[^0-9.-]/g, '')) || 0
                }));

                const worksheet = XLSX.utils.json_to_sheet(dataToExport);
                const workbook = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(workbook, worksheet, "Active Employees");
                
                // Set column widths for better readability
                worksheet["!cols"] = [ 
                    { wch: 25 }, // Name
                    { wch: 30 }, // Email
                    { wch: 20 }, // Position
                    { wch: 20 }, // Shop
                    { wch: 15 }, // Join Date
                    { wch: 18 }, // Worked Duration
                    { wch: 10 }, // Shift
                    { wch: 15 }, // Telephone
                    { wch: 18 }  // Salary
                ];
                
                XLSX.writeFile(workbook, "Active_Employees_Report.xlsx");
            }, [searchedEmployees]); // Dependency on the filtered list ensures the correct data is exported.
            
            const handleOpenModal = (employee = null, viewOnly = false) => {
                setEditingEmployee(employee);
                setIsViewOnly(viewOnly);
                setIsModalOpen(true);
            };

            const handleCloseModal = () => {
                setEditingEmployee(null);
                setIsModalOpen(false);
            };

            // NEW: Handler for viewing history
            const handleViewHistory = (employee) => {
                setHistoryEmployee(employee);
            };

            // Handler for saving a new or edited employee.
            const handleSaveEmployee = async (formData) => {
                const { addDoc, updateDoc, doc, collection, setDoc, serverTimestamp, getDoc } = window.firebaseSDK;
                const { id, enrollInSavings, ...dataToSave } = formData;
                
                let action = '';
                let originalData = null;
                let savedEmployeeId = id;

                try {
                    if (id) {
                        action = 'Edit Employee';
                        const originalEmployee = employees.find(e => e.id === id);
                        if (originalEmployee) originalData = originalEmployee;

                        await updateDoc(doc(db, 'employees', id), dataToSave);

                        if (dataToSave.status === 'Terminated' || dataToSave.status === 'Resigned') {
                            try {
                                const savingsRef = doc(db, 'savingprogram', id);
                                const savingsDoc = await getDoc(savingsRef);
                                
                                if (savingsDoc.exists() && savingsDoc.data().savingsProgramStatus !== 'Inactive') {
                                    await updateDoc(savingsRef, {
                                        savingsProgramStatus: 'Inactive',
                                        savingsPercentage: 0,
                                        lastUpdated: serverTimestamp()
                                    });
                                }
                            } catch (savingsErr) {
                                console.error("Failed to auto-remove from savings:", savingsErr);
                            }
                        }

                    } else {
                        action = 'Add Employee';
                        const newDocRef = await addDoc(collection(db, 'employees'), dataToSave);
                        savedEmployeeId = newDocRef.id;

                        // --- NEW: AUTO-CREATE WELCOME NOTICE (KHMER CONTENT) ---
                        try {
                            const shopName = Array.isArray(dataToSave.shop) ? (dataToSave.shop[0] || '') : (dataToSave.shop || '');
                            // Format the joined date for the message
                            const displayJoinedDate = Utils.formatISOToDisplay(dataToSave.joinedDate);
                            
                            await addDoc(collection(db, 'memoAlerts'), {
                                title: `  ${dataToSave.name}!`,
                                // REVISED: Content in Khmer as specifically requested
                                content: ` **${dataToSave.name}**   **${shopName}**  **${dataToSave.position}**  **${displayJoinedDate}**!`,
                                startTime: '08:00',
                                endTime: '18:00',
                                targetShops: shopName ? [shopName] : [], 
                                status: 'Active',
                                authorName: 'System',
                                authorId: 'system',
                                createdAt: serverTimestamp(),
                                readBy: [],
                                likes: []
                            });
                            console.log(`Welcome notice created for ${dataToSave.name}`);
                        } catch (noticeError) {
                            console.error("Failed to create welcome notice:", noticeError);
                        }
                        // --- END WELCOME NOTICE ---

                        if (enrollInSavings !== false) {
                            try {
                                const today = new Date();
                                const savingsDefaults = {
                                    employeeId: savedEmployeeId,
                                    employeeName: dataToSave.name,
                                    shop: Array.isArray(dataToSave.shop) ? (dataToSave.shop[0] || '') : (dataToSave.shop || ''),
                                    savingsProgramStatus: 'Active',
                                    savingsPercentage: 5,
                                    savingsJoinDate: today.toISOString().slice(0, 10),
                                    savingsEffectiveMonth: today.toISOString().slice(0, 7),
                                    currentBalance: 0,
                                    mySavingCredit: 0,
                                    mySavingWithdrawalTotal: 0,
                                    lastUpdated: serverTimestamp()
                                };
                                await setDoc(doc(db, 'savingprogram', savedEmployeeId), savingsDefaults);
                            } catch (savingsError) {
                                console.error("Failed to auto-enroll new employee in savings program:", savingsError);
                            }
                        }
                    }

                    Utils.logUserActivity(db, auth, action, {
                        id: savedEmployeeId,
                        name: dataToSave.name,
                        originalData: originalData,
                        updatedData: dataToSave
                    });

                    handleCloseModal();
                } catch (error) {
                    console.error("Error saving employee:", error);
                }
            };
            
            const handleDeleteEmployee = (employee) => {
                setEmployeeToDelete(employee);
            };

            const confirmDelete = async () => {
                if (!employeeToDelete) return;
                const { doc, updateDoc, getDoc, serverTimestamp } = window.firebaseSDK; // Added getDoc, serverTimestamp
                try {
                    const employeeRef = doc(db, 'employees', employeeToDelete.id);
                    // Instead of deleting, we change the status to 'Terminated'.
                    await updateDoc(employeeRef, { status: 'Terminated', statusChangeDate: new Date().toISOString().substring(0, 10), reasonForLeaving: 'Deleted from active list' });
                    
                    // --- NEW: Auto-Remove from Savings Program ---
                    try {
                        const savingsRef = doc(db, 'savingprogram', employeeToDelete.id);
                        const savingsDoc = await getDoc(savingsRef);
                        
                        if (savingsDoc.exists() && savingsDoc.data().savingsProgramStatus !== 'Inactive') {
                            await updateDoc(savingsRef, {
                                savingsProgramStatus: 'Inactive',
                                savingsPercentage: 0,
                                lastUpdated: serverTimestamp()
                            });
                            console.log(`[Auto-Action] Removed ${employeeToDelete.name} from Savings Program due to deletion.`);
                        }
                    } catch (savingsErr) {
                        console.error("Failed to auto-remove from savings during delete:", savingsErr);
                    }
                    // --- END AUTO-REMOVE ---

                } catch (error) {
                    console.error("Error 'deleting' (terminating) employee:", error);
                } finally {
                    setEmployeeToDelete(null);
                }
            };

            // Render logic for the Active Employees tab.
            // OPTIMIZATION: Refactored to use PageHeader, SearchInput, and ShopFilterSelect
            return (
                <Card>
                    <PageHeader title={`Active Employee List - ${searchedEmployees.length}`}>
                        <SearchInput 
                            value={searchTerm} 
                            onChange={e => setSearchTerm(e.target.value)} 
                            placeholder="Search by name..."
                        />
                        
                        <ShopFilterSelect 
                            userProfile={userProfile}
                            shops={shops}
                            selectedShop={selectedShop}
                            onChange={e => setSelectedShop(e.target.value)}
                        />

                        <Button variant="success" icon="fa-file-excel" onClick={handleExportExcel} disabled={loading}>
                            Excel
                        </Button>

                        {/* --- NEW: Import/Template Buttons --- */}
                        {(userProfile?.role === 'Admin' || userProfile?.role === 'CEO' || userProfile?.role === 'Shop Manager') && (
                            <>
                                <Button variant="secondary" icon="fa-file-download" onClick={handleDownloadTemplate} title="Download Template">Template</Button>
                                <Button variant="secondary" icon="fa-file-import" onClick={handleImportClick} title="Import Staff" disabled={importing}>Import</Button>
                                <input 
                                    type="file" 
                                    ref={fileInputRef} 
                                    onChange={handleFileChange} 
                                    className="hidden" 
                                    accept=".xlsx, .xls"
                                />
                                <Button variant="primary" icon="fa-plus" onClick={() => handleOpenModal()}>Add Employee</Button>
                            </>
                        )}
                    </PageHeader>
                    
                    {/* --- NEW: Import Log Overlay --- */}
                    {importing && (
                        <div className="fixed inset-0 bg-black/70 z-[70] flex items-center justify-center p-4">
                            <div className="bg-slate-800 p-6 rounded-xl shadow-2xl max-w-lg w-full border border-slate-600 flex flex-col max-h-[80vh]">
                                <h3 className="text-white font-bold text-lg mb-4 flex items-center gap-3">
                                    <i className="fas fa-cog fa-spin text-blue-400"></i> Importing Staff...
                                </h3>
                                <div className="flex-1 overflow-y-auto bg-slate-900 p-4 rounded-lg border border-slate-700 font-mono text-xs text-slate-300 space-y-1">
                                    {importLog.map((l, i) => (
                                        <div key={i} className={`${l.includes('Error') ? 'text-red-400' : l.includes('Success') ? 'text-green-400' : ''}`}>
                                            {l}
                                        </div>
                                    ))}
                                    <div ref={(el) => el?.scrollIntoView({ behavior: 'smooth' })} />
                                </div>
                            </div>
                        </div>
                    )}

                    {loading ? (
                        <div className="text-center py-10"><i className="fas fa-spinner fa-spin text-3xl"></i></div>
                    ) : (
                        <EmployeeTable
                            employees={searchedEmployees}
                            userProfile={userProfile}
                            onView={(emp) => handleOpenModal(emp, true)}
                            onDelete={handleDeleteEmployee}
                            onViewHistory={handleViewHistory} // Pass the handler
                        />
                    )}

                    <EmployeeModal
                        isOpen={isModalOpen}
                        onClose={handleCloseModal}
                        onSave={handleSaveEmployee}
                        employee={editingEmployee}
                        userProfile={userProfile}
                        isViewOnly={isViewOnly}
                        onSwitchToEdit={() => setIsViewOnly(false)}
                        allEmployees={employees} 
                    />
                    
                    {/* NEW: Render Salary History Modal */}
                    <SalaryHistoryModal 
                        isOpen={!!historyEmployee} 
                        onClose={() => setHistoryEmployee(null)} 
                        employee={historyEmployee} 
                    />

                    <ConfirmationModal
                        isOpen={!!employeeToDelete}
                        onClose={() => setEmployeeToDelete(null)}
                        onConfirm={confirmDelete}
                        title="Confirm Deletion"
                        message={`Are you sure you want to remove ${employeeToDelete?.name}? Their status will be set to 'Terminated'.`}
                    />
                </Card>
            );
        };

        // NEW: Salary Revision Table Component (Fix for ReferenceError)
        const SalaryRevisionTable = memo(({ revisions, canManage, onUpdateStatus, onEdit, onDelete }) => {
            return (
                <div className="overflow-x-auto">
                    <table className="min-w-full divide-y divide-slate-700">
                        <thead className="bg-slate-900/50">
                            <tr>
                                <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Req. Date</th>
                                <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Eff. Date</th>
                                <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Shop</th>
                                <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Staff</th>
                                <th className="px-4 py-3 text-right text-xs font-semibold text-slate-400 uppercase">Base Salary</th>
                                <th className="px-4 py-3 text-right text-xs font-semibold text-slate-400 uppercase">Amount</th>
                                <th className="px-4 py-3 text-right text-xs font-semibold text-slate-400 uppercase">New Salary</th>
                                <th className="px-4 py-3 text-center text-xs font-semibold text-slate-400 uppercase">Status</th>
                                <th className="px-4 py-3 text-center text-xs font-semibold text-slate-400 uppercase">Actions</th>
                            </tr>
                        </thead>
                        <tbody className="divide-y divide-slate-700">
                            {revisions.map(rev => (
                                <tr key={rev.id} className="hover:bg-slate-700/50">
                                    <td className="px-4 py-4 text-sm text-slate-300 whitespace-nowrap">{Utils.formatISOToDisplay(rev.reqDate)}</td>
                                    <td className="px-4 py-4 text-sm text-slate-300 whitespace-nowrap">{Utils.formatISOToDisplay(rev.effectiveDate)}</td>
                                    <td className="px-4 py-4 text-sm text-slate-300">{rev.shopName}</td>
                                    <td className="px-4 py-4 text-sm text-slate-200">{rev.staffName}</td>
                                    <td className="px-4 py-4 text-sm text-right text-slate-300">{Utils.formatCurrency(rev.baseSalary)}</td>
                                    <td className={`px-4 py-4 text-sm text-right font-bold ${parseFloat(rev.reviseAmount) >= 0 ? 'text-green-400' : 'text-red-400'}`}>
                                        {Utils.formatCurrency(rev.reviseAmount)}
                                    </td>
                                    <td className="px-4 py-4 text-sm text-right font-bold text-blue-300">{Utils.formatCurrency(rev.updatedSalary)}</td>
                                    <td className="px-4 py-4 text-center">
                                        <span className={`px-2 py-1 text-xs rounded-full ${
                                            rev.status === 'Approved' ? 'bg-green-900 text-green-300' : 
                                            rev.status === 'Rejected' ? 'bg-red-900 text-red-300' : 
                                            'bg-yellow-900 text-yellow-300'
                                        }`}>
                                            {rev.status}
                                        </span>
                                    </td>
                                    <td className="px-4 py-4 text-center whitespace-nowrap">
                                        <div className="flex items-center justify-center gap-2">
                                            {canManage && rev.status === 'Pending' && (
                                                <>
                                                    <Button variant="icon-approve" icon="fa-check" onClick={() => onUpdateStatus(rev, 'Approved')} title="Approve" />
                                                    <Button variant="icon-reject" icon="fa-times" onClick={() => onUpdateStatus(rev, 'Rejected')} title="Reject" />
                                                </>
                                            )}
                                            {canManage && (
                                                <>
                                                    <Button variant="icon-edit" icon="fa-edit" onClick={() => onEdit(rev)} />
                                                    <Button variant="icon-delete" icon="fa-trash" onClick={() => onDelete(rev)} />
                                                </>
                                            )}
                                        </div>
                                    </td>
                                </tr>
                            ))}
                            {revisions.length === 0 && (
                                <tr><td colSpan="9" className="px-4 py-8 text-center text-slate-500">No revisions found.</td></tr>
                            )}
                        </tbody>
                    </table>
                </div>
            );
        });

        // NEW: Modal for adding/editing salary revisions
        const SalaryRevisionModal = ({ isOpen, onClose, onSave, revision, userProfile }) => {
            // Get global data from context
            const { shops, employees } = useAppData();
            const [formData, setFormData] = useState({});

            // OPTIMIZATION: Use the new hook
            const availableShops = useAllowedShops(userProfile, shops);

            const employeesInShop = useMemo(() => {
                if (!formData.shopName) return [];
                return employees.filter(emp => {
                    const employeeShops = Array.isArray(emp.shop) ? emp.shop : [emp.shop];
                    return employeeShops.includes(formData.shopName) && emp.status === 'Active';
                });
            }, [formData.shopName, employees]);

            // Initialize form
            useEffect(() => {
                const initialData = revision 
                    ? { ...revision }
                    : {
                        reqDate: new Date().toISOString().substring(0, 10),
                        effectiveDate: new Date().toISOString().substring(0, 10),
                        shopName: '',
                        staffId: '',
                        reviseAmount: '',
                        baseSalary: 0,
                        updatedSalary: 0,
                        status: 'Pending'
                    };
                setFormData(initialData);
            }, [revision, isOpen]);
            
            // REMOVED: The two separate useEffect hooks for salary calculation have been removed.

            // REVISED: Consolidated all salary calculation logic into a single, more robust handleChange function.
            // This prevents race conditions and ensures data consistency when the form is updated.
            const handleChange = useCallback((e) => {
                const { name, value } = e.target;
                
                setFormData(prev => {
                    const newFormData = { ...prev, [name]: value };

                    // When the shop selection changes...
                    if (name === 'shopName') {
                        // ...reset all employee-specific fields.
                        newFormData.staffId = '';
                        newFormData.staffName = '';
                        newFormData.baseSalary = 0;
                        newFormData.reviseAmount = '';
                        newFormData.updatedSalary = 0;
                    }

                    // When the staff selection changes...
                    if (name === 'staffId') {
                        const selectedEmployee = employees.find(emp => emp.id === value);
                        if (selectedEmployee) {
                            // ...update the staff name and recalculate salaries from scratch.
                            newFormData.staffName = selectedEmployee.name;
                            const currentSalary = parseFloat(String(selectedEmployee.salary).replace(/[^0-9.-]/g, '')) || 0;
                            const revisedAmount = parseFloat(newFormData.reviseAmount) || 0;
                            newFormData.baseSalary = currentSalary;
                            newFormData.updatedSalary = currentSalary + revisedAmount;
                        } else {
                            // ...or reset if the staff is deselected.
                            newFormData.staffName = '';
                            newFormData.baseSalary = 0;
                            newFormData.updatedSalary = parseFloat(newFormData.reviseAmount) || 0;
                        }
                    }

                    // When only the revision amount changes...
                    if (name === 'reviseAmount') {
                        // ...recalculate just the final salary.
                        const base = parseFloat(newFormData.baseSalary) || 0;
                        const revise = parseFloat(value) || 0;
                        newFormData.updatedSalary = base + revise;
                    }

                    return newFormData;
                });
            }, [employees]); // Dependency on employees is needed to find staff details.
            
            const handleSubmit = (e) => {
                e.preventDefault();
                onSave(formData);
            };
            
            return (
                <Modal isOpen={isOpen} onClose={onClose} maxWidth="max-w-3xl">
                    {/* FIX: Added 'flex flex-col h-full overflow-hidden' to ensure proper scrolling on mobile */}
                    <form onSubmit={handleSubmit} className="flex flex-col h-full overflow-hidden">
                        <ModalHeader title={revision ? "Edit Salary Revision" : "Add New Salary Revision"} onClose={onClose} />
                        <ModalBody>
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <label className="text-sm font-medium text-slate-400">
                                        <i className="fas fa-calendar-alt mr-2 text-blue-400"></i>Request Date
                                    </label>
                                    <input type="date" name="reqDate" value={formData.reqDate || ''} onChange={handleChange} className="input" required />
                                </div>
                                <div>
                                    <label className="text-sm font-medium text-slate-400">
                                        <i className="fas fa-calendar-check mr-2 text-green-400"></i>Effective Date
                                    </label>
                                    <input type="date" name="effectiveDate" value={formData.effectiveDate || ''} onChange={handleChange} className="input" required />
                                </div>
                                
                                <div>
                                    <label className="text-sm font-medium text-slate-400">
                                        <i className="fas fa-store mr-2 text-purple-400"></i>Shop Name
                                    </label>
                                    <select name="shopName" value={formData.shopName || ''} onChange={handleChange} className="select" required>
                                        <option value="">Select Shop</option>
                                        {availableShops.map(shop => <option key={shop.id} value={shop.name}>{shop.name}</option>)}
                                    </select>
                                </div>
                                
                                <div>
                                    <label className="text-sm font-medium text-slate-400">
                                        <i className="fas fa-user mr-2 text-orange-400"></i>Staff Name
                                    </label>
                                    <select name="staffId" value={formData.staffId || ''} onChange={handleChange} className="select" required disabled={!formData.shopName}>
                                        <option value="">Select Staff</option>
                                        {employeesInShop.map(e => <option key={e.id} value={e.id}>{e.name}</option>)}
                                    </select>
                                </div>

                                <div>
                                    <label className="text-sm font-medium text-slate-400">
                                        <i className="fas fa-money-bill mr-2 text-slate-400"></i>Base Salary
                                    </label>
                                    <input value={Utils.formatCurrency(formData.baseSalary)} className="input" disabled />
                                </div>
                                <div>
                                    <label className="text-sm font-medium text-slate-400">
                                        <i className="fas fa-chart-line mr-2 text-yellow-400"></i>Revise Amount
                                    </label>
                                    <input type="number" name="reviseAmount" value={formData.reviseAmount || ''} onChange={handleChange} className="input" required />
                                </div>

                                <div className="md:col-span-2">
                                   <label className="text-sm font-medium text-slate-400">
                                       <i className="fas fa-money-bill-wave mr-2 text-green-500"></i>Updated Salary
                                   </label>
                                   <input value={Utils.formatCurrency(formData.updatedSalary)} className="input" disabled />
                                </div>
                            </div>
                        </ModalBody>
                        <ModalFooter>
                            <Button variant="secondary" onClick={onClose}>Cancel</Button>
                            <Button 
                                type="submit" 
                                variant="primary"
                                // FIX: Corrected disabled logic to use this component's state
                                // It should check for staffId and reviseAmount from its own formData.
                                disabled={!formData.staffId || !formData.reviseAmount}
                            >
                                {/* FIX: Corrected button text. */}
                                Save Revision
                            </Button>
                        </ModalFooter>
                    </form>
                </Modal>
            );
        };

        // Component: Salary Revise Report Tab
        const SalaryReviseReportTab = ({ userProfile }) => {
            // MODIFIED: Added 'auth'
            const { db, auth } = useFirebase();
            const { where } = window.firebaseSDK;
            const { shops } = useAppData();
            
            // State for modal and filters
            const [isModalOpen, setIsModalOpen] = useState(false);
            const [editingRevision, setEditingRevision] = useState(null);
            const [revisionToDelete, setRevisionToDelete] = useState(null);
            const [selectedShop, setSelectedShop] = useState('');
            // REVISED: Added search term state
            const [searchTerm, setSearchTerm] = useState('');

            // Data fetching
            const queryConstraints = useMemo(() => {
                if (!userProfile) return [where("shopName", "==", "null")];
                if (userProfile.role === 'Admin' || userProfile.role === 'CEO') return [];
                if (userProfile.role === 'Shop Manager') {
                    const managedShops = Array.isArray(userProfile.shop) ? userProfile.shop : (userProfile.shop ? [userProfile.shop] : []);
                    return managedShops.length > 0 ? [where("shopName", "in", managedShops)] : [where("shopName", "==", "null")];
                }
                return [where("staffId", "==", userProfile.id || null)];
            }, [userProfile]);
            
            const { data: revisions, loading } = useCollection('salaryRevisions', queryConstraints);
            
            const filteredRevisions = useMemo(() => {
                return revisions
                    .filter(rev => 
                        (!selectedShop || rev.shopName === selectedShop) &&
                        // REVISED: Replaced month filter with search term filter
                        (!searchTerm || (rev.staffName && rev.staffName.toLowerCase().includes(searchTerm.toLowerCase())))
                    )
                    .sort((a,b) => (b.reqDate || '').localeCompare(a.reqDate || ''));
            // REVISED: Updated dependency array
            }, [revisions, selectedShop, searchTerm]);

            // Handlers
            const handleOpenModal = (revision = null) => { setEditingRevision(revision); setIsModalOpen(true); };
            const handleCloseModal = () => { setEditingRevision(null); setIsModalOpen(false); };
            
            const handleSaveRevision = async (formData) => {
                const { addDoc, updateDoc, doc, collection, serverTimestamp } = window.firebaseSDK;
                const { id, ...dataToSave } = formData;
                
                try {
                    if (id) {
                        await updateDoc(doc(db, 'salaryRevisions', id), dataToSave);
                    } else {
                        await addDoc(collection(db, 'salaryRevisions'), { ...dataToSave, status: 'Pending', createdAt: serverTimestamp() });
                    }
                    handleCloseModal();
                } catch (error) { console.error("Error saving salary revision:", error); }
            };
            
            const handleUpdateStatus = async (revision, newStatus) => {
                const { updateDoc, doc } = window.firebaseSDK;
                try {
                    const revisionRef = doc(db, 'salaryRevisions', revision.id);
                    await updateDoc(revisionRef, { status: newStatus });
                    
                    // --- NEW: Log the approval/rejection ---
                    const action = newStatus === 'Approved' ? 'Approve Salary Revision' : 'Reject Salary Revision';
                    Utils.logUserActivity(db, auth, action, {
                        id: revision.id,
                        name: revision.staffName,
                        originalData: { ...revision, status: 'Pending' },
                        updatedData: { ...revision, status: newStatus }
                    });
                } catch (error) { console.error("Error updating revision status:", error); }
            };
            
            const handleDeleteConfirm = async () => {
                if (!revisionToDelete) return;
                try {
                    await window.firebaseSDK.deleteDoc(window.firebaseSDK.doc(db, 'salaryRevisions', revisionToDelete.id));
                } catch (error) { console.error("Error deleting revision:", error); }
                finally { setRevisionToDelete(null); }
            };

            // NEW: Excel Export Handler
            const handleExportExcel = () => {
                const data = filteredRevisions.map(rev => ({
                    'Req Date': rev.reqDate,
                    'Effective Date': rev.effectiveDate,
                    'Shop': rev.shopName,
                    'Staff': rev.staffName,
                    'Base Salary': rev.baseSalary,
                    'Revise Amount': rev.reviseAmount,
                    'New Salary': rev.updatedSalary,
                    'Status': rev.status
                }));
                Utils.exportToExcel(data, "Salary Revisions", "Salary_Revision_Report.xlsx", [
                    { wch: 15 }, { wch: 15 }, { wch: 20 }, { wch: 25 }, { wch: 15 }, { wch: 15 }, { wch: 15 }, { wch: 10 }
                ]);
            };

            const canManage = userProfile?.role === 'Admin' || userProfile?.role === 'CEO';
            
            // OPTIMIZATION: Use the new hook
            const availableShops = useAllowedShops(userProfile, shops);

            return (
                <Card>
                    <PageHeader title="Salary Revision Management">
                        <ShopFilterSelect 
                            userProfile={userProfile}
                            shops={shops}
                            selectedShop={selectedShop}
                            onChange={e => setSelectedShop(e.target.value)}
                        />
                        <SearchInput value={searchTerm} onChange={e => setSearchTerm(e.target.value)} />
                        
                        <Button variant="success" icon="fa-file-excel" onClick={handleExportExcel}>Excel</Button>
                        
                        {canManage && <Button variant="primary" icon="fa-plus" onClick={() => handleOpenModal()}>Add Revision</Button>}
                    </PageHeader>

                    {loading ? <div className="text-center py-10"><i className="fas fa-spinner fa-spin text-3xl text-blue-500"></i></div> : (
                        // OPTIMIZATION: Used the new extracted component
                        <SalaryRevisionTable 
                            revisions={filteredRevisions}
                            canManage={canManage}
                            onUpdateStatus={handleUpdateStatus}
                            onEdit={(rev) => handleOpenModal(rev)}
                            onDelete={setRevisionToDelete}
                        />
                    )}
                    <SalaryRevisionModal isOpen={isModalOpen} onClose={handleCloseModal} onSave={handleSaveRevision} revision={editingRevision} userProfile={userProfile} />
                    <ConfirmationModal isOpen={!!revisionToDelete} onClose={() => setRevisionToDelete(null)} onConfirm={handleDeleteConfirm} title="Delete Revision" message="Are you sure you want to delete this salary revision record?" />
                </Card>
            );
        };
        
        // NEW: Table component specifically for displaying former employees.
        const FormerEmployeeTable = memo(({ employees, userProfile, onEdit, onDelete }) => {
            return (
                <div className="overflow-x-auto">
                    <table className="min-w-full divide-y divide-slate-700">
                        <thead className="bg-slate-900/50">
                            <tr>
                                <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Date</th>
                                <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Shop Name</th>
                                <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Staff</th>
                                <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Worked Dur.</th>
                                <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Status</th>
                                <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Reason</th>
                                <th className="px-4 py-3 text-center text-xs font-semibold text-slate-400 uppercase">Actions</th>
                            </tr>
                        </thead>
                        <tbody className="divide-y divide-slate-700">
                            {employees.map(emp => (
                                <tr key={emp.id} className="hover:bg-slate-700/50">
                                    <td className="px-4 py-4 text-sm text-slate-300 whitespace-nowrap">{Utils.formatISOToDisplay(emp.statusChangeDate)}</td>
                                    <td className="px-4 py-4 text-sm text-slate-300 whitespace-nowrap">{Array.isArray(emp.shop) ? emp.shop.join(', ') : emp.shop}</td>
                                    <td className="px-4 py-4 text-sm text-slate-200 whitespace-nowrap">{emp.name}</td>
                                    <td className="px-4 py-4 text-sm text-slate-300 whitespace-nowrap">{Utils.calculateWorkedDuration(emp.joinedDate, emp.statusChangeDate)}</td>
                                    <td className="px-4 py-4 text-sm text-slate-300 whitespace-nowrap">{emp.status}</td>
                                    <td className="px-4 py-4 text-sm text-slate-300 whitespace-pre-wrap max-w-xs truncate" title={emp.reasonForLeaving}>{emp.reasonForLeaving}</td>
                                    <td className="px-4 py-4 text-center whitespace-nowrap">
                                        <div className="flex items-center justify-center gap-4">
                                            {(userProfile?.role === 'Admin' || userProfile?.role === 'CEO' || userProfile?.role === 'Shop Manager') && (
                                                <Button variant="icon-edit" icon="fa-edit" onClick={() => onEdit(emp)} title="Edit Record"/>
                                            )}
                                            {/* Permanent delete is restricted to Admin/CEO for data integrity */}
                                            {(userProfile?.role === 'Admin' || userProfile?.role === 'CEO') && (
                                                <Button variant="icon-delete" icon="fa-trash" onClick={() => onDelete(emp)} title="Permanently Delete"/>
                                            )}
                                        </div>
                                    </td>
                                </tr>
                            ))}
                        </tbody>
                    </table>
                </div>
            );
        });

        // REPLACED: This component now provides the requested report table for former employees.
        const FormerEmployeesTab = ({ userProfile }) => {
            const { db } = useFirebase();
            const [isModalOpen, setIsModalOpen] = useState(false);
            const [editingEmployee, setEditingEmployee] = useState(null);
            const [employeeToDelete, setEmployeeToDelete] = useState(null);
            
            // Get global shops data from context for the filter dropdown.
            const { shops } = useAppData();
            
            const [selectedShop, setSelectedShop] = useState('');
            const [searchTerm, setSearchTerm] = useState('');

            // Set initial shop filter based on user's role.
            useEffect(() => {
                if (userProfile && userProfile.role !== 'Admin' && userProfile.role !== 'CEO') {
                    setSelectedShop(Array.isArray(userProfile.shop) ? '' : userProfile.shop || '');
                }
            }, [userProfile]);
            
            // Custom hook to fetch former employees based on user role and selected shop.
            const useFormerEmployees = (userProfile, selectedShop) => {
                const { db } = useFirebase();
                const [employees, setEmployees] = useState([]);
                const [loading, setLoading] = useState(true);

                useEffect(() => {
                    if (!db || !userProfile) return () => {};
                    
                    const { collection, query, where, onSnapshot } = window.firebaseSDK;
                    setLoading(true);
                    
                    const statusFilter = where("status", "in", ["Terminated", "Resigned"]);
                    let finalQuery;
                    
                    const baseQuery = query(collection(db, "employees"), statusFilter);
                    const role = userProfile.role;

                    if (role === 'Admin' || role === 'CEO') {
                        finalQuery = selectedShop ? query(baseQuery, where("shop", "==", selectedShop)) : baseQuery;
                    } else if (role === 'Shop Manager') {
                        const managedShops = Array.isArray(userProfile.shop) ? userProfile.shop : (userProfile.shop ? [userProfile.shop] : []);
                        if (managedShops.length > 0) {
                            const shopsToQuery = selectedShop ? [selectedShop] : managedShops;
                            finalQuery = query(baseQuery, where("shop", "in", shopsToQuery));
                        } else {
                            setEmployees([]); setLoading(false); return; // Manager with no shops sees nothing
                        }
                    } else {
                        setEmployees([]); setLoading(false); return; // Staff role sees nothing
                    }

                    const unsub = onSnapshot(finalQuery, (snapshot) => {
                        setEmployees(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
                        setLoading(false);
                    }, (error) => {
                        console.error("Error fetching former employees:", error);
                        setLoading(false);
                    });

                    return () => unsub();
                }, [db, userProfile, selectedShop]);

                return { employees, loading };
            };

            const { employees, loading } = useFormerEmployees(userProfile, selectedShop);

            // Further filter employees based on search term on the client side.
            const searchedEmployees = useMemo(() => {
                if (!searchTerm) return employees;
                return employees.filter(emp => 
                    emp.name.toLowerCase().includes(searchTerm.toLowerCase())
                );
            }, [employees, searchTerm]);
            
            // Determine which shops are available for the filter dropdown.
            const availableShopsForFilter = useMemo(() => {
                if (!userProfile || !shops) return [];
                if (userProfile.role === 'Admin' || userProfile.role === 'CEO') return shops;
                if (userProfile.role === 'Shop Manager' && Array.isArray(userProfile.shop)) {
                    return userProfile.shop.map(name => ({ id: name, name: name }));
                }
                return [];
            }, [userProfile, shops]);
            
            // Handlers for modal operations.
            const handleOpenModal = (employee) => {
                setEditingEmployee(employee);
                setIsModalOpen(true);
            };

            const handleCloseModal = () => {
                setEditingEmployee(null);
                setIsModalOpen(false);
            };

            const handleSaveEmployee = async (formData) => {
                const { updateDoc, doc } = window.firebaseSDK;
                const { id, ...dataToSave } = formData;
                try {
                    await updateDoc(doc(db, 'employees', id), dataToSave);
                    handleCloseModal();
                } catch (error) {
                    console.error("Error updating former employee:", error);
                }
            };
            
            // Handlers for deletion.
            const handleDeleteEmployee = (employee) => {
                setEmployeeToDelete(employee);
            };

            const confirmDelete = async () => {
                if (!employeeToDelete) return;
                const { doc, deleteDoc } = window.firebaseSDK;
                try {
                    // This is a permanent, hard delete from the database.
                    await deleteDoc(doc(db, 'employees', employeeToDelete.id));
                } catch (error) {
                    console.error("Error permanently deleting employee record:", error);
                } finally {
                    setEmployeeToDelete(null);
                }
            };

            // OPTIMIZATION: Refactored to use new components
            return (
                <Card>
                    <PageHeader title="Resigned/Terminated Employee List">
                        <SearchInput value={searchTerm} onChange={e => setSearchTerm(e.target.value)} />
                        <ShopFilterSelect 
                            userProfile={userProfile}
                            shops={shops}
                            selectedShop={selectedShop}
                            onChange={e => setSelectedShop(e.target.value)}
                        />
                    </PageHeader>

                    {loading ? (
                        <div className="text-center py-10"><i className="fas fa-spinner fa-spin text-3xl"></i></div>
                    ) : (
                        <FormerEmployeeTable 
                            employees={searchedEmployees}
                            userProfile={userProfile}
                            onEdit={handleOpenModal}
                            onDelete={handleDeleteEmployee}
                        />
                    )}

                    <EmployeeModal
                        isOpen={isModalOpen}
                        onClose={handleCloseModal}
                        onSave={handleSaveEmployee}
                        employee={editingEmployee}
                        userProfile={userProfile}
                        isViewOnly={false} // Always open in edit mode for this tab
                        onSwitchToEdit={() => {}} // Not applicable here
                    />

                    <ConfirmationModal
                        isOpen={!!employeeToDelete}
                        onClose={() => setEmployeeToDelete(null)}
                        onConfirm={confirmDelete}
                        title="Confirm Permanent Deletion"
                        message={`Are you sure you want to PERMANENTLY delete the record for ${employeeToDelete?.name}? This action cannot be undone and will remove all their historical data.`}
                    />
                </Card>
            );
        };

        // Component: Main Employees Page (Tab Container)
        // MODIFIED: Added 'pageParams' prop
        const EmployeesPage = ({ userProfile, pageParams }) => {
            // NEW: Get module config for granular control
            const { moduleConfig = {} } = useAppData();
            
            const [activeTab, setActiveTab] = useState(''); // Default empty, set by effect

            // MODIFIED: Filter tabs based on configuration
            const tabs = useMemo(() => {
                const available = {};
                
                // Helper to check if enabled (default true)
                const isEnabled = (key) => moduleConfig?.[key] !== false;

                if (isEnabled('employees:active')) {
                    available.active = <span><i className="fas fa-users mr-2 text-blue-400"></i>Active Employees</span>;
                }
                if (isEnabled('employees:salaryReport')) {
                    available.salaryReport = <span><i className="fas fa-file-invoice-dollar mr-2 text-green-400"></i>Salary Revise Report</span>;
                }
                if (isEnabled('employees:former')) {
                    available.former = <span><i className="fas fa-user-slash mr-2 text-red-400"></i>Resigned/Terminated</span>;
                }
                
                return available;
            }, [moduleConfig]);

            // Ensure we have a valid active tab
            useEffect(() => {
                const keys = Object.keys(tabs);
                if (keys.length > 0 && !tabs[activeTab]) {
                    setActiveTab(keys[0]);
                }
            }, [tabs, activeTab]);

            return (
                <TabbedPage tabs={tabs} activeTab={activeTab} setActiveTab={setActiveTab}>
                    {/* MODIFIED: Conditionally render content */}
                    {tabs.active && (
                        <div id="active"><ActiveEmployeesTab userProfile={userProfile} pageParams={pageParams} /></div>
                    )}
                    
                    {tabs.salaryReport && (
                        <div id="salaryReport"><SalaryReviseReportTab userProfile={userProfile} /></div>
                    )}
                    
                    {tabs.former && (
                        <div id="former"><FormerEmployeesTab userProfile={userProfile} /></div>
                    )}
                </TabbedPage>
            );
        };
        // --- END EMPLOYEES PAGE COMPONENTS ---
        
        // --- START SAVINGS PROGRAM PAGE COMPONENTS (NEW) ---
        
        // NEW: Modal to Add/Edit Salary Saving Program Participants
        // MODIFIED (STEP 4): Added 'allSavings' prop
        const AddSalarySavingModal = ({ isOpen, onClose, onSave, participant, userProfile, allEmployees, allSavings }) => {
            const { shops } = useAppData();
            const [selectedShop, setSelectedShop] = useState('');
            const [selectedEmployeeId, setSelectedEmployeeId] = useState('');
            const [savingsPercentage, setSavingsPercentage] = useState(0);
            const [joinDate, setJoinDate] = useState('');
            const [effectiveMonth, setEffectiveMonth] = useState('');
            // --- NEW: State for participant status ---
            const [savingsProgramStatus, setSavingsProgramStatus] = useState('Active');
            // --- NEW: State for Current Balance (Total Accumulated Savings) ---
            const [currentBalance, setCurrentBalance] = useState(0);
        
            useEffect(() => {
                if (participant) {
                    // EDIT MODE
                    const participantShop = Array.isArray(participant.shop) ? participant.shop[0] : participant.shop;
                    setSelectedShop(participantShop || '');
                    setSelectedEmployeeId(participant.id);
                    setSavingsPercentage(participant.savingsPercentage || 0);
                    setJoinDate(participant.savingsJoinDate || '');
                    setEffectiveMonth(participant.savingsEffectiveMonth || '');
                    // --- NEW: Load existing status in edit mode ---
                    setSavingsProgramStatus(participant.savingsProgramStatus || 'Active');
                    // --- NEW: Load existing balance ---
                    setCurrentBalance(participant.savingsBalance || 0);
                } else {
                    // ADD MODE - Reset form
                    setSelectedShop('');
                    setSelectedEmployeeId('');
                    setSavingsPercentage(0);
                    const today = new Date().toISOString().slice(0, 10);
                    const currentMonth = new Date().toISOString().slice(0, 7);
                    setJoinDate(today);
                    setEffectiveMonth(currentMonth);
                    // --- NEW: Default status for new participants ---
                    setSavingsProgramStatus('Active');
                    setCurrentBalance(0);
                }
            }, [participant, isOpen]);
        
            // OPTIMIZATION: Use the new hook
            const availableShops = useAllowedShops(userProfile, shops);
            
            const availableEmployees = useMemo(() => {
                if (!selectedShop) return [];
                const enrolledIds = new Set(
                    (allSavings || [])
                        .filter(s => s.savingsProgramStatus === 'Active')
                        .map(s => s.id)
                );
                
                return allEmployees.filter(emp => {
                    const isInShop = Array.isArray(emp.shop) ? emp.shop.includes(selectedShop) : emp.shop === selectedShop;
                    const isNotEnrolled = !enrolledIds.has(emp.id);
                    return emp.status === 'Active' && isInShop && (isNotEnrolled || emp.id === participant?.id);
                });
            }, [selectedShop, allEmployees, participant, allSavings]);
        
            const handleSubmit = (e) => {
                e.preventDefault();
                if (!selectedEmployeeId || isNaN(savingsPercentage) || savingsPercentage <= 0 || !joinDate || !effectiveMonth) {
                    alert("Please fill all required fields, including a savings percentage greater than 0.");
                    return;
                }
                // MODIFIED: Pass currentBalance and existing withdrawals to save handler
                onSave(
                    selectedEmployeeId, 
                    savingsPercentage || 0, 
                    joinDate, 
                    effectiveMonth, 
                    !!participant, 
                    savingsProgramStatus, 
                    parseFloat(currentBalance), // New Balance
                    participant ? (participant.mySavingWithdrawalTotal || 0) : 0 // Existing Withdrawals (needed for credit calc)
                );
            };

            // NEW: Permission check for balance editing
            const canEditBalance = userProfile?.role === 'Admin' || userProfile?.role === 'CEO';
        
            return (
                <Modal isOpen={isOpen} onClose={onClose} maxWidth="max-w-xl">
                    <form onSubmit={handleSubmit} className="flex flex-col h-full overflow-hidden">
                        <ModalHeader title={participant ? "Edit Savings Participant" : "Add to Savings Program"} onClose={onClose} />
                        <ModalBody>
                            <div className="space-y-4">
                                <div>
                                    <label className="text-sm font-medium text-slate-400"><i className="fas fa-store mr-2 text-cyan-400"></i>Shop</label>
                                    <select value={selectedShop} onChange={e => setSelectedShop(e.target.value)} className="select" disabled={!!participant}>
                                        <option value="">Select Shop</option>
                                        {availableShops.map(s => <option key={s.id} value={s.name}>{s.name}</option>)}
                                    </select>
                                </div>
                                <div>
                                    <label className="text-sm font-medium text-slate-400"><i className="fas fa-user mr-2 text-emerald-400"></i>Employee</label>
                                    <select value={selectedEmployeeId} onChange={e => setSelectedEmployeeId(e.target.value)} className="select" disabled={!selectedShop || !!participant}>
                                        <option value="">Select Employee</option>
                                        {availableEmployees.map(e => <option key={e.id} value={e.id}>{e.name}</option>)}
                                    </select>
                                </div>
                                
                                {/* --- NEW: Editable Current Balance Field (Restricted) --- */}
                                <div>
                                    <label className="text-sm font-medium text-slate-400"><i className="fas fa-wallet mr-2 text-green-400"></i>Total Accumulated Savings (KHR)</label>
                                    <input
                                        type="number"
                                        value={currentBalance}
                                        onChange={e => setCurrentBalance(e.target.value)}
                                        className={`input font-bold text-green-400 bg-slate-700/50 border-slate-600 focus:border-green-500 ${!canEditBalance ? 'opacity-60 cursor-not-allowed' : ''}`}
                                        placeholder="0"
                                        disabled={!canEditBalance} // FIX: Disable for non-admins
                                    />
                                    {canEditBalance ? (
                                        <p className="text-[10px] text-slate-500 mt-1">
                                            <i className="fas fa-info-circle mr-1"></i> You can manually adjust this value if needed.
                                        </p>
                                    ) : (
                                        <p className="text-[10px] text-slate-500 mt-1">
                                            <i className="fas fa-lock mr-1"></i> Contact Admin to adjust balance manually.
                                        </p>
                                    )}
                                </div>

                                <div className="grid grid-cols-2 gap-4">
                                    <div>
                                        <label className="text-sm font-medium text-slate-400"><i className="fas fa-percent mr-2 text-purple-400"></i>Percentage (%)</label>
                                        <input
                                            type="number"
                                            value={isNaN(savingsPercentage) ? '' : savingsPercentage}
                                            onChange={e => setSavingsPercentage(parseFloat(e.target.value))}
                                            className="input"
                                            min="0"
                                            max="100"
                                            placeholder="e.g., 5"
                                            required
                                        />
                                    </div>
                                    <div>
                                        <label className="text-sm font-medium text-slate-400"><i className="fas fa-calendar-plus mr-2 text-blue-400"></i>Join Date</label>
                                        <input
                                            type="date"
                                            value={joinDate}
                                            onChange={e => setJoinDate(e.target.value)}
                                            className="input"
                                            required
                                        />
                                    </div>
                                </div>

                                <div>
                                    <label className="text-sm font-medium text-slate-400"><i className="fas fa-calendar-alt mr-2 text-orange-400"></i>Effective Month</label>
                                    <input
                                        type="month"
                                        value={effectiveMonth}
                                        onChange={e => setEffectiveMonth(e.target.value)}
                                        className="input"
                                        required
                                    />
                                </div>
                                {participant && (
                                    <div>
                                        <label className="text-sm font-medium text-slate-400"><i className="fas fa-info-circle mr-2 text-yellow-400"></i>Status</label>
                                        <select
                                            name="status"
                                            value={savingsProgramStatus}
                                            onChange={e => setSavingsProgramStatus(e.target.value)}
                                            className={`select ${
                                                savingsProgramStatus === 'Active' ? 'text-green-400' :
                                                savingsProgramStatus === 'Paused' ? 'text-yellow-400' :
                                                'text-red-400'
                                            }`}
                                            required
                                        >
                                            <option value="Active">Active</option>
                                            <option value="Paused">Paused</option>
                                            <option value="Inactive">Inactive</option>
                                        </select>
                                    </div>
                                )}
                            </div>
                        </ModalBody>
                        <ModalFooter>
                            <Button variant="secondary" onClick={onClose}>Cancel</Button>
                            <Button 
                                type="submit" 
                                variant="primary"
                                disabled={!selectedEmployeeId || isNaN(savingsPercentage) || savingsPercentage <= 0 || !joinDate || !effectiveMonth}
                            >
                                {participant ? "Update" : "Save Participant"}
                            </Button>
                        </ModalFooter>
                    </form>
                </Modal>
            );
        };

        // NEW: Modal for processing a savings payback
        const PaybackModal = ({ isOpen, onClose, onSave, participant }) => {
            const [amount, setAmount] = useState(0); 
            const [note, setNote] = useState('');
            const [error, setError] = useState('');
            const [selectedPercentage, setSelectedPercentage] = useState(null); 

            useEffect(() => {
                if (isOpen) {
                    setAmount(0);
                    setNote('');
                    setError('');
                    setSelectedPercentage(null); 
                }
            }, [isOpen]);
            
            // NEW: Handler for percentage buttons
            const handlePercentageClick = (percentage) => {
                if (!participant) return;
                const paybackAmount = Math.round((participant.savingsBalance || 0) * (percentage / 100));
                setAmount(paybackAmount);
                setSelectedPercentage(percentage);
                setError('');
            };

            const handleSubmit = (e) => {
                e.preventDefault();
                const paybackAmount = parseFloat(amount);
                
                if (isNaN(paybackAmount) || paybackAmount <= 0) { 
                    setError('Please select a valid payback percentage.');
                    return;
                }
                if (paybackAmount > participant.savingsBalance) {
                    setError('Payback amount cannot exceed the total savings.');
                    return;
                }
                onSave(participant.id, paybackAmount, note);
            };

            if (!participant) return null;

            return (
                <Modal isOpen={isOpen} onClose={onClose} maxWidth="max-w-md">
                    {/* FIX: Added flex layout class */}
                    <form onSubmit={handleSubmit} className="flex flex-col h-full overflow-hidden">
                        <ModalHeader title="Process Savings Payback" onClose={onClose} />
                        <ModalBody>
                            <div className="space-y-4">
                                <div>
                                    <label className="text-sm font-medium text-slate-400"><i className="fas fa-user mr-2 text-slate-400"></i>Employee</label>
                                    <input value={participant.name} className="input" disabled />
                                </div>
                                <div>
                                    <label className="text-sm font-medium text-slate-400"><i className="fas fa-wallet mr-2 text-green-400"></i>Current Balance</label>
                                    <input value={Utils.formatCurrency(participant.savingsBalance)} className="input" disabled />
                                </div>
                                
                                <div>
                                    <label className="text-sm font-medium text-slate-400"><i className="fas fa-percent mr-2 text-blue-400"></i>Payback Percentage</label>
                                    <div className="grid grid-cols-4 gap-2 mt-1">
                                        {[25, 50, 75, 100].map(pct => (
                                            <button
                                                key={pct}
                                                type="button"
                                                onClick={() => handlePercentageClick(pct)}
                                                className={`py-2 text-sm font-medium rounded border transition-colors ${
                                                    selectedPercentage === pct
                                                        ? 'bg-blue-600 border-blue-600 text-white'
                                                        : 'bg-slate-700 border-slate-600 text-slate-300 hover:bg-slate-600'
                                                }`}
                                            >
                                                {pct}%
                                            </button>
                                        ))}
                                    </div>
                                </div>

                                <div>
                                    <label className="text-sm font-medium text-slate-400"><i className="fas fa-coins mr-2 text-yellow-400"></i>Calculated Amount (KHR)</label>
                                    <input
                                        type="text"
                                        value={Utils.formatCurrency(amount)}
                                        className="input"
                                        disabled
                                    />
                                </div>

                                <div>
                                    <label className="text-sm font-medium text-slate-400"><i className="fas fa-sticky-note mr-2 text-slate-400"></i>Note (Optional)</label>
                                    <input
                                        type="text"
                                        value={note}
                                        onChange={(e) => setNote(e.target.value)}
                                        className="input"
                                        placeholder="e.g., Resignation payout"
                                    />
                                </div>
                                {error && <p className="text-sm text-red-400">{error}</p>}
                            </div>
                        </ModalBody>
                        <ModalFooter>
                            <Button variant="secondary" onClick={onClose}>Cancel</Button>
                            <Button 
                                type="submit" 
                                variant="primary"
                                disabled={!amount || parseFloat(amount) <= 0}
                            >
                                Confirm Payback
                            </Button>
                        </ModalFooter>
                    </form>
                </Modal>
            );
        };

        // NEW: Modal for processing a savings deposit (Cash on Hand)
        const DepositModal = ({ isOpen, onClose, onSave, participant }) => {
            const [amount, setAmount] = useState('');
            const [note, setNote] = useState('');
            const [date, setDate] = useState(''); // NEW: Date state
            const [error, setError] = useState('');
            const [isSubmitting, setIsSubmitting] = useState(false); // NEW: Loading state

            useEffect(() => {
                if (isOpen) {
                    setAmount('');
                    setNote('Cash Deposit');
                    setDate(new Date().toISOString().slice(0, 10)); // Default to today
                    setError('');
                    setIsSubmitting(false); // Reset loading state
                }
            }, [isOpen]);

            // NEW: Calculate projected total
            const currentBalance = participant?.savingsBalance || 0;
            const depositAmountValue = parseFloat(amount) || 0;
            const projectedTotal = currentBalance + depositAmountValue;

            const handleSubmit = async (e) => { // Made async
                e.preventDefault();
                const depositAmount = parseFloat(amount);
                
                if (isNaN(depositAmount) || depositAmount <= 0) { 
                    setError('Please enter a valid positive amount.');
                    return;
                }

                setIsSubmitting(true); // Start loading
                
                // Await the result to know if we should reset loading or if modal will close
                // MODIFIED: Pass date to onSave
                const success = await onSave(participant.id, depositAmount, note, date);
                
                if (!success) {
                    setIsSubmitting(false); // Only reset if failed (modal stays open)
                }
                // If success, parent component will close the modal, so we don't need to do anything.
            };

            if (!participant) return null;

            return (
                <Modal isOpen={isOpen} onClose={onClose} maxWidth="max-w-md">
                    {/* FIX: Added flex layout class */}
                    <form onSubmit={handleSubmit} className="flex flex-col h-full overflow-hidden">
                        <ModalHeader title="Deposit Cash to Savings" onClose={onClose} />
                        <ModalBody>
                            <div className="space-y-4">
                                <div>
                                    <label className="text-sm font-medium text-slate-400"><i className="fas fa-user mr-2 text-slate-400"></i>Employee</label>
                                    <input value={participant.name} className="input" disabled />
                                </div>
                                <div className="grid grid-cols-2 gap-4">
                                    <div>
                                        <label className="text-sm font-medium text-slate-400"><i className="fas fa-wallet mr-2 text-slate-400"></i>Current Balance</label>
                                        <input value={Utils.formatCurrency(currentBalance)} className="input" disabled />
                                    </div>
                                    {/* NEW: Date Input */}
                                    <div>
                                        <label className="text-sm font-medium text-slate-400"><i className="fas fa-calendar-day mr-2 text-blue-400"></i>Date</label>
                                        <input 
                                            type="date" 
                                            value={date} 
                                            onChange={(e) => setDate(e.target.value)} 
                                            className="input" 
                                            required 
                                            disabled={isSubmitting}
                                        />
                                    </div>
                                </div>
                                
                                <div>
                                    <label className="text-sm font-medium text-slate-400"><i className="fas fa-money-bill-wave mr-2 text-green-400"></i>Deposit Amount (KHR)</label>
                                    <input
                                        type="number"
                                        value={amount}
                                        onChange={(e) => setAmount(e.target.value)}
                                        className="input font-bold text-green-400"
                                        placeholder="Enter amount"
                                        required
                                        min="100"
                                        disabled={isSubmitting} // Disable while submitting
                                    />
                                </div>

                                {/* NEW: Total Calculation Display */}
                                <div>
                                    <label className="text-sm font-medium text-slate-400"><i className="fas fa-calculator mr-2 text-blue-400"></i>Total (Current + Deposit)</label>
                                    <input 
                                        value={Utils.formatCurrency(projectedTotal)} 
                                        className="input font-bold text-blue-400 bg-slate-800" 
                                        disabled 
                                    />
                                </div>

                                <div>
                                    <label className="text-sm font-medium text-slate-400"><i className="fas fa-sticky-note mr-2 text-slate-400"></i>Note (Optional)</label>
                                    <input
                                        type="text"
                                        value={note}
                                        onChange={(e) => setNote(e.target.value)}
                                        className="input"
                                        placeholder="e.g., Cash from employee"
                                        disabled={isSubmitting}
                                    />
                                </div>
                                {error && <p className="text-sm text-red-400">{error}</p>}
                            </div>
                        </ModalBody>
                        <ModalFooter>
                            <Button variant="secondary" onClick={onClose} disabled={isSubmitting}>Cancel</Button>
                            <Button 
                                type="submit" 
                                variant="success" 
                                disabled={!amount || parseFloat(amount) <= 0 || !date || isSubmitting}
                            >
                                {isSubmitting ? <><i className="fas fa-spinner fa-spin"></i> Processing...</> : 'Confirm Deposit'}
                            </Button>
                        </ModalFooter>
                    </form>
                </Modal>
            );
        };

        // --- FIX: ADDED MISSING SavingsHistoryModal COMPONENT ---
        const SavingsHistoryModal = ({ isOpen, onClose, employeeName, transactions }) => {
            if (!isOpen) return null;

            return (
                <Modal isOpen={isOpen} onClose={onClose} maxWidth="max-w-2xl">
                    <ModalHeader title={`Savings History: ${employeeName}`} onClose={onClose} />
                    <ModalBody>
                        {(!transactions || transactions.length === 0) ? (
                            <p className="text-center text-slate-400 py-4">No transactions found.</p>
                        ) : (
                            <div className="overflow-x-auto">
                                <table className="min-w-full divide-y divide-slate-700">
                                    <thead className="bg-slate-900/50">
                                        <tr>
                                            <th className="px-4 py-2 text-left text-xs font-semibold text-slate-400 uppercase">Date</th>
                                            <th className="px-4 py-2 text-left text-xs font-semibold text-slate-400 uppercase">Type</th>
                                            <th className="px-4 py-2 text-right text-xs font-semibold text-slate-400 uppercase">Amount</th>
                                            <th className="px-4 py-2 text-left text-xs font-semibold text-slate-400 uppercase">Note</th>
                                        </tr>
                                    </thead>
                                    <tbody className="divide-y divide-slate-700">
                                        {transactions.map((tx) => (
                                            <tr key={tx.id} className="hover:bg-slate-700/30">
                                                <td className="px-4 py-2 text-sm text-slate-300">{Utils.formatRequestDate(tx.date)}</td>
                                                <td className="px-4 py-2 text-sm">
                                                    <span className={`px-2 py-0.5 text-xs rounded-full ${
                                                        tx.type === 'contribution' ? 'bg-green-900 text-green-300' : 'bg-red-900 text-red-300'
                                                    }`}>
                                                        {tx.type === 'contribution' ? 'Deposit' : 'Withdrawal'}
                                                    </span>
                                                </td>
                                                <td className={`px-4 py-2 text-sm text-right font-medium ${
                                                    tx.type === 'contribution' ? 'text-green-400' : 'text-red-400'
                                                }`}>
                                                    {Utils.formatCurrency(tx.amountDeducted || tx.amountWithdrawn)}
                                                </td>
                                                <td className="px-4 py-2 text-sm text-slate-400">{tx.note || tx.payrollId || '-'}</td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </div>
                        )}
                    </ModalBody>
                    <ModalFooter>
                        <Button variant="secondary" onClick={onClose}>Close</Button>
                    </ModalFooter>
                </Modal>
            );
        };

        // MOVED & RENAMED: from SalarySavingTab to ParticipantsTab
        // MODIFIED (STEP 4): This component is heavily refactored to use the new '/savingprogram' collection.
        const ParticipantsTab = ({ userProfile }) => {
            // MODIFIED: Added 'auth'
            const { db, auth } = useFirebase();
            // MODIFIED (STEP 4): Added setDoc and deleteField AND serverTimestamp (Fixing the error)
            const { doc, updateDoc, where, setDoc, deleteField, serverTimestamp } = window.firebaseSDK;
            const { employees, shops } = useAppData();
            
            const [selectedShop, setSelectedShop] = useState('');
            const [searchTerm, setSearchTerm] = useState('');
            
            // --- NEW: State for the sub-tabs (Active vs Inactive) ---
            const [listTab, setListTab] = useState('active');

            // --- OPTIMIZATION: Only fetch the data needed for the current tab ---
            // If tab is 'active', fetch 'Active' and 'Paused'. 
            // If tab is 'inactive', fetch 'Inactive'.
            // This prevents downloading hundreds of old inactive records on page load.
            const savingsQueryConstraints = useMemo(() => {
                if (listTab === 'active') {
                    return [where('savingsProgramStatus', 'in', ['Active', 'Paused'])];
                } else {
                    return [where('savingsProgramStatus', '==', 'Inactive')];
                }
            }, [listTab]);

            // MODIFIED: Pass constraints to useCollection
            const { data: savingsList } = useCollection('savingprogram', savingsQueryConstraints);
            
            const [isSavingModalOpen, setIsSavingModalOpen] = useState(false);
            const [editingParticipant, setEditingParticipant] = useState(null);
            const [participantToRemove, setParticipantToRemove] = useState(null);
            const [paybackParticipant, setPaybackParticipant] = useState(null);
            const [depositParticipant, setDepositParticipant] = useState(null); // NEW: State for deposit modal
            const [historyParticipant, setHistoryParticipant] = useState(null);
            const [participantForPaybackConfirmation, setParticipantForPaybackConfirmation] = useState(null);

            // MODIFIED (STEP 6.B): Replaced 'useCollection' with a 'useEffect'
            // to listen to the new dynamic subcollection path.
            const [transactionHistory, setTransactionHistory] = useState([]);
            useEffect(() => {
                if (!db || !historyParticipant) {
                    setTransactionHistory([]);
                    return;
                }
                
                const { collection, onSnapshot, orderBy, query } = window.firebaseSDK;
                const collectionRef = collection(db, 'savingprogram', historyParticipant.id, 'transactions');
                const q = query(collectionRef, orderBy('date', 'desc')); // Order by date descending

                const unsubscribe = onSnapshot(q, (snapshot) => {
                    const history = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    setTransactionHistory(history);
                }, (error) => {
                    console.error("Error fetching transaction history:", error);
                    setTransactionHistory([]);
                });

                // Clean up the listener when the modal is closed or participant changes
                return () => unsubscribe();
            }, [db, historyParticipant]); // Re-run when the selected participant changes

            const handleOpenSavingModal = (participant = null) => {
                setEditingParticipant(participant);
                setIsSavingModalOpen(true);
            };

            const handleCloseSavingModal = () => {
                setEditingParticipant(null);
                setIsSavingModalOpen(false);
            };

            // MODIFIED (STEP 4): This function now writes to '/savingprogram' and cleans up '/employees'.
            // MODIFIED (Bug Fix): Added 'isEdit' flag to correctly initialize balance for new participants.
            // MODIFIED (User Request): Added 'status' parameter
            // MODIFIED (Latest Request): Added 'newBalance' and 'existingWithdrawals' for manual balance updates
            const handleSaveParticipant = async (employeeId, percentage, joinDate, effectiveMonth, isEdit, status, newBalance = 0, existingWithdrawals = 0) => {
                if (!employeeId || !db) return;
                
                // Find the employee to get their name and shop for denormalization
                const employee = employees.find(e => e.id === employeeId);
                if (!employee) {
                    alert("Could not find employee data.");
                    return;
                }
                
                try {
                    const savingsDocRef = doc(db, 'savingprogram', employeeId);
                    
                    // --- NEW LOGIC: Recalculate Credit based on manually edited Balance ---
                    // Integrity Rule: Credit = Current Balance + Total Withdrawals
                    const calculatedCredit = parseFloat(newBalance) + parseFloat(existingWithdrawals);

                    const newData = {
                        employeeId: employeeId,
                        employeeName: employee.name,
                        shop: Array.isArray(employee.shop) ? employee.shop[0] : employee.shop,
                        savingsProgramStatus: status || 'Active',
                        savingsPercentage: percentage,
                        savingsJoinDate: joinDate,
                        savingsEffectiveMonth: effectiveMonth,
                        // --- UPDATE BALANCE FIELDS ---
                        currentBalance: parseFloat(newBalance),
                        mySavingCredit: calculatedCredit,
                        lastUpdated: serverTimestamp()
                    };

                    // FIX: If this is a NEW participant (not an edit), initialize withdrawal total
                    if (!isEdit) {
                        newData.mySavingWithdrawalTotal = 0;
                    }

                    // Use { merge: true }
                    await setDoc(savingsDocRef, newData, { merge: true }); 

                    // 2. Remove the deprecated fields from the '/employees' document
                    const employeeRef = doc(db, 'employees', employeeId);
                    await updateDoc(employeeRef, {
                        savingsProgramStatus: deleteField(),
                        savingsPercentage: deleteField(),
                        savingsJoinDate: deleteField(),
                        savingsEffectiveMonth: deleteField()
                    });
                    
                    // --- NEW: Log the activity ---
                    const action = isEdit ? 'Edit Savings Participant' : 'Add Savings Participant';
                    Utils.logUserActivity(db, auth, action, {
                        id: employeeId,
                        name: employee.name,
                        updatedData: newData
                    });
                    
                    handleCloseSavingModal();
                } catch (error) {
                    console.error("Error saving participant:", error);
                    alert("Failed to save participant.");
                }
            };
            
            // MODIFIED (STEP 4): This function now updates the '/savingprogram' collection.
            const handleConfirmRemove = async () => {
                if (!participantToRemove || !db) return;
                try {
                    // Update the '/savingprogram' doc instead of the '/employees' doc
                    const savingsDocRef = doc(db, 'savingprogram', participantToRemove.id);
                    await updateDoc(savingsDocRef, {
                        savingsProgramStatus: 'Inactive',
                        savingsPercentage: 0
                    });

                    // --- NEW: Log the activity ---
                    Utils.logUserActivity(db, auth, 'Remove Savings Participant', {
                        id: participantToRemove.id,
                        name: participantToRemove.name,
                        originalData: participantToRemove,
                        updatedData: { ...participantToRemove, savingsProgramStatus: 'Inactive', savingsPercentage: 0 }
                    });
                    // --- END LOGGING ---

                    setParticipantToRemove(null);
                } catch (error) {
                    console.error("Error removing participant:", error);
                    alert("Failed to remove participant.");
                }
            };
            
            const handleStartPaybackProcess = () => {
                if (!participantForPaybackConfirmation) return;
                setPaybackParticipant(participantForPaybackConfirmation);
                setParticipantForPaybackConfirmation(null);
            };
            
            // MODIFIED (STEP 4): This function now passes the required 'employeeName' and 'shop'
            // to match the new signature of Utils.manageSavingsWithdrawal.
            const handleProcessPayback = async (employeeId, amount, note) => {
                if (!paybackParticipant) {
                    alert("Error: No participant selected for payback.");
                    return;
                }
                
                const participantShop = Array.isArray(paybackParticipant.shop) ? paybackParticipant.shop[0] : paybackParticipant.shop;
                
                const result = await Utils.manageSavingsWithdrawal(
                    db, 
                    employeeId, 
                    paybackParticipant.name, // Pass Employee Name
                    participantShop, // Pass Shop
                    amount, 
                    note
                );
                
                if (result.success) {
                    alert("Payback processed successfully!");
                    setPaybackParticipant(null);
                } else {
                    alert(`Payback failed: ${result.error?.message || 'An unknown error occurred.'}`);
                }
            };

            // --- NEW: Handler for processing cash deposits ---
            // MODIFIED: Accepts 'date' parameter
            const handleProcessDeposit = async (employeeId, amount, note, date) => {
                // SECURITY CHECK: Ensure only Admin or CEO can perform this action
                if (userProfile.role !== 'Admin' && userProfile.role !== 'CEO') {
                    alert("Permission Denied: Only Administrators and CEOs can process cash deposits.");
                    return false; // Return failure
                }

                if (!depositParticipant) {
                    alert("Error: No participant selected for deposit.");
                    return false; // Return failure
                }
                
                const participantShop = Array.isArray(depositParticipant.shop) ? depositParticipant.shop[0] : depositParticipant.shop;
                
                // Reuse the existing contribution utility, passing the note and null for payrollId
                // MODIFIED: Pass 'date'
                const result = await Utils.manageSavingsContribution(
                    db,
                    employeeId,
                    depositParticipant.name,
                    participantShop,
                    amount,
                    null, // No payrollId for manual deposit
                    note,  // Pass the note
                    date   // Pass the custom date
                );
                
                if (result.success) {
                    alert("Cash deposit processed successfully!");
                    setDepositParticipant(null);
                    return true; // Return success
                } else {
                    alert(`Deposit failed: ${result.error?.message || 'An unknown error occurred.'}`);
                    return false; // Return failure
                }
            };

            useEffect(() => {
                if (userProfile && userProfile.role !== 'Admin' && userProfile.role !== 'CEO') {
                    setSelectedShop(Array.isArray(userProfile.shop) ? '' : userProfile.shop || '');
                }
            }, [userProfile]);
            
            const availableShops = useMemo(() => {
                // FIX: Cleaned up logic and added guard for userProfile
                if (!userProfile) return [];
                if (userProfile.role === 'Admin' || userProfile.role === 'CEO') return shops;
                if (userProfile.role === 'Shop Manager' && Array.isArray(userProfile.shop)) {
                    // Manager with multiple shops can filter by their assigned shops
                    return shops.filter(s => userProfile.shop.includes(s.name));
                }
                // Manager with one shop, or staff, don't get a filter dropdown.
                return [];
            }, [shops, userProfile]);

            // MODIFIED (STEP 4): This logic is completely rebuilt to use '/savingprogram'
            // as the source of truth for participants.
            const enrolledEmployees = useMemo(() => {
                // 1. Create a map of all employees from context for quick lookup
                const employeeMap = new Map((employees || []).map(e => [e.id, e]));

                // 2. Map over 'savingsList' (fetched based on active tab) and merge with employee data
                const enrolled = (savingsList || []).map(savingDoc => {
                    const employeeData = employeeMap.get(savingDoc.id);
                    // Use employeeData if available, but fallback to denormalized data
                    // in savingDoc just in case (e.g., for a resigned employee).
                    return {
                        ...employeeData, // Full employee record (includes 'status', 'position', etc.)
                        ...savingDoc,   // Full savings record (overwrites with fresher savings data)
                        id: savingDoc.id, // Ensure savingDoc.id is primary
                        name: employeeData?.name || savingDoc.employeeName,
                        shop: employeeData?.shop || savingDoc.shop, // Use employee's current shop
                        savingsBalance: savingDoc.currentBalance || 0
                    };
                });

                // 3. Apply role-based filtering
                const roleFiltered = enrolled.filter(emp => {
                    if (!userProfile) return false;
                    
                    if (userProfile.role === 'Admin' || userProfile.role === 'CEO') {
                        return true; // Admins/CEOs see everyone
                    }
                    if (userProfile.role === 'Shop Manager') {
                        const managedShops = Array.isArray(userProfile.shop) ? userProfile.shop : (userProfile.shop ? [userProfile.shop] : []);
                        const employeeShops = Array.isArray(emp.shop) ? emp.shop : (emp.shop ? [emp.shop] : []);
                        return employeeShops.some(s => managedShops.includes(s));
                    }
                    if (userProfile.role === 'Staff') {
                        return emp.id === userProfile.id; // Staff only see themselves
                    }
                    return false; // Default deny
                });

                // 4. Apply the UI filters (selectedShop dropdown and search term)
                const filtered = roleFiltered.filter(emp => 
                    (!selectedShop || (Array.isArray(emp.shop) ? emp.shop.includes(selectedShop) : emp.shop === selectedShop)) &&
                    (emp.name.toLowerCase().includes(searchTerm.toLowerCase()))
                );
                
                return filtered.sort((a,b) => a.name.localeCompare(b.name));
            }, [employees, savingsList, selectedShop, searchTerm, userProfile]); 

            // --- NEW: Filter by Active/Inactive Tab ---
            // NOTE: The 'savingsList' is ALREADY filtered by the database query based on 'listTab'.
            // However, we keep this secondary check for robust filtering in case of latency.
            const displayEmployees = useMemo(() => {
                return enrolledEmployees.filter(emp => {
                    const status = emp.savingsProgramStatus || 'Active'; // Default to Active if undefined
                    if (listTab === 'active') {
                        // Show Active and Paused in the first tab
                        return status === 'Active' || status === 'Paused';
                    } else {
                        // Show Inactive in the second tab
                        return status === 'Inactive';
                    }
                });
            }, [enrolledEmployees, listTab]);

            // MODIFIED: Calculate total savings based on the DISPLAYED list, not the full list.
            const totalSavings = useMemo(() => {
                return displayEmployees.reduce((sum, emp) => sum + emp.savingsBalance, 0);
            }, [displayEmployees]);

            const handleExportExcel = useCallback(() => {
                // MODIFIED: Export only displayed employees
                const dataToExport = displayEmployees.map(emp => ({ 
                    'Name': emp.name,
                    'Shop': Array.isArray(emp.shop) ? emp.shop.join(', ') : emp.shop,
                    'Status': emp.savingsProgramStatus,
                    'Savings Percentage (%)': emp.savingsPercentage,
                    'Total Accumulated Savings (KHR)': emp.savingsBalance
                }));
                const worksheet = XLSX.utils.json_to_sheet(dataToExport);
                const workbook = XLSX.utils.book_new();
                const sheetName = listTab === 'active' ? "Active Savings" : "Inactive Savings";
                XLSX.utils.book_append_sheet(workbook, worksheet, sheetName);
                worksheet["!cols"] = [ { wch: 25 }, { wch: 20 }, { wch: 10 }, { wch: 25 }, { wch: 30 } ];
                XLSX.writeFile(workbook, `Salary_Savings_Report_${listTab}.xlsx`);
            }, [displayEmployees, listTab]);

            return (
                <Card>
                    {/* --- NEW: Tab Navigation for Active / Inactive Lists --- */}
                    <div className="flex space-x-6 border-b border-slate-700 mb-6">
                        <button
                            className={`pb-3 text-sm font-medium transition-colors border-b-2 ${
                                listTab === 'active' 
                                    ? 'border-blue-500 text-blue-400' 
                                    : 'border-transparent text-slate-400 hover:text-slate-200 hover:border-slate-600'
                            }`}
                            onClick={() => setListTab('active')}
                        >
                            Active Participants
                        </button>
                        <button
                            className={`pb-3 text-sm font-medium transition-colors border-b-2 ${
                                listTab === 'inactive' 
                                    ? 'border-blue-500 text-blue-400' 
                                    : 'border-transparent text-slate-400 hover:text-slate-200 hover:border-slate-600'
                            }`}
                            onClick={() => setListTab('inactive')}
                        >
                            Inactive / Removed
                        </button>
                    </div>

                    <div className="flex flex-wrap gap-4 justify-between items-center mb-6">
                        <h3 className="text-xl font-semibold text-slate-100">Salary Saving Program Participants</h3>
                        <div className="flex flex-wrap gap-4 items-center">
                            <input 
                                type="text" 
                                placeholder="Search by name..." 
                                value={searchTerm} 
                                onChange={e => setSearchTerm(e.target.value)} 
                                className="input w-full sm:w-auto" 
                            />
                            {(userProfile?.role === 'Admin' || userProfile?.role === 'CEO' || (userProfile?.role === 'Shop Manager' && Array.isArray(userProfile.shop))) && (
                                <select value={selectedShop} onChange={e => setSelectedShop(e.target.value)} className="select w-full sm:w-auto">
                                    <option value="">{userProfile.role === 'Admin' || userProfile.role === 'CEO' ? 'All Shops' : 'All My Shops'}</option>
                                    {availableShops.map(s => <option key={s.id} value={s.name}>{s.name}</option>)}
                                </select>
                            )}
                             {(userProfile?.role === 'Admin' || userProfile?.role === 'CEO' || userProfile?.role === 'Shop Manager') && (
                                <Button variant="primary" icon="fa-plus" onClick={() => handleOpenSavingModal()}>Add Participant</Button>
                            )}
                            <Button variant="success" icon="fa-file-excel" onClick={handleExportExcel}>Excel</Button>
                        </div>
                    </div>
                    <div className="overflow-x-auto">
                        <table className="min-w-full divide-y divide-slate-700">
                            <thead className="bg-slate-900/50">
                                <tr>
                                    <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Staff Name</th>
                                    <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Shop</th>
                                    <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Join Date</th>
                                    <th className="px-4 py-3 text-center text-xs font-semibold text-slate-400 uppercase">Savings Percentage</th>
                                    <th className="px-4 py-3 text-center text-xs font-semibold text-slate-400 uppercase">Effective Month</th>
                                    
                                    {/* NEW: Added Status column header */}
                                    <th className="px-4 py-3 text-center text-xs font-semibold text-slate-400 uppercase">Status</th>

                                    {/* MODIFIED: Removed 'My Saving Credit' to prevent duplication */}
                                    {/* <th className="px-4 py-3 text-right text-xs font-semibold text-slate-400 uppercase">My Saving Credit</th> */}
                                    
                                    {/* NEW: Added 'Total Withdrawals' for clarity */}
                                    <th className="px-4 py-3 text-right text-xs font-semibold text-slate-400 uppercase">Total Withdrawals</th>
                                    
                                    <th className="px-4 py-3 text-right text-xs font-semibold text-slate-400 uppercase">Total Accumulated Savings</th>
                                    {(userProfile?.role === 'Admin' || userProfile?.role === 'CEO' || userProfile?.role === 'Shop Manager') && (
                                        <th className="px-4 py-3 text-center text-xs font-semibold text-slate-400 uppercase">Actions</th>
                                    )}
                                </tr>
                            </thead>
                            <tbody className="divide-y divide-slate-700">
                                {/* MODIFIED: Map over displayEmployees instead of enrolledEmployees */}
                                {displayEmployees.map(emp => (
                                    <tr key={emp.id} className="hover:bg-slate-700/50">
                                        <td className="px-4 py-4 text-sm text-slate-200">{emp.name}</td>
                                        <td className="px-4 py-4 text-sm text-slate-300">{Array.isArray(emp.shop) ? emp.shop.join(', ') : emp.shop}</td>
                                        <td className="px-4 py-4 text-sm text-slate-300">{Utils.formatISOToDisplay(emp.savingsJoinDate)}</td>
                                        <td className="px-4 py-4 text-sm text-slate-300 text-center">{emp.savingsPercentage}%</td>
                                        <td className="px-4 py-4 text-sm text-slate-300 text-center">{emp.savingsEffectiveMonth}</td>
                                        
                                        {/* NEW: Added Status column data cell */}
                                        <td className="px-4 py-4 text-center text-sm">
                                            <span className={`px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${
                                                emp.savingsProgramStatus === 'Active' ? 'bg-green-100 text-green-800' :
                                                emp.savingsProgramStatus === 'Paused' ? 'bg-yellow-100 text-yellow-800' :
                                                'bg-slate-100 text-slate-800'
                                            }`}>
                                                {emp.savingsProgramStatus || 'N/A'}
                                            </span>
                                        </td>
                                        
                                        {/* NEW: Added 'Total Withdrawals' column data */}
                                        <td className="px-4 py-4 text-sm text-red-300 font-semibold text-right">{Utils.formatCurrency(emp.mySavingWithdrawalTotal)}</td>
                                        
                                        <td className="px-4 py-4 text-sm text-blue-300 font-semibold text-right">{Utils.formatCurrency(emp.savingsBalance)}</td>
                                        {(userProfile?.role === 'Admin' || userProfile?.role === 'CEO' || userProfile?.role === 'Shop Manager') && (
                                            <td className="px-4 py-4 text-center">
                                                <div className="flex items-center justify-center gap-2">
                                                    <Button variant="icon-view" icon="fa-history" onClick={() => setHistoryParticipant(emp)} title="View History"/>
                                                    
                                                    {/* NEW: Edit Button (Admin/CEO Only) */}
                                                    {(userProfile?.role === 'Admin' || userProfile?.role === 'CEO') && (
                                                        <Button variant="icon-edit" icon="fa-edit" onClick={() => handleOpenSavingModal(emp)} title="Edit Percentage/Status" />
                                                    )}

                                                    {/* NEW: Add Deposit Button for Cash on Hand - RESTRICTED TO ADMIN/CEO AND ACTIVE/PAUSED STATUS ONLY */}
                                                    {(userProfile?.role === 'Admin' || userProfile?.role === 'CEO') && emp.savingsProgramStatus !== 'Inactive' && (
                                                        <Button variant="icon-approve" icon="fa-circle-plus" onClick={() => setDepositParticipant(emp)} title="Deposit Cash" />
                                                    )}

                                                    {/* MODIFIED: Allow Payback for Active/Paused users ONLY. Hidden for Inactive/Removed. */}
                                                    {(userProfile?.role === 'Admin' || userProfile?.role === 'CEO') && emp.savingsProgramStatus !== 'Inactive' && (
                                                        <Button variant="icon-edit-alt" icon="fa-hand-holding-dollar" onClick={() => setParticipantForPaybackConfirmation(emp)} title="Process Payback" />
                                                    )}
                                                    {(userProfile?.role === 'Admin' || userProfile?.role === 'CEO' || userProfile?.role === 'Shop Manager') && (
                                                        <Button variant="icon-delete" icon="fa-trash" onClick={() => setParticipantToRemove(emp)} title="Remove" />
                                                    )}
                                                </div>
                                            </td>
                                        )}
                                        </tr>
                                    ))}
                                    {displayEmployees.length === 0 && (
                                        <tr><td colSpan="9" className="px-4 py-8 text-center text-slate-500">No participants found.</td></tr>
                                    )}
                                </tbody>
                            </table>
                        </div>

                        <AddSalarySavingModal 
                            isOpen={isSavingModalOpen} 
                            onClose={handleCloseSavingModal} 
                            onSave={handleSaveParticipant} 
                            participant={editingParticipant} 
                            userProfile={userProfile} 
                            allEmployees={employees} 
                            allSavings={savingsList}
                        />

                        <PaybackModal 
                            isOpen={!!paybackParticipant} 
                            onClose={() => setPaybackParticipant(null)} 
                            onSave={handleProcessPayback} 
                            participant={paybackParticipant} 
                        />

                        <DepositModal 
                            isOpen={!!depositParticipant} 
                            onClose={() => setDepositParticipant(null)} 
                            onSave={handleProcessDeposit} 
                            participant={depositParticipant} 
                        />

                        <SavingsHistoryModal 
                            isOpen={!!historyParticipant} 
                            onClose={() => setHistoryParticipant(null)} 
                            employeeName={historyParticipant?.name} 
                            transactions={transactionHistory}
                        />

                        <ConfirmationModal 
                            isOpen={!!participantToRemove} 
                            onClose={() => setParticipantToRemove(null)} 
                            onConfirm={handleConfirmRemove} 
                            title="Remove Participant" 
                            message={`Are you sure you want to remove ${participantToRemove?.name}? This will change their status to Inactive.`} 
                        />
                        
                        <ConfirmationModal
                            isOpen={!!participantForPaybackConfirmation}
                            onClose={() => setParticipantForPaybackConfirmation(null)}
                            onConfirm={handleStartPaybackProcess}
                            title="Initiate Payback"
                            message={`Do you want to process a payback (withdrawal) for ${participantForPaybackConfirmation?.name}? This will reduce their accumulated savings.`}
                        />
                    </Card>
                );
            };

        // --- NEW COMPONENT: KPI Scorecard Tab (Phase 2 - Interactive Drill Down) ---
        const KPIScorecardTab = ({ userProfile }) => {
            const { db } = useFirebase();
            // MODIFIED: Added 'employees' to destructuring to check status
            const { shops, employees } = useAppData();
            const { collection, query, where, getDocs } = window.firebaseSDK;

            // Filters
            const [filterMode, setFilterMode] = useState('monthly'); // 'monthly', 'quarterly', 'yearly'
            const [selectedMonth, setSelectedMonth] = useState(new Date().toISOString().slice(0, 7));
            const [selectedYear, setSelectedYear] = useState(new Date().getFullYear());
            const [selectedQuarter, setSelectedQuarter] = useState(Math.ceil((new Date().getMonth() + 1) / 3)); // 1-4

            const [selectedShop, setSelectedShop] = useState('');
            const [loading, setLoading] = useState(false);
            const [scorecardData, setScorecardData] = useState([]);
            
            // Phase 2: Drill Down State
            const [selectedStaff, setSelectedStaff] = useState(null); // The staff member clicked
            const [staffTasks, setStaffTasks] = useState([]); // The raw tasks for that staff

            // Available Shops for Filter
            const availableShops = useAllowedShops(userProfile, shops);

            // Year Options (Current -2 to +1)
            const yearOptions = useMemo(() => {
                const current = new Date().getFullYear();
                return [current - 2, current - 1, current, current + 1];
            }, []);

            // Set initial shop
            useEffect(() => {
                if (userProfile && userProfile.role !== 'Admin' && userProfile.role !== 'CEO') {
                    setSelectedShop(Array.isArray(userProfile.shop) ? '' : userProfile.shop || '');
                }
            }, [userProfile]);

            // Fetch & Calculate Data
            useEffect(() => {
                if (!db || !userProfile) return;

                const fetchData = async () => {
                    setLoading(true);
                    try {
                        // 1. Define Date Range based on Filter Mode
                        let startOfPeriod, endOfPeriod;

                        if (filterMode === 'monthly') {
                            const [y, m] = selectedMonth.split('-').map(Number);
                            startOfPeriod = new Date(y, m - 1, 1);
                            endOfPeriod = new Date(y, m, 0, 23, 59, 59, 999);
                        } else if (filterMode === 'quarterly') {
                            const q = Number(selectedQuarter);
                            const startMonthIndex = (q - 1) * 3; // 0 for Q1, 3 for Q2...
                            startOfPeriod = new Date(selectedYear, startMonthIndex, 1);
                            // End date is last day of the 3rd month in quarter
                            endOfPeriod = new Date(selectedYear, startMonthIndex + 3, 0, 23, 59, 59, 999);
                        } else if (filterMode === 'yearly') {
                            startOfPeriod = new Date(selectedYear, 0, 1);
                            endOfPeriod = new Date(selectedYear, 11, 31, 23, 59, 59, 999);
                        }

                        // 2. Build Query (Base: Date + Status)
                        // FIX: Move Shop Filtering to Client-Side to avoid complex Composite Index errors.
                        // This ensures the query works reliably with just the 'status + completedTimestamp' index.
                        let q = query(
                            collection(db, 'tasks'),
                            where('status', '==', 'done'),
                            where('completedTimestamp', '>=', startOfPeriod),
                            where('completedTimestamp', '<=', endOfPeriod)
                        );

                        const snapshot = await getDocs(q);
                        let tasks = snapshot.docs.map(d => d.data());

                        // 3. Client-Side Filtering (Robustness Fix)
                        if (selectedShop) {
                            tasks = tasks.filter(t => t.shopName === selectedShop);
                        } else if (userProfile.role === 'Shop Manager') {
                            const myShops = Array.isArray(userProfile.shop) ? userProfile.shop : [userProfile.shop];
                            // If manager has shops assigned, filter to only those.
                            if (myShops.length > 0) {
                                tasks = tasks.filter(t => myShops.includes(t.shopName));
                            } else {
                                tasks = []; // Manager with no shops sees nothing
                            }
                        } else if (userProfile.role === 'Staff') {
                            tasks = tasks.filter(t => t.staffId === userProfile.id);
                        }

                        // 4. Process Data: Group by Staff -> Group by KPI
                        const staffStats = {};

                        tasks.forEach(task => {
                            const staffId = task.staffId;
                            if (!staffId) return;

                            // NEW: Active Staff Filter
                            // If we have the employee list, check if this staff member is Active.
                            // If they are not found or not Active, skip their data.
                            if (employees) {
                                const emp = employees.find(e => e.id === staffId);
                                if (emp && emp.status !== 'Active') return;
                            }

                            if (!staffStats[staffId]) {
                                staffStats[staffId] = {
                                    id: staffId,
                                    name: task.staffName || 'Unknown',
                                    shop: task.shopName,
                                    totalTasks: 0,
                                    totalScoreSum: 0,
                                    rawTasks: [], // Store raw tasks for drill-down
                                    kpis: {} 
                                };
                            }

                            // Extract Score
                            let scoreVal = 0;
                            if (task.auditScore) {
                                const match = task.auditScore.match(/(\d+)%/);
                                if (match) scoreVal = parseInt(match[1], 10);
                            } else {
                                scoreVal = 100; // Default if approved without score
                            }

                            const stats = staffStats[staffId];
                            stats.totalTasks++;
                            stats.totalScoreSum += scoreVal;
                            stats.rawTasks.push({ ...task, numericScore: scoreVal });

                            // KPI Breakdown
                            const kpiName = task.kpiText || 'General';
                            if (!stats.kpis[kpiName]) {
                                stats.kpis[kpiName] = { sum: 0, count: 0 };
                            }
                            stats.kpis[kpiName].sum += scoreVal;
                            stats.kpis[kpiName].count++;
                        });

                        // 5. Calculate Final Averages
                        const results = Object.values(staffStats).map(staff => {
                            const overallAvg = Math.round(staff.totalScoreSum / staff.totalTasks);
                            
                            const kpiBreakdown = Object.entries(staff.kpis).map(([kpiName, data]) => ({
                                name: kpiName,
                                avg: Math.round(data.sum / data.count),
                                count: data.count
                            })).sort((a, b) => a.avg - b.avg);

                            return { ...staff, overallAvg, kpiBreakdown };
                        });

                        // Sort by Overall Average (High to Low)
                        results.sort((a, b) => b.overallAvg - a.overallAvg);

                        setScorecardData(results);

                    } catch (error) {
                        console.error("Error calculating scorecard:", error);
                    } finally {
                        setLoading(false);
                    }
                };

                fetchData();
            }, [db, userProfile, filterMode, selectedMonth, selectedYear, selectedQuarter, selectedShop]);

            const handleCardClick = (staff) => {
                setSelectedStaff(staff);
                setStaffTasks(staff.rawTasks.sort((a,b) => (b.completedTimestamp?.toDate() || 0) - (a.completedTimestamp?.toDate() || 0)));
            };

            const handleExportExcel = () => {
                const exportData = [];
                scorecardData.forEach(staff => {
                    const row = {
                        'Staff Name': staff.name,
                        'Shop': staff.shop,
                        'Total Tasks': staff.totalTasks,
                        'Overall Score (%)': staff.overallAvg
                    };
                    staff.kpiBreakdown.forEach(kpi => {
                        row[`KPI: ${kpi.name}`] = `${kpi.avg}% (${kpi.count})`;
                    });
                    exportData.push(row);
                });
                
                let filenameSuffix = "";
                if (filterMode === 'monthly') filenameSuffix = selectedMonth;
                else if (filterMode === 'quarterly') filenameSuffix = `${selectedYear}_Q${selectedQuarter}`;
                else filenameSuffix = `${selectedYear}_Yearly`;

                Utils.exportToExcel(exportData, "KPI Scorecard", `KPI_Scorecard_${filenameSuffix}.xlsx`);
            };

            return (
                <Card>
                    <PageHeader title="Performance Scorecard">
                        <div className="flex flex-wrap items-center gap-2">
                            {/* Shop Filter */}
                            <ShopFilterSelect 
                                userProfile={userProfile}
                                shops={shops}
                                selectedShop={selectedShop}
                                onChange={e => setSelectedShop(e.target.value)}
                            />

                            {/* Period Type Selector */}
                            <select 
                                value={filterMode} 
                                onChange={e => setFilterMode(e.target.value)} 
                                className="select w-auto font-medium"
                            >
                                <option value="monthly">Monthly</option>
                                <option value="quarterly">Quarterly</option>
                                <option value="yearly">Yearly</option>
                            </select>

                            {/* Monthly View Controls */}
                            {filterMode === 'monthly' && (
                                <input type="month" value={selectedMonth} onChange={e => setSelectedMonth(e.target.value)} className="input w-auto" />
                            )}

                            {/* Quarterly/Yearly View Controls */}
                            {(filterMode === 'quarterly' || filterMode === 'yearly') && (
                                <select value={selectedYear} onChange={e => setSelectedYear(Number(e.target.value))} className="select w-auto">
                                    {yearOptions.map(y => <option key={y} value={y}>{y}</option>)}
                                </select>
                            )}

                            {/* Quarterly View Quarter Selector */}
                            {filterMode === 'quarterly' && (
                                <select value={selectedQuarter} onChange={e => setSelectedQuarter(Number(e.target.value))} className="select w-auto">
                                    <option value="1">Q1 (Jan-Mar)</option>
                                    <option value="2">Q2 (Apr-Jun)</option>
                                    <option value="3">Q3 (Jul-Sep)</option>
                                    <option value="4">Q4 (Oct-Dec)</option>
                                </select>
                            )}

                            <Button variant="success" icon="fa-file-excel" onClick={handleExportExcel}>Excel</Button>
                        </div>
                    </PageHeader>

                    {loading ? (
                        <div className="text-center py-20"><i className="fas fa-spinner fa-spin text-3xl text-blue-500"></i></div>
                    ) : (
                        <div className="space-y-4">
                            {scorecardData.length === 0 ? (
                                <div className="text-center py-10 text-slate-500">
                                    <i className="fas fa-chart-bar text-4xl mb-3 opacity-50"></i>
                                    <p>No KPI data found for this period.</p>
                                </div>
                            ) : (
                                <div className="grid grid-cols-1 gap-4">
                                    {scorecardData.map(staff => (
                                        <div 
                                            key={staff.id} 
                                            onClick={() => handleCardClick(staff)}
                                            className="bg-slate-800/50 border border-slate-700 rounded-xl p-4 flex flex-col md:flex-row items-center gap-4 hover:border-blue-500/50 hover:bg-slate-800 transition-all cursor-pointer group"
                                        >
                                            {/* Left: Staff Info & Score */}
                                            <div className="flex items-center gap-4 w-full md:w-1/3 border-b md:border-b-0 md:border-r border-slate-700 pb-3 md:pb-0 md:pr-4">
                                                <div className={`w-14 h-14 rounded-full flex items-center justify-center text-xl font-bold border-4 shadow-lg ${
                                                    staff.overallAvg >= 90 ? 'border-green-500 text-green-400 bg-green-900/20' :
                                                    staff.overallAvg >= 70 ? 'border-yellow-500 text-yellow-400 bg-yellow-900/20' :
                                                    'border-red-500 text-red-400 bg-red-900/20'
                                                }`}>
                                                    {staff.overallAvg}%
                                                </div>
                                                <div>
                                                    <h4 className="text-lg font-bold text-white group-hover:text-blue-300 transition-colors">{staff.name}</h4>
                                                    <p className="text-xs text-slate-400">{staff.shop}  {staff.totalTasks} Tasks</p>
                                                </div>
                                            </div>

                                            {/* Right: KPI Breakdown Badges */}
                                            <div className="flex-1 w-full relative">
                                                <p className="text-[10px] text-slate-500 uppercase font-bold tracking-wider mb-2">Performance Breakdown</p>
                                                <div className="flex flex-wrap gap-2">
                                                    {staff.kpiBreakdown.map((kpi, idx) => (
                                                        <div key={idx} className={`px-3 py-1 rounded-lg text-xs border flex items-center gap-2 ${
                                                            kpi.avg >= 90 ? 'bg-green-500/10 border-green-500/20 text-green-300' :
                                                            kpi.avg >= 70 ? 'bg-yellow-500/10 border-yellow-500/20 text-yellow-300' :
                                                            'bg-red-500/10 border-red-500/20 text-red-300'
                                                        }`}>
                                                            <span className="font-medium">{kpi.name}</span>
                                                            <span className="font-bold bg-black/20 px-1.5 rounded">{kpi.avg}%</span>
                                                        </div>
                                                    ))}
                                                </div>
                                                <div className="absolute right-0 top-1/2 -translate-y-1/2 opacity-0 group-hover:opacity-100 transition-opacity">
                                                    <i className="fas fa-chevron-right text-slate-500"></i>
                                                </div>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            )}
                        </div>
                    )}

                    {/* Drill-Down Modal (Phase 2) */}
                    {selectedStaff && (
                        <Modal isOpen={!!selectedStaff} onClose={() => setSelectedStaff(null)} maxWidth="max-w-4xl">
                            <div className="flex flex-col h-[80vh]">
                                <ModalHeader title={`Performance Audit: ${selectedStaff.name}`} onClose={() => setSelectedStaff(null)} />
                                <div className="bg-slate-900/50 p-4 border-b border-slate-700 flex justify-between items-center shrink-0">
                                    <div>
                                        <p className="text-sm text-slate-400">Overall Score</p>
                                        <p className={`text-3xl font-bold ${
                                            selectedStaff.overallAvg >= 90 ? 'text-green-400' : 
                                            selectedStaff.overallAvg >= 70 ? 'text-yellow-400' : 'text-red-400'
                                        }`}>{selectedStaff.overallAvg}%</p>
                                    </div>
                                    <div className="text-right">
                                        <p className="text-sm text-slate-400">Total Tasks</p>
                                        <p className="text-xl font-bold text-white">{selectedStaff.totalTasks}</p>
                                    </div>
                                </div>
                                <div className="flex-1 overflow-y-auto p-4 custom-scrollbar">
                                    <div className="space-y-6">
                                        {/* Group by KPI */}
                                        {Object.entries(
                                            staffTasks.reduce((acc, task) => {
                                                const kpi = task.kpiText || 'General';
                                                if (!acc[kpi]) acc[kpi] = [];
                                                acc[kpi].push(task);
                                                return acc;
                                            }, {})
                                        ).map(([kpiName, tasks]) => (
                                            <div key={kpiName} className="bg-slate-800 rounded-xl border border-slate-700 overflow-hidden">
                                                <div className="bg-slate-700/50 p-3 border-b border-slate-700 flex justify-between items-center">
                                                    <h4 className="font-bold text-slate-200">{kpiName}</h4>
                                                    <span className="text-xs bg-slate-600 px-2 py-1 rounded text-slate-300">{tasks.length} Tasks</span>
                                                </div>
                                                <div className="divide-y divide-slate-700/50">
                                                    {tasks.map(task => (
                                                        <div key={task.id} className="p-4 hover:bg-slate-700/30 transition-colors">
                                                            <div className="flex justify-between items-start mb-2">
                                                                <div>
                                                                    <p className="text-sm font-medium text-white mb-1">{task.text}</p>
                                                                    <p className="text-xs text-slate-500">
                                                                        {formatFullDateTime(task.completedTimestamp)}  Audited by {task.auditorName || 'System'}
                                                                    </p>
                                                                </div>
                                                                <span className={`px-2 py-1 rounded text-xs font-bold border ${
                                                                    task.numericScore >= 90 ? 'bg-green-500/10 text-green-400 border-green-500/20' :
                                                                    task.numericScore >= 70 ? 'bg-yellow-500/10 text-yellow-400 border-yellow-500/20' :
                                                                    'bg-red-500/10 text-red-400 border-red-500/20'
                                                                }`}>
                                                                    {task.auditScore || '100%'}
                                                                </span>
                                                            </div>
                                                            {task.auditComment ? (
                                                                <div className="mt-2 p-2 bg-slate-900/50 rounded border border-slate-700/50 text-xs text-slate-300 italic flex gap-2">
                                                                    <i className="fas fa-comment-dots mt-0.5 text-slate-500"></i>
                                                                    <span>"{task.auditComment}"</span>
                                                                </div>
                                                            ) : (
                                                                <p className="text-xs text-slate-600 italic mt-1">No feedback provided.</p>
                                                            )}
                                                        </div>
                                                    ))}
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                                <div className="p-4 border-t border-slate-700 shrink-0 flex justify-end">
                                    <Button variant="secondary" onClick={() => setSelectedStaff(null)}>Close Audit</Button>
                                </div>
                            </div>
                        </Modal>
                    )}
                </Card>
            );
        };

        // --- NEW: Deposit Cash Report Tab (Updated with Index Link Logic) ---
        const DepositCashReportTab = ({ userProfile }) => {
            const { db } = useFirebase();
            const { shops } = useAppData();
            
            const [transactions, setTransactions] = useState([]);
            const [loading, setLoading] = useState(true);
            const [errorMsg, setErrorMsg] = useState('');
            const [indexLink, setIndexLink] = useState(null); // NEW
            const [retryTrigger, setRetryTrigger] = useState(0);

            const [selectedShop, setSelectedShop] = useState('');
            const [selectedMonth, setSelectedMonth] = useState(new Date().toISOString().slice(0, 7));
            const [searchTerm, setSearchTerm] = useState('');

            useEffect(() => {
                if (!db || !userProfile) return;

                setLoading(true);
                setErrorMsg('');
                setIndexLink(null);
                const { collectionGroup, query, where, onSnapshot, orderBy } = window.firebaseSDK;
                
                let q = query(collectionGroup(db, 'transactions'), orderBy('date', 'desc'));
                
                if (selectedMonth) {
                    const [y, m] = selectedMonth.split('-').map(Number);
                    const startOfMonth = new Date(y, m - 1, 1);
                    const endOfMonth = new Date(y, m, 0, 23, 59, 59, 999);
                    q = query(q, where('date', '>=', startOfMonth), where('date', '<=', endOfMonth));
                }

                if (userProfile.role === 'Shop Manager') {
                    const managedShops = Array.isArray(userProfile.shop) ? userProfile.shop : (userProfile.shop ? [userProfile.shop] : []);
                    if (managedShops.length > 0) {
                        q = query(q, where("shop", "in", managedShops));
                    } else {
                        q = query(q, where("shop", "==", "null")); 
                    }
                } else if (userProfile.role === 'Staff') {
                    q = query(q, where("employeeId", "==", userProfile.id));
                }

                const unsubscribe = onSnapshot(q, (snapshot) => {
                    const txs = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    setTransactions(txs);
                    setLoading(false);
                }, (error) => {
                    console.error("Deposit Report Error:", error);
                    if (error.code === 'failed-precondition') {
                        setErrorMsg("Database Index Required");
                        const match = error.message.match(/https:\/\/console\.firebase\.google\.com[^\s]+/);
                        if (match) {
                            setIndexLink(match[0]);
                        }
                    } else {
                        setErrorMsg(error.message);
                    }
                    setTransactions([]);
                    setLoading(false);
                });

                return () => unsubscribe();
            }, [db, userProfile, selectedMonth, retryTrigger]);

            useEffect(() => {
                if (userProfile && userProfile.role !== 'Admin' && userProfile.role !== 'CEO') {
                    setSelectedShop(Array.isArray(userProfile.shop) ? '' : userProfile.shop || '');
                }
            }, [userProfile]);
            
            const availableShops = useMemo(() => {
                if (userProfile?.role === 'Admin' || userProfile?.role === 'CEO') return shops;
                if (userProfile?.role === 'Shop Manager' && Array.isArray(userProfile.shop)) {
                    return shops.filter(s => userProfile.shop.includes(s.name));
                }
                return [];
            }, [shops, userProfile]);

            const { depositTransactions, totalDeposits } = useMemo(() => {
                const filtered = transactions.filter(tx => {
                    const shopMatch = !selectedShop || tx.shop === selectedShop;
                    const searchMatch = !searchTerm || (tx.staffName && tx.staffName.toLowerCase().includes(searchTerm.toLowerCase()));
                    const isCashDeposit = tx.type === 'contribution' && !tx.payrollId;
                    return shopMatch && searchMatch && isCashDeposit;
                });
                
                const total = filtered.reduce((sum, tx) => sum + (tx.amountDeducted || 0), 0);
                return { depositTransactions: filtered, totalDeposits: total };
            }, [transactions, selectedShop, searchTerm]);

            const handleExportExcel = useCallback(() => {
                const dataToExport = depositTransactions.map(tx => ({ 
                    'Date': Utils.formatRequestDate(tx.date),
                    'Staff Name': tx.staffName,
                    'Shop': tx.shop,
                    'Amount (KHR)': tx.amountDeducted,
                    'Note': tx.note || 'Manual Cash Deposit'
                }));
                const worksheet = XLSX.utils.json_to_sheet(dataToExport);
                const workbook = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(workbook, worksheet, "Cash Deposits");
                worksheet["!cols"] = [ { wch: 20 }, { wch: 25 }, { wch: 20 }, { wch: 15 }, { wch: 30 } ];
                XLSX.writeFile(workbook, `Cash_Deposit_Report_${selectedMonth}.xlsx`);
            }, [depositTransactions, selectedMonth]);

            return (
                <Card>
                    <div className="flex flex-wrap gap-4 justify-between items-center mb-6">
                        <h3 className="text-xl font-semibold text-slate-100">Deposit Cash Report</h3>
                        <div className="flex flex-wrap gap-4 items-center">
                            <input type="text" placeholder="Search by name..." value={searchTerm} onChange={e => setSearchTerm(e.target.value)} className="input w-full sm:w-auto" />
                             {(userProfile?.role === 'Admin' || userProfile?.role === 'CEO' || (userProfile?.role === 'Shop Manager' && Array.isArray(userProfile.shop))) && (
                                <select value={selectedShop} onChange={e => setSelectedShop(e.target.value)} className="select w-full sm:w-auto">
                                    <option value="">{userProfile.role === 'Admin' || userProfile.role === 'CEO' ? 'All Shops' : 'All My Shops'}</option>
                                    {availableShops.map(s => <option key={s.id} value={s.name}>{s.name}</option>)}
                                </select>
                            )}
                            <input type="month" value={selectedMonth} onChange={e => setSelectedMonth(e.target.value)} className="input w-full sm:w-auto" />
                            <Button variant="success" icon="fa-file-excel" onClick={handleExportExcel}>Excel</Button>
                        </div>
                    </div>

                    {errorMsg && (
                        <div className="mb-6 p-4 bg-red-900/30 border border-red-500/50 rounded-lg text-red-200 flex flex-col items-center justify-center gap-4 text-center">
                            <div>
                                <p className="font-bold text-lg flex items-center justify-center"><i className="fas fa-database mr-2 text-yellow-400"></i> {errorMsg}</p>
                                {indexLink ? (
                                    <p className="text-sm mt-2 opacity-90 max-w-lg">
                                        Firebase requires a specialized index for this report.
                                    </p>
                                ) : (
                                    <p className="text-sm mt-2 opacity-90">Open console (F12) to see details.</p>
                                )}
                            </div>
                            <div className="flex gap-4">
                                {indexLink && (
                                    <a 
                                        href={indexLink} 
                                        target="_blank" 
                                        rel="noopener noreferrer" 
                                        className="bg-yellow-600 hover:bg-yellow-500 text-white font-bold py-2 px-6 rounded-lg shadow-lg flex items-center transition-transform transform hover:scale-105"
                                    >
                                        <i className="fas fa-hammer mr-2"></i> Create Missing Index
                                    </a>
                                )}
                                <Button variant="secondary" onClick={() => setRetryTrigger(prev => prev + 1)} icon="fa-sync">
                                    Retry Connection
                                </Button>
                            </div>
                        </div>
                    )}

                     {loading ? (
                        <div className="text-center py-10"><i className="fas fa-spinner fa-spin text-3xl text-blue-400"></i></div>
                    ) : (
                    <div className="overflow-x-auto">
                        <table className="min-w-full divide-y divide-slate-700">
                            <thead className="bg-slate-900/50">
                                <tr>
                                    <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Date</th>
                                    <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Staff Name</th>
                                    <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Shop</th>
                                    <th className="px-4 py-3 text-right text-xs font-semibold text-slate-400 uppercase">Amount</th>
                                    <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Note</th>
                                </tr>
                            </thead>
                            <tbody className="divide-y divide-slate-700">
                                {depositTransactions.length === 0 ? (
                                    <tr><td colSpan="5" className="px-4 py-8 text-center text-slate-500">No cash deposits found for this period.</td></tr>
                                ) : (
                                    depositTransactions.map(tx => (
                                        <tr key={tx.id} className="hover:bg-slate-700/50">
                                            <td className="px-4 py-4 text-sm text-slate-300 whitespace-nowrap">{Utils.formatRequestDate(tx.date)}</td>
                                            <td className="px-4 py-4 text-sm text-slate-200">{tx.staffName}</td>
                                            <td className="px-4 py-4 text-sm text-slate-300">{tx.shop}</td>
                                            <td className="px-4 py-4 text-sm text-right font-semibold text-green-400">
                                                {Utils.formatCurrency(tx.amountDeducted)}
                                            </td>
                                            <td className="px-4 py-4 text-sm text-slate-400">{tx.note || 'Manual Cash Deposit'}</td>
                                        </tr>
                                    ))
                                )}
                            </tbody>
                            <tfoot className="bg-slate-900/50">
                                <tr>
                                    <td colSpan="3" className="px-4 py-3 text-right font-bold text-green-400 uppercase">Total Cash Deposits</td>
                                    <td className="px-4 py-3 text-right font-bold text-green-400">{Utils.formatCurrency(totalDeposits)}</td>
                                    <td></td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                    )}
                </Card>
            );
        };
        
        // --- NEW: Savings Transaction History Tab ---
        const SavingsHistoryTab = ({ userProfile }) => {
            const { db } = useFirebase();
            const { shops } = useAppData();
            
            const [transactions, setTransactions] = useState([]);
            const [loading, setLoading] = useState(true);
            const [errorMsg, setErrorMsg] = useState('');
            const [indexLink, setIndexLink] = useState(null);

            const [selectedShop, setSelectedShop] = useState('');
            const [selectedMonth, setSelectedMonth] = useState(new Date().toISOString().slice(0, 7));
            const [searchTerm, setSearchTerm] = useState('');
            
            // Reversal State
            const [txToReverse, setTxToReverse] = useState(null);

            useEffect(() => {
                if (!db || !userProfile) return;

                setLoading(true);
                setErrorMsg('');
                const { collectionGroup, query, where, onSnapshot, orderBy } = window.firebaseSDK;
                
                // Base query on collectionGroup 'transactions'
                let q = query(collectionGroup(db, 'transactions'), orderBy('date', 'desc'));
                
                // Date Filtering (Month)
                if (selectedMonth) {
                    const [y, m] = selectedMonth.split('-').map(Number);
                    const startOfMonth = new Date(y, m - 1, 1);
                    const endOfMonth = new Date(y, m, 0, 23, 59, 59, 999);
                    q = query(q, where('date', '>=', startOfMonth), where('date', '<=', endOfMonth));
                }

                // Security Filtering
                if (userProfile.role === 'Shop Manager') {
                    const managedShops = Array.isArray(userProfile.shop) ? userProfile.shop : [userProfile.shop];
                    if (managedShops.length > 0) {
                        q = query(q, where("shop", "in", managedShops));
                    } else {
                        q = query(q, where("shop", "==", "null")); 
                    }
                } else if (userProfile.role === 'Staff') {
                    q = query(q, where("employeeId", "==", userProfile.id));
                }

                const unsubscribe = onSnapshot(q, (snapshot) => {
                    const txs = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    setTransactions(txs);
                    setLoading(false);
                }, (error) => {
                    console.error("History Report Error:", error);
                    if (error.code === 'failed-precondition') {
                        setErrorMsg("Database Index Required");
                        const match = error.message.match(/https:\/\/console\.firebase\.google\.com[^\s]+/);
                        if (match) setIndexLink(match[0]);
                    } else {
                        setErrorMsg(error.message);
                    }
                    setLoading(false);
                });

                return () => unsubscribe();
            }, [db, userProfile, selectedMonth]);

            // UI Filter Logic
            const filteredTransactions = useMemo(() => {
                return transactions.filter(tx => {
                    const shopMatch = !selectedShop || tx.shop === selectedShop;
                    const searchMatch = !searchTerm || (tx.staffName && tx.staffName.toLowerCase().includes(searchTerm.toLowerCase()));
                    return shopMatch && searchMatch;
                });
            }, [transactions, selectedShop, searchTerm]);

            // Handlers
            const handleReverse = async () => {
                if (!txToReverse) return;
                const result = await Utils.reverseSavingsWithdrawal(db, txToReverse);
                if (result.success) {
                    alert("Transaction reversed successfully.");
                    setTxToReverse(null);
                } else {
                    alert("Failed to reverse transaction: " + result.error.message);
                }
            };

            const handleExportExcel = () => {
                const data = filteredTransactions.map(tx => ({
                    'Date': Utils.formatRequestDate(tx.date),
                    'Staff Name': tx.staffName,
                    'Shop': tx.shop,
                    'Type': tx.type === 'contribution' ? 'Deposit' : 'Withdrawal',
                    'Amount': tx.amountDeducted || tx.amountWithdrawn,
                    'Note': tx.note || '-'
                }));
                Utils.exportToExcel(data, "Savings History", `Savings_History_${selectedMonth}.xlsx`);
            };
            
            const availableShops = useAllowedShops(userProfile, shops);
            const canManage = userProfile.role === 'Admin' || userProfile.role === 'CEO';

            return (
                <Card>
                    <div className="flex flex-wrap gap-4 justify-between items-center mb-6">
                        <h3 className="text-xl font-semibold text-slate-100">Transaction History</h3>
                        <div className="flex flex-wrap gap-4 items-center">
                            <input type="text" placeholder="Search staff..." value={searchTerm} onChange={e => setSearchTerm(e.target.value)} className="input w-full sm:w-auto" />
                            {(userProfile?.role === 'Admin' || userProfile?.role === 'CEO' || (userProfile?.role === 'Shop Manager' && Array.isArray(userProfile.shop))) && (
                                <select value={selectedShop} onChange={e => setSelectedShop(e.target.value)} className="select w-full sm:w-auto">
                                    <option value="">All Shops</option>
                                    {availableShops.map(s => <option key={s.id} value={s.name}>{s.name}</option>)}
                                </select>
                            )}
                            <input type="month" value={selectedMonth} onChange={e => setSelectedMonth(e.target.value)} className="input w-full sm:w-auto" />
                            <Button variant="success" icon="fa-file-excel" onClick={handleExportExcel}>Excel</Button>
                        </div>
                    </div>

                    {errorMsg && (
                        <div className="mb-6 p-4 bg-red-900/30 border border-red-500/50 rounded-lg text-red-200 text-center">
                            <p className="font-bold"><i className="fas fa-exclamation-triangle mr-2"></i> {errorMsg}</p>
                            {indexLink && <a href={indexLink} target="_blank" rel="noopener noreferrer" className="underline text-yellow-400 mt-2 block">Create Missing Index</a>}
                        </div>
                    )}

                    {loading ? <div className="text-center py-10"><i className="fas fa-spinner fa-spin text-3xl text-blue-400"></i></div> : (
                        <div className="overflow-x-auto">
                            <table className="min-w-full divide-y divide-slate-700">
                                <thead className="bg-slate-900/50">
                                    <tr>
                                        <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Date</th>
                                        <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Staff</th>
                                        <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Shop</th>
                                        <th className="px-4 py-3 text-center text-xs font-semibold text-slate-400 uppercase">Type</th>
                                        <th className="px-4 py-3 text-right text-xs font-semibold text-slate-400 uppercase">Amount</th>
                                        <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Note</th>
                                        {canManage && <th className="px-4 py-3 text-center text-xs font-semibold text-slate-400 uppercase">Actions</th>}
                                    </tr>
                                </thead>
                                <tbody className="divide-y divide-slate-700">
                                    {filteredTransactions.length === 0 ? <tr><td colSpan="7" className="px-4 py-8 text-center text-slate-500">No transactions found.</td></tr> : (
                                        filteredTransactions.map(tx => (
                                            <tr key={tx.id} className="hover:bg-slate-700/50">
                                                <td className="px-4 py-4 text-sm text-slate-300 whitespace-nowrap">{Utils.formatRequestDate(tx.date)}</td>
                                                <td className="px-4 py-4 text-sm text-slate-200">{tx.staffName}</td>
                                                <td className="px-4 py-4 text-sm text-slate-300">{tx.shop}</td>
                                                <td className="px-4 py-4 text-center">
                                                    <span className={`px-2 py-1 text-xs rounded-full ${tx.type === 'contribution' ? 'bg-green-900 text-green-300' : 'bg-red-900 text-red-300'}`}>
                                                        {tx.type === 'contribution' ? 'Deposit' : 'Withdrawal'}
                                                    </span>
                                                </td>
                                                <td className={`px-4 py-4 text-sm text-right font-bold ${tx.type === 'contribution' ? 'text-green-400' : 'text-red-400'}`}>
                                                    {Utils.formatCurrency(tx.amountDeducted || tx.amountWithdrawn)}
                                                </td>
                                                <td className="px-4 py-4 text-sm text-slate-400">{tx.note || '-'}</td>
                                                {canManage && (
                                                    <td className="px-4 py-4 text-center">
                                                        {tx.type === 'withdrawal' && (
                                                            <Button variant="icon-delete" icon="fa-undo" onClick={() => setTxToReverse(tx)} title="Reverse Withdrawal" />
                                                        )}
                                                    </td>
                                                )}
                                            </tr>
                                        ))
                                    )}
                                </tbody>
                            </table>
                        </div>
                    )}
                    
                    <ConfirmationModal 
                        isOpen={!!txToReverse} 
                        onClose={() => setTxToReverse(null)} 
                        onConfirm={handleReverse} 
                        title="Reverse Transaction" 
                        message={`Are you sure you want to reverse this withdrawal of ${Utils.formatCurrency(txToReverse?.amountWithdrawn)}? This will add the amount back to the employee's savings balance.`} 
                    />
                </Card>
            );
        };

        // NEW: Main Savings Program Page (Tab Container)
        const SavingsProgramPage = ({ userProfile }) => {
            // MODIFIED: Re-introduced TabbedPage to include the new report tab
            const [activeTab, setActiveTab] = useState('participants');
            
            const tabs = {
                participants: <span><i className="fas fa-users mr-2 text-blue-400"></i>Participants</span>,
                history: <span><i className="fas fa-history mr-2 text-orange-400"></i>Transaction History</span>,
                depositReport: <span><i className="fas fa-file-invoice mr-2 text-green-400"></i>Deposit Cash Report</span>
            };

            return (
                <TabbedPage tabs={tabs} activeTab={activeTab} setActiveTab={setActiveTab}>
                    <div id="participants"><ParticipantsTab userProfile={userProfile} /></div>
                    <div id="history"><SavingsHistoryTab userProfile={userProfile} /></div>
                    <div id="depositReport"><DepositCashReportTab userProfile={userProfile} /></div>
                </TabbedPage>
            );
        };
        // --- END SAVINGS PROGRAM PAGE COMPONENTS ---

        // --- START LOAN MANAGER PAGE ---
        const LoanManagerPage = ({ userProfile }) => {
            return (
                <div className="space-y-6">
                    <LoanManagementTab userProfile={userProfile} />
                    <LoanHistoryTab userProfile={userProfile} />
                </div>
            );
        };

        const LoanManagementTab = ({ userProfile }) => {
            const { db } = useFirebase();
            const [isModalOpen, setModalOpen] = useState(false);
            const [editingLoan, setEditingLoan] = useState(null);
            const [loanToDelete, setLoanToDelete] = useState(null);
            const { where } = window.firebaseSDK;
            
            // REFACTORED: Get global data from App Data Context.
            const { shops, employees } = useAppData();
            const [selectedShop, setSelectedShop] = useState(''); // For the modal's employee list
            const [formData, setFormData] = useState({});
            const [filterShop, setFilterShop] = useState(''); // For filtering the main list
            const [searchTerm, setSearchTerm] = useState(''); // State for the search input

            const queryConstraints = useMemo(() => {
                if (!userProfile) return [where("shop", "==", "null")];
                if (userProfile.role === 'Admin' || userProfile.role === 'CEO') return [];
                if (userProfile.role === 'Shop Manager') {
                    const shops = Array.isArray(userProfile.shop) ? userProfile.shop : (userProfile.shop ? [userProfile.shop] : []);
                    if (shops.length > 0) {
                        return [where("shop", "in", shops)];
                    }
                    return [where("staffId", "==", "null")]; // No shops, no data
                }
                return [where("shop", "==", userProfile.shop || null)];
            }, [userProfile]);

            const { data: loans } = useCollection('staffLoans', queryConstraints);

            // OPTIMIZATION: Use the centralized hook
            const allowedShops = useAllowedShops(userProfile, shops);

            // Set initial filter shop
            useEffect(() => {
                if (userProfile && userProfile.role !== 'Admin' && userProfile.role !== 'CEO') {
                    setFilterShop(Array.isArray(userProfile.shop) ? '' : userProfile.shop || '');
                }
            }, [userProfile]);

            const filteredLoans = useMemo(() => {
                return loans.filter(loan =>
                    (!filterShop || loan.shop === filterShop) &&
                    (loan.staffName.toLowerCase().includes(searchTerm.toLowerCase()))
                );
            }, [loans, filterShop, searchTerm]);

            const employeesInShop = useMemo(() => {
                if (!selectedShop) return [];
                return employees.filter(emp => {
                    const employeeShops = Array.isArray(emp.shop) ? emp.shop : [emp.shop];
                    return employeeShops.includes(selectedShop) && emp.status === 'Active';
                });
            }, [selectedShop, employees]);
            
            const canSelectShopInModal = userProfile?.role === 'Admin' || userProfile?.role === 'CEO' || (userProfile?.role === 'Shop Manager' && Array.isArray(userProfile.shop));

            const handleOpenModal = (loan = null) => {
                setEditingLoan(loan);
                let initialShop = '';
                if (userProfile.role === 'Shop Manager') {
                    const managedShops = Array.isArray(userProfile.shop) ? userProfile.shop : [userProfile.shop];
                    if (managedShops.length === 1) initialShop = managedShops[0];
                } else if (userProfile.role !== 'Admin' && userProfile.role !== 'CEO') {
                    initialShop = userProfile.shop || '';
                }

                const initialData = loan ? { ...loan } : { loanDate: new Date().toISOString().substring(0, 10), effectiveDate: new Date().toISOString().substring(0, 10), shop: initialShop, staffId: '', loanAmount: '', agreedMonthlyDeduction: '', reason: '', totalPaid: 0, status: 'Active' };
                setFormData(initialData);
                setSelectedShop(initialData.shop || '');
                setModalOpen(true);
            };

            const handleCloseModal = () => { setModalOpen(false); setEditingLoan(null); };
            const handleChange = (e) => {
                const { name, value } = e.target;
                setFormData(prev => ({ ...prev, [name]: value }));
                if (name === 'shop') { setSelectedShop(value); setFormData(prev => ({...prev, staffId: ''})); }
            };
            const handleSave = async () => {
                const { addDoc, updateDoc, doc, collection } = window.firebaseSDK;
                const dataToSave = { ...formData, loanAmount: parseFloat(formData.loanAmount) || 0, agreedMonthlyDeduction: parseFloat(formData.agreedMonthlyDeduction) || 0, staffName: employees.find(e => e.id === formData.staffId)?.name || '' };
                try {
                    if (editingLoan) { await updateDoc(doc(db, 'staffLoans', editingLoan.id), dataToSave); } 
                    else { await addDoc(collection(db, 'staffLoans'), dataToSave); }
                    handleCloseModal();
                } catch (error) { console.error("Error saving loan:", error); }
            };
            const confirmDelete = async () => {
                if (!loanToDelete) return;
                const { writeBatch, collection, query, where, getDocs, doc } = window.firebaseSDK;
                const batch = writeBatch(db);
                try {
                    const paymentsQuery = query(collection(db, 'loanPayments'), where("loanId", "==", loanToDelete.id));
                    const paymentsSnapshot = await getDocs(paymentsQuery);
                    paymentsSnapshot.forEach((paymentDoc) => { batch.delete(paymentDoc.ref); });
                    const loanRef = doc(db, 'staffLoans', loanToDelete.id);
                    batch.delete(loanRef);
                    await batch.commit();
                } catch (error) {
                    console.error("Error deleting loan and its payments:", error);
                    alert("Failed to delete the loan and its history. Please try again.");
                } finally {
                    setLoanToDelete(null);
                }
            };
            
            // OPTIMIZATION: Refactored UI
            return (
                 <Card>
                    <PageHeader title="Loan Management">
                        <SearchInput 
                            value={searchTerm} 
                            onChange={e => setSearchTerm(e.target.value)} 
                            placeholder="Search by staff name..."
                        />
                        <ShopFilterSelect 
                            userProfile={userProfile}
                            shops={shops}
                            selectedShop={filterShop}
                            onChange={e => setFilterShop(e.target.value)}
                        />
                        <Button variant="primary" icon="fa-plus" onClick={() => handleOpenModal()}>Add New Loan</Button>
                    </PageHeader>

                    <div className="overflow-x-auto"><table className="min-w-full divide-y divide-slate-700"><thead className="bg-slate-900/50"><tr><th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Staff Name</th><th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Loan Date</th><th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Effective Date</th><th className="px-4 py-3 text-right text-xs font-semibold text-slate-400 uppercase">Loan Amount</th><th className="px-4 py-3 text-right text-xs font-semibold text-slate-400 uppercase">Agreed Amount</th><th className="px-4 py-3 text-right text-xs font-semibold text-slate-400 uppercase">Total Paid</th><th className="px-4 py-3 text-right text-xs font-semibold text-slate-400 uppercase">Balance</th><th className="px-4 py-3 text-center text-xs font-semibold text-slate-400 uppercase">Status</th><th className="px-4 py-3 text-center text-xs font-semibold text-slate-400 uppercase">Actions</th></tr></thead><tbody className="divide-y divide-slate-700">{filteredLoans.map(loan => { const balance = loan.loanAmount - loan.totalPaid; return (<tr key={loan.id} className="hover:bg-slate-700/50"><td className="px-4 py-4 text-sm text-slate-200">{loan.staffName}</td><td className="px-4 py-4 text-sm text-slate-300">{Utils.formatISOToDisplay(loan.loanDate)}</td><td className="px-4 py-4 text-sm text-slate-300">{Utils.formatISOToDisplay(loan.effectiveDate)}</td><td className="px-4 py-4 text-sm text-slate-300 text-right">{Utils.formatCurrency(loan.loanAmount)}</td><td className="px-4 py-4 text-sm text-slate-300 text-right">{Utils.formatCurrency(loan.agreedMonthlyDeduction)}</td><td className="px-4 py-4 text-sm text-slate-300 text-right">{Utils.formatCurrency(loan.totalPaid)}</td><td className="px-4 py-4 text-sm text-slate-300 text-right">{Utils.formatCurrency(balance)}</td><td className="px-4 py-4 text-center text-sm"><span className={`px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${balance <= 0 ? 'bg-green-100 text-green-800' : 'bg-blue-100 text-blue-800'}`}>{balance <= 0 ? 'Paid Off' : 'Active'}</span></td><td className="px-4 py-4 text-center whitespace-nowrap"><div className="flex items-center justify-center gap-4"><Button variant="icon-edit" icon="fa-edit" onClick={() => handleOpenModal(loan)} title="Edit" /><Button variant="icon-delete" icon="fa-trash" onClick={() => setLoanToDelete(loan)} title="Delete" /></div></td></tr>); })}</tbody></table></div>
                    <Modal isOpen={isModalOpen} onClose={handleCloseModal}><ModalHeader title={editingLoan ? "Edit Loan" : "Add New Loan"} onClose={handleCloseModal} /><ModalBody><div className="space-y-4"><div><label className="text-sm text-slate-400">Shop</label><select name="shop" value={formData.shop || ''} onChange={handleChange} className="select" disabled={!canSelectShopInModal}><option value="">Select Shop</option>{allowedShops.map(s => <option key={s.id} value={s.name}>{s.name}</option>)}</select></div><div><label className="text-sm text-slate-400">Staff</label><select name="staffId" value={formData.staffId || ''} onChange={handleChange} className="select" disabled={!selectedShop}><option value="">Select Staff</option>{employeesInShop.map(e => <option key={e.id} value={e.id}>{e.name}</option>)}</select></div><div><label className="text-sm text-slate-400">Loan Date</label><input type="date" name="loanDate" value={formData.loanDate || ''} onChange={handleChange} className="input"/></div><div><label className="text-sm text-slate-400">Effective Date</label><input type="date" name="effectiveDate" value={formData.effectiveDate || ''} onChange={handleChange} className="input"/></div><div><label className="text-sm text-slate-400">Loan Amount</label><input type="number" name="loanAmount" value={formData.loanAmount || ''} onChange={handleChange} className="input"/></div><div><label className="text-sm text-slate-400">Agreed Monthly Deduction</label><input type="number" name="agreedMonthlyDeduction" value={formData.agreedMonthlyDeduction || ''} onChange={handleChange} className="input"/></div><div><label className="text-sm text-slate-400">Reason</label><textarea name="reason" value={formData.reason || ''} onChange={handleChange} className="input" rows="3"></textarea></div></div></ModalBody><ModalFooter><Button variant="secondary" onClick={handleCloseModal}>Cancel</Button><Button variant="primary" onClick={handleSave} className="px-6">Save Loan</Button></ModalFooter></Modal>
                    <ConfirmationModal isOpen={!!loanToDelete} onClose={() => setLoanToDelete(null)} onConfirm={confirmDelete} title="Delete Loan" message="Are you sure you want to delete this loan record?" />
                </Card>
            );
        };
        
        const LoanHistoryTab = ({ userProfile }) => {
            const { db } = useFirebase();
            const { where } = window.firebaseSDK;
            const [selectedShop, setSelectedShop] = useState('');
            // REFACTORED: Get global data from App Data Context.
            const { shops } = useAppData();

            // Set initial shop based on role
            useEffect(() => {
                if (userProfile && userProfile.role !== 'Admin' && userProfile.role !== 'CEO') {
                    setSelectedShop(Array.isArray(userProfile.shop) ? '' : userProfile.shop || '');
                }
            }, [userProfile]);

            // Query logic
            const queryConstraints = useMemo(() => {
                if (!userProfile) return [where("shop", "==", "null")];
                if (userProfile.role === 'Admin' || userProfile.role === 'CEO') {
                    return selectedShop ? [where("shop", "==", selectedShop)] : [];
                }
                if (userProfile.role === 'Shop Manager') {
                    const managedShops = Array.isArray(userProfile.shop) ? userProfile.shop : (userProfile.shop ? [userProfile.shop] : []);
                    if (managedShops.length === 0) return [where("shop", "==", "null")];
                    if (selectedShop) {
                        return [where("shop", "==", selectedShop)];
                    }
                    return [where("shop", "in", managedShops)];
                }
                return [where("shop", "==", userProfile.shop || null)];
            }, [userProfile, selectedShop]);
            
            const { data: loanPayments } = useCollection('loanPayments', queryConstraints);
            const { data: staffLoans } = useCollection('staffLoans');
            const [paymentToDelete, setPaymentToDelete] = useState(null);

            const confirmDelete = async () => {
                if (!paymentToDelete) return;
                const { doc, updateDoc, deleteDoc } = window.firebaseSDK;
                try {
                    // Revert the loan's totalPaid amount
                    const loan = staffLoans.find(l => l.id === paymentToDelete.loanId);
                    if (loan) {
                        const newTotalPaid = (loan.totalPaid || 0) - paymentToDelete.amountPaid;
                        const newStatus = newTotalPaid >= loan.loanAmount ? 'Paid Off' : 'Active';
                        await updateDoc(doc(db, 'staffLoans', loan.id), { totalPaid: newTotalPaid, status: newStatus });
                    }
                    await deleteDoc(doc(db, 'loanPayments', paymentToDelete.id));
                } catch (error) { console.error("Error deleting loan payment:", error); alert("Failed to delete loan payment."); } 
                finally { setPaymentToDelete(null); }
            };
            
            // OPTIMIZATION: Used new hook
            const allowedShops = useAllowedShops(userProfile, shops);

            // OPTIMIZATION: Refactored UI
            return (
                 <Card>
                    <PageHeader title="Loan Payment History">
                        <ShopFilterSelect 
                            userProfile={userProfile}
                            shops={shops}
                            selectedShop={selectedShop}
                            onChange={e => setSelectedShop(e.target.value)}
                        />
                    </PageHeader>
                    <div className="overflow-x-auto"><table className="min-w-full divide-y divide-slate-700"><thead className="bg-slate-900/50"><tr><th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Payment Date</th><th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Staff Name</th><th className="px-4 py-3 text-right text-xs font-semibold text-slate-400 uppercase">Amount Paid</th><th className="px-4 py-3 text-right text-xs font-semibold text-slate-400 uppercase">Remaining Balance</th><th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Note</th><th className="px-4 py-3 text-center text-xs font-semibold text-slate-400 uppercase">Actions</th></tr></thead><tbody className="divide-y divide-slate-700">{loanPayments.map(payment => (<tr key={payment.id} className="hover:bg-slate-700/50"><td className="px-4 py-4 text-sm text-slate-200">{payment.paymentDate}</td><td className="px-4 py-4 text-sm text-slate-300">{payment.staffName}</td><td className="px-4 py-4 text-sm text-slate-300 text-right">{Utils.formatCurrency(payment.amountPaid)}</td><td className="px-4 py-4 text-sm text-slate-300 text-right">{Utils.formatCurrency(payment.remainingBalance)}</td><td className="px-4 py-4 text-sm text-slate-300">{payment.note}</td><td className="px-4 py-4 text-center whitespace-nowrap"><Button variant="icon-delete" icon="fa-trash" onClick={() => setPaymentToDelete(payment)} title="Delete" /></td></tr>))}</tbody></table></div>
                    <ConfirmationModal isOpen={!!paymentToDelete} onClose={() => setPaymentToDelete(null)} onConfirm={confirmDelete} title="Delete Loan Payment" message="Are you sure you want to delete this payment record? This will also update the loan's total paid amount." />
                </Card>
            );
        };
        // --- END LOAN MANAGER PAGE ---

        // --- START HR BANKING PAGE (RESTORED) ---
        const HRBankingPage = ({ userProfile }) => {
            // NEW: Get module config
            const { moduleConfig = {} } = useAppData();
            const [activeTab, setActiveTab] = useState('');

            // MODIFIED: Filter tabs based on configuration
            const tabs = useMemo(() => {
                const available = {};
                const isEnabled = (key) => moduleConfig?.[key] !== false;

                if (isEnabled('hrBanking:loans')) {
                    available.loans = <span><i className="fas fa-landmark mr-2 text-blue-400"></i>Loan Manager</span>;
                }
                if (isEnabled('hrBanking:savings')) {
                    available.savings = <span><i className="fas fa-piggy-bank mr-2 text-green-400"></i>Savings Program</span>;
                }
                return available;
            }, [moduleConfig]);

            // Ensure we have a valid active tab
            useEffect(() => {
                const keys = Object.keys(tabs);
                if (keys.length > 0 && !tabs[activeTab]) {
                    setActiveTab(keys[0]);
                }
            }, [tabs, activeTab]);

            return (
                <TabbedPage tabs={tabs} activeTab={activeTab} setActiveTab={setActiveTab}>
                    {tabs.loans && (
                        <div id="loans"><LoanManagerPage userProfile={userProfile} /></div>
                    )}
                    {tabs.savings && (
                        <div id="savings"><SavingsProgramPage userProfile={userProfile} /></div>
                    )}
                </TabbedPage>
            );
        };
        // --- END HR BANKING PAGE ---

        // --- START CHECKINME PAGE COMPONENTS ---

        // Component: Check In / Out Tab
        const CheckInOutTab = ({ userProfile }) => {
            const { db } = useFirebase();
            const [currentTime, setCurrentTime] = useState(new Date());
            const [location, setLocation] = useState(null);
            const [accuracy, setAccuracy] = useState(null);
            const [status, setStatus] = useState('Ready to verify location.');
            const [loading, setLoading] = useState(false);
            const [distance, setDistance] = useState(null);
            const [selectedShopForCheckIn, setSelectedShopForCheckIn] = useState('');
            const [alertModal, setAlertModal] = useState({ isOpen: false, message: '' }); 
            const [savingsData, setSavingsData] = useState(null); 
            
            const [savingsWithdrawals, setSavingsWithdrawals] = useState([]);

            // NEW: Step 1 States for QR Mode
            const [checkInMethod, setCheckInMethod] = useState('gps'); // 'gps' or 'qr'
            const [isScannerOpen, setIsScannerOpen] = useState(false);
            
            const [selectedMonth, setSelectedMonth] = useState(() => {
                const now = new Date();
                const year = now.getFullYear();
                const month = String(now.getMonth() + 1).padStart(2, '0');
                return `${year}-${month}`;
            });

            const { where } = window.firebaseSDK;
            const { shops, shifts, systemSettings } = useAppData(); // MODIFIED: Get systemSettings

            // --- OPTIMIZATION START: Date-Range Scoped Data Fetching ---
            // Instead of fetching ALL history, we calculate range constraints based on 'selectedMonth'
            const dataConstraints = useMemo(() => {
                if (!userProfile?.id || !selectedMonth) return { 
                    attendance: [], leave: [], ot: [], loan: [], state: [], salary: [] 
                };

                const [year, month] = selectedMonth.split('-').map(Number);
                
                // Calculate Timestamps for Attendance
                const startOfMonth = new Date(year, month - 1, 1);
                const endOfMonth = new Date(year, month, 0, 23, 59, 59, 999);
                
                // Calculate Strings for YYYY-MM-DD fields
                const startStr = `${selectedMonth}-01`;
                const endStr = `${selectedMonth}-31`; // Loose upper bound covers all months

                return {
                    attendance: [
                        where("employeeId", "==", userProfile.id),
                        where("timestamp", ">=", startOfMonth),
                        where("timestamp", "<=", endOfMonth)
                    ],
                    // Leaves: Fetch if return date is after start of month (catches overlapping leaves)
                    leave: [
                        where("staffId", "==", userProfile.id),
                        where("returnDate", ">=", startStr) 
                    ],
                    ot: [
                        where("staffId", "==", userProfile.id),
                        where("reqDate", ">=", startStr),
                        where("reqDate", "<=", endStr)
                    ],
                    // Loans: Only fetch Active loans (historical paid-off loans not needed for current calculation)
                    loan: [
                        where("staffId", "==", userProfile.id),
                        where("status", "==", "Active")
                    ],
                    state: [
                        where("staffId", "==", userProfile.id),
                        where("date", ">=", startStr),
                        where("date", "<=", endStr)
                    ],
                    salary: [
                        where("staffId", "==", userProfile.id)
                        // Salary revisions are small, usually fetch all to find active one, 
                        // but strictly we could limit. Leaving all for safety as history is rare.
                    ]
                };
            }, [userProfile?.id, selectedMonth]);

            // Apply the optimized constraints
            const { data: attendanceData } = useCollection('attendance', dataConstraints.attendance);
            const { data: leaveRequestsData } = useCollection('leaveRequests', dataConstraints.leave);
            const { data: otRequestsData } = useCollection('otRequests', dataConstraints.ot);
            const { data: staffLoansData } = useCollection('staffLoans', dataConstraints.loan);
            const { data: employeeStatesData } = useCollection('employeeStates', dataConstraints.state);
            const { data: salaryRevisionsData } = useCollection('salaryRevisions', dataConstraints.salary);
            // --- OPTIMIZATION END ---

            const allData = {
                shops: shops,
                attendance: attendanceData,
                leaveRequests: leaveRequestsData,
                otRequests: otRequestsData,
                staffLoans: staffLoansData,
                employeeStates: employeeStatesData,
                salaryRevisions: salaryRevisionsData,
                shifts: shifts,
            };
            
            useEffect(() => {
                if (!db || !userProfile?.id) return;
                const { doc, onSnapshot } = window.firebaseSDK;
                const savingsDocRef = doc(db, 'savingprogram', userProfile.id);

                const unsubscribe = onSnapshot(savingsDocRef, (doc) => {
                    if (doc.exists()) {
                        setSavingsData(doc.data());
                    } else {
                        setSavingsData(null);
                    }
                }, (error) => { 
                    console.error("Error fetching savings balance:", error); 
                    setSavingsData(null); 
                });
                return () => unsubscribe();
            }, [db, userProfile?.id]);
            
            useEffect(() => {
                if (!db || !userProfile?.id || !selectedMonth) {
                    setSavingsWithdrawals([]);
                    return;
                }

                const fetchWithdrawals = async () => {
                    try {
                        const { collection, query, where, getDocs } = window.firebaseSDK;
                        const [year, month] = selectedMonth.split('-').map(Number);
                        const startDate = new Date(year, month - 1, 1);
                        const endDate = new Date(year, month, 0, 23, 59, 59, 999); 

                        const q = query(
                            collection(db, 'savingprogram', userProfile.id, 'transactions'),
                            where("date", ">=", startDate),
                            where("date", "<=", endDate)
                        );
                        
                        const querySnapshot = await getDocs(q);
                        const withdrawals = querySnapshot.docs
                            .map(doc => ({ id: doc.id, ...doc.data() }))
                            .filter(tx => tx.type === 'withdrawal');
                        setSavingsWithdrawals(withdrawals);
                    } catch (error) {
                        console.error("Error fetching savings withdrawals for preview:", error);
                        setSavingsWithdrawals([]);
                    }
                };

                fetchWithdrawals();
            }, [db, userProfile?.id, selectedMonth]);
            
            const isMultiShopManager = userProfile.role === 'Shop Manager' && Array.isArray(userProfile.shop);

            useEffect(() => {
                if (!isMultiShopManager) {
                    setSelectedShopForCheckIn(userProfile.shop);
                }
            }, [userProfile, isMultiShopManager]);

            const userShop = useMemo(() => {
                if (!selectedShopForCheckIn) return null;
                return allData.shops.find(s => s.name === selectedShopForCheckIn);
            }, [selectedShopForCheckIn, allData.shops]);

            const todayInShopTimezone = useMemo(() => {
                if (!userShop?.timezone) {
                    const now = new Date();
                    const year = now.getFullYear();
                    const month = String(now.getMonth() + 1).padStart(2, '0');
                    const day = String(now.getDate()).padStart(2, '0');
                    return `${year}-${month}-${day}`;
                }
                return Utils.formatDateInTimezone({ toDate: () => new Date() }, userShop.timezone).localDate;
            }, [userShop]);

            const userAttendanceToday = useMemo(() => {
                return (allData.attendance || [])
                    .filter(a => {
                        if (a.employeeId !== userProfile.id) return false;
                        const { localDate: recordDate } = Utils.formatDateInTimezone(a.timestamp, userShop?.timezone);
                        return recordDate === todayInShopTimezone;
                    })
                    .sort((a, b) => (b.timestamp?.toDate() || 0) - (a.timestamp?.toDate() || 0));
            }, [userProfile, allData.attendance, userShop, todayInShopTimezone]);
            
            const lastAction = userAttendanceToday[0] || null;

            useEffect(() => { const timerId = setInterval(() => setCurrentTime(new Date()), 1000); return () => clearInterval(timerId); }, []);
            
            const getLocation = useCallback((isCheckAction = false) => {
                if (!userShop && checkInMethod === 'gps') { 
                    setStatus(isMultiShopManager ? "Select a shop." : "Shop not found."); 
                    setLoading(false);
                    return Promise.reject("No user shop selected"); 
                }
                
                setStatus("Locating...");
                setLoading(true);

                return new Promise((resolve, reject) => {
                    navigator.geolocation.getCurrentPosition(
                        (position) => {
                            const { latitude, longitude, accuracy: posAccuracy } = position.coords;
                            const newLocation = { latitude, longitude };
                            setLocation(newLocation);
                            setAccuracy(posAccuracy);
                            
                            let dist = 0;
                            if (userShop) {
                                dist = Utils.getDistance(latitude, longitude, parseFloat(userShop.latitude), parseFloat(userShop.longitude));
                                setDistance(dist);
                                
                                const radius = parseFloat(userShop.radius) || 500;
                                const isInRange = dist <= radius;
                                
                                if (!isCheckAction) {
                                    setStatus(isInRange 
                                        ? "You are in range."
                                        : "You are too far."
                                    );
                                }
                            }
                            
                            setLoading(false);
                            resolve({ location: newLocation, distance: dist, shop: userShop });
                        },
                        (error) => {
                            setStatus(error.code === 1 ? "Permission denied." : "Location unavailable."); 
                            setLoading(false);
                            reject(error);
                        }, 
                        { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
                    );
                });
            }, [userShop, isMultiShopManager, checkInMethod]);

            // ... (keep handleScanSuccess and handleCheckAction exactly as they were) ...
            // [Abbreviated to save space, assuming they are unchanged from previous full context]
            const handleScanSuccess = async (qrText) => {
                setIsScannerOpen(false);
                setLoading(true);
                setStatus("Verifying QR...");
                
                // NEW: Track penalty application
                let penaltyApplied = false;
                let penaltyAmount = 0;

                try {
                    const { location: gpsLocation } = await getLocation(true);
                    const scannedShop = allData.shops.find(s => s.name === qrText);
                    if (!scannedShop) { alert("Invalid QR Code."); setLoading(false); return; }
                    
                    const userShops = Array.isArray(userProfile.shop) ? userProfile.shop : [userProfile.shop];
                    if (userProfile.role !== 'Admin' && userProfile.role !== 'CEO' && !userShops.includes(qrText)) {
                        alert(`Access Denied to ${qrText}.`); setLoading(false); return;
                    }

                    const dist = Utils.getDistance(gpsLocation.latitude, gpsLocation.longitude, parseFloat(scannedShop.latitude), parseFloat(scannedShop.longitude));
                    const radius = parseFloat(scannedShop.radius) || 500;
                    if (dist > radius) { alert(`Too far from ${qrText} (${Math.round(dist)}m).`); setLoading(false); return; }

                    const nextActionType = lastAction?.type === 'in' ? 'out' : 'in';
                    const checkInTimestamp = new Date();
                    const { addDoc, collection, serverTimestamp, setDoc, doc, query, getDocs, where } = window.firebaseSDK;
                    
                    // --- NEW: Capture Device Info ---
                    const deviceInfo = await Utils.getDeviceInfo();

                    await addDoc(collection(db, 'attendance'), { 
                        employeeId: userProfile.id, 
                        employeeName: userProfile.name, 
                        shop: qrText, 
                        timestamp: serverTimestamp(), 
                        type: nextActionType, 
                        verificationMethod: 'qr', 
                        location: gpsLocation,
                        deviceInfo: deviceInfo // Save to database
                    });
                    setSelectedShopForCheckIn(qrText);

                    // Late Logic (Simplified copy for brevity)
                    if (nextActionType === 'in') {
                        const shiftDetails = (allData.shifts || []).find(s => s.name === userProfile.shift && s.shopName === qrText);
                        if (shiftDetails && shiftDetails.lateThreshold && scannedShop.timezone) {
                            const timeInZoneString = checkInTimestamp.toLocaleTimeString('en-GB', { timeZone: scannedShop.timezone, hour: '2-digit', minute: '2-digit' });
                            const [checkInHour, checkInMinute] = timeInZoneString.split(':').map(Number);
                            const [lateHour, lateMinute] = shiftDetails.lateThreshold.split(':').map(Number);
                            const [startHour] = (shiftDetails.startTime || '00:00').split(':').map(Number);
                            if (checkInHour - startHour < 3) {
                                if (checkInHour > lateHour || (checkInHour === lateHour && checkInMinute > lateMinute)) {
                                    const { localDate: todayStr } = Utils.formatDateInTimezone({ toDate: () => checkInTimestamp }, scannedShop.timezone);
                                    const penaltyDocId = `late_${userProfile.id}_${todayStr}`;
                                    const q = query(collection(db, "employeeStates"), where("staffId", "==", userProfile.id), where("date", "==", todayStr));
                                    const snap = await getDocs(q);
                                    if (!snap.docs.some(doc => doc.data().note?.startsWith('CheckIn Late @'))) {
                                        const formattedTime = checkInTimestamp.toLocaleTimeString('en-US', { timeZone: scannedShop.timezone, hour: '2-digit', minute: '2-digit', hour12: true });
                                        
                                        // MODIFIED: Use configured amount or default to 5000
                                        penaltyAmount = parseFloat(systemSettings?.lateDeductionAmount) || 5000;
                                        
                                        await setDoc(doc(db, 'employeeStates', penaltyDocId), { 
                                            staffId: userProfile.id, staffName: userProfile.name, shop: qrText, date: todayStr, statusState: 'Deduction', amount: penaltyAmount, note: `CheckIn Late @${formattedTime}`, status: 'Approved' 
                                        });
                                        
                                        // NEW: Flag penalty application
                                        penaltyApplied = true;
                                    }
                                }
                            }
                        }
                    }
                    
                    // NEW: Conditional Message for QR
                    let message = `Successfully Checked ${nextActionType.toUpperCase()} via QR.`;
                    if (penaltyApplied) {
                        message = (
                            <div className="text-center">
                                <p className="text-slate-200 mb-3">Successfully checked IN.</p>
                                <p className="text-yellow-400 font-bold text-lg mb-1"><i className="fas fa-exclamation-triangle"></i> LATE CHECK-IN DETECTED</p>
                                <p className="text-sm text-slate-400">A penalty of <span className="text-red-400 font-bold">{Utils.formatCurrency(penaltyAmount)}</span> has been applied automatically.</p>
                            </div>
                        );
                    }

                    setAlertModal({ isOpen: true, message: message });
                    setStatus(`Checked ${nextActionType} via QR.`);
                } catch (error) { console.error("QR Error:", error); alert("QR Check-in Failed."); } finally { setLoading(false); }
            };

            const handleCheckAction = useCallback(async () => {
                setLoading(true);
                setStatus("Verifying...");
                
                // NEW: Track penalty application
                let penaltyApplied = false;
                let penaltyAmount = 0;

                try {
                    const { location: freshLocation, distance: freshDistance, shop } = await getLocation(true);
                    if (freshDistance > (parseFloat(shop.radius) || 500)) {
                        setStatus(`Too far (${Math.round(freshDistance)}m).`); setLoading(false); return;
                    }
                    
                    const { addDoc, collection, serverTimestamp, getDocs, query, where, setDoc, doc } = window.firebaseSDK;
                    const nextActionType = lastAction?.type === 'in' ? 'out' : 'in';
                    const checkInTimestamp = new Date();
                    
                    // --- NEW: Capture Device Info ---
                    // This now calls the updated utility to support Safari/Chrome
                    const deviceInfo = await Utils.getDeviceInfo();

                    await addDoc(collection(db, 'attendance'), { 
                        employeeId: userProfile.id, 
                        employeeName: userProfile.name, 
                        shop: selectedShopForCheckIn, 
                        timestamp: serverTimestamp(), 
                        type: nextActionType, 
                        location: freshLocation, 
                        verificationMethod: 'gps',
                        deviceInfo: deviceInfo // Saving device info
                    });
                    
                    if (nextActionType === 'in') {
                        const shiftDetails = (allData.shifts || []).find(s => s.name === userProfile.shift && s.shopName === selectedShopForCheckIn);
                        if (shiftDetails && shiftDetails.lateThreshold && shop.timezone) {
                            const [lateHour, lateMinute] = shiftDetails.lateThreshold.split(':').map(Number);
                            const [startHour] = (shiftDetails.startTime || '00:00').split(':').map(Number);
                            const timeInZoneString = checkInTimestamp.toLocaleTimeString('en-GB', { timeZone: shop.timezone, hour: '2-digit', minute: '2-digit' });
                            const [checkInHour, checkInMinute] = timeInZoneString.split(':').map(Number);
                            
                            if (checkInHour - startHour < 3) {
                                if (checkInHour > lateHour || (checkInHour === lateHour && checkInMinute > lateMinute)) {
                                    const { localDate: todayStr } = Utils.formatDateInTimezone({ toDate: () => checkInTimestamp }, shop.timezone);
                                    const penaltyDocId = `late_${userProfile.id}_${todayStr}`;
                                    const q = query(collection(db, "employeeStates"), where("staffId", "==", userProfile.id), where("date", "==", todayStr));
                                    const snap = await getDocs(q);
                                    if (!snap.docs.some(doc => doc.data().note?.startsWith('CheckIn Late @'))) {
                                        const formattedTime = checkInTimestamp.toLocaleTimeString('en-US', { timeZone: shop.timezone, hour: '2-digit', minute: '2-digit', hour12: true });
                                        
                                        // MODIFIED: Use configured amount or default to 5000
                                        penaltyAmount = parseFloat(systemSettings?.lateDeductionAmount) || 5000;

                                        await setDoc(doc(db, 'employeeStates', penaltyDocId), { 
                                            staffId: userProfile.id, staffName: userProfile.name, shop: selectedShopForCheckIn, date: todayStr, statusState: 'Deduction', amount: penaltyAmount, note: `CheckIn Late @${formattedTime}`, status: 'Approved'
                                        });
                                        
                                        // NEW: Flag penalty
                                        penaltyApplied = true;
                                    }
                                }
                            }
                        }
                    }
                    
                    // NEW: Conditional Message for GPS
                    let message = `Successfully checked ${nextActionType}.`;
                    if (penaltyApplied) {
                        message = (
                            <div className="text-center">
                                <p className="text-slate-200 mb-3">Successfully checked IN.</p>
                                <p className="text-yellow-400 font-bold text-lg mb-1"><i className="fas fa-exclamation-triangle"></i> LATE CHECK-IN DETECTED</p>
                                <p className="text-sm text-slate-400">A penalty of <span className="text-red-400 font-bold">{Utils.formatCurrency(penaltyAmount)}</span> has been applied automatically.</p>
                            </div>
                        );
                    }

                    setAlertModal({ isOpen: true, message: message });
                    setStatus(`Checked ${nextActionType}.`); 
                } catch (error) { setStatus("Failed."); console.error(error); } finally { setLoading(false); }
            }, [db, lastAction, userProfile, selectedShopForCheckIn, allData.leaveRequests, getLocation, systemSettings]); // Added systemSettings dependency

            const canCheck = distance !== null && userShop && distance <= (parseFloat(userShop.radius) || 500);
            const { inputs, calculations } = usePayrollCalculator(userProfile, selectedMonth, allData, undefined, savingsWithdrawals, savingsData);

            // Determine if checked in
            const isCheckedIn = lastAction?.type === 'in';

            return (
                <Card className="max-w-2xl mx-auto">
                    <div className="flex flex-col items-center justify-center p-2 sm:p-6 space-y-6">
                    {/* Header: Time & Date */}
                    <div className="text-center">
                        <p className="text-4xl sm:text-7xl font-bold text-slate-100 tracking-wider">
                            {currentTime.toLocaleTimeString('en-US', { timeZone: userShop?.timezone || Intl.DateTimeFormat().resolvedOptions().timeZone, hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: true })}
                        </p>
                        <p className="text-lg text-slate-400 mt-2">
                            {currentTime.toLocaleDateString('en-US', { timeZone: userShop?.timezone || Intl.DateTimeFormat().resolvedOptions().timeZone, weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}
                        </p>
                    </div>

                    {/* Method Toggle */}
                    <div className="flex bg-slate-700/50 p-1 rounded-lg w-full max-w-sm">
                        <button onClick={() => setCheckInMethod('gps')} className={`flex-1 py-2 rounded-md text-sm font-bold transition-all ${checkInMethod === 'gps' ? 'bg-blue-600 text-white shadow-lg' : 'text-slate-400 hover:text-white'}`}>
                            <i className="fas fa-map-marker-alt mr-2"></i> GPS
                        </button>
                        <button onClick={() => setCheckInMethod('qr')} className={`flex-1 py-2 rounded-md text-sm font-bold transition-all ${checkInMethod === 'qr' ? 'bg-purple-600 text-white shadow-lg' : 'text-slate-400 hover:text-white'}`}>
                            <i className="fas fa-qrcode mr-2"></i> QR Code
                        </button>
                    </div>

                    {/* Conditional Rendering based on Method */}
                    {checkInMethod === 'gps' ? (
                        <div className="w-full max-w-sm animate-fade-in space-y-4">
                            {isMultiShopManager && (
                                <div className="w-full">
                                    <select value={selectedShopForCheckIn} onChange={e => setSelectedShopForCheckIn(e.target.value)} className="select bg-slate-800 border-slate-600 text-white text-center">
                                        <option value="">-- Select Your Shop --</option>
                                        {userProfile.shop.map(shopName => <option key={shopName} value={shopName}>{shopName}</option>)}
                                    </select>
                                </div>
                            )}

                            {/* --- REDESIGNED GPS UI START --- */}
                            
                            {/* 1. Location Status Bar */}
                            <div className={`flex items-center justify-between p-3 rounded-xl border ${canCheck ? 'bg-green-500/10 border-green-500/30' : 'bg-red-500/10 border-red-500/30'} transition-colors`}>
                                <div className="flex items-center gap-3">
                                    <div className={`w-2 h-2 rounded-full ${canCheck ? 'bg-green-500 animate-pulse' : 'bg-red-500'}`}></div>
                                    <div className="flex flex-col">
                                        <span className={`text-xs font-bold ${canCheck ? 'text-green-400' : 'text-red-400'}`}>
                                            {loading ? 'Locating...' : (canCheck ? 'In Range' : 'Out of Range')}
                                        </span>
                                        <span className="text-[10px] text-slate-400">
                                            {distance !== null ? `${Math.round(distance)}m from shop` : 'Unknown location'}
                                        </span>
                                    </div>
                                </div>
                                <button 
                                    onClick={() => getLocation(false)} 
                                    disabled={loading || !userShop}
                                    className="p-2 rounded-lg bg-slate-700 hover:bg-slate-600 text-slate-300 transition-colors"
                                    title="Refresh Location"
                                >
                                    <i className={`fas fa-sync-alt ${loading ? 'fa-spin' : ''}`}></i>
                                </button>
                            </div>

                            {/* 2. Hero Action Buttons */}
                            <div className="grid grid-cols-2 gap-4">
                                {/* Check IN Button */}
                                <button 
                                    onClick={handleCheckAction} 
                                    disabled={isCheckedIn || loading} 
                                    className={`relative p-4 rounded-2xl flex flex-col items-center justify-center gap-2 border-2 transition-all transform active:scale-95 ${
                                        isCheckedIn 
                                            ? 'bg-slate-800/50 border-slate-700 text-slate-500 cursor-not-allowed opacity-50' 
                                            : 'bg-gradient-to-br from-green-600 to-emerald-700 border-green-500 text-white shadow-lg shadow-green-900/30 hover:-translate-y-1'
                                    }`}
                                >
                                    <i className="fas fa-sign-in-alt text-2xl mb-1"></i>
                                    <span className="text-lg font-bold">Check IN</span>
                                    {!isCheckedIn && !loading && canCheck && (
                                        <span className="absolute top-2 right-2 w-3 h-3 bg-white rounded-full animate-ping"></span>
                                    )}
                                </button>

                                {/* Check OUT Button */}
                                <button 
                                    onClick={handleCheckAction} 
                                    disabled={!isCheckedIn || loading} 
                                    className={`relative p-4 rounded-2xl flex flex-col items-center justify-center gap-2 border-2 transition-all transform active:scale-95 ${
                                        !isCheckedIn 
                                            ? 'bg-slate-800/50 border-slate-700 text-slate-500 cursor-not-allowed opacity-50' 
                                            : 'bg-gradient-to-br from-red-600 to-rose-700 border-red-500 text-white shadow-lg shadow-red-900/30 hover:-translate-y-1'
                                    }`}
                                >
                                    <i className="fas fa-sign-out-alt text-2xl mb-1"></i>
                                    <span className="text-lg font-bold">Check OUT</span>
                                    {isCheckedIn && !loading && canCheck && (
                                        <span className="absolute top-2 right-2 w-3 h-3 bg-white rounded-full animate-ping"></span>
                                    )}
                                </button>
                            </div>
                            
                            {/* 3. Small Status Text */}
                            <p className="text-center text-xs text-slate-500 mt-2">{status}</p>

                            {/* --- REDESIGNED GPS UI END --- */}
                        </div>
                    ) : (
                        <div className="w-full max-w-sm animate-fade-in flex flex-col items-center gap-4">
                            <button onClick={() => setIsScannerOpen(true)} className="w-full py-6 rounded-2xl bg-gradient-to-r from-purple-600 to-indigo-600 text-white font-bold text-xl shadow-lg flex items-center justify-center gap-3 transition-transform active:scale-95 hover:shadow-purple-500/20">
                                <i className="fas fa-qrcode text-2xl"></i>
                                <span>{lastAction?.type === 'in' ? 'Scan to Check OUT' : 'Scan to Check IN'}</span>
                            </button>
                            <p className="text-xs text-slate-500">Requires camera access. GPS verification still applies.</p>
                        </div>
                    )}

                    {/* Savings & Salary Preview Logic remains same */}
                    {savingsData && (savingsData.savingsProgramStatus === 'Active' || savingsData.savingsProgramStatus === 'Paused') && (
                        <div className="w-full max-w-md mt-8 p-4 bg-indigo-900/50 border border-indigo-700 rounded-lg text-center">
                            <h4 className="text-lg font-semibold text-indigo-200"></h4>
                            <p className="text-sm text-slate-400"></p>
                            <p className="text-4xl font-bold text-white mt-2">
                                {Utils.formatCurrency(savingsData?.currentBalance || 0)}
                            </p>
                        </div>
                    )}

                    <div className="text-center text-sm text-slate-400 pt-4 border-t border-slate-700 w-full max-w-md">
                        <p>Welcome, <span className="font-bold text-slate-200">{userProfile?.name}</span></p>
                        <p>Shop: <span className="font-bold text-slate-200">{selectedShopForCheckIn || 'N/A'}</span></p>
                        {lastAction && (<p className="mt-2">Last action: Checked <span className="font-semibold text-slate-200">{
                        Utils.formatDateInTimezone(lastAction.timestamp, userShop?.timezone).localTime
                    }</span></p>)}</div>
                    
                    {/* Salary Preview Section (Restored) */}
                    <div className="w-full max-w-md mt-4 p-4 bg-slate-700/50 border border-slate-600 rounded-lg">
                        <div className="flex justify-between items-center mb-4">
                             <h4 className="text-lg font-semibold text-slate-100"></h4>
                             <input type="month" value={selectedMonth} onChange={e => setSelectedMonth(e.target.value)} className="input !mt-0 w-auto" />
                        </div>
                        <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            <div className="space-y-2">
                                <h5 className="font-semibold text-slate-200 border-b border-slate-600 pb-1 mb-2"> :</h5>
                                <div className="flex justify-between items-center text-sm"><span className="text-slate-400"> :</span><span className="font-semibold text-slate-200">{inputs.workDays || 0}</span></div>
                                <div className="flex justify-between items-center text-sm"><span className="text-slate-400"> :</span><span className="font-semibold text-slate-200">{inputs.givenOffDays || 0}</span></div>
                                <div className="flex justify-between items-center text-sm"><span className="text-slate-400"> :</span><span className="font-semibold text-slate-200">{inputs.otDays || 0}</span></div>
                                <div className="flex justify-between items-center text-sm"><span className="text-slate-400"> :</span><span className="font-semibold text-slate-200">{Utils.formatCurrency(calculations.engagements)}</span></div>
                                {calculations.totalSavingsWithdrawal > 0 && (
                                    <div className="flex justify-between items-center text-sm" title="Savings Program Payback">
                                        <span className="text-slate-400"> :</span>
                                        <span className="font-semibold text-indigo-400">{Utils.formatCurrency(calculations.totalSavingsWithdrawal)}</span>
                                    </div>
                                )}
                                <div className="pt-2 border-t border-slate-600 flex justify-between items-center text-sm"><span className="font-bold text-green-400"> :</span><span className="font-bold text-green-400">{Utils.formatCurrency(calculations.grossSalary)}</span></div>
                            </div>
                            <div className="space-y-2">
                                <h5 className="font-semibold text-slate-200 border-b border-slate-600 pb-1 mb-2"> :</h5>
                                <div className="flex justify-between items-center text-sm"><span className="text-slate-400"> :</span><span className="font-semibold text-slate-200">{inputs.leaveDays || 0}</span></div>
                                <div className="flex justify-between items-center text-sm"><span className="text-slate-400"> :</span><span className="font-semibold text-slate-200">{inputs.totalLateDays || 0}</span></div>
                                <div className="flex justify-between items-center text-sm" title=" + "><span className="text-slate-400"> :</span><span className="font-semibold text-slate-200">{inputs.noAttendance || 0}</span></div>
                                <div className="flex justify-between items-center text-sm"><span className="text-slate-400"> :</span><span className="font-semibold text-slate-200">{Utils.formatCurrency(inputs.loanDeduction)}</span></div>
                                {calculations.savingsDeduction > 0 && (
                                    <div className="flex justify-between items-center text-sm">
                                        <span className="text-slate-400"> :</span>
                                        <span className="font-semibold text-blue-400">{Utils.formatCurrency(calculations.savingsDeduction)}</span>
                                    </div>
                                )}
                                {calculations.rejectedLeavePenaltyAmount > 0 && (
                                    <div className="flex justify-between items-center text-sm" title="Penalty for absence on a day with a rejected leave request">
                                        <span className="text-slate-400"> :</span>
                                        <span className="font-semibold text-red-400">{Utils.formatCurrency(calculations.rejectedLeavePenaltyAmount)}</span>
                                    </div>
                                )}
                                <div className="flex justify-between items-center text-sm"><span className="text-slate-400"> :</span><span className="font-semibold text-slate-200">{Utils.formatCurrency(calculations.otherDeductions)}</span></div>
                                <div className="pt-2 border-t border-slate-600 flex justify-between items-center text-sm"><span className="font-bold text-red-400"> :</span><span className="font-bold text-red-400">{Utils.formatCurrency(calculations.totalDeductions)}</span></div>
                            </div>
                        </div>
                        <div className="mt-4 pt-4 border-t border-slate-600 flex justify-between items-center">
                            <span className="font-bold text-slate-200"> :</span>
                            <span className="text-xl font-bold text-blue-400">{Utils.formatCurrency(calculations.netSalary)}</span>
                        </div>
                    </div>
                </div>
                <Modal isOpen={alertModal.isOpen} onClose={() => setAlertModal({ isOpen: false, message: '' })} maxWidth="max-w-sm">
                    <ModalHeader title="Notification" onClose={() => setAlertModal({ isOpen: false, message: '' })} />
                    {/* FIX: Changed from <p> to <div> to allow rich JSX message content */}
                    <ModalBody><div className="text-slate-300">{alertModal.message}</div></ModalBody>
                    <ModalFooter><Button variant="primary" onClick={() => setAlertModal({ isOpen: false, message: '' })}>OK</Button></ModalFooter>
                </Modal>
                <ScannerModal isOpen={isScannerOpen} onClose={() => setIsScannerOpen(false)} onScan={handleScanSuccess} />
                </Card>
            );
        };
        
        // Component: Leave Request Modal
        const LeaveRequestModal = ({ isOpen, onClose, onSave, request, userProfile }) => {
            const [formData, setFormData] = useState({});
            
            // Get global data from context
            const { shops, employees } = useAppData();

            const isManagerial = useMemo(() => userProfile?.role === 'Admin' || userProfile?.role === 'Shop Manager', [userProfile]);

            // Filter employees for the dropdown based on the selected shop in the modal
            const employeesInShop = useMemo(() => {
                if (!formData.shop) return [];
                return employees.filter(emp => {
                    const employeeShops = Array.isArray(emp.shop) ? emp.shop : [emp.shop];
                    return employeeShops.includes(formData.shop) && emp.status === 'Active';
                });
            }, [formData.shop, employees]);
            
            // Determine which shops should be available in the dropdown
            const availableShopsForModal = useMemo(() => {
                if (!userProfile) return [];
                if (userProfile.role === 'Admin' || userProfile.role === 'CEO') return shops;
                if (userProfile.role === 'Shop Manager') {
                    const managedShops = Array.isArray(userProfile.shop) ? userProfile.shop : (userProfile.shop ? [userProfile.shop] : []);
                    return shops.filter(s => managedShops.includes(s.name));
                }
                return []; // Staff don't get a shop dropdown
            }, [userProfile, shops]);

            useEffect(() => {
                if (request) { // EDIT mode: Populate with existing request data
                    setFormData(request);
                } else if (userProfile) { // NEW request mode
                    const initialData = {
                        leaveDate: new Date().toISOString().substring(0, 10),
                        returnDate: new Date().toISOString().substring(0, 10),
                        numberOfDays: 1,
                        leaveSession: 'Full Day',
                        leaveType: 'Relaxing Leave',
                        reason: '',
                        // Conditionally pre-fill based on role
                        shop: isManagerial ? '' : (Array.isArray(userProfile.shop) ? userProfile.shop[0] : userProfile.shop || ''),
                        staffId: isManagerial ? '' : (userProfile.id || ''),
                        staffName: isManagerial ? '' : (userProfile.name || ''),
                        supervisor: isManagerial ? '' : (userProfile.supervisor || ''),
                    };
                    setFormData(initialData);
                }
            }, [request, userProfile, isOpen, isManagerial]);

            const dateDiffInDays = useMemo(() => {
                if (formData.leaveDate && formData.returnDate) {
                    const start = new Date(formData.leaveDate);
                    const end = new Date(formData.returnDate);
                    if (end <= start) return 0;
                    const diffTime = end.getTime() - start.getTime();
                    return Math.round(diffTime / (1000 * 60 * 60 * 24));
                }
                return 0;
            }, [formData.leaveDate, formData.returnDate]);

            const isMultiDayLeave = dateDiffInDays > 1;

            const handleChange = useCallback((e) => {
                const { name, value } = e.target;
                let newFormData = { ...formData, [name]: value };

                // When a manager selects a shop, reset the staff selection
                if (name === 'shop') {
                    newFormData.staffId = '';
                    newFormData.staffName = '';
                    newFormData.supervisor = '';
                }

                // When a manager selects a staff member, populate their details
                if (name === 'staffId') {
                    const selectedEmployee = employees.find(emp => emp.id === value);
                    if (selectedEmployee) {
                        newFormData.staffName = selectedEmployee.name;
                        newFormData.supervisor = selectedEmployee.supervisor || '';
                    } else {
                        newFormData.staffName = '';
                        newFormData.supervisor = '';
                    }
                }

                // Recalculate days based on dates and session.
                const { leaveDate, returnDate, leaveSession } = newFormData;

                if (leaveDate && returnDate) {
                    const start = new Date(leaveDate);
                    const end = new Date(returnDate);
                    start.setHours(0, 0, 0, 0); // Normalize to avoid timezone issues
                    end.setHours(0, 0, 0, 0);

                    if (end < start) {
                        newFormData.numberOfDays = 0;
                    } else {
                        const diffTime = end.getTime() - start.getTime();
                        const diffDays = Math.round(diffTime / (1000 * 60 * 60 * 24));

                        // Case: User selects same leave and return date. We interpret this as a single-day event.
                        if (diffDays === 0) {
                            if (leaveSession === 'Full Day') { newFormData.numberOfDays = 1; } 
                            else { newFormData.numberOfDays = 0.5; }
                        } 
                        // Case: Standard single day leave (e.g., leave Mon, return Tue)
                        else if (diffDays === 1) {
                            if (leaveSession === 'Full Day') { newFormData.numberOfDays = 1; } 
                            else { newFormData.numberOfDays = 0.5; }
                        } 
                        // Case: Multi-day leave
                        else {
                            newFormData.numberOfDays = diffDays;
                            newFormData.leaveSession = 'Full Day'; // Force full day for multi-day leaves
                        }
                    }
                } else {
                    newFormData.numberOfDays = 0;
                }
                
                setFormData(newFormData);
            }, [formData, employees]);
            
            const handleSubmit = useCallback((e) => { 
                e.preventDefault(); 
                if ((isManagerial || Array.isArray(userProfile.shop)) && !formData.shop) {
                    alert("Please select a shop for the leave request.");
                    return;
                }

                // --- BUG FIX: Validation to prevent 0 days or negative dates ---
                if (formData.numberOfDays <= 0) {
                    alert("Invalid date range. The Return Date cannot be before the Leave Date.");
                    return;
                }
                // --- END FIX ---

                const dataToSave = { ...formData };
                if (dataToSave.leaveDate && dataToSave.leaveDate === dataToSave.returnDate) {
                    const returnDate = new Date(dataToSave.returnDate);
                    returnDate.setDate(returnDate.getDate() + 1);
                    dataToSave.returnDate = returnDate.toISOString().substring(0, 10);
                }
                onSave(dataToSave); 
            }, [onSave, formData, isManagerial, userProfile]);
            
            return (
                <Modal isOpen={isOpen} onClose={onClose} maxWidth="max-w-4xl">
                    {/* FIX: Added 'flex flex-col h-full overflow-hidden' to ensure the form stays within modal bounds and scrolls correctly */}
                    <form onSubmit={handleSubmit} className="flex flex-col h-full overflow-hidden">
                        <ModalHeader title={request ? "Edit Leave Request" : "New Leave Request"} onClose={onClose} />
                        <ModalBody>
                            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                <div>
                                    <label className="text-sm font-medium text-slate-400"><i className="fas fa-calendar-minus mr-2 text-orange-400"></i>Leave Date</label>
                                    <input type="date" name="leaveDate" value={formData.leaveDate || ''} onChange={handleChange} className="input" required />
                                </div>
                                <div>
                                    <label className="text-sm font-medium text-slate-400"><i className="fas fa-calendar-check mr-2 text-green-400"></i>Return Date</label>
                                    <input type="date" name="returnDate" value={formData.returnDate || ''} onChange={handleChange} className="input" required />
                                </div>
                                
                                <div>
                                    <label className="text-sm font-medium text-slate-400"><i className="fas fa-sun mr-2 text-yellow-400"></i>Session</label>
                                    <select name="leaveSession" value={formData.leaveSession || 'Full Day'} onChange={handleChange} className="select" disabled={isMultiDayLeave}>
                                        <option value="Full Day">Full Day</option>
                                        <option value="AM">AM (Morning)</option>
                                        <option value="PM">PM (Afternoon)</option>
                                    </select>
                                </div>
                                <div>
                                    <label className="text-sm font-medium text-slate-400"><i className="fas fa-calculator mr-2 text-blue-400"></i>No. Day(s)</label>
                                    <input 
                                        type="number"
                                        name="numberOfDays" 
                                        value={formData.numberOfDays || ''} 
                                        className="input" required 
                                        disabled
                                    />
                                </div>
                                
                                {isManagerial ? (
                                    <div>
                                        <label className="text-sm font-medium text-slate-400"><i className="fas fa-store mr-2 text-cyan-400"></i>Shop Name</label>
                                        <select name="shop" value={formData.shop || ''} onChange={handleChange} className="select" required>
                                            <option value="">Select Shop</option>
                                            {availableShopsForModal.map(shop => <option key={shop.id} value={shop.name}>{shop.name}</option>)}
                                        </select>
                                    </div>
                                ) : (
                                    <div><label className="text-sm font-medium text-slate-400"><i className="fas fa-store mr-2 text-cyan-400"></i>Shop Name</label><input value={formData.shop || ''} className="input" disabled /></div>
                                )}
                                
                                {isManagerial && !request ? (
                                    <div>
                                        <label className="text-sm font-medium text-slate-400"><i className="fas fa-user mr-2 text-emerald-400"></i>Staff Name</label>
                                        <select name="staffId" value={formData.staffId || ''} onChange={handleChange} className="select" required disabled={!formData.shop}>
                                            <option value="">Select Staff</option>
                                            {employeesInShop.map(e => <option key={e.id} value={e.id}>{e.name}</option>)}
                                        </select>
                                    </div>
                                ) : (
                                    <div><label className="text-sm font-medium text-slate-400"><i className="fas fa-user mr-2 text-emerald-400"></i>Staff Name</label><input value={formData.staffName || ''} className="input" disabled /></div>
                                )}
                                
                                <div><label className="text-sm font-medium text-slate-400"><i className="fas fa-user-tie mr-2 text-indigo-400"></i>Supervisor</label><input value={formData.supervisor || ''} className="input" disabled /></div>

                                <div className="lg:col-span-3">
                                    <label className="text-sm font-medium text-slate-400"><i className="fas fa-tags mr-2 text-pink-400"></i>Leave Type</label>
                                    <select name="leaveType" value={formData.leaveType || 'Relaxing Leave'} onChange={handleChange} className="select" required>
                                        <option>Relaxing Leave</option>
                                        <option>Sick Leave</option>
                                        <option>Emergency Leave</option>
                
                                    </select>
                                </div>
                                <div className="lg:col-span-3"><label className="text-sm font-medium text-slate-400"><i className="fas fa-comment-alt mr-2 text-slate-400"></i>Reason</label><textarea name="reason" value={formData.reason || ''} onChange={handleChange} className="input" rows="3" required></textarea></div>
                            </div>
                        </ModalBody>
                        <ModalFooter>
                            <Button type="button" variant="secondary" onClick={onClose}>Cancel</Button>
                            <Button type="submit" variant="primary" className="px-6">Submit Request</Button>
                        </ModalFooter>
                    </form>
                </Modal>
            );
        };

        // Component: OT Request Modal
        const OTRequestModal = ({ isOpen, onClose, onSave, request, userProfile }) => {
            const [formData, setFormData] = useState({});
            
            // Get global data from context
            const { shops, employees } = useAppData();

            const isManagerial = useMemo(() => userProfile?.role === 'Admin' || userProfile?.role === 'Shop Manager', [userProfile]);
            
            // Filter employees for dropdown based on selected shop
            const employeesInShop = useMemo(() => {
                if (!formData.shop) return [];
                return employees.filter(emp => {
                    const employeeShops = Array.isArray(emp.shop) ? emp.shop : [emp.shop];
                    return employeeShops.includes(formData.shop) && emp.status === 'Active';
                });
            }, [formData.shop, employees]);

            // Determine available shops for dropdown
            const availableShopsForModal = useMemo(() => {
                if (!userProfile) return [];
                if (userProfile.role === 'Admin' || userProfile.role === 'CEO') return shops;
                if (userProfile.role === 'Shop Manager') {
                    const managedShops = Array.isArray(userProfile.shop) ? userProfile.shop : (userProfile.shop ? [userProfile.shop] : []);
                    return shops.filter(s => managedShops.includes(s.name));
                }
                return [];
            }, [userProfile, shops]);

            // Initialize form data
            useEffect(() => {
                if (request) { // EDIT mode
                    setFormData({
                        ...request,
                        // Infer session if missing (for legacy edits), default to Full Day if 1 day, else AM
                        session: request.session || (parseFloat(request.numberOfOTDays) === 1 ? 'Full Day' : 'AM')
                    });
                } else if (userProfile) { // NEW request mode
                    const initialData = {
                        reqDate: new Date().toISOString().substring(0, 10),
                        session: 'Full Day', // Default session
                        numberOfOTDays: 1,   // Default days
                        reason: '',
                        shop: isManagerial ? '' : (Array.isArray(userProfile.shop) ? userProfile.shop[0] : userProfile.shop || ''),
                        staffId: isManagerial ? '' : (userProfile.id || ''),
                        staffName: isManagerial ? '' : (userProfile.name || ''),
                        supervisor: isManagerial ? '' : (userProfile.supervisor || ''),
                    };
                    setFormData(initialData);
                }
            }, [request, userProfile, isOpen, isManagerial]);

            // NEW: Calculate OT days based on Session change
            useEffect(() => {
                if (formData.session) {
                    const days = formData.session === 'Full Day' ? 1 : 0.5;
                    // Only update if different to avoid potential loops
                    if (formData.numberOfOTDays !== days) {
                        setFormData(prev => ({ ...prev, numberOfOTDays: days }));
                    }
                }
            }, [formData.session]);

            const handleChange = useCallback((e) => { 
                const { name, value } = e.target;
                let newFormData = { ...formData, [name]: value };

                if (name === 'shop') {
                    newFormData.staffId = '';
                    newFormData.staffName = '';
                    newFormData.supervisor = '';
                }
                if (name === 'staffId') {
                    const selectedEmployee = employees.find(emp => emp.id === value);
                    if (selectedEmployee) {
                        newFormData.staffName = selectedEmployee.name;
                        newFormData.supervisor = selectedEmployee.supervisor || '';
                    } else {
                        newFormData.staffName = '';
                        newFormData.supervisor = '';
                    }
                }
                setFormData(newFormData);
            }, [formData, employees]);
            
            const handleSubmit = useCallback((e) => { 
                e.preventDefault(); 
                if ((isManagerial || Array.isArray(userProfile.shop)) && !formData.shop) {
                    alert("Please select a shop for the OT request.");
                    return;
                }
                onSave(formData); 
            }, [onSave, formData, isManagerial, userProfile]);
            
            return (
                <Modal isOpen={isOpen} onClose={onClose} maxWidth="max-w-4xl">
                    {/* FIX: Added 'flex flex-col h-full overflow-hidden' to ensure the form stays within modal bounds and scrolls correctly */}
                    <form onSubmit={handleSubmit} className="flex flex-col h-full overflow-hidden">
                        <ModalHeader title={request ? "Edit OT Request" : "New OT Request"} onClose={onClose} />
                        <ModalBody>
                            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                <div><label className="text-sm font-medium text-slate-400"><i className="fas fa-calendar-day mr-2 text-orange-400"></i>OT Date</label><input type="date" name="reqDate" value={formData.reqDate || ''} onChange={handleChange} className="input" required /></div>
                                
                                {/* REPLACED Time Inputs with Session Select */}
                                <div>
                                    <label className="text-sm font-medium text-slate-400"><i className="fas fa-sun mr-2 text-yellow-400"></i>Session</label>
                                    <select name="session" value={formData.session || 'Full Day'} onChange={handleChange} className="select">
                                        <option value="Full Day">Full Day</option>
                                        <option value="AM">AM</option>
                                        <option value="PM">PM</option>
                                    </select>
                                </div>
                                
                                {isManagerial ? (
                                    <div>
                                        <label className="text-sm font-medium text-slate-400"><i className="fas fa-store mr-2 text-cyan-400"></i>Shop Name</label>
                                        <select name="shop" value={formData.shop || ''} onChange={handleChange} className="select" required>
                                            <option value="">Select Shop</option>
                                            {availableShopsForModal.map(shop => <option key={shop.id} value={shop.name}>{shop.name}</option>)}
                                        </select>
                                    </div>
                                ) : (
                                    <div><label className="text-sm font-medium text-slate-400"><i className="fas fa-store mr-2 text-cyan-400"></i>Shop Name</label><input value={formData.shop || ''} className="input" disabled /></div>
                                )}
                                
                                {isManagerial && !request ? (
                                    <div>
                                        <label className="text-sm font-medium text-slate-400"><i className="fas fa-user mr-2 text-emerald-400"></i>Staff Name</label>
                                        <select name="staffId" value={formData.staffId || ''} onChange={handleChange} className="select" required disabled={!formData.shop}>
                                            <option value="">Select Staff</option>
                                            {employeesInShop.map(e => <option key={e.id} value={e.id}>{e.name}</option>)}
                                        </select>
                                    </div>
                                ) : (
                                    <div><label className="text-sm font-medium text-slate-400"><i className="fas fa-user mr-2 text-emerald-400"></i>Staff Name</label><input value={formData.staffName || ''} className="input" disabled /></div>
                                )}
                                
                                <div><label className="text-sm font-medium text-slate-400"><i className="fas fa-user-tie mr-2 text-indigo-400"></i>Supervisor</label><input value={formData.supervisor || ''} className="input" disabled /></div>
                                
                                <div className="lg:col-span-3"><label className="text-sm font-medium text-slate-400"><i className="fas fa-calculator mr-2 text-green-400"></i>No. OT Day(s)</label><input type="number" name="numberOfOTDays" value={formData.numberOfOTDays || ''} className="input" disabled /></div>
                                <div className="lg:col-span-3"><label className="text-sm font-medium text-slate-400"><i className="fas fa-comment-alt mr-2 text-slate-400"></i>Reason</label><textarea name="reason" value={formData.reason || ''} onChange={handleChange} className="input" rows="3" required></textarea></div>
                            </div>
                        </ModalBody>
                        <ModalFooter>
                            <Button type="button" variant="secondary" onClick={onClose}>Cancel</Button>
                            <Button type="submit" variant="primary" className="px-6">Submit Request</Button>
                        </ModalFooter>
                    </form>
                </Modal>
            );
        };
        
        // Component: A single card for displaying a request in the mobile view
        const RequestCard = memo(({ request, userProfile, config, onUpdateStatus, onEdit, onDelete }) => {
            const { cardFields, submissionDateField } = config;
            // NEW: Check if we have an odd number of fields (like OT Request with 3 fields).
            // If odd, Reason fits in the last slot (col-span-1). If even, it takes a full row (col-span-2).
            const isOddFields = cardFields.length % 2 !== 0;

            // NEW: Format Request Date
            let displayDate = '';
            const rawDate = request[submissionDateField];
            if (rawDate) {
                const date = rawDate.toDate ? rawDate.toDate() : new Date(rawDate);
                const dd = String(date.getDate()).padStart(2, '0');
                const mm = String(date.getMonth() + 1).padStart(2, '0');
                const yy = String(date.getFullYear()).slice(-2);
                const time = date.toLocaleTimeString('en-GB', { hour12: false }); // hh:mm:ss
                displayDate = `${dd}-${mm}-${yy} | ${time}`;
            }

            return (
                <div className="bg-slate-700/50 rounded-lg p-4 space-y-3 flex flex-col">
                    <div className="flex justify-between items-start">
                        <div>
                            <p className="font-bold text-lg text-slate-100">{request.staffName}</p>
                            <p className="text-sm text-slate-300 flex items-center flex-wrap">
                                {request.shop}
                                {displayDate && (
                                    <>
                                        <span className="text-slate-500 mx-2">|</span>
                                        <span className="text-xs text-slate-400 font-mono">{displayDate}</span>
                                    </>
                                )}
                            </p>
                        </div>
                        <span className="px-2 py-1 text-xs font-semibold rounded-full bg-yellow-200 text-yellow-900">{request.status}</span>
                    </div>
                    <div className="grid grid-cols-2 gap-x-4 gap-y-2 text-sm pt-2 border-t border-slate-600 flex-grow">
                        {cardFields.map(field => (
                            <div key={field.label}>
                                <p className="text-slate-400">{field.label}</p>
                                <p className="text-slate-200 font-medium">{field.value(request)}</p>
                            </div>
                        ))}
                        {/* MODIFIED: Dynamic col-span based on field count */}
                        <div className={isOddFields ? "" : "col-span-2"}>
                            <p className="text-slate-400">Reason</p>
                            <p className="text-slate-200 font-medium whitespace-pre-wrap break-words">{request.reason}</p>
                        </div>
                    </div>
                    <div className="flex justify-end space-x-3 pt-2">
                        {(userProfile?.role === 'Admin' || userProfile?.role === 'CEO' || (userProfile?.role === 'Shop Manager' && userProfile.id !== request.staffId)) && request.status === 'Pending' && (
                            <>
                                <Button variant="icon-approve" icon="fa-check-circle" onClick={() => onUpdateStatus(request.id, 'Approved')} title="Approve" className="text-xl" />
                                <Button variant="icon-reject" icon="fa-times-circle" onClick={() => onUpdateStatus(request.id, 'Rejected')} title="Reject" className="text-xl" />
                            </>
                        )}
                        <Button variant="icon-edit-alt" icon="fa-edit" onClick={() => onEdit(request)} title="Edit" className="text-xl" />
                        <Button variant="icon-delete" icon="fa-trash" onClick={() => onDelete(request.id)} title="Delete" className="text-xl" />
                    </div>
                </div>
            );
        });

        // NEW: Phase 1 Refactoring - Request Filters Component
        const RequestFilters = memo(({
            title, userProfile, shops, employeesInShop,
            selectedShop, setSelectedShop, selectedEmployeeId, setSelectedEmployeeId,
            filterPeriod, setFilterPeriod, customDate, setCustomDate,
            onNewRequest
        }) => {
            return (
                <div className="flex flex-wrap gap-4 justify-between items-center mb-6">
                    <h3 className="text-xl font-semibold text-slate-100">{title}s</h3>
                    <div className="flex flex-wrap gap-4 items-center">
                        {(userProfile.role === 'Admin' || (userProfile.role === 'Shop Manager' && Array.isArray(userProfile.shop))) && (
                            <select value={selectedShop} onChange={e => { setSelectedShop(e.target.value); setSelectedEmployeeId(''); }} className="select w-full sm:w-auto">
                                <option value="">{userProfile.role === 'Admin' ? 'All Shops' : 'All My Shops'}</option>
                                {(userProfile.role === 'Admin' ? shops : (userProfile.shop || []).map(name => ({ id: name, name: name }))).map(s => <option key={s.id} value={s.name}>{s.name}</option>)}
                            </select>
                        )}
                        {(userProfile.role === 'Admin' || userProfile.role === 'Shop Manager') && selectedShop && (
                            <select value={selectedEmployeeId} onChange={e => setSelectedEmployeeId(e.target.value)} className="select w-full sm:w-auto">
                                <option value="">All Staff</option>
                                {employeesInShop.map(e => <option key={e.id} value={e.id}>{e.name}</option>)}
                            </select>
                        )}
                        {(userProfile.role === 'Admin' || userProfile.role === 'Shop Manager') && (
                            <select value={filterPeriod} onChange={e => setFilterPeriod(e.target.value)} className="select w-full sm:w-auto">
                                <option value="thisWeek">This Week</option><option value="thisMonth">This Month</option>
                                <option value="lastMonth">Last Month</option><option value="thisYear">This Year</option>
                                <option value="custom">Custom Date</option>
                            </select>
                        )}
                        {filterPeriod === 'custom' && (<input type="date" value={customDate} onChange={e => setCustomDate(e.target.value)} className="input w-full sm:w-auto" />)}
                        <Button variant="primary" icon="fa-plus" onClick={onNewRequest}>New Request</Button>
                    </div>
                </div>
            );
        });

        // NEW: Phase 1 Refactoring - Pending Requests Grid
        const PendingRequestsGrid = memo(({ requests, userProfile, config, onUpdateStatus, onEdit, onDelete }) => {
            if (requests.length === 0) return null;
            return (
                <div className="mb-8">
                    <h4 className="text-lg font-semibold text-slate-200 mb-4">Pending Requests</h4>
                    <div className="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-4">
                        {requests.map(req => (
                            <RequestCard
                                key={req.id}
                                request={req}
                                userProfile={userProfile}
                                config={config}
                                onUpdateStatus={onUpdateStatus}
                                onEdit={onEdit}
                                onDelete={onDelete}
                            />
                        ))}
                    </div>
                </div>
            );
        });

        // NEW: Phase 1 Refactoring - Request History Table
        const RequestHistoryTable = memo(({ requests, title, config, onEdit, onDelete, onViewReason }) => {
            const { tableColumns } = config;
            return (
                <div>
                    <h4 className="text-lg font-semibold text-slate-200 mb-4">{title} History</h4>
                    <div className="overflow-x-auto">
                        <table className="min-w-full divide-y divide-slate-700">
                            <thead className="bg-slate-900/50">
                                <tr>
                                    {tableColumns.map(col => <th key={col.header} className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">{col.header}</th>)}
                                    <th className="px-4 py-3 text-center text-xs font-semibold text-slate-400 uppercase">Reason</th>
                                    <th className="px-4 py-3 text-center text-xs font-semibold text-slate-400 uppercase">Status</th>
                                    <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Approval Time</th>
                                    <th className="px-4 py-3 text-center text-xs font-semibold text-slate-400 uppercase">Actions</th>
                                </tr>
                            </thead>
                            <tbody className="divide-y divide-slate-700">
                                {requests.map(req => (
                                    <tr key={req.id} className="hover:bg-slate-700/50">
                                        {tableColumns.map(col => <td key={col.header} className="px-4 py-4 text-sm text-slate-300">{typeof col.accessor === 'function' ? col.accessor(req) : req[col.accessor]}</td>)}
                                        <td className="px-4 py-4 text-center text-sm"><Button variant="icon-view" icon="fa-eye" onClick={() => onViewReason(req.reason)} /></td>
                                        <td className="px-4 py-4 text-center text-sm"><span className={`px-2 py-1 text-xs font-semibold rounded-full ${req.status === 'Approved' ? 'bg-green-200 text-green-900' : 'bg-red-200 text-red-900'}`}>{req.status}</span></td>
                                        <td className="px-4 py-4 text-sm text-slate-300">{req.status === 'Approved' ? req.approvalTimestamp || '' : ''}</td>
                                        <td className="px-4 py-4 text-center whitespace-nowrap">
                                            <div className="flex items-center justify-center gap-4">
                                                <Button variant="icon-edit-alt" icon="fa-edit" onClick={() => onEdit(req)} title="Edit" />
                                                <Button variant="icon-delete" icon="fa-trash" onClick={() => onDelete(req.id)} title="Delete" />
                                            </div>
                                        </td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                </div>
            );
        });

        // Component: Generic Tab for managing requests (Leave, OT, etc.)
        // MODIFIED: Added 'onAutoOpenProcessed' to handle one-time quick actions
        const RequestManagementTab = ({ userProfile, config, autoOpenNew, onAutoOpenProcessed }) => {
            const { collectionName, title, ModalComponent, dateField, submissionDateField } = config;
            const { db } = useFirebase();
            const [isModalOpen, setModalOpen] = useState(false);
            const [editingRequest, setEditingRequest] = useState(null);
            const [requestToDelete, setRequestToDelete] = useState(null);
            const [reasonToView, setReasonToView] = useState(null);
            const { where } = window.firebaseSDK;
            // REFACTORED: Get global data from context instead of separate collection calls.
            const { shops, employees } = useAppData();
            const [selectedShop, setSelectedShop] = useState('');
            const [filterPeriod, setFilterPeriod] = useState('thisMonth');
            const [customDate, setCustomDate] = useState(new Date().toISOString().slice(0, 10));
            const [selectedEmployeeId, setSelectedEmployeeId] = useState('');

            // NEW: Effect to auto-open the "New Request" modal if triggered via Quick Action
            useEffect(() => {
                if (autoOpenNew) {
                    setEditingRequest(null); // Ensure it's a new request
                    setModalOpen(true);
                    // Mark the action as processed so it doesn't open again on tab switch
                    if (onAutoOpenProcessed) onAutoOpenProcessed();
                }
            }, [autoOpenNew]); // Removed onAutoOpenProcessed from dependency to avoid loop

            // Set initial shop filter based on user role
            useEffect(() => {
                if (userProfile && userProfile.role !== 'Admin') {
                    setSelectedShop(Array.isArray(userProfile.shop) ? '' : userProfile.shop || '');
                }
            }, [userProfile]);

            // Define query constraints to fetch requests based on user role
            const queryConstraints = useMemo(() => {
                if (!userProfile) return [where("staffId", "==", "null")];
                if (userProfile.role === 'Admin') return [];
                if (userProfile.role === 'Shop Manager') {
                    const shops = Array.isArray(userProfile.shop) ? userProfile.shop : (userProfile.shop ? [userProfile.shop] : []);
                    if (shops.length > 0) return [where("shop", "in", shops)];
                    return [where("staffId", "==", "null")];
                }
                return [where("staffId", "==", userProfile.id)];
            }, [userProfile]);

            const { data: requests } = useCollection(collectionName, queryConstraints);

            // Get employees for the filter dropdown based on selected shop
            const employeesInShop = useMemo(() => {
                if (!selectedShop) return [];
                return employees.filter(emp => {
                    const employeeShops = Array.isArray(emp.shop) ? emp.shop : [emp.shop];
                    return employeeShops.includes(selectedShop) && emp.status === 'Active';
                });
            }, [selectedShop, employees]);

            // Filter and sort requests for display
            const { pendingRequests, historyRequests } = useMemo(() => {
                const filtered = requests.filter(req => {
                    if (!req[dateField]) return false;
                    const now = new Date();
                    let dateMatch = false;
                    switch (filterPeriod) {
                        case 'thisWeek':
                            const startOfWeek = new Date(now);
                            startOfWeek.setDate(now.getDate() - now.getDay());
                            startOfWeek.setHours(0, 0, 0, 0);
                            const endOfWeek = new Date(startOfWeek);
                            endOfWeek.setDate(startOfWeek.getDate() + 6);
                            endOfWeek.setHours(23, 59, 59, 999);
                            const reqDate = new Date(req[dateField]);
                            dateMatch = reqDate >= startOfWeek && reqDate <= endOfWeek;
                            break;
                        // FIX: The following cases now use local date components to avoid timezone errors.
                        case 'thisMonth':
                            const year_tm = now.getFullYear();
                            const month_tm = String(now.getMonth() + 1).padStart(2, '0');
                            dateMatch = req[dateField].startsWith(`${year_tm}-${month_tm}`);
                            break;
                        case 'lastMonth':
                            const lastMonthDate = new Date();
                            lastMonthDate.setMonth(lastMonthDate.getMonth() - 1);
                            const year_lm = lastMonthDate.getFullYear();
                            const month_lm = String(lastMonthDate.getMonth() + 1).padStart(2, '0');
                            dateMatch = req[dateField].startsWith(`${year_lm}-${month_lm}`);
                            break;
                        case 'thisYear':
                            dateMatch = req[dateField].startsWith(now.getFullYear().toString());
                            break;
                        case 'custom':
                            dateMatch = req[dateField] === customDate;
                            break;
                        default:
                            dateMatch = true;
                    }
                    return dateMatch && (!selectedShop || req.shop === selectedShop) && (!selectedEmployeeId || req.staffId === selectedEmployeeId);
                });

                const pending = filtered.filter(req => req.status === 'Pending').sort((a, b) => (b[submissionDateField]?.toDate() || 0) - (a[submissionDateField]?.toDate() || 0));
                const history = filtered.filter(req => req.status !== 'Pending').sort((a, b) => (b[submissionDateField]?.toDate() || 0) - (a[submissionDateField]?.toDate() || 0));
                
                return { pendingRequests: pending, historyRequests: history };
            }, [requests, selectedShop, selectedEmployeeId, filterPeriod, customDate, dateField, submissionDateField]);

            const handleOpenModal = useCallback((request = null) => { setEditingRequest(request); setModalOpen(true); }, []);
            const handleCloseModal = useCallback(() => { setEditingRequest(null); setModalOpen(false); }, []);
            
            const handleSaveRequest = useCallback(async (formData) => {
                const { doc, addDoc, updateDoc, collection, serverTimestamp } = window.firebaseSDK;
                const staffName = employees.find(e => e.id === formData.staffId)?.name || '';
                try {
                    if (formData.id) { 
                        const { id, ...dataToUpdate } = formData; 
                        await updateDoc(doc(db, collectionName, id), { ...dataToUpdate, staffName }); 
                    } else { 
                        const dataToAdd = { ...formData, staffName, status: 'Pending' };
                        dataToAdd[submissionDateField] = serverTimestamp();
                        await addDoc(collection(db, collectionName), dataToAdd); 
                    }
                    handleCloseModal();
                } catch (error) { console.error(`Error saving ${title}:`, error); }
            }, [db, employees, handleCloseModal, collectionName, title, submissionDateField]);

            const handleUpdateRequestStatus = useCallback(async (id, status) => {
                const { doc, updateDoc } = window.firebaseSDK;
                const dataToUpdate = { status };
                if (status === 'Approved') {
                    const now = new Date();
                    const formattedTimestamp = `${String(now.getDate()).padStart(2, '0')}/${String(now.getMonth() + 1).padStart(2, '0')} | ${now.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: true })}`;
                    dataToUpdate.approvalTimestamp = formattedTimestamp;
                }
                try { await updateDoc(doc(db, collectionName, id), dataToUpdate); } 
                catch (error) { console.error(`Error updating status for ${title} ${id}:`, error); }
            }, [db, collectionName, title]);

            const confirmDelete = useCallback(async () => {
                if (!requestToDelete) return;
                try { await window.firebaseSDK.deleteDoc(window.firebaseSDK.doc(db, collectionName, requestToDelete)); } 
                catch (error) { console.error(`Error deleting ${title} ${requestToDelete}:`, error); } 
                finally { setRequestToDelete(null); }
            }, [db, requestToDelete, collectionName, title]);

            return (
                <Card>
                    <RequestFilters
                        title={title}
                        userProfile={userProfile}
                        shops={shops}
                        employeesInShop={employeesInShop}
                        selectedShop={selectedShop}
                        setSelectedShop={setSelectedShop}
                        selectedEmployeeId={selectedEmployeeId}
                        setSelectedEmployeeId={setSelectedEmployeeId}
                        filterPeriod={filterPeriod}
                        setFilterPeriod={setFilterPeriod}
                        customDate={customDate}
                        setCustomDate={setCustomDate}
                        onNewRequest={() => handleOpenModal()}
                    />
                    <PendingRequestsGrid
                        requests={pendingRequests}
                        userProfile={userProfile}
                        config={config}
                        onUpdateStatus={handleUpdateRequestStatus}
                        onEdit={handleOpenModal}
                        onDelete={setRequestToDelete}
                    />
                    <RequestHistoryTable
                        requests={historyRequests}
                        title={title}
                        config={config}
                        onEdit={handleOpenModal}
                        onDelete={setRequestToDelete}
                        onViewReason={setReasonToView}
                    />
                    {/* REFACTORED: Removed shops and employees props as the modal now gets them from context */}
                    <ModalComponent isOpen={isModalOpen} onClose={handleCloseModal} onSave={handleSaveRequest} request={editingRequest} userProfile={userProfile} />
                    <ConfirmationModal isOpen={!!requestToDelete} onClose={() => setRequestToDelete(null)} onConfirm={confirmDelete} title={`Delete ${title}`} message={`Are you sure you want to permanently delete this ${title.toLowerCase()}?`} />
                    <Modal isOpen={!!reasonToView} onClose={() => setReasonToView(null)} maxWidth="max-w-md">
                        <ModalHeader title={`${title} Reason`} onClose={() => setReasonToView(null)} />
                        <ModalBody><p className="text-slate-300">{reasonToView}</p></ModalBody>
                        <ModalFooter><Button variant="secondary" onClick={() => setReasonToView(null)}>Close</Button></ModalFooter>
                    </Modal>
                </Card>
            );
        };
        
        // --- START EMPLOYEE STATE COMPONENTS (RESTORED) ---
        
        const EmployeeStateModal = ({ isOpen, onClose, onSave, record, userProfile }) => {
            const [formData, setFormData] = useState({});
            const { shops, employees } = useAppData();
            const isManagerial = userProfile?.role === 'Admin' || userProfile?.role === 'Shop Manager';

            const employeesInShop = useMemo(() => {
                if (!formData.shop) return [];
                return employees.filter(emp => {
                    const employeeShops = Array.isArray(emp.shop) ? emp.shop : [emp.shop];
                    return employeeShops.includes(formData.shop) && emp.status === 'Active';
                });
            }, [formData.shop, employees]);

            const availableShopsForModal = useAllowedShops(userProfile, shops);

            useEffect(() => {
                if (isOpen) {
                    setFormData(record ? { ...record } : {
                        date: new Date().toISOString().slice(0, 10),
                        shop: isManagerial ? '' : (Array.isArray(userProfile.shop) ? userProfile.shop[0] : userProfile.shop || ''),
                        staffId: isManagerial ? '' : (userProfile.id || ''),
                        staffName: isManagerial ? '' : (userProfile.name || ''),
                        statusState: 'Engagement',
                        amount: '',
                        note: '',
                        status: 'Pending'
                    });
                }
            }, [isOpen, record, userProfile, isManagerial]);

            const handleChange = (e) => {
                const { name, value } = e.target;
                setFormData(prev => {
                    const newData = { ...prev, [name]: value };
                    if (name === 'shop') {
                        newData.staffId = ''; newData.staffName = '';
                    }
                    if (name === 'staffId') {
                        const emp = employees.find(e => e.id === value);
                        if (emp) newData.staffName = emp.name;
                    }
                    return newData;
                });
            };

            const handleSubmit = (e) => {
                e.preventDefault();
                onSave({ ...formData, amount: parseFloat(formData.amount) });
            };

            return (
                <Modal isOpen={isOpen} onClose={onClose}>
                    {/* FIX: Added 'flex flex-col h-full overflow-hidden' to ensure proper scrolling and keep footer visible */}
                    <form onSubmit={handleSubmit} className="flex flex-col h-full overflow-hidden">
                        <ModalHeader title={record ? "Edit Record" : "Add Engagement/Deduction"} onClose={onClose} />
                        <ModalBody>
                            <div className="space-y-4">
                                <div className="grid grid-cols-2 gap-4">
                                    <div>
                                        <label className="text-sm font-medium text-slate-400">
                                            <i className="fas fa-calendar-day mr-2 text-blue-400"></i>Date
                                        </label>
                                        {/* FIX: Added || '' to value to prevent uncontrolled input warning */}
                                        <input type="date" name="date" value={formData.date || ''} onChange={handleChange} className="input" required />
                                    </div>
                                    <div>
                                        <label className="text-sm font-medium text-slate-400">
                                            <i className="fas fa-tag mr-2 text-purple-400"></i>Type
                                        </label>
                                        {/* FIX: Added || 'Engagement' default */}
                                        <select name="statusState" value={formData.statusState || 'Engagement'} onChange={handleChange} className="select">
                                            <option value="Engagement">Engagement (Bonus)</option>
                                            <option value="Deduction">Deduction (Fine)</option>
                                        </select>
                                    </div>
                                </div>
                                
                                {isManagerial ? (
                                    <div>
                                        <label className="text-sm font-medium text-slate-400">
                                            <i className="fas fa-store mr-2 text-cyan-400"></i>Shop
                                        </label>
                                        {/* FIX: Added || '' */}
                                        <select name="shop" value={formData.shop || ''} onChange={handleChange} className="select" required>
                                            <option value="">Select Shop</option>
                                            {availableShopsForModal.map(s => <option key={s.id} value={s.name}>{s.name}</option>)}
                                        </select>
                                    </div>
                                ) : (
                                    /* FIX: Added || '' */
                                    <input value={formData.shop || ''} className="input" disabled />
                                )}

                                {isManagerial && !record ? (
                                    <div>
                                        <label className="text-sm font-medium text-slate-400">
                                            <i className="fas fa-user mr-2 text-emerald-400"></i>Staff
                                        </label>
                                        {/* FIX: Added || '' */}
                                        <select name="staffId" value={formData.staffId || ''} onChange={handleChange} className="select" required disabled={!formData.shop}>
                                            <option value="">Select Staff</option>
                                            {employeesInShop.map(e => <option key={e.id} value={e.id}>{e.name}</option>)}
                                        </select>
                                    </div>
                                ) : (
                                    /* FIX: Added || '' */
                                    <input value={formData.staffName || ''} className="input" disabled />
                                )}

                                <div>
                                    <label className="text-sm font-medium text-slate-400">
                                        <i className="fas fa-money-bill-wave mr-2 text-green-400"></i>Amount (KHR)
                                    </label>
                                    {/* FIX: Added || '' */}
                                    <input type="number" name="amount" value={formData.amount || ''} onChange={handleChange} className="input font-bold text-orange-400" required />
                                </div>
                                <div>
                                    <label className="text-sm font-medium text-slate-400">
                                        <i className="fas fa-sticky-note mr-2 text-slate-400"></i>Note
                                    </label>
                                    {/* FIX: Added || '' */}
                                    <textarea name="note" value={formData.note || ''} onChange={handleChange} className="input" rows="2" required></textarea>
                                </div>
                            </div>
                        </ModalBody>
                        <ModalFooter>
                            <Button variant="secondary" onClick={onClose}>Cancel</Button>
                            <Button type="submit" variant="primary">Save</Button>
                        </ModalFooter>
                    </form>
                </Modal>
            );
        };

        const EmployeeStateTab = ({ userProfile }) => {
            const { db } = useFirebase();
            const { shops } = useAppData();
            const [selectedShop, setSelectedShop] = useState('');
            const [searchTerm, setSearchTerm] = useState('');
            // NEW: State for Month Filter (Defaults to current month)
            const [selectedMonth, setSelectedMonth] = useState(new Date().toISOString().slice(0, 7));
            // NEW: State for Status Filter
            const [filterStatus, setFilterStatus] = useState('All');
            
            const [isModalOpen, setIsModalOpen] = useState(false);
            const [editingRecord, setEditingRecord] = useState(null);
            const [recordToDelete, setRecordToDelete] = useState(null);

            // Set initial shop
            useEffect(() => {
                if (userProfile && userProfile.role !== 'Admin' && userProfile.role !== 'CEO') {
                    setSelectedShop(Array.isArray(userProfile.shop) ? '' : userProfile.shop || '');
                }
            }, [userProfile]);

            const queryConstraints = useMemo(() => {
                const { where } = window.firebaseSDK;
                if (!userProfile) return [where("shop", "==", "null")];
                if (userProfile.role === 'Admin' || userProfile.role === 'CEO') return [];
                if (userProfile.role === 'Shop Manager') {
                    const managedShops = Array.isArray(userProfile.shop) ? userProfile.shop : (userProfile.shop ? [userProfile.shop] : []);
                    return managedShops.length > 0 ? [where("shop", "in", managedShops)] : [where("shop", "==", "null")];
                }
                return [where("staffId", "==", userProfile.id)];
            }, [userProfile]);

            const { data: records, loading } = useCollection('employeeStates', queryConstraints);

            const filteredRecords = useMemo(() => {
                return records.filter(r => {
                    // 1. Shop Filter
                    if (selectedShop && r.shop !== selectedShop) return false;
                    
                    // 2. Search Filter
                    if (searchTerm && !r.staffName.toLowerCase().includes(searchTerm.toLowerCase())) return false;
                    
                    // 3. Status Filter
                    if (filterStatus !== 'All' && r.status !== filterStatus) return false;

                    // 4. Month Filter (Smart Logic)
                    // If viewing "Pending" or "All Status", we strictly obey the Month filter 
                    // UNLESS the specific status is 'Pending', in which case we show it regardless of date 
                    // so it doesn't get lost in the backlog.
                    const isPending = r.status === 'Pending';
                    const matchesMonth = !selectedMonth || r.date.startsWith(selectedMonth);
                    
                    // Show if: (It matches the month) OR (We are filtering for Pending items specifically) OR (The item itself is pending)
                    return matchesMonth || filterStatus === 'Pending' || isPending;
                }).sort((a,b) => b.date.localeCompare(a.date));
            }, [records, selectedShop, searchTerm, selectedMonth, filterStatus]);

            const handleSave = async (formData) => {
                const { addDoc, updateDoc, doc, collection, serverTimestamp } = window.firebaseSDK;
                const { id, ...data } = formData;
                
                // MODIFIED: Auto-approve Deductions (No approval needed)
                if (data.statusState === 'Deduction') {
                    data.status = 'Approved';
                }

                try {
                    if (id) await updateDoc(doc(db, 'employeeStates', id), data);
                    else await addDoc(collection(db, 'employeeStates'), { ...data, createdAt: serverTimestamp() });
                    setIsModalOpen(false);
                    setEditingRecord(null);
                } catch (error) { console.error("Error saving record:", error); }
            };

            const handleDelete = async () => {
                if (!recordToDelete) return;
                try {
                    await window.firebaseSDK.deleteDoc(window.firebaseSDK.doc(db, 'employeeStates', recordToDelete.id));
                    setRecordToDelete(null);
                } catch (error) { console.error("Error deleting record:", error); }
            };

            const handleUpdateStatus = async (record, status) => {
                try {
                    await window.firebaseSDK.updateDoc(window.firebaseSDK.doc(db, 'employeeStates', record.id), { status });
                } catch (error) { console.error("Error updating status:", error); }
            };

            const canManage = userProfile?.role === 'Admin' || userProfile?.role === 'CEO' || userProfile?.role === 'Shop Manager';

            return (
                <Card>
                    <PageHeader title="Engagements & Deductions">
                        <SearchInput value={searchTerm} onChange={e => setSearchTerm(e.target.value)} />
                        <ShopFilterSelect userProfile={userProfile} shops={shops} selectedShop={selectedShop} onChange={e => setSelectedShop(e.target.value)} />
                        
                        <input 
                            type="month" 
                            value={selectedMonth} 
                            onChange={e => setSelectedMonth(e.target.value)} 
                            className="input w-full sm:w-auto" 
                        />

                        {/* NEW: Status Filter Dropdown */}
                        <select 
                            value={filterStatus} 
                            onChange={e => setFilterStatus(e.target.value)} 
                            className="select w-full sm:w-auto"
                        >
                            <option value="All">All Status</option>
                            <option value="Pending">Pending</option>
                            <option value="Approved">Approved</option>
                            <option value="Rejected">Rejected</option>
                        </select>

                        {canManage && <Button variant="primary" icon="fa-plus" onClick={() => { setEditingRecord(null); setIsModalOpen(true); }}>Add Record</Button>}
                    </PageHeader>

                    {loading ? <div className="text-center py-10"><i className="fas fa-spinner fa-spin text-3xl"></i></div> : (
                        <div className="overflow-x-auto">
                            <table className="min-w-full divide-y divide-slate-700">
                                <thead className="bg-slate-900/50">
                                    <tr>
                                        <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Date</th>
                                        <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Staff</th>
                                        <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Type</th>
                                        <th className="px-4 py-3 text-right text-xs font-semibold text-slate-400 uppercase">Amount</th>
                                        <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Note</th>
                                        <th className="px-4 py-3 text-center text-xs font-semibold text-slate-400 uppercase">Status</th>
                                        <th className="px-4 py-3 text-center text-xs font-semibold text-slate-400 uppercase">Actions</th>
                                    </tr>
                                </thead>
                                <tbody className="divide-y divide-slate-700">
                                    {filteredRecords.map(rec => (
                                        <tr key={rec.id} className="hover:bg-slate-700/50">
                                            <td className="px-4 py-4 text-sm text-slate-300">{Utils.formatISOToDisplay(rec.date)}</td>
                                            <td className="px-4 py-4 text-sm text-slate-200">{rec.staffName}</td>
                                            <td className="px-4 py-4 text-sm"><span className={`px-2 py-1 text-xs rounded-full ${rec.statusState === 'Engagement' ? 'bg-green-900 text-green-300' : 'bg-red-900 text-red-300'}`}>{rec.statusState}</span></td>
                                            <td className="px-4 py-4 text-sm text-right font-bold text-orange-300">{Utils.formatCurrency(rec.amount)}</td>
                                            <td className="px-4 py-4 text-sm text-slate-300">{rec.note}</td>
                                            <td className="px-4 py-4 text-center text-sm"><span className={`px-2 py-1 text-xs rounded-full ${rec.status === 'Approved' ? 'bg-green-200 text-green-900' : 'bg-yellow-200 text-yellow-900'}`}>{rec.status}</span></td>
                                            <td className="px-4 py-4 text-center">
                                                <div className="flex items-center justify-center gap-2">
                                                    {(canManage && rec.status === 'Pending') && (
                                                        <>
                                                            <Button variant="icon-approve" icon="fa-check" onClick={() => handleUpdateStatus(rec, 'Approved')} />
                                                            <Button variant="icon-reject" icon="fa-times" onClick={() => handleUpdateStatus(rec, 'Rejected')} />
                                                        </>
                                                    )}
                                                    {canManage && (
                                                        <>
                                                            <Button variant="icon-edit" icon="fa-edit" onClick={() => { setEditingRecord(rec); setIsModalOpen(true); }} />
                                                            <Button variant="icon-delete" icon="fa-trash" onClick={() => setRecordToDelete(rec)} />
                                                        </>
                                                    )}
                                                </div>
                                            </td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                    )}
                    <EmployeeStateModal isOpen={isModalOpen} onClose={() => setIsModalOpen(false)} onSave={handleSave} record={editingRecord} userProfile={userProfile} />
                    <ConfirmationModal isOpen={!!recordToDelete} onClose={() => setRecordToDelete(null)} onConfirm={handleDelete} title="Delete Record" message="Are you sure you want to delete this record?" />
                </Card>
            );
        };
        // --- END EMPLOYEE STATE COMPONENTS ---
        
        // Component: Main CheckInMe Page (Tab Container)
        const CheckInMePage = ({ userProfile, initialTab = 'checkInOut', pendingLeaves = [], pendingOTs = [] }) => {
            // FIX: Split prop into ID, Action, and Timestamp to handle unique events
            const [propTabId, propAction, propTs] = initialTab ? initialTab.split(':') : ['checkInOut', null, null];
            
            const { db } = useFirebase();
            const { moduleConfig = {} } = useAppData();
            const [activeTab, setActiveTab] = useState('checkInOut');
            
            // NEW: State to track which quick action ID has already been handled (consumed)
            const [handledActionId, setHandledActionId] = useState(null);

            // NEW: State for Pending Employee States (Engagements/Deductions) Count
            const [pendingStatesCount, setPendingStatesCount] = useState(0);

            // Fetch pending states count for badge
            useEffect(() => {
                if (!db || !userProfile) return;
                // Only managers need this count
                if (userProfile.role !== 'Admin' && userProfile.role !== 'Shop Manager' && userProfile.role !== 'CEO') return;

                const { collection, query, where, onSnapshot } = window.firebaseSDK;
                const q = query(collection(db, 'employeeStates'), where('status', '==', 'Pending'));
                
                const unsub = onSnapshot(q, (snap) => {
                    // Filter in memory for shop managers to avoid index issues
                    const count = snap.docs.filter(doc => {
                        const d = doc.data();
                        if (d.statusState !== 'Engagement') return false; // Only count Engagements if desired, or all pending states
                        
                        if (userProfile.role === 'Admin' || userProfile.role === 'CEO') return true;
                        if (userProfile.role === 'Shop Manager') {
                            const shops = Array.isArray(userProfile.shop) ? userProfile.shop : [userProfile.shop];
                            return shops.includes(d.shop);
                        }
                        return false;
                    }).length;
                    setPendingStatesCount(count);
                });
                return () => unsub();
            }, [db, userProfile]);

            // Sync active tab when initialTab prop changes
            useEffect(() => {
                if (propTabId) setActiveTab(propTabId);
            }, [initialTab, propTabId]);
            
            // Helper to determine if we should auto-open a modal
            const shouldAutoOpen = (tabKey) => {
                if (propTabId !== tabKey || !propAction) return false;
                const actionId = `${propTabId}:${propAction}:${propTs}`;
                return actionId !== handledActionId;
            };

            const handleActionProcessed = () => {
                const actionId = `${propTabId}:${propAction}:${propTs}`;
                setHandledActionId(actionId);
            };

            // --- RESTORED: Configuration Objects (Fixes ReferenceError) ---
            const leaveRequestConfig = {
                collectionName: 'leaveRequests',
                title: 'Leave Request',
                ModalComponent: LeaveRequestModal,
                dateField: 'leaveDate',
                submissionDateField: 'requestDate',
                cardFields: [
                    { label: 'Leave Type', value: (req) => req.leaveType },
                    { label: 'Session', value: (req) => req.leaveSession },
                    // MODIFIED: Swapped Leave Date (first) and Return Date (second)
                    { label: 'Leave Date', value: (req) => Utils.formatISOToDisplay(req.leaveDate) },
                    { label: 'Return Date', value: (req) => Utils.formatISOToDisplay(req.returnDate) },
                    { label: 'Duration', value: (req) => `${req.numberOfDays} Day(s)` }
                ],
                tableColumns: [
                    { header: 'Request Date', accessor: (req) => Utils.formatRequestDate(req.requestDate) },
                    { header: 'Staff Name', accessor: 'staffName' },
                    { header: 'Shop', accessor: 'shop' },
                    { header: 'Leave Type', accessor: 'leaveType' },
                    // MODIFIED: Split Date into Leave Date and Return Date columns
                    { header: 'Leave Date', accessor: (req) => Utils.formatISOToDisplay(req.leaveDate) },
                    { header: 'Return Date', accessor: (req) => Utils.formatISOToDisplay(req.returnDate) },
                    { header: 'Session', accessor: 'leaveSession' },
                    { header: 'Duration', accessor: (req) => `${req.numberOfDays} Day(s)` }
                ]
            };

            const otRequestConfig = {
                collectionName: 'otRequests',
                title: 'OT Request',
                ModalComponent: OTRequestModal,
                dateField: 'reqDate',
                submissionDateField: 'submissionDate',
                cardFields: [
                    { label: 'OT Date', value: (req) => Utils.formatISOToDisplay(req.reqDate) },
                    // MODIFIED: Display Session, fallback to Time if legacy data
                    { label: 'Session', value: (req) => req.session || (req.startTime ? `${req.startTime} - ${req.endTime}` : 'N/A') },
                    { label: 'Duration', value: (req) => `${req.numberOfOTDays} Day(s)` }
                ],
                tableColumns: [
                    { header: 'Submission Date', accessor: (req) => Utils.formatRequestDate(req.submissionDate) },
                    { header: 'Staff Name', accessor: 'staffName' },
                    { header: 'Shop', accessor: 'shop' },
                    { header: 'OT Date', accessor: (req) => Utils.formatISOToDisplay(req.reqDate) },
                    // MODIFIED: Display Session
                    { header: 'Session', accessor: (req) => req.session || (req.startTime ? `${req.startTime} - ${req.endTime}` : 'N/A') },
                    { header: 'Duration', accessor: (req) => `${req.numberOfOTDays} Day(s)` }
                ]
            };
            // --- END RESTORED CONFIG ---

            const canManage = userProfile?.role === 'Admin' || userProfile?.role === 'CEO' || userProfile?.role === 'Shop Manager';

            // MODIFIED: Define tabs dynamically based on config
            const tabs = useMemo(() => {
                const available = {};
                const isEnabled = (key) => moduleConfig?.[key] !== false;

                if (isEnabled('checkinme:checkInOut')) {
                    available.checkInOut = <span><i className="fas fa-fingerprint mr-2 text-blue-400"></i>Check In/Out</span>;
                }
                
                if (isEnabled('checkinme:leaveRequest')) {
                    available.leaveRequest = (
                        <span className="flex items-center gap-2">
                            <span><i className="fas fa-calendar-minus mr-1 text-orange-400"></i>Leave Request</span>
                            {canManage && pendingLeaves.length > 0 && (
                                <span className="bg-red-500 text-white text-[10px] font-bold px-1.5 py-0.5 rounded-full animate-pulse shadow-sm">
                                    {pendingLeaves.length}
                                </span>
                            )}
                        </span>
                    );
                }

                if (isEnabled('checkinme:otRequest')) {
                    available.otRequest = (
                        <span className="flex items-center gap-2">
                            <span><i className="fas fa-clock mr-1 text-purple-400"></i>OT Request</span>
                            {canManage && pendingOTs.length > 0 && (
                                <span className="bg-red-500 text-white text-[10px] font-bold px-1.5 py-0.5 rounded-full animate-pulse shadow-sm">
                                    {pendingOTs.length}
                                </span>
                            )}
                        </span>
                    );
                }

                if (isEnabled('checkinme:employeeState')) {
                    available.employeeState = (
                        <span className="flex items-center gap-2">
                            <span><i className="fas fa-file-contract mr-1 text-yellow-400"></i>Engagements / Deductions</span>
                            {canManage && pendingStatesCount > 0 && (
                                <span className="bg-red-500 text-white text-[10px] font-bold px-1.5 py-0.5 rounded-full animate-pulse shadow-sm">
                                    {pendingStatesCount}
                                </span>
                            )}
                        </span>
                    );
                }
                
                return available;
            }, [moduleConfig, canManage, pendingLeaves.length, pendingOTs.length, pendingStatesCount]);

            // Ensure valid active tab
            useEffect(() => {
                const keys = Object.keys(tabs);
                // If current activeTab is not in available tabs, switch to first available
                if (keys.length > 0 && !tabs[activeTab]) {
                    setActiveTab(keys[0]);
                }
            }, [tabs, activeTab]);

            return (
                <TabbedPage tabs={tabs} activeTab={activeTab} setActiveTab={setActiveTab}>
                    {tabs.checkInOut && <div id="checkInOut"><CheckInOutTab userProfile={userProfile} /></div>}
                    {tabs.leaveRequest && (
                        <div id="leaveRequest">
                            <RequestManagementTab 
                                userProfile={userProfile} 
                                config={leaveRequestConfig} 
                                autoOpenNew={shouldAutoOpen('leaveRequest')} 
                                onAutoOpenProcessed={handleActionProcessed}
                            />
                        </div>
                    )}
                    {tabs.otRequest && (
                        <div id="otRequest">
                            <RequestManagementTab 
                                userProfile={userProfile} 
                                config={otRequestConfig} 
                                autoOpenNew={shouldAutoOpen('otRequest')} 
                                onAutoOpenProcessed={handleActionProcessed}
                            />
                        </div>
                    )}
                    {tabs.employeeState && <div id="employeeState"><EmployeeStateTab userProfile={userProfile} /></div>}
                </TabbedPage>
            );
        };
        // --- END CHECKINME PAGE COMPONENTS ---

        // --- START ATTENDANCE REPORT PAGE ---

        // NEW: Phase 1 Refactoring - Daily Report Filters Component
        // OPTIMIZATION: Updated to use standard PageHeader style internally
        const DailyReportFilters = memo(({
            userProfile, selectedShop, setSelectedShop, searchTerm, setSearchTerm, availableShops,
            filterType, setFilterType, customMonth, setCustomMonth,
            selectedShift, setSelectedShift, uniqueShiftNames, onExportExcel
        }) => {
            return (
                <div className="flex flex-wrap gap-4 justify-between items-center mb-6">
                    <h3 className="text-xl font-semibold text-slate-100">Daily Attendance Report</h3>
                    <div className="flex flex-wrap gap-4 items-center">
                        <ShopFilterSelect 
                            userProfile={userProfile}
                            shops={availableShops} // Pass pre-calculated allowed shops
                            selectedShop={selectedShop}
                            onChange={e => { setSelectedShop(e.target.value); setSearchTerm(''); }}
                        />
                        
                        {userProfile?.role !== 'Staff' && (
                            <SearchInput 
                                value={searchTerm} 
                                onChange={e => setSearchTerm(e.target.value)} 
                                placeholder="Search staff..."
                            />
                        )}
                        
                        <select value={filterType} onChange={e => setFilterType(e.target.value)} className="select w-full sm:w-auto">
                            <option value="today">Today</option>
                            <option value="yesterday">Yesterday</option>
                            <option value="thisMonth">This Month</option>
                            <option value="lastMonth">Last Month</option>
                            <option value="custom">Custom Month</option>
                        </select>
                        
                        {filterType === 'custom' && (
                            <input type="month" value={customMonth} onChange={e => setCustomMonth(e.target.value)} className="input w-full sm:w-auto" />
                        )}
                        
                        <select value={selectedShift} onChange={e => setSelectedShift(e.target.value)} className="select w-full sm:w-auto">
                            <option value="">All Shifts</option>
                            {uniqueShiftNames.map(name => <option key={name} value={name}>{name}</option>)}
                        </select>
                        
                        <Button variant="success" icon="fa-file-excel" onClick={onExportExcel}>Excel</Button>
                    </div>
                </div>
            );
        });
        
        // NEW: Phase 1 Refactoring - Daily Report Table Component
        const DailyReportTable = memo(({ attendanceReport, userProfile, onAddCheckOut, onDeleteRecord }) => {
            return (
                <div className="overflow-x-auto">
                    <table className="min-w-full divide-y divide-slate-700">
                        <thead className="bg-slate-900/50">
                            <tr>
                                <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Date</th>
                                <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Shop Name</th>
                                <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Staff Name</th>
                                <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Shift</th>
                                <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Check In</th>
                                <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Check Out</th>
                                <th className="px-4 py-3 text-center text-xs font-semibold text-slate-400 uppercase">Leave Status</th>
                                <th className="px-4 py-3 text-center text-xs font-semibold text-slate-400 uppercase">OT Status</th>
                                {/* NEW: Device Info Column for Admins/Managers */}
                                {(userProfile.role !== 'Staff') && (
                                    <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Device Used</th>
                                )}
                                <th className="px-4 py-3 text-center text-xs font-semibold text-slate-400 uppercase">Actions</th>
                            </tr>
                        </thead>
                        <tbody className="divide-y divide-slate-700">
                            {attendanceReport.map((report) => (
                                <tr key={`${report.employeeId}-${report.date}`} className="transition-colors hover:bg-slate-700/50">
                                    <td className="px-4 py-4 text-sm text-slate-200">{report.date}</td>
                                    <td className="px-4 py-4 text-sm text-slate-300">{report.shop}</td>
                                    <td className="px-4 py-4 text-sm text-slate-200">{report.employeeName}</td>
                                    <td className="px-4 py-4 text-sm text-slate-300">{report.shift}</td>
                                    <td className={`px-4 py-4 text-sm ${report.isLate ? 'bg-red-900/60 text-red-300 font-semibold' : 'text-slate-300'}`}>{report.checkIn}</td>
                                    <td className="px-4 py-4 text-sm text-slate-300">{report.checkOut}</td>
                                    <td className={`px-4 py-4 text-sm text-center ${report.isOnLeave === 'Absent' ? 'text-red-400 font-semibold' : 'text-slate-300'}`}>{report.isOnLeave}</td>
                                    <td className="px-4 py-4 text-sm text-center text-slate-300">{report.otStatus}</td>
                                    
                                    {/* NEW: Display Device Info */}
                                    {(userProfile.role !== 'Staff') && (
                                        <td className="px-4 py-4 text-xs text-slate-400 font-mono">
                                            {report.deviceModel && report.deviceModel !== 'Unknown' ? (
                                                <span title={report.devicePlatform || ''} className="text-blue-300">{report.deviceModel}</span>
                                            ) : (
                                                <span className="opacity-30">-</span>
                                            )}
                                        </td>
                                    )}

                                    <td className="px-4 py-4 text-center whitespace-nowrap">
                                        <div className="flex items-center justify-center gap-4">
                                            {(userProfile?.role === 'Admin' || userProfile?.role === 'CEO') && report.checkIn && !report.checkOut && (
                                                <Button variant="icon-add-time" icon="fa-clock" onClick={() => onAddCheckOut(report)} title="Add Check-Out"/>
                                            )}
                                            {(userProfile?.role === 'Admin' || userProfile?.role === 'CEO') && report.docIds.length > 0 && (
                                                <Button variant="icon-delete" icon="fa-trash" onClick={() => onDeleteRecord(report)} title="Delete" />
                                            )}
                                        </div>
                                    </td>
                                </tr>
                            ))}
                        </tbody>
                    </table>
                </div>
            );
        });

        // NEW: Phase 1 Refactoring - Work Day Report Filters Component
        // OPTIMIZATION: Updated to use standard PageHeader style internally
        const WorkDayReportFilters = memo(({
            userProfile, selectedShop, setSelectedShop, searchTerm, setSearchTerm, availableShops,
            filterType, setFilterType, selectedMonth, setSelectedMonth,
            selectedShift, setSelectedShift, uniqueShiftNames, onExportExcel
        }) => {
            return (
                <div className="flex flex-wrap gap-4 justify-between items-center mb-6">
                    <h3 className="text-xl font-semibold text-slate-100">Monthly Work Day Report</h3>
                    <div className="flex flex-wrap gap-4 items-center">
                        <ShopFilterSelect 
                            userProfile={userProfile}
                            shops={availableShops} // Pass pre-calculated allowed shops
                            selectedShop={selectedShop}
                            onChange={e => { setSelectedShop(e.target.value); setSearchTerm(''); }}
                        />

                        {userProfile?.role !== 'Staff' && (
                            <SearchInput 
                                value={searchTerm} 
                                onChange={e => setSearchTerm(e.target.value)} 
                                placeholder="Search staff..."
                            />
                        )}

                        <select value={filterType} onChange={e => setFilterType(e.target.value)} className="select w-full sm:w-auto">
                            <option value="thisMonth">This Month</option>
                            <option value="lastMonth">Last Month</option>
                            <option value="custom">Custom Month</option>
                        </select>
                        
                        {filterType === 'custom' && (
                            <input type="month" value={selectedMonth} onChange={e => setSelectedMonth(e.target.value)} className="input w-full sm:w-auto" />
                        )}
                        
                        <select value={selectedShift} onChange={e => setSelectedShift(e.target.value)} className="select w-full sm:w-auto">
                            <option value="">All Shifts</option>
                            {uniqueShiftNames.map(name => <option key={name} value={name}>{name}</option>)}
                        </select>
                        
                        <Button variant="success" icon="fa-file-excel" onClick={onExportExcel}>Excel</Button>
                    </div>
                </div>
            );
        });

        // NEW: Phase 1 Refactoring - Work Day Report Table Component
        const WorkDayReportTable = memo(({ workDayReport }) => {
            return (
                <div className="overflow-x-auto">
                    <table className="min-w-full divide-y divide-slate-700">
                        <thead className="bg-slate-900/50">
                            <tr>
                                <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Date</th>
                                <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Shop Name</th>
                                <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Staff Name</th>
                                <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">No. Work Day</th>
                                <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Given Off Day</th>
                                <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Total OT</th>
                                <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Total Leave No</th>
                                <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Total LATE</th>
                                <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">No-CheckOut</th>
                                <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">No-Absent</th>
                                <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Salary Day</th>
                            </tr>
                        </thead>
                        <tbody className="divide-y divide-slate-700">
                            {workDayReport.map((report, index) => (
                                <tr key={`${report.staffName}-${report.dueTime}-${index}`} className="hover:bg-slate-700/50">
                                    <td className="px-4 py-4 text-sm text-slate-200">{report.dueTime}</td>
                                    <td className="px-4 py-4 text-sm text-slate-300">{report.shopName}</td>
                                    <td className="px-4 py-4 text-sm text-slate-200">{report.staffName}</td>
                                    <td className="px-4 py-4 text-sm font-semibold text-blue-400">{report.workDays}</td>
                                    <td className="px-4 py-4 text-sm font-semibold text-cyan-400">{report.givenOffDays}</td>
                                    <td className="px-4 py-4 text-sm font-semibold text-green-400">{report.totalOT > 0 ? report.totalOT.toFixed(2) : 0}</td>
                                    <td className="px-4 py-4 text-sm font-semibold text-yellow-400">{report.totalLeave}</td>
                                    <td className="px-4 py-4 text-sm font-semibold text-red-400">{report.totalLate}</td>
                                    <td className="px-4 py-4 text-sm font-semibold text-orange-400">{report.noCheckOutCount}</td>
                                    <td className="px-4 py-4 text-sm font-semibold text-red-500">{report.noAbsentCount}</td>
                                    <td className="px-4 py-4 text-sm font-semibold text-indigo-400">{report.salaryDay.toFixed(2)}</td>
                                </tr>
                            ))}
                        </tbody>
                    </table>
                </div>
            );
        });

         const AttendanceReportPage = ({ userProfile }) => {
            // NEW: Get module config
            const { moduleConfig = {} } = useAppData();
            const [activeTab, setActiveTab] = useState(''); // Default empty

            const { db } = useFirebase();
            const { where, query, collection, getDocs } = window.firebaseSDK;
            const [reportData, setReportData] = useState({ leaveRequests: [], otRequests: [] });
            const [loading, setLoading] = useState(false);

            // PHASE 3 OPTIMIZATION: For Admins/CEOs AND Shop Managers, we now fetch this data on-demand.
            // FIX: Only 'Staff' role should use real-time listeners for reports. 
            // Managers viewing 44+ people should fetch strictly by date range to save quota.
            const isRealTime = userProfile?.role === 'Staff';
            
            const staffQueryConstraints = useMemo(() => {
                const { role, id, shop } = userProfile || {};
                if (role === 'Staff' && id) {
                    return [where("staffId", "==", id)];
                }
                // Managers & Admins return empty here because they use the on-demand fetch in the child components
                return []; 
            }, [userProfile]);
            
            // Real-time data for Staff Only
            const { data: realTimeLeaveRequests } = useCollection('leaveRequests', isRealTime ? staffQueryConstraints : []);
            const { data: realTimeOtRequests } = useCollection('otRequests', isRealTime ? staffQueryConstraints : []);
            
            // On-demand data for Admins/Managers (passed down)
            const leaveRequests = isRealTime ? realTimeLeaveRequests : reportData.leaveRequests;
            const otRequests = isRealTime ? realTimeOtRequests : reportData.otRequests;

            // MODIFIED: Filter tabs based on configuration
            const tabs = useMemo(() => {
                const available = {};
                const isEnabled = (key) => moduleConfig?.[key] !== false;

                if (isEnabled('attendanceReport:daily')) {
                    available.daily = <span><i className="fas fa-calendar-day mr-2 text-blue-400"></i>Daily Report</span>;
                }
                if (isEnabled('attendanceReport:monthly')) {
                    available.monthly = <span><i className="fas fa-briefcase mr-2 text-green-400"></i>No. Work Day</span>;
                }
                return available;
            }, [moduleConfig]);

            // Ensure we have a valid active tab
            useEffect(() => {
                const keys = Object.keys(tabs);
                if (keys.length > 0 && !tabs[activeTab]) {
                    setActiveTab(keys[0]);
                }
            }, [tabs, activeTab]);

            return (
                <TabbedPage tabs={tabs} activeTab={activeTab} setActiveTab={setActiveTab}>
                    {tabs.daily && (
                        <div id="daily"><DailyReportTab userProfile={userProfile} leaveRequests={leaveRequests} otRequests={otRequests} setAdminReportData={setReportData} setLoadingAdminReport={setLoading} isAdminLoading={loading} /></div>
                    )}
                    {tabs.monthly && (
                        <div id="monthly"><WorkDayReportTab userProfile={userProfile} leaveRequests={leaveRequests} otRequests={otRequests} setAdminReportData={setReportData} setLoadingAdminReport={setLoading} isAdminLoading={loading} /></div>
                    )}
                </TabbedPage>
            );
        };

        // NEW: Modal for manually adding a check-out time
        const ManualCheckOutModal = ({ isOpen, onClose, onSave, record }) => {
            const [checkOutTime, setCheckOutTime] = useState('');

            useEffect(() => {
                // Reset time when modal opens for a new record
                if (isOpen) {
                    setCheckOutTime('');
                }
            }, [isOpen]);
            
            const handleSubmit = (e) => {
                e.preventDefault();
                if (record && checkOutTime) {
                    onSave(record, checkOutTime);
                }
            };

            if (!record) return null;

            return (
                <Modal isOpen={isOpen} onClose={onClose} maxWidth="max-w-md">
                    <form onSubmit={handleSubmit}>
                        <ModalHeader title="Add Manual Check-Out" onClose={onClose} />
                        <ModalBody>
                            <div className="space-y-4">
                                <div>
                                    <label className="text-sm font-medium text-slate-400">Employee</label>
                                    <input value={record.employeeName} className="input" disabled />
                                </div>
                                <div>
                                    <label className="text-sm font-medium text-slate-400">Date</label>
                                    <input value={record.date} className="input" disabled />
                                </div>
                                <div>
                                    <label className="text-sm font-medium text-slate-400">Check-Out Time</label>
                                    <input
                                        type="time"
                                        value={checkOutTime}
                                        onChange={(e) => setCheckOutTime(e.target.value)}
                                        className="input"
                                        required
                                    />
                                </div>
                            </div>
                        </ModalBody>
                        <ModalFooter>
                            <Button variant="secondary" onClick={onClose}>Cancel</Button>
                            <Button type="submit" variant="primary">Save Check-Out</Button>
                        </ModalFooter>
                    </form>
                </Modal>
            );
        };

        const DailyReportTab = ({ userProfile, leaveRequests, otRequests, setAdminReportData, setLoadingAdminReport, isAdminLoading }) => {
            const { db } = useFirebase();
            const { where, query, collection, getDocs } = window.firebaseSDK;
            const [recordToDelete, setRecordToDelete] = useState(null);
            const [recordToCorrect, setRecordToCorrect] = useState(null);
            const [isCorrectionModalOpen, setCorrectionModalOpen] = useState(false);

            // Filters State
            const [selectedShop, setSelectedShop] = useState('');
            const [filterType, setFilterType] = useState('today');
            const [customMonth, setCustomMonth] = useState(new Date().toISOString().slice(0, 7));
            const [searchTerm, setSearchTerm] = useState('');
            const [selectedShift, setSelectedShift] = useState('');

            // Data State
            const { shops, employees, shifts } = useAppData();
            
            // NEW: Get unique shift names for the filter dropdown to avoid duplicates.
            const uniqueShiftNames = useMemo(() => {
                if (!shifts) return [];
                const shiftNames = shifts.map(s => s.name);
                return [...new Set(shiftNames)].sort();
            }, [shifts]);
            
            // PHASE 3: Data state for Admin's one-time fetches
            const [adminAttendance, setAdminAttendance] = useState([]);
            
            // PHASE 2 & 3: Combined logic for fetching attendance data.
            // FIX: Managers now use isRealTime = false (On Demand) to save quota
            const isRealTime = userProfile?.role === 'Staff';

            const attendanceQueryConstraints = useMemo(() => {
                // This is ONLY for real-time listeners (Staff)
                if (!isRealTime) return [where("shop", "==", "___NON_EXISTENT_SHOP___")]; 
                
                const { role, id } = userProfile || {};
                if (role === 'Staff' && id) return [where("employeeId", "==", id)];
                
                // Fallback for unexpected cases
                return [where("shop", "==", "___NON_EXISTENT_SHOP___")];
            }, [userProfile, isRealTime]);
            
            const { data: realTimeAttendance, loading: attendanceLoading } = useCollection('attendance', attendanceQueryConstraints);
            const attendance = isRealTime ? realTimeAttendance : adminAttendance;
            const isReportLoading = isRealTime ? attendanceLoading : isAdminLoading;
            
            // PHASE 3: ON-DEMAND DATA FETCHING FOR ADMIN & MANAGERS (OPTIMIZED) ---
            useEffect(() => {
                // Fetch if NOT staff
                if (userProfile?.role === 'Staff') return;

                const fetchAdminData = async () => {
                    setLoadingAdminReport(true);
                    
                    const startDate = new Date();
                    const endDate = new Date();
                    
                    switch (filterType) {
                        case 'today': startDate.setHours(0, 0, 0, 0); endDate.setHours(23, 59, 59, 999); break;
                        case 'yesterday': startDate.setDate(startDate.getDate() - 1); startDate.setHours(0, 0, 0, 0); endDate.setDate(endDate.getDate() - 1); endDate.setHours(23, 59, 59, 999); break;
                        case 'thisMonth': startDate.setDate(1); startDate.setHours(0, 0, 0, 0); endDate.setMonth(endDate.getMonth() + 1); endDate.setDate(0); endDate.setHours(23, 59, 59, 999); break;
                        case 'lastMonth': startDate.setMonth(startDate.getMonth() - 1); startDate.setDate(1); startDate.setHours(0, 0, 0, 0); endDate.setDate(0); endDate.setHours(23, 59, 59, 999); break;
                        case 'custom': const [year, month] = customMonth.split('-').map(Number); if (year && month) { startDate.setFullYear(year, month - 1, 1); startDate.setHours(0, 0, 0, 0); endDate.setFullYear(year, month, 0); endDate.setHours(23, 59, 59, 999); } break;
                    }
                    
                    // --- FIX: BUFFER FOR TIMEZONE OFFSET ---
                    const bufferStart = new Date(startDate);
                    bufferStart.setDate(bufferStart.getDate() - 1);
                    
                    const bufferEnd = new Date(endDate);
                    bufferEnd.setDate(bufferEnd.getDate() + 1);
                    
                    // --- OPTIMIZATION START: Server-Side Shop Filtering ---
                    let attendanceQuery = query(collection(db, 'attendance'), where('timestamp', '>=', bufferStart), where('timestamp', '<=', bufferEnd));
                    
                    // Leaves/OT usually span days, so we keep their logic but ensure they cover the buffer
                    let leaveQuery = query(collection(db, 'leaveRequests'), where('returnDate', '>=', bufferStart.toISOString().slice(0, 10)));
                    let otQuery = query(collection(db, 'otRequests'), where('reqDate', '>=', bufferStart.toISOString().slice(0, 10)), where('reqDate', '<=', bufferEnd.toISOString().slice(0, 10)));
                    
                    // Apply Shop Filtering Logic
                    let targetShop = selectedShop;
                    
                    // If Manager hasn't selected a shop yet, and has managed shops, we must filter by "in" or handle manually
                    if (!targetShop && userProfile.role === 'Shop Manager') {
                         const managedShops = Array.isArray(userProfile.shop) ? userProfile.shop : [userProfile.shop];
                         if (managedShops.length > 0) {
                             attendanceQuery = query(attendanceQuery, where('shop', 'in', managedShops));
                             leaveQuery = query(leaveQuery, where('shop', 'in', managedShops));
                             otQuery = query(otQuery, where('shop', 'in', managedShops));
                         } else {
                             // No shops assigned
                             setAdminAttendance([]);
                             setAdminReportData({ leaveRequests: [], otRequests: [] });
                             setLoadingAdminReport(false);
                             return;
                         }
                    } else if (targetShop) {
                        attendanceQuery = query(attendanceQuery, where('shop', '==', targetShop));
                        leaveQuery = query(leaveQuery, where('shop', '==', targetShop));
                        otQuery = query(otQuery, where('shop', '==', targetShop));
                    }
                    // --- OPTIMIZATION END ---

                    try {
                        const [attSnap, leaveSnap, otSnap] = await Promise.all([
                            getDocs(attendanceQuery),
                            getDocs(leaveQuery),
                            getDocs(otQuery)
                        ]);
                        
                        // Client-side filtering ensures exact match if complex logic needed
                        const attendanceData = attSnap.docs.map(d => ({id: d.id, ...d.data()}))
                            .filter(rec => {
                                const shopMatch = !selectedShop || rec.shop === selectedShop;
                                const empMatch = !searchTerm || (rec.employeeName && rec.employeeName.toLowerCase().includes(searchTerm.toLowerCase()));
                                return shopMatch && empMatch;
                            });
                        setAdminAttendance(attendanceData);
                        
                        const leaveData = leaveSnap.docs.map(d => ({ id: d.id, ...d.data() }))
                            .filter(lr => {
                                const shopMatch = !selectedShop || lr.shop === selectedShop;
                                const empMatch = !searchTerm || (lr.staffName && lr.staffName.toLowerCase().includes(searchTerm.toLowerCase()));
                                const dateMatch = lr.leaveDate <= endDate.toISOString().slice(0, 10);
                                return shopMatch && empMatch && dateMatch;
                            });

                        const otData = otSnap.docs.map(d => ({id: d.id, ...d.data()}))
                             .filter(rec => {
                                const shopMatch = !selectedShop || rec.shop === selectedShop;
                                const empMatch = !searchTerm || (rec.staffName && rec.staffName.toLowerCase().includes(searchTerm.toLowerCase()));
                                return shopMatch && empMatch;
                            });
                        
                        setAdminReportData({ leaveRequests: leaveData, otRequests: otData });

                    } catch (error) {
                        console.error("Error fetching report data:", error);
                    } finally {
                        setLoadingAdminReport(false);
                    }
                };
                
                fetchAdminData();

            }, [userProfile, filterType, customMonth, selectedShop, searchTerm, db, setLoadingAdminReport, setAdminReportData]);

            // Set initial shop selection
            useEffect(() => {
                if (userProfile && userProfile.role !== 'Admin' && userProfile.role !== 'CEO') {
                    setSelectedShop(Array.isArray(userProfile.shop) ? '' : userProfile.shop || '');
                }
            }, [userProfile]);
            
            const availableShops = useAllowedShops(userProfile, shops);

            const attendanceReport = useMemo(() => {
                // --- FIX: TIMEZONE AWARE FILTERING ---
                
                // 0. Pre-compute Shop Map for O(1) Timezone Lookup
                const shopsMap = new Map(shops.map(s => [s.name, s]));

                // 1. Determine the Reference Timezone
                // If a shop is selected, use that shop's timezone.
                // If not, fall back to the browser's timezone.
                let refTimezone = Intl.DateTimeFormat().resolvedOptions().timeZone;
                if (selectedShop) {
                    const s = shopsMap.get(selectedShop);
                    if (s && s.timezone) refTimezone = s.timezone;
                }

                // 2. Calculate the Target Date Strings (YYYY-MM-DD) based on that Timezone
                // This ensures "Today" means "Today at the Shop", not "Today in my Browser"
                const { localDate: nowInTz } = Utils.formatDateInTimezone({ toDate: () => new Date() }, refTimezone);
                
                let targetStartDateStr = nowInTz;
                let targetEndDateStr = nowInTz;

                switch (filterType) {
                    case 'today':
                        // target is just nowInTz
                        break;
                    case 'yesterday':
                        const d = new Date(nowInTz);
                        d.setDate(d.getDate() - 1);
                        targetStartDateStr = d.toISOString().slice(0, 10);
                        targetEndDateStr = targetStartDateStr;
                        break;
                    case 'thisMonth':
                        targetStartDateStr = nowInTz.slice(0, 7) + '-01';
                        // End date is tricky for string logic, but for month filter we can check .startsWith()
                        break;
                    case 'lastMonth':
                        const lm = new Date(nowInTz);
                        lm.setMonth(lm.getMonth() - 1);
                        targetStartDateStr = lm.toISOString().slice(0, 7) + '-01';
                        break;
                    case 'custom':
                        targetStartDateStr = customMonth + '-01';
                        break;
                }

                // 2. Get a list of employees to report on
                const relevantEmployees = employees.filter(emp => {
                    const employeeShops = Array.isArray(emp.shop) ? emp.shop : (emp.shop ? [emp.shop] : []);
                    const userManagedShops = Array.isArray(userProfile.shop) ? userProfile.shop : (userProfile.shop ? [userProfile.shop] : []);

                    let roleMatch = false;
                    if (userProfile.role === 'Admin' || userProfile.role === 'CEO') roleMatch = true;
                    else if (userProfile.role === 'Shop Manager') roleMatch = employeeShops.some(s => userManagedShops.includes(s));
                    else roleMatch = emp.id === userProfile.id;

                    const shopMatch = !selectedShop || employeeShops.includes(selectedShop);
                    const shiftMatch = !selectedShift || emp.shift === selectedShift;
                    const searchMatch = !searchTerm || emp.name.toLowerCase().includes(searchTerm.toLowerCase());
                    return emp.status === 'Active' && roleMatch && shopMatch && searchMatch && shiftMatch && emp.role !== 'Admin' && emp.role !== 'CEO';
                });
                
                const relevantEmployeeIds = new Set(relevantEmployees.map(e => e.id));

                // ... (Optimized lookup maps code remains same) ...
                const leaveLookup = new Map();
                leaveRequests.forEach(lr => {
                    if (lr.status !== 'Approved') return;
                    if (!leaveLookup.has(lr.staffId)) leaveLookup.set(lr.staffId, []);
                    leaveLookup.get(lr.staffId).push(lr);
                });

                const otLookup = new Set();
                otRequests.forEach(ot => {
                    if (ot.status === 'Approved') otLookup.add(`${ot.staffId}_${ot.reqDate}`);
                });

                // 3. Process attendance data
                const reportMap = new Map();
                
                attendance.forEach(record => {
                    if (!relevantEmployeeIds.has(record.employeeId)) return;
                    if (!record.timestamp) return;

                    // OPTIMIZATION: Use Map lookup instead of .find()
                    const recordShop = shopsMap.get(record.shop);
                    const { localDate: dateKey } = Utils.formatDateInTimezone(record.timestamp, recordShop?.timezone);
                    
                    // --- FIX: STRING BASED FILTERING ---
                    // Compare the Record's Local Date String with the Target Date String
                    let isMatch = false;
                    if (filterType === 'today' || filterType === 'yesterday') {
                        isMatch = dateKey === targetStartDateStr;
                    } else if (filterType === 'thisMonth' || filterType === 'lastMonth' || filterType === 'custom') {
                        // Compare YYYY-MM
                        isMatch = dateKey.slice(0, 7) === targetStartDateStr.slice(0, 7);
                    }
                    
                    if (!isMatch) return;

                    const reportKey = `${record.employeeId}_${dateKey}`;

                    if (!reportMap.has(reportKey)) {
                        reportMap.set(reportKey, {
                            date: dateKey,
                            employeeId: record.employeeId,
                            checkInRecords: [],
                            checkOutRecords: [],
                            docIds: []
                        });
                    }
                    
                    const entry = reportMap.get(reportKey);
                    
                    // MODIFIED: Include Device Info in the stored record data
                    const recordData = { 
                        date: record.timestamp.toDate(), 
                        shop: record.shop, 
                        deviceInfo: record.deviceInfo // Store the captured info
                    };
                    
                    if (record.type === 'in') entry.checkInRecords.push(recordData);
                    if (record.type === 'out') entry.checkOutRecords.push(recordData);
                    entry.docIds.push(record.id);
                });

                // 4. Fill gaps for absent days (Logic updated for Timezone)
                // We need to iterate dates based on the TARGET range, not Browser range
                let loopDateStr = targetStartDateStr;
                
                // Helper to increment YYYY-MM-DD
                const addDays = (dateStr, days) => {
                    const d = new Date(dateStr);
                    d.setDate(d.getDate() + days);
                    return d.toISOString().slice(0, 10);
                };

                // Determine end date for loop
                let loopEndDateStr = targetStartDateStr;
                if (filterType !== 'today' && filterType !== 'yesterday') {
                     // For months, go to end of month
                     const [y, m] = targetStartDateStr.split('-').map(Number);
                     const daysInMonth = new Date(y, m, 0).getDate();
                     loopEndDateStr = `${y}-${String(m).padStart(2,'0')}-${daysInMonth}`;
                }

                // Cap loop at "Today" (in ref timezone) to prevent showing future absences
                if (loopEndDateStr > nowInTz) loopEndDateStr = nowInTz;

                let curr = targetStartDateStr;
                while (curr <= loopEndDateStr) {
                    for (const employee of relevantEmployees) {
                         const reportKey = `${employee.id}_${curr}`;
                         if (!reportMap.has(reportKey)) {
                            reportMap.set(reportKey, {
                                date: curr, employeeId: employee.id,
                                checkInRecords: [], checkOutRecords: [], docIds: []
                            });
                         }
                    }
                    curr = addDays(curr, 1);
                }

                // 5. Finalize rows (Logic remains mostly same)
                const reportArray = Array.from(reportMap.values()).map(entry => {
                    const employee = employees.find(e => e.id === entry.employeeId);
                    if (!employee) return null;

                    const firstCheckInRecord = entry.checkInRecords.length > 0
                        ? entry.checkInRecords.reduce((earliest, current) => current.date < earliest.date ? current : earliest)
                        : null;
                    const lastCheckOutRecord = entry.checkOutRecords.length > 0
                        ? entry.checkOutRecords.reduce((latest, current) => current.date > latest.date ? current : latest)
                        : null;

                    const checkIn = firstCheckInRecord ? firstCheckInRecord.date : null;
                    const checkOut = lastCheckOutRecord ? lastCheckOutRecord.date : null;
                    
                    // --- NEW: Extract Device Model from the first check-in record ---
                    const deviceModel = firstCheckInRecord?.deviceInfo?.model || 'Unknown';
                    const devicePlatform = firstCheckInRecord?.deviceInfo?.platform || '';

                    // OPTIMIZATION: Use Map lookup
                    const shopNameForLookup = firstCheckInRecord?.shop || (Array.isArray(employee.shop) ? employee.shop[0] : employee.shop);
                    const shopDetails = shopsMap.get(shopNameForLookup);
                    const shopTimezone = shopDetails?.timezone;

                    let isLate = false;
                    if (checkIn && employee) {
                        const shiftDetails = (shifts || []).find(s => s.name === employee.shift && s.shopName === firstCheckInRecord.shop);
                        if (shiftDetails?.lateThreshold) {
                            const [lateHour, lateMinute] = shiftDetails.lateThreshold.split(':').map(Number);
                            const timeInZoneString = checkIn.toLocaleTimeString('en-GB', { timeZone: shopTimezone, hour: '2-digit', minute: '2-digit' });
                            const [checkInHour, checkInMinute] = timeInZoneString.split(':').map(Number);
                            if (checkInHour > lateHour || (checkInHour === lateHour && checkInMinute > lateMinute)) {
                                isLate = true;
                            }
                        }
                    }

                    // --- OPTIMIZATION: Use Lookup Map instead of .find() ---
                    const employeeLeaves = leaveLookup.get(employee.id) || [];
                    const approvedLeave = employeeLeaves.find(lr => entry.date >= lr.leaveDate && entry.date < lr.returnDate);
                    // --- END OPTIMIZATION ---

                    let isOnLeave;
                    if (approvedLeave) {
                        isOnLeave = approvedLeave.leaveSession === 'Full Day' ? 'Y-Full Day' : `Y-${approvedLeave.leaveSession}`;
                    } else if (checkIn || checkOut) {
                        isOnLeave = 'N';
                    } else {
                        isOnLeave = isReportLoading ? '-' : 'Absent';
                    }

                    // --- OPTIMIZATION: Use Set Lookup instead of .some() ---
                    const otStatus = otLookup.has(`${employee.id}_${entry.date}`) ? 'Y' : 'N';
                    
                    const { localTime: checkInTimeStr } = checkIn ? Utils.formatDateInTimezone({ toDate: () => checkIn }, shopTimezone) : { localTime: '' };
                    const { localTime: checkOutTimeStr } = checkOut ? Utils.formatDateInTimezone({ toDate: () => checkOut }, shopTimezone) : { localTime: '' };
                    
                    let shopDisplay = Array.isArray(employee.shop) ? employee.shop.join(', ') : employee.shop;
                    if (firstCheckInRecord && lastCheckOutRecord) {
                        shopDisplay = firstCheckInRecord.shop === lastCheckOutRecord.shop ? firstCheckInRecord.shop : `${firstCheckInRecord.shop} (In)  ${lastCheckOutRecord.shop} (Out)`;
                    } else if (firstCheckInRecord) {
                        shopDisplay = firstCheckInRecord.shop;
                    }

                    return {
                        date: entry.date,
                        employeeId: employee.id,
                        employeeName: employee.name,
                        shop: shopDisplay,
                        shift: employee.shift,
                        checkIn: checkInTimeStr,
                        checkOut: checkOutTimeStr,
                        isLate, isOnLeave, otStatus, docIds: entry.docIds,
                        deviceModel, devicePlatform // Pass to row
                    };
                }).filter(Boolean);
                
                return reportArray.sort((a, b) => (a.shop || '').localeCompare(b.shop || '') || b.date.localeCompare(a.date) || a.employeeName.localeCompare(b.employeeName));
            }, [attendance, selectedShop, filterType, customMonth, searchTerm, employees, leaveRequests, otRequests, selectedShift, shops, shifts, userProfile, isReportLoading]);

            // ... (keep Handlers: handleDelete, handleOpenCorrectionModal, etc.) ...
            const handleDelete = async () => {
                if (!recordToDelete?.docIds) return;
                const { doc, writeBatch } = window.firebaseSDK;
                const batch = writeBatch(db);
                recordToDelete.docIds.forEach(id => batch.delete(doc(db, 'attendance', id)));
                try { await batch.commit(); } catch (error) { console.error("Error deleting attendance records: ", error); } 
                finally { setRecordToDelete(null); }
            };

            const handleOpenCorrectionModal = useCallback((record) => {
                setRecordToCorrect(record);
                setCorrectionModalOpen(true);
            }, []);

            const handleCloseCorrectionModal = useCallback(() => {
                setRecordToCorrect(null);
                setCorrectionModalOpen(false);
            }, []);
            
            const handleSaveCheckOut = useCallback(async (record, time) => {
                const { addDoc, collection } = window.firebaseSDK;
                const checkOutDateTime = new Date(`${record.date}T${time}:00`);

                try {
                    const newDocRef = await addDoc(collection(db, 'attendance'), {
                        employeeId: record.employeeId,
                        employeeName: record.employeeName,
                        shop: record.shop,
                        timestamp: checkOutDateTime,
                        type: 'out',
                        location: { manualEntry: true, note: 'Added by Admin' }
                    });

                    if (userProfile?.role === 'Admin' || userProfile?.role === 'CEO') {
                        const newRecordForState = {
                            id: newDocRef.id,
                            employeeId: record.employeeId,
                            employeeName: record.employeeName,
                            shop: record.shop,
                            timestamp: { toDate: () => checkOutDateTime },
                            type: 'out',
                            location: { manualEntry: true, note: 'Added by Admin' }
                        };
                        setAdminAttendance(prev => [...prev, newRecordForState]);
                    }
                    handleCloseCorrectionModal();
                } catch (error) {
                    console.error("Error saving manual check-out:", error);
                    alert("Failed to save the manual check-out time.");
                }
            }, [db, handleCloseCorrectionModal, userProfile]);

            const handleExportExcel = useCallback(() => {
                const dataToExport = attendanceReport.map(report => ({
                    'Date': report.date,
                    'Shop Name': report.shop,
                    'Staff Name': report.employeeName,
                    'Shift': report.shift,
                    'Check In': report.checkIn,
                    'Check Out': report.checkOut,
                    'On Leave': report.isOnLeave,
                    'OT Status': report.otStatus,
                    'Late Check-In': report.isLate ? 'Yes' : 'No',
                    'Device Used': report.deviceModel !== 'Unknown' ? report.deviceModel : '-' // NEW: Add to Excel Export
                }));

                const getReportFilename = () => {
                    const todayStr = new Date().toISOString().slice(0, 10);
                    switch (filterType) {
                        case 'today': return `Daily_Attendance_Report_Today_${todayStr}.xlsx`;
                        case 'yesterday': 
                            const yesterday = new Date();
                            yesterday.setDate(yesterday.getDate() - 1);
                            return `Daily_Attendance_Report_Yesterday_${yesterday.toISOString().slice(0, 10)}.xlsx`;
                        case 'thisMonth': return `Daily_Attendance_Report_ThisMonth_${new Date().toISOString().slice(0, 7)}.xlsx`;
                        case 'lastMonth': 
                            const lastMonth = new Date();
                            lastMonth.setMonth(lastMonth.getMonth() - 1);
                            return `Daily_Attendance_Report_LastMonth_${lastMonth.toISOString().slice(0, 7)}.xlsx`;
                        case 'custom': return `Daily_Attendance_Report_${customMonth}.xlsx`;
                        default: return 'Daily_Attendance_Report.xlsx';
                    }
                };

                const worksheet = XLSX.utils.json_to_sheet(dataToExport);
                const workbook = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(workbook, worksheet, "Daily Attendance");

                worksheet["!cols"] = [ { wch: 12 }, { wch: 15 }, { wch: 25 }, { wch: 10 }, { wch: 15 }, { wch: 15 }, { wch: 15 }, { wch: 12 }, { wch: 15 } ];
                
                XLSX.writeFile(workbook, getReportFilename());
            }, [attendanceReport, filterType, customMonth]);

            return (
                <Card>
                    <DailyReportFilters
                        userProfile={userProfile}
                        selectedShop={selectedShop}
                        setSelectedShop={setSelectedShop}
                        searchTerm={searchTerm}
                        setSearchTerm={setSearchTerm}
                        availableShops={availableShops}
                        filterType={filterType}
                        setFilterType={setFilterType}
                        customMonth={customMonth}
                        setCustomMonth={setCustomMonth}
                        selectedShift={selectedShift}
                        setSelectedShift={setSelectedShift}
                        uniqueShiftNames={uniqueShiftNames}
                        onExportExcel={handleExportExcel}
                    />
                    <DailyReportTable
                        attendanceReport={attendanceReport}
                        userProfile={userProfile}
                        onAddCheckOut={handleOpenCorrectionModal}
                        onDeleteRecord={setRecordToDelete}
                    />
                    <ConfirmationModal isOpen={!!recordToDelete} onClose={() => setRecordToDelete(null)} onConfirm={handleDelete} title="Delete Attendance Record" message={`Are you sure you want to delete all attendance records for ${recordToDelete?.employeeName} on ${recordToDelete?.date}? This action cannot be undone.`} />
                    <ManualCheckOutModal isOpen={isCorrectionModalOpen} onClose={handleCloseCorrectionModal} onSave={handleSaveCheckOut} record={recordToCorrect} />
                </Card>
            );
        };
        
        const WorkDayReportTab = ({ userProfile, leaveRequests, otRequests, setAdminReportData, setLoadingAdminReport, isAdminLoading }) => {
            const { db } = useFirebase();
            const { where, query, collection, getDocs } = window.firebaseSDK;

            // Filter States
            const [selectedShop, setSelectedShop] = useState('');
            const [filterType, setFilterType] = useState('thisMonth');
            const [selectedMonth, setSelectedMonth] = useState(new Date().toISOString().slice(0, 7));
            const [searchTerm, setSearchTerm] = useState('');
            const [selectedShift, setSelectedShift] = useState('');

            // Data States
            const { shops, employees, shifts } = useAppData();

            // NEW: Get unique shift names for the filter dropdown
            const uniqueShiftNames = useMemo(() => {
                if (!shifts) return [];
                const shiftNames = shifts.map(s => s.name);
                return [...new Set(shiftNames)].sort();
            }, [shifts]);
            
            // PHASE 3: Data states for Admin's one-time fetches
            const [adminAttendance, setAdminAttendance] = useState([]);
            const [adminEmployeeStates, setAdminEmployeeStates] = useState([]);

            // PHASE 2 & 3: Combined logic for fetching data.
            // FIX: Managers use On Demand (isRealTime = false)
            const isRealTime = userProfile?.role === 'Staff';
            
            const realTimeQueryConstraints = useMemo(() => {
                if (!isRealTime) return { attendance: [where("shop", "==", "___NON_EXISTENT_SHOP___")], employeeStates: [where("shop", "==", "___NON_EXISTENT_SHOP___")] };

                const { role, id } = userProfile || {};
                
                let attendanceCons = [], statesCons = [];

                if (role === 'Staff' && id) {
                    attendanceCons = [where("employeeId", "==", id)];
                    statesCons = [where("staffId", "==", id)];
                } else {
                     // Fallback
                     attendanceCons = [where("shop", "==", "___NON_EXISTENT_SHOP___")];
                     statesCons = [where("shop", "==", "___NON_EXISTENT_SHOP___")];
                }
                return { attendance: attendanceCons, employeeStates: statesCons };
            }, [userProfile, isRealTime]);

            const { data: realTimeAttendance } = useCollection('attendance', realTimeQueryConstraints.attendance);
            const { data: realTimeEmployeeStates } = useCollection('employeeStates', realTimeQueryConstraints.employeeStates);
            
            const attendance = isRealTime ? realTimeAttendance : adminAttendance;
            const employeeStates = isRealTime ? realTimeEmployeeStates : adminEmployeeStates;

             // --- PHASE 3: ON-DEMAND DATA FETCHING FOR ADMIN & MANAGERS ---
            useEffect(() => {
                if (userProfile?.role === 'Staff') return;

                const fetchAdminData = async () => {
                    setLoadingAdminReport(true);
                    
                    let targetMonth;
                    const now = new Date();
                    switch (filterType) {
                        case 'lastMonth':
                            const lastMonthDate = new Date(now.getFullYear(), now.getMonth() - 1, 1);
                            const year_lm = lastMonthDate.getFullYear();
                            const month_lm = String(lastMonthDate.getMonth() + 1).padStart(2, '0');
                            targetMonth = `${year_lm}-${month_lm}`;
                            break;
                        case 'custom': targetMonth = selectedMonth; break;
                        default: targetMonth = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`; break;
                    }

                    const startDate = `${targetMonth}-01`;
                    // Calculate last day of month
                    const [y, m] = targetMonth.split('-').map(Number);
                    const daysInMonth = new Date(y, m, 0).getDate();
                    const endDate = `${targetMonth}-${daysInMonth}`; 

                    // --- FIX: Add Timezone Buffer (2 Days) ---
                    const bufferStart = new Date(startDate);
                    bufferStart.setDate(bufferStart.getDate() - 2);
                    
                    const bufferEnd = new Date(endDate);
                    bufferEnd.setDate(bufferEnd.getDate() + 2);

                    // --- OPTIMIZATION START: Server-Side Shop Filtering for Monthly Report ---
                    let attendanceQuery = query(collection(db, 'attendance'), where('timestamp', '>=', bufferStart), where('timestamp', '<=', bufferEnd));
                    let statesQuery = query(collection(db, 'employeeStates'), where('date', '>=', startDate), where('date', '<=', endDate));
                    let leaveQuery = query(collection(db, 'leaveRequests'), where('returnDate', '>=', startDate));
                    let otQuery = query(collection(db, 'otRequests'), where('reqDate', '>=', startDate), where('reqDate', '<=', endDate));
                    
                    // Apply Shop Filter at the Database Level
                    let targetShop = selectedShop;
                    if (!targetShop && userProfile.role === 'Shop Manager') {
                         const managedShops = Array.isArray(userProfile.shop) ? userProfile.shop : [userProfile.shop];
                         if (managedShops.length > 0) {
                             // Use 'in' query for managed shops list
                             attendanceQuery = query(attendanceQuery, where('shop', 'in', managedShops));
                             statesQuery = query(statesQuery, where('shop', 'in', managedShops));
                             leaveQuery = query(leaveQuery, where('shop', 'in', managedShops));
                             otQuery = query(otQuery, where('shop', 'in', managedShops));
                         } else {
                             setAdminAttendance([]); setAdminEmployeeStates([]);
                             setAdminReportData({ leaveRequests: [], otRequests: [] });
                             setLoadingAdminReport(false);
                             return;
                         }
                    } else if (targetShop) {
                        attendanceQuery = query(attendanceQuery, where('shop', '==', targetShop));
                        statesQuery = query(statesQuery, where('shop', '==', targetShop));
                        leaveQuery = query(leaveQuery, where('shop', '==', targetShop));
                        otQuery = query(otQuery, where('shop', '==', targetShop));
                    }
                    // --- OPTIMIZATION END ---
                    
                    try {
                        const [attSnap, statesSnap, leaveSnap, otSnap] = await Promise.all([ getDocs(attendanceQuery), getDocs(statesQuery), getDocs(leaveQuery), getDocs(otQuery) ]);
                        
                        const attendanceData = attSnap.docs.map(d => ({id: d.id, ...d.data()}))
                            .filter(rec => {
                                const shopMatch = !selectedShop || rec.shop === selectedShop;
                                const empMatch = !searchTerm || (rec.employeeName && rec.employeeName.toLowerCase().includes(searchTerm.toLowerCase()));
                                return shopMatch && empMatch;
                            });
                        setAdminAttendance(attendanceData);

                        const statesData = statesSnap.docs.map(d => ({id: d.id, ...d.data()}))
                            .filter(rec => {
                                const shopMatch = !selectedShop || rec.shop === selectedShop;
                                const empMatch = !searchTerm || (rec.staffName && rec.staffName.toLowerCase().includes(searchTerm.toLowerCase()));
                                return shopMatch && empMatch;
                            });
                        setAdminEmployeeStates(statesData);
                        
                        const leaveData = leaveSnap.docs.map(d => ({ id: d.id, ...d.data() }))
                            .filter(lr => {
                                const shopMatch = !selectedShop || lr.shop === selectedShop;
                                const empMatch = !searchTerm || (lr.staffName && lr.staffName.toLowerCase().includes(searchTerm.toLowerCase()));
                                // FIX: Client-side check for overlap: starts before end of month
                                const dateMatch = lr.leaveDate <= endDate;
                                return shopMatch && empMatch && dateMatch;
                            });
                        
                        const otData = otSnap.docs.map(d => ({id: d.id, ...d.data()}))
                             .filter(rec => {
                                const shopMatch = !selectedShop || rec.shop === selectedShop;
                                const empMatch = !searchTerm || (rec.staffName && rec.staffName.toLowerCase().includes(searchTerm.toLowerCase()));
                                return shopMatch && empMatch;
                            });

                        setAdminReportData({ leaveRequests: leaveData, otRequests: otData });

                    } catch (error) {
                        console.error("Error fetching work day report data:", error);
                    } finally {
                        setLoadingAdminReport(false);
                    }
                };
                
                fetchAdminData();

            }, [userProfile, filterType, selectedMonth, selectedShop, searchTerm, db, setLoadingAdminReport, setAdminReportData]);

            // Set initial shop selection
            useEffect(() => {
                if (userProfile && userProfile.role !== 'Admin' && userProfile.role !== 'CEO') {
                    setSelectedShop(Array.isArray(userProfile.shop) ? '' : userProfile.shop || '');
                }
            }, [userProfile]);

            // OPTIMIZATION: Use centralized hook for shops
            const availableShops = useAllowedShops(userProfile, shops);

            const workDayReport = useMemo(() => {
                let targetMonth;
                const now = new Date();
                switch (filterType) {
                    case 'lastMonth':
                        const lastMonthDate = new Date(now.getFullYear(), now.getMonth() - 1, 1);
                        const year_lm = lastMonthDate.getFullYear();
                        const month_lm = String(lastMonthDate.getMonth() + 1).padStart(2, '0');
                        targetMonth = `${year_lm}-${month_lm}`;
                        break;
                    case 'custom': targetMonth = selectedMonth; break;
                    case 'thisMonth':
                    default:
                        const year_tm = now.getFullYear();
                        const month_tm = String(now.getMonth() + 1).padStart(2, '0');
                        targetMonth = `${year_tm}-${month_tm}`;
                        break;
                }

                // 0. Pre-compute Shop Map for O(1) Timezone Lookup
                const shopsMap = new Map(shops.map(s => [s.name, s]));

                // 1. Determine which employees to generate a report for based on filters
                const employeesToReportOn = employees.filter(emp => {
                    if (emp.status !== 'Active') return false;

                    const employeeShops = Array.isArray(emp.shop) ? emp.shop : (emp.shop ? [emp.shop] : []);
                    const userManagedShops = Array.isArray(userProfile.shop) ? userProfile.shop : (userProfile.shop ? [userProfile.shop] : []);

                    let roleMatch = false;
                    if (userProfile.role === 'Admin' || userProfile.role === 'CEO') roleMatch = true;
                    else if (userProfile.role === 'Shop Manager') roleMatch = employeeShops.some(s => userManagedShops.includes(s));
                    else roleMatch = emp.id === userProfile.id; // Staff see only themselves
                    
                    const shopFilterMatch = !selectedShop || employeeShops.includes(selectedShop);
                    const employeeFilterMatch = !searchTerm || emp.name.toLowerCase().includes(searchTerm.toLowerCase());
                    const shiftFilterMatch = !selectedShift || emp.shift === selectedShift;

                    return roleMatch && shopFilterMatch && employeeFilterMatch && shiftFilterMatch && emp.role !== 'Admin' && emp.role !== 'CEO';
                });

                // --- PERFORMANCE CRITICAL: Pre-Index Data by Employee ID ---
                // Convert arrays to Maps/Sets to avoid O(N^2) complexity in the loop below
                
                // Index 1: Attendance [EmpID -> Array of Records]
                const attendanceByEmp = new Map();
                (attendance || []).forEach(r => {
                    if (!r.timestamp || !r.timestamp.toDate) return;
                    
                    // FIX: Don't filter by date here using UTC. We must wait until we know the Employee's Shop Timezone.
                    // Store all fetched (buffered) records. Filtering happens in the next step.
                    if (!attendanceByEmp.has(r.employeeId)) attendanceByEmp.set(r.employeeId, []);
                    attendanceByEmp.get(r.employeeId).push(r);
                });

                // Index 2: Leave Requests [EmpID -> Array of Approved Records]
                const leaveByEmp = new Map();
                leaveRequests.forEach(r => {
                    if (r.status === 'Approved' && r.leaveDate.startsWith(targetMonth)) {
                        if (!leaveByEmp.has(r.staffId)) leaveByEmp.set(r.staffId, []);
                        leaveByEmp.get(r.staffId).push(r);
                    }
                });

                // Index 3: OT Requests [EmpID -> Array of Approved Records]
                const otByEmp = new Map();
                otRequests.forEach(r => {
                    if (r.status === 'Approved' && r.reqDate.startsWith(targetMonth)) {
                        if (!otByEmp.has(r.staffId)) otByEmp.set(r.staffId, []);
                        otByEmp.get(r.staffId).push(r);
                    }
                });

                // Index 4: Employee States [EmpID -> Array of Records]
                const statesByEmp = new Map();
                employeeStates.forEach(r => {
                    if (r.date.startsWith(targetMonth)) {
                        if (!statesByEmp.has(r.staffId)) statesByEmp.set(r.staffId, []);
                        statesByEmp.get(r.staffId).push(r);
                    }
                });
                // --- END PRE-INDEXING ---
                
                // 2. Generate report using O(1) Lookups
                const report = employeesToReportOn.map(employee => {
                    const employeeShopName = employee.primaryShop 
                        ? employee.primaryShop 
                        : (Array.isArray(employee.shop) ? employee.shop[0] : employee.shop);

                    // OPTIMIZATION: Use Map lookup instead of .find()
                    const employeeShop = shopsMap.get(employeeShopName);
                    const employeeShopTimezone = employeeShop?.timezone;

                    // Retrieve pre-filtered data from Maps
                    const rawAttendance = attendanceByEmp.get(employee.id) || [];
                    const monthLeave = leaveByEmp.get(employee.id) || [];
                    const monthOT = otByEmp.get(employee.id) || [];
                    const monthStates = statesByEmp.get(employee.id) || [];

                    const totalLeave = monthLeave.reduce((sum, r) => sum + (parseFloat(r.numberOfDays) || 0), 0);
                    const totalOT = monthOT.reduce((sum, r) => sum + (parseFloat(r.numberOfOTDays) || 0), 0);
                    const totalLate = monthStates.filter(es => es.statusState === 'Deduction' && es.note?.includes('CheckIn Late @')).length;
                    
                    const dailyRecords = {};
                    rawAttendance.forEach(rec => {
                        // FIX: Use Timezone-Aware Date Conversion for Filtering
                        const { localDate: dayKey } = Utils.formatDateInTimezone(rec.timestamp, employeeShopTimezone);
                        
                        // Check if this record belongs to the target month in the SHOP'S timezone
                        if (!dayKey.startsWith(targetMonth)) return; 

                        if (!dailyRecords[dayKey]) dailyRecords[dayKey] = [];
                        dailyRecords[dayKey].push({ date: rec.timestamp.toDate(), type: rec.type });
                    });
                    
                    let workDays = 0;
                    let noCheckOutCount = 0;
                    const { localDate: todayStr } = Utils.formatDateInTimezone({ toDate: () => new Date() }, employeeShopTimezone);

                    Object.entries(dailyRecords).forEach(([dayKey, dayRecs]) => {
                        const ins = dayRecs.filter(r => r.type === 'in').sort((a,b) => a.date - b.date);
                        const outs = dayRecs.filter(r => r.type === 'out').sort((a,b) => b.date - a.date);
                        if (ins.length > 0 && outs.length > 0) {
                            const diffHours = (outs[0].date.getTime() - ins[0].date.getTime()) / 3600000;
                            if (diffHours >= 7) workDays += 1;
                            else if (diffHours >= 4) workDays += 0.5;
                        } else if (ins.length > 0 && dayKey < todayStr) {
                            noCheckOutCount += 1;
                        }
                    });

                    const [year, month] = targetMonth.split('-').map(Number);
                    const daysInMonth = new Date(year, month, 0).getDate();
                    const attendedDays = new Set(Object.keys(dailyRecords));
                    let noAbsentCount = 0;

                    for (let day = 1; day <= daysInMonth; day++) {
                        const dayKey = `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                        if (dayKey >= todayStr) break;
                        if (!attendedDays.has(dayKey)) {
                            const isOnLeave = monthLeave.some(lr => dayKey >= lr.leaveDate && dayKey < lr.returnDate);
                            if (!isOnLeave) noAbsentCount++;
                        }
                    }

                    const givenOffDays = Math.floor(workDays / 6.5);
                    const [reportYear, reportMonth] = targetMonth.split('-');
                    const salaryDay = workDays + givenOffDays + totalOT;

                    return { 
                        dueTime: `${reportMonth}-${reportYear.substring(2)}`, 
                        shopName: employeeShopName, 
                        staffName: employee.name, 
                        workDays, 
                        givenOffDays, 
                        totalOT, 
                        totalLeave, 
                        totalLate, 
                        noCheckOutCount, 
                        noAbsentCount, 
                        salaryDay,
                    };
                });
                
                return report.sort((a, b) => (a.shopName || '').localeCompare(b.shopName || '') || (a.staffName || '').localeCompare(b.staffName || ''));

            }, [attendance, leaveRequests, otRequests, employeeStates, employees, shops, filterType, selectedMonth, selectedShop, searchTerm, userProfile, selectedShift]);

            const handleExportExcel = useCallback(() => {
                const dataToExport = workDayReport.map(rec => ({
                    'Due Time (MM-YY)': rec.dueTime,
                    'Shop Name': rec.shopName,
                    'Staff Name': rec.staffName,
                    'No. Work Day': rec.workDays,
                    'Given Off Day': rec.givenOffDays,
                    'Total OT': rec.totalOT,
                    'Total Leave No': rec.totalLeave,
                    'Total LATE': rec.totalLate,
                    'No-CheckOut': rec.noCheckOutCount,
                    'No-Absent': rec.noAbsentCount,
                    'Salary Day': rec.salaryDay,
                }));

                const getReportFilename = () => {
                    const now = new Date();
                    switch (filterType) {
                        case 'thisMonth':
                            const year_tm = now.getFullYear();
                            const month_tm = String(now.getMonth() + 1).padStart(2, '0');
                            return `Monthly_Work_Day_Report_${year_tm}-${month_tm}.xlsx`;
                        case 'lastMonth': 
                            const lastMonthDate = new Date(now.getFullYear(), now.getMonth() - 1, 1);
                            const year_lm = lastMonthDate.getFullYear();
                            const month_lm = String(lastMonthDate.getMonth() + 1).padStart(2, '0');
                            return `Monthly_Work_Day_Report_${year_lm}-${month_lm}.xlsx`;
                        case 'custom': return `Monthly_Work_Day_Report_${selectedMonth}.xlsx`;
                        default: return 'Monthly_Work_Day_Report.xlsx';
                    }
                };

                const worksheet = XLSX.utils.json_to_sheet(dataToExport);
                const workbook = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(workbook, worksheet, "Monthly Work Day Report");
                
                worksheet["!cols"] = [ { wch: 18 }, { wch: 20 }, { wch: 25 }, { wch: 15 }, { wch: 15 }, { wch: 15 }, { wch: 15 }, { wch: 15 }, { wch: 15 }, { wch: 15 }, { wch: 15 } ];
                
                XLSX.writeFile(workbook, getReportFilename());
            }, [workDayReport, filterType, selectedMonth]);

            return (
                <Card>
                    <WorkDayReportFilters
                        userProfile={userProfile}
                        selectedShop={selectedShop}
                        setSelectedShop={setSelectedShop}
                        searchTerm={searchTerm}
                        setSearchTerm={setSearchTerm}
                        availableShops={availableShops}
                        filterType={filterType}
                        setFilterType={setFilterType}
                        selectedMonth={selectedMonth}
                        setSelectedMonth={setSelectedMonth}
                        selectedShift={selectedShift}
                        setSelectedShift={setSelectedShift}
                        uniqueShiftNames={uniqueShiftNames}
                        onExportExcel={handleExportExcel}
                    />
                    <WorkDayReportTable workDayReport={workDayReport} />
                </Card>
            );
        };
        // --- END ATTENDANCE REPORT PAGE ---

        // --- START PAYROLL PAGE (RESTORED) ---
        // A dedicated component for rendering the payslip.
        const PayslipPreview = memo(({ selectedEmployee, selectedMonth, manualInputs, calculations, isRecalculated, originalRecord }) => {
            const getChangeIndicatorClass = (newValue, oldValue) => {
                if (!isRecalculated || oldValue === undefined || newValue === oldValue) return ''; 
                if (typeof newValue === 'number' && typeof oldValue === 'number') {
                    if (newValue > oldValue) return 'text-green-600 font-bold'; 
                    if (newValue < oldValue) return 'text-red-600 font-bold';   
                }
                return 'text-yellow-600 font-bold'; 
            };

            const oldCalcs = originalRecord?.calculations || {};
            const oldInputs = originalRecord?.manualInputs || {};

            return (
                <div id="payslip-preview" className="bg-white text-slate-800 p-6 rounded-lg shadow-2xl font-sans">
                    <div className="text-center mb-6">
                        <h2 className="text-2xl font-bold">PAYSLIP</h2>
                        <p className="text-slate-500">For the month of {selectedMonth}</p>
                    </div>
                    {selectedEmployee ? (
                    <>
                        <div className="grid grid-cols-2 gap-4 mb-6 text-sm">
                            <div>
                                <p className="font-bold">{selectedEmployee.name}</p>
                                <p>{selectedEmployee.position}</p>
                                <p>Shift: {selectedEmployee.shift}</p>
                            </div>
                            <div className="text-right">
                                <p>Shop: {Array.isArray(selectedEmployee.shop) ? selectedEmployee.shop.join(', ') : selectedEmployee.shop}</p>
                                <p>Base Salary: {Utils.formatCurrency(calculations.baseSalary)}</p>
                                <p>Worked Dur.: {Utils.calculateWorkedDuration(selectedEmployee.joinedDate)}</p>
                            </div>
                        </div>
                        <div className="grid grid-cols-2 gap-6">
                            <div className="space-y-2 p-4 border-t-4 border-green-500 bg-green-50 rounded-b-lg">
                                <h3 className="text-lg font-semibold text-slate-900">Earnings</h3>
                                <div className="flex justify-between text-sm"><p>Work Days</p><p className={getChangeIndicatorClass(manualInputs.workDays, oldInputs.workDays)}>{manualInputs.workDays || 0}</p></div>
                                <div className="flex justify-between text-sm"><p>Given Off Days</p><p className={getChangeIndicatorClass(manualInputs.givenOffDays, oldInputs.givenOffDays)}>{manualInputs.givenOffDays || 0}</p></div>
                                <div className="flex justify-between text-sm pt-2 border-t border-slate-200"><p>Salary Earned</p><p className={getChangeIndicatorClass(calculations.baseSalaryEarned, oldCalcs.baseSalaryEarned)}>{Utils.formatCurrency(calculations.baseSalaryEarned)}</p></div>
                                <div className="flex justify-between text-sm"><p>OT Salary ({manualInputs.otDays || 0})</p><p className={getChangeIndicatorClass(calculations.otSalary, oldCalcs.otSalary)}>{Utils.formatCurrency(calculations.otSalary)}</p></div>
                                <div className="flex justify-between text-sm"><p>Engagements</p><p className={getChangeIndicatorClass(calculations.engagements, oldCalcs.engagements)}>{Utils.formatCurrency(calculations.engagements)}</p></div>
                                
                                {calculations.totalSavingsWithdrawal > 0 && (
                                    <div className="flex justify-between text-sm text-indigo-700 font-semibold" title="Savings Program Payback">
                                        <p>Savings Payback</p>
                                        <p className={getChangeIndicatorClass(calculations.totalSavingsWithdrawal, oldCalcs.totalSavingsWithdrawal)}>{Utils.formatCurrency(calculations.totalSavingsWithdrawal)}</p>
                                    </div>
                                )}

                                <div className="flex justify-between font-bold pt-2 border-t border-slate-300"><p>Gross Salary</p><p className={getChangeIndicatorClass(calculations.grossSalary, oldCalcs.grossSalary)}>{Utils.formatCurrency(calculations.grossSalary)}</p></div>
                            </div>
                            <div className="space-y-2 p-4 border-t-4 border-red-500 bg-red-50 rounded-b-lg">
                                <h3 className="text-lg font-semibold text-slate-900">Deductions</h3>
                                <div className="flex justify-between text-sm"><p>Leave Days</p><p className={`text-red-600 ${getChangeIndicatorClass(manualInputs.leaveDays, oldInputs.leaveDays)}`}>-{manualInputs.leaveDays || 0}</p></div>
                                <div className="flex justify-between text-sm"><p>Late ({manualInputs.totalLateDays || 0})</p><p className={getChangeIndicatorClass(calculations.lateDeductionsAmount, oldCalcs.lateDeductionsAmount)}>{Utils.formatCurrency(calculations.lateDeductionsAmount)}</p></div>
                                <div className="flex justify-between text-sm" title="Absent + No-CheckOut"><p>No-Attendance</p><p className={getChangeIndicatorClass(manualInputs.noAttendance, oldInputs.noAttendance)}>{manualInputs.noAttendance || 0}</p></div>
                                <div className="flex justify-between text-sm"><p>Loan Deduction</p><p className={getChangeIndicatorClass(manualInputs.loanDeduction, oldInputs.loanDeduction)}>{Utils.formatCurrency(manualInputs.loanDeduction)}</p></div>
                                <div className="flex justify-between text-sm"><p>Other Deductions</p><p className={getChangeIndicatorClass(calculations.otherDeductions, oldCalcs.otherDeductions)}>{Utils.formatCurrency(calculations.otherDeductions)}</p></div>
                                {calculations.rejectedLeavePenaltyAmount > 0 && (
                                    <div className="flex justify-between text-sm text-red-700 font-semibold" title="Penalty: Absence on a day with a rejected leave request. (Salary Per Day x 2)">
                                        <p>Penalty Leave Rejected</p>
                                        <p className={getChangeIndicatorClass(calculations.rejectedLeavePenaltyAmount, oldCalcs.rejectedLeavePenaltyAmount)}>{Utils.formatCurrency(calculations.rejectedLeavePenaltyAmount)}</p>
                                    </div>
                                )}
                                {calculations.savingsDeduction > 0 && (
                                    <div className="flex justify-between text-sm text-blue-700 font-semibold" title="Voluntary Savings Program">
                                        <p>Savings Deduction</p>
                                        <p className={getChangeIndicatorClass(calculations.savingsDeduction, oldCalcs.savingsDeduction)}>{Utils.formatCurrency(calculations.savingsDeduction)}</p>
                                    </div>
                                )}
                                <div className="flex justify-between font-bold pt-2 border-t border-slate-300"><p>Total Deductions</p><p className={`text-red-600 ${getChangeIndicatorClass(calculations.totalDeductions, oldCalcs.totalDeductions)}`}>{Utils.formatCurrency(calculations.totalDeductions)}</p></div>
                            </div>
                        </div>
                        <div className="mt-6 p-4 bg-blue-100 border border-blue-300 rounded-lg text-center">
                            <p className="text-sm font-semibold text-blue-800">NET SALARY</p>
                            <p className={`text-3xl font-bold text-blue-900 ${getChangeIndicatorClass(calculations.netSalary, oldCalcs.netSalary)}`}>{Utils.formatCurrency(calculations.netSalary)}</p>
                        </div>
                    </>
                    ) : (
                        <div className="text-center py-20 text-slate-500"><i className="fas fa-file-invoice-dollar text-4xl mb-4"></i><p>Please select an employee to view the payslip.</p></div>
                    )}
                </div>
            );
        });

        // MODIFIED: Added onCancelEdit prop to handle exiting edit mode
        const PayrollCalculatorTab = ({ userProfile, editingRecord, onSaveSuccess, onCancelEdit }) => {
            const { db } = useFirebase();
            const currentMonth = new Date().toISOString().slice(0, 7);
            const [selectedMonth, setSelectedMonth] = useState(currentMonth);
            const [selectedShop, setSelectedShop] = useState('');
            const [selectedEmployeeId, setSelectedEmployeeId] = useState('');
            const { where } = window.firebaseSDK;

            const { shops, employees, shifts } = useAppData();

            // --- OPTIMIZATION: DATE RANGE CONSTRAINTS (The Silent Killer Fix) ---
            const dateConstraints = useMemo(() => {
                if (!selectedMonth) return null;
                const [y, m] = selectedMonth.split('-').map(Number);
                // Calculate Start/End of month for DB queries
                const startOfMonth = new Date(y, m - 1, 1);
                const endOfMonth = new Date(y, m, 0, 23, 59, 59, 999);
                
                // String formats for YYYY-MM-DD fields
                const startStr = `${selectedMonth}-01`;
                const endStr = `${selectedMonth}-31`; 

                return { start: startOfMonth, end: endOfMonth, startStr, endStr };
            }, [selectedMonth]);

            // PHASE 2 OPTIMIZATION: Query constraints for Shop Managers AND Date Range
            const payrollQueryConstraints = useMemo(() => {
                const { role, shop, id } = userProfile || {};
                const { start, end, startStr, endStr } = dateConstraints || {};
                
                // Guard: If no date selected, return empty/dummy to prevent fetch
                if (!start) return { attendance: [where("shop", "==", "___")], leave: [], ot: [], loan: [], state: [], salary: [] };

                // Helper to build constraints based on base filters (shop/id)
                const build = (baseFilters) => {
                    return {
                        // Attendance: Filter by Shop AND Date Range (Crucial for quota)
                        attendance: [...baseFilters.attendance, where("timestamp", ">=", start), where("timestamp", "<=", end)],
                        // Leaves: Overlap logic (simple: returnDate >= start of month)
                        leave: [...baseFilters.shop, where("returnDate", ">=", startStr)],
                        // OT: Within month
                        ot: [...baseFilters.shop, where("reqDate", ">=", startStr), where("reqDate", "<=", endStr)],
                        // Loans: Only Active ones
                        loan: [...baseFilters.shop, where("status", "==", "Active")],
                        // States: Within month
                        state: [...baseFilters.shop, where("date", ">=", startStr), where("date", "<=", endStr)],
                        // Salary: All revisions (usually small collection)
                        salary: [...baseFilters.salary]
                    };
                };
                
                // --- FIX: PRIORITY TO SELECTED EMPLOYEE ---
                // If a specific employee is selected (in the UI), we MUST fetch their attendance 
                // by ID, ignoring the Shop Filter. This ensures Multi-Shop employees (like Mr. A)
                // get attendance records from "Shop D" even if "Shop F" is selected in the dropdown.
                if (selectedEmployeeId) {
                    return build({
                        // Attendance: STRICTLY by Employee ID
                        attendance: [where("employeeId", "==", selectedEmployeeId)],
                        // Others: Also by Employee ID for safety/consistency
                        shop: [where("staffId", "==", selectedEmployeeId)],
                        salary: [where("staffId", "==", selectedEmployeeId)]
                    });
                }
                // --- END FIX ---

                if (role === 'Admin' || role === 'CEO') {
                    if (!selectedShop) return build({ shop: [where("shop", "==", "null")], attendance: [where("shop", "==", "null")], salary: [where("shopName", "==", "null")] });
                    return build({ 
                        shop: [where("shop", "==", selectedShop)], 
                        attendance: [where("shop", "==", selectedShop)],
                        salary: [where("shopName", "==", selectedShop)] 
                    });
                }

                if (role === 'Shop Manager') {
                    const managedShops = Array.isArray(shop) ? shop : (shop ? [shop] : []);
                    if (managedShops.length > 0) {
                        const shopFilter = selectedShop ? [where("shop", "==", selectedShop)] : [where("shop", "in", managedShops)];
                        const salaryFilter = selectedShop ? [where("shopName", "==", selectedShop)] : [where("shopName", "in", managedShops)];
                        return build({ shop: shopFilter, attendance: shopFilter, salary: salaryFilter });
                    }
                }
                
                if (role === 'Staff' && id) {
                    return build({ 
                        shop: [where("staffId", "==", id)], 
                        attendance: [where("employeeId", "==", id)],
                        salary: [where("staffId", "==", id)] 
                    });
                }

                return build({ shop: [where("shop", "==", "null")], attendance: [where("shop", "==", "null")], salary: [where("shopName", "==", "null")] });

            }, [userProfile, selectedShop, selectedEmployeeId, dateConstraints]); // Added selectedEmployeeId dependency
            
            const { data: attendanceData } = useCollection('attendance', payrollQueryConstraints.attendance);
            const { data: leaveRequestsData } = useCollection('leaveRequests', payrollQueryConstraints.leave);
            const { data: otRequestsData } = useCollection('otRequests', payrollQueryConstraints.ot);
            const { data: staffLoansData } = useCollection('staffLoans', payrollQueryConstraints.loan);
            const { data: employeeStatesData } = useCollection('employeeStates', payrollQueryConstraints.state);
            const { data: salaryRevisionsData } = useCollection('salaryRevisions', payrollQueryConstraints.salary);

            const allData = useMemo(() => ({
                shops, employees, shifts,
                attendance: attendanceData, leaveRequests: leaveRequestsData, otRequests: otRequestsData,
                staffLoans: staffLoansData, employeeStates: employeeStatesData, salaryRevisions: salaryRevisionsData,
            }), [shops, employees, shifts, attendanceData, leaveRequestsData, otRequestsData, staffLoansData, employeeStatesData, salaryRevisionsData]);
            
            const [manualLoanDeduction, setManualLoanDeduction] = useState(undefined);
            const [isProcessing, setIsProcessing] = useState(false);
            const [isRecalculated, setIsRecalculated] = useState(false);
            const [displayInputs, setDisplayInputs] = useState({});
            const [displayCalculations, setDisplayCalculations] = useState({});
            const [savingsData, setSavingsData] = useState(null);
            const [savingsWithdrawals, setSavingsWithdrawals] = useState([]);

            useEffect(() => {
                if (!db || !selectedEmployeeId) { setSavingsData(null); return; }
                const { doc, onSnapshot } = window.firebaseSDK;
                const unsubscribe = onSnapshot(doc(db, 'savingprogram', selectedEmployeeId), (doc) => {
                    if (doc.exists()) { setSavingsData(doc.data()); } else { setSavingsData(null); }
                }, (error) => { console.error("Error fetching savings data for payroll:", error); setSavingsData(null); });
                return () => unsubscribe();
            }, [db, selectedEmployeeId]);

            // --- Fetch Savings Withdrawals for Payroll Calculation ---
            useEffect(() => {
                if (!db || !selectedEmployeeId || !selectedMonth) {
                    setSavingsWithdrawals([]);
                    return;
                }
                const fetchWithdrawals = async () => {
                    try {
                        const { collection, query, where, getDocs } = window.firebaseSDK;
                        const [year, month] = selectedMonth.split('-').map(Number);
                        const startDate = new Date(year, month - 1, 1);
                        const endDate = new Date(year, month, 0, 23, 59, 59, 999); 

                        const q = query(
                            collection(db, 'savingprogram', selectedEmployeeId, 'transactions'),
                            where("date", ">=", startDate),
                            where("date", "<=", endDate)
                        );
                        
                        const querySnapshot = await getDocs(q);
                        const withdrawals = querySnapshot.docs
                            .map(doc => ({ id: doc.id, ...doc.data() }))
                            .filter(tx => tx.type === 'withdrawal');
                        setSavingsWithdrawals(withdrawals);
                    } catch (error) {
                        console.error("Error fetching payroll savings withdrawals:", error);
                        setSavingsWithdrawals([]);
                    }
                };
                fetchWithdrawals();
            }, [db, selectedEmployeeId, selectedMonth]);

            const isMultiShopManager = userProfile?.role === 'Shop Manager' && Array.isArray(userProfile.shop);
            const isShopManager = userProfile?.role === 'Shop Manager';

            const managedShops = useMemo(() => {
                if (isShopManager) {
                    return Array.isArray(userProfile.shop) ? userProfile.shop : (userProfile.shop ? [userProfile.shop] : []);
                }
                return [];
            }, [userProfile, isShopManager]);

            const selectedEmployee = useMemo(() => employees.find(emp => emp.id === selectedEmployeeId), [selectedEmployeeId, employees]);
            const { inputs: liveInputs, calculations: liveCalculations } = usePayrollCalculator(selectedEmployee, selectedMonth, allData, manualLoanDeduction, savingsWithdrawals, savingsData);

            useEffect(() => {
                if (editingRecord) {
                    setSelectedMonth(editingRecord.month); 
                    setSelectedShop(editingRecord.shop); 
                    setSelectedEmployeeId(editingRecord.employeeId);
                    setIsRecalculated(false); 
                }
            }, [editingRecord]);

            useEffect(() => {
                if (editingRecord && !isRecalculated) {
                    setDisplayInputs(editingRecord.manualInputs || {});
                    setDisplayCalculations(editingRecord.calculations || {});
                    setManualLoanDeduction(editingRecord.manualInputs?.loanDeduction);
                } else {
                    setDisplayInputs(liveInputs || {});
                    setDisplayCalculations(liveCalculations || {});
                }
            }, [editingRecord, liveInputs, liveCalculations, isRecalculated]);

            useEffect(() => {
                if (!editingRecord || isRecalculated) {
                    setManualLoanDeduction(liveInputs.autoLoanDeduction);
                }
            }, [liveInputs.autoLoanDeduction, editingRecord, isRecalculated]);

            useEffect(() => {
                if (!editingRecord && userProfile) {
                    if (userProfile.role === 'Admin' || isShopManager) { setSelectedShop(''); } 
                    else { setSelectedShop(userProfile.shop || ''); }
                    setSelectedEmployeeId(''); 
                    setSelectedMonth(currentMonth);
                    setManualLoanDeduction(undefined);
                    setIsRecalculated(false);
                }
            }, [editingRecord, userProfile, currentMonth, isShopManager]);
            
            const handleManualLoanChange = (e) => {
                const value = e.target.value;
                setManualLoanDeduction(value === '' ? undefined : parseFloat(value));
            };
            
            const handleRecalculate = () => {
                setDisplayInputs(liveInputs || {});
                setDisplayCalculations(liveCalculations || {});
                setManualLoanDeduction(liveInputs.loanDeduction); 
                setIsRecalculated(true);
            };

            const handleCancelRecalculation = () => {
                if (editingRecord) {
                    setDisplayInputs(editingRecord.manualInputs || {});
                    setDisplayCalculations(editingRecord.calculations || {});
                    setManualLoanDeduction(editingRecord.manualInputs?.loanDeduction);
                    setIsRecalculated(false);
                }
            };

            const availableShops = useAllowedShops(userProfile, shops);

            const employeesForDropdown = useMemo(() => {
                let relevantEmployees = [];
                if (userProfile?.role === 'Admin' || userProfile?.role === 'CEO') {
                     relevantEmployees = selectedShop 
                        ? employees.filter(e => Array.isArray(e.shop) ? e.shop.includes(selectedShop) : e.shop === selectedShop)
                        : []; 
                } else if (isShopManager) {
                    const shopsToFilter = selectedShop ? [selectedShop] : managedShops;
                    relevantEmployees = employees.filter(e => {
                        const employeeShops = Array.isArray(e.shop) ? e.shop : [e.shop];
                        return employeeShops.some(s => shopsToFilter.includes(s));
                    });
                } else { // Staff
                    relevantEmployees = employees.filter(e => e.shop === userProfile.shop);
                }
                return relevantEmployees.filter(e => e.status === 'Active');
            }, [selectedShop, employees, userProfile, isShopManager, managedShops]);

            const handleDownloadPayslip = () => {
                const payslipElement = document.getElementById('payslip-preview');
                if (!payslipElement || !selectedEmployee) { alert("Please select an employee to generate a payslip."); return; }
                const [year, month] = selectedMonth.split('-');
                const shopName = Array.isArray(selectedEmployee.shop) ? selectedEmployee.shop[0] : selectedEmployee.shop;
                html2canvas(payslipElement, { backgroundColor: '#ffffff', scale: 2 }).then(canvas => {
                    const link = document.createElement('a');
                    link.download = `${shopName}-${selectedEmployee.name}-${month}-${year.substring(2)}.png`;
                    link.href = canvas.toDataURL('image/png'); link.click();
                });
            };

            const handleSaveAndDownload = async () => {
                setIsProcessing(true);
                if (!selectedEmployee || displayCalculations.netSalary === undefined) {
                    alert("Cannot process. Please ensure an employee is selected and payroll is calculated.");
                    setIsProcessing(false);
                    return;
                }
                
                // FIX: Prioritize 'primaryShop' for Payroll Expense attribution
                const shopName = selectedEmployee.primaryShop 
                    ? selectedEmployee.primaryShop 
                    : (Array.isArray(selectedEmployee.shop) ? selectedEmployee.shop[0] : selectedEmployee.shop);

                // MODIFIED: Use writeBatch instead of runTransaction to avoid mandatory reads (Quota Fix)
                const { addDoc, collection, serverTimestamp, doc, updateDoc, getDocs, query, where, writeBatch } = window.firebaseSDK;
                
                // 1. Duplicate Check (Read 1 - Necessary Check)
                if (!editingRecord) {
                    try {
                        const payrollCheckQuery = query(collection(db, "payrollHistory"), where("employeeId", "==", selectedEmployee.id), where("month", "==", selectedMonth));
                        const existingPayrollSnap = await getDocs(payrollCheckQuery);
                        if (!existingPayrollSnap.empty) {
                            alert(`Payroll for ${selectedEmployee.name} for ${selectedMonth} has already been generated and saved.`);
                            setIsProcessing(false);
                            return; 
                        }
                    } catch (err) {
                        console.warn("Duplicate check skipped due to potential quota issues.", err);
                    }
                }

                // Prepare Data
                const finalInputsForSave = { ...displayInputs, loanDeduction: manualLoanDeduction };
                const payrollData = { 
                    month: selectedMonth, 
                    shop: shopName, 
                    employeeId: selectedEmployee.id, 
                    employeeName: selectedEmployee.name, 
                    baseSalary: displayCalculations.baseSalary, 
                    netSalary: displayCalculations.netSalary, 
                    manualInputs: finalInputsForSave, 
                    calculations: displayCalculations 
                };
                
                // 2. Identify Active Loan (from pre-loaded data)
                let activeLoan = null;
                if (finalInputsForSave.loanDeduction > 0) {
                    const applicableLoans = (allData.staffLoans || [])
                        .filter(l => l.staffId === selectedEmployee.id && l.status === 'Active' && (!l.effectiveDate || l.effectiveDate.slice(0, 7) <= selectedMonth))
                        .sort((a, b) => (b.effectiveDate || '0000-00').localeCompare(a.effectiveDate || '0000-00'));
                    if (applicableLoans.length > 0) activeLoan = applicableLoans[0];
                }

                // 3. Prepare Savings Data
                const savingsAmount = parseFloat(displayCalculations.savingsDeduction) || 0;

                try {
                    // --- OPTIMIZATION: BATCH WRITE ---
                    // This replaces runTransaction. It queues all writes and sends them in one go.
                    // Crucially, it does NOT require reading the docs first, preventing "Quota Exceeded" errors.
                    const batch = writeBatch(db);

                    // A. Save Payroll Record
                    let payrollRef;
                    if (editingRecord) {
                        payrollRef = doc(db, 'payrollHistory', editingRecord.id);
                        batch.update(payrollRef, payrollData);
                    } else {
                        payrollRef = doc(collection(db, 'payrollHistory'));
                        batch.set(payrollRef, { ...payrollData, createdAt: serverTimestamp() });
                    }

                    // B. Update Loan (if exists)
                    if (activeLoan) {
                        const newTotalPaid = (activeLoan.totalPaid || 0) + finalInputsForSave.loanDeduction;
                        const newBalance = activeLoan.loanAmount - newTotalPaid;
                        const newStatus = newBalance <= 0 ? 'Paid Off' : 'Active';
                        
                        const loanRef = doc(db, 'staffLoans', activeLoan.id);
                        batch.update(loanRef, { totalPaid: newTotalPaid, status: newStatus });
                        
                        const loanPayRef = doc(collection(db, 'loanPayments'));
                        batch.set(loanPayRef, { 
                            paymentDate: `${selectedMonth}-${new Date(selectedMonth.split('-')[0], selectedMonth.split('-')[1], 0).getDate()}`, 
                            staffId: selectedEmployee.id, 
                            staffName: selectedEmployee.name, 
                            shop: shopName, 
                            loanId: activeLoan.id, 
                            amountPaid: finalInputsForSave.loanDeduction, 
                            remainingBalance: newBalance, 
                            note: "Paid via payroll", 
                            payrollId: payrollRef.id 
                        });
                    }

                    // C. Update Savings (if amount > 0)
                    if (savingsAmount > 0) {
                        const parseSafeFloat = (val) => {
                            if (val === null || val === undefined) return 0;
                            const num = parseFloat(val);
                            return isNaN(num) ? 0 : num;
                        };

                        // Use the LOCALLY loaded savingsData (fresh from listener)
                        let currentBalance = 0;
                        let currentWithdrawals = 0;

                        if (savingsData) {
                            currentBalance = parseSafeFloat(savingsData.currentBalance);
                            currentWithdrawals = parseSafeFloat(savingsData.mySavingWithdrawalTotal);
                        }

                        const newBalance = currentBalance + savingsAmount;
                        const newCredit = newBalance + currentWithdrawals;

                        const savingsRef = doc(db, 'savingprogram', selectedEmployee.id);
                        const savingsUpdateData = { 
                            currentBalance: newBalance, 
                            mySavingCredit: newCredit, 
                            lastUpdated: serverTimestamp() 
                        };

                        if (savingsData) {
                            batch.update(savingsRef, savingsUpdateData);
                        } else {
                            // Robustness: Create if it doesn't exist yet
                            batch.set(savingsRef, { 
                                ...savingsUpdateData,
                                employeeId: selectedEmployee.id,
                                employeeName: selectedEmployee.name,
                                shop: shopName,
                                mySavingWithdrawalTotal: 0,
                                savingsProgramStatus: 'Active',
                                savingsPercentage: 0
                            });
                        }

                        // Add Savings Transaction Log
                        const savingsLogRef = doc(collection(db, 'savingprogram', selectedEmployee.id, 'transactions'));
                        batch.set(savingsLogRef, {
                            employeeId: selectedEmployee.id,
                            staffName: selectedEmployee.name,
                            shop: shopName,
                            date: serverTimestamp(),
                            amountDeducted: savingsAmount,
                            type: 'contribution',
                            payrollId: payrollRef.id,
                            note: 'Payroll Deduction'
                        });
                    }

                    // EXECUTE ALL WRITES
                    await batch.commit();

                    // Success!
                    alert('Payroll and all associated records saved successfully!');
                    
                    setTimeout(() => {
                        handleDownloadPayslip();
                        onSaveSuccess(selectedMonth);
                    }, 500);

                } catch (error) {
                    console.error("Error saving payroll:", error);
                    let msg = "Failed to save payroll.";
                    if (error.code === 'resource-exhausted') {
                        msg = "Daily Database Quota Exceeded. Writes failed. Please try again tomorrow.";
                    }
                    alert(msg);
                    setIsProcessing(false);
                }
            };
           
            const canSelectShop = (userProfile?.role === 'Admin' || userProfile?.role === 'CEO' || isShopManager) && !editingRecord;
        
            return (
                <>
                    <div className="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <Card><CardTitle>Payroll Calculator</CardTitle>
                        <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div>
                            <label className="text-sm font-medium text-slate-400"><i className="fas fa-calendar-alt mr-2 text-blue-400"></i>Month</label>
                            <input type="month" value={selectedMonth} onChange={e => setSelectedMonth(e.target.value)} className="input" disabled={!!editingRecord} />
                        </div>
                        <div>
                            <label className="text-sm font-medium text-slate-400"><i className="fas fa-store mr-2 text-cyan-400"></i>Shop</label>
                            {canSelectShop ? (
                                <select value={selectedShop} onChange={e => { setSelectedShop(e.target.value); setSelectedEmployeeId(''); }} className="select">
                                    <option value="">{userProfile?.role === 'Admin' || userProfile?.role === 'CEO' ? 'All Shops' : 'All My Shops'}</option>
                                    {availableShops.map(s => <option key={s.id} value={s.name}>{s.name}</option>)}
                                </select>
                            ) : (
                                <input value={selectedShop} className="input" disabled />
                            )}
                        </div>
                        <div>
                            <label className="text-sm font-medium text-slate-400"><i className="fas fa-user mr-2 text-emerald-400"></i>Employee</label>
                            <select value={selectedEmployeeId} onChange={e => setSelectedEmployeeId(e.target.value)} className="select" disabled={!!editingRecord || employeesForDropdown.length === 0}>
                                <option value="">Select Employee</option>
                                {employeesForDropdown.map(e => <option key={e.id} value={e.id}>{e.name}</option>)}
                            </select>
                        </div>
                    </div>{selectedEmployee && (<><div className="grid grid-cols-1 md:grid-cols-3 gap-4 pt-6 border-t border-slate-700"><h3 className="md:col-span-3 text-lg font-semibold text-slate-200">Attendance & Deductions</h3><div><label className="text-sm"><i className="fas fa-briefcase mr-2 text-slate-400"></i>Work Days</label><input type="number" name="workDays" value={displayInputs.workDays ?? ''} className="input" disabled /></div><div><label className="text-sm"><i className="fas fa-gift mr-2 text-pink-400"></i>Given Off Days</label><input type="number" name="givenOffDays" value={displayInputs.givenOffDays ?? ''} className="input" disabled /></div><div><label className="text-sm"><i className="fas fa-clock mr-2 text-purple-400"></i>OT Days</label><input type="number" name="otDays" value={displayInputs.otDays ?? ''} className="input" disabled /></div><div><label className="text-sm"><i className="fas fa-calendar-minus mr-2 text-orange-400"></i>Leave Days</label><input type="number" name="leaveDays" value={displayInputs.leaveDays ?? ''} className="input" disabled /></div><div><label className="text-sm"><i className="fas fa-user-clock mr-2 text-red-400"></i>Total Late Days</label><input type="number" name="totalLateDays" value={displayInputs.totalLateDays ?? ''} className="input" disabled /></div><div><label className="text-sm"><i className="fas fa-hand-holding-dollar mr-2 text-green-400"></i>Loan Deduction</label><input type="number" name="loanDeduction" value={manualLoanDeduction ?? ''} onChange={handleManualLoanChange} className="input" /></div></div>
                    
                    {/* FIX: Updated Button Group with Cancel Option */}
                    <div className="pt-6 border-t border-slate-700 flex flex-col gap-4">
                        {editingRecord ? (
                            <>
                                <div className="flex flex-col sm:flex-row gap-4 w-full">
                                    {isRecalculated ? (
                                        <>
                                            <Button variant="secondary" onClick={handleCancelRecalculation} className="flex-1">
                                                <i className="fas fa-undo"></i> Cancel Recalculation
                                            </Button>
                                            <Button variant="primary" onClick={handleSaveAndDownload} disabled={isProcessing} className="flex-1">
                                                {isProcessing ? (<><i className="fas fa-spinner fa-spin"></i> Processing...</>) : (<><i className="fas fa-save"></i> Save Updated Record</>)}
                                            </Button>
                                        </>
                                    ) : (
                                        <>
                                            <Button variant="secondary" onClick={handleDownloadPayslip} className="flex-1">
                                                <i className="fas fa-download"></i> Download Original
                                            </Button>
                                            <Button variant="primary" onClick={handleRecalculate} icon="fa-calculator" className="flex-1">
                                                Recalculate with Live Data
                                            </Button>
                                        </>
                                    )}
                                </div>
                                {/* NEW: Explicit Exit Button */}
                                <Button variant="danger" onClick={onCancelEdit} className="w-full bg-red-900/30 text-red-300 hover:bg-red-900/50 border border-red-900/50">
                                    <i className="fas fa-times"></i> Cancel & Exit Edit Mode
                                </Button>
                            </>
                        ) : (
                            <Button variant="primary" onClick={handleSaveAndDownload} disabled={isProcessing} className="flex-1 w-full">
                                {isProcessing ? (<><i className="fas fa-spinner fa-spin"></i> Processing...</>) : (<><i className="fas fa-save"></i> Save & Download</>)}
                            </Button>
                        )}
                    </div></>)}</Card>
                    <PayslipPreview 
                        selectedEmployee={selectedEmployee}
                        selectedMonth={selectedMonth}
                        manualInputs={{...displayInputs, loanDeduction: manualLoanDeduction }}
                        calculations={displayCalculations}
                        isRecalculated={isRecalculated}
                        originalRecord={editingRecord}
                    />
                    </div>

                    {(userProfile?.role === 'Admin' || userProfile?.role === 'CEO' || userProfile?.role === 'Shop Manager') && (
                        <div className="mt-8">
                            <TriggerSalaryTab />
                        </div>
                    )}
                </>
            );
        };

        // --- RESTORED COMPONENT: Payroll History Tab ---
        const PayrollHistoryTab = ({ userProfile, onEdit }) => {
            const { db } = useFirebase();
            const { shops } = useAppData(); 
            const [history, setHistory] = useState([]);
            const [loading, setLoading] = useState(true);
            const [selectedShop, setSelectedShop] = useState('');
            const [selectedMonth, setSelectedMonth] = useState(new Date().toISOString().slice(0, 7));
            const [searchTerm, setSearchTerm] = useState('');
            const [recordToDelete, setRecordToDelete] = useState(null);

            // Fetch Data
            useEffect(() => {
                if (!db || !userProfile) return;
                setLoading(true);
                
                const { collection, query, orderBy, onSnapshot, where } = window.firebaseSDK;
                let q = query(collection(db, 'payrollHistory'), orderBy('month', 'desc'));

                if (userProfile.role === 'Staff') {
                    q = query(q, where('employeeId', '==', userProfile.id));
                } else if (userProfile.role === 'Shop Manager') {
                     const myShops = Array.isArray(userProfile.shop) ? userProfile.shop : [userProfile.shop];
                     if (myShops.length > 0) {
                        q = query(q, where('shop', 'in', myShops));
                     } else {
                        q = query(q, where('shop', '==', 'null'));
                     }
                }

                const unsubscribe = onSnapshot(q, (snapshot) => {
                    const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    setHistory(data);
                    setLoading(false);
                }, (error) => {
                    console.error("Error fetching payroll history:", error);
                    setLoading(false);
                });

                return () => unsubscribe();
            }, [db, userProfile]);

            // Set initial shop filter
            useEffect(() => {
                if (userProfile && userProfile.role !== 'Admin' && userProfile.role !== 'CEO') {
                    setSelectedShop(Array.isArray(userProfile.shop) ? '' : userProfile.shop || '');
                }
            }, [userProfile]);

            // Filter Data
            const filteredHistory = useMemo(() => {
                return history.filter(rec => {
                    const shopMatch = !selectedShop || rec.shop === selectedShop;
                    const monthMatch = !selectedMonth || rec.month === selectedMonth;
                    const searchMatch = !searchTerm || rec.employeeName.toLowerCase().includes(searchTerm.toLowerCase());
                    return shopMatch && monthMatch && searchMatch;
                });
            }, [history, selectedShop, selectedMonth, searchTerm]);

            // Calculate Totals
            const totals = useMemo(() => {
                return filteredHistory.reduce((acc, curr) => ({
                    baseSalary: acc.baseSalary + (parseFloat(curr.baseSalary) || 0),
                    engagements: acc.engagements + (parseFloat(curr.calculations?.engagements) || 0),
                    otSalary: acc.otSalary + (parseFloat(curr.calculations?.otSalary) || 0),
                    totalSavingsPayback: acc.totalSavingsPayback + (parseFloat(curr.calculations?.totalSavingsWithdrawal) || 0),
                    loanDeduction: acc.loanDeduction + (parseFloat(curr.manualInputs?.loanDeduction) || 0),
                    otherDeductions: acc.otherDeductions + (parseFloat(curr.calculations?.otherDeductions) || 0),
                    savingsDeduction: acc.savingsDeduction + (parseFloat(curr.calculations?.savingsDeduction) || 0),
                    netSalary: acc.netSalary + (parseFloat(curr.netSalary) || 0)
                }), { baseSalary: 0, engagements: 0, otSalary: 0, totalSavingsPayback: 0, loanDeduction: 0, otherDeductions: 0, savingsDeduction: 0, netSalary: 0 });
            }, [filteredHistory]);

            // Delete Handler with Rollback
            const handleDelete = async () => {
                if (!recordToDelete) return;
                
                // OPTIMIZATION: Safety check for dependencies
                const { writeBatch, doc, getDocs, query, where, increment, collection } = window.firebaseSDK;
                if (!increment) {
                    alert("System update incomplete. Please refresh the page to load the latest fixes.");
                    return;
                }

                try {
                    const batch = writeBatch(db);

                    // 1. Delete Payroll Record
                    batch.delete(doc(db, 'payrollHistory', recordToDelete.id));

                    // 2. Find and Delete Linked Loan Payments & Revert Loan Balance
                    const loanQuery = query(collection(db, 'loanPayments'), where('payrollId', '==', recordToDelete.id));
                    const loanSnap = await getDocs(loanQuery);
                    loanSnap.forEach(d => {
                        const payData = d.data();
                        batch.delete(d.ref);
                        if (payData.loanId) {
                            const loanRef = doc(db, 'staffLoans', payData.loanId);
                            batch.update(loanRef, { 
                                totalPaid: increment(-payData.amountPaid),
                                status: 'Active' 
                            });
                        }
                    });

                    // 3. Find and Delete Linked Savings Transactions & Revert Savings Balance
                    const savingsQuery = query(
                        collection(db, 'savingprogram', recordToDelete.employeeId, 'transactions'), 
                        where('payrollId', '==', recordToDelete.id)
                    );
                    
                    const savingsSnap = await getDocs(savingsQuery);
                    let savingsAmountRevert = 0;
                    savingsSnap.forEach(d => {
                        const txData = d.data();
                        if (txData.type === 'contribution') {
                            savingsAmountRevert += (txData.amountDeducted || 0);
                        }
                        batch.delete(d.ref);
                    });

                    if (savingsAmountRevert > 0) {
                        const savingsRef = doc(db, 'savingprogram', recordToDelete.employeeId);
                        batch.update(savingsRef, {
                            currentBalance: increment(-savingsAmountRevert),
                            mySavingCredit: increment(-savingsAmountRevert)
                        });
                    }

                    await batch.commit();
                    setRecordToDelete(null);
                    alert("Record deleted successfully and balances reverted.");
                } catch (err) {
                    console.error("Delete error:", err);
                    if (err.code === 'resource-exhausted') {
                        alert(" CRITICAL ERROR: Daily Database Quota Exceeded.\n\nThe system cannot read the Savings or Loan records to safely revert the balance. The deletion has been blocked to prevent data corruption.\n\nPlease try again tomorrow (GMT+0).");
                    } else if (err.message && err.message.includes('increment is not a function')) {
                        alert("System Error: Please refresh the page to reload the Firebase SDK.");
                    } else {
                        alert(`Failed to delete record: ${err.message}`);
                    }
                }
            };

            // FIX: Restored Correct UI for Payroll History (Was incorrectly showing SysConfig UI)
            const availableShops = useAllowedShops(userProfile, shops);

            return (
                <Card>
                    <PageHeader title="Payroll History Log">
                        <div className="flex flex-wrap gap-4 items-center">
                            <SearchInput value={searchTerm} onChange={e => setSearchTerm(e.target.value)} placeholder="Search employee..." />
                            
                            {(userProfile?.role === 'Admin' || userProfile?.role === 'CEO' || (userProfile?.role === 'Shop Manager' && Array.isArray(userProfile.shop))) && (
                                <select value={selectedShop} onChange={e => setSelectedShop(e.target.value)} className="select w-full sm:w-auto">
                                    <option value="">{userProfile.role === 'Admin' || userProfile.role === 'CEO' ? 'All Shops' : 'All My Shops'}</option>
                                    {availableShops.map(s => <option key={s.id} value={s.name}>{s.name}</option>)}
                                </select>
                            )}
                            
                            <input type="month" value={selectedMonth} onChange={e => setSelectedMonth(e.target.value)} className="input w-full sm:w-auto" />
                        </div>
                    </PageHeader>

                    {loading ? (
                        <div className="text-center py-10"><i className="fas fa-spinner fa-spin text-3xl text-blue-500"></i></div>
                    ) : (
                        <div className="overflow-x-auto">
                            <table className="min-w-full divide-y divide-slate-700">
                                <thead className="bg-slate-900/50">
                                    <tr>
                                        <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Month</th>
                                        <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Shop</th>
                                        <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Employee</th>
                                        <th className="px-4 py-3 text-right text-xs font-semibold text-slate-400 uppercase">Base Salary</th>
                                        
                                        {/* NEW: Requested Columns */}
                                        <th className="px-4 py-3 text-right text-xs font-semibold text-slate-400 uppercase">Engage.</th>
                                        <th className="px-4 py-3 text-right text-xs font-semibold text-slate-400 uppercase">OT Sal.</th>
                                        <th className="px-4 py-3 text-right text-xs font-semibold text-slate-400 uppercase">Sav. Back</th>
                                        <th className="px-4 py-3 text-right text-xs font-semibold text-slate-400 uppercase">Loan Ded.</th>
                                        <th className="px-4 py-3 text-right text-xs font-semibold text-slate-400 uppercase">Oth. Ded.</th>
                                        <th className="px-4 py-3 text-right text-xs font-semibold text-slate-400 uppercase">Sav. Ded.</th>

                                        <th className="px-4 py-3 text-right text-xs font-semibold text-slate-400 uppercase">Net Salary</th>
                                        <th className="px-4 py-3 text-center text-xs font-semibold text-slate-400 uppercase">Actions</th>
                                    </tr>
                                </thead>
                                <tbody className="divide-y divide-slate-700">
                                    {filteredHistory.map(rec => (
                                        <tr key={rec.id} className="hover:bg-slate-700/50 transition-colors">
                                            <td className="px-4 py-4 text-sm text-slate-300 whitespace-nowrap">{rec.month}</td>
                                            <td className="px-4 py-4 text-sm text-slate-300">{rec.shop}</td>
                                            <td className="px-4 py-4 text-sm text-slate-200 font-medium">{rec.employeeName}</td>
                                            <td className="px-4 py-4 text-sm text-right text-slate-400">{Utils.formatCurrency(rec.baseSalary)}</td>
                                            
                                            {/* NEW: Requested Data Fields */}
                                            <td className="px-4 py-4 text-sm text-right text-green-300 font-medium">{Utils.formatCurrency(rec.calculations?.engagements)}</td>
                                            <td className="px-4 py-4 text-sm text-right text-blue-300">{Utils.formatCurrency(rec.calculations?.otSalary)}</td>
                                            <td className="px-4 py-4 text-sm text-right text-indigo-300">{Utils.formatCurrency(rec.calculations?.totalSavingsWithdrawal)}</td>
                                            <td className="px-4 py-4 text-sm text-right text-orange-300">{Utils.formatCurrency(rec.manualInputs?.loanDeduction)}</td>
                                            <td className="px-4 py-4 text-sm text-right text-red-300">{Utils.formatCurrency(rec.calculations?.otherDeductions)}</td>
                                            <td className="px-4 py-4 text-sm text-right text-blue-400">{Utils.formatCurrency(rec.calculations?.savingsDeduction)}</td>

                                            <td className="px-4 py-4 text-sm text-right font-bold text-green-400">{Utils.formatCurrency(rec.netSalary)}</td>
                                            <td className="px-4 py-4 text-center">
                                                <div className="flex items-center justify-center gap-2">
                                                    <Button variant="icon-edit" icon="fa-edit" onClick={() => onEdit(rec)} title="Edit & Recalculate" />
                                                    {(userProfile?.role === 'Admin' || userProfile?.role === 'CEO') && (
                                                        <Button variant="icon-delete" icon="fa-trash" onClick={() => setRecordToDelete(rec)} title="Delete Record" />
                                                    )}
                                                </div>
                                            </td>
                                        </tr>
                                    ))}
                                    {filteredHistory.length === 0 && (
                                        <tr><td colSpan="12" className="px-4 py-8 text-center text-slate-500">No records found.</td></tr>
                                    )}
                                </tbody>
                                <tfoot className="bg-slate-900/50">
                                    <tr>
                                        {/* Adjusted colSpan to match new column count (4 base + 6 new = 10 columns before Net Salary) */}
                                        <td colSpan="10" className="px-4 py-3 text-right font-bold text-slate-300 uppercase">Total Net Salary</td>
                                        <td className="px-4 py-3 text-right font-bold text-blue-400">{Utils.formatCurrency(totals.netSalary)}</td>
                                        <td></td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                    )}
                    
                    <ConfirmationModal 
                        isOpen={!!recordToDelete} 
                        onClose={() => setRecordToDelete(null)} 
                        onConfirm={handleDelete} 
                        title="Delete Payroll Record" 
                        message={`Are you sure you want to delete the payroll record for ${recordToDelete?.employeeName}? \n\n WARNING: This will also REVERT any linked Loan Deductions (adding balance back to loan) and Savings Contributions (removing from savings balance).`} 
                    />
                </Card>
            );
        };

        // --- FIX: ADDED MISSING PAYROLL PAGE COMPONENT ---
        const PayrollPage = ({ userProfile }) => {
            const { moduleConfig = {} } = useAppData();
            const [activeTab, setActiveTab] = useState('calculator');
            
            // State to handle editing from history tab
            const [editingRecord, setEditingRecord] = useState(null);

            const handleEdit = (record) => {
                setEditingRecord(record);
                setActiveTab('calculator');
            };

            const handleSaveSuccess = () => {
                setEditingRecord(null);
                setActiveTab('history');
            };

            const tabs = useMemo(() => {
                const available = {};
                const isEnabled = (key) => moduleConfig?.[key] !== false;

                if (isEnabled('payroll:calculator')) {
                    available.calculator = <span><i className="fas fa-calculator mr-2 text-blue-400"></i>Calculator</span>;
                }
                if (isEnabled('payroll:history')) {
                    available.history = <span><i className="fas fa-history mr-2 text-green-400"></i>History</span>;
                }
                return available;
            }, [moduleConfig]);

            useEffect(() => {
                const keys = Object.keys(tabs);
                if (keys.length > 0 && !tabs[activeTab]) {
                    setActiveTab(keys[0]);
                }
            }, [tabs, activeTab]);

            return (
                <TabbedPage tabs={tabs} activeTab={activeTab} setActiveTab={setActiveTab}>
                    {tabs.calculator && (
                        <div id="calculator">
                            <PayrollCalculatorTab 
                                userProfile={userProfile} 
                                editingRecord={editingRecord}
                                onSaveSuccess={handleSaveSuccess}
                                // NEW: Pass the cancel handler
                                onCancelEdit={() => setEditingRecord(null)}
                            />
                        </div>
                    )}
                    {tabs.history && (
                        <div id="history">
                            <PayrollHistoryTab 
                                userProfile={userProfile} 
                                onEdit={handleEdit}
                            />
                        </div>
                    )}
                </TabbedPage>
            );
        };

        // --- NEW: Payroll Expenses Tab (Restored) ---
        const PayrollExpensesTab = ({ userProfile }) => {
            const { where } = window.firebaseSDK;
            // ... (Previous logic from ExpenseReportPage goes here) ...
            // RE-USE EXISTING LOGIC from the original ExpenseReportPage component
            // to populate this tab.
            
            // COPYING LOGIC FROM OLD ExpenseReportPage
            const { data: payrollHistory } = useCollection('payrollHistory', []); // Query constraints logic handles permissions below
            const { data: shops } = useCollection('shops');
            const [selectedShop, setSelectedShop] = useState('');
            const [selectedMonth, setSelectedMonth] = useState(new Date().toISOString().slice(0, 7));
            
            useEffect(() => {
                if (userProfile && userProfile.role !== 'Admin' && userProfile.role !== 'CEO') {
                    setSelectedShop(Array.isArray(userProfile.shop) ? '' : userProfile.shop || '');
                }
            }, [userProfile]);

            const availableShops = useMemo(() => {
                if (userProfile?.role === 'Admin' || userProfile?.role === 'CEO') return shops;
                if (userProfile?.role === 'Shop Manager' && Array.isArray(userProfile.shop)) {
                    return shops.filter(s => userProfile.shop.includes(s.name));
                }
                return [];
            }, [shops, userProfile]);

            const { expenseSummary, totals } = useMemo(() => {
                if (!payrollHistory.length) return { expenseSummary: [], totals: {} };
                
                // Client-side filtering because useCollection reused logic is tricky here without props
                const filteredHistory = payrollHistory.filter(rec => {
                    const shopMatch = !selectedShop || rec.shop === selectedShop;
                    const monthMatch = !selectedMonth || rec.month === selectedMonth;
                    
                    // Role check
                    let roleMatch = false;
                    if (userProfile?.role === 'Admin' || userProfile?.role === 'CEO') roleMatch = true;
                    else if (userProfile?.role === 'Shop Manager') {
                        const managed = Array.isArray(userProfile.shop) ? userProfile.shop : [userProfile.shop];
                        roleMatch = managed.includes(rec.shop);
                    }
                    
                    return shopMatch && monthMatch && roleMatch;
                });
                
                const summary = filteredHistory.reduce((acc, rec) => {
                    if (!rec.shop || !rec.month) return acc;
                    const key = `${rec.shop}_${rec.month}`;
                    if (!acc[key]) { acc[key] = { month: rec.month, shopName: rec.shop, totalLoanDed: 0, totalOtherDed: 0, totalSavingsDed: 0, totalSavingsPayback: 0, totalFinalSalary: 0 }; }
                    acc[key].totalLoanDed += parseFloat(rec.manualInputs?.loanDeduction) || 0;
                    acc[key].totalOtherDed += parseFloat(rec.calculations?.otherDeductions) || 0;
                    acc[key].totalSavingsDed += parseFloat(rec.calculations?.savingsDeduction) || 0;
                    acc[key].totalSavingsPayback += parseFloat(rec.calculations?.totalSavingsWithdrawal) || 0;
                    acc[key].totalFinalSalary += parseFloat(rec.netSalary) || 0;
                    return acc;
                }, {});

                const summaryArray = Object.values(summary).map(item => {
                    const accountNote = (item.totalFinalSalary || 0) + (item.totalLoanDed || 0) + (item.totalOtherDed || 0) + (item.totalSavingsDed || 0);
                    return { ...item, accountNote };
                }).sort((a, b) => b.month.localeCompare(a.month) || a.shopName.localeCompare(b.shopName));

                const totals = summaryArray.reduce((acc, curr) => { 
                    acc.totalLoanDed += curr.totalLoanDed; 
                    acc.totalOtherDed += curr.totalOtherDed; 
                    acc.totalSavingsDed += curr.totalSavingsDed;
                    acc.totalSavingsPayback += curr.totalSavingsPayback;
                    acc.totalFinalSalary += curr.totalFinalSalary; 
                    acc.totalAccountNote += curr.accountNote;
                    return acc; 
                }, { totalLoanDed: 0, totalOtherDed: 0, totalSavingsDed: 0, totalSavingsPayback: 0, totalFinalSalary: 0, totalAccountNote: 0 });
                
                return { expenseSummary: summaryArray, totals };
            }, [payrollHistory, selectedShop, selectedMonth, userProfile]);
            
            const canFilterByShop = userProfile?.role === 'Admin' || userProfile?.role === 'CEO' || (userProfile?.role === 'Shop Manager' && Array.isArray(userProfile.shop));

            return (
                <Card>
                    <div className="flex flex-wrap gap-4 justify-between items-center mb-6">
                        <h3 className="text-xl font-semibold text-slate-100">Payroll Expense Summary</h3>
                        <div className="flex flex-wrap gap-4 items-center">
                            {canFilterByShop && (
                                <select value={selectedShop} onChange={e => setSelectedShop(e.target.value)} className="select w-full sm:w-auto">
                                    <option value="">{userProfile.role === 'Admin' || userProfile.role === 'CEO' ? 'All Shops' : 'All My Shops'}</option>
                                    {availableShops.map(s => <option key={s.id} value={s.name}>{s.name}</option>)}
                                </select>
                            )}
                            <input type="month" value={selectedMonth} onChange={e => setSelectedMonth(e.target.value)} className="input w-full sm:w-auto" />
                        </div>
                    </div>
                    <div className="overflow-x-auto"><table className="min-w-full divide-y divide-slate-700"><thead className="bg-slate-900/50"><tr><th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Month</th><th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Shop Name</th><th className="px-4 py-3 text-right text-xs font-semibold text-slate-400 uppercase">Total Loan Ded.</th><th className="px-4 py-3 text-right text-xs font-semibold text-slate-400 uppercase">Total Other Ded.</th><th className="px-4 py-3 text-right text-xs font-semibold text-slate-400 uppercase">Saving Program</th><th className="px-4 py-3 text-right text-xs font-semibold text-slate-400 uppercase">Savings Payback</th><th className="px-4 py-3 text-right text-xs font-semibold text-slate-400 uppercase">Total Final Salary</th><th className="px-4 py-3 text-right text-xs font-semibold text-slate-400 uppercase">Account Note</th></tr></thead><tbody className="divide-y divide-slate-700">{expenseSummary.map((item, index) => (<tr key={index} className="hover:bg-slate-700/50"><td className="px-4 py-4 text-sm text-slate-200">{item.month}</td><td className="px-4 py-4 text-sm text-slate-300">{item.shopName}</td><td className="px-4 py-4 text-sm text-slate-300 text-right">{Utils.formatCurrency(item.totalLoanDed)}</td><td className="px-4 py-4 text-sm text-slate-300 text-right">{Utils.formatCurrency(item.totalOtherDed)}</td><td className="px-4 py-4 text-sm text-slate-300 text-right">{Utils.formatCurrency(item.totalSavingsDed)}</td><td className="px-4 py-4 text-sm text-slate-300 text-right">{Utils.formatCurrency(item.totalSavingsPayback)}</td><td className="px-4 py-4 text-sm text-slate-300 text-right font-semibold">{Utils.formatCurrency(item.totalFinalSalary)}</td><td className="px-4 py-4 text-sm text-slate-300 text-right font-semibold">{Utils.formatCurrency(item.accountNote)}</td></tr>))}</tbody><tfoot className="bg-slate-900/50"><tr><td colSpan="2" className="px-4 py-3 text-right font-bold text-slate-300 uppercase">Sub-Total</td><td className="px-4 py-3 text-right font-bold text-slate-300">{Utils.formatCurrency(totals.totalLoanDed)}</td><td className="px-4 py-3 text-right font-bold text-slate-300">{Utils.formatCurrency(totals.totalOtherDed)}</td><td className="px-4 py-3 text-right font-bold text-slate-300">{Utils.formatCurrency(totals.totalSavingsDed)}</td><td className="px-4 py-3 text-right font-bold text-slate-300">{Utils.formatCurrency(totals.totalSavingsPayback)}</td><td className="px-4 py-3 text-right font-bold text-slate-300">{Utils.formatCurrency(totals.totalFinalSalary)}</td><td className="px-4 py-3 text-right font-bold text-slate-300">{Utils.formatCurrency(totals.totalAccountNote)}</td></tr></tfoot></table></div>
                </Card>
            );
        };

        // NEW: Component to manage Operational (Shop) Expenses
        // REPLACED with new version supporting Cash Advance/Shop Fund

        // NEW: Modal for Shop Fund Top Up (Helper for OperationalExpensesTab)
        const TopUpModal = ({ isOpen, onClose, onConfirm, shopName }) => {
            const [amount, setAmount] = useState('');
            const [note, setNote] = useState('');

            useEffect(() => {
                if (isOpen) {
                    setAmount('');
                    setNote('');
                }
            }, [isOpen]);

            const handleSubmit = (e) => {
                e.preventDefault();
                const val = parseFloat(amount);
                if (isNaN(val) || val <= 0) {
                    alert("Please enter a valid amount.");
                    return;
                }
                onConfirm(val, note);
            };

            if (!isOpen) return null;

            return (
                <Modal isOpen={isOpen} onClose={onClose} maxWidth="max-w-sm">
                    <form onSubmit={handleSubmit}>
                        <ModalHeader title={`Top Up: ${shopName}`} onClose={onClose} />
                        <ModalBody>
                            <div className="space-y-4">
                                <div className="p-3 bg-blue-900/20 border border-blue-700/30 rounded-lg text-sm text-blue-200">
                                    <i className="fas fa-info-circle mr-2"></i> Adding funds to the shop's petty cash wallet.
                                </div>
                                <div>
                                    <label className="text-sm font-medium text-slate-400">Amount (KHR)</label>
                                    <input 
                                        type="number" 
                                        value={amount} 
                                        onChange={e => setAmount(e.target.value)} 
                                        className="input font-bold text-green-400 text-lg" 
                                        placeholder="0" 
                                        required 
                                        autoFocus 
                                    />
                                </div>
                                <div>
                                    <label className="text-sm font-medium text-slate-400">Note (Optional)</label>
                                    <input 
                                        type="text" 
                                        value={note} 
                                        onChange={e => setNote(e.target.value)} 
                                        className="input" 
                                        placeholder="e.g., Monthly Replenishment" 
                                    />
                                </div>
                            </div>
                        </ModalBody>
                        <ModalFooter>
                            <Button variant="secondary" onClick={onClose}>Cancel</Button>
                            <Button type="submit" variant="success" icon="fa-plus-circle">Confirm Deposit</Button>
                        </ModalFooter>
                    </form>
                </Modal>
            );
        };

        const OperationalExpensesTab = ({ userProfile }) => {
            const { db, auth } = useFirebase();
            const { shops, expenseCategories } = useAppData();
            const { where, addDoc, updateDoc, deleteDoc, doc, collection, serverTimestamp, writeBatch, increment, onSnapshot, query, orderBy } = window.firebaseSDK;

            const [expenses, setExpenses] = useState([]);
            const [loading, setLoading] = useState(true);
            const [isModalOpen, setIsModalOpen] = useState(false);
            const [editingExpense, setEditingExpense] = useState(null);
            const [expenseToDelete, setExpenseToDelete] = useState(null);

            // Filters
            const [selectedShop, setSelectedShop] = useState('');
            const [selectedMonth, setSelectedMonth] = useState(new Date().toISOString().slice(0, 7));
            const [selectedCategory, setSelectedCategory] = useState('');

            // --- PHASE 1: SHOP FUNDS STATE ---
            const [shopFunds, setShopFunds] = useState({}); 
            
            // --- PHASE 2: TOP UP STATE ---
            const [isTopUpModalOpen, setIsTopUpModalOpen] = useState(false);
            const [topUpShop, setTopUpShop] = useState('');

            // Categories
            const categoriesList = useMemo(() => {
                if (expenseCategories && expenseCategories.length > 0) {
                    return expenseCategories.map(c => c.name).sort();
                }
                return ['Utilities (Water/Electric)', 'Internet/Phone', 'Office Supplies', 'Cleaning Supplies', 'Maintenance/Repairs', 'Rent', 'Staff Welfare', 'Transportation', 'Marketing', 'Other'];
            }, [expenseCategories]);

            // Real-time Fund Listener
            useEffect(() => {
                if (!db) return;
                const q = collection(db, 'shopFunds');
                const unsub = onSnapshot(q, (snapshot) => {
                    const funds = {};
                    snapshot.docs.forEach(doc => {
                        funds[doc.id] = doc.data().balance || 0;
                    });
                    setShopFunds(funds);
                });
                return () => unsub();
            }, [db]);

            // Fetch Expenses
            useEffect(() => {
                if (!db || !userProfile) return;
                setLoading(true);

                const collectionRef = collection(db, 'shopExpenses');
                const startStr = `${selectedMonth}-01`;
                const endStr = `${selectedMonth}-31`; 

                let constraints = [
                    where('date', '>=', startStr), 
                    where('date', '<=', endStr),
                    orderBy('date', 'desc')
                ];
                
                if (userProfile.role === 'Shop Manager') {
                    const managedShops = Array.isArray(userProfile.shop) ? userProfile.shop : (userProfile.shop ? [userProfile.shop] : []);
                    if (managedShops.length > 0) {
                        constraints.push(where("shop", "in", managedShops));
                    } else {
                        constraints.push(where("shop", "==", "null"));
                    }
                } else if (userProfile.role === 'Staff') {
                     constraints.push(where("shop", "==", "null"));
                }

                const q = query(collectionRef, ...constraints);

                const unsubscribe = onSnapshot(q, (snapshot) => {
                    const items = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    setExpenses(items);
                    setLoading(false);
                }, (error) => {
                    console.error("Error fetching expenses:", error);
                    setLoading(false);
                });

                return () => unsubscribe();
            }, [db, userProfile, selectedMonth]);

            useEffect(() => {
                if (userProfile && userProfile.role !== 'Admin' && userProfile.role !== 'CEO') {
                    setSelectedShop(Array.isArray(userProfile.shop) ? '' : userProfile.shop || '');
                }
            }, [userProfile]);

            const availableShops = useAllowedShops(userProfile, shops);

            const filteredExpenses = useMemo(() => {
                return expenses.filter(exp => {
                    const shopMatch = !selectedShop || exp.shop === selectedShop;
                    const catMatch = !selectedCategory || exp.category === selectedCategory;
                    return shopMatch && catMatch;
                });
            }, [expenses, selectedShop, selectedCategory]);

            const totalAmount = useMemo(() => filteredExpenses.reduce((sum, item) => sum + (parseFloat(item.amount) || 0), 0), [filteredExpenses]);

            // Handlers
            const handleOpenModal = (expense = null) => {
                setEditingExpense(expense);
                setIsModalOpen(true);
            };

            // --- PHASE 2: HANDLE TOP UP (DEPOSIT) ---
            const handleTopUp = async (amount, note) => {
                if (!topUpShop || amount <= 0) return;
                try {
                    const batch = writeBatch(db);
                    
                    // 1. Update Fund Balance (Create doc if missing)
                    const fundRef = doc(db, 'shopFunds', topUpShop);
                    // Use 'increment' to safely add to existing balance even if other writes happen
                    // Use 'merge: true' to create the document if it doesn't exist yet
                    batch.set(fundRef, { 
                        balance: increment(amount), 
                        lastUpdated: serverTimestamp() 
                    }, { merge: true });

                    // 2. Log User Activity for Audit
                    Utils.logUserActivity(db, auth, 'Shop Fund Deposit', {
                        shop: topUpShop,
                        amount: amount,
                        note: note
                    });

                    await batch.commit();
                    alert(`Successfully deposited ${Utils.formatCurrency(amount)} to ${topUpShop}`);
                    setIsTopUpModalOpen(false);
                } catch (error) {
                    console.error("Top up error:", error);
                    alert("Failed to top up.");
                }
            };

            // --- PHASE 3: HANDLE SAVE EXPENSE (SPENDING LOGIC) ---
            const handleSave = async (formData) => {
                try {
                    const amount = parseFloat(formData.amount);
                    const data = { ...formData, amount };
                    
                    const batch = writeBatch(db);

                    if (editingExpense) {
                        const expenseRef = doc(db, 'shopExpenses', editingExpense.id);
                        batch.update(expenseRef, { ...data, updatedAt: serverTimestamp() });
                    } else {
                        const newExpenseRef = doc(collection(db, 'shopExpenses'));
                        batch.set(newExpenseRef, { ...data, createdAt: serverTimestamp(), createdBy: userProfile.id });

                        if (data.paidViaFund) {
                            const fundRef = doc(db, 'shopFunds', data.shop);
                            batch.set(fundRef, { 
                                balance: increment(-amount), 
                                lastUpdated: serverTimestamp() 
                            }, { merge: true });
                        }
                    }

                    await batch.commit();
                    setIsModalOpen(false);
                    setEditingExpense(null);
                } catch (error) {
                    console.error("Error saving expense:", error);
                    alert("Failed to save expense.");
                }
            };

            // --- PHASE 4: HANDLE DELETE (SAFETY NET REVERSAL) ---
            const handleDelete = async () => {
                if (!expenseToDelete) return;
                try {
                    const batch = writeBatch(db);
                    const expenseRef = doc(db, 'shopExpenses', expenseToDelete.id);
                    
                    // 1. Delete the expense record
                    batch.delete(expenseRef);

                    let refundMessage = "";

                    // 2. SAFETY NET: Refund amount to wallet if it was paid via fund
                    if (expenseToDelete.paidViaFund) {
                         const fundRef = doc(db, 'shopFunds', expenseToDelete.shop);
                         // Atomic increment to add the money back
                         batch.update(fundRef, { 
                             balance: increment(expenseToDelete.amount), 
                             lastUpdated: serverTimestamp() 
                         });
                         refundMessage = `\n\n ${Utils.formatCurrency(expenseToDelete.amount)} has been refunded to the Shop Wallet.`;
                    }

                    await batch.commit();
                    setExpenseToDelete(null);
                    
                    // 3. User Feedback
                    if (refundMessage) {
                        alert(`Expense deleted successfully.${refundMessage}`);
                    }

                } catch (error) {
                    console.error("Error deleting expense:", error);
                    alert("Failed to delete expense. Please try again.");
                }
            };

            const handleExportExcel = () => {
                const data = filteredExpenses.map(e => ({
                    'Date': e.date,
                    'Shop': e.shop,
                    'Category': e.category,
                    'Description': e.description,
                    'Amount (KHR)': e.amount,
                    'Paid By': e.paidViaFund ? 'Shop Fund' : 'Cash/Other',
                    'Recorded By': e.recordedBy || '-'
                }));
                if (window.XLSX) {
                    const ws = XLSX.utils.json_to_sheet(data);
                    const wb = XLSX.utils.book_new();
                    XLSX.utils.book_append_sheet(wb, ws, "Operational Expenses");
                    XLSX.writeFile(wb, `Operational_Expenses_${selectedMonth}.xlsx`);
                } else {
                    alert("Excel library not loaded.");
                }
            };

            const canManage = userProfile?.role === 'Admin' || userProfile?.role === 'CEO' || userProfile?.role === 'Shop Manager';
            const isAdmin = userProfile?.role === 'Admin' || userProfile?.role === 'CEO';

            const displayShopsForWallet = useMemo(() => {
                if (selectedShop) return [selectedShop];
                if (isAdmin) return shops.map(s => s.name);
                return availableShops.map(s => s.name);
            }, [selectedShop, isAdmin, shops, availableShops]);

            return (
                <Card>
                    <div className="flex flex-wrap gap-4 justify-between items-center mb-6">
                        <h3 className="text-xl font-semibold text-slate-100">Operational Expenses</h3>
                        <div className="flex flex-wrap gap-4 items-center">
                            {canManage && (
                                <select value={selectedShop} onChange={e => setSelectedShop(e.target.value)} className="select w-full sm:w-auto">
                                    <option value="">{userProfile.role === 'Admin' || userProfile.role === 'CEO' ? 'All Shops' : 'All My Shops'}</option>
                                    {availableShops.map(s => <option key={s.id} value={s.name}>{s.name}</option>)}
                                </select>
                            )}
                            <input type="month" value={selectedMonth} onChange={e => setSelectedMonth(e.target.value)} className="input w-full sm:w-auto" />
                            <select value={selectedCategory} onChange={e => setSelectedCategory(e.target.value)} className="select w-full sm:w-auto">
                                <option value="">All Categories</option>
                                {categoriesList.map(c => <option key={c} value={c}>{c}</option>)}
                            </select>
                            {canManage && <Button variant="primary" icon="fa-plus" onClick={() => handleOpenModal()}>Add Expense</Button>}
                            <Button variant="success" icon="fa-file-excel" onClick={handleExportExcel}>Excel</Button>
                        </div>
                    </div>

                    {/* --- PHASE 1: SHOP FUNDS WIDGET (Compact Design) --- */}
                    <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 xl:grid-cols-5 gap-3 mb-6">
                        {displayShopsForWallet.length > 0 ? (
                            displayShopsForWallet.map(shopName => (
                                <div key={shopName} className="group relative bg-slate-800/50 hover:bg-slate-800 rounded-lg p-3 border border-slate-700/50 hover:border-blue-500/30 transition-all shadow-sm">
                                    <div className="flex items-center justify-between">
                                        <div className="flex items-center gap-3 overflow-hidden">
                                            <div className={`w-8 h-8 rounded-md flex-shrink-0 flex items-center justify-center ${shopFunds[shopName] < 0 ? 'bg-red-500/10 text-red-400' : 'bg-emerald-500/10 text-emerald-400'}`}>
                                                <i className="fas fa-wallet text-xs"></i>
                                            </div>
                                            <div className="min-w-0">
                                                <p className="text-[10px] text-slate-500 uppercase font-bold tracking-wider truncate">{shopName}</p>
                                                <p className={`text-sm font-bold leading-tight truncate ${shopFunds[shopName] < 0 ? 'text-red-400' : 'text-slate-200'}`}>
                                                    {Utils.formatCurrency(shopFunds[shopName] || 0)}
                                                </p>
                                            </div>
                                        </div>
                                        
                                        {/* Admin Deposit Button - Appears on Hover */}
                                        {isAdmin && (
                                            <button 
                                                onClick={() => { setTopUpShop(shopName); setIsTopUpModalOpen(true); }}
                                                className="w-6 h-6 flex items-center justify-center rounded bg-blue-600 hover:bg-blue-500 text-white shadow-lg opacity-0 group-hover:opacity-100 transition-all transform scale-90 group-hover:scale-100"
                                                title="Deposit Funds"
                                            >
                                                <i className="fas fa-plus text-[10px]"></i>
                                            </button>
                                        )}
                                    </div>
                                </div>
                            ))
                        ) : (
                            <div className="col-span-full text-center text-slate-500 italic py-4 text-xs">Select a shop to view wallets.</div>
                        )}
                    </div>

                    {loading ? (
                        <div className="text-center py-10"><i className="fas fa-spinner fa-spin text-3xl text-blue-400"></i></div>
                    ) : (
                        <div className="overflow-x-auto">
                            <table className="min-w-full divide-y divide-slate-700">
                                <thead className="bg-slate-900/50">
                                    <tr>
                                        <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Date</th>
                                        <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Shop</th>
                                        <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Category</th>
                                        <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Description</th>
                                        <th className="px-4 py-3 text-right text-xs font-semibold text-slate-400 uppercase">Amount</th>
                                        <th className="px-4 py-3 text-center text-xs font-semibold text-slate-400 uppercase">Method</th>
                                        {canManage && <th className="px-4 py-3 text-center text-xs font-semibold text-slate-400 uppercase">Actions</th>}
                                    </tr>
                                </thead>
                                <tbody className="divide-y divide-slate-700">
                                    {filteredExpenses.length === 0 ? (
                                        <tr><td colSpan="7" className="px-4 py-8 text-center text-slate-500">No expenses found.</td></tr>
                                    ) : (
                                        filteredExpenses.map(exp => (
                                            <tr key={exp.id} className="hover:bg-slate-700/50">
                                                <td className="px-4 py-4 text-sm text-slate-300 whitespace-nowrap">{exp.date}</td>
                                                <td className="px-4 py-4 text-sm text-slate-300">{exp.shop}</td>
                                                <td className="px-4 py-4 text-sm text-slate-200">
                                                    <span className="px-2 py-1 bg-slate-700 rounded text-xs">{exp.category}</span>
                                                </td>
                                                <td className="px-4 py-4 text-sm text-slate-300">{exp.description}</td>
                                                <td className="px-4 py-4 text-sm text-right font-semibold text-orange-400">{Utils.formatCurrency(exp.amount)}</td>
                                                <td className="px-4 py-4 text-center">
                                                    {exp.paidViaFund ? (
                                                        <span className="text-[10px] bg-green-900/30 text-green-300 border border-green-700 px-2 py-0.5 rounded cursor-help" title="Deducted from Shop Wallet">
                                                            Shop Fund
                                                        </span>
                                                    ) : (
                                                        <span className="text-[10px] text-slate-500">Cash/Other</span>
                                                    )}
                                                </td>
                                                {canManage && (
                                                    <td className="px-4 py-4 text-center">
                                                        <div className="flex items-center justify-center gap-2">
                                                            {/* Phase 3: Disable Edit for Fund Expenses to prevent math issues for now */}
                                                            <Button variant="icon-edit" icon="fa-edit" onClick={() => handleOpenModal(exp)} disabled={exp.paidViaFund} title={exp.paidViaFund ? "Cannot edit Fund payments" : "Edit"} />
                                                            <Button variant="icon-delete" icon="fa-trash" onClick={() => setExpenseToDelete(exp)} />
                                                        </div>
                                                    </td>
                                                )}
                                            </tr>
                                        ))
                                    )}
                                </tbody>
                                <tfoot className="bg-slate-900/50">
                                    <tr>
                                        <td colSpan="4" className="px-4 py-3 text-right font-bold text-slate-300 uppercase">Total Expenses</td>
                                        <td className="px-4 py-3 text-right font-bold text-orange-400">{Utils.formatCurrency(totalAmount)}</td>
                                        <td colSpan={canManage ? 2 : 1}></td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                    )}

                    <ExpenseModal 
                        isOpen={isModalOpen} 
                        onClose={() => setIsModalOpen(false)} 
                        onSave={handleSave} 
                        expense={editingExpense} 
                        categories={categoriesList} 
                        availableShops={availableShops}
                        userProfile={userProfile}
                        shopFunds={shopFunds} 
                    />
                    
                    <TopUpModal 
                        isOpen={isTopUpModalOpen}
                        onClose={() => setIsTopUpModalOpen(false)}
                        onConfirm={handleTopUp}
                        shopName={topUpShop}
                    />

                    <ConfirmationModal 
                        isOpen={!!expenseToDelete} 
                        onClose={() => setExpenseToDelete(null)} 
                        onConfirm={handleDelete} 
                        title="Delete Expense" 
                        message={`Are you sure you want to delete this expense record? ${expenseToDelete?.paidViaFund ? 'The amount will be REFUNDED to the Shop Fund.' : ''}`} 
                    />
                </Card>
            );
        };

        const ExpenseModal = ({ isOpen, onClose, onSave, expense, categories, availableShops, userProfile, shopFunds }) => {
            const [formData, setFormData] = useState({});

            useEffect(() => {
                if (isOpen) {
                    const initialShop = (userProfile.role === 'Shop Manager' && Array.isArray(userProfile.shop) && userProfile.shop.length === 1) 
                        ? userProfile.shop[0] 
                        : '';

                    setFormData(expense || {
                        date: new Date().toISOString().slice(0, 10),
                        shop: initialShop,
                        category: categories[0],
                        amount: '',
                        description: '',
                        recordedBy: userProfile.name,
                        paidViaFund: false // Default
                    });
                }
            }, [isOpen, expense, userProfile, categories]);

            const handleChange = (e) => {
                const value = e.target.type === 'checkbox' ? e.target.checked : e.target.value;
                setFormData(prev => ({ ...prev, [e.target.name]: value }));
            };

            const handleSubmit = (e) => {
                e.preventDefault();
                if (!formData.amount || formData.amount <= 0) {
                    alert("Please enter a valid amount.");
                    return;
                }
                onSave(formData);
            };

            const currentFund = formData.shop && shopFunds ? (shopFunds[formData.shop] || 0) : 0;

            return (
                <Modal isOpen={isOpen} onClose={onClose} maxWidth="max-w-md">
                    <form onSubmit={handleSubmit}>
                        <ModalHeader title={expense ? "Edit Expense" : "Add Shop Expense"} onClose={onClose} />
                        <ModalBody>
                            <div className="space-y-4">
                                <div>
                                    <label className="text-sm font-medium text-slate-400">
                                        <i className="fas fa-calendar-day mr-2 text-blue-400"></i>Date
                                    </label>
                                    <input type="date" name="date" value={formData.date} onChange={handleChange} className="input" required />
                                </div>
                                <div>
                                    <label className="text-sm font-medium text-slate-400">
                                        <i className="fas fa-store mr-2 text-cyan-400"></i>Shop
                                    </label>
                                    <select name="shop" value={formData.shop} onChange={handleChange} className="select" required disabled={!!expense}>
                                        <option value="">Select Shop</option>
                                        {availableShops.map(s => <option key={s.id} value={s.name}>{s.name}</option>)}
                                    </select>
                                    {formData.shop && shopFunds && (
                                        <p className="text-xs text-slate-500 mt-1 text-right">
                                            Fund Balance: <span className={currentFund < 0 ? 'text-red-400' : 'text-green-400'}>{Utils.formatCurrency(currentFund)}</span>
                                        </p>
                                    )}
                                </div>
                                <div>
                                    <label className="text-sm font-medium text-slate-400">
                                        <i className="fas fa-tags mr-2 text-purple-400"></i>Category
                                    </label>
                                    <select name="category" value={formData.category} onChange={handleChange} className="select" required>
                                        {categories.map(c => <option key={c} value={c}>{c}</option>)}
                                    </select>
                                </div>
                                <div>
                                    <label className="text-sm font-medium text-slate-400">
                                        <i className="fas fa-money-bill-wave mr-2 text-green-400"></i>Amount (KHR)
                                    </label>
                                    <input type="number" name="amount" value={formData.amount} onChange={handleChange} className="input font-bold text-orange-400" placeholder="0" required />
                                </div>
                                
                                {formData.shop && !expense && (
                                    <div className="flex items-center p-3 border border-slate-600 rounded-lg bg-slate-700/30">
                                        <input 
                                            id="paidViaFund" 
                                            name="paidViaFund" 
                                            type="checkbox" 
                                            checked={formData.paidViaFund || false} 
                                            onChange={handleChange} 
                                            className="h-5 w-5 rounded border-gray-300 text-green-500 focus:ring-green-500 bg-slate-600"
                                        />
                                        <label htmlFor="paidViaFund" className="ml-3 text-sm text-slate-200">
                                            Pay using Shop Fund?
                                        </label>
                                    </div>
                                )}

                                <div>
                                    <label className="text-sm font-medium text-slate-400">
                                        <i className="fas fa-comment-alt mr-2 text-slate-400"></i>Description / Item Name
                                    </label>
                                    <textarea name="description" value={formData.description} onChange={handleChange} className="input" rows="3" placeholder="e.g., Bought 5 packs of A4 paper"></textarea>
                                </div>
                            </div>
                        </ModalBody>
                        <ModalFooter>
                            <Button variant="secondary" onClick={onClose}>Cancel</Button>
                            <Button type="submit" variant="primary">Save Expense</Button>
                        </ModalFooter>
                    </form>
                </Modal>
            );
        };

        // --- NEW: Summary Expense Tab (Consolidated View) ---
        const SummaryExpenseTab = ({ userProfile }) => {
            const { db } = useFirebase();
            const { shops } = useAppData();
            const { collection, query, where, getDocs } = window.firebaseSDK;

            const [selectedMonth, setSelectedMonth] = useState(new Date().toISOString().slice(0, 7));
            const [loading, setLoading] = useState(false);
            const [summary, setSummary] = useState([]);
            const [totals, setTotals] = useState({ payroll: 0, opsCash: 0, opsFund: 0, total: 0 });

            useEffect(() => {
                if (!db || !userProfile) return;
                
                const fetchData = async () => {
                    setLoading(true);
                    
                    const startStr = `${selectedMonth}-01`;
                    const endStr = `${selectedMonth}-31`;

                    // 1. Fetch Payroll (Stored by 'month' string YYYY-MM)
                    const payrollQ = query(collection(db, 'payrollHistory'), where('month', '==', selectedMonth));
                    
                    // 2. Fetch Expenses (Stored by 'date' string YYYY-MM-DD)
                    const expenseQ = query(collection(db, 'shopExpenses'), where('date', '>=', startStr), where('date', '<=', endStr));

                    try {
                        const [payrollSnap, expenseSnap] = await Promise.all([getDocs(payrollQ), getDocs(expenseQ)]);
                        
                        const payrolls = payrollSnap.docs.map(d => d.data());
                        const expenses = expenseSnap.docs.map(d => d.data());

                        // Aggregation Map by Shop
                        const shopMap = {};

                        // Initialize shops based on permissions
                        const allowedShops = (userProfile.role === 'Admin' || userProfile.role === 'CEO') 
                            ? shops 
                            : (userProfile.role === 'Shop Manager' && Array.isArray(userProfile.shop) 
                                ? shops.filter(s => userProfile.shop.includes(s.name)) 
                                : []);

                        allowedShops.forEach(s => {
                            shopMap[s.name] = { name: s.name, payroll: 0, opsCash: 0, opsFund: 0 };
                        });

                        // Process Payrolls
                        payrolls.forEach(p => {
                            const sName = p.shop;
                            // Only add if shop is allowed/tracked
                            if (shopMap[sName]) {
                                shopMap[sName].payroll += (parseFloat(p.netSalary) || 0);
                            }
                        });

                        // Process Expenses
                        expenses.forEach(e => {
                            const sName = e.shop;
                            if (shopMap[sName]) {
                                const amt = parseFloat(e.amount) || 0;
                                if (e.paidViaFund) {
                                    shopMap[sName].opsFund += amt;
                                } else {
                                    shopMap[sName].opsCash += amt;
                                }
                            }
                        });

                        // Convert to Array & Filter
                        const finalSummary = Object.values(shopMap).sort((a, b) => a.name.localeCompare(b.name));

                        // Calculate Grand Totals
                        const grandTotals = finalSummary.reduce((acc, curr) => ({
                            payroll: acc.payroll + curr.payroll,
                            opsCash: acc.opsCash + curr.opsCash,
                            opsFund: acc.opsFund + curr.opsFund,
                            total: acc.total + curr.payroll + curr.opsCash + curr.opsFund
                        }), { payroll: 0, opsCash: 0, opsFund: 0, total: 0 });

                        setSummary(finalSummary);
                        setTotals(grandTotals);

                    } catch (err) {
                        console.error("Error fetching summary:", err);
                    } finally {
                        setLoading(false);
                    }
                };

                fetchData();
            }, [db, selectedMonth, userProfile, shops]);

            const handleExportExcel = () => {
                const data = summary.map(s => ({
                    'Shop Name': s.name,
                    'Payroll Expense': s.payroll,
                    'Operational (Cash)': s.opsCash,
                    'Petty Cash Spent': s.opsFund,
                    'Total Expense': s.payroll + s.opsCash + s.opsFund
                }));
                
                // Add Totals Row
                data.push({
                    'Shop Name': 'GRAND TOTAL',
                    'Payroll Expense': totals.payroll,
                    'Operational (Cash)': totals.opsCash,
                    'Petty Cash Spent': totals.opsFund,
                    'Total Expense': totals.total
                });

                Utils.exportToExcel(data, "Expense Summary", `Expense_Summary_${selectedMonth}.xlsx`);
            };

            return (
                <Card>
                    <div className="flex flex-wrap gap-4 justify-between items-center mb-6">
                        <h3 className="text-xl font-semibold text-slate-100">Financial Overview</h3>
                        <div className="flex flex-wrap gap-4 items-center">
                            <input type="month" value={selectedMonth} onChange={e => setSelectedMonth(e.target.value)} className="input w-full sm:w-auto" />
                            <Button variant="success" icon="fa-file-excel" onClick={handleExportExcel}>Excel</Button>
                        </div>
                    </div>

                    {/* Summary Cards */}
                    <div className="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
                        <div className="bg-slate-800 p-4 rounded-xl border border-slate-700 shadow-lg">
                            <p className="text-xs text-slate-400 uppercase font-bold tracking-wider">Total Expense</p>
                            <p className="text-2xl font-bold text-white mt-1">{Utils.formatCurrency(totals.total)}</p>
                        </div>
                        <div className="bg-slate-800 p-4 rounded-xl border border-emerald-900/30 shadow-lg">
                            <p className="text-xs text-emerald-400 uppercase font-bold tracking-wider"><i className="fas fa-users mr-1"></i> Payroll</p>
                            <p className="text-xl font-bold text-slate-200 mt-1">{Utils.formatCurrency(totals.payroll)}</p>
                        </div>
                        <div className="bg-slate-800 p-4 rounded-xl border border-orange-900/30 shadow-lg">
                            <p className="text-xs text-orange-400 uppercase font-bold tracking-wider"><i className="fas fa-money-bill mr-1"></i> Ops (Cash)</p>
                            <p className="text-xl font-bold text-slate-200 mt-1">{Utils.formatCurrency(totals.opsCash)}</p>
                        </div>
                        <div className="bg-slate-800 p-4 rounded-xl border border-blue-900/30 shadow-lg">
                            <p className="text-xs text-blue-400 uppercase font-bold tracking-wider"><i className="fas fa-wallet mr-1"></i> Petty Cash</p>
                            <p className="text-xl font-bold text-slate-200 mt-1">{Utils.formatCurrency(totals.opsFund)}</p>
                        </div>
                    </div>

                    {loading ? (
                        <div className="text-center py-10"><i className="fas fa-spinner fa-spin text-3xl text-blue-400"></i></div>
                    ) : (
                        <div className="overflow-x-auto">
                            <table className="min-w-full divide-y divide-slate-700">
                                <thead className="bg-slate-900/50">
                                    <tr>
                                        <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Shop Name</th>
                                        <th className="px-4 py-3 text-right text-xs font-semibold text-slate-400 uppercase">Payroll</th>
                                        <th className="px-4 py-3 text-right text-xs font-semibold text-slate-400 uppercase">Ops (Cash)</th>
                                        <th className="px-4 py-3 text-right text-xs font-semibold text-slate-400 uppercase">Petty Cash</th>
                                        <th className="px-4 py-3 text-right text-xs font-bold text-white uppercase">Total</th>
                                    </tr>
                                </thead>
                                <tbody className="divide-y divide-slate-700">
                                    {summary.length === 0 ? (
                                        <tr><td colSpan="5" className="px-4 py-8 text-center text-slate-500">No data found for this month.</td></tr>
                                    ) : (
                                        summary.map((s, idx) => (
                                            <tr key={idx} className="hover:bg-slate-700/50">
                                                <td className="px-4 py-4 text-sm text-slate-200 font-medium">{s.name}</td>
                                                <td className="px-4 py-4 text-sm text-right text-emerald-300">{Utils.formatCurrency(s.payroll)}</td>
                                                <td className="px-4 py-4 text-sm text-right text-orange-300">{Utils.formatCurrency(s.opsCash)}</td>
                                                <td className="px-4 py-4 text-sm text-right text-blue-300">{Utils.formatCurrency(s.opsFund)}</td>
                                                <td className="px-4 py-4 text-sm text-right font-bold text-white bg-slate-800/30">
                                                    {Utils.formatCurrency(s.payroll + s.opsCash + s.opsFund)}
                                                </td>
                                            </tr>
                                        ))
                                    )}
                                </tbody>
                                <tfoot className="bg-slate-900/80 font-bold border-t border-slate-600">
                                    <tr>
                                        <td className="px-4 py-3 text-slate-300">GRAND TOTAL</td>
                                        <td className="px-4 py-3 text-right text-emerald-400">{Utils.formatCurrency(totals.payroll)}</td>
                                        <td className="px-4 py-3 text-right text-orange-400">{Utils.formatCurrency(totals.opsCash)}</td>
                                        <td className="px-4 py-3 text-right text-blue-400">{Utils.formatCurrency(totals.opsFund)}</td>
                                        <td className="px-4 py-3 text-right text-white text-lg">{Utils.formatCurrency(totals.total)}</td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                    )}
                </Card>
            );
        };

        // --- FIX: ADDED MISSING EXPENSE REPORT PAGE (Placeholder) ---
        const ExpenseReportPage = ({ userProfile }) => {
            // MODIFIED: Set Summary as default active tab
            const [activeTab, setActiveTab] = useState('summary');
            
            const tabs = {
                summary: <span><i className="fas fa-chart-line mr-2 text-yellow-400"></i>Summary</span>,
                payrollExpenses: <span><i className="fas fa-users mr-2 text-emerald-400"></i>Payroll</span>,
                operationalExpenses: <span><i className="fas fa-receipt mr-2 text-blue-400"></i>Operational</span>
            };

            return (
                <TabbedPage tabs={tabs} activeTab={activeTab} setActiveTab={setActiveTab}>
                    {/* MODIFIED: Included new Summary Tab */}
                    <div id="summary"><SummaryExpenseTab userProfile={userProfile} /></div>
                    <div id="payrollExpenses"><PayrollExpensesTab userProfile={userProfile} /></div>
                    <div id="operationalExpenses"><OperationalExpensesTab userProfile={userProfile} /></div>
                </TabbedPage>
            );
        };

        // --- NEW: SYSTEM CONFIGURATION TAB (DATABASE INDEXES) ---
        const SysConfigTab = () => {
            const { db } = useFirebase();
            const { systemSettings } = useAppData(); // Use global settings
            const [indexStatuses, setIndexStatuses] = useState({}); 
            
            // NEW: State for Global Settings
            const [lateFee, setLateFee] = useState(5000);
            const [isSavingSettings, setIsSavingSettings] = useState(false);

            // Initialize local state from context
            useEffect(() => {
                if (systemSettings) {
                    setLateFee(systemSettings.lateDeductionAmount || 5000);
                }
            }, [systemSettings]);

            // NEW: Handler to save global settings
            const handleSaveSettings = async (e) => {
                e.preventDefault();
                setIsSavingSettings(true);
                const { doc, setDoc, serverTimestamp } = window.firebaseSDK;
                try {
                    await setDoc(doc(db, 'systemConfig', 'global'), {
                        lateDeductionAmount: parseFloat(lateFee),
                        updatedAt: serverTimestamp()
                    }, { merge: true });
                    alert("System settings updated successfully.");
                } catch (error) {
                    console.error("Error saving settings:", error);
                    alert("Failed to save settings.");
                } finally {
                    setIsSavingSettings(false);
                }
            };

            /* * -------------------------------------------------------------------------
             * DEVELOPER NOTE: INDEX MANAGEMENT
             * -------------------------------------------------------------------------
             */

            // Define the required indexes based on app logic
            const requiredIndexes = [
                // ... (Keep existing indexes)
                // --- TASK MANAGER & KPI ---
                {
                    title: "Tasks: Staff KPI",
                    description: "For 'My KPI Scorecard' (Filter by Staff + Date Range).",
                    collection: "tasks",
                    scope: "COLLECTION",
                    fields: [
                        { name: "staffId", mode: "ASCENDING" },
                        { name: "completedTimestamp", mode: "ASCENDING" }
                    ]
                },
                {
                    title: "Tasks: Shop KPI",
                    description: "For 'KPI Performance Overview' (Filter by Shop + Date Range).",
                    collection: "tasks",
                    scope: "COLLECTION",
                    fields: [
                        { name: "shopName", mode: "ASCENDING" },
                        { name: "completedTimestamp", mode: "ASCENDING" }
                    ]
                },
                // --- NEW: TOP STATS INDEX ---
                {
                    title: "Employee States: Top Stats",
                    description: "For 'Top 5 Late/Deductions' Dashboard Widget (Filter by Type + Date Range).",
                    collection: "employeeStates",
                    scope: "COLLECTION",
                    fields: [
                        { name: "statusState", mode: "ASCENDING" },
                        { name: "date", mode: "ASCENDING" }
                    ]
                },
                {
                    title: "Task Board: Staff View",
                    description: "For Staff Kanban Board (Filter by Staff + Sort Newest).",
                    collection: "tasks",
                    scope: "COLLECTION",
                    fields: [
                        { name: "staffId", mode: "ASCENDING" },
                        { name: "taskTimestamp", mode: "DESCENDING" }
                    ]
                },
                {
                    title: "Task Board: Manager View",
                    description: "For Manager Kanban Board (Filter by Shop + Sort Newest).",
                    collection: "tasks",
                    scope: "COLLECTION",
                    fields: [
                        { name: "shopName", mode: "ASCENDING" },
                        { name: "taskTimestamp", mode: "DESCENDING" }
                    ]
                },

                // --- SAVINGS PROGRAM ---
                {
                    title: "Savings History: By Shop",
                    description: "For Savings Reports (Filter by Shop + Sort Date).",
                    collection: "transactions",
                    scope: "COLLECTION_GROUP", 
                    fields: [
                        { name: "shop", mode: "ASCENDING" },
                        { name: "date", mode: "DESCENDING" }
                    ]
                },
                {
                    title: "Savings History: By Employee",
                    description: "For Staff Savings View (Filter by Employee + Sort Date).",
                    collection: "transactions",
                    scope: "COLLECTION_GROUP",
                    fields: [
                        { name: "employeeId", mode: "ASCENDING" },
                        { name: "date", mode: "DESCENDING" }
                    ]
                },

                // --- EXPENSES ---
                {
                    title: "Shop Expenses: Manager View",
                    description: "For Expense Report (Filter by Shop + Sort Date).",
                    collection: "shopExpenses",
                    scope: "COLLECTION",
                    fields: [
                        { name: "shop", mode: "ASCENDING" },
                        { name: "date", mode: "DESCENDING" }
                    ]
                },

                // --- MEETINGS ---
                {
                    title: "Meetings: General Schedule",
                    description: "For Meeting Room (Sort by Date + Start Time).",
                    collection: "meetings",
                    scope: "COLLECTION",
                    fields: [
                        { name: "date", mode: "ASCENDING" },
                        { name: "startTime", mode: "ASCENDING" }
                    ]
                },

                // --- ADMIN REPORTS (Optimized Server-Side Filtering) ---
                {
                    title: "Attendance Report: By Shop",
                    description: "Optimizes Daily & Monthly Attendance Reports when a specific Shop is selected.",
                    collection: "attendance",
                    scope: "COLLECTION",
                    fields: [
                        { name: "shop", mode: "ASCENDING" },
                        { name: "timestamp", mode: "ASCENDING" }
                    ]
                },
                // ... (existing indexes) ...
                {
                    title: "Savings: Global Date Range",
                    description: "Required for bulk fetching savings transactions across all users for Payroll processing.",
                    collection: "transactions",
                    scope: "COLLECTION_GROUP",
                    fields: [
                        { name: "date", mode: "ASCENDING" }
                    ]
                },
                // --- NEW INDEX ADDED HERE ---
                {
                    title: "Tasks: Scorecard (Status + Date)",
                    description: "Required for KPI Scorecard to filter 'Done' tasks within a date range.",
                    collection: "tasks",
                    scope: "COLLECTION",
                    fields: [
                        { name: "status", mode: "ASCENDING" },
                        { name: "completedTimestamp", mode: "ASCENDING" }
                    ]
                }
            ];

            // NEW: Function to verify index status by running a dummy query
            const checkIndexStatus = async (idx) => {
                // Set status to checking
                setIndexStatuses(prev => ({ ...prev, [idx.title]: { status: 'checking' } }));

                try {
                    const { collection, collectionGroup, query, orderBy, limit, getDocs } = window.firebaseSDK;
                    
                    // 1. Determine Collection Ref based on scope
                    let ref;
                    if (idx.scope === 'COLLECTION_GROUP') {
                        ref = collectionGroup(db, idx.collection);
                    } else {
                        ref = collection(db, idx.collection);
                    }

                    // 2. Build a test query that forces Firestore to check the index
                    let q = ref;
                    idx.fields.forEach(field => {
                        const direction = field.mode === 'ASCENDING' ? 'asc' : 'desc';
                        q = query(q, orderBy(field.name, direction));
                    });
                    q = query(q, limit(1)); // We only need 1 doc to test

                    // 3. Execute
                    await getDocs(q);
                    
                    // If successful, index exists!
                    setIndexStatuses(prev => ({ ...prev, [idx.title]: { status: 'valid' } }));

                } catch (error) {
                    if (error.code === 'failed-precondition') {
                        // This is the specific error for missing index.
                        // Firebase provides the creation link in the error message.
                        const match = error.message.match(/https:\/\/console\.firebase\.google\.com[^\s]+/);
                        const link = match ? match[0] : null;
                        
                        setIndexStatuses(prev => ({ 
                            ...prev, 
                            [idx.title]: { status: 'missing', link: link } 
                        }));
                    } else {
                        console.error("Index check error:", error);
                        setIndexStatuses(prev => ({ 
                            ...prev, 
                            [idx.title]: { status: 'error', message: error.message } 
                        }));
                    }
                }
            };

            return (
                <Card>
                    <PageHeader title="System Configuration">
                        <div className="bg-blue-900/30 text-blue-200 px-3 py-1 rounded text-xs border border-blue-800">
                            Project ID: <span className="font-mono font-bold text-white">{activeFirebaseConfig.projectId}</span>
                        </div>
                    </PageHeader>

                    {/* MODIFIED: Removed Global Settings Section (Moved to Shop Tab) */}

                    <div className="bg-slate-900/50 p-6 rounded-lg border border-slate-700 mb-6">
                        <h4 className="text-lg font-bold text-slate-200 mb-2"><i className="fas fa-database text-yellow-500 mr-2"></i>Database Optimization</h4>
                        <p className="text-sm text-slate-400 mb-4">
                            The following Composite Indexes are required for advanced filtering and reporting features. 
                            Click <strong>"Check Status"</strong> to verify each index. If missing, a direct creation link will be provided.
                        </p>
                        
                        <div className="grid grid-cols-1 gap-4">
                            {requiredIndexes.map((idx, index) => {
                                const statusObj = indexStatuses[idx.title] || { status: 'unknown' };
                                
                                return (
                                    <div key={index} className="flex flex-col sm:flex-row items-start sm:items-center justify-between p-4 bg-slate-800 rounded-lg border border-slate-600 hover:border-slate-500 transition-colors">
                                        <div className="mb-3 sm:mb-0 flex-1">
                                            <div className="flex items-center gap-2">
                                                <h5 className="font-bold text-slate-200 text-sm">{idx.title}</h5>
                                                {statusObj.status === 'valid' && <span className="text-green-400 text-xs font-bold"><i className="fas fa-check-circle"></i> Active</span>}
                                                {statusObj.status === 'missing' && <span className="text-red-400 text-xs font-bold"><i className="fas fa-exclamation-circle"></i> Missing</span>}
                                            </div>
                                            <p className="text-xs text-slate-500 mt-1">{idx.description}</p>
                                            <div className="flex gap-2 mt-2">
                                                <span className="text-[10px] bg-slate-700 text-slate-300 px-2 py-0.5 rounded font-mono">
                                                    {idx.scope === 'COLLECTION_GROUP' ? 'Collection Group' : 'Collection'}: {idx.collection}
                                                </span>
                                                {idx.fields.map(f => (
                                                    <span key={f.name} className="text-[10px] bg-slate-700 text-slate-300 px-2 py-0.5 rounded font-mono">
                                                        {f.name} ({f.mode === 'ASCENDING' ? 'Asc' : 'Desc'})
                                                    </span>
                                                ))}
                                            </div>
                                        </div>
                                        
                                        <div className="flex items-center gap-3">
                                            {statusObj.status === 'missing' && statusObj.link ? (
                                                <a 
                                                    href={statusObj.link} 
                                                    target="_blank" 
                                                    rel="noopener noreferrer"
                                                    className="flex items-center gap-2 bg-yellow-600 hover:bg-yellow-500 text-white text-xs font-bold py-2 px-4 rounded shadow-lg transition-transform active:scale-95 whitespace-nowrap animate-pulse"
                                                >
                                                    <i className="fas fa-hammer"></i> Create Index
                                                </a>
                                            ) : (
                                                <Button 
                                                    onClick={() => checkIndexStatus(idx)} 
                                                    variant="secondary" 
                                                    className="text-xs whitespace-nowrap"
                                                    disabled={statusObj.status === 'checking'}
                                                >
                                                    {statusObj.status === 'checking' ? <i className="fas fa-spinner fa-spin"></i> : (statusObj.status === 'valid' ? 'Re-Check' : 'Check Status')}
                                                </Button>
                                            )}
                                        </div>
                                    </div>
                                );
                            })}
                        </div>
                    </div>
                    
                    <div className="p-4 rounded-lg bg-yellow-900/10 border border-yellow-700/30 text-yellow-200/80 text-xs">
                        <i className="fas fa-info-circle mr-2"></i>
                        <strong>Note:</strong> After clicking "Create Index", it may take several minutes for Firebase to build the index. During this time, the "Check Status" button may still show "Missing".
                    </div>
                </Card>
            );
        };

        // --- START SETTINGS PAGE ---

        // NEW: Extracted Global Settings Widget
        const GlobalSettingsWidget = ({ userProfile }) => {
            const { db } = useFirebase();
            const { systemSettings } = useAppData();
            const [lateFee, setLateFee] = useState(5000);
            const [isSavingSettings, setIsSavingSettings] = useState(false);

            useEffect(() => {
                if (systemSettings) {
                    setLateFee(systemSettings.lateDeductionAmount || 5000);
                }
            }, [systemSettings]);

            const handleSaveSettings = async (e) => {
                e.preventDefault();
                setIsSavingSettings(true);
                const { doc, setDoc, serverTimestamp } = window.firebaseSDK;
                try {
                    await setDoc(doc(db, 'systemConfig', 'global'), {
                        lateDeductionAmount: parseFloat(lateFee),
                        updatedAt: serverTimestamp()
                    }, { merge: true });
                    alert("System settings updated successfully.");
                } catch (error) {
                    console.error("Error saving settings:", error);
                    alert("Failed to save settings.");
                } finally {
                    setIsSavingSettings(false);
                }
            };
            
            // Security check: Only Admin/CEO
            if (userProfile.role !== 'Admin' && userProfile.role !== 'CEO') return null;

            return (
                <div className="bg-slate-800/50 p-6 rounded-lg border border-slate-700 mb-8">
                    <h4 className="text-lg font-bold text-slate-200 mb-4"><i className="fas fa-sliders mr-2 text-blue-400"></i>Global Settings</h4>
                    <form onSubmit={handleSaveSettings} className="grid grid-cols-1 md:grid-cols-2 gap-4 items-end">
                        <div>
                            <label className="text-sm font-medium text-slate-400">
                                <i className="fas fa-user-clock mr-2 text-red-400"></i>Late Check-In Penalty (KHR)
                            </label>
                            <input 
                                type="number" 
                                value={lateFee} 
                                onChange={(e) => setLateFee(e.target.value)} 
                                className="input font-bold text-slate-200 mt-1" 
                                placeholder="5000"
                            />
                            <p className="text-xs text-slate-500 mt-1">Amount deducted automatically when staff check in late.</p>
                        </div>
                        <div className="md:col-span-1">
                            <Button type="submit" variant="primary" disabled={isSavingSettings} className="w-full md:w-auto">
                                {isSavingSettings ? 'Saving...' : 'Update Settings'}
                            </Button>
                        </div>
                    </form>
                </div>
            );
        };

        // NEW: QR Code Generator Modal for Shop Settings (Phase 1)
        const ShopQRModal = ({ isOpen, onClose, shop }) => {
            const canvasRef = useRef(null);

            useEffect(() => {
                if (isOpen && shop && canvasRef.current) {
                    // Generate QR Code using QRious (Standard resolution for preview)
                    new QRious({
                        element: canvasRef.current,
                        value: shop.name, 
                        size: 250,
                        level: 'H' // High error correction
                    });
                }
            }, [isOpen, shop]);

            // MODIFIED: Updated to generate a High-Resolution composite poster image
            const handleDownload = () => {
                if (!canvasRef.current || !shop) return;

                // Create a temporary canvas to combine text and QR code
                const tempCanvas = document.createElement('canvas');
                const ctx = tempCanvas.getContext('2d');
                
                // Set dimensions (High Res Scale Factor = 4x)
                const scale = 4;
                const width = 400 * scale;  // 1600px
                const height = 520 * scale; // 2080px
                
                tempCanvas.width = width;
                tempCanvas.height = height;

                // 1. White Background
                ctx.fillStyle = '#ffffff';
                ctx.fillRect(0, 0, width, height);

                // 2. Shop Name (Header)
                ctx.fillStyle = '#1e293b'; // slate-800
                ctx.font = `bold ${28 * scale}px sans-serif`; // Scaled Font
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText(shop.name, width / 2, 60 * scale);

                // 3. Draw QR Code with Border
                const qrSize = 250 * scale; // 1000px
                const qrX = (width - qrSize) / 2;
                const qrY = 110 * scale;
                
                // Draw border rect
                ctx.fillStyle = '#1e293b'; 
                const borderSize = 4 * scale;
                ctx.fillRect(qrX - borderSize, qrY - borderSize, qrSize + (borderSize*2), qrSize + (borderSize*2));
                
                // Generate a separate High-Res QR code for the download image
                const highResQrCanvas = document.createElement('canvas');
                new QRious({
                    element: highResQrCanvas,
                    value: shop.name, 
                    size: qrSize, // Generate at full high-res size
                    level: 'H'
                });

                // Draw the high-res QR onto the poster
                ctx.drawImage(highResQrCanvas, qrX, qrY, qrSize, qrSize);

                // 4. Instructions (Footer)
                ctx.fillStyle = '#475569'; // slate-600
                ctx.font = `bold ${18 * scale}px sans-serif`;
                ctx.fillText("Scan to Check In", width / 2, qrY + qrSize + (50 * scale));
                
                ctx.fillStyle = '#94a3b8'; // slate-400
                ctx.font = `${14 * scale}px sans-serif`;
                ctx.fillText("HR System Attendance", width / 2, qrY + qrSize + (80 * scale));

                // 5. Trigger Download
                const link = document.createElement('a');
                link.download = `QR_Poster_${shop.name.replace(/\s+/g, '_')}_HighRes.png`;
                link.href = tempCanvas.toDataURL('image/png');
                link.click();
            };

            if (!shop) return null;

            return (
                <Modal isOpen={isOpen} onClose={onClose} maxWidth="max-w-sm">
                    <ModalHeader title="Shop QR Code" onClose={onClose} />
                    <ModalBody>
                        <div className="flex flex-col items-center justify-center p-6 space-y-6 bg-white rounded-lg border border-slate-200">
                            <h3 className="text-xl font-bold text-slate-800">{shop.name}</h3>
                            <canvas ref={canvasRef} className="border-4 border-slate-800 rounded-lg shadow-xl"></canvas>
                            <div className="text-center space-y-1">
                                <p className="text-sm font-semibold text-slate-600">Scan to Check In</p>
                                <p className="text-xs text-slate-400">Print this and place it at the shop entrance.</p>
                            </div>
                        </div>
                    </ModalBody>
                    <ModalFooter>
                        <Button variant="secondary" onClick={onClose}>Close</Button>
                        <Button variant="primary" onClick={handleDownload} icon="fa-download">Download Poster</Button>
                    </ModalFooter>
                </Modal>
            );
        };

        // NEW: Memo Alert Modal
        const MemoAlertModal = ({ isOpen, onClose, onSave, memo }) => {
            const { shops } = useAppData();
            const [formData, setFormData] = useState({});

            useEffect(() => {
                if (isOpen) {
                    setFormData(memo ? { ...memo } : { 
                        title: '', 
                        content: '', 
                        startTime: '', 
                        endTime: '', 
                        targetShops: [], 
                        status: 'Active',
                        readBy: [] // Initialized Data: Prevent errors with read tracking
                    });
                }
            }, [isOpen, memo]);

            const handleChange = (e) => {
                const { name, value } = e.target;
                setFormData(prev => ({ ...prev, [name]: value }));
            };

            const handleShopToggle = (shopName) => {
                setFormData(prev => {
                    const current = prev.targetShops || [];
                    const updated = current.includes(shopName)
                        ? current.filter(s => s !== shopName)
                        : [...current, shopName];
                    return { ...prev, targetShops: updated };
                });
            };

            const handleSubmit = (e) => {
                e.preventDefault();
                onSave(formData);
            };

            return (
                <Modal isOpen={isOpen} onClose={onClose} maxWidth="max-w-lg">
                    {/* Fixed Layout: Added flex flex-col h-full overflow-hidden */}
                    <form onSubmit={handleSubmit} className="flex flex-col h-full overflow-hidden">
                        <ModalHeader title={memo ? "Edit Memo" : "Add New Memo"} onClose={onClose} />
                        <ModalBody>
                            <div className="space-y-4">
                                <div>
                                    <label className="text-sm font-medium text-slate-400">Title</label>
                                    <input name="title" value={formData.title || ''} onChange={handleChange} className="input" required />
                                </div>
                                <div className="grid grid-cols-2 gap-4">
                                    <div>
                                        <label className="text-sm font-medium text-slate-400">Start Time</label>
                                        <input type="time" name="startTime" value={formData.startTime || ''} onChange={handleChange} className="input" required />
                                    </div>
                                    <div>
                                        <label className="text-sm font-medium text-slate-400">End Time</label>
                                        <input type="time" name="endTime" value={formData.endTime || ''} onChange={handleChange} className="input" required />
                                    </div>
                                </div>
                                <div>
                                    <label className="text-sm font-medium text-slate-400">Content</label>
                                    <textarea name="content" value={formData.content || ''} onChange={handleChange} className="input" rows="3" required></textarea>
                                </div>
                                <div>
                                    <label className="text-sm font-medium text-slate-400 mb-2 block">Target Shops</label>
                                    <div className="grid grid-cols-2 gap-2 p-2 border border-slate-600 rounded bg-slate-700/50 max-h-40 overflow-y-auto">
                                        {shops.map(shop => (
                                            <div key={shop.id} className="flex items-center">
                                                <input 
                                                    type="checkbox" 
                                                    checked={(formData.targetShops || []).includes(shop.name)} 
                                                    onChange={() => handleShopToggle(shop.name)}
                                                    className="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500 bg-slate-600"
                                                />
                                                <label className="ml-2 text-sm text-slate-300">{shop.name}</label>
                                            </div>
                                        ))}
                                    </div>
                                    <p className="text-xs text-slate-500 mt-1">Leave empty to target ALL shops.</p>
                                </div>
                                <div>
                                    <label className="text-sm font-medium text-slate-400">Status</label>
                                    <select name="status" value={formData.status || 'Active'} onChange={handleChange} className="select">
                                        <option value="Active">Active</option>
                                        <option value="Inactive">Inactive</option>
                                    </select>
                                </div>
                            </div>
                        </ModalBody>
                        <ModalFooter>
                            <Button variant="secondary" onClick={onClose}>Cancel</Button>
                            {/* Corrected Button Label */}
                            <Button type="submit" variant="primary">{memo ? "Update Memo" : "Add Memo"}</Button>
                        </ModalFooter>
                    </form>
                </Modal>
            );
        };

        // NEW: Memo Alert Tab
        const MemoAlertTab = () => {
            const { db } = useFirebase();
            const { data: memos, loading } = useCollection('memoAlerts');
            const [isModalOpen, setIsModalOpen] = useState(false);
            const [editingMemo, setEditingMemo] = useState(null);
            const [memoToDelete, setMemoToDelete] = useState(null);

            const handleOpenModal = (memo = null) => {
                setEditingMemo(memo);
                setIsModalOpen(true);
            };
            const handleCloseModal = () => {
                setEditingMemo(null);
                setIsModalOpen(false);
            };

            const handleSave = async (formData) => {
                const { addDoc, updateDoc, doc, collection, serverTimestamp } = window.firebaseSDK;
                const { id, ...dataToSave } = formData;
                
                try {
                    if (id) {
                        await updateDoc(doc(db, 'memoAlerts', id), { ...dataToSave, updatedAt: serverTimestamp() });
                    } else {
                        await addDoc(collection(db, 'memoAlerts'), { ...dataToSave, createdAt: serverTimestamp() });
                    }
                    handleCloseModal();
                } catch (error) {
                    console.error("Error saving memo:", error);
                }
            };

            const handleDeleteConfirm = async () => {
                if (!memoToDelete) return;
                try {
                    await window.firebaseSDK.deleteDoc(window.firebaseSDK.doc(db, 'memoAlerts', memoToDelete.id));
                } catch (error) {
                    console.error("Error deleting memo:", error);
                } finally {
                    setMemoToDelete(null);
                }
            };

            const sortedMemos = useMemo(() => {
                if (!memos) return [];
                return [...memos].sort((a, b) => (a.startTime || '00:00').localeCompare(b.startTime || '00:00'));
            }, [memos]);

            return (
                <Card>
                    <PageHeader title="Memo Alert Management">
                        <Button variant="primary" icon="fa-plus" onClick={() => handleOpenModal()}>Add New Memo</Button>
                    </PageHeader>

                    {loading ? (
                        <div className="text-center py-10"><i className="fas fa-spinner fa-spin text-3xl"></i></div>
                    ) : (
                        <div className="overflow-x-auto">
                            <table className="min-w-full divide-y divide-slate-700">
                                <thead className="bg-slate-900/50">
                                    <tr>
                                        <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Title</th>
                                        <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Time Window</th>
                                        <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Target Shops</th>
                                        <th className="px-4 py-3 text-center text-xs font-semibold text-slate-400 uppercase">Status</th>
                                        <th className="px-4 py-3 text-right text-xs font-semibold text-slate-400 uppercase">Actions</th>
                                    </tr>
                                </thead>
                                <tbody className="divide-y divide-slate-700">
                                    {sortedMemos.map(memo => (
                                        <tr key={memo.id} className="hover:bg-slate-700/50">
                                            <td className="px-4 py-4 text-sm text-slate-200">{memo.title}</td>
                                            <td className="px-4 py-4 text-sm text-slate-300">{memo.startTime} to {memo.endTime}</td>
                                            <td className="px-4 py-4 text-sm text-slate-300">
                                                {(Array.isArray(memo.targetShops) && memo.targetShops.length > 0)
                                                    ? memo.targetShops.join(', ')
                                                    : 'All Shops'
                                                }
                                            </td>
                                            <td className="px-4 py-4 text-center text-sm">
                                                <span className={`px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${memo.status === 'Active' ? 'bg-green-100 text-green-800' : 'bg-slate-100 text-slate-800'}`}>
                                                    {memo.status}
                                                </span>
                                            </td>
                                            <td className="px-4 py-4 text-right">
                                                <div className="flex items-center justify-end gap-4">
                                                    <Button variant="icon-edit" icon="fa-edit" onClick={() => handleOpenModal(memo)} />
                                                    <Button variant="icon-delete" icon="fa-trash" onClick={() => setMemoToDelete(memo)} />
                                                </div>
                                            </td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                    )}
                    <MemoAlertModal isOpen={isModalOpen} onClose={handleCloseModal} onSave={handleSave} memo={editingMemo} />
                    <ConfirmationModal isOpen={!!memoToDelete} onClose={() => setMemoToDelete(null)} onConfirm={handleDeleteConfirm} title="Delete Memo" message={`Are you sure you want to delete the memo "${memoToDelete?.title}"?`} />
                </Card>
            );
        };

        // --- NEW: KPI COMPONENTS (Missing in previous version) ---

        // KPI Modal
        const KPIModal = ({ isOpen, onClose, onSave, kpi }) => {
            const { positions } = useAppData();
            const [formData, setFormData] = useState({});

            useEffect(() => {
                if (isOpen) {
                    setFormData(kpi ? { ...kpi, assignedPositions: kpi.assignedPositions || [] } : { 
                        name: '', 
                        assignedPositions: [] 
                    });
                }
            }, [isOpen, kpi]);

            const handleChange = (e) => {
                const { name, value } = e.target;
                setFormData(prev => ({ ...prev, [name]: value }));
            };

            const handlePositionToggle = (positionName) => {
                setFormData(prev => {
                    const current = prev.assignedPositions || [];
                    const updated = current.includes(positionName)
                        ? current.filter(p => p !== positionName)
                        : [...current, positionName];
                    return { ...prev, assignedPositions: updated };
                });
            };

            const handleSubmit = (e) => {
                e.preventDefault();
                if (!formData.name) {
                    alert("KPI Name is required.");
                    return;
                }
                onSave(formData);
            };

            return (
                <Modal isOpen={isOpen} onClose={onClose} maxWidth="max-w-lg">
                    <form onSubmit={handleSubmit}>
                        <ModalHeader title={kpi ? "Edit KPI" : "Add New KPI"} onClose={onClose} />
                        <ModalBody>
                            <div className="space-y-4">
                                <div>
                                    <label className="text-sm font-medium text-slate-400">
                                        <i className="fas fa-chart-line mr-2 text-blue-400"></i>KPI Name
                                    </label>
                                    <input 
                                        name="name" 
                                        value={formData.name || ''} 
                                        onChange={handleChange} 
                                        className="input" 
                                        placeholder="e.g., Monthly Sales Target" 
                                        required 
                                    />
                                </div>
                                
                                <div>
                                    <label className="text-sm font-medium text-slate-400 mb-2 block">
                                        <i className="fas fa-briefcase mr-2 text-purple-400"></i>Assigned To (Positions)
                                    </label>
                                    <div className="p-3 border border-slate-600 rounded-lg bg-slate-700/50 max-h-60 overflow-y-auto custom-scrollbar">
                                        {positions && positions.length > 0 ? (
                                            <div className="grid grid-cols-1 gap-2">
                                                {positions.map(pos => (
                                                    <div key={pos.id} className="flex items-center hover:bg-slate-700 p-1.5 rounded transition-colors cursor-pointer" onClick={() => handlePositionToggle(pos.position)}>
                                                        <div className={`w-5 h-5 rounded border flex items-center justify-center mr-3 transition-colors ${
                                                            (formData.assignedPositions || []).includes(pos.position) 
                                                                ? 'bg-blue-600 border-blue-600' 
                                                                : 'border-slate-500 bg-slate-800'
                                                        }`}>
                                                            {(formData.assignedPositions || []).includes(pos.position) && <i className="fas fa-check text-white text-xs"></i>}
                                                        </div>
                                                        <span className="text-sm text-slate-200 select-none">{pos.position}</span>
                                                    </div>
                                                ))}
                                            </div>
                                        ) : (
                                            <p className="text-sm text-slate-500 italic text-center py-4">No positions found. Please add positions first.</p>
                                        )}
                                    </div>
                                    <p className="text-xs text-slate-500 mt-2">Select the positions responsible for this KPI.</p>
                                </div>
                            </div>
                        </ModalBody>
                        <ModalFooter>
                            <Button variant="secondary" onClick={onClose}>Cancel</Button>
                            <Button type="submit" variant="primary">Save KPI</Button>
                        </ModalFooter>
                    </form>
                </Modal>
            );
        };

        // KPI Manager Tab Component
        const KPIManagerTab = () => {
            const { db } = useFirebase();
            const { data: kpis, loading } = useCollection('kpis');
            const [isModalOpen, setIsModalOpen] = useState(false);
            const [editingKPI, setEditingKPI] = useState(null);
            const [kpiToDelete, setKPIToDelete] = useState(null);

            const handleOpenModal = (kpi = null) => {
                setEditingKPI(kpi);
                setIsModalOpen(true);
            };

            const handleCloseModal = () => {
                setEditingKPI(null);
                setIsModalOpen(false);
            };

            const handleSave = async (formData) => {
                const { addDoc, updateDoc, doc, collection, serverTimestamp } = window.firebaseSDK;
                const { id, ...dataToSave } = formData;
                
                try {
                    if (id) {
                        await updateDoc(doc(db, 'kpis', id), { ...dataToSave, updatedAt: serverTimestamp() });
                    } else {
                        await addDoc(collection(db, 'kpis'), { ...dataToSave, createdAt: serverTimestamp() });
                    }
                    handleCloseModal();
                } catch (error) {
                    console.error("Error saving KPI:", error);
                    alert("Failed to save KPI.");
                }
            };

            const handleDeleteConfirm = async () => {
                if (!kpiToDelete) return;
                try {
                    await window.firebaseSDK.deleteDoc(window.firebaseSDK.doc(db, 'kpis', kpiToDelete.id));
                } catch (error) {
                    console.error("Error deleting KPI:", error);
                } finally {
                    setKPIToDelete(null);
                }
            };

            return (
                <Card>
                    <PageHeader title="KPI Management">
                        <Button variant="primary" icon="fa-plus" onClick={() => handleOpenModal()}>Add New KPI</Button>
                    </PageHeader>

                    {loading ? (
                        <div className="text-center py-10"><i className="fas fa-spinner fa-spin text-3xl"></i></div>
                    ) : (
                        <div className="overflow-x-auto">
                            <table className="min-w-full divide-y divide-slate-700">
                                <thead className="bg-slate-900/50">
                                    <tr>
                                        <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">KPI Name</th>
                                        <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Assigned To (Positions)</th>
                                        <th className="px-4 py-3 text-right text-xs font-semibold text-slate-400 uppercase">Actions</th>
                                    </tr>
                                </thead>
                                <tbody className="divide-y divide-slate-700">
                                    {kpis.map(kpi => (
                                        <tr key={kpi.id} className="hover:bg-slate-700/50">
                                            <td className="px-4 py-4 text-sm text-slate-200 font-medium">{kpi.name}</td>
                                            <td className="px-4 py-4 text-sm text-slate-300">
                                                {Array.isArray(kpi.assignedPositions) && kpi.assignedPositions.length > 0 
                                                    ? <div className="flex flex-wrap gap-1">
                                                        {kpi.assignedPositions.map((pos, idx) => (
                                                            <span key={idx} className="px-2 py-0.5 rounded-full bg-blue-900/40 text-blue-300 border border-blue-800/50 text-xs">
                                                                {pos}
                                                            </span>
                                                        ))}
                                                      </div>
                                                    : <span className="text-slate-500 italic">None assigned</span>
                                                }
                                            </td>
                                            <td className="px-4 py-4 text-right">
                                                <div className="flex items-center justify-end gap-4">
                                                    <Button variant="icon-edit" icon="fa-edit" onClick={() => handleOpenModal(kpi)} />
                                                    <Button variant="icon-delete" icon="fa-trash" onClick={() => setKPIToDelete(kpi)} />
                                                </div>
                                            </td>
                                        </tr>
                                    ))}
                                    {kpis.length === 0 && (
                                        <tr><td colSpan="3" className="px-4 py-8 text-center text-slate-500">No KPIs found.</td></tr>
                                    )}
                                </tbody>
                            </table>
                        </div>
                    )}
                    
                    <KPIModal isOpen={isModalOpen} onClose={handleCloseModal} onSave={handleSave} kpi={editingKPI} />
                    <ConfirmationModal isOpen={!!kpiToDelete} onClose={() => setKPIToDelete(null)} onConfirm={handleDeleteConfirm} title="Delete KPI" message={`Are you sure you want to delete the KPI "${kpiToDelete?.name}"?`} />
                </Card>
            );
        };

        // --- NEW: SYSTEM FEATURE TAB (PHASE 2 - GRANULAR LOGIC INTEGRATION) ---
        const SysFeatureTab = () => {
            const { db } = useFirebase();
            const { moduleConfig = {} } = useAppData(); // Ensure fallback
            const { doc, setDoc, serverTimestamp } = window.firebaseSDK;
            const [toggling, setToggling] = useState(null); // Track which specific key is toggling

            // Generic toggle handler for both Modules and Sub-features
            // key: 'moduleName' OR 'moduleName:subFeature'
            const handleToggle = async (key, currentState) => {
                if (key === 'settings') {
                    alert("The Settings module cannot be disabled as it is required to manage these toggles.");
                    return;
                }
                if (key === 'settings:sysFeatures') {
                    alert("You cannot disable the System Features control panel.");
                    return;
                }

                setToggling(key);
                try {
                    // FIX: Changed collection from 'settings' to 'systemConfig' to match AppDataProvider
                    const ref = doc(db, 'systemConfig', 'modules');
                    
                    // Logic: If currently enabled (or undefined), set to false. If false, set to true.
                    const nextValue = !(currentState !== false);
                    
                    await setDoc(ref, {
                        [key]: nextValue,
                        updatedAt: serverTimestamp()
                    }, { merge: true });
                    
                } catch (error) {
                    console.error("Error toggling feature:", error);
                    alert("Failed to update feature status. Please check your permissions.");
                } finally {
                    setToggling(null);
                }
            };

            return (
                <Card>
                    <PageHeader title="System Features Control">
                        <div className="text-xs text-green-400 bg-green-900/30 px-3 py-1 rounded-full border border-green-500/30 font-bold flex items-center gap-2">
                            <span className="relative flex h-2 w-2">
                              <span className="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75"></span>
                              <span className="relative inline-flex rounded-full h-2 w-2 bg-green-500"></span>
                            </span>
                            Phase 2: Granular Logic Integration
                        </div>
                    </PageHeader>

                    <div className="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-4">
                        {APP_MODULES.map(module => {
                            // 1. Check Main Module Status
                            const isModuleEnabled = moduleConfig[module.key] !== false; 
                            const isModuleProcessing = toggling === module.key;
                            const isSettings = module.key === 'settings';

                            return (
                                <div key={module.key} className={`flex flex-col rounded-xl border transition-all duration-300 ${isModuleEnabled ? 'bg-slate-800 border-slate-700' : 'bg-slate-900/80 border-slate-800 opacity-75 grayscale-[0.3]'}`}>
                                    
                                    {/* Module Header Area */}
                                    <div className="p-4 flex items-center justify-between border-b border-slate-700/50">
                                        <div className="flex items-center gap-3">
                                            <div className={`w-10 h-10 rounded-lg flex items-center justify-center shadow-lg transition-transform ${isModuleEnabled ? (module.bg || 'bg-slate-700') : 'bg-slate-800'}`}>
                                                <i className={`fas ${module.icon} ${isModuleEnabled ? module.color : 'text-slate-500'} text-lg`}></i>
                                            </div>
                                            <div>
                                                <h4 className={`font-bold text-sm ${isModuleEnabled ? 'text-slate-200' : 'text-slate-500'}`}>{module.label}</h4>
                                                <p className="text-[9px] text-slate-500 font-mono uppercase tracking-wide">ID: {module.key}</p>
                                            </div>
                                        </div>
                                        
                                        {/* Main Toggle Switch */}
                                        <div className="flex flex-col items-end">
                                            {isSettings ? (
                                                <span className="text-[10px] font-bold text-slate-500 bg-slate-700/50 px-2 py-1 rounded"><i className="fas fa-lock mr-1"></i> Core</span>
                                            ) : (
                                                <label className="relative inline-flex items-center cursor-pointer">
                                                    <input 
                                                        type="checkbox" 
                                                        className="sr-only peer"
                                                        checked={isModuleEnabled}
                                                        onChange={() => handleToggle(module.key, moduleConfig[module.key])}
                                                        disabled={isModuleProcessing}
                                                    />
                                                    <div className="w-9 h-5 bg-slate-700 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-green-600"></div>
                                                </label>
                                            )}
                                        </div>
                                    </div>

                                    {/* Internal Features (Sub-Toggles) */}
                                    {module.tabs && module.tabs.length > 0 && (
                                        <div className={`p-3 bg-slate-900/30 rounded-b-xl space-y-2 ${!isModuleEnabled ? 'opacity-50 pointer-events-none' : ''}`}>
                                            {module.tabs.map((tab) => {
                                                const subKey = `${module.key}:${tab.key}`;
                                                // Check specifically for the sub-feature key
                                                const isTabEnabled = moduleConfig[subKey] !== false;
                                                const isTabProcessing = toggling === subKey;
                                                const isLocked = subKey === 'settings:sysFeatures'; // Lock this panel

                                                return (
                                                    <div key={subKey} className="flex items-center justify-between group">
                                                        <div className="flex items-center gap-2 overflow-hidden">
                                                            <div className={`w-1.5 h-1.5 rounded-full ${isTabEnabled ? 'bg-slate-500 group-hover:bg-blue-400' : 'bg-slate-700'}`}></div>
                                                            <span className={`text-xs truncate ${isTabEnabled ? 'text-slate-400 group-hover:text-slate-200' : 'text-slate-600'}`}>
                                                                {tab.label}
                                                            </span>
                                                        </div>

                                                        {isLocked ? (
                                                            <i className="fas fa-lock text-[10px] text-slate-600"></i>
                                                        ) : (
                                                            <div 
                                                                onClick={() => handleToggle(subKey, moduleConfig[subKey])}
                                                                className={`
                                                                    cursor-pointer w-8 h-4 rounded-full flex items-center p-0.5 transition-colors duration-300
                                                                    ${isTabEnabled ? 'bg-blue-600/30' : 'bg-slate-700'}
                                                                    ${isTabProcessing ? 'animate-pulse' : ''}
                                                                `}
                                                            >
                                                                <div className={`
                                                                    w-3 h-3 bg-white rounded-full shadow-sm transform transition-transform duration-300
                                                                    ${isTabEnabled ? 'translate-x-4 bg-blue-400' : 'translate-x-0 bg-slate-400'}
                                                                `}></div>
                                                            </div>
                                                        )}
                                                    </div>
                                                );
                                            })}
                                        </div>
                                    )}
                                </div>
                            );
                        })}
                    </div>
                    
                    <div className="mt-6 p-4 bg-blue-900/20 border border-blue-800/50 rounded-lg text-sm text-blue-200 flex items-start gap-3">
                        <i className="fas fa-info-circle text-lg mt-0.5"></i>
                        <div>
                            <p className="font-bold mb-1">System-Wide Impact</p>
                            <p className="opacity-90 leading-relaxed text-xs">
                                <strong>Main Module:</strong> Disabling the main switch hides the entire page from the sidebar.<br/>
                                <strong>Sub-Features:</strong> Disabling a sub-feature removes that specific tab from within the page.
                            </p>
                        </div>
                    </div>
                </Card>
            );
        };

        const SettingsPage = ({ initialTab = 'shop' }) => {
            // REDUNDANCY FIX: Use global context data instead of fetching collections again
            const { shops, positions, shifts, expenseCategories } = useAppData();
            
            const [activeTab, setActiveTab] = useState(initialTab);
            const { userProfile } = useFirebase(); 

            useEffect(() => {
                setActiveTab(initialTab);
            }, [initialTab]);
            
            // MODIFIED: Added Sys Features Tab
            const tabs = useMemo(() => {
                const baseTabs = { 
                    shop: <span><i className="fas fa-building mr-2 text-blue-400"></i>Shop & Shift Management</span>, 
                    position: <span><i className="fas fa-id-badge mr-2 text-purple-400"></i>Position & KPI</span>,
                    expenses: <span><i className="fas fa-tags mr-2 text-green-400"></i>Expense Categories</span>, 
                    memo: <span><i className="fas fa-bell mr-2 text-yellow-400"></i>Memo Alert</span> 
                };

                // NEW: Add Sys Feature & Sys Config tabs for Admin/CEO
                if (userProfile?.role === 'Admin' || userProfile?.role === 'CEO') {
                    // NEW: Phase 1 Feature List Tab
                    baseTabs.sysFeatures = <span><i className="fas fa-layer-group mr-2 text-cyan-400"></i>Sys Features</span>;
                    baseTabs.sysConfig = <span><i className="fas fa-cogs mr-2 text-red-400"></i>System Config</span>;
                }

                return baseTabs;
            }, [userProfile]);

            // NEW: Timezone options for shop settings
            const timezoneOptions = [
                'Asia/Phnom_Penh',
                'Asia/Bangkok',
                'Asia/Ho_Chi_Minh',
                'Asia/Singapore',
                'Asia/Kuala_Lumpur',
                'Asia/Tokyo',
                'Europe/London',
                'America/New_York',
                'UTC'
            ];

            // Configuration for the generic CRUD component for Shops
            const shopFormFields = [
                { name: 'name', label: 'Shop Name', icon: 'fa-store', required: true }, 
                { name: 'latitude', label: 'Latitude', icon: 'fa-location-dot' }, 
                { name: 'longitude', label: 'Longitude', icon: 'fa-location-crosshairs' }, 
                { name: 'radius', label: 'Radius (m)', type: 'number', icon: 'fa-circle-notch' }, 
                { name: 'timezone', label: 'Time Zone', type: 'select', options: timezoneOptions, required: true, icon: 'fa-globe' },
                { name: 'note', label: 'Note', fullWidth: true, icon: 'fa-sticky-note' }
            ];

            const shopListColumns = [
                { header: 'Shop Name', accessor: 'name' },
                { header: 'Time Zone', accessor: 'timezone' },
                { header: 'Radius (m)', accessor: 'radius' },
                { header: 'Note', accessor: 'note' }
            ];

            const shopNames = useMemo(() => shops.map(s => s.name), [shops]);

            const shiftFormFields = [
                { name: 'shopName', label: 'Shop Name', type: 'select', options: shopNames, required: true, icon: 'fa-store' },
                { name: 'name', label: 'Shift Name', required: true, icon: 'fa-clock' },
                { name: 'startTime', label: 'Start Time', type: 'time', icon: 'fa-hourglass-start' },
                { name: 'endTime', label: 'End Time', type: 'time', icon: 'fa-hourglass-end' },
                { name: 'lateThreshold', label: 'Standard Late Limit', type: 'time', icon: 'fa-user-clock' },
                { name: 'amLeaveThreshold', label: 'AM Leave Check-In Limit (Afternoon Start)', type: 'time', icon: 'fa-sun' },
                { name: 'pmLeaveThreshold', label: 'PM Leave Check-In Limit (Morning Start)', type: 'time', icon: 'fa-moon' }
            ];
            
            const shiftListColumns = [
                { header: 'Shift Name', accessor: 'name' },
                { header: 'Start', accessor: 'startTime' },
                { header: 'Standard Late', accessor: 'lateThreshold' },
                { header: 'AM Leave Limit', accessor: 'amLeaveThreshold' },
                { header: 'PM Leave Limit', accessor: 'pmLeaveThreshold' }
            ];

            const positionFormFields = [
                { name: 'position', label: 'Position Name', required: true, icon: 'fa-briefcase' }
            ];
            
            const positionListColumns = [
                { header: 'Position Name', accessor: 'position' }
            ];
            
            const expenseCategoryFormFields = [
                { name: 'name', label: 'Category Name', required: true, icon: 'fa-tag' }
            ];
            
            const expenseCategoryListColumns = [
                { header: 'Category Name', accessor: 'name' }
            ];

            return (
                <TabbedPage tabs={tabs} activeTab={activeTab} setActiveTab={setActiveTab}>
                    <div id="shop">
                        {/* NEW: Global Settings Widget (Moved here) */}
                        <GlobalSettingsWidget userProfile={userProfile} />
                        <SettingsCRUD title="Shop" collectionName="shops" items={shops} formFields={shopFormFields} listColumns={shopListColumns} />
                        <div className="mt-8">
                           <SettingsCRUD title="Shift" collectionName="shifts" items={shifts} formFields={shiftFormFields} listColumns={shiftListColumns} />
                        </div>
                    </div>
                    {/* REVISED: Integrated KPI Manager into Position Tab */}
                    <div id="position">
                        <SettingsCRUD title="Position" collectionName="positions" items={positions} formFields={positionFormFields} listColumns={positionListColumns} />
                        <div className="mt-8">
                            <KPIManagerTab />
                        </div>
                    </div>
                    <div id="expenses">
                        <SettingsCRUD 
                            title="Expense Category" 
                            collectionName="expenseCategories" 
                            items={expenseCategories} 
                            formFields={expenseCategoryFormFields} 
                            listColumns={expenseCategoryListColumns} 
                        />
                    </div>
                    <div id="memo"><MemoAlertTab /></div>
                    
                    {/* NEW: Render Sys Feature Tab */}
                    {(userProfile?.role === 'Admin' || userProfile?.role === 'CEO') && (
                        <div id="sysFeatures"><SysFeatureTab /></div>
                    )}

                    {/* NEW: Render Sys Config Tab */}
                    {(userProfile?.role === 'Admin' || userProfile?.role === 'CEO') && (
                        <div id="sysConfig"><SysConfigTab /></div>
                    )}
                </TabbedPage>
            );
        }

        // NEW: Component for manually triggering payroll for a whole shop
        const TriggerSalaryTab = () => {
            const { db, userProfile } = useFirebase(); 
            const [selectedShop, setSelectedShop] = useState('');
            const [selectedMonth, setSelectedMonth] = useState(new Date().toISOString().slice(0, 7));
            const [triggerConfirmed, setTriggerConfirmed] = useState(false);
            const [isProcessing, setIsProcessing] = useState(false);
            const [processLog, setProcessLog] = useState([]);
            const [processComplete, setProcessComplete] = useState(false);

            // FIX: Use AppData and AllowedShops hook instead of static collection
            // This ensures Shop Managers only see their assigned shops
            const { shops } = useAppData();
            const allowedShops = useAllowedShops(userProfile, shops);

            const handleTriggerPayroll = async () => {
                if (!triggerConfirmed || !selectedShop || !selectedMonth) {
                    alert("Please select a shop, month, and confirm the action.");
                    return;
                }

                setIsProcessing(true);
                setProcessLog([]);
                setProcessComplete(false);

                // MODIFIED: Added writeBatch
                const { collection, getDocs, query, where, doc, serverTimestamp, collectionGroup, writeBatch } = window.firebaseSDK;

                setProcessLog(prev => [...prev, 'Step 1: Identifying unprocessed employees...']);

                try {
                    // --- OPTIMIZATION: Calculate Date Ranges UP FRONT ---
                    const [y, m] = selectedMonth.split('-').map(Number);
                    const startOfMonth = new Date(y, m - 1, 1);
                    const endOfMonth = new Date(y, m, 0, 23, 59, 59, 999);
                    const startStr = startOfMonth.toISOString().slice(0, 10);
                    const endStr = endOfMonth.toISOString().slice(0, 10);

                    // 1. Prepare Payroll Check Query
                    const payrollCheckQuery = query(collection(db, 'payrollHistory'), where('month', '==', selectedMonth));

                    // --- NEW OPTIMIZATION: Bulk Fetch Savings Transactions ---
                    const savingsTxQuery = query(
                        collectionGroup(db, 'transactions'), 
                        where('date', '>=', startOfMonth), 
                        where('date', '<=', endOfMonth)
                    );

                    // 2. Fetch Base Data (Metadata only)
                    const [shopsSnap, empSnap, revSnap, savingsSnap, payrollSnap, savingsTxSnap] = await Promise.all([
                        getDocs(collection(db, 'shops')),
                        getDocs(collection(db, 'employees')),
                        getDocs(collection(db, 'salaryRevisions')),
                        getDocs(collection(db, 'savingprogram')),
                        getDocs(payrollCheckQuery),
                        getDocs(savingsTxQuery) 
                    ]);

                    const allEmployees = empSnap.docs.map(d => ({ id: d.id, ...d.data() }));
                    // Create a Set of ALL IDs paid this month
                    const existingPayrollIds = new Set(payrollSnap.docs.map(d => d.data().employeeId));
                    
                    // --- PROCESS SAVINGS TRANSACTIONS INTO MAP ---
                    const withdrawalsByEmployee = new Map();
                    savingsTxSnap.docs.forEach(doc => {
                        const data = doc.data();
                        if (data.type === 'withdrawal') {
                            if (!withdrawalsByEmployee.has(data.employeeId)) {
                                withdrawalsByEmployee.set(data.employeeId, []);
                            }
                            withdrawalsByEmployee.get(data.employeeId).push({ id: doc.id, ...data });
                        }
                    });
                    setProcessLog(prev => [...prev, `> Optimizing: Pre-fetched ${savingsTxSnap.size} savings transactions.`]);

                    // 3. Filter: Active AND In Shop AND Not Processed
                    const employeesToProcess = allEmployees.filter(e => {
                        const empShops = Array.isArray(e.shop) ? e.shop : [e.shop];
                        const isShopMatch = selectedShop === 'ALL_SHOPS' || empShops.includes(selectedShop);
                        return e.status === 'Active' && isShopMatch && !existingPayrollIds.has(e.id);
                    });

                    if (employeesToProcess.length === 0) {
                        setProcessLog(prev => [...prev, 'All active employees in this shop are already processed.']);
                        alert("No pending employees found. Payroll is up to date for this month.");
                        setIsProcessing(false);
                        return;
                    }

                    setProcessLog(prev => [...prev, `Found ${employeesToProcess.length} pending employees.`]);

                    // --- STEP 2: SMART DATA FETCHING ---
                    setProcessLog(prev => [...prev, 'Step 2: Fetching attendance & records...']);

                    const targetIds = employeesToProcess.map(e => e.id);
                    const useTargetedFetch = targetIds.length <= 10;

                    // Refs
                    const attRef = collection(db, 'attendance');
                    const leaveRef = collection(db, 'leaveRequests');
                    const otRef = collection(db, 'otRequests');
                    const stateRef = collection(db, 'employeeStates');
                    const loanRef = collection(db, 'staffLoans');

                    let attQ, leaveQ, otQ, stateQ, loanQ;

                    if (useTargetedFetch) {
                        // OPTION A: Targeted Fetch
                        setProcessLog(prev => [...prev, `> Optimizing: Using Targeted Fetch for ${targetIds.length} users...`]);
                        attQ = query(attRef, where('employeeId', 'in', targetIds), where('timestamp', '>=', startOfMonth), where('timestamp', '<=', endOfMonth));
                        leaveQ = query(leaveRef, where('staffId', 'in', targetIds), where('returnDate', '>=', startStr));
                        otQ = query(otRef, where('staffId', 'in', targetIds), where('reqDate', '>=', startStr), where('reqDate', '<=', endStr));
                        stateQ = query(stateRef, where('staffId', 'in', targetIds), where('date', '>=', startStr), where('date', '<=', endStr));
                        loanQ = query(loanRef, where('staffId', 'in', targetIds), where('status', '==', 'Active'));
                    } else {
                        // OPTION B: Bulk Fetch (Simplified for brevity, same logic as before)
                        setProcessLog(prev => [...prev, `> High Volume: Using Bulk Fetch...`]);
                        let baseAttConstraints = [where('timestamp', '>=', startOfMonth), where('timestamp', '<=', endOfMonth)];
                        // ... (same logic as before for constructing shop queries) ...
                        // For safety, falling back to basic date-range fetch if complex shop logic is too heavy
                        attQ = query(attRef, ...baseAttConstraints);
                        leaveQ = query(leaveRef, where('leaveDate', '<=', endStr));
                        otQ = query(otRef, where('reqDate', '>=', startStr), where('reqDate', '<=', endStr));
                        stateQ = query(stateRef, where('date', '>=', startStr), where('date', '<=', endStr));
                        loanQ = query(loanRef, where('status', '==', 'Active'));
                    }

                    const [attSnap, leaveSnap, otSnap, loanSnap, stateSnap] = await Promise.all([
                        getDocs(attQ), getDocs(leaveQ), getDocs(otQ), getDocs(loanQ), getDocs(stateQ)
                    ]);

                    setProcessLog(prev => [...prev, `Data loaded. (${attSnap.docs.length} attendance records)`]);

                    // Assemble AllData object
                    const allData = {
                        shops: shopsSnap.docs.map(d => ({ id: d.id, ...d.data() })),
                        employees: allEmployees,
                        attendance: attSnap.docs.map(d => ({ id: d.id, ...d.data() })),
                        leaveRequests: leaveSnap.docs.map(d => ({ id: d.id, ...d.data() })),
                        otRequests: otSnap.docs.map(d => ({ id: d.id, ...d.data() })),
                        staffLoans: loanSnap.docs.map(d => ({ id: d.id, ...d.data() })),
                        employeeStates: stateSnap.docs.map(d => ({ id: d.id, ...d.data() })),
                        salaryRevisions: revSnap.docs.map(d => ({ id: d.id, ...d.data() }))
                    };
                    
                    // Map for O(1) access to savings data (Pre-fetched)
                    const savingsDataMap = new Map(savingsSnap.docs.map(d => [d.id, { id: d.id, ...d.data() }]));

                    // --- STEP 3: BATCH PROCESSING LOOP ---
                    setProcessLog(prev => [...prev, `Starting Batch Calculation...`]);
                    
                    let batch = writeBatch(db);
                    let opCount = 0;
                    let successCount = 0;
                    const BATCH_LIMIT = 450; // Safety limit (max 500)

                    for (const employee of employeesToProcess) {
                        // Get withdrawals from Map
                        const employeeSavingsWithdrawals = withdrawalsByEmployee.get(employee.id) || [];
                        const employeeSavingsData = savingsDataMap.get(employee.id) || null;
                        
                        const { inputs, calculations } = calculatePayrollForEmployee(employee, selectedMonth, allData, undefined, employeeSavingsWithdrawals, employeeSavingsData);
                        
                        if (calculations.netSalary !== undefined) {
                            const shopName = employee.primaryShop 
                                ? employee.primaryShop 
                                : (Array.isArray(employee.shop) ? employee.shop[0] : employee.shop);

                            const payrollData = { 
                                month: selectedMonth, shop: shopName, employeeId: employee.id, employeeName: employee.name, 
                                baseSalary: calculations.baseSalary, netSalary: calculations.netSalary, 
                                manualInputs: inputs, calculations: calculations, createdAt: serverTimestamp() 
                            };
                            
                            // Find active loan
                            const activeLoan = (inputs.loanDeduction > 0) ? (allData.staffLoans || [])
                                .filter(l => l.staffId === employee.id && l.status === 'Active' && (!l.effectiveDate || l.effectiveDate.slice(0, 7) <= selectedMonth))
                                .sort((a, b) => (b.effectiveDate || '0000-00').localeCompare(a.effectiveDate || '0000-00'))[0] : null;

                            const savingsAmount = calculations.savingsDeduction;

                            // --- BATCH OPERATIONS ---
                            
                            // 1. Create Payroll Record
                            const payrollDocRef = doc(collection(db, "payrollHistory"));
                            batch.set(payrollDocRef, payrollData);
                            opCount++;

                            // 2. Update Loan (if exists)
                            if (activeLoan) {
                                const newTotalPaid = (activeLoan.totalPaid || 0) + inputs.loanDeduction;
                                const newBalance = activeLoan.loanAmount - newTotalPaid;
                                const newStatus = newBalance <= 0 ? 'Paid Off' : 'Active';
                                
                                const loanRef = doc(db, 'staffLoans', activeLoan.id);
                                batch.update(loanRef, { totalPaid: newTotalPaid, status: newStatus });
                                opCount++;
                                
                                const loanPayRef = doc(collection(db, 'loanPayments'));
                                batch.set(loanPayRef, { 
                                    paymentDate: `${selectedMonth}-${new Date(y, m, 0).getDate()}`, 
                                    staffId: employee.id, staffName: employee.name, shop: shopName, 
                                    loanId: activeLoan.id, amountPaid: inputs.loanDeduction, 
                                    remainingBalance: newBalance, note: "Paid via payroll", payrollId: payrollDocRef.id 
                                });
                                opCount++;
                            }

                            // 3. Update Savings (if amount > 0)
                            if (savingsAmount > 0) {
                                const parseSafeFloat = (val) => {
                                    if (val === null || val === undefined) return 0;
                                    const num = parseFloat(val);
                                    return isNaN(num) ? 0 : num;
                                };

                                let currentBalance = 0;
                                let currentWithdrawals = 0;

                                // Use Pre-fetched Data
                                if (employeeSavingsData) {
                                    currentBalance = parseSafeFloat(employeeSavingsData.currentBalance);
                                    currentWithdrawals = parseSafeFloat(employeeSavingsData.mySavingWithdrawalTotal);
                                }

                                const newBalance = currentBalance + savingsAmount;
                                const newCredit = newBalance + currentWithdrawals;
                                
                                const savingsRef = doc(db, 'savingprogram', employee.id);
                                const savingsUpdateData = { currentBalance: newBalance, mySavingCredit: newCredit, lastUpdated: serverTimestamp() };
                                
                                if (employeeSavingsData) {
                                    batch.update(savingsRef, savingsUpdateData);
                                } else {
                                    batch.set(savingsRef, { 
                                        ...savingsUpdateData, employeeId: employee.id, employeeName: employee.name, shop: shopName, mySavingWithdrawalTotal: 0, savingsProgramStatus: 'Active', savingsPercentage: 0 
                                    });
                                }
                                opCount++;

                                const savingsLogRef = doc(collection(db, 'savingprogram', employee.id, 'transactions'));
                                batch.set(savingsLogRef, {
                                    employeeId: employee.id, staffName: employee.name, shop: shopName, date: serverTimestamp(), amountDeducted: savingsAmount, type: 'contribution', payrollId: payrollDocRef.id, note: 'Payroll Deduction'
                                });
                                opCount++;
                            }

                            successCount++;
                        } else {
                            setProcessLog(prev => [...prev, `[Skipped] ${employee.name}: No valid salary calculation.`]);
                        }

                        // Check Batch Limit
                        if (opCount >= BATCH_LIMIT) {
                            await batch.commit();
                            setProcessLog(prev => [...prev, `> Batch Committed: Processed operations...`]);
                            batch = writeBatch(db); // Start new batch
                            opCount = 0;
                        }
                    } // End Loop

                    // Commit remaining operations
                    if (opCount > 0) {
                        await batch.commit();
                        setProcessLog(prev => [...prev, `> Final Batch Committed.`]);
                    }

                    const finishMsg = `Process finished.\nSuccessfully generated payroll for ${successCount} employees.`;
                    setProcessLog(prev => [...prev, finishMsg]);
                    setIsProcessing(false);
                    setProcessComplete(true);
                    setTriggerConfirmed(false); 
                    
                    if (successCount === employeesToProcess.length) {
                        alert("Success! All payroll records generated and saved.");
                    } else if (successCount === 0) {
                        alert("Process Failed or Skipped. No records were saved.");
                    } else {
                        alert(`Process Complete.\n\nSuccess: ${successCount}\nSkipped: ${employeesToProcess.length - successCount}\n\nPlease check the log.`);
                    }

                } catch (fetchError) {
                    console.error("Critical error in payroll trigger:", fetchError);
                    let errMsg = fetchError.message;
                    if (fetchError.code === 'resource-exhausted') errMsg = "Quota Exceeded. Please wait 24 hours.";
                    
                    setProcessLog(prev => [...prev, `FATAL ERROR: ${errMsg}`]);
                    setIsProcessing(false);
                }
            };

            return (
                <Card>
                    <CardTitle>Trigger Bulk Salary Calculation</CardTitle>
                    <div className="max-w-xl mx-auto space-y-6">
                        <p className="text-slate-400">This tool allows you to generate payroll for all active employees in a selected shop for a specific month. The results will be saved to the Payroll History.</p>
                        
                        <div>
                            <label className="text-sm font-medium text-slate-400"><i className="fas fa-calendar-alt mr-2 text-blue-400"></i>Select Month</label>
                            <input type="month" value={selectedMonth} onChange={e => setSelectedMonth(e.target.value)} className="input" disabled={isProcessing} />
                        </div>

                        <div>
                            <label className="text-sm font-medium text-slate-400"><i className="fas fa-store mr-2 text-cyan-400"></i>Select Shop</label>
                            <select value={selectedShop} onChange={e => setSelectedShop(e.target.value)} className="select" disabled={isProcessing}>
                                <option value="">-- Select a Shop --</option>
                                {/* FIX: Only allow All Shops for Admin/CEO */}
                                {(userProfile?.role === 'Admin' || userProfile?.role === 'CEO') && (
                                    <option value="ALL_SHOPS">All Shops (Admin Only)</option>
                                )}
                                {/* FIX: Render allowed shops */}
                                {allowedShops.map(s => <option key={s.id} value={s.name}>{s.name}</option>)}
                            </select>
                        </div>
                        
                        <div className="p-4 border border-yellow-600 bg-yellow-900/20 rounded-lg space-y-3">
                            <h4 className="font-bold text-yellow-300">Confirmation</h4>
                            <div className="flex items-start">
                                <input id="confirm-trigger" type="checkbox" checked={triggerConfirmed} onChange={e => setTriggerConfirmed(e.target.checked)} className="h-5 w-5 rounded border-gray-300 text-blue-600 focus:ring-blue-500 bg-slate-600 mt-1" disabled={isProcessing} />
                                <label htmlFor="confirm-trigger" className="ml-3 text-sm text-slate-300">I understand that this action will generate and save payroll records for all employees in the selected shop and month. This may overwrite existing records if run multiple times.</label>
                            </div>
                        </div>

                        <Button 
                            onClick={handleTriggerPayroll} 
                            disabled={!triggerConfirmed || isProcessing || !selectedShop}
                            variant="danger"
                            className="w-full py-3 text-base"
                        >
                            {isProcessing ? <><i className="fas fa-spinner fa-spin"></i> Processing...</> : <><i className="fas fa-bolt"></i> Trigger Payroll Generation</>}
                        </Button>
                        
                        {(isProcessing || processLog.length > 0) && (
                            <div className="mt-6">
                                <h4 className="font-semibold text-slate-200">Processing Log:</h4>
                                <pre className="mt-2 bg-slate-900/70 p-4 rounded-lg text-sm text-slate-300 h-64 overflow-y-auto font-mono">
                                    {processLog.join('\n')}
                                </pre>
                            </div>
                        )}
                        {processComplete && (
                             <div className="mt-4 p-4 text-center bg-green-900/50 border border-green-700 rounded-lg">
                                <p className="font-semibold text-green-300">Process Complete!</p>
                            </div>
                        )}
                    </div>
                </Card>
            );
        };

        // Generic component for CRUD operations (Create, Read, Update, Delete)
        function SettingsCRUD({ title, collectionName, items, formFields, listColumns }) {
            const { db } = useFirebase();
            const [isModalOpen, setIsModalOpen] = useState(false);
            const [editingItem, setEditingItem] = useState(null);
            const [itemToDelete, setItemToDelete] = useState(null);
            
            // NEW: QR Modal State (Phase 1)
            const [qrShop, setQrShop] = useState(null);

            // --- MODIFIED: Robust Initial State Logic ---
            // Ensure arrays (for checkbox-groups) are initialized as [] and strings as ''
            const getInitialState = useCallback(() => formFields.reduce((acc, field) => {
                if (field.type === 'checkbox-group') {
                    acc[field.name] = []; 
                } else {
                    acc[field.name] = '';
                }
                return acc;
            }, {}), [formFields]);

            const [formData, setFormData] = useState(getInitialState());

            // Memoized grouping logic specifically for shifts
            const groupedItems = useMemo(() => {
                if (collectionName !== 'shifts') return null;

                // Group items by shopName
                const grouped = items.reduce((acc, item) => {
                    const groupKey = item.shopName || 'Uncategorized';
                    if (!acc[groupKey]) {
                        acc[groupKey] = [];
                    }
                    acc[groupKey].push(item);
                    return acc;
                }, {});

                // Sort shifts within each group (e.g., AM, PM)
                Object.keys(grouped).forEach(shop => {
                    grouped[shop].sort((a, b) => a.name.localeCompare(b.name));
                });

                return grouped;
            }, [items, collectionName]);

            // NEW: Get sorted keys for rendering the groups in alphabetical order
            const sortedGroupKeys = useMemo(() => {
                if (!groupedItems) return [];
                return Object.keys(groupedItems).sort();
            }, [groupedItems]);

            const handleOpenModal = (item = null) => {
                if (item) {
                    setEditingItem(item);
                    setFormData({ ...item });
                } else {
                    setEditingItem(null);
                    setFormData(getInitialState());
                }
                setIsModalOpen(true);
            };

            const handleCloseModal = () => {
                setIsModalOpen(false);
                setEditingItem(null);
                setFormData(getInitialState());
            };

            const handleSave = useCallback(async (item) => {
                const { doc, updateDoc, addDoc, collection } = window.firebaseSDK;
                
                // --- BUG FIX: Check for duplicates on BOTH Create and Update ---
                if (collectionName === 'shifts') {
                    const isDuplicate = items.some(existingShift => 
                        existingShift.name === item.name && 
                        existingShift.shopName === item.shopName &&
                        existingShift.id !== item.id // Exclude itself when editing
                    );

                    if (isDuplicate) {
                        alert(`A shift with the name "${item.name}" already exists for "${item.shopName}". Please choose a different name.`);
                        return; // Stop the save
                    }
                }
                // --- END FIX ---

                try {
                    if (item.id) { const { id, ...data } = item; await updateDoc(doc(db, collectionName, id), data); } 
                    else { 
                        await addDoc(collection(db, collectionName), item); 
                    }
                    handleCloseModal();
                } catch (e) { console.error(`Error saving ${collectionName}:`, e); }
            }, [db, collectionName, items]); 
            
            const handleDelete = useCallback(async () => {
                if (!itemToDelete) return;
                try { 
                    await window.firebaseSDK.deleteDoc(window.firebaseSDK.doc(db, collectionName, itemToDelete.id)); 
                } catch (e) { 
                    console.error(`Error deleting ${collectionName}:`, e); 
                } finally {
                    setItemToDelete(null);
                }
            }, [db, collectionName, itemToDelete]);

            // OPTIMIZATION: Refactored UI to use PageHeader and Modal
            return (
                <Card>
                    <PageHeader title={`${title} Management`}>
                        {/* NEW: Add Button moved to Header */}
                        <Button variant="primary" icon="fa-plus" onClick={() => handleOpenModal()}>Add {title}</Button>
                    </PageHeader>
                    
                    <div className="overflow-x-auto">
                        <table className="min-w-full divide-y divide-slate-700">
                            <thead className="bg-slate-900/50">
                                <tr>
                                    {listColumns.map(col => <th key={col.accessor} className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">{col.header}</th>)}
                                    <th className="px-4 py-3 text-right text-xs font-semibold text-slate-400 uppercase">Actions</th>
                                </tr>
                            </thead>
                            <tbody className="divide-y divide-slate-700">
                                {/* NEW: Conditional rendering for grouped shifts vs. flat lists */}
                                {collectionName === 'shifts' && groupedItems ? (
                                    sortedGroupKeys.map(shopName => (
                                        <React.Fragment key={shopName}>
                                            <tr className="bg-slate-900">
                                                <td colSpan={listColumns.length + 1} className="px-4 py-2 text-sm font-semibold text-blue-400 tracking-wider">
                                                    {shopName}
                                                </td>
                                            </tr>
                                            {groupedItems[shopName].map(item => (
                                                <tr key={item.id} className="hover:bg-slate-700/50">
                                                    {listColumns.map(col => <td key={col.accessor} className="px-4 py-4 text-sm text-slate-300">{col.render ? col.render(item) : item[col.accessor]}</td>)}
                                                    <td className="px-4 py-4 text-sm">
                                                        <div className="flex items-center justify-end gap-4">
                                                            <Button variant="icon-edit" icon="fa-edit" onClick={() => handleOpenModal(item)} />
                                                            <Button variant="icon-delete" icon="fa-trash" onClick={() => setItemToDelete(item)} />
                                                        </div>
                                                    </td>
                                                </tr>
                                            ))}
                                        </React.Fragment>
                                    ))
                                ) : (
                                    items.map(item => (
                                        <tr key={item.id} className="hover:bg-slate-700/50">
                                            {listColumns.map(col => <td key={col.accessor} className="px-4 py-4 text-sm text-slate-300">{col.render ? col.render(item) : item[col.accessor]}</td>)}
                                            <td className="px-4 py-4 text-sm">
                                                <div className="flex items-center justify-end gap-2">
                                                    {/* NEW: Add QR Button for Shops (Phase 1) */}
                                                    {collectionName === 'shops' && (
                                                        <Button variant="icon-view" icon="fa-qrcode" onClick={() => setQrShop(item)} title="Generate QR Code" className="text-purple-400 hover:text-purple-300" />
                                                    )}
                                                    <Button variant="icon-edit" icon="fa-edit" onClick={() => handleOpenModal(item)} />
                                                    <Button variant="icon-delete" icon="fa-trash" onClick={() => setItemToDelete(item)} />
                                                </div>
                                            </td>
                                        </tr>
                                    ))
                                )}
                            </tbody>
                        </table>
                    </div>

                    {/* NEW: Modal Form */}
                    <Modal isOpen={isModalOpen} onClose={handleCloseModal} maxWidth="max-w-2xl">
                        <form onSubmit={(e) => { e.preventDefault(); handleSave(formData); }} className="flex flex-col h-full overflow-hidden">
                            <ModalHeader title={editingItem ? `Edit ${title}` : `Add New ${title}`} onClose={handleCloseModal} />
                            <ModalBody>
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    {formFields.map(field => (
                                        <div key={field.name} className={field.fullWidth ? 'col-span-full' : ''}>
                                            <label className="block text-sm font-medium text-slate-400 mb-1">
                                                {field.icon && <i className={`fas ${field.icon} mr-2 text-blue-400`}></i>}
                                                {field.label}
                                            </label>
                                            {field.type === 'select' ? (
                                                <select name={field.name} value={formData[field.name] || ''} onChange={(e) => setFormData({...formData, [field.name]: e.target.value})} className="select" required={field.required}>
                                                    <option value="">Select {field.label}</option>
                                                    {(field.options || []).map(option => (<option key={option} value={option}>{option}</option>))}
                                                </select>
                                            ) : field.type === 'checkbox-group' ? (
                                                <div className="mt-2 grid grid-cols-2 gap-2 p-2 border border-slate-600 rounded bg-slate-700/50 max-h-32 overflow-y-auto">
                                                    {(field.options || []).map(opt => (
                                                        <div key={opt.id} className="flex items-center">
                                                            <input 
                                                                type="checkbox" 
                                                                id={`${field.name}-${opt.id}`} 
                                                                name={field.name} 
                                                                value={opt.id} 
                                                                checked={(formData[field.name] || []).includes(opt.id)} 
                                                                onChange={(e) => {
                                                                    const checked = e.target.checked;
                                                                    const val = opt.id;
                                                                    const current = formData[field.name] || [];
                                                                    const updated = checked ? [...current, val] : current.filter(v => v !== val);
                                                                    setFormData({...formData, [field.name]: updated});
                                                                }}
                                                                className="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500 bg-slate-600"
                                                            />
                                                            <label htmlFor={`${field.name}-${opt.id}`} className="ml-2 text-xs text-slate-300 truncate cursor-pointer">{opt.name}</label>
                                                        </div>
                                                    ))}
                                                </div>
                                            ) : (
                                                <input type={field.type || 'text'} name={field.name} value={formData[field.name] || ''} onChange={(e) => setFormData({...formData, [field.name]: e.target.value})} className="input" required={field.required} />
                                            )}
                                        </div>
                                    ))}
                                </div>
                            </ModalBody>
                            <ModalFooter>
                                <Button variant="secondary" onClick={handleCloseModal}>Cancel</Button>
                                <Button type="submit" variant="primary">Save</Button>
                            </ModalFooter>
                        </form>
                    </Modal>

                    <ConfirmationModal isOpen={!!itemToDelete} onClose={() => setItemToDelete(null)} onConfirm={handleDelete} title={`Delete ${title}`} message="Are you sure you want to delete this item?" />
                    
                    {/* NEW: Render QR Modal (Phase 1) */}
                    <ShopQRModal isOpen={!!qrShop} onClose={() => setQrShop(null)} shop={qrShop} />
                </Card>
            );
        }
        // --- END SETTINGS PAGE ---

        // --- START ASSET MANAGER PAGE (NEW) ---
        
        // Modal for Adding/Editing Assets
        const AssetModal = ({ isOpen, onClose, onSave, asset, userProfile }) => {
            const [formData, setFormData] = useState({});
            // MODIFIED: Get employees from context to populate the list
            const { shops, employees } = useAppData();

            // OPTIMIZATION: Use the new hook
            const availableShops = useAllowedShops(userProfile, shops);

            // NEW: Filter employees for the selected shop
            const shopEmployees = useMemo(() => {
                if (!formData.shop) return [];
                return employees.filter(e => {
                    const empShops = Array.isArray(e.shop) ? e.shop : [e.shop];
                    return empShops.includes(formData.shop) && e.status === 'Active';
                });
            }, [formData.shop, employees]);

            useEffect(() => {
                if (isOpen) {
                    const initialShop = (userProfile.role === 'Shop Manager' && Array.isArray(userProfile.shop) && userProfile.shop.length === 1) 
                        ? userProfile.shop[0] 
                        : '';
                    
                    // Helper to format existing date for input or default to today
                    const defaultDate = new Date().toISOString().slice(0, 10);
                    let initialDate = defaultDate;
                    
                    if (asset && asset.lastUpdated && asset.lastUpdated.toDate) {
                        initialDate = asset.lastUpdated.toDate().toISOString().slice(0, 10);
                    }

                    setFormData(asset ? { ...asset, assignedDate: initialDate } : {
                        name: '',
                        category: 'Equipment', 
                        shop: initialShop,
                        purchaseValue: '',
                        condition: 'New',
                        status: 'Available',
                        notes: '',
                        currentHolderId: '', // NEW: Default empty
                        assignedDate: defaultDate // NEW: Default to today
                    });
                }
            }, [isOpen, asset, userProfile]);

            const handleChange = (e) => {
                const { name, value } = e.target;
                setFormData(prev => {
                    const newData = { ...prev, [name]: value };
                    
                    // NEW: If Shop changes, clear the assigned staff to prevent mismatch
                    if (name === 'shop') {
                        newData.currentHolderId = '';
                    }
                    return newData;
                });
            };

            const handleSubmit = (e) => {
                e.preventDefault();
                if (!formData.name || !formData.shop) {
                    alert("Please fill in required fields.");
                    return;
                }
                onSave(formData);
            };

            return (
                <Modal isOpen={isOpen} onClose={onClose}>
                    <form onSubmit={handleSubmit}>
                        <ModalHeader title={asset ? "Edit Asset" : "Add New Asset"} onClose={onClose} />
                        <ModalBody>
                            <div className="space-y-4">
                                <div>
                                    <label className="text-sm font-medium text-slate-400">
                                        <i className="fas fa-tag mr-2 text-blue-400"></i>Asset Name
                                    </label>
                                    <input name="name" value={formData.name || ''} onChange={handleChange} className="input" placeholder="e.g., Shop Key #1, Dell Laptop" required />
                                </div>
                                <div className="grid grid-cols-2 gap-4">
                                    <div>
                                        <label className="text-sm font-medium text-slate-400">
                                            <i className="fas fa-layer-group mr-2 text-purple-400"></i>Category
                                        </label>
                                        <select name="category" value={formData.category} onChange={handleChange} className="select">
                                            <option>Equipment</option>
                                            <option>Keys</option>
                                            <option>Electronics</option>
                                            <option>Uniform</option>
                                            <option>Vehicle</option>
                                            <option>Other</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label className="text-sm font-medium text-slate-400">
                                            <i className="fas fa-store mr-2 text-cyan-400"></i>Shop Location
                                        </label>
                                        <select name="shop" value={formData.shop || ''} onChange={handleChange} className="select" required disabled={asset && asset.status === 'Assigned'}>
                                            <option value="">Select Shop</option>
                                            {availableShops.map(s => <option key={s.id} value={s.name}>{s.name}</option>)}
                                        </select>
                                    </div>
                                </div>

                                {/* NEW: Assignment Section - Only visible if Shop is selected */}
                                {formData.shop && (
                                    <div className="p-4 bg-slate-700/30 rounded-lg border border-slate-600/50">
                                        <h4 className="text-xs font-bold text-slate-400 uppercase mb-3">Initial Assignment</h4>
                                        <div className="grid grid-cols-2 gap-4">
                                            <div>
                                                <label className="text-sm font-medium text-slate-400">
                                                    <i className="fas fa-user mr-2 text-emerald-400"></i>Assigned To
                                                </label>
                                                <select 
                                                    name="currentHolderId" 
                                                    value={formData.currentHolderId || ''} 
                                                    onChange={handleChange} 
                                                    className="select"
                                                >
                                                    <option value="">-- Available (None) --</option>
                                                    {shopEmployees.map(e => <option key={e.id} value={e.id}>{e.name}</option>)}
                                                </select>
                                            </div>
                                            
                                            {/* Show Date Picker only if a staff is selected */}
                                            {formData.currentHolderId && (
                                                <div className="animate-fade-in">
                                                    <label className="text-sm font-medium text-slate-400">
                                                        <i className="fas fa-calendar-check mr-2 text-orange-400"></i>Assigned Date
                                                    </label>
                                                    <input 
                                                        type="date" 
                                                        name="assignedDate" 
                                                        value={formData.assignedDate || ''} 
                                                        onChange={handleChange} 
                                                        className="input" 
                                                    />
                                                </div>
                                            )}
                                        </div>
                                    </div>
                                )}

                                <div className="grid grid-cols-2 gap-4">
                                    <div>
                                        <label className="text-sm font-medium text-slate-400">
                                            <i className="fas fa-money-bill-wave mr-2 text-green-400"></i>Value (KHR)
                                        </label>
                                        <input type="number" name="purchaseValue" value={formData.purchaseValue || ''} onChange={handleChange} className="input" placeholder="0" />
                                    </div>
                                    <div>
                                        <label className="text-sm font-medium text-slate-400">
                                            <i className="fas fa-clipboard-check mr-2 text-yellow-400"></i>Condition
                                        </label>
                                        <select name="condition" value={formData.condition} onChange={handleChange} className="select">
                                            <option>New</option>
                                            <option>Good</option>
                                            <option>Fair</option>
                                            <option>Poor</option>
                                            <option>Broken</option>
                                        </select>
                                    </div>
                                </div>
                                <div>
                                    <label className="text-sm font-medium text-slate-400">
                                        <i className="fas fa-sticky-note mr-2 text-slate-400"></i>Notes
                                    </label>
                                    <textarea name="notes" value={formData.notes || ''} onChange={handleChange} className="input" rows="2"></textarea>
                                </div>
                            </div>
                        </ModalBody>
                        <ModalFooter>
                            <Button variant="secondary" onClick={onClose}>Cancel</Button>
                            <Button type="submit" variant="primary">Save Asset</Button>
                        </ModalFooter>
                    </form>
                </Modal>
            );
        };

        // Modal for Assigning, Returning, or Reporting Lost Assets
        const AssetActionModal = ({ isOpen, onClose, onProcess, asset, employees }) => {
            // ... (keep existing AssetActionModal code) ...
            const [actionType, setActionType] = useState('checkout'); // 'checkout', 'checkin', 'lost'
            const [selectedEmployeeId, setSelectedEmployeeId] = useState('');
            const [notes, setNotes] = useState('');
            const [condition, setCondition] = useState('Good');
            const [deductFromPayroll, setDeductFromPayroll] = useState(false);
            const [deductionAmount, setDeductionAmount] = useState(0);
            const [actionDate, setActionDate] = useState('');

            useEffect(() => {
                if (isOpen && asset) {
                    if (asset.status === 'Available') setActionType('checkout');
                    else setActionType('checkin');
                    
                    setSelectedEmployeeId('');
                    setNotes('');
                    setCondition(asset.condition || 'Good');
                    setDeductFromPayroll(false);
                    setDeductionAmount(parseFloat(asset.purchaseValue) || 0);
                    setActionDate(new Date().toISOString().slice(0, 10));
                }
            }, [isOpen, asset]);

            const eligibleEmployees = useMemo(() => {
                if (!asset || !employees) return [];
                return employees.filter(e => {
                    const empShops = Array.isArray(e.shop) ? e.shop : [e.shop];
                    return empShops.includes(asset.shop) && e.status === 'Active';
                });
            }, [employees, asset]);

            const handleSubmit = (e) => {
                e.preventDefault();
                onProcess({
                    actionType,
                    assetId: asset.id,
                    employeeId: selectedEmployeeId,
                    notes,
                    condition,
                    deductFromPayroll,
                    deductionAmount,
                    actionDate
                });
            };

            if (!asset) return null;

            return (
                <Modal isOpen={isOpen} onClose={onClose} maxWidth="max-w-md">
                    <form onSubmit={handleSubmit}>
                        <ModalHeader title={`Manage: ${asset.name}`} onClose={onClose} />
                        <ModalBody>
                            {asset.status === 'Assigned' && (
                                <div className="flex space-x-2 mb-6 p-1 bg-slate-700 rounded-lg">
                                    <button type="button" onClick={() => setActionType('checkin')} className={`flex-1 py-2 rounded-md text-sm font-medium transition-colors ${actionType === 'checkin' ? 'bg-blue-600 text-white shadow' : 'text-slate-300 hover:text-white'}`}>Return (Check-In)</button>
                                    <button type="button" onClick={() => setActionType('lost')} className={`flex-1 py-2 rounded-md text-sm font-medium transition-colors ${actionType === 'lost' ? 'bg-red-600 text-white shadow' : 'text-slate-300 hover:text-white'}`}>Report Lost</button>
                                </div>
                            )}

                            {actionType === 'checkout' && (
                                <div className="space-y-4">
                                    <div className="p-3 bg-blue-900/30 border border-blue-700/50 rounded-lg text-blue-200 text-sm">
                                        <i className="fas fa-info-circle mr-2"></i> Assigning item from <strong>{asset.shop}</strong>
                                    </div>
                                    <div>
                                        <label className="text-sm font-medium text-slate-400"><i className="fas fa-user mr-2 text-emerald-400"></i>Assign to Employee</label>
                                        <select value={selectedEmployeeId} onChange={e => setSelectedEmployeeId(e.target.value)} className="select" required>
                                            <option value="">Select Employee</option>
                                            {eligibleEmployees.map(e => <option key={e.id} value={e.id}>{e.name}</option>)}
                                        </select>
                                    </div>
                                    <div>
                                        <label className="text-sm font-medium text-slate-400"><i className="fas fa-calendar-minus mr-2 text-orange-400"></i>Check-Out Date</label>
                                        <input type="date" value={actionDate} onChange={e => setActionDate(e.target.value)} className="input" required />
                                    </div>
                                    <div>
                                        <label className="text-sm font-medium text-slate-400"><i className="fas fa-sticky-note mr-2 text-slate-400"></i>Check-Out Notes</label>
                                        <textarea value={notes} onChange={e => setNotes(e.target.value)} className="input" rows="2" placeholder="e.g., Handed over with charger"></textarea>
                                    </div>
                                </div>
                            )}

                            {actionType === 'checkin' && (
                                <div className="space-y-4">
                                    <div className="p-3 bg-green-900/30 border border-green-700/50 rounded-lg text-green-200 text-sm">
                                        <i className="fas fa-undo mr-2"></i> Returning item from <strong>{asset.currentHolderName}</strong>
                                    </div>
                                    <div>
                                        <label className="text-sm font-medium text-slate-400"><i className="fas fa-calendar-plus mr-2 text-green-400"></i>Return Date</label>
                                        <input type="date" value={actionDate} onChange={e => setActionDate(e.target.value)} className="input" required />
                                    </div>
                                    <div>
                                        <label className="text-sm font-medium text-slate-400"><i className="fas fa-clipboard-check mr-2 text-yellow-400"></i>Return Condition</label>
                                        <select value={condition} onChange={e => setCondition(e.target.value)} className="select">
                                            <option>New</option>
                                            <option>Good</option>
                                            <option>Fair</option>
                                            <option>Poor</option>
                                            <option>Broken</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label className="text-sm font-medium text-slate-400"><i className="fas fa-sticky-note mr-2 text-slate-400"></i>Return Notes</label>
                                        <textarea value={notes} onChange={e => setNotes(e.target.value)} className="input" rows="2" placeholder="e.g., Returned in good condition"></textarea>
                                    </div>
                                </div>
                            )}

                            {actionType === 'lost' && (
                                <div className="space-y-4">
                                    <div className="p-3 bg-red-900/30 border border-red-700/50 rounded-lg text-red-200 text-sm">
                                        <i className="fas fa-exclamation-triangle mr-2"></i> Reporting lost by <strong>{asset.currentHolderName}</strong>
                                    </div>
                                    
                                    <div>
                                        <label className="text-sm font-medium text-slate-400"><i className="fas fa-calendar-xmark mr-2 text-red-400"></i>Lost Date</label>
                                        <input type="date" value={actionDate} onChange={e => setActionDate(e.target.value)} className="input" required />
                                    </div>

                                    <div className="flex items-center p-3 border border-slate-600 rounded-lg bg-slate-700/30">
                                        <input id="deduct-check" type="checkbox" checked={deductFromPayroll} onChange={e => setDeductFromPayroll(e.target.checked)} className="h-5 w-5 rounded border-gray-300 text-red-600 focus:ring-red-500 bg-slate-600" />
                                        <label htmlFor="deduct-check" className="ml-3 text-sm font-medium text-slate-200">Deduct cost from Payroll?</label>
                                    </div>

                                    {deductFromPayroll && (
                                        <div className="animate-fade-in">
                                            <label className="text-sm font-medium text-slate-400"><i className="fas fa-money-bill mr-2 text-green-400"></i>Deduction Amount (KHR)</label>
                                            <input type="number" value={deductionAmount} onChange={e => setDeductionAmount(e.target.value)} className="input font-bold text-red-400" />
                                            <p className="text-xs text-slate-500 mt-1">This will create a 'Deduction' record in Employee States.</p>
                                        </div>
                                    )}

                                    <div>
                                        <label className="text-sm font-medium text-slate-400"><i className="fas fa-comment-alt mr-2 text-slate-400"></i>Notes / Reason</label>
                                        <textarea value={notes} onChange={e => setNotes(e.target.value)} className="input" rows="2" required placeholder="Details about the loss..."></textarea>
                                    </div>
                                </div>
                            )}
                        </ModalBody>
                        <ModalFooter>
                            <Button variant="secondary" onClick={onClose}>Cancel</Button>
                            <Button type="submit" variant={actionType === 'lost' ? 'danger' : actionType === 'checkin' ? 'success' : 'primary'} disabled={actionType === 'checkout' && !selectedEmployeeId}>
                                {actionType === 'checkout' ? 'Confirm Check-Out' : actionType === 'checkin' ? 'Confirm Return' : 'Report Lost'}
                            </Button>
                        </ModalFooter>
                    </form>
                </Modal>
            );
        };

        // NEW: Asset Dashboard Tab (Extracted Logic)
        const AssetDashboardTab = ({ userProfile }) => {
            const { db, auth } = useFirebase();
            const { shops, employees } = useAppData();
            const { where, collection, addDoc, updateDoc, doc, serverTimestamp, deleteDoc } = window.firebaseSDK;

            // Filters
            const [selectedShop, setSelectedShop] = useState('');
            const [statusFilter, setStatusFilter] = useState('All');
            const [searchTerm, setSearchTerm] = useState('');

            // Modals
            const [isAssetModalOpen, setIsAssetModalOpen] = useState(false);
            const [isActionModalOpen, setIsActionModalOpen] = useState(false);
            const [editingAsset, setEditingAsset] = useState(null);
            const [activeAsset, setActiveAsset] = useState(null); 
            const [assetToDelete, setAssetToDelete] = useState(null);

            // Fetch Assets
            const queryConstraints = useMemo(() => {
                if (!userProfile) return [where("shop", "==", "null")];
                if (userProfile.role === 'Admin' || userProfile.role === 'CEO') return [];
                if (userProfile.role === 'Shop Manager') {
                    const managedShops = Array.isArray(userProfile.shop) ? userProfile.shop : (userProfile.shop ? [userProfile.shop] : []);
                    return managedShops.length > 0 ? [where("shop", "in", managedShops)] : [where("shop", "==", "null")];
                }
                return [where("shop", "==", "null")]; 
            }, [userProfile]);

            const { data: assets, loading } = useCollection('assets', queryConstraints);

            // Filter Logic
            const filteredAssets = useMemo(() => {
                return assets.filter(asset => {
                    const shopMatch = !selectedShop || asset.shop === selectedShop;
                    const statusMatch = statusFilter === 'All' || asset.status === statusFilter;
                    const searchMatch = !searchTerm || 
                        asset.name.toLowerCase().includes(searchTerm.toLowerCase()) || 
                        (asset.currentHolderName && asset.currentHolderName.toLowerCase().includes(searchTerm.toLowerCase()));
                    
                    return shopMatch && statusMatch && searchMatch;
                });
            }, [assets, selectedShop, statusFilter, searchTerm]);

            // Handlers
            const handleSaveAsset = async (formData) => {
                try {
                    const { currentHolderId, assignedDate, ...restFormData } = formData;
                    let status = 'Available';
                    let holderData = { currentHolderId: null, currentHolderName: null };
                    let timestampData = { updatedAt: serverTimestamp() }; 

                    if (currentHolderId) {
                        status = 'Assigned';
                        const emp = employees.find(e => e.id === currentHolderId);
                        if (emp) {
                            holderData = { currentHolderId: emp.id, currentHolderName: emp.name };
                        }
                        if (assignedDate) {
                            timestampData = { lastUpdated: new Date(`${assignedDate}T12:00:00`) };
                        } else {
                            timestampData = { lastUpdated: serverTimestamp() };
                        }
                    } else {
                        holderData = { currentHolderId: null, currentHolderName: null };
                        if (!editingAsset) { status = 'Available'; } else { status = 'Available'; }
                    }

                    const data = { ...restFormData, ...holderData, ...timestampData, status: status, purchaseValue: parseFloat(formData.purchaseValue) || 0 };
                    
                    if (editingAsset) {
                        await updateDoc(doc(db, 'assets', editingAsset.id), data);
                    } else {
                        await addDoc(collection(db, 'assets'), { ...data, createdAt: serverTimestamp() });
                    }
                    setIsAssetModalOpen(false);
                    setEditingAsset(null);
                } catch (error) {
                    console.error("Error saving asset:", error);
                    alert("Failed to save asset.");
                }
            };

            const handleProcessAction = async ({ actionType, assetId, employeeId, notes, condition, deductFromPayroll, deductionAmount, actionDate }) => {
                try {
                    const assetRef = doc(db, 'assets', assetId);
                    const employee = employees.find(e => e.id === employeeId);
                    const timestamp = actionDate ? new Date(`${actionDate}T12:00:00`) : new Date();

                    if (actionType === 'checkout') {
                        if (!employee) return;
                        await updateDoc(assetRef, { status: 'Assigned', currentHolderId: employee.id, currentHolderName: employee.name, lastUpdated: timestamp, notes: notes ? `Check-Out Note: ${notes}` : '' });
                    } else if (actionType === 'checkin') {
                        await updateDoc(assetRef, { status: 'Available', condition: condition, currentHolderId: null, currentHolderName: null, lastUpdated: timestamp, notes: notes ? `Return Note: ${notes}` : '' });
                    } else if (actionType === 'lost') {
                        await updateDoc(assetRef, { status: 'Lost', currentHolderId: null, notes: `Marked Lost. ${notes}`, lastUpdated: timestamp });
                        if (deductFromPayroll && activeAsset.currentHolderId) {
                            await addDoc(collection(db, 'employeeStates'), { staffId: activeAsset.currentHolderId, staffName: activeAsset.currentHolderName, shop: activeAsset.shop, date: actionDate || new Date().toISOString().slice(0, 10), statusState: 'Deduction', amount: parseFloat(deductionAmount), note: `Lost Asset Deduction: ${activeAsset.name} - ${notes}`, status: 'Approved' });
                        }
                    }

                    const actionName = actionType === 'checkout' ? 'Asset Check-Out' : actionType === 'checkin' ? 'Asset Check-In' : 'Asset Lost Report';
                    Utils.logUserActivity(db, auth, actionName, { assetName: activeAsset.name, employee: employee ? employee.name : activeAsset.currentHolderName, date: actionDate, notes });

                    setIsActionModalOpen(false);
                    setActiveAsset(null);
                } catch (error) {
                    console.error("Error processing asset action:", error);
                    alert("Failed to update asset.");
                }
            };

            const handleDelete = async () => {
                if (!assetToDelete) return;
                try { await deleteDoc(doc(db, 'assets', assetToDelete.id)); setAssetToDelete(null); } 
                catch (error) { console.error("Error deleting asset:", error); }
            };

            return (
                <Card>
                    <PageHeader title="Asset Manager">
                        <ShopFilterSelect userProfile={userProfile} shops={shops} selectedShop={selectedShop} onChange={e => setSelectedShop(e.target.value)} />
                        <select value={statusFilter} onChange={e => setStatusFilter(e.target.value)} className="select w-full sm:w-auto">
                            <option value="All">All Status</option><option value="Available">Available</option><option value="Assigned">Assigned</option><option value="Lost">Lost</option><option value="Broken">Broken</option>
                        </select>
                        <SearchInput value={searchTerm} onChange={e => setSearchTerm(e.target.value)} placeholder="Search asset or staff..." />
                        <Button variant="primary" icon="fa-plus" onClick={() => { setEditingAsset(null); setIsAssetModalOpen(true); }}>Add Asset</Button>
                    </PageHeader>

                    {loading ? ( <div className="text-center py-10"><i className="fas fa-spinner fa-spin text-3xl text-blue-400"></i></div> ) : (
                        <div className="overflow-x-auto">
                            <table className="min-w-full divide-y divide-slate-700">
                                <thead className="bg-slate-900/50">
                                    <tr>
                                        <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Asset Name</th>
                                        <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Type</th>
                                        <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Shop</th>
                                        <th className="px-4 py-3 text-center text-xs font-semibold text-slate-400 uppercase">Status</th>
                                        <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Current Holder</th>
                                        <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Condition</th>
                                        <th className="px-4 py-3 text-right text-xs font-semibold text-slate-400 uppercase">Value</th>
                                        <th className="px-4 py-3 text-center text-xs font-semibold text-slate-400 uppercase">Actions</th>
                                    </tr>
                                </thead>
                                <tbody className="divide-y divide-slate-700">
                                    {filteredAssets.length === 0 ? ( <tr><td colSpan="8" className="px-4 py-8 text-center text-slate-500">No assets found.</td></tr> ) : (
                                        filteredAssets.map(asset => (
                                            <tr key={asset.id} className="hover:bg-slate-700/50">
                                                <td className="px-4 py-4 text-sm text-slate-200 font-medium">{asset.name}</td>
                                                <td className="px-4 py-4 text-sm text-slate-400">{asset.category}</td>
                                                <td className="px-4 py-4 text-sm text-slate-300">{asset.shop}</td>
                                                <td className="px-4 py-4 text-center"><span className={`px-2 py-1 text-xs font-bold rounded-full ${asset.status === 'Available' ? 'bg-green-900 text-green-300' : asset.status === 'Assigned' ? 'bg-blue-900 text-blue-300' : 'bg-red-900 text-red-300'}`}>{asset.status}</span></td>
                                                <td className="px-4 py-4 text-sm text-slate-200">{asset.currentHolderName || '-'}</td>
                                                <td className="px-4 py-4 text-sm text-slate-300">{asset.condition}</td>
                                                <td className="px-4 py-4 text-sm text-right text-slate-400">{Utils.formatCurrency(asset.purchaseValue)}</td>
                                                <td className="px-4 py-4 text-center">
                                                    <div className="flex items-center justify-center gap-2">
                                                        {asset.status === 'Available' ? ( <Button variant="icon-approve" icon="fa-share-from-square" onClick={() => { setActiveAsset(asset); setIsActionModalOpen(true); }} title="Check-Out / Assign" /> ) : asset.status === 'Assigned' ? ( <Button variant="icon-edit-alt" icon="fa-reply" onClick={() => { setActiveAsset(asset); setIsActionModalOpen(true); }} title="Return / Lost" /> ) : null}
                                                        <Button variant="icon-edit" icon="fa-edit" onClick={() => { setEditingAsset(asset); setIsAssetModalOpen(true); }} />
                                                        <Button variant="icon-delete" icon="fa-trash" onClick={() => setAssetToDelete(asset)} />
                                                    </div>
                                                </td>
                                            </tr>
                                        ))
                                    )}
                                </tbody>
                            </table>
                        </div>
                    )}
                    <AssetModal isOpen={isAssetModalOpen} onClose={() => setIsAssetModalOpen(false)} onSave={handleSaveAsset} asset={editingAsset} userProfile={userProfile} />
                    <AssetActionModal isOpen={isActionModalOpen} onClose={() => setIsActionModalOpen(false)} onProcess={handleProcessAction} asset={activeAsset} employees={employees} />
                    <ConfirmationModal isOpen={!!assetToDelete} onClose={() => setAssetToDelete(null)} onConfirm={handleDelete} title="Delete Asset" message={`Are you sure you want to delete "${assetToDelete?.name}"?`} />
                </Card>
            );
        };

        const AssetManagerPage = ({ userProfile }) => {
            const { moduleConfig = {} } = useAppData();
            const [activeTab, setActiveTab] = useState('');

            const tabs = useMemo(() => {
                const available = {};
                // If enabled, show the dashboard tab
                if (moduleConfig['assets:main'] !== false) {
                    available.main = <span><i className="fas fa-boxes-stacked mr-2 text-orange-400"></i>Asset Dashboard</span>;
                }
                return available;
            }, [moduleConfig]);

            useEffect(() => {
                const keys = Object.keys(tabs);
                if (keys.length > 0 && !tabs[activeTab]) {
                    setActiveTab(keys[0]);
                }
            }, [tabs, activeTab]);

            return (
                <TabbedPage tabs={tabs} activeTab={activeTab} setActiveTab={setActiveTab}>
                    {tabs.main && <div id="main"><AssetDashboardTab userProfile={userProfile} /></div>}
                </TabbedPage>
            );
        };
        // --- END ASSET MANAGER PAGE ---

        // --- START TASK MANAGER PAGE (NEW INTEGRATION) ---
        
        // Constants & Helpers for Task Manager
        const KANBAN_STATUS = {
            TODO: 'todo',
            IN_PROGRESS: 'in_progress',
            AUDITING: 'auditing',
            DONE: 'done'
        };

        const ICONS = {
            KPI: (props) => <i className={`fas fa-chart-line ${props.className}`}></i>
        };

        // Helper to format timestamps
        const formatFullDateTime = (timestamp) => {
            if (!timestamp) return '';
            const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
            
            const d = String(date.getDate()).padStart(2, '0');
            const m = String(date.getMonth() + 1).padStart(2, '0');
            const y = String(date.getFullYear()).slice(-2);
            const time = date.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: true });
            
            return `${d}-${m}-${y} | ${time}`;
        };

        // NEW: Helper to calculate work duration for history items
        const getTaskWorkTime = (task) => {
            if (task.progressTimestamp && task.workCompletedTimestamp) {
                const start = task.progressTimestamp.toDate ? task.progressTimestamp.toDate() : new Date(task.progressTimestamp);
                const end = task.workCompletedTimestamp.toDate ? task.workCompletedTimestamp.toDate() : new Date(task.workCompletedTimestamp);
                const diffMs = end - start;
                
                // Handle edge cases where timestamps might be invalid
                if (diffMs < 0) return '-';

                const diffMins = Math.floor(diffMs / 60000);
                const hours = Math.floor(diffMins / 60);
                const mins = diffMins % 60;
                
                // Format: "1h 30m" or "45m"
                if (hours > 0) return `${hours}h ${mins}m`;
                return `${mins}m`;
            }
            return '-';
        };

        // Helper Hook: Calculate duration since task started
        // MODIFIED: Updated to show HH:MM:SS live timing
        const useLiveTaskDuration = (task) => {
            const [duration, setDuration] = useState('');
            
            useEffect(() => {
                if (task.status !== KANBAN_STATUS.IN_PROGRESS || !task.progressTimestamp) {
                    setDuration('');
                    return;
                }

                const calculate = () => {
                    const start = task.progressTimestamp.toDate ? task.progressTimestamp.toDate() : new Date(task.progressTimestamp);
                    const now = new Date();
                    const diffMs = Math.max(0, now - start); // Ensure no negative time
                    
                    const seconds = Math.floor((diffMs / 1000) % 60);
                    const minutes = Math.floor((diffMs / (1000 * 60)) % 60);
                    const hours = Math.floor((diffMs / (1000 * 60 * 60)));

                    // Format with leading zeros (HH:MM:SS)
                    const formatted = [
                        hours.toString().padStart(2, '0'),
                        minutes.toString().padStart(2, '0'),
                        seconds.toString().padStart(2, '0')
                    ].join(':');

                    setDuration(formatted);
                };

                calculate();
                const timer = setInterval(calculate, 1000); // Update every second
                return () => clearInterval(timer);
            }, [task]);

            return duration;
        };

        // Helper Hook: Static duration for completed phases
        const useTaskDuration = (task) => {
            if (task.status === KANBAN_STATUS.AUDITING && task.progressTimestamp && task.workCompletedTimestamp) {
                const start = task.progressTimestamp.toDate();
                const end = task.workCompletedTimestamp.toDate();
                const diffMins = Math.floor((end - start) / 60000);
                const hours = Math.floor(diffMins / 60);
                const mins = diffMins % 60;
                return `${hours}h ${mins}m`; // MODIFIED: Removed "(Work Time)" suffix
            }
            return null;
        };

        // Sub-Component: Filter Select
        const FilterSelect = memo(({ label, name, value, onChange, options, disabled, simple = false }) => (
            <div className={simple ? "" : "flex-1 w-full"}>
                {!simple && <label htmlFor={`${name}-filter`} className="block text-sm font-medium text-slate-400 mb-1">{label}</label>}
                <select id={`${name}-filter`} name={name} value={value} onChange={onChange} className={`input ${simple ? 'text-sm' : 'w-full'}`} disabled={disabled}>
                    <option value="">{`All ${label || name}s`}</option>
                    {options.map((opt, idx) => {
                        const isObject = typeof opt === 'object' && opt !== null;
                        const val = isObject ? opt.id : opt;
                        const text = isObject ? (opt.text || opt.name) : opt;
                        return <option key={idx} value={val}>{text}</option>;
                    })}
                </select>
            </div>
        ));

        // Sub-Component: Task Audit Controls
        const TaskAuditControls = ({ task, onTaskAction, isProcessing, userProfile }) => {
            const [score, setScore] = useState('');
            const [comment, setComment] = useState(task.auditComment || '');
            
            // Allow Admin or the Shop Manager of that shop to audit
            const canAudit = userProfile.role === 'Admin' || userProfile.role === 'CEO' || (userProfile.role === 'Shop Manager');
            
            if (!canAudit) return null;
            
            return (
                <div className="space-y-3 bg-slate-900/50 p-3 rounded-lg border border-slate-700/50">
                    <p className="text-xs font-bold text-blue-300 uppercase">Manager Review</p>
                    <textarea 
                        value={comment} 
                        onChange={(e) => setComment(e.target.value)} 
                        className="input text-sm p-2" 
                        rows="2" 
                        placeholder="Feedback or instructions..." 
                    />
                    <select value={score} onChange={(e) => setScore(e.target.value)} className="input text-sm p-2">
                        <option value="">Select Score / Result...</option>
                        {["100% - Excellent", "90% - Good", "70% - Acceptable", "50% - Needs Improvement", "Rejected"].map(s => <option key={s} value={s}>{s}</option>)}
                    </select>
                    <div className="flex justify-end gap-2"> 
                        <Button 
                            onClick={() => onTaskAction('move', task, { newStatus: KANBAN_STATUS.IN_PROGRESS, comment })} 
                            variant="secondary"
                            disabled={!comment || isProcessing}
                            className="text-xs"
                        >
                            Return for Rework
                        </Button>
                        <Button 
                            onClick={() => onTaskAction('approve', task, { score, comment })} 
                            variant="success"
                            disabled={isProcessing || !score}
                            className="text-xs"
                        >
                            {isProcessing ? 'Processing...' : 'Approve & Close'}
                        </Button>
                    </div>
                </div>
            );
        };

        // Sub-Component: Task Card
        // MODIFIED: Accepts 'onDelete' prop to trigger confirmation modal
        const TaskCard = memo(({ task, onEdit, onTaskAction, onDelete, processingTaskIds, userProfile }) => {
            const staticDuration = useTaskDuration(task);
            const liveDuration = useLiveTaskDuration(task);
            const isProcessing = processingTaskIds.has(task.id);

            // NEW: Custom Date Formatter for Card (dd-mm-yy | hh:mm am/pm)
            const formatCardDate = (timestamp) => {
                if (!timestamp) return '';
                const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
                const d = String(date.getDate()).padStart(2, '0');
                const m = String(date.getMonth() + 1).padStart(2, '0');
                const y = String(date.getFullYear()).slice(-2);
                const time = date.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: true }).toLowerCase();
                return `${d}-${m}-${y} | ${time}`;
            };

            // MODIFIED: InfoRow now displays the label text explicitly
            const InfoRow = ({ icon, label, value }) => (
                <div className="flex items-center gap-2" title={label}>
                    <span className="w-4 text-center flex-shrink-0 opacity-70">{icon}</span>
                    <span className="truncate text-slate-300">
                        <span className="text-slate-500 font-bold mr-1">{label}:</span>
                        {value}
                    </span>
                </div>
            );

            const handleComplete = () => {
                const newStatus = KANBAN_STATUS.AUDITING; 
                onTaskAction('move', task, { newStatus });
            };

            return (
                <div className="bg-slate-700 border border-slate-600 p-4 rounded-lg shadow-sm group mb-4 hover:border-blue-500/50 transition-all">
                    <div className="flex justify-between items-start mb-2">
                        <div 
                            onClick={() => onEdit(task)} 
                            className="font-semibold text-slate-100 flex-grow pr-2 cursor-pointer hover:text-blue-400 transition-colors"
                        >
                            {task.text}
                        </div>
                        {(userProfile.role === 'Admin' || userProfile.role === 'CEO' || userProfile.id === task.creatorUid) && (
                            <button 
                                // FIX: Use onDelete to trigger modal instead of immediate action
                                onClick={() => onDelete(task)} 
                                className="text-slate-500 hover:text-red-500 transition-colors px-1"
                                title="Delete Task"
                            >
                                <i className="fas fa-times"></i>
                            </button>
                        )}
                    </div>

                    <div className="text-xs text-slate-400 space-y-1.5 border-t border-slate-600/50 pt-2">
                        {task.kpiText && <InfoRow icon={<ICONS.KPI className="text-purple-400" />} label='KPI' value={<span className="font-semibold text-purple-400">{task.kpiText}</span>} />}
                        {task.shopName && <InfoRow icon="" label='Shop' value={task.shopName} />}
                        {task.staffName && <InfoRow icon="" label='Name' value={task.staffName} />}
                        
                        {task.taskTimestamp && <InfoRow icon="" label='Date' value={formatCardDate(task.taskTimestamp)} />}
                        
                        {/* Timers */}
                        {staticDuration && <InfoRow icon="" label='Work Time' value={staticDuration} />}
                        {liveDuration && <InfoRow icon="" label='Work Time' value={<span className="font-bold text-yellow-400 animate-pulse">{liveDuration}</span>} />}
                        
                        {/* Audit Comments */}
                        {task.auditComment && (
                            <div className="mt-2 p-2 bg-yellow-500/10 border border-yellow-500/20 rounded text-yellow-200 italic">
                                "{task.auditComment}"
                            </div>
                        )}
                    </div>

                    {/* Actions Footer */}
                    <div className="mt-3 pt-3 border-t border-slate-600 flex justify-end gap-2">
                        {task.status === KANBAN_STATUS.AUDITING ? (
                            <TaskAuditControls task={task} onTaskAction={onTaskAction} isProcessing={isProcessing} userProfile={userProfile} />
                        ) : (
                            <>
                                {task.status === KANBAN_STATUS.TODO && (
                                    <button 
                                        onClick={() => onTaskAction('move', task, { newStatus: KANBAN_STATUS.IN_PROGRESS })} 
                                        className="px-3 py-1 text-xs bg-blue-600 text-white rounded hover:bg-blue-500 transition-colors"
                                        disabled={isProcessing}
                                    >
                                        Start Work
                                    </button>
                                )}
                                {task.status === KANBAN_STATUS.IN_PROGRESS && (
                                    <>
                                        <button 
                                            onClick={() => onTaskAction('move', task, { newStatus: KANBAN_STATUS.TODO })} 
                                            className="px-3 py-1 text-xs bg-slate-600 text-slate-200 rounded hover:bg-slate-500 transition-colors"
                                            disabled={isProcessing}
                                        >
                                            Stop
                                        </button>
                                        <button 
                                            onClick={handleComplete} 
                                            className="px-3 py-1 text-xs bg-green-600 text-white rounded hover:bg-green-500 transition-colors font-bold"
                                            disabled={isProcessing}
                                        >
                                            Submit for Audit
                                        </button>
                                    </>
                                )}
                            </>
                        )}
                    </div>
                </div>
            );
        });

        // --- INSERTED MISSING COMPONENT: Task Modal ---
        const TaskModal = ({ isOpen, onClose, onSave, task, userProfile, kpis, employees }) => {
            const { shops } = useAppData(); // Use global shops data
            const [formData, setFormData] = useState({});
            
            // Determine allowed shops for the dropdown
            const availableShops = useMemo(() => {
                if (!shops) return [];
                if (userProfile.role === 'Admin' || userProfile.role === 'CEO') return shops;
                if (userProfile.role === 'Shop Manager') {
                    const myShops = Array.isArray(userProfile.shop) ? userProfile.shop : [userProfile.shop];
                    return shops.filter(s => myShops.includes(s.name));
                }
                return []; 
            }, [shops, userProfile]);

            // Filter employees based on selected shop
            const availableEmployees = useMemo(() => {
                if (!employees) return [];
                // If staff, not relevant as dropdown is hidden/disabled
                if (userProfile.role === 'Staff') return [];

                let filtered = employees.filter(e => e.status === 'Active');
                
                // Filter by selected shop if any
                if (formData.shopName) {
                    filtered = filtered.filter(e => {
                        const empShops = Array.isArray(e.shop) ? e.shop : [e.shop];
                        return empShops.includes(formData.shopName);
                    });
                } else if (userProfile.role === 'Shop Manager') {
                     // If no shop selected yet, limit to managed shops
                     const myShops = Array.isArray(userProfile.shop) ? userProfile.shop : [userProfile.shop];
                     filtered = filtered.filter(e => {
                        const empShops = Array.isArray(e.shop) ? e.shop : [e.shop];
                        return empShops.some(s => myShops.includes(s));
                     });
                }
                return filtered;
            }, [employees, userProfile, formData.shopName]);

            useEffect(() => {
                if (isOpen) {
                    const now = new Date();
                    // Default or extract Date/Time
                    let initialDate = now.toISOString().slice(0, 10);
                    let initialTime = now.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' });
                    
                    if (task && task.taskTimestamp) {
                        const d = task.taskTimestamp.toDate ? task.taskTimestamp.toDate() : new Date(task.taskTimestamp);
                        initialDate = d.toISOString().slice(0, 10);
                        initialTime = d.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' });
                    }

                    // Default Shop
                    let initialShop = '';
                    if (task) {
                        initialShop = task.shopName || '';
                    } else if (userProfile.role === 'Shop Manager') {
                         const myShops = Array.isArray(userProfile.shop) ? userProfile.shop : [userProfile.shop];
                         if (myShops.length === 1) initialShop = myShops[0];
                    } else if (userProfile.role === 'Staff') {
                         initialShop = Array.isArray(userProfile.shop) ? userProfile.shop[0] : userProfile.shop;
                    }

                    setFormData(task ? { 
                        ...task,
                        date: initialDate,
                        time: initialTime,
                        shopName: initialShop
                    } : {
                        text: '',
                        kpiId: '',
                        staffId: userProfile.role === 'Staff' ? userProfile.id : '',
                        date: initialDate,
                        time: initialTime,
                        shopName: initialShop
                    });
                }
            }, [isOpen, task, userProfile]);

            const handleChange = (e) => {
                const { name, value } = e.target;
                setFormData(prev => {
                    const next = { ...prev, [name]: value };
                    // If shop changes, reset staff selection (unless staff role)
                    if (name === 'shopName' && userProfile.role !== 'Staff') {
                        next.staffId = ''; 
                    }
                    return next;
                });
            };

            const handleSubmit = (e) => {
                e.preventDefault();
                // REVISED: Mandatory Check for KPI
                if (!formData.text || !formData.kpiId) {
                    alert("Please select a KPI and enter a task description.");
                    return;
                }
                
                // Enrich data before saving
                let staffName = '';
                
                if (userProfile.role === 'Staff') {
                    staffName = userProfile.name;
                } else if (formData.staffId) {
                    const emp = employees.find(e => e.id === formData.staffId);
                    if (emp) staffName = emp.name;
                }

                let kpiText = '';
                if (formData.kpiId) {
                    const kpi = kpis.find(k => k.id === formData.kpiId);
                    if (kpi) kpiText = kpi.name;
                }

                // Construct timestamp from inputs
                const taskDateTime = new Date(`${formData.date}T${formData.time}`);

                onSave({
                    ...formData,
                    staffName,
                    kpiText,
                    taskTimestamp: taskDateTime
                });
            };

            const canManage = userProfile.role !== 'Staff';

            return (
                <Modal isOpen={isOpen} onClose={onClose} maxWidth="max-w-lg">
                    <form onSubmit={handleSubmit} className="flex flex-col h-full overflow-hidden">
                        <ModalHeader title={task ? "Edit Task" : "Add New Task"} onClose={onClose} />
                        <ModalBody>
                            <div className="space-y-4">
                                {/* 1 & 2. Date & Time */}
                                <div className="grid grid-cols-2 gap-4">
                                    <div>
                                        <label className="text-sm font-medium text-slate-400">Date</label>
                                        <input type="date" name="date" value={formData.date || ''} onChange={handleChange} className="input" required />
                                    </div>
                                    <div>
                                        <label className="text-sm font-medium text-slate-400">Time</label>
                                        <input type="time" name="time" value={formData.time || ''} onChange={handleChange} className="input" required />
                                    </div>
                                </div>

                                {/* 3. Shop */}
                                <div>
                                    <label className="text-sm font-medium text-slate-400">Shop</label>
                                    {canManage ? (
                                        <select name="shopName" value={formData.shopName || ''} onChange={handleChange} className="select" required>
                                            <option value="">Select Shop</option>
                                            {availableShops.map(s => <option key={s.id} value={s.name}>{s.name}</option>)}
                                        </select>
                                    ) : (
                                        <input value={formData.shopName || ''} className="input" disabled />
                                    )}
                                </div>

                                {/* 4. Staff Name */}
                                {canManage && (
                                    <div>
                                        <label className="text-sm font-medium text-slate-400">Assign To (Staff Name)</label>
                                        <select name="staffId" value={formData.staffId || ''} onChange={handleChange} className="select" required disabled={!formData.shopName}>
                                            <option value="">Select Staff</option>
                                            {availableEmployees.map(e => <option key={e.id} value={e.id}>{e.name}</option>)}
                                        </select>
                                    </div>
                                )}

                                {/* 5. KPI - REVISED: REQUIRED FIELD */}
                                <div>
                                    <label className="text-sm font-medium text-slate-400">Link to KPI <span className="text-red-400">*</span></label>
                                    <select name="kpiId" value={formData.kpiId || ''} onChange={handleChange} className="select" required>
                                        <option value="">-- Select KPI --</option>
                                        {kpis && kpis.map(k => <option key={k.id} value={k.id}>{k.name}</option>)}
                                    </select>
                                </div>

                                {/* 6. Task Description */}
                                <div>
                                    <label className="text-sm font-medium text-slate-400">Task Description</label>
                                    <textarea name="text" value={formData.text || ''} onChange={handleChange} className="input" rows="3" required placeholder="What needs to be done?" />
                                </div>
                            </div>
                        </ModalBody>
                        <ModalFooter>
                            <Button variant="secondary" onClick={onClose}>Cancel</Button>
                            <Button type="submit" variant="primary">{task ? "Update" : "Create"}</Button>
                        </ModalFooter>
                    </form>
                </Modal>
            );
        };

        // --- INSERTED MISSING COMPONENT: TaskKanbanTab ---
        const TaskKanbanTab = ({ userProfile }) => {
            const { db } = useFirebase();
            const { kpis, employees, shops } = useAppData(); 
            const { collection, query, where, onSnapshot, orderBy, addDoc, updateDoc, deleteDoc, doc, serverTimestamp, limit } = window.firebaseSDK;

            const [tasks, setTasks] = useState([]);
            const [loading, setLoading] = useState(true);
            const [processingTaskIds, setProcessingTaskIds] = useState(new Set());
            
            // Modals
            const [isModalOpen, setIsModalOpen] = useState(false);
            const [editingTask, setEditingTask] = useState(null);
            const [taskToDelete, setTaskToDelete] = useState(null);

            // Filters
            const [filterStaff, setFilterStaff] = useState('');
            const [filterKpi, setFilterKpi] = useState('');
            const [filterShop, setFilterShop] = useState(''); 
            const [filterManagerOnly, setFilterManagerOnly] = useState(false);
            
            // NEW: Month Filter State (Defaults to Current Month)
            const [filterMonth, setFilterMonth] = useState(new Date().toISOString().slice(0, 7));

            // NEW: Pagination State for History
            const [currentPage, setCurrentPage] = useState(1);
            const itemsPerPage = 50;

            // --- NEW: AUTO-REJECT LOGIC FOR OVERDUE TASKS (>10 Hours) ---
            useEffect(() => {
                if (!tasks || tasks.length === 0 || !db) return;

                const checkAndRejectOverdue = async () => {
                    const now = new Date();
                    const { updateDoc, doc, serverTimestamp } = window.firebaseSDK;

                    // Filter for tasks that are IN_PROGRESS and started > 10 hours ago
                    const overdueTasks = tasks.filter(t => {
                        if (t.status !== KANBAN_STATUS.IN_PROGRESS || !t.progressTimestamp) return false;
                        
                        const start = t.progressTimestamp.toDate ? t.progressTimestamp.toDate() : new Date(t.progressTimestamp);
                        const diffMs = now - start;
                        const diffHours = diffMs / (1000 * 60 * 60);
                        
                        return diffHours > 10;
                    });

                    if (overdueTasks.length > 0) {
                        console.log(`[Auto-Bot] Rejecting ${overdueTasks.length} overdue tasks (>10h)...`);
                        
                        // Process rejections
                        await Promise.all(overdueTasks.map(t => 
                            updateDoc(doc(db, 'tasks', t.id), {
                                status: KANBAN_STATUS.DONE, // Move to Done/History
                                completedTimestamp: serverTimestamp(),
                                auditScore: 'Rejected',
                                // MODIFIED: Simplified comment as requested
                                auditComment: 'Task over Due Time!',
                                auditorName: 'System Auto-Bot'
                            }).catch(err => console.error("Failed to auto-reject task:", t.id, err))
                        ));
                    }
                };

                // Run check immediately on load/update, then every minute
                checkAndRejectOverdue();
                const interval = setInterval(checkAndRejectOverdue, 60000); 
                return () => clearInterval(interval);
            }, [tasks, db]); // Re-run when tasks list updates to catch new overdues
            // --- END AUTO-REJECT LOGIC ---

            const employeesForFilter = useMemo(() => {
                if (!employees) return [];
                if (!filterShop) return employees.filter(e => e.status === 'Active');
                return employees.filter(e => {
                    const empShops = Array.isArray(e.shop) ? e.shop : [e.shop];
                    return empShops.includes(filterShop) && e.status === 'Active';
                });
            }, [employees, filterShop]);

            const kpisForFilter = useMemo(() => {
                if (!kpis) return [];
                if (filterStaff) {
                    const staff = employees.find(e => e.id === filterStaff);
                    if (staff && staff.position) {
                        return kpis.filter(k => Array.isArray(k.assignedPositions) && k.assignedPositions.includes(staff.position));
                    }
                    return []; 
                }
                return kpis; 
            }, [kpis, employees, filterStaff]);

            useEffect(() => {
                setFilterStaff('');
            }, [filterShop]);

            useEffect(() => {
                setFilterKpi('');
            }, [filterStaff]);

            // Data Fetching
            useEffect(() => {
                if (!db || !userProfile) return;
                setLoading(true);

                // MODIFIED: Calculate Date Range for the selected month
                const [y, m] = filterMonth.split('-').map(Number);
                const startOfMonth = new Date(y, m - 1, 1);
                const endOfMonth = new Date(y, m, 0, 23, 59, 59, 999);

                // MODIFIED: Apply Date Range Filter to the Base Query
                // Note: We remove the 'limit(500)' because the month filter acts as a natural pagination/limit.
                let q = query(
                    collection(db, 'tasks'), 
                    where('taskTimestamp', '>=', startOfMonth),
                    where('taskTimestamp', '<=', endOfMonth),
                    orderBy('taskTimestamp', 'desc')
                );

                if (userProfile.role === 'Staff') {
                    q = query(q, where('staffId', '==', userProfile.id));
                } else if (userProfile.role === 'Shop Manager') {
                    const myShops = Array.isArray(userProfile.shop) ? userProfile.shop : [userProfile.shop];
                    if (myShops.length > 0) {
                        q = query(q, where('shopName', 'in', myShops));
                    } else {
                        q = query(q, where('shopName', '==', 'null'));
                    }
                }
                
                const unsubscribe = onSnapshot(q, (snapshot) => {
                    const items = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    setTasks(items);
                    setLoading(false);
                }, (error) => {
                    console.error("Error fetching tasks:", error);
                    setLoading(false);
                });

                return () => unsubscribe();
            }, [db, userProfile, filterMonth]); // Added filterMonth dependency

            // Filter Logic
            const filteredTasks = useMemo(() => {
                return tasks.filter(t => {
                    if (filterStaff && t.staffId !== filterStaff) return false;
                    if (filterKpi && t.kpiId !== filterKpi) return false;
                    if (filterShop && t.shopName !== filterShop) return false;
                    if (filterManagerOnly) {
                        const staff = employees.find(e => e.id === t.staffId);
                        if (!staff || staff.role !== 'Shop Manager') return false;
                    }
                    return true;
                });
            }, [tasks, filterStaff, filterKpi, filterShop, filterManagerOnly, employees]);

            // Columns
            const columns = {
                [KANBAN_STATUS.TODO]: filteredTasks.filter(t => t.status === KANBAN_STATUS.TODO),
                [KANBAN_STATUS.IN_PROGRESS]: filteredTasks.filter(t => t.status === KANBAN_STATUS.IN_PROGRESS),
                [KANBAN_STATUS.AUDITING]: filteredTasks.filter(t => t.status === KANBAN_STATUS.AUDITING),
                [KANBAN_STATUS.DONE]: filteredTasks.filter(t => t.status === KANBAN_STATUS.DONE),
            };

            // NEW: Pagination Logic
            const completedTasks = columns[KANBAN_STATUS.DONE];
            const totalPages = Math.ceil(completedTasks.length / itemsPerPage);
            const paginatedHistory = useMemo(() => {
                const start = (currentPage - 1) * itemsPerPage;
                return completedTasks.slice(start, start + itemsPerPage);
            }, [completedTasks, currentPage]);

            // Reset page when filters change (tasks array changes)
            useEffect(() => {
                setCurrentPage(1);
            }, [tasks.length, filterShop, filterStaff]);

            // Actions
            const handleTaskAction = async (action, task, payload) => {
                setProcessingTaskIds(prev => new Set(prev).add(task.id));
                try {
                    const taskRef = doc(db, 'tasks', task.id);
                    const updateData = {};

                    if (action === 'move') {
                        updateData.status = payload.newStatus;
                        if (payload.newStatus === KANBAN_STATUS.IN_PROGRESS) updateData.progressTimestamp = serverTimestamp();
                        if (payload.newStatus === KANBAN_STATUS.AUDITING) updateData.workCompletedTimestamp = serverTimestamp();
                        if (payload.comment) updateData.auditComment = payload.comment; 
                    } 
                    else if (action === 'approve') {
                        updateData.status = KANBAN_STATUS.DONE;
                        updateData.completedTimestamp = serverTimestamp();
                        updateData.auditScore = payload.score;
                        updateData.auditComment = payload.comment;
                        updateData.auditorName = userProfile.name;
                    }

                    await updateDoc(taskRef, updateData);
                } catch (error) {
                    console.error("Task action failed:", error);
                    alert("Failed to update task.");
                } finally {
                    setProcessingTaskIds(prev => { const next = new Set(prev); next.delete(task.id); return next; });
                }
            };

            const handleSaveTask = async (formData) => {
                try {
                    if (editingTask) {
                        await updateDoc(doc(db, 'tasks', editingTask.id), formData);
                    } else {
                        await addDoc(collection(db, 'tasks'), {
                            ...formData,
                            status: KANBAN_STATUS.TODO,
                            taskTimestamp: formData.taskTimestamp || serverTimestamp(), 
                            creatorUid: userProfile.id
                        });
                    }
                    setIsModalOpen(false);
                    setEditingTask(null);
                } catch (error) {
                    console.error("Error saving task:", error);
                    alert("Failed to save task.");
                }
            };

            const handleDeleteTask = async () => {
                if (!taskToDelete) return;
                try {
                    await deleteDoc(doc(db, 'tasks', taskToDelete.id));
                    setTaskToDelete(null);
                } catch (error) {
                    console.error("Error deleting task:", error);
                }
            };

            const canManage = userProfile.role !== 'Staff';
            const isAdminOrCEO = userProfile.role === 'Admin' || userProfile.role === 'CEO';

            return (
                <div className="flex flex-col space-y-6">
                    <div className="flex flex-wrap gap-4 justify-between items-center mb-0 bg-slate-800/50 p-4 rounded-xl border border-slate-700">
                        <div className="flex flex-wrap gap-4 items-center flex-1">
                            {/* NEW: Month Filter Input */}
                            <input 
                                type="month" 
                                value={filterMonth} 
                                onChange={e => setFilterMonth(e.target.value)} 
                                className="input w-auto text-sm font-medium"
                                title="Filter by Creation Month"
                            />

                            <ShopFilterSelect 
                                userProfile={userProfile}
                                shops={shops}
                                selectedShop={filterShop}
                                onChange={e => setFilterShop(e.target.value)}
                            />

                            {isAdminOrCEO && (
                                <label className={`flex items-center gap-2 cursor-pointer px-3 py-1.5 rounded-lg border transition-colors ${filterManagerOnly ? 'bg-blue-600 border-blue-500 text-white shadow-md' : 'bg-slate-700/50 border-slate-600 text-slate-300 hover:bg-slate-700'}`}>
                                    <input 
                                        type="checkbox" 
                                        checked={filterManagerOnly} 
                                        onChange={e => setFilterManagerOnly(e.target.checked)} 
                                        className="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500 bg-slate-600"
                                    />
                                    <span className="text-sm font-medium">Managers Only</span>
                                </label>
                            )}

                            {canManage && (
                                <select value={filterStaff} onChange={e => setFilterStaff(e.target.value)} className="select text-sm w-auto">
                                    <option value="">All Staff</option>
                                    {employeesForFilter.map(e => <option key={e.id} value={e.id}>{e.name}</option>)}
                                </select>
                            )}
                            <select value={filterKpi} onChange={e => setFilterKpi(e.target.value)} className="select text-sm w-auto">
                                <option value="">All KPIs</option>
                                {kpisForFilter.map(k => <option key={k.id} value={k.id}>{k.name}</option>)}
                            </select>
                        </div>
                        <Button variant="primary" icon="fa-plus" onClick={() => { setEditingTask(null); setIsModalOpen(true); }}>
                            New Task
                        </Button>
                    </div>

                    {loading ? (
                        <div className="flex justify-center items-center py-20"><i className="fas fa-spinner fa-spin text-3xl text-blue-500"></i></div>
                    ) : (
                        <>
                            <div className="overflow-x-auto pb-2">
                                <div className="flex gap-4 min-w-[900px]">
                                    <KanbanColumn title="To Do" status={KANBAN_STATUS.TODO} tasks={columns[KANBAN_STATUS.TODO]} color="slate" userProfile={userProfile} onEdit={(t) => { setEditingTask(t); setIsModalOpen(true); }} onDelete={setTaskToDelete} onTaskAction={handleTaskAction} processingTaskIds={processingTaskIds} />
                                    <KanbanColumn title="In Progress" status={KANBAN_STATUS.IN_PROGRESS} tasks={columns[KANBAN_STATUS.IN_PROGRESS]} color="blue" userProfile={userProfile} onEdit={(t) => { setEditingTask(t); setIsModalOpen(true); }} onDelete={setTaskToDelete} onTaskAction={handleTaskAction} processingTaskIds={processingTaskIds} />
                                    <KanbanColumn title="Auditing" status={KANBAN_STATUS.AUDITING} tasks={columns[KANBAN_STATUS.AUDITING]} color="yellow" userProfile={userProfile} onEdit={(t) => { setEditingTask(t); setIsModalOpen(true); }} onDelete={setTaskToDelete} onTaskAction={handleTaskAction} processingTaskIds={processingTaskIds} />
                                </div>
                            </div>

                            <Card>
                                <div className="flex justify-between items-center mb-4">
                                    <h3 className="text-lg font-bold text-slate-100 flex items-center gap-2">
                                        <i className="fas fa-history text-green-400"></i> Completed Tasks History
                                    </h3>
                                    <div className="text-xs text-slate-400 bg-slate-800 px-3 py-1 rounded-full border border-slate-700 font-mono">
                                        Total: {completedTasks.length}
                                    </div>
                                </div>
                                <div className="overflow-x-auto">
                                    <table className="min-w-full divide-y divide-slate-700">
                                        <thead className="bg-slate-900/50">
                                            <tr>
                                                <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Completed Date</th>
                                                <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Shop</th>
                                                <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Staff</th>
                                                <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">KPI</th>
                                                <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Task Description</th>
                                                <th className="px-4 py-3 text-center text-xs font-semibold text-slate-400 uppercase">Result</th>
                                                <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Auditor</th>
                                                {(userProfile.role === 'Admin' || userProfile.role === 'CEO') && (
                                                    <th className="px-4 py-3 text-center text-xs font-semibold text-slate-400 uppercase">Actions</th>
                                                )}
                                            </tr>
                                        </thead>
                                        <tbody className="divide-y divide-slate-700">
                                            {/* MODIFIED: Render paginated list with reordered columns */}
                                            {paginatedHistory.map(task => (
                                                <tr key={task.id} className="hover:bg-slate-700/50 transition-colors">
                                                    <td className="px-4 py-3 text-sm text-slate-300 whitespace-nowrap">{formatFullDateTime(task.completedTimestamp)}</td>
                                                    <td className="px-4 py-3 text-sm text-slate-400">{task.shopName}</td>
                                                    <td className="px-4 py-3 text-sm text-slate-300">{task.staffName}</td>
                                                    <td className="px-4 py-3 text-sm text-slate-300">{task.kpiText || '-'}</td>
                                                    <td className="px-4 py-3 text-sm text-slate-200 font-medium">{task.text}</td>
                                                    <td className="px-4 py-3 text-sm text-center">
                                                        <div className="flex flex-col items-center">
                                                            <span className={`px-2 py-1 text-xs font-bold rounded-full border ${
                                                                task.auditScore?.includes('100%') ? 'bg-green-500/10 text-green-400 border-green-500/20' :
                                                                task.auditScore?.includes('Rejected') ? 'bg-red-500/10 text-red-400 border-red-500/20' : 
                                                                'bg-blue-500/10 text-blue-400 border-blue-500/20'
                                                            }`}>
                                                                {task.auditScore || 'Approved'}
                                                            </span>
                                                            {/* Moved Audit Comment here as subtitle since column was removed */}
                                                            {task.auditComment && (
                                                                <span className="text-[10px] text-slate-500 mt-1 italic max-w-[150px] truncate" title={task.auditComment}>
                                                                    "{task.auditComment}"
                                                                </span>
                                                            )}
                                                        </div>
                                                    </td>
                                                    <td className="px-4 py-3 text-sm text-slate-400">{task.auditorName || 'System'}</td>
                                                    {(userProfile.role === 'Admin' || userProfile.role === 'CEO') && (
                                                        <td className="px-4 py-3 text-center whitespace-nowrap">
                                                            <Button 
                                                                variant="icon-delete" 
                                                                icon="fa-trash" 
                                                                onClick={() => setTaskToDelete(task)} 
                                                                title="Delete History Record" 
                                                            />
                                                        </td>
                                                    )}
                                                </tr>
                                            ))}
                                            {completedTasks.length === 0 && (
                                                <tr><td colSpan="8" className="px-4 py-8 text-center text-slate-500 italic">No completed tasks found for this month.</td></tr>
                                            )}
                                        </tbody>
                                    </table>
                                </div>
                                
                                {/* NEW: Pagination Controls */}
                                {totalPages > 1 && (
                                    <div className="flex justify-between items-center mt-4 pt-4 border-t border-slate-700">
                                        <div className="text-xs text-slate-400">
                                            Showing {(currentPage - 1) * itemsPerPage + 1} to {Math.min(currentPage * itemsPerPage, completedTasks.length)} of {completedTasks.length} entries
                                        </div>
                                        <div className="flex gap-2">
                                            <Button 
                                                variant="secondary" 
                                                onClick={() => setCurrentPage(p => Math.max(1, p - 1))}
                                                disabled={currentPage === 1}
                                                className="text-xs py-1 px-3 h-8"
                                            >
                                                Previous
                                            </Button>
                                            <div className="flex items-center justify-center bg-slate-800 rounded px-3 text-sm font-bold text-slate-300 border border-slate-700">
                                                Page {currentPage} of {totalPages}
                                            </div>
                                            <Button 
                                                variant="secondary" 
                                                onClick={() => setCurrentPage(p => Math.min(totalPages, p + 1))}
                                                disabled={currentPage === totalPages}
                                                className="text-xs py-1 px-3 h-8"
                                            >
                                                Next
                                            </Button>
                                        </div>
                                    </div>
                                )}
                            </Card>
                        </>
                    )}

                    <TaskModal isOpen={isModalOpen} onClose={() => setIsModalOpen(false)} onSave={handleSaveTask} task={editingTask} userProfile={userProfile} kpis={kpis} employees={employees} />
                    <ConfirmationModal isOpen={!!taskToDelete} onClose={() => setTaskToDelete(null)} onConfirm={handleDeleteTask} title="Delete Task" message="Are you sure you want to delete this task? This action cannot be undone." />
                </div>
            );
        };

        const KanbanColumn = ({ title, status, tasks, color, userProfile, onEdit, onDelete, onTaskAction, processingTaskIds }) => (
            <div className={`flex-1 bg-slate-800/30 rounded-xl border border-slate-700/50 flex flex-col min-h-[500px]`}>
                <div className={`p-3 border-b border-slate-700/50 flex justify-between items-center bg-${color}-900/20 rounded-t-xl`}>
                    <h3 className={`font-bold text-${color}-400 uppercase text-xs tracking-wider`}>{title}</h3>
                    <span className="bg-slate-700 text-slate-300 text-xs px-2 py-0.5 rounded-full">{tasks.length}</span>
                </div>
                <div className="p-2 flex-1 overflow-y-auto space-y-2 custom-scrollbar">
                    {tasks.map(task => (
                        <TaskCard 
                            key={task.id} 
                            task={task} 
                            onEdit={onEdit} 
                            onDelete={onDelete}
                            onTaskAction={onTaskAction}
                            processingTaskIds={processingTaskIds}
                            userProfile={userProfile}
                        />
                    ))}
                </div>
            </div>
        );

        // --- NEW: MEETING ROOM COMPONENTS ---

        // NEW: Modal for responding to an invitation
        const MeetingResponseModal = ({ isOpen, onClose, onConfirm, actionType }) => {
            const [reason, setReason] = useState('');

            useEffect(() => {
                if (isOpen) setReason('');
            }, [isOpen]);

            const handleSubmit = (e) => {
                e.preventDefault();
                onConfirm(actionType, reason);
            };

            if (!isOpen) return null;

            const isReject = actionType === 'rejected';

            return (
                <Modal isOpen={isOpen} onClose={onClose} maxWidth="max-w-md">
                    <form onSubmit={handleSubmit}>
                        <ModalHeader title={isReject ? "Decline Invitation" : "Accept Invitation"} onClose={onClose} />
                        <ModalBody>
                            <div className="space-y-4">
                                <p className="text-slate-300">
                                    {isReject 
                                        ? "Are you sure you want to decline this meeting? Please provide a reason." 
                                        : "Confirm your attendance for this meeting."}
                                </p>
                                <div>
                                    <label className="text-sm font-medium text-slate-400">
                                        {isReject ? "Reason for Rejection (Required)" : "Note (Optional)"}
                                    </label>
                                    <textarea 
                                        className="input" 
                                        rows="3" 
                                        value={reason} 
                                        onChange={(e) => setReason(e.target.value)}
                                        placeholder={isReject ? "e.g., Conflicting schedule, Sick leave..." : "e.g., I might be 5 mins late..."}
                                        required={isReject}
                                    ></textarea>
                                </div>
                            </div>
                        </ModalBody>
                        <ModalFooter>
                            <Button variant="secondary" onClick={onClose}>Cancel</Button>
                            <Button 
                                type="submit" 
                                variant={isReject ? 'danger' : 'success'}
                                disabled={isReject && !reason.trim()}
                            >
                                {isReject ? "Decline" : "Confirm Attendance"}
                            </Button>
                        </ModalFooter>
                    </form>
                </Modal>
            );
        };

        // --- NEW FEATURE: PENDING MEETING ALERT COMPONENTS ---
        
        // Sub-component for individual item logic in the alert list
        const PendingMeetingItem = ({ meeting, onRespond }) => {
            const [isRejecting, setIsRejecting] = useState(false);
            const [reason, setReason] = useState('');

            const handleRejectSubmit = () => {
                if (!reason.trim()) return;
                onRespond(meeting, 'rejected', reason);
            };

            return (
                <div className="p-4 border-b border-slate-700 bg-slate-800/30 hover:bg-slate-800/80 transition-colors first:rounded-t-lg last:rounded-b-lg last:border-b-0">
                    <div className="flex justify-between items-start mb-2">
                        <div>
                            <div className="flex items-center gap-2">
                                <i className="fas fa-calendar-check text-blue-400"></i>
                                <h4 className="font-bold text-white text-lg">{meeting.title}</h4>
                            </div>
                            <p className="text-sm text-slate-300 font-medium mt-1 ml-6">
                                {new Date(meeting.date).toLocaleDateString('en-GB', {weekday: 'short', day: 'numeric', month: 'short', year: 'numeric'})} 
                                <span className="mx-2 text-slate-600">|</span> 
                                <span className="text-yellow-400">{meeting.startTime} - {meeting.endTime}</span>
                            </p>
                        </div>
                        <div className="text-[10px] bg-slate-700 px-2 py-1 rounded text-slate-400 uppercase tracking-wider font-bold">
                            Host: {meeting.hostName?.split(' ')[0]}
                        </div>
                    </div>
                    
                    {meeting.location && (
                        <p className="text-xs text-slate-400 mb-3 ml-6">
                            <i className={`fas ${meeting.type === 'Online' ? 'fa-video' : 'fa-map-marker-alt'} mr-1 w-4 text-center`}></i> 
                            {meeting.location}
                        </p>
                    )}

                    {isRejecting ? (
                        <div className="mt-3 ml-6 bg-red-900/10 p-3 rounded-lg border border-red-900/30 animate-fade-in">
                            <label className="text-xs font-bold text-red-400 mb-1 block">Reason for declining:</label>
                            <textarea 
                                className="input text-sm w-full mb-2 bg-slate-900 border-red-900/30 focus:border-red-500" 
                                rows="2" 
                                value={reason} 
                                onChange={(e) => setReason(e.target.value)}
                                placeholder="e.g., Conflicting schedule..."
                                autoFocus
                            ></textarea>
                            <div className="flex gap-2 justify-end">
                                <button onClick={() => setIsRejecting(false)} className="text-xs text-slate-400 hover:text-white px-3 py-1">Cancel</button>
                                <Button variant="danger" onClick={handleRejectSubmit} disabled={!reason.trim()} className="py-1 px-3 text-xs">Confirm Decline</Button>
                            </div>
                        </div>
                    ) : (
                        <div className="flex gap-3 mt-4 ml-6">
                            <Button variant="success" onClick={() => onRespond(meeting, 'accepted')} className="flex-1 py-2 text-sm shadow-lg shadow-green-900/20" icon="fa-check">Accept</Button>
                            <Button variant="danger" onClick={() => setIsRejecting(true)} className="flex-1 py-2 text-sm shadow-lg shadow-red-900/20" icon="fa-times">Decline</Button>
                        </div>
                    )}
                </div>
            );
        };

        // --- NEW: SCANNER MODAL COMPONENT (Restored) ---
        const ScannerModal = ({ isOpen, onClose, onScan }) => {
            const scannerRef = useRef(null); 
            const onScanRef = useRef(onScan);

            useEffect(() => { onScanRef.current = onScan; }, [onScan]);

            useEffect(() => {
                if (isOpen && !scannerRef.current) {
                    const initScanner = async () => {
                        try {
                            if (!window.Html5Qrcode) {
                                await Utils.loadScript(Utils.LIBS.HTML5QR);
                            }
                            
                            const html5QrCode = new window.Html5Qrcode("reader");
                            scannerRef.current = html5QrCode;
                            html5QrCode.start({ facingMode: "environment" }, { fps: 10, qrbox: { width: 250, height: 250 } },
                                (decodedText) => { 
                                    html5QrCode.stop().then(() => { 
                                        scannerRef.current = null; 
                                        if (onScanRef.current) onScanRef.current(decodedText); 
                                    }).catch(console.error); 
                                },
                                () => {}
                            ).catch(err => { console.error("Scanner Error:", err); alert("Unable to start camera."); onClose(); });
                        } catch(e) { console.error(e); alert("Failed to load scanner library."); onClose(); }
                    };
                    
                    // Small delay to ensure modal DOM is ready
                    const timer = setTimeout(initScanner, 300);
                    return () => clearTimeout(timer);
                }
                return () => { if (scannerRef.current) scannerRef.current.stop().catch(console.warn); };
            }, [isOpen]); 

            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 z-50 bg-black flex flex-col items-center justify-center p-4">
                    <div className="w-full max-w-md bg-slate-900 rounded-2xl p-4 border border-slate-700 relative">
                        <button onClick={onClose} className="absolute top-4 right-4 text-white text-xl z-10 bg-slate-800 rounded-full w-8 h-8 flex items-center justify-center shadow-md"><i className="fas fa-times"></i></button>
                        <h3 className="text-center text-white font-bold mb-4">Scan Shop QR</h3>
                        <div id="reader" className="scanner-box bg-slate-800"></div>
                        <p className="text-center text-slate-400 text-sm mt-4">Point your camera at the QR Code</p>
                    </div>
                </div>
            );
        };
        // --- END REUSABLE UI COMPONENTS ---

        // --- START CUSTOM OPTIMIZATION HOOKS (NEW) ---
        
        // OPTIMIZATION 1: Centralized Shop Permission Logic
        // Main Modal Component for the Alert
        const PendingMeetingsModal = ({ isOpen, onClose, meetings, onRespond }) => {
            if (!isOpen || meetings.length === 0) return null;

            return (
                <Modal isOpen={isOpen} onClose={onClose} maxWidth="max-w-lg">
                    <div className="flex flex-col max-h-[80vh]">
                        <div className="p-5 border-b border-slate-700 bg-slate-800 flex justify-between items-center shrink-0">
                            <div className="flex items-center gap-3">
                                <div className="p-2 bg-yellow-500/10 rounded-lg text-yellow-400 animate-pulse">
                                    <i className="fas fa-bell"></i>
                                </div>
                                <div>
                                    <h3 className="text-xl font-bold text-white">Action Required</h3>
                                    <p className="text-xs text-slate-400">You have {meetings.length} pending invitation{meetings.length > 1 ? 's' : ''}</p>
                                </div>
                            </div>
                            <Button variant="icon-close" onClick={onClose} className="text-2xl p-1">&times;</Button>
                        </div>
                        
                        <div className="overflow-y-auto custom-scrollbar bg-slate-900/50 p-4 space-y-4">
                            {meetings.map(meeting => (
                                <PendingMeetingItem key={meeting.id} meeting={meeting} onRespond={onRespond} />
                            ))}
                        </div>
                        
                        <div className="p-4 bg-slate-800 border-t border-slate-700 shrink-0 flex justify-end">
                            <Button variant="secondary" onClick={onClose}>Remind Me Later</Button>
                        </div>
                    </div>
                </Modal>
            );
        };

        // --- NEW: Birthday Celebration Pop-up Component ---
        // FIX: Added 'onJoin' to the destructured props
        const BirthdayCelebrationModal = ({ isOpen, onClose, celebrants, onJoin }) => {
            if (!isOpen || !celebrants || celebrants.length === 0) return null;

            // FIX: Wraps the click handler to prevent propagation issues
            const handleJoin = (e) => {
                e.preventDefault(); // Prevent ghost clicks
                e.stopPropagation();
                if(onJoin) onJoin();
            };

            return (
                <Modal isOpen={isOpen} onClose={onClose} maxWidth="max-w-md">
                    <div className="relative overflow-hidden rounded-lg">
                        {/* Festive Background & Confetti Effect */}
                        <div className="absolute inset-0 bg-gradient-to-br from-slate-900 via-slate-800 to-slate-900 z-0"></div>
                        <div className="absolute top-0 right-0 w-64 h-64 bg-pink-500/10 rounded-full blur-3xl -mr-16 -mt-16 pointer-events-none"></div>
                        <div className="absolute bottom-0 left-0 w-48 h-48 bg-purple-500/10 rounded-full blur-3xl -ml-10 -mb-10 pointer-events-none"></div>
                        
                        {/* Content */}
                        <div className="relative z-10 p-8 text-center flex flex-col items-center">
                            <div className="w-24 h-24 bg-gradient-to-tr from-pink-500 to-purple-600 rounded-full flex items-center justify-center mb-6 shadow-lg shadow-pink-500/30 animate-bounce">
                                <i className="fas fa-birthday-cake text-4xl text-white"></i>
                            </div>
                            
                            <h2 className="text-3xl font-bold text-white mb-2 tracking-tight">Time to Celebrate!</h2>
                            <p className="text-slate-400 mb-8 text-sm">Today is a special day for your team.</p>

                            <div className="w-full space-y-3 mb-8">
                                {celebrants.map(emp => (
                                    <div key={emp.id} className="bg-slate-800/80 p-3 rounded-xl border border-slate-700/50 flex items-center gap-4 shadow-sm transform transition-transform hover:scale-105">
                                        {/* MODIFIED: Render Photo or Initials */}
                                        <div className="w-12 h-12 rounded-full bg-slate-700 flex items-center justify-center text-white font-bold text-lg border-2 border-pink-500/50 overflow-hidden flex-shrink-0">
                                            {emp.photo ? (
                                                <img src={emp.photo} alt={emp.name} className="w-full h-full object-cover" />
                                            ) : (
                                                emp.name.charAt(0)
                                            )}
                                        </div>
                                        <div className="text-left">
                                            <p className="font-bold text-white text-lg leading-none mb-1">{emp.name}</p>
                                            <p className="text-xs text-pink-400 font-bold uppercase tracking-wider">
                                                <i className="fas fa-star mr-1"></i> Happy Birthday!
                                            </p>
                                        </div>
                                    </div>
                                ))}
                            </div>

                            <Button 
                                onClick={handleJoin} 
                                // FIX: Removed complex hover/transform classes that might cause double-tap issues on mobile
                                className="w-full py-3.5 text-base font-bold bg-pink-600 text-white rounded-xl shadow-lg shadow-pink-900/20 active:opacity-90"
                            >
                                <i className="fas fa-glass-cheers mr-2"></i> Join the Celebration
                            </Button>
                        </div>
                    </div>
                </Modal>
            );
        };
        // --- END NEW FEATURE COMPONENTS ---

        // NEW: Modal to view attendee status list (For Host)
        const MeetingAttendeesModal = ({ isOpen, onClose, meeting, employees }) => {
            if (!isOpen || !meeting) return null;

            const responses = meeting.responses || {};
            const invitedIds = meeting.invitedStaffIds || [];

            // Map IDs to employee data and status
            const attendeeList = invitedIds.map(id => {
                const emp = employees.find(e => e.id === id);
                const response = responses[id] || { status: 'pending' };
                return {
                    id,
                    name: emp ? emp.name : 'Unknown Staff',
                    position: emp ? emp.position : '',
                    status: response.status,
                    reason: response.reason,
                    timestamp: response.timestamp
                };
            });

            const counts = attendeeList.reduce((acc, curr) => {
                acc[curr.status] = (acc[curr.status] || 0) + 1;
                return acc;
            }, {});

            return (
                <Modal isOpen={isOpen} onClose={onClose} maxWidth="max-w-2xl">
                    <ModalHeader title={`Attendance: ${meeting.title}`} onClose={onClose} />
                    <ModalBody>
                        <div className="flex gap-4 mb-6 border-b border-slate-700 pb-4">
                            <div className="text-center flex-1">
                                <span className="block text-2xl font-bold text-green-400">{counts.accepted || 0}</span>
                                <span className="text-xs text-slate-500 uppercase">Accepted</span>
                            </div>
                            <div className="text-center flex-1">
                                <span className="block text-2xl font-bold text-red-400">{counts.rejected || 0}</span>
                                <span className="text-xs text-slate-500 uppercase">Declined</span>
                            </div>
                            <div className="text-center flex-1">
                                <span className="block text-2xl font-bold text-yellow-400">{counts.pending || 0}</span>
                                <span className="text-xs text-slate-500 uppercase">Pending</span>
                            </div>
                        </div>
                        <div className="space-y-3 max-h-96 overflow-y-auto custom-scrollbar">
                            {attendeeList.map(att => (
                                <div key={att.id} className="flex items-start justify-between p-3 rounded-lg bg-slate-700/30 border border-slate-600/50">
                                    <div>
                                        <p className="font-bold text-slate-200">{att.name}</p>
                                        <p className="text-xs text-slate-400">{att.position}</p>
                                        {att.reason && (
                                            <div className="mt-2 text-xs bg-slate-800/50 p-2 rounded text-slate-300 italic border-l-2 border-slate-500">
                                                "{att.reason}"
                                            </div>
                                        )}
                                    </div>
                                    <span className={`px-2 py-1 text-xs font-bold rounded-full uppercase ${
                                        att.status === 'accepted' ? 'bg-green-900 text-green-300' :
                                        att.status === 'rejected' ? 'bg-red-900 text-red-300' :
                                        'bg-yellow-900 text-yellow-300'
                                    }`}>
                                        {att.status}
                                    </span>
                                </div>
                            ))}
                        </div>
                    </ModalBody>
                    <ModalFooter>
                        <Button variant="secondary" onClick={onClose}>Close</Button>
                    </ModalFooter>
                </Modal>
            );
        };

        // Sub-Component: Meeting Modal (Schedule)
        const MeetingModal = ({ isOpen, onClose, onSave, meeting, userProfile, employees, shops }) => {
            const [formData, setFormData] = useState({});
            // Local state for filtering staff list
            const [inviteFilterShop, setInviteFilterShop] = useState(''); 
            
            // Helper to determine available shops for the dropdown
            const availableShops = useMemo(() => {
                if (userProfile.role === 'Admin' || userProfile.role === 'CEO') return shops;
                if (userProfile.role === 'Shop Manager' && Array.isArray(userProfile.shop)) {
                    return shops.filter(s => userProfile.shop.includes(s.name));
                }
                return [];
            }, [shops, userProfile]);

            // Filter employees based on the SELECTED FILTER SHOP
            const availableEmployees = useMemo(() => {
                if (!inviteFilterShop) return [];
                return employees.filter(e => {
                    const empShops = Array.isArray(e.shop) ? e.shop : [e.shop];
                    const isAlreadyInvited = (formData.invitedStaffIds || []).includes(e.id);
                    return empShops.includes(inviteFilterShop) && e.status === 'Active' && !isAlreadyInvited;
                });
            }, [inviteFilterShop, employees, formData.invitedStaffIds]);

            // Get list of currently invited staff objects for display
            const invitedStaff = useMemo(() => {
                const ids = formData.invitedStaffIds || [];
                return employees.filter(e => ids.includes(e.id));
            }, [formData.invitedStaffIds, employees]);

            useEffect(() => {
                if (isOpen) {
                    const initialShop = (userProfile.role === 'Shop Manager' && Array.isArray(userProfile.shop) && userProfile.shop.length === 1) 
                        ? userProfile.shop[0] 
                        : '';

                    setFormData(meeting ? { ...meeting } : {
                        title: '',
                        agenda: '',
                        date: new Date().toISOString().slice(0, 10),
                        startTime: '',
                        endTime: '',
                        type: 'In-Person',
                        shop: initialShop, // Keep strictly for backend reference if needed
                        location: '',
                        mapLink: '',
                        invitedStaffIds: [] 
                    });
                    
                    // Initialize the filter to the meeting shop (if set) or user's first shop
                    setInviteFilterShop(meeting ? meeting.shop : initialShop);
                }
            }, [isOpen, meeting, userProfile]);

            const handleChange = (e) => {
                const { name, value } = e.target;
                setFormData(prev => ({ ...prev, [name]: value }));
            };

            const handleAddStaff = (e) => {
                const staffId = e.target.value;
                if (!staffId) return;
                
                setFormData(prev => ({
                    ...prev,
                    invitedStaffIds: [...(prev.invitedStaffIds || []), staffId]
                }));
            };

            const handleRemoveStaff = (staffId) => {
                setFormData(prev => ({
                    ...prev,
                    invitedStaffIds: (prev.invitedStaffIds || []).filter(id => id !== staffId)
                }));
            };

            const handleSubmit = (e) => {
                e.preventDefault();
                // FIX: Removed '!formData.shop' from validation as requested
                if (!formData.title || !formData.date || !formData.startTime || !formData.endTime) {
                    alert("Please fill in all required fields.");
                    return;
                }
                onSave(formData);
            };

            return (
                <Modal isOpen={isOpen} onClose={onClose} maxWidth="max-w-2xl">
                    <form onSubmit={handleSubmit} className="flex flex-col h-full overflow-hidden">
                        <ModalHeader title={meeting ? "Edit Meeting" : "Schedule Meeting"} onClose={onClose} />
                        <ModalBody>
                            <div className="space-y-4">
                                <div>
                                    <label className="text-sm font-medium text-slate-400"><i className="fas fa-heading mr-2 text-blue-400"></i>Meeting Topic</label>
                                    <input name="title" value={formData.title || ''} onChange={handleChange} className="input" required placeholder="e.g., Monthly Sales Review" />
                                </div>

                                {/* REVISED: Moved Meeting Type Here */}
                                <div>
                                    <label className="text-sm font-medium text-slate-400"><i className="fas fa-video mr-2 text-purple-400"></i>Meeting Type</label>
                                    <select name="type" value={formData.type || 'In-Person'} onChange={handleChange} className="select">
                                        <option value="In-Person">In-Person</option>
                                        <option value="Online">Online (Video Call)</option>
                                    </select>
                                </div>

                                {/* MODIFIED: Removed 'Host / Location Shop' field. Location is now full width. */}
                                <div>
                                    <label className="text-sm font-medium text-slate-400">
                                        {formData.type === 'Online' ? <><i className="fas fa-link mr-2 text-pink-400"></i>Meeting Link</> : <><i className="fas fa-map-marker-alt mr-2 text-red-400"></i>Location / Room</>}
                                    </label>
                                    <input 
                                        name="location" 
                                        value={formData.location || ''} 
                                        onChange={handleChange} 
                                        className="input" 
                                        placeholder={formData.type === 'Online' ? 'Zoom/Meet Link' : 'e.g., Conference Room A'} 
                                    />
                                </div>

                                {/* Map Link Field (Only for In-Person) */}
                                {formData.type !== 'Online' && (
                                    <div>
                                        <label className="text-sm font-medium text-slate-400"><i className="fas fa-map-location-dot mr-2 text-green-400"></i>External Map Link (Optional)</label>
                                        <input 
                                            name="mapLink" 
                                            value={formData.mapLink || ''} 
                                            onChange={handleChange} 
                                            className="input" 
                                            placeholder="https://maps.google.com/..." 
                                        />
                                        <p className="text-xs text-slate-500 mt-1">Paste a Google Maps link here to make the location clickable.</p>
                                    </div>
                                )}

                                <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                                    <div>
                                        <label className="text-sm font-medium text-slate-400"><i className="fas fa-calendar-day mr-2 text-orange-400"></i>Date</label>
                                        <input type="date" name="date" value={formData.date || ''} onChange={handleChange} className="input" required />
                                    </div>
                                    <div>
                                        <label className="text-sm font-medium text-slate-400"><i className="fas fa-clock mr-2 text-green-400"></i>Start Time</label>
                                        <input type="time" name="startTime" value={formData.startTime || ''} onChange={handleChange} className="input" required />
                                    </div>
                                    <div>
                                        <label className="text-sm font-medium text-slate-400">End Time</label>
                                        <input type="time" name="endTime" value={formData.endTime || ''} onChange={handleChange} className="input" required />
                                    </div>
                                </div>

                                <div>
                                    <label className="text-sm font-medium text-slate-400"><i className="fas fa-list-ul mr-2 text-slate-400"></i>Agenda</label>
                                    <textarea name="agenda" value={formData.agenda || ''} onChange={handleChange} className="input" rows="2" placeholder="Key points..."></textarea>
                                </div>

                                <div className="border-t border-slate-700 pt-4 mt-2">
                                    <label className="text-sm font-medium text-slate-400 mb-2 block"><i className="fas fa-users mr-2 text-teal-400"></i>Invite Attendees</label>
                                    
                                    {/* Staff Dropdown - Filter + Select */}
                                    <div className="flex flex-col sm:flex-row gap-2 mb-3">
                                        <div className="flex-1">
                                            <select
                                                value={inviteFilterShop}
                                                onChange={(e) => setInviteFilterShop(e.target.value)}
                                                className="select w-full text-xs sm:text-sm bg-slate-700 border-slate-600"
                                            >
                                                <option value="">-- Filter by Shop --</option>
                                                {availableShops.map(s => <option key={s.id} value={s.name}>{s.name}</option>)}
                                            </select>
                                        </div>
                                        <div className="flex-[2]">
                                            <select 
                                                value="" 
                                                onChange={handleAddStaff} 
                                                className="select w-full" 
                                                disabled={!inviteFilterShop}
                                            >
                                                <option value="">{inviteFilterShop ? "Select Staff to Add..." : "Select a Shop Filter first"}</option>
                                                {availableEmployees.map(emp => (
                                                    <option key={emp.id} value={emp.id}>{emp.name} - {emp.position}</option>
                                                ))}
                                            </select>
                                        </div>
                                    </div>

                                    {/* Selected Staff Chips */}
                                    <div className="flex flex-wrap gap-2 p-3 border border-slate-600 rounded-lg bg-slate-700/30 min-h-[60px]">
                                        {invitedStaff.length > 0 ? (
                                            invitedStaff.map(emp => (
                                                <div key={emp.id} className="flex items-center gap-2 bg-slate-600 text-slate-200 px-3 py-1 rounded-full text-sm border border-slate-500 shadow-sm animate-fade-in">
                                                    <span>{emp.name} <span className="text-[10px] text-slate-400">({Array.isArray(emp.shop) ? emp.shop[0] : emp.shop})</span></span>
                                                    <button 
                                                        type="button" 
                                                        onClick={() => handleRemoveStaff(emp.id)}
                                                        className="text-slate-400 hover:text-red-400 focus:outline-none"
                                                    >
                                                        <i className="fas fa-times-circle"></i>
                                                    </button>
                                                </div>
                                            ))
                                        ) : (
                                            <span className="text-slate-500 text-sm italic self-center">No attendees added yet.</span>
                                        )}
                                    </div>
                                </div>
                            </div>
                        </ModalBody>
                        <ModalFooter>
                            <Button variant="secondary" onClick={onClose}>Cancel</Button>
                            <Button type="submit" variant="primary">Schedule Meeting</Button>
                        </ModalFooter>
                    </form>
                </Modal>
            );
        };

        // Sub-Component: Meeting Card
        const MeetingCard = ({ meeting, userProfile, onEdit, onDelete, employees, onResponseAction, onViewAttendees, shops }) => {
            // FIX: Timezone-aware status calculation
            const getStatus = () => {
                // 1. Determine the target timezone (Shop's TZ or fallback to Browser's)
                let timeZone = Intl.DateTimeFormat().resolvedOptions().timeZone;
                if (meeting.shop && shops) {
                    const shopObj = shops.find(s => s.name === meeting.shop);
                    if (shopObj && shopObj.timezone) {
                        timeZone = shopObj.timezone;
                    }
                }

                // 2. Get "Now" shifted to the target timezone's wall-clock time
                // We format 'Now' into parts based on the target TZ, then reconstruct a local Date object from those parts.
                // This ensures that 10:00 AM in the Shop's TZ is compared against 10:00 AM in the meeting record.
                const nowRaw = new Date();
                const options = { timeZone, year: 'numeric', month: 'numeric', day: 'numeric', hour: 'numeric', minute: 'numeric', second: 'numeric', hour12: false };
                const formatter = new Intl.DateTimeFormat('en-US', options);
                const parts = formatter.formatToParts(nowRaw);
                const p = {};
                parts.forEach(({ type, value }) => p[type] = value);
                
                // Construct "Now" as if it were local time matching the wall clock of the shop
                const nowShifted = new Date(p.year, p.month - 1, p.day, p.hour, p.minute, p.second);

                // 3. Construct Meeting Start/End as local Date objects
                // input: "YYYY-MM-DD" and "HH:mm" -> Date object in local browser time (which aligns with our shifted 'now')
                const startShifted = new Date(`${meeting.date}T${meeting.startTime}`);
                const endShifted = new Date(`${meeting.date}T${meeting.endTime}`);
                
                if (nowShifted > endShifted) return { label: 'Completed', color: 'bg-slate-600 text-slate-300' };
                if (nowShifted >= startShifted && nowShifted <= endShifted) return { label: 'In Progress', color: 'bg-green-600 text-white animate-pulse' };
                return { label: 'Upcoming', color: 'bg-blue-600 text-white' };
            };

            const status = getStatus();
            const isHost = meeting.hostId === userProfile.id;
            const canManage = userProfile.role === 'Admin' || userProfile.role === 'CEO' || isHost;
            const isInvited = meeting.invitedStaffIds?.includes(userProfile.id);

            // Response Logic
            const myResponse = meeting.responses?.[userProfile.id];
            const myStatus = myResponse?.status || 'pending';

            // Counts for Host View
            const responses = meeting.responses || {};
            const acceptedCount = Object.values(responses).filter(r => r.status === 'accepted').length;
            const rejectedCount = Object.values(responses).filter(r => r.status === 'rejected').length;
            const totalInvited = meeting.invitedStaffIds?.length || 0;
            const pendingCount = totalInvited - acceptedCount - rejectedCount;
            
            return (
                <div className="bg-slate-800/50 border border-slate-700 rounded-xl p-5 shadow-lg hover:border-slate-600 transition-all flex flex-col h-full group">
                    {/* Header: Date & Status Badge */}
                    <div className="flex justify-between items-start mb-3">
                        <div className="flex flex-col">
                            <span className="text-3xl font-bold text-slate-200 leading-none mb-1">
                                {new Date(meeting.date).getDate()}
                            </span>
                            <span className="text-xs uppercase font-bold text-slate-500">
                                {new Date(meeting.date).toLocaleDateString('en-US', { month: 'short' })}
                            </span>
                        </div>
                        <span className={`px-3 py-1 rounded-full text-xs font-bold ${status.color} shadow-sm`}>
                            {status.label}
                        </span>
                    </div>

                    {/* Title */}
                    <h3 className="text-lg font-bold text-white mb-1 line-clamp-2">{meeting.title}</h3>
                    
                    {/* Details */}
                    <div className="text-sm text-slate-400 mb-4 space-y-1">
                        <div className="flex items-center gap-2">
                            <i className="fas fa-clock text-slate-500 w-4"></i>
                            <span>{meeting.startTime} - {meeting.endTime}</span>
                        </div>
                        <div className="flex items-center gap-2">
                            <i className={`fas ${meeting.type === 'Online' ? 'fa-video text-purple-400' : 'fa-map-marker-alt text-red-400'} w-4`}></i>
                            {/* MODIFIED: Check for mapLink and render anchor tag if exists */}
                            {meeting.mapLink ? (
                                <a 
                                    href={meeting.mapLink} 
                                    target="_blank" 
                                    rel="noopener noreferrer" 
                                    className="truncate text-blue-400 hover:text-blue-300 hover:underline cursor-pointer"
                                    title="Open Map Location"
                                >
                                    {meeting.location || 'View Location'} <i className="fas fa-external-link-alt text-xs ml-1"></i>
                                </a>
                            ) : (
                                <span className="truncate">{meeting.location || 'No location set'}</span>
                            )}
                        </div>
                        <div className="flex items-center gap-2">
                            <i className="fas fa-user-circle text-slate-500 w-4"></i>
                            <span>Host: {meeting.hostName}</span>
                        </div>
                        
                        {/* Host View: Attendance Summary */}
                        {canManage && (
                            <div className="flex items-center gap-2 mt-2 cursor-pointer hover:bg-slate-700/50 p-1 rounded -ml-1 transition-colors" onClick={() => onViewAttendees(meeting)}>
                                <i className="fas fa-users text-teal-500 w-4"></i>
                                <span className="text-xs font-medium">
                                    <span className="text-green-400">{acceptedCount}</span>  <span className="text-red-400">{rejectedCount}</span>  <span className="text-yellow-400">{pendingCount}?</span>
                                </span>
                                <i className="fas fa-chevron-right text-[10px] ml-auto text-slate-600"></i>
                            </div>
                        )}
                        
                        {/* Staff View: Simple Count */}
                        {!canManage && (
                            <div className="flex items-center gap-2">
                                <i className="fas fa-users text-teal-500 w-4"></i>
                                <span>{totalInvited} Invited</span>
                            </div>
                        )}
                    </div>

                    {meeting.agenda && (
                        <div className="mb-4 p-3 bg-slate-900/50 rounded-lg text-sm text-slate-300 italic border border-slate-700/50 line-clamp-3">
                            "{meeting.agenda}"
                        </div>
                    )}

                    {/* Footer Actions */}
                    <div className="mt-auto space-y-3">
                        {/* Invitation Response Buttons (For Staff) */}
                        {!isHost && isInvited && meeting.status !== 'Completed' && (
                            <div className="pt-3 border-t border-slate-700">
                                {myStatus === 'pending' ? (
                                    <div className="flex gap-2">
                                        <button 
                                            onClick={() => onResponseAction(meeting, 'accepted')} 
                                            className="flex-1 bg-green-600 hover:bg-green-500 text-white text-sm font-bold py-2 rounded-lg transition-colors flex justify-center items-center gap-2"
                                        >
                                            <i className="fas fa-check"></i> Accept
                                        </button>
                                        <button 
                                            onClick={() => onResponseAction(meeting, 'rejected')} 
                                            className="flex-1 bg-red-600 hover:bg-red-500 text-white text-sm font-bold py-2 rounded-lg transition-colors flex justify-center items-center gap-2"
                                        >
                                            <i className="fas fa-times"></i> Reject
                                        </button>
                                    </div>
                                ) : (
                                    <div className="flex items-center justify-between bg-slate-900/50 p-2 rounded-lg border border-slate-700">
                                        <div className="flex items-center gap-2">
                                            <div className={`w-2 h-2 rounded-full ${myStatus === 'accepted' ? 'bg-green-500' : 'bg-red-500'}`}></div>
                                            <span className="text-sm font-medium text-slate-300">You {myStatus}</span>
                                        </div>
                                        <button onClick={() => onResponseAction(meeting, 'edit')} className="text-xs text-blue-400 hover:text-blue-300 underline">Change</button>
                                    </div>
                                )}
                            </div>
                        )}

                        <div className="flex gap-2">
                            {meeting.type === 'Online' && meeting.location && meeting.location.startsWith('http') && (myStatus === 'accepted' || isHost) && (
                                <a 
                                    href={meeting.location} 
                                    target="_blank" 
                                    rel="noopener noreferrer"
                                    className="flex-1 bg-purple-600 hover:bg-purple-500 text-white text-sm font-bold py-2 px-4 rounded-lg text-center transition-colors flex items-center justify-center gap-2"
                                >
                                    <i className="fas fa-video"></i> Join
                                </a>
                            )}
                            
                            {canManage && (
                                <>
                                    <button onClick={() => onEdit(meeting)} className="p-2 bg-slate-700 hover:bg-blue-600 text-slate-300 hover:text-white rounded-lg transition-colors">
                                        <i className="fas fa-edit"></i>
                                    </button>
                                    <button onClick={() => onDelete(meeting)} className="p-2 bg-slate-700 hover:bg-red-600 text-slate-300 hover:text-white rounded-lg transition-colors">
                                        <i className="fas fa-trash"></i>
                                    </button>
                                </>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        // NEW: Meeting History Table (Transaction Style for History View)
        const MeetingHistoryTable = ({ meetings, userProfile, onDelete, onViewAttendees }) => {
            return (
                <div className="overflow-x-auto rounded-xl border border-slate-700 shadow-lg">
                    <table className="min-w-full divide-y divide-slate-700 bg-slate-800/50">
                        <thead className="bg-slate-900/80">
                            <tr>
                                <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Date & Time</th>
                                <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Topic</th>
                                <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Type</th>
                                <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Host</th>
                                <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Location</th>
                                <th className="px-4 py-3 text-center text-xs font-semibold text-slate-400 uppercase">Attendance</th>
                                <th className="px-4 py-3 text-center text-xs font-semibold text-slate-400 uppercase">Actions</th>
                            </tr>
                        </thead>
                        <tbody className="divide-y divide-slate-700">
                            {meetings.map(meeting => {
                                const isHost = meeting.hostId === userProfile.id;
                                const canManage = userProfile.role === 'Admin' || userProfile.role === 'CEO' || isHost;
                                
                                // Calculate basic stats for the table view
                                const responses = meeting.responses || {};
                                const acceptedCount = Object.values(responses).filter(r => r.status === 'accepted').length;
                                const totalInvited = meeting.invitedStaffIds?.length || 0;

                                return (
                                    <tr key={meeting.id} className="hover:bg-slate-700/50 transition-colors">
                                        <td className="px-4 py-3 text-sm text-slate-300 whitespace-nowrap">
                                            <div className="font-bold text-white">{new Date(meeting.date).toLocaleDateString('en-GB')}</div>
                                            <div className="text-xs text-slate-500 font-mono">{meeting.startTime} - {meeting.endTime}</div>
                                        </td>
                                        <td className="px-4 py-3 text-sm font-medium text-white">{meeting.title}</td>
                                        <td className="px-4 py-3 text-sm text-slate-300">
                                            <span className={`px-2 py-0.5 rounded text-xs border ${meeting.type === 'Online' ? 'bg-purple-900/30 text-purple-300 border-purple-800' : 'bg-blue-900/30 text-blue-300 border-blue-800'}`}>
                                                {meeting.type}
                                            </span>
                                        </td>
                                        <td className="px-4 py-3 text-sm text-slate-300">{meeting.hostName}</td>
                                        <td className="px-4 py-3 text-sm text-slate-400 max-w-xs truncate" title={meeting.location}>
                                            {meeting.location || '-'}
                                        </td>
                                        <td className="px-4 py-3 text-center">
                                            <span className="text-xs font-mono text-slate-400 bg-slate-800 px-2 py-1 rounded border border-slate-700">
                                                {acceptedCount} / {totalInvited}
                                            </span>
                                        </td>
                                        <td className="px-4 py-3 text-center whitespace-nowrap">
                                            <div className="flex items-center justify-center gap-2">
                                                {canManage && (
                                                    <Button variant="icon-view" icon="fa-users" onClick={() => onViewAttendees(meeting)} title="View Attendance" />
                                                )}
                                                {canManage && (
                                                    <Button variant="icon-delete" icon="fa-trash" onClick={() => onDelete(meeting)} title="Delete Record" />
                                                )}
                                            </div>
                                        </td>
                                    </tr>
                                );
                            })}
                        </tbody>
                    </table>
                </div>
            );
        };

        // Main Tab Component
        const MeetingRoomTab = ({ userProfile }) => {
            const { db, auth } = useFirebase();
            const { employees, shops } = useAppData();
            const { collection, query, where, onSnapshot, orderBy, addDoc, updateDoc, deleteDoc, doc, serverTimestamp } = window.firebaseSDK;

            const [meetings, setMeetings] = useState([]);
            const [loading, setLoading] = useState(true);
            const [isModalOpen, setIsModalOpen] = useState(false);
            const [editingMeeting, setEditingMeeting] = useState(null);
            const [meetingToDelete, setMeetingToDelete] = useState(null);
            
            // NEW STATES
            const [isResponseModalOpen, setIsResponseModalOpen] = useState(false);
            const [respondingMeeting, setRespondingMeeting] = useState(null);
            const [responseActionType, setResponseActionType] = useState('accepted');
            const [isAttendeesModalOpen, setIsAttendeesModalOpen] = useState(false);
            const [viewingAttendeesMeeting, setViewingAttendeesMeeting] = useState(null);
            
            // Filters
            const [filterType, setFilterType] = useState('upcoming'); // 'upcoming', 'history'

            useEffect(() => {
                if (!db || !userProfile) return;
                setLoading(true);

                // Build Query
                let q = query(collection(db, 'meetings'), orderBy('date', 'asc'), orderBy('startTime', 'asc'));
                
                const unsubscribe = onSnapshot(q, (snapshot) => {
                    const allMeetings = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    
                    // Filter based on Role and Invitation
                    const visibleMeetings = allMeetings.filter(m => {
                        const isHost = m.hostId === userProfile.id;
                        const isInvited = m.invitedStaffIds?.includes(userProfile.id);
                        
                        if (userProfile.role === 'Admin' || userProfile.role === 'CEO') return true;
                        if (userProfile.role === 'Shop Manager') {
                            const myShops = Array.isArray(userProfile.shop) ? userProfile.shop : [userProfile.shop];
                            return isHost || isInvited || (m.shop && myShops.includes(m.shop));
                        }
                        // Staff
                        return isInvited || isHost;
                    });

                    // Filter based on Time (Upcoming vs History)
                    // FIX: Use Local Date instead of UTC (toISOString) to prevent timezone lag in early mornings
                    const now = new Date();
                    const year = now.getFullYear();
                    const month = String(now.getMonth() + 1).padStart(2, '0');
                    const day = String(now.getDate()).padStart(2, '0');
                    const todayStr = `${year}-${month}-${day}`;

                    const finalSet = visibleMeetings.filter(m => {
                        if (filterType === 'upcoming') return m.date >= todayStr;
                        return m.date < todayStr;
                    });

                    // If History, reverse sort to show newest first
                    if (filterType === 'history') {
                        finalSet.sort((a, b) => b.date.localeCompare(a.date));
                    }

                    setMeetings(finalSet);
                    setLoading(false);
                });

                return () => unsubscribe();
            }, [db, userProfile, filterType]);

            const handleSave = async (formData) => {
                const payload = {
                    ...formData,
                    hostId: editingMeeting ? editingMeeting.hostId : userProfile.id,
                    hostName: editingMeeting ? editingMeeting.hostName : userProfile.name,
                    updatedAt: serverTimestamp()
                };

                if (!editingMeeting) {
                    payload.createdAt = serverTimestamp();
                    // Initialize empty responses map logic (handled naturally by Firestore when adding items later)
                }

                try {
                    if (editingMeeting) {
                        await updateDoc(doc(db, 'meetings', editingMeeting.id), payload);
                    } else {
                        await addDoc(collection(db, 'meetings'), payload);
                    }
                    setIsModalOpen(false);
                    setEditingMeeting(null);
                } catch (error) {
                    console.error("Error saving meeting:", error);
                    alert("Failed to save meeting.");
                }
            };

            const handleDelete = async () => {
                if (!meetingToDelete) return;
                try {
                    await deleteDoc(doc(db, 'meetings', meetingToDelete.id));
                    setMeetingToDelete(null);
                } catch (error) {
                    console.error("Error deleting meeting:", error);
                }
            };

            // NEW: Handle Staff Clicking Accept/Reject
            const handleResponseAction = (meeting, type) => {
                setRespondingMeeting(meeting);
                setResponseActionType(type === 'edit' ? 'accepted' : type); // Default to accepted if editing
                setIsResponseModalOpen(true);
            };

            // NEW: Submit Response to Firestore
            const handleSubmitResponse = async (type, reason) => {
                if (!respondingMeeting) return;
                
                try {
                    const meetingRef = doc(db, 'meetings', respondingMeeting.id);
                    // Update specific field in the map using dot notation
                    const fieldPath = `responses.${userProfile.id}`;
                    
                    await updateDoc(meetingRef, {
                        [fieldPath]: {
                            status: type,
                            reason: reason || '',
                            timestamp: new Date().toISOString()
                        }
                    });
                    
                    setIsResponseModalOpen(false);
                    setRespondingMeeting(null);
                } catch (error) {
                    console.error("Error saving response:", error);
                    alert("Failed to save response. Please try again.");
                }
            };

            const handleViewAttendees = (meeting) => {
                setViewingAttendeesMeeting(meeting);
                setIsAttendeesModalOpen(true);
            };

            const canCreate = userProfile.role === 'Admin' || userProfile.role === 'CEO' || userProfile.role === 'Shop Manager';

            return (
                <div className="space-y-6">
                    <div className="flex flex-col md:flex-row justify-between items-center gap-4 bg-slate-800/50 p-4 rounded-xl border border-slate-700">
                        <div>
                            <h2 className="text-xl font-bold text-white">Meeting Schedule</h2>
                            <p className="text-sm text-slate-400">View upcoming sessions and invitations</p>
                        </div>
                        <div className="flex items-center gap-4 w-full md:w-auto">
                            <div className="flex p-1 bg-slate-700 rounded-lg">
                                <button 
                                    onClick={() => setFilterType('upcoming')}
                                    className={`px-4 py-2 text-sm font-medium rounded-md transition-all ${filterType === 'upcoming' ? 'bg-blue-600 text-white shadow' : 'text-slate-400 hover:text-white'}`}
                                >
                                    Upcoming
                                </button>
                                <button 
                                    onClick={() => setFilterType('history')}
                                    className={`px-4 py-2 text-sm font-medium rounded-md transition-all ${filterType === 'history' ? 'bg-slate-600 text-white shadow' : 'text-slate-400 hover:text-white'}`}
                                >
                                    History
                                </button>
                            </div>
                            {canCreate && (
                                <Button variant="primary" icon="fa-plus" onClick={() => { setEditingMeeting(null); setIsModalOpen(true); }}>
                                    Schedule
                                </Button>
                            )}
                        </div>
                    </div>

                    {loading ? (
                        <div className="text-center py-20"><i className="fas fa-spinner fa-spin text-3xl text-blue-500"></i></div>
                    ) : meetings.length === 0 ? (
                        <div className="text-center py-20 opacity-50">
                            <i className="fas fa-calendar-times text-5xl text-slate-600 mb-4"></i>
                            <p className="text-lg text-slate-400">No {filterType} meetings found.</p>
                        </div>
                    ) : (
                        /* MODIFIED: Conditional Rendering based on Filter Type */
                        filterType === 'upcoming' ? (
                            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                {meetings.map(meeting => (
                                    <MeetingCard 
                                        key={meeting.id} 
                                        meeting={meeting} 
                                        userProfile={userProfile} 
                                        onEdit={() => { setEditingMeeting(meeting); setIsModalOpen(true); }}
                                        onDelete={() => setMeetingToDelete(meeting)}
                                        onResponseAction={handleResponseAction}
                                        onViewAttendees={handleViewAttendees}
                                        employees={employees}
                                        shops={shops} // FIX: Pass shops data for timezone lookup
                                    />
                                ))}
                            </div>
                        ) : (
                            /* History View: Render Table */
                            <MeetingHistoryTable 
                                meetings={meetings}
                                userProfile={userProfile}
                                onDelete={(meeting) => setMeetingToDelete(meeting)}
                                onViewAttendees={handleViewAttendees}
                            />
                        )
                    )}

                    <MeetingModal 
                        isOpen={isModalOpen} 
                        onClose={() => setIsModalOpen(false)} 
                        onSave={handleSave} 
                        meeting={editingMeeting} 
                        userProfile={userProfile}
                        employees={employees}
                        shops={shops}
                    />

                    <MeetingResponseModal
                        isOpen={isResponseModalOpen}
                        onClose={() => setIsResponseModalOpen(false)}
                        onConfirm={handleSubmitResponse}
                        actionType={responseActionType}
                    />

                    <MeetingAttendeesModal
                        isOpen={isAttendeesModalOpen}
                        onClose={() => setIsAttendeesModalOpen(false)}
                        meeting={viewingAttendeesMeeting}
                        employees={employees}
                    />

                    <ConfirmationModal 
                        isOpen={!!meetingToDelete} 
                        onClose={() => setMeetingToDelete(null)} 
                        onConfirm={handleDelete} 
                        title="Cancel Meeting" 
                        message={`Are you sure you want to cancel "${meetingToDelete?.title}"?`} 
                    />
                </div>
            );
        };

        // NEW: Main Task Manager Page Container (Tabs)
        const TaskBoardPage = ({ userProfile, pageParams }) => { // MODIFIED: Added pageParams
            const { moduleConfig = {} } = useAppData(); // Phase 3.2 Enforcement
            const [activeTab, setActiveTab] = useState('');

            const tabs = useMemo(() => {
                const available = {};
                if (moduleConfig['tasks:kanban'] !== false) available.kanban = <span><i className="fas fa-list-check mr-2 text-blue-400"></i>Task Board</span>;
                // NEW: Add Scorecard Tab
                if (moduleConfig['tasks:scorecard'] !== false) available.scorecard = <span><i className="fas fa-chart-bar mr-2 text-green-400"></i>KPI Scorecard</span>;
                if (moduleConfig['tasks:meetingRoom'] !== false) available.meetingRoom = <span><i className="fas fa-chalkboard-user mr-2 text-purple-400"></i>Meeting Room</span>;
                return available;
            }, [moduleConfig]);

            useEffect(() => {
                // NEW: Handle direct navigation to specific tabs (e.g. 'scorecard') via pageParams
                if (pageParams && tabs[pageParams]) {
                    setActiveTab(pageParams);
                    return;
                }

                const keys = Object.keys(tabs);
                if (keys.length > 0 && !tabs[activeTab]) setActiveTab(keys[0]);
            }, [tabs, activeTab, pageParams]);

            return (
                <TabbedPage tabs={tabs} activeTab={activeTab} setActiveTab={setActiveTab}>
                    {tabs.kanban && <div id="kanban"><TaskKanbanTab userProfile={userProfile} /></div>}
                    {/* NEW: Render Scorecard */}
                    {tabs.scorecard && <div id="scorecard"><KPIScorecardTab userProfile={userProfile} /></div>}
                    {tabs.meetingRoom && <div id="meetingRoom"><MeetingRoomTab userProfile={userProfile} /></div>}
                </TabbedPage>
            );
        };
        // --- END TASK MANAGER PAGE ---

        // --- START DASHBOARD SUMMARY PAGE ---
        
        // NEW: Sub-component for Memo Item to handle "Read More" logic
        const DashboardMemoItem = ({ memo, isRead }) => { // Updated to accept isRead prop
            const [expanded, setExpanded] = useState(false);
            // Check if text is long enough to warrant a "Read More" button (e.g., > 80 chars)
            const isLongText = memo.content && memo.content.length > 80;

            return (
                <div className={`p-4 rounded-xl border relative transition-colors ${
                    isRead ? 'bg-slate-800/30 border-slate-700/30' : 'bg-slate-800 border-yellow-500/30 shadow-sm'
                }`}>
                    <div className="flex justify-between items-start mb-1">
                        <h4 className={`font-bold ${isRead ? 'text-slate-400' : 'text-slate-200'}`}>{memo.title}</h4>
                        {!isRead && <span className="bg-yellow-500 text-black text-[9px] font-bold px-1.5 py-0.5 rounded animate-pulse">NEW</span>}
                    </div>
                    
                    {/* Use whitespace-pre-line to preserve line breaks when expanded */}
                    <p className={`text-sm ${isRead ? 'text-slate-500' : 'text-slate-300'} whitespace-pre-line ${expanded ? '' : 'line-clamp-2'}`}>
                        {memo.content}
                    </p>
                    <div className="mt-2 flex items-center justify-between">
                        <div className="flex items-center gap-2 text-[10px] text-slate-500 font-medium uppercase">
                            <i className="fas fa-clock"></i>
                            <span>{memo.startTime} - {memo.endTime}</span>
                        </div>
                        {isLongText && (
                            <button 
                                onClick={(e) => { e.stopPropagation(); setExpanded(!expanded); }}
                                className="text-xs font-bold text-blue-400 hover:text-blue-300 transition-colors focus:outline-none"
                            >
                                {expanded ? "Show Less" : "Read More"}
                            </button>
                        )}
                    </div>
                </div>
            );
        };

        // --- NEW WIDGET: TEAM STATUS (Who is Present/Leave/OT Today) ---
        // FIX: Wrapped in memo to prevent re-rendering every second due to parent clock, which caused scroll reset
        const TeamStatusWidget = memo(({ userProfile, db }) => {
            // MODIFIED: Destructure 'employees' to access staff photos
            const { shops, employees } = useAppData();
            const [activeTab, setActiveTab] = useState('present');
            const [data, setData] = useState({ present: [], leave: [], ot: [], titleSuffix: '' });
            const [loading, setLoading] = useState(true);
            
            // FIX: Ref to track initial load to prevent spinner flash (and scroll reset) on updates
            const isFirstLoad = useRef(true);

            useEffect(() => {
                const fetchTeamData = async () => {
                    if (!db || !userProfile || !shops || shops.length === 0) return;

                    try {
                        // FIX: Only set loading true on first mount/load. 
                        // Subsequent updates (e.g. profile change) will update data silently without destroying the DOM/Scroll.
                        if (isFirstLoad.current) {
                            setLoading(true);
                        }
                        
                        const { collection, query, where, getDocs } = window.firebaseSDK;
                        
                        // OPTIMIZATION 1: Tighten Timezone Buffer
                        // Instead of 2 days (48h), we use 30h. 
                        const now = new Date();
                        const bufferStart = new Date(now.getTime() - (30 * 60 * 60 * 1000)); 
                        const bufferEnd = new Date(now.getTime() + (30 * 60 * 60 * 1000));
                        
                        const bufferStartStr = bufferStart.toISOString().slice(0, 10);
                        const bufferEndStr = bufferEnd.toISOString().slice(0, 10);

                        // OPTIMIZATION 2: Server-Side Shop Filtering for Managers
                        const isManager = userProfile.role === 'Shop Manager';
                        const managedShops = isManager ? (Array.isArray(userProfile.shop) ? userProfile.shop : [userProfile.shop]) : [];
                        const canUseDbFilter = isManager && managedShops.length > 0 && managedShops.length <= 10;

                        // 1. Fetch Attendance (Optimized)
                        let attQ = query(
                            collection(db, 'attendance'),
                            where('timestamp', '>=', bufferStart),
                            where('timestamp', '<=', bufferEnd)
                        );
                        if (canUseDbFilter) {
                            attQ = query(attQ, where('shop', 'in', managedShops));
                        }

                        // 2. Fetch Active Leaves
                        const leaveQ = query(
                            collection(db, 'leaveRequests'),
                            where('status', '==', 'Approved'),
                            where('returnDate', '>=', bufferStartStr) 
                        );

                        // 3. Fetch OT
                        const otQ = query(
                            collection(db, 'otRequests'),
                            where('status', '==', 'Approved'),
                            where('reqDate', '>=', bufferStartStr),
                            where('reqDate', '<=', bufferEndStr)
                        );

                        const [attSnap, leaveSnap, otSnap] = await Promise.all([
                            getDocs(attQ), getDocs(leaveQ), getDocs(otQ)
                        ]);

                        const isAllowedShop = (recordShop) => {
                            if (!recordShop) return false;
                            if (userProfile.role === 'Admin' || userProfile.role === 'CEO') return true;
                            if (isManager) return managedShops.includes(recordShop);
                            const myShop = Array.isArray(userProfile.shop) ? userProfile.shop[0] : userProfile.shop;
                            return recordShop === myShop;
                        };

                        // Helper: Get "Today" string (YYYY-MM-DD) for a specific shop's timezone
                        const shopMap = new Map(shops.map(s => [s.name, s]));
                        const getShopToday = (shopName) => {
                            const shop = shopMap.get(shopName);
                            const tz = shop?.timezone; 
                            return Utils.formatDateInTimezone({ toDate: () => new Date() }, tz).localDate;
                        };

                        // NEW: Helper to look up photo from global employees list
                        const getEmployeePhoto = (id) => {
                            if (!employees) return null;
                            const emp = employees.find(e => e.id === id);
                            return emp ? emp.photo : null;
                        };

                        // --- PROCESS ATTENDANCE ---
                        const dailyStatsMap = {};

                        attSnap.docs.forEach(doc => {
                            const d = doc.data();
                            
                            if (!canUseDbFilter && !isAllowedShop(d.shop)) return;
                            if (!d.timestamp) return;

                            const shopTodayStr = getShopToday(d.shop);
                            const shopObj = shopMap.get(d.shop);
                            const recordDateStr = Utils.formatDateInTimezone(d.timestamp, shopObj?.timezone).localDate;

                            if (shopTodayStr !== recordDateStr) return;

                            if (!dailyStatsMap[d.employeeId]) {
                                dailyStatsMap[d.employeeId] = {
                                    id: d.employeeId,
                                    name: d.employeeName,
                                    shop: d.shop,
                                    inTime: null,
                                    inShop: null, // NEW: Track In-Shop
                                    outTime: null,
                                    outShop: null, // NEW: Track Out-Shop
                                    latestTimestamp: 0,
                                    latestType: null,
                                    timezone: shopObj?.timezone
                                };
                            }
                            
                            const record = dailyStatsMap[d.employeeId];
                            const time = d.timestamp.toDate();

                            if (time > record.latestTimestamp) {
                                record.latestTimestamp = time;
                                record.latestType = d.type;
                            }

                            if (d.type === 'in') {
                                if (!record.inTime || time < record.inTime) {
                                    record.inTime = time;
                                    record.inShop = d.shop; // Capture Shop
                                }
                            } else if (d.type === 'out') {
                                if (!record.outTime || time > record.outTime) {
                                    record.outTime = time;
                                    record.outShop = d.shop; // Capture Shop
                                }
                            }
                        });
                        
                        const presentList = Object.values(dailyStatsMap)
                            .filter(rec => rec.inTime !== null)
                            .map(rec => {
                                const fmt = (date) => date.toLocaleTimeString('en-US', { timeZone: rec.timezone, hour: '2-digit', minute:'2-digit', hour12: true });
                                const inStr = fmt(rec.inTime);
                                const outStr = rec.outTime ? fmt(rec.outTime) : null;
                                
                                // MODIFIED: Logic to show shop name(s)
                                let shopDisplay = rec.inShop || rec.shop;
                                if (rec.outShop && rec.outShop !== rec.inShop) {
                                    shopDisplay = `${rec.inShop}${rec.outShop}`;
                                }

                                // REVISED Format: Shop Name|In:HH:MM AM Out:HH:MM PM (Compact)
                                let infoStr = `${shopDisplay}|In:${inStr}`;
                                if (outStr) {
                                    infoStr += ` Out:${outStr}`;
                                }
                                
                                return {
                                    id: rec.id,
                                    name: rec.name, // Display Name only (Shop moved to info)
                                    info: infoStr,
                                    status: rec.latestType === 'in' ? 'Online' : 'Offline',
                                    photo: getEmployeePhoto(rec.id)
                                };
                            });

                        // --- PROCESS LEAVES ---
                        const leaveList = leaveSnap.docs
                            .map(doc => doc.data())
                            .filter(l => {
                                if (!isAllowedShop(l.shop)) return false;
                                const shopToday = getShopToday(l.shop);
                                const leaveStart = (l.leaveDate || '').substring(0, 10);
                                const leaveEnd = (l.returnDate || '').substring(0, 10);
                                // Leave logic: Active today
                                return leaveStart <= shopToday && leaveEnd > shopToday;
                            })
                            .map(l => {
                                const dStart = Utils.formatISOToDisplay(l.leaveDate);
                                const dEnd = Utils.formatISOToDisplay(l.returnDate);
                                const dateRange = dStart === dEnd ? dStart : `${dStart} to ${dEnd}`;
                                return {
                                    id: l.staffId,
                                    // MODIFIED: Removed Shop Name from Name line
                                    name: l.staffName,
                                    // MODIFIED: Added Shop Name to Info line
                                    info: `${l.shop}  ${dateRange}  ${l.leaveSession || 'Full Day'}`,
                                    status: l.leaveType,
                                    photo: getEmployeePhoto(l.staffId)
                                };
                            });

                        // --- PROCESS OT ---
                        const otList = otSnap.docs
                            .map(doc => doc.data())
                            .filter(o => {
                                if (!isAllowedShop(o.shop)) return false;
                                const shopToday = getShopToday(o.shop);
                                const otDate = (o.reqDate || '').substring(0, 10);
                                return otDate === shopToday;
                            })
                            .map(o => ({
                                id: o.staffId,
                                // MODIFIED: Removed Shop Name from Name line
                                name: o.staffName,
                                // MODIFIED: Added Shop Name to Info line
                                info: `${o.shop}  ${o.session || 'OT'}`,
                                status: `${o.numberOfOTDays} Day(s)`,
                                photo: getEmployeePhoto(o.staffId)
                            }));

                        let headerTitleSuffix = "My Shop";
                        if (userProfile.role === 'Admin' || userProfile.role === 'CEO') headerTitleSuffix = "All Shops";
                        else if (isManager && managedShops.length > 1) headerTitleSuffix = "My Shops";
                        else if (userProfile.shop) headerTitleSuffix = Array.isArray(userProfile.shop) ? userProfile.shop[0] : userProfile.shop;

                        setData({ present: presentList, leave: leaveList, ot: otList, titleSuffix: headerTitleSuffix });

                    } catch (error) {
                        console.error("Error fetching team status:", error);
                    } finally {
                        setLoading(false);
                        isFirstLoad.current = false;
                    }
                };

                fetchTeamData();
            }, [db, userProfile, shops, employees]); 

            const renderList = (list, emptyMsg, icon, color) => {
                if (list.length === 0) return <div className="text-center py-8 text-slate-500 text-sm">{emptyMsg}</div>;
                return (
                    <div className="space-y-3">
                        {list.map((item, idx) => (
                            <div key={item.id || idx} className="flex items-center justify-between p-3 rounded-lg bg-slate-800/50 border border-slate-700/50 hover:bg-slate-800 transition-colors">
                                <div className="flex items-center gap-3">
                                    <div className={`w-10 h-10 rounded-full flex items-center justify-center overflow-hidden border border-${color}-500/30 shrink-0 ${item.photo ? 'bg-slate-700' : `bg-${color}-500/20 text-${color}-400`}`}>
                                        {item.photo ? (
                                            <img src={item.photo} alt={item.name} className="w-full h-full object-cover" />
                                        ) : (
                                            <i className={`fas ${icon}`}></i>
                                        )}
                                    </div>
                                    <div>
                                        <p className="text-sm font-bold text-slate-200">{item.name}</p>
                                        <p className="text-[10px] text-slate-400 font-mono">{item.info}</p>
                                    </div>
                                </div>
                                <span className={`text-[10px] px-2 py-1 rounded bg-${color}-900/30 text-${color}-300 border border-${color}-700/50`}>
                                    {item.status}
                                </span>
                            </div>
                        ))}
                    </div>
                );
            };

            return (
                <div className="bg-slate-900 rounded-2xl border border-slate-800 shadow-lg overflow-hidden flex flex-col h-full">
                    <div className="p-4 border-b border-slate-800 bg-slate-900/80">
                        <div className="flex items-center justify-between mb-4">
                            <h3 className="text-lg font-bold text-white flex items-center gap-2">
                                <i className="fas fa-store text-blue-400"></i> Today at {data.titleSuffix}
                            </h3>
                        </div>
                        <div className="flex p-1 bg-slate-800 rounded-lg">
                            {/* FIX: Added type="button" and touch-manipulation to ensure instant tap response on mobile */}
                            <button type="button" onClick={() => setActiveTab('present')} className={`flex-1 py-1.5 text-xs font-bold rounded-md transition-all touch-manipulation ${activeTab === 'present' ? 'bg-green-600 text-white shadow' : 'text-slate-400 hover:text-white'}`}>
                                Present ({data.present.length})
                            </button>
                            <button type="button" onClick={() => setActiveTab('leave')} className={`flex-1 py-1.5 text-xs font-bold rounded-md transition-all touch-manipulation ${activeTab === 'leave' ? 'bg-pink-600 text-white shadow' : 'text-slate-400 hover:text-white'}`}>
                                Leave ({data.leave.length})
                            </button>
                            <button type="button" onClick={() => setActiveTab('ot')} className={`flex-1 py-1.5 text-xs font-bold rounded-md transition-all touch-manipulation ${activeTab === 'ot' ? 'bg-purple-600 text-white shadow' : 'text-slate-400 hover:text-white'}`}>
                                OT ({data.ot.length})
                            </button>
                        </div>
                    </div>
                    {/* Max Height set to 500px for consistency with KPI Card */}
                    <div className="flex-1 overflow-y-auto p-4 custom-scrollbar max-h-[500px]">
                        {loading ? (
                            <div className="flex justify-center py-8"><i className="fas fa-spinner fa-spin text-2xl text-blue-500"></i></div>
                        ) : (
                            <>
                                {activeTab === 'present' && renderList(data.present, "No one is currently checked in.", "fa-user-check", "green")}
                                {activeTab === 'leave' && renderList(data.leave, "No one is on leave today.", "fa-umbrella-beach", "pink")}
                                {activeTab === 'ot' && renderList(data.ot, "No approved OT for today.", "fa-clock", "purple")}
                            </>
                        )}
                    </div>
                </div>
            );
        });

        // --- NEW WIDGET: BIRTHDAY CELEBRATION (Upcoming & Today) ---
        // FIX: Added useAppData to access shops for Timezone calculation
        const BirthdayWidget = ({ employees }) => {
            const { shops } = useAppData(); // Access global shops data

            const birthdayData = useMemo(() => {
                if (!employees || employees.length === 0 || !shops) return { today: [], upcoming: [] };

                // Filter valid employees
                const validEmployees = employees.filter(e => e.status === 'Active' && e.dob);

                const list = validEmployees.map(emp => {
                    // ... (Timezone & Date Logic remains the same) ...
                    // 1. Determine the employee's shop timezone
                    const empShopName = Array.isArray(emp.shop) ? emp.shop[0] : emp.shop;
                    const shop = shops.find(s => s.name === empShopName);
                    const timezone = shop?.timezone;

                    // 2. Get "Today" in that specific timezone
                    const { localDate: todayStr } = Utils.formatDateInTimezone({ toDate: () => new Date() }, timezone);
                    const [tYear, tMonth, tDay] = todayStr.split('-').map(Number);
                    
                    const todayDate = new Date(tYear, tMonth - 1, tDay);

                    // 3. Parse DOB
                    const [y, m, d] = emp.dob.split('-').map(Number);
                    if (!y || !m || !d) return null;

                    const thisYear = tYear;
                    let nextBirthday = new Date(thisYear, m - 1, d);
                    
                    if (nextBirthday < todayDate) {
                        nextBirthday.setFullYear(thisYear + 1);
                    }

                    const diffTime = nextBirthday - todayDate;
                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                    
                    const birthYear = y;
                    const turningAge = nextBirthday.getFullYear() - birthYear;

                    const dd = String(d).padStart(2, '0');
                    const mm = String(m).padStart(2, '0');
                    const displayDate = `${dd}-${mm}`;

                    const prefix = emp.sex === 'F' ? 'Ms.' : 'Mr.';

                    return { 
                        ...emp, 
                        nextBirthday, 
                        diffDays, 
                        turningAge,
                        displayDate, 
                        prefix
                    };
                }).filter(Boolean);

                const todaysBirthdays = list.filter(b => b.diffDays === 0);
                const upcomingBirthdays = list
                    .filter(b => b.diffDays > 0 && b.diffDays <= 14)
                    .sort((a, b) => a.diffDays - b.diffDays);

                return { today: todaysBirthdays, upcoming: upcomingBirthdays };
            }, [employees, shops]); 

            const { today, upcoming } = birthdayData;

            if (today.length === 0 && upcoming.length === 0) {
                return (
                    <div className="bg-slate-900 rounded-2xl border border-slate-800 shadow-lg p-5 flex flex-col items-center justify-center h-full min-h-[200px] bg-gradient-to-br from-slate-900 to-slate-800">
                        <div className="w-12 h-12 bg-slate-800 rounded-full flex items-center justify-center mb-3 text-slate-600">
                            <i className="fas fa-calendar text-xl"></i>
                        </div>
                        <p className="text-slate-500 text-sm font-medium">No birthdays in the next 2 weeks.</p>
                    </div>
                );
            }

            return (
                <div className="bg-slate-900 rounded-2xl border border-slate-800 shadow-lg overflow-hidden flex flex-col h-full relative">
                    <div className="p-4 border-b border-slate-800 bg-slate-900/80 shrink-0">
                        <div className="flex items-center justify-between mb-3">
                            <h3 className="text-lg font-bold text-white flex items-center gap-2">
                                <i className="fas fa-birthday-cake text-pink-500"></i> Celebrations
                            </h3>
                            {today.length > 0 && (
                                <span className="bg-pink-600 text-white text-[10px] font-bold px-2 py-0.5 rounded-full animate-pulse shadow-sm shadow-pink-900/40">
                                    {today.length} Today!
                                </span>
                            )}
                        </div>
                    </div>
                    
                    <div className="flex-1 overflow-y-auto p-4 custom-scrollbar space-y-4">
                        {today.length > 0 && (
                            <div>
                                <h4 className="text-xs font-bold text-pink-400 uppercase tracking-wider mb-2 flex items-center gap-2">
                                    Today <div className="h-px bg-pink-500/20 flex-1"></div>
                                </h4>
                                <div className="space-y-2">
                                    {today.map(emp => (
                                        <div key={emp.id} className="flex items-center gap-3 bg-gradient-to-r from-pink-500/10 to-purple-500/10 p-2 rounded-lg border border-pink-500/20">
                                            <div className="w-8 h-8 rounded-full bg-slate-800 border border-pink-500/30 flex items-center justify-center overflow-hidden">
                                                {emp.photo ? <img src={emp.photo} className="w-full h-full object-cover"/> : emp.name.charAt(0)}
                                            </div>
                                            <div>
                                                <p className="text-sm font-bold text-slate-200">{emp.name}</p>
                                                <p className="text-[10px] text-pink-300">Turning {emp.turningAge}!</p>
                                            </div>
                                            <i className="fas fa-gift text-pink-500 ml-auto"></i>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}

                        {upcoming.length > 0 && (
                            <div>
                                <h4 className="text-xs font-bold text-slate-500 uppercase tracking-wider mb-2 flex items-center gap-2">
                                    Upcoming <div className="h-px bg-slate-700 flex-1"></div>
                                </h4>
                                <div className="space-y-2">
                                    {upcoming.map(emp => (
                                        <div key={emp.id} className="flex items-center justify-between p-2 rounded hover:bg-slate-800/50 transition-colors group">
                                            <div className="flex items-center gap-3">
                                                <div className="text-center w-8 bg-slate-800 rounded border border-slate-700 p-0.5">
                                                    <div className="text-[8px] text-slate-400 uppercase">{new Date(emp.nextBirthday).toLocaleDateString('en-US', {month:'short'})}</div>
                                                    <div className="text-sm font-bold text-slate-200">{new Date(emp.nextBirthday).getDate()}</div>
                                                </div>
                                                <div>
                                                    <p className="text-sm text-slate-300 group-hover:text-white transition-colors">{emp.name}</p>
                                                    <p className="text-[10px] text-slate-500">{emp.shop}</p>
                                                </div>
                                            </div>
                                            <span className="text-[10px] text-slate-500 bg-slate-800 px-1.5 py-0.5 rounded">
                                                {Math.ceil((emp.nextBirthday - new Date()) / (1000 * 60 * 60 * 24))} days
                                            </span>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        // --- NEW WIDGET: MY ASSETS (For Staff Dashboard) ---
        // FIX: Moved component outside of BirthdayWidget
        const MyAssetsWidget = ({ assets, loading }) => {
             const getAssetIcon = (category) => {
                switch(category) {
                    case 'Electronics': return 'fa-laptop';
                    case 'Vehicle': return 'fa-motorcycle';
                    case 'Keys': return 'fa-key';
                    case 'Uniform': return 'fa-tshirt';
                    case 'Equipment': return 'fa-tools';
                    default: return 'fa-box';
                }
            };

            return (
                <div className="bg-slate-900 rounded-2xl border border-slate-800 shadow-lg overflow-hidden flex flex-col h-full">
                    <div className="p-5 border-b border-slate-800 flex justify-between items-center bg-slate-900/80">
                        <div className="flex items-center gap-3">
                            <div className="p-2 bg-orange-500/10 rounded-lg text-orange-400">
                                <i className="fas fa-boxes-stacked"></i>
                            </div>
                            <h3 className="text-lg font-bold text-white">My Assets</h3>
                        </div>
                         {/* Only show count if loaded */}
                         {!loading && (
                            <span className="text-xs font-bold text-slate-500 bg-slate-800 px-2 py-1 rounded-full border border-slate-700">
                                {assets.length} Item{assets.length !== 1 ? 's' : ''}
                            </span>
                         )}
                    </div>
                    <div className="flex-1 overflow-y-auto max-h-[400px] p-4 space-y-3 custom-scrollbar">
                        {loading ? (
                             <div className="flex justify-center py-10"><i className="fas fa-spinner fa-spin text-2xl text-orange-500"></i></div>
                        ) : assets.length === 0 ? (
                            <div className="text-center py-10 text-slate-500">
                                <div className="w-12 h-12 rounded-full bg-slate-800 flex items-center justify-center mx-auto mb-3">
                                    <i className="fas fa-box-open text-xl opacity-50"></i>
                                </div>
                                <p className="text-sm">No assets assigned.</p>
                            </div>
                        ) : (
                            assets.map((asset) => (
                                <div key={asset.id} className="flex items-center justify-between p-3 rounded-xl bg-slate-800/40 border border-slate-700/50 hover:bg-slate-800 hover:border-orange-500/30 transition-all group">
                                    <div className="flex items-center gap-3 overflow-hidden">
                                        <div className="w-10 h-10 rounded-lg bg-slate-800 flex items-center justify-center text-slate-400 shrink-0 border border-slate-700 group-hover:text-orange-400 transition-colors">
                                            <i className={`fas ${getAssetIcon(asset.category)}`}></i>
                                        </div>
                                        <div className="min-w-0">
                                            <p className="text-sm font-semibold text-slate-200 truncate">{asset.name}</p>
                                            <div className="flex items-center gap-2 text-[10px] text-slate-500">
                                                <span className="bg-slate-700/50 px-1.5 rounded">{asset.category}</span>
                                                {asset.condition && <span> {asset.condition}</span>}
                                            </div>
                                        </div>
                                    </div>
                                    <div className="text-right pl-2">
                                         <span className="text-[10px] px-2 py-0.5 rounded bg-green-500/10 text-green-400 border border-green-500/20">
                                            Active
                                        </span>
                                    </div>
                                </div>
                            ))
                        )}
                    </div>
                </div>
            );
        };

        // --- NEW WIDGET: Staff Performance Breakdown (Redesigned) ---
        const StaffPerformanceWidget = ({ stats, loading, onNavigate }) => {
            // ... (keep existing code) ...
            const { overall, totalTasks, validScoreCount } = useMemo(() => {
                if (!stats) return { overall: 0, totalTasks: 0, validScoreCount: 0 };
                const totalScore = stats.reduce((acc, item) => acc + (item.totalScore || 0), 0);
                const scoreCount = stats.reduce((acc, item) => acc + (item.scoreCount || 0), 0);
                const allTasks = stats.reduce((acc, item) => acc + item.count, 0);
                return {
                    overall: scoreCount > 0 ? Math.round(totalScore / scoreCount) : 0,
                    totalTasks: allTasks,
                    validScoreCount: scoreCount
                };
            }, [stats]);

            const getScoreColor = (score) => {
                if (score >= 90) return 'text-green-400 border-green-500';
                if (score >= 70) return 'text-yellow-400 border-yellow-500';
                return 'text-red-400 border-red-500';
            };
            
            const getScoreBg = (score) => {
                if (score >= 90) return 'bg-green-500/20';
                if (score >= 70) return 'bg-yellow-500/20';
                return 'bg-red-500/20';
            };

            return (
                <div className="bg-slate-900 rounded-2xl border border-slate-800 shadow-lg overflow-hidden flex flex-col h-full">
                    <div className="p-5 border-b border-slate-800 flex justify-between items-center bg-slate-900/80 shrink-0">
                        <div className="flex items-center gap-3">
                            <div className="p-2 bg-emerald-500/10 rounded-lg text-emerald-400">
                                <i className="fas fa-chart-pie"></i>
                            </div>
                            <h3 className="text-lg font-bold text-white">Current Month KPI</h3>
                        </div>
                        <button onClick={onNavigate} className="text-xs font-bold text-blue-400 hover:text-blue-300">
                            FULL REPORT
                        </button>
                    </div>
                    
                    {loading ? (
                        <div className="flex justify-center items-center flex-1 py-10"><i className="fas fa-spinner fa-spin text-2xl text-emerald-500"></i></div>
                    ) : (!stats || stats.length === 0) ? (
                        <div className="flex-1 flex flex-col items-center justify-center p-6 text-slate-500">
                            <i className="fas fa-clipboard-list text-3xl mb-2 opacity-50"></i>
                            <p className="text-sm">No KPI data yet this month.</p>
                        </div>
                    ) : (
                        <div className="flex-1 overflow-y-auto p-4 custom-scrollbar">
                            {/* Header Stats */}
                            <div className="flex items-center gap-6 mb-6 px-2">
                                <div className={`relative w-20 h-20 rounded-full flex items-center justify-center border-4 ${getScoreColor(overall)} ${getScoreBg(overall)} shadow-lg shrink-0`}>
                                    <span className={`text-2xl font-bold ${getScoreColor(overall).split(' ')[0]}`}>{overall}%</span>
                                    {validScoreCount === 0 && <span className="absolute text-[8px] bottom-3 text-slate-400">N/A</span>}
                                </div>
                                <div>
                                    <p className="text-slate-400 text-xs uppercase font-bold tracking-wider mb-1">Total Tasks</p>
                                    <p className="text-3xl font-bold text-white leading-none">{totalTasks}</p>
                                    <p className="text-slate-500 text-[10px] mt-1">{validScoreCount} Audited</p>
                                </div>
                            </div>

                            {/* Breakdown List */}
                            <h4 className="text-xs font-bold text-slate-500 uppercase tracking-wider mb-3 px-1 border-b border-slate-800 pb-2">
                                Performance Breakdown
                            </h4>
                            <div className="space-y-3">
                                {stats.map((item, idx) => (
                                    <div key={idx} className="flex items-center justify-between p-3 rounded-xl bg-slate-800/40 border border-slate-700/50 hover:bg-slate-800 transition-colors">
                                        <div className="min-w-0 pr-4">
                                            <p className="text-sm font-medium text-slate-200 truncate">{item.name}</p>
                                            <p className="text-[10px] text-slate-500">{item.count} Tasks Completed</p>
                                        </div>
                                        
                                        {item.scoreCount > 0 ? (
                                            <div className={`px-2 py-1 rounded text-xs font-bold border ${
                                                item.avgScore >= 90 ? 'bg-green-500/10 text-green-400 border-green-500/20' :
                                                item.avgScore >= 70 ? 'bg-yellow-500/10 text-yellow-400 border-yellow-500/20' :
                                                'bg-red-500/10 text-red-400 border-red-500/20'
                                            }`}>
                                                {item.avgScore}%
                                            </div>
                                        ) : (
                                            <span className="text-[10px] text-slate-600 italic">Pending</span>
                                        )}
                                    </div>
                                ))}
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // --- NEW WIDGET: TOP 5 STATS (Absent/Leave/OT) ---
        const TopStatsWidget = memo(({ topStats, loading }) => {
            const [activeTab, setActiveTab] = useState('leave'); // 'leave', 'ot', 'late'

            const renderList = (list, valueSuffix, color) => {
                if (!list || list.length === 0) return <div className="text-center py-8 text-slate-500 text-sm">No data available.</div>;
                
                return (
                    <div className="space-y-3">
                        {list.map((item, idx) => (
                            <div key={item.id} className="flex items-center justify-between p-3 rounded-lg bg-slate-800/50 border border-slate-700/50 hover:bg-slate-800 transition-colors relative overflow-hidden group">
                                {/* Rank Number Background */}
                                <div className="absolute -left-1 -bottom-3 text-[40px] font-bold text-slate-800/50 pointer-events-none select-none z-0 group-hover:text-slate-700/50 transition-colors">
                                    {idx + 1}
                                </div>
                                
                                <div className="flex items-center gap-3 relative z-10">
                                    <div className="w-10 h-10 rounded-full bg-slate-700 flex items-center justify-center text-slate-300 font-bold text-sm shrink-0 border border-slate-600 overflow-hidden">
                                        {item.photo ? (
                                            <img src={item.photo} alt={item.name} className="w-full h-full object-cover" />
                                        ) : (
                                            item.name.charAt(0)
                                        )}
                                    </div>
                                    <div>
                                        <p className="text-sm font-bold text-slate-200">{item.name}</p>
                                        <p className="text-[10px] text-slate-500">{item.shop}</p>
                                    </div>
                                </div>
                                
                                <span className={`text-xs font-bold px-2 py-1 rounded bg-${color}-900/30 text-${color}-300 border border-${color}-700/50 relative z-10`}>
                                    {item.value} {valueSuffix}
                                </span>
                            </div>
                        ))}
                    </div>
                );
            };

            return (
                <div className="bg-slate-900 rounded-2xl border border-slate-800 shadow-lg overflow-hidden flex flex-col h-full">
                    <div className="p-4 border-b border-slate-800 bg-slate-900/80">
                        <div className="flex items-center justify-between mb-4">
                            <h3 className="text-lg font-bold text-white flex items-center gap-2">
                                <i className="fas fa-trophy text-yellow-500"></i> Top 5 This Month
                            </h3>
                        </div>
                        <div className="flex p-1 bg-slate-800 rounded-lg">
                            <button onClick={() => setActiveTab('leave')} className={`flex-1 py-1.5 text-xs font-bold rounded-md transition-all ${activeTab === 'leave' ? 'bg-orange-600 text-white shadow' : 'text-slate-400 hover:text-white'}`}>
                                Leave
                            </button>
                            <button onClick={() => setActiveTab('ot')} className={`flex-1 py-1.5 text-xs font-bold rounded-md transition-all ${activeTab === 'ot' ? 'bg-purple-600 text-white shadow' : 'text-slate-400 hover:text-white'}`}>
                                OT
                            </button>
                            <button onClick={() => setActiveTab('late')} className={`flex-1 py-1.5 text-xs font-bold rounded-md transition-all ${activeTab === 'late' ? 'bg-red-600 text-white shadow' : 'text-slate-400 hover:text-white'}`}>
                                Late
                            </button>
                        </div>
                    </div>
                    
                    <div className="flex-1 overflow-y-auto p-4 custom-scrollbar max-h-[500px]">
                        {loading ? (
                            <div className="flex justify-center py-8"><i className="fas fa-spinner fa-spin text-2xl text-blue-500"></i></div>
                        ) : (
                            <>
                                {activeTab === 'leave' && renderList(topStats.leave, "Days", "orange")}
                                {activeTab === 'ot' && renderList(topStats.ot, "Days", "purple")}
                                {activeTab === 'late' && renderList(topStats.late, "Times", "red")}
                            </>
                        )}
                    </div>
                </div>
            );
        });

        // --- NEW WIDGET: KPI Stats Widget (Admin/Manager Version) ---
        // ... (keep existing KPIStatsWidget code) ...
        const KPIStatsWidget = memo(({ stats, title, icon, color, onNavigate }) => {
            // ... (keep logic) ...
            const { overallScore, totalVolume } = useMemo(() => {
                if (!stats || stats.length === 0) return { overallScore: 0, totalVolume: 0 };
                // ...
                let totalSum = 0;
                let totalCount = 0;
                stats.forEach(s => {
                    if (s.totalScore !== undefined && s.scoreCount) {
                        totalSum += s.totalScore;
                        totalCount += s.scoreCount;
                    }
                });
                return { overallScore: totalCount > 0 ? Math.round(totalSum / totalCount) : 0, totalVolume: totalCount };
            }, [stats]);

            const getScoreColor = (score) => {
                if (score >= 90) return 'text-green-400 border-green-500';
                if (score >= 70) return 'text-yellow-400 border-yellow-500';
                return 'text-red-400 border-red-500';
            };
            const getScoreBg = (score) => {
                if (score >= 90) return 'bg-green-500/10';
                if (score >= 70) return 'bg-yellow-500/10';
                return 'bg-red-500/10';
            };

            return (
                <div className="bg-slate-900 rounded-2xl border border-slate-800 shadow-lg overflow-hidden flex flex-col h-full">
                    <div className="p-5 border-b border-slate-800 flex justify-between items-center bg-slate-900/80 shrink-0">
                        <div className="flex items-center gap-3">
                            <div className={`p-2 bg-${color}-500/10 rounded-lg text-${color}-400`}>
                                <i className={`fas ${icon}`}></i>
                            </div>
                            <h3 className="text-lg font-bold text-white">{title}</h3>
                        </div>
                        <button onClick={onNavigate} className="text-xs font-bold text-blue-400 hover:text-blue-300">
                            VIEW DETAILS
                        </button>
                    </div>
                    {(!stats || stats.length === 0) ? (
                        <div className="flex-1 flex flex-col items-center justify-center p-6 text-slate-500">
                            <i className="fas fa-chart-line text-3xl mb-2 opacity-50"></i>
                            <p className="text-sm">No KPI data available this month.</p>
                        </div>
                    ) : (
                        <div className="flex-1 overflow-y-auto p-4 custom-scrollbar max-h-[500px]">
                            <div className="flex items-center gap-5 mb-6 px-2 pb-4 border-b border-slate-800/50">
                                <div className={`relative w-16 h-16 rounded-full flex items-center justify-center border-4 ${getScoreColor(overallScore)} ${getScoreBg(overallScore)} shadow-lg shrink-0`}>
                                    <span className={`text-xl font-bold ${getScoreColor(overallScore).split(' ')[0]}`}>{overallScore}%</span>
                                </div>
                                <div>
                                    <p className="text-slate-400 text-xs uppercase font-bold tracking-wider mb-0.5">Average Performance</p>
                                    <p className="text-2xl font-bold text-white leading-none">{totalVolume}</p>
                                    <p className="text-slate-500 text-[10px] mt-0.5">Total Tasks Evaluated</p>
                                </div>
                            </div>
                            <h4 className="text-[10px] font-bold text-slate-500 uppercase tracking-wider mb-3 px-1">Top Performers</h4>
                            <div className="space-y-3">
                                {stats.map((item, idx) => (
                                    <div key={item.id || idx} className="flex items-center justify-between p-3 rounded-xl bg-slate-800/40 border border-slate-700/50 hover:bg-slate-800 transition-colors group">
                                        <div className="flex items-center gap-3 overflow-hidden">
                                            <div className="w-10 h-10 rounded-full bg-slate-700 flex items-center justify-center text-slate-300 font-bold text-sm shrink-0 border border-slate-600 overflow-hidden">
                                                {item.photo ? (<img src={item.photo} alt={item.name} className="w-full h-full object-cover" />) : (item.name.charAt(0))}
                                            </div>
                                            <div className="min-w-0">
                                                <p className="text-sm font-bold text-slate-200 truncate group-hover:text-blue-300 transition-colors">{item.name}</p>
                                                <p className="text-[10px] text-slate-500 truncate">{item.shop}  {item.count} Tasks</p>
                                            </div>
                                        </div>
                                        <div className={`w-12 h-12 rounded-full flex items-center justify-center border-2 ${getScoreColor(item.avgScore)} ${getScoreBg(item.avgScore)} shrink-0`}>
                                            <span className={`text-xs font-bold ${getScoreColor(item.avgScore).split(' ')[0]}`}>{item.avgScore}%</span>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>
                    )}
                </div>
            );
        });

        // FIX: Wrapped DashboardSummaryPage in memo to prevent it from re-rendering every second 
        // when the parent AppContent's clock updates. This stabilizes the children widgets (like TeamStatus)
        // and fixes touch interaction issues on mobile.
        const DashboardSummaryPage = memo(({ userProfile, setActivePage, onNavigateWithTab, pendingLeaves = [], pendingOTs = [] }) => {
            // MODIFIED: Added 'kpis' to useAppData destructuring
            const { employees, shops, isLoading, kpis } = useAppData(); 
            const { db } = useFirebase();
            // MODIFIED: Added 'addDoc', 'serverTimestamp' AND 'onSnapshot' for real-time funds
            const { collection, query, where, getDocs, limit, orderBy, addDoc, serverTimestamp, onSnapshot } = window.firebaseSDK;

            // --- NEW: Helper for Session Caching (Stale-While-Revalidate) ---
            const getCachedState = (key, defaultValue) => {
                try {
                    const cached = sessionStorage.getItem(`dash_cache_${userProfile.id}_${key}`);
                    return cached ? JSON.parse(cached) : defaultValue;
                } catch (e) { return defaultValue; }
            };

            const setCachedState = (key, value) => {
                try {
                    sessionStorage.setItem(`dash_cache_${userProfile.id}_${key}`, JSON.stringify(value));
                } catch (e) { /* Ignore quota errors */ }
            };
            // --- END HELPER ---

            // --- NEW: Top Stats State (Initialized from Cache) ---
            const [topStats, setTopStats] = useState(() => getCachedState('topStats', { leave: [], ot: [], late: [] }));

            // --- NEW: Fetch My Assigned Assets (Initialized from Cache) ---
            const assetQueryConstraints = useMemo(() => {
                // FIX: Removed role restriction. Now ALL roles (Admin, Manager, Staff) can see their own assigned assets.
                return [
                    where('currentHolderId', '==', userProfile.id),
                    where('status', '==', 'Assigned')
                ];
            }, [userProfile]);

            // Note: useCollection handles its own caching if persistKey is passed, but MyAssets wasn't using it.
            // We'll let useCollection handle this one naturally or add a key if needed. 
            // For now, MyAssets loads fast, but we can optimize other heavy widgets.
            const { data: myAssets, loading: assetsLoading } = useCollection('assets', assetQueryConstraints);

            // --- NEW STATE FOR EMPLOYEE DASHBOARD (Initialized from Cache) ---
            const [myStats, setMyStats] = useState(() => getCachedState('myStats', { workDays: 0, lateCount: 0, otDays: 0, engagementAmount: 0 }));
            const [myRecentRequests, setMyRecentRequests] = useState(() => getCachedState('myRecentRequests', []));
            const [activeMemos, setActiveMemos] = useState(() => getCachedState('activeMemos', []));

            // --- NEW: KPI Stats State (Initialized from Cache) ---
            const [kpiStats, setKpiStats] = useState(() => getCachedState('kpiStats', []));
            
            // --- NEW: Petty Cash State (Initialized from Cache) ---
            const [totalPettyCash, setTotalPettyCash] = useState(() => getCachedState('totalPettyCash', 0));
            
            // --- NEW: Task Modal State ---
            const [isTaskModalOpen, setIsTaskModalOpen] = useState(false);

            // --- NEW: Pending Audits State (Initialized from Cache) ---
            const [pendingAudits, setPendingAudits] = useState(() => getCachedState('pendingAudits', []));
            
            // --- NEW: Upcoming Meetings State (Initialized from Cache) ---
            const [upcomingMeetings, setUpcomingMeetings] = useState(() => getCachedState('upcomingMeetings', []));

            // FIX: Create stable handler for KPI navigation to prevent widget re-renders
            const handleScorecardNav = useCallback(() => {
                setActivePage('tasks:scorecard');
            }, [setActivePage]);

            // --- STEP 1 RE-EXECUTION: PREPARE SOCIAL/COLLEAGUE DATA FOR BIRTHDAYS ---
            // This logic allows Staff to see their colleagues' birthdays, even if they can't see their payroll data.
            const socialEmployees = useMemo(() => {
                if (!employees) return [];
                // Admins/CEOs see everyone
                if (userProfile.role === 'Admin' || userProfile.role === 'CEO') return employees;
                
                // For Shop Manager & Staff: See everyone in their shop(s)
                const myShops = Array.isArray(userProfile.shop) ? userProfile.shop : [userProfile.shop];
                
                return employees.filter(e => {
                    const eShops = Array.isArray(e.shop) ? e.shop : [e.shop];
                    // Check intersection: Does employee work in ANY of the target shops?
                    return eShops.some(s => myShops.includes(s));
                });
            }, [employees, userProfile]);

            const activeSocialEmployees = socialEmployees.filter(e => e.status === 'Active');
            // --- END STEP 1 ---

            // --- BUG FIX: Calculate Active Shops Count based on Role ---
            const activeShopsCount = useMemo(() => {
                if (!shops) return 0;
                if (userProfile.role === 'Admin' || userProfile.role === 'CEO') {
                    return shops.length;
                }
                if (userProfile.role === 'Shop Manager') {
                    if (Array.isArray(userProfile.shop)) {
                        // Count shops that exist in the system and are assigned to the manager
                        return shops.filter(s => userProfile.shop.includes(s.name)).length;
                    }
                    // Single shop manager
                    return userProfile.shop ? 1 : 0;
                }
                return 1; // Staff
            }, [shops, userProfile]);
            // --- END FIX ---
            
            // --- NEW: Fetch Petty Cash for Ops Card (Real-Time) ---
            useEffect(() => {
                if (!db || !userProfile || userProfile.role === 'Staff') return;

                const unsub = onSnapshot(collection(db, 'shopFunds'), (snapshot) => {
                    let total = 0;
                    snapshot.docs.forEach(doc => {
                        const balance = parseFloat(doc.data().balance) || 0;
                        const shopName = doc.id;
                        
                        if (userProfile.role === 'Admin' || userProfile.role === 'CEO') {
                            total += balance;
                        } else if (userProfile.role === 'Shop Manager') {
                            const myShops = Array.isArray(userProfile.shop) ? userProfile.shop : [userProfile.shop];
                            if (myShops.includes(shopName)) {
                                total += balance;
                            }
                        }
                    });
                    setTotalPettyCash(total);
                    setCachedState('totalPettyCash', total); // Update Cache
                }, (error) => {
                    console.error("Error fetching shop funds:", error);
                });
                
                return () => unsub();
            }, [db, userProfile]);

            // --- NEW: Fetch Pending Audits (Real-Time) ---
            useEffect(() => {
                if (!db || !userProfile || userProfile.role === 'Staff') return;

                // Query tasks in 'auditing' status
                const q = query(collection(db, 'tasks'), where('status', '==', 'auditing'));
                
                const unsubscribe = onSnapshot(q, (snapshot) => {
                    let items = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    
                    // Filter for Shop Managers (Client-side for flexibility/quota savings on small list)
                    if (userProfile.role === 'Shop Manager') {
                        const myShops = Array.isArray(userProfile.shop) ? userProfile.shop : [userProfile.shop];
                        if (myShops.length > 0) {
                            items = items.filter(t => myShops.includes(t.shopName));
                        } else {
                            items = [];
                        }
                    }
                    
                    setPendingAudits(items);
                    setCachedState('pendingAudits', items); // Update Cache
                }, (error) => {
                    console.error("Error fetching pending audits:", error);
                });

                return () => unsubscribe();
            }, [db, userProfile]);

            // --- NEW: Fetch Upcoming Meetings (Real-Time) ---
            useEffect(() => {
                if (!db || !userProfile || userProfile.role === 'Staff') return;

                const today = new Date().toISOString().slice(0, 10);
                // Fetch future meetings
                const q = query(
                    collection(db, 'meetings'), 
                    where('date', '>=', today), 
                    orderBy('date', 'asc'),
                    orderBy('startTime', 'asc')
                );

                const unsubscribe = onSnapshot(q, (snapshot) => {
                    const allMeetings = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    
                    // Filter in memory based on permissions
                    const visibleMeetings = allMeetings.filter(m => {
                        if (userProfile.role === 'Admin' || userProfile.role === 'CEO') return true;
                        if (userProfile.role === 'Shop Manager') {
                            const myShops = Array.isArray(userProfile.shop) ? userProfile.shop : [userProfile.shop];
                            // Show if hosted by me, invited me, OR is in one of my shops
                            return m.hostId === userProfile.id || 
                                   (m.invitedStaffIds && m.invitedStaffIds.includes(userProfile.id)) ||
                                   (m.shop && myShops.includes(m.shop));
                        }
                        return false;
                    });

                    setUpcomingMeetings(visibleMeetings);
                    setCachedState('upcomingMeetings', visibleMeetings); // Update Cache
                }, (error) => {
                    console.error("Error fetching upcoming meetings:", error);
                });

                return () => unsubscribe();
            }, [db, userProfile]);

            // Fetch extra dashboard data
            useEffect(() => {
                if (!db || !userProfile) return;

                const fetchDashboardData = async () => {
                    const isStaff = userProfile.role === 'Staff';
                    const isManager = userProfile.role === 'Shop Manager';
                    const isAdmin = userProfile.role === 'Admin' || userProfile.role === 'CEO';

                    const today = new Date();
                    const startOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);
                    const endOfMonth = new Date(today.getFullYear(), today.getMonth() + 1, 0, 23, 59, 59);
                    const currentMonthStr = today.toISOString().slice(0, 7);

                    // --- 1. KPI DATA FETCHING & PROCESSING ---
                    try {
                        let kpiQuery;
                        
                        // Define base query for "Done" tasks this month
                        if (isStaff) {
                            kpiQuery = query(
                                collection(db, 'tasks'),
                                where('staffId', '==', userProfile.id),
                                where('completedTimestamp', '>=', startOfMonth),
                                where('completedTimestamp', '<=', endOfMonth)
                            );
                        } else if (isManager) {
                            const myShops = Array.isArray(userProfile.shop) ? userProfile.shop : (userProfile.shop ? [userProfile.shop] : []);
                            if (myShops.length > 0) {
                                kpiQuery = query(
                                    collection(db, 'tasks'),
                                    where('shopName', 'in', myShops),
                                    where('completedTimestamp', '>=', startOfMonth),
                                    where('completedTimestamp', '<=', endOfMonth)
                                );
                            } else {
                                kpiQuery = query(collection(db, 'tasks'), where('shopName', '==', 'null')); // No access
                            }
                        } else {
                            // Admin/CEO
                            kpiQuery = query(
                                collection(db, 'tasks'),
                                where('completedTimestamp', '>=', startOfMonth),
                                where('completedTimestamp', '<=', endOfMonth)
                            );
                        }

                        if (kpiQuery) {
                            const kpiSnap = await getDocs(kpiQuery);
                            const tasks = kpiSnap.docs.map(d => d.data()).filter(t => t.status === 'done'); // Ensure status is done

                            // REVISED: Aggregation Logic based on Role
                            const statsMap = {};
                            
                            tasks.forEach(task => {
                                // FIX: Updated Score Calculation Logic to match KPIScorecardTab
                                // 1. Default to 0 (for Rejected or failed parse)
                                let scoreVal = 0;
                                
                                if (task.auditScore) {
                                    // 2. Try to parse percentage (e.g. "80%")
                                    const scoreMatch = task.auditScore.match(/(\d+)%/);
                                    if (scoreMatch) {
                                        scoreVal = parseInt(scoreMatch[1], 10);
                                    }
                                    // 3. If "Rejected" (no digit match), scoreVal remains 0.
                                } else {
                                    // 4. If no auditScore exists but task is done, assume 100% (Auto-Approved)
                                    scoreVal = 100;
                                }

                                // Key Selection:
                                // If Staff: Aggregate by KPI Category
                                // If Admin/Manager: Aggregate by Staff ID
                                let key, name, shop, photo;
                                
                                if (isStaff) {
                                    key = task.kpiText || 'General Tasks';
                                    name = key;
                                    shop = null;
                                    photo = null;
                                } else {
                                    key = task.staffId;
                                    if (!key) return; // Skip if no staff ID
                                    
                                    // MODIFIED: Look up photo from employees list
                                    const staffObj = employees ? employees.find(e => e.id === key) : null;
                                    
                                    // NEW: Filter out inactive staff from Dashboard Widget
                                    if (staffObj && staffObj.status !== 'Active') return;

                                    name = task.staffName || 'Unknown';
                                    shop = task.shopName || 'Unknown';
                                    photo = staffObj ? staffObj.photo : null;
                                }

                                if (!statsMap[key]) {
                                    statsMap[key] = { 
                                        id: key, // Ensure ID is present
                                        name: name,
                                        shop: shop,
                                        photo: photo, // NEW: Store photo
                                        count: 0, 
                                        totalScore: 0, 
                                        scoreCount: 0 
                                    };
                                }
                                
                                statsMap[key].count += 1;
                                
                                // FIX: Always include "Done" tasks in the average, even if 0% (Rejected)
                                statsMap[key].totalScore += scoreVal;
                                statsMap[key].scoreCount += 1;
                            });

                            const statsArray = Object.values(statsMap).map(s => ({
                                ...s,
                                avgScore: s.scoreCount > 0 ? Math.round(s.totalScore / s.scoreCount) : 0
                            })).sort((a, b) => b.avgScore - a.avgScore); // Sort by Score (High to Low)

                            setKpiStats(statsArray);
                            setCachedState('kpiStats', statsArray); // Update Cache
                        }

                    } catch (error) {
                        console.error("Error fetching KPI Dashboard Data:", error);
                    }
                    // --- END KPI FETCHING ---

                    // --- 2. ADMIN/MANAGER: TOP STATS FETCHING (Leave, OT, Late) ---
                    if (!isStaff) {
                        try {
                            const leaveQ = query(collection(db, 'leaveRequests'), where('status', '==', 'Approved'), where('returnDate', '>=', currentMonthStr + '-01'));
                            const otQ = query(collection(db, 'otRequests'), where('status', '==', 'Approved'), where('reqDate', '>=', currentMonthStr + '-01'), where('reqDate', '<=', currentMonthStr + '-31'));
                            // MODIFIED: Fetch ALL deductions to split into Late vs Absent
                            const stateQ = query(collection(db, 'employeeStates'), where('statusState', '==', 'Deduction'), where('date', '>=', currentMonthStr + '-01'), where('date', '<=', currentMonthStr + '-31'));

                            const [lSnap, oSnap, sSnap] = await Promise.all([getDocs(leaveQ), getDocs(otQ), getDocs(stateQ)]);

                            const aggregateStats = (docs, valueKey, type = 'normal') => {
                                const map = {};
                                docs.forEach(d => {
                                    const data = d.data();
                                    // Shop Filter for Managers
                                    if (isManager) {
                                        const myShops = Array.isArray(userProfile.shop) ? userProfile.shop : [userProfile.shop];
                                        if (!myShops.includes(data.shop)) return;
                                    }
                                    
                                    // NEW: Active Staff Filter
                                    // We look up the employee to check their current status
                                    const emp = employees ? employees.find(e => e.id === data.staffId) : null;
                                    
                                    // Skip if employee doesn't exist or is not Active
                                    if (!emp || emp.status !== 'Active') return;

                                    // Logic for splitting Late vs Absent based on 'type' arg
                                    if (type === 'late') {
                                        if (!data.note?.includes('Late')) return; // Skip if not Late
                                    } else if (type === 'absent') {
                                        if (data.note?.includes('Late')) return; // Skip if it IS Late (we want others)
                                    }

                                    if (!map[data.staffId]) {
                                        map[data.staffId] = {
                                            id: data.staffId,
                                            name: data.staffName,
                                            shop: data.shop,
                                            photo: emp.photo,
                                            value: 0
                                        };
                                    }
                                    
                                    // For Late/Absent, we count occurrences (1). For Leave/OT, we sum days.
                                    const val = (type === 'late' || type === 'absent') ? 1 : (parseFloat(data[valueKey]) || 0);
                                    map[data.staffId].value += val;
                                });
                                return Object.values(map).sort((a,b) => b.value - a.value).slice(0, 5);
                            };

                            setTopStats({
                                leave: aggregateStats(lSnap.docs, 'numberOfDays'),
                                ot: aggregateStats(oSnap.docs, 'numberOfOTDays'),
                                late: aggregateStats(sSnap.docs, null, 'late'),
                                absent: aggregateStats(sSnap.docs, null, 'absent')
                            });

                        } catch (error) {
                            console.error("Error fetching Top Stats:", error);
                        }
                    }
                    // --- END TOP STATS ---

                    // 3. Employee Specific Data (For Staff)
                    if (isStaff) {
                        try {
                            const currentMonthStr = today.toISOString().slice(0, 7); // YYYY-MM

                            // A. Calculate "My Stats" for this month
                            // Work Days (Count unique attendance dates)
                            const attQ = query(collection(db, 'attendance'), 
                                where('employeeId', '==', userProfile.id),
                                where('timestamp', '>=', startOfMonth),
                                where('timestamp', '<=', endOfMonth)
                            );
                            // Lates & Engagements (Count records)
                            const stateQ = query(collection(db, 'employeeStates'),
                                where('staffId', '==', userProfile.id),
                                where('date', '>=', currentMonthStr + '-01'),
                                where('date', '<=', currentMonthStr + '-31')
                            );
                            // OT (Sum OT days)
                            const otQ = query(collection(db, 'otRequests'),
                                where('staffId', '==', userProfile.id),
                                where('reqDate', '>=', currentMonthStr + '-01'),
                                where('reqDate', '<=', currentMonthStr + '-31'),
                                where('status', '==', 'Approved')
                            );

                            // B. Fetch Recent Requests (Client-Side Sort to fix Index Error)
                            const recentLeaveQ = query(collection(db, 'leaveRequests'), where('staffId', '==', userProfile.id));
                            const recentOtQ = query(collection(db, 'otRequests'), where('staffId', '==', userProfile.id));

                            // C. Fetch Active Memos
                            const memosQ = query(collection(db, 'memoAlerts'), where('status', '==', 'Active'));

                            // Execute all queries
                            const [attSnap, stateSnap, otSnap, rLeaveSnap, rOtSnap, memoSnap] = await Promise.all([
                                getDocs(attQ), getDocs(stateQ), getDocs(otQ), getDocs(recentLeaveQ), getDocs(recentOtQ), getDocs(memosQ)
                            ]);

                            // Process Stats
                            const uniqueDays = new Set(attSnap.docs.map(d => {
                                return d.data().timestamp?.toDate().toDateString();
                            }));
                            
                            // Filter for Lates
                            const lates = stateSnap.docs.filter(d => d.data().statusState === 'Deduction' && d.data().note?.includes('Late')).length;
                            
                            // Filter for Engagements (Bonuses)
                            const engagements = stateSnap.docs.filter(d => d.data().statusState === 'Engagement');
                            const totalEngagementAmount = engagements.reduce((sum, d) => sum + (parseFloat(d.data().amount) || 0), 0);

                            const otTotal = otSnap.docs.reduce((sum, d) => sum + (parseFloat(d.data().numberOfOTDays) || 0), 0);

                            // MODIFIED: Updated state with engagementAmount
                            const myStatsData = { workDays: uniqueDays.size, lateCount: lates, otDays: otTotal, engagementAmount: totalEngagementAmount };
                            setMyStats(myStatsData);
                            setCachedState('myStats', myStatsData); // Update Cache

                            // Process Requests (Sort & Limit in JavaScript)
                            const leaveReqs = rLeaveSnap.docs.map(d => ({ ...d.data(), type: 'Leave', date: d.data().requestDate }));
                            const otReqs = rOtSnap.docs.map(d => ({ ...d.data(), type: 'OT', date: d.data().submissionDate }));
                            
                            const combinedRequests = [...leaveReqs, ...otReqs]
                                .sort((a, b) => {
                                    const dateA = a.date?.toDate ? a.date.toDate() : new Date(a.date);
                                    const dateB = b.date?.toDate ? b.date.toDate() : new Date(b.date);
                                    return dateB - dateA;
                                })
                                .slice(0, 3); // Take top 3 most recent
                                
                            setMyRecentRequests(combinedRequests);
                            setCachedState('myRecentRequests', combinedRequests); // Update Cache

                            // Process Memos
                            // MODIFIED: Smart Dashboard Logic (Sort Unread First)
                            const rawMemos = memoSnap.docs.map(d => ({id: d.id, ...d.data()}));
                            
                            // Filter logic: Apply targetShops check here as well to match NoticeBoardTab
                            const relevantMemos = rawMemos.filter(m => {
                                if (!m.targetShops || m.targetShops.length === 0) return true;
                                const userShops = Array.isArray(userProfile.shop) ? userProfile.shop : [userProfile.shop];
                                const validUserShops = userShops.filter(Boolean);
                                // Check overlap
                                return validUserShops.some(s => m.targetShops.includes(s));
                            });

                            // Sort: Unread first, then by Creation Date
                            relevantMemos.sort((a, b) => {
                                const aRead = (a.readBy || []).includes(userProfile.id);
                                const bRead = (b.readBy || []).includes(userProfile.id);
                                
                                if (aRead === bRead) {
                                    // If status matches, sort by date (newest first)
                                    return (b.createdAt?.toDate() || 0) - (a.createdAt?.toDate() || 0);
                                }
                                return aRead ? 1 : -1; // Unread comes first
                            });
                            
                            const finalMemos = relevantMemos.slice(0, 5); // Show top 5
                            setActiveMemos(finalMemos);
                            setCachedState('activeMemos', finalMemos); // Update Cache

                        } catch (err) { console.error("Error fetching employee dashboard data", err); }
                    }
                };

                fetchDashboardData();
            }, [db, userProfile, employees]); // MODIFIED: Added 'employees' to dependencies so photos update

            // --- Calculations ---
            const visibleEmployees = useMemo(() => {
                if (!employees) return [];
                if (userProfile.role === 'Admin' || userProfile.role === 'CEO') return employees;
                if (userProfile.role === 'Shop Manager') {
                    const managedShops = Array.isArray(userProfile.shop) ? userProfile.shop : (userProfile.shop ? [userProfile.shop] : []);
                    return employees.filter(e => {
                        const empShops = Array.isArray(e.shop) ? e.shop : [e.shop];
                        return empShops.some(s => managedShops.includes(s));
                    });
                }
                return employees.filter(e => e.id === userProfile.id);
            }, [employees, userProfile]);

            const activeEmployees = visibleEmployees.filter(e => e.status === 'Active');
            
            // NEW: Calculate Gender breakdown for Operations Card
            const maleStaffCount = activeEmployees.filter(e => e.sex === 'M').length;
            const femaleStaffCount = activeEmployees.filter(e => e.sex === 'F').length;
            
            // --- NEW: Handle Save Task from Dashboard ---
            const handleSaveTask = async (formData) => {
                try {
                    await addDoc(collection(db, 'tasks'), {
                        ...formData,
                        status: 'todo', // KANBAN_STATUS.TODO
                        taskTimestamp: formData.taskTimestamp || serverTimestamp(), 
                        creatorUid: userProfile.id
                    });
                    setIsTaskModalOpen(false);
                    // Optional: Show success feedback if needed, currently implied by modal close
                } catch (error) {
                    console.error("Error saving task:", error);
                    alert("Failed to save task.");
                }
            };

            // --- Helper Components ---
            const DashboardMetricCard = ({ title, value, subtitle, icon, color, onClick }) => (
                <div 
                    onClick={onClick}
                    // MODIFIED: Responsive padding (p-3 on mobile, p-5 on desktop) to fit 2-col grid
                    className={`relative p-3 sm:p-5 rounded-2xl border border-slate-800 bg-slate-900/50 shadow-lg overflow-hidden group transition-all duration-300 hover:shadow-xl hover:border-slate-700 hover:-translate-y-1 ${onClick ? 'cursor-pointer' : ''}`}
                >
                    <div className="flex justify-between items-start mb-2 relative z-10">
                        <div className={`p-2.5 rounded-xl bg-${color}-500/10 text-${color}-400 border border-${color}-500/20`}>
                            <i className={`fas ${icon} text-lg`}></i>
                        </div>
                        {onClick && <i className="fas fa-chevron-right text-slate-600 text-xs"></i>}
                    </div>
                    <div className="relative z-10">
                        {/* MODIFIED: Responsive font size (text-xl on mobile) to prevent overflow */}
                        <h3 className="text-xl sm:text-3xl font-bold text-white tracking-tight mb-0.5 font-sans truncate">{value}</h3>
                        <p className="text-xs font-semibold text-slate-400 uppercase tracking-wider truncate">{title}</p>
                        <p className="text-[10px] text-slate-500 mt-2 font-medium flex items-center gap-1 truncate">
                            <span className={`w-1.5 h-1.5 rounded-full bg-${color}-500 inline-block`}></span> {subtitle}
                        </p>
                    </div>
                    <div className={`absolute -right-4 -bottom-4 w-24 h-24 bg-${color}-500/5 rounded-full blur-xl group-hover:bg-${color}-500/10 transition-all duration-500`}></div>
                </div>
            );

            const CompactActionButton = ({ icon, label, onClick, color }) => (
                <button 
                    onClick={onClick}
                    className="group flex flex-col items-center justify-center p-3 rounded-xl border border-slate-700/50 bg-slate-800/50 hover:bg-slate-800 transition-all duration-200 hover:border-slate-600 hover:shadow-md"
                >
                    <div className={`mb-2 text-${color}-400 group-hover:scale-110 transition-transform duration-200`}>
                        <i className={`fas ${icon} text-xl`}></i>
                    </div>
                    <span className="text-[10px] font-bold text-slate-300 uppercase tracking-wide group-hover:text-white">{label}</span>
                </button>
            );

            // FIX: Removed duplicate KPIStatsWidget definition from here. 
            // It is already defined and memoized globally above DashboardSummaryPage.

            // MODIFIED: Use Skeleton instead of Spinner
            if (isLoading) return <DashboardSkeleton />;

            // --- VIEW 1: ADMIN & MANAGER DASHBOARD ---
            if (userProfile.role !== 'Staff') {
                return (
                    // MODIFIED: Changed grid-cols-1 to grid-cols-2 on mobile with smaller gap
                    <div className="grid grid-cols-2 lg:grid-cols-6 gap-3 sm:gap-6 animate-fade-in pb-10">
                        
                        {/* 1. OPERATIONS CARD (Redesigned) */}
                        <div className="order-1 col-span-2 lg:col-span-2 relative p-5 rounded-2xl border border-slate-800 bg-slate-900 shadow-lg flex flex-col justify-between group hover:border-slate-700 transition-all h-full min-h-[160px]">
                            {/* Header Row */}
                            <div className="flex justify-between items-start mb-4">
                                <div className="flex items-center gap-3">
                                    <div className="w-10 h-10 rounded-xl bg-slate-800 flex items-center justify-center border border-slate-700 text-blue-400 shadow-sm">
                                        <i className="fas fa-network-wired text-lg"></i>
                                    </div>
                                    <div>
                                        <h3 className="text-sm font-bold text-white leading-tight">Operations</h3>
                                        <p className="text-[10px] text-slate-500 uppercase tracking-wide">System Overview</p>
                                    </div>
                                </div>
                                
                                {/* Petty Cash Pill */}
                                <div className={`px-3 py-1.5 rounded-lg border ${totalPettyCash < 0 ? 'bg-red-500/10 border-red-500/20 text-red-400' : 'bg-emerald-500/10 border-emerald-500/20 text-emerald-400'} flex flex-col items-end`}>
                                    <span className="text-[9px] uppercase font-bold opacity-70">Petty Cash</span>
                                    <span className="text-sm font-bold font-mono">{Utils.formatCurrency(totalPettyCash)}</span>
                                </div>
                            </div>

                            {/* Metrics Grid */}
                            <div className="grid grid-cols-2 gap-4 mt-auto">
                                {/* Metric 1: Staff */}
                                <div className="bg-slate-800/50 rounded-lg p-2.5 border border-slate-700/50 transition-colors group-hover:bg-slate-800/80">
                                    <div className="flex justify-between items-end mb-1">
                                        <span className="text-2xl font-bold text-white">{activeEmployees.length}</span>
                                        <span className="text-[10px] text-slate-400 uppercase font-bold mb-1">Active Staff</span>
                                    </div>
                                    {/* Mini Gender Bar */}
                                    <div className="w-full h-1 bg-slate-700 rounded-full overflow-hidden flex">
                                        <div style={{ width: `${activeEmployees.length > 0 ? (maleStaffCount / activeEmployees.length) * 100 : 0}%` }} className="bg-blue-500"></div>
                                        <div style={{ width: `${activeEmployees.length > 0 ? (femaleStaffCount / activeEmployees.length) * 100 : 0}%` }} className="bg-pink-500"></div>
                                    </div>
                                    <div className="flex justify-between mt-1 text-[8px] text-slate-500 font-medium">
                                        <span>{maleStaffCount} M</span>
                                        <span>{femaleStaffCount} F</span>
                                    </div>
                                </div>

                                {/* Metric 2: Shops */}
                                <div className="bg-slate-800/50 rounded-lg p-2.5 border border-slate-700/50 flex flex-col justify-center transition-colors group-hover:bg-slate-800/80">
                                    <div className="flex justify-between items-center mb-1">
                                        <span className="text-2xl font-bold text-white">{activeShopsCount}</span>
                                        <div className="p-1.5 bg-slate-700 rounded text-slate-400">
                                            <i className="fas fa-store text-xs"></i>
                                        </div>
                                    </div>
                                    <span className="text-[10px] text-slate-400 uppercase font-bold">Active Locations</span>
                                </div>
                            </div>
                        </div>

                        {/* 4. COMMAND CENTER (Order 2) */}
                        <div className="order-2 col-span-2 lg:order-2 lg:col-span-2 p-4 sm:p-5 rounded-2xl border border-slate-800 bg-slate-900 shadow-lg flex flex-col h-full min-h-[160px]">
                            <div className="flex items-center justify-between mb-4">
                                <div className="flex items-center gap-2">
                                    <i className="fas fa-bolt text-yellow-500"></i>
                                    <span className="text-sm font-bold text-white uppercase tracking-wide">Command Center</span>
                                </div>
                            </div>
                            <div className="grid grid-cols-4 lg:grid-cols-2 gap-2 sm:gap-3 flex-grow">
                                <CompactActionButton icon="fa-user-clock" label="Check In" color="blue" onClick={() => setActivePage('checkinme')} />
                                <CompactActionButton 
                                    icon="fa-user-plus" 
                                    label="Add Staff" 
                                    color="emerald" 
                                    onClick={() => setActivePage(`employees:add_new:${Date.now()}`)} 
                                />
                                <CompactActionButton icon="fa-file-invoice-dollar" label="Payroll" color="amber" onClick={() => setActivePage('payroll')} />
                                <CompactActionButton 
                                    icon="fa-list-check" 
                                    label="New Task" 
                                    color="lime" 
                                    onClick={() => setIsTaskModalOpen(true)} 
                                />
                            </div>
                        </div>

                        {/* 2. PENDING REQUESTS & AUDITS & MEETINGS (Order 3) */}
                        {/* MODIFIED: Changed layout to grid-cols-2 for consistent 2x2 grid on all screens */}
                        <div className="order-3 col-span-2 lg:order-3 lg:col-span-2 grid grid-cols-2 gap-3 sm:gap-4 h-full">
                            <div 
                                onClick={() => onNavigateWithTab('leaveRequest')}
                                className="relative p-4 sm:p-5 rounded-2xl border border-slate-800 bg-slate-900/50 shadow-lg group cursor-pointer hover:border-slate-700 hover:-translate-y-1 transition-all"
                            >
                                 <div className="flex justify-between items-start mb-1">
                                    <div className="p-1.5 rounded-lg bg-orange-500/10 text-orange-400 border border-orange-500/20">
                                        <i className="fas fa-calendar-minus text-sm"></i>
                                    </div>
                                    <span className="text-[10px] sm:text-xs font-bold text-slate-500 uppercase tracking-wider">Leave</span>
                                </div>
                                <div className="text-xl sm:text-2xl font-bold text-white mt-1">{pendingLeaves.length} <span className="text-[10px] sm:text-sm font-normal text-slate-400">Pending</span></div>
                                <div className="absolute -right-4 -bottom-4 w-12 h-12 bg-orange-500/5 rounded-full blur-xl group-hover:bg-orange-500/10 transition-all duration-500"></div>
                            </div>

                            <div 
                                onClick={() => onNavigateWithTab('otRequest')}
                                className="relative p-4 sm:p-5 rounded-2xl border border-slate-800 bg-slate-900/50 shadow-lg group cursor-pointer hover:border-slate-700 hover:-translate-y-1 transition-all"
                            >
                                 <div className="flex justify-between items-start mb-1">
                                    <div className="p-1.5 rounded-lg bg-purple-500/10 text-purple-400 border border-purple-500/20">
                                        <i className="fas fa-clock text-sm"></i>
                                    </div>
                                     <span className="text-[10px] sm:text-xs font-bold text-slate-500 uppercase tracking-wider">Overtime</span>
                                </div>
                                <div className="text-xl sm:text-2xl font-bold text-white mt-1">{pendingOTs.length} <span className="text-[10px] sm:text-sm font-normal text-slate-400">Pending</span></div>
                                <div className="absolute -right-4 -bottom-4 w-12 h-12 bg-purple-500/5 rounded-full blur-xl group-hover:bg-purple-500/10 transition-all duration-500"></div>
                            </div>

                            {/* Auditing Task Widget */}
                            <div 
                                onClick={() => setActivePage('tasks:kanban')}
                                className="relative p-4 sm:p-5 rounded-2xl border border-slate-800 bg-slate-900/50 shadow-lg group cursor-pointer hover:border-yellow-500/50 hover:-translate-y-1 transition-all"
                            >
                                 <div className="flex justify-between items-start mb-1">
                                    <div className="p-1.5 rounded-lg bg-yellow-500/10 text-yellow-400 border border-yellow-500/20">
                                        <i className="fas fa-clipboard-check text-sm"></i>
                                    </div>
                                     <span className="text-[10px] sm:text-xs font-bold text-slate-500 uppercase tracking-wider">Auditing</span>
                                </div>
                                <div className="text-xl sm:text-2xl font-bold text-white mt-1">
                                    {pendingAudits.length} <span className="text-[10px] sm:text-sm font-normal text-slate-400">Tasks</span>
                                </div>
                                {pendingAudits.length > 0 && (
                                    <span className="absolute top-4 right-4 flex h-3 w-3">
                                      <span className="animate-ping absolute inline-flex h-full w-full rounded-full bg-yellow-400 opacity-75"></span>
                                      <span className="relative inline-flex rounded-full h-3 w-3 bg-yellow-500"></span>
                                    </span>
                                )}
                                <div className="absolute -right-4 -bottom-4 w-12 h-12 bg-yellow-500/5 rounded-full blur-xl group-hover:bg-yellow-500/10 transition-all duration-500"></div>
                            </div>

                            {/* NEW: Upcoming Meetings Widget */}
                            <div 
                                onClick={() => setActivePage('tasks:meetingRoom')}
                                className="relative p-4 sm:p-5 rounded-2xl border border-slate-800 bg-slate-900/50 shadow-lg group cursor-pointer hover:border-blue-500/50 hover:-translate-y-1 transition-all"
                            >
                                 <div className="flex justify-between items-start mb-1">
                                    <div className="p-1.5 rounded-lg bg-blue-500/10 text-blue-400 border border-blue-500/20">
                                        <i className="fas fa-calendar-alt text-sm"></i>
                                    </div>
                                     <span className="text-[10px] sm:text-xs font-bold text-slate-500 uppercase tracking-wider">Meetings</span>
                                </div>
                                <div className="text-xl sm:text-2xl font-bold text-white mt-1">
                                    {upcomingMeetings.length} <span className="text-[10px] sm:text-sm font-normal text-slate-400">Upcoming</span>
                                </div>
                                {upcomingMeetings.length > 0 && (
                                    <div className="absolute top-4 right-4 text-[10px] text-blue-300 font-mono bg-blue-900/30 px-1.5 py-0.5 rounded border border-blue-500/20">
                                        {new Date(upcomingMeetings[0].date).getDate()}/{new Date(upcomingMeetings[0].date).getMonth() + 1}
                                    </div>
                                )}
                                <div className="absolute -right-4 -bottom-4 w-12 h-12 bg-blue-500/5 rounded-full blur-xl group-hover:bg-blue-500/10 transition-all duration-500"></div>
                            </div>
                        </div>

                        {/* 3. LIVE ATTENDANCE MONITOR (Order 4) */}
                        <div className="order-4 col-span-2 lg:order-4 lg:col-span-3 h-[500px] lg:h-auto">
                            <TeamStatusWidget userProfile={userProfile} db={db} />
                        </div>

                        {/* 5. KPI STATS (Order 5) */}
                        <div className="order-5 col-span-2 lg:order-5 lg:col-span-3 h-[500px] lg:h-auto">
                            {/* MODIFIED: Use stable handleScorecardNav */}
                            <KPIStatsWidget 
                                stats={kpiStats} 
                                title="Performance Scorecard" 
                                icon="fa-chart-pie" 
                                color="purple" 
                                onNavigate={handleScorecardNav}
                            />
                        </div>

                        {/* NEW: TOP 5 STATS WIDGET (Order 6 - New Widget) */}
                        <div className="order-6 col-span-2 lg:order-6 lg:col-span-2 h-[500px] lg:h-auto">
                            <TopStatsWidget topStats={topStats} loading={isLoading} />
                        </div>

                        {/* NEW POSITION: 7. BIRTHDAY CELEBRATIONS (Order 7) */}
                        <div className="order-7 col-span-2 lg:order-7 lg:col-span-2 h-full min-h-[120px]">
                            <BirthdayWidget employees={activeEmployees} compact={true} />
                        </div>

                        {/* NEW: MY ASSETS FOR ADMIN/MANAGER (Order 8) */}
                        <div className="order-8 col-span-2 lg:order-8 lg:col-span-2 h-[400px] lg:h-auto">
                             <MyAssetsWidget assets={myAssets} loading={assetsLoading} />
                        </div>

                        {/* NEW: Render Task Modal */}
                        <TaskModal 
                            isOpen={isTaskModalOpen} 
                            onClose={() => setIsTaskModalOpen(false)} 
                            onSave={handleSaveTask} 
                            task={null} 
                            userProfile={userProfile} 
                            kpis={kpis} 
                            employees={employees} 
                        />
                    </div>
                );
            }

            // --- VIEW 2: EMPLOYEE (STAFF) DASHBOARD ---
            return (
                <div className="space-y-6 animate-fade-in pb-10">
                    {/* MODIFIED: Changed to grid-cols-2 (2 columns) on mobile with smaller gap (gap-3) */}
                    <div className="grid grid-cols-2 lg:grid-cols-4 gap-3 sm:gap-6">
                        <DashboardMetricCard title="Work Days" value={myStats.workDays} subtitle="This Month" icon="fa-calendar-check" color="blue" />
                        <DashboardMetricCard title="Late Count" value={myStats.lateCount} subtitle="Deductions" icon="fa-user-clock" color={myStats.lateCount > 0 ? "red" : "green"} />
                        <DashboardMetricCard title="OT Days" value={myStats.otDays.toFixed(1)} subtitle="Approved" icon="fa-business-time" color="purple" />
                        {/* NEW: Added Engagement Card */}
                        <DashboardMetricCard title="Engagement" value={Utils.formatCurrency(myStats.engagementAmount)} subtitle="Bonuses" icon="fa-hand-holding-dollar" color="teal" />
                    </div>

                    <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <div className="lg:col-span-2">
                            {/* NEW: Team Status Widget */}
                            <TeamStatusWidget userProfile={userProfile} db={db} />
                        </div>
                        <div className="lg:col-span-1 h-[400px] lg:h-auto">
                            {/* MODIFIED: Replaced generic KPIStatsWidget with detailed StaffPerformanceWidget */}
                            <StaffPerformanceWidget 
                                stats={kpiStats} 
                                loading={isLoading}
                                onNavigate={() => setActivePage('tasks:scorecard')} 
                            />
                        </div>
                    </div>

                    {/* Tracker & Assets & Birthdays Row */}
                    <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        {/* Birthday Widget for Staff */}
                        <div className="lg:col-span-1 h-[400px] lg:h-auto">
                            {/* FIX: Use activeSocialEmployees so staff can see colleagues' birthdays */}
                            <BirthdayWidget employees={activeSocialEmployees} />
                        </div>

                        {/* NEW: My Assets Widget */}
                        <div className="lg:col-span-1 h-[400px] lg:h-auto">
                             <MyAssetsWidget assets={myAssets} loading={assetsLoading} />
                        </div>

                        {/* Request Tracker - Adjusted to col-span-1 */}
                        <div className="bg-slate-900 rounded-2xl border border-slate-800 shadow-lg overflow-hidden flex flex-col h-full lg:col-span-1">
                            <div className="p-5 border-b border-slate-800 flex justify-between items-center bg-slate-900/80">
                                <div className="flex items-center gap-3">
                                    <div className="p-2 bg-blue-500/10 rounded-lg text-blue-400"><i className="fas fa-list-ul"></i></div>
                                    <h3 className="text-lg font-bold text-white">My Requests</h3>
                                </div>
                                <button onClick={() => setActivePage('checkinme')} className="text-xs font-bold text-blue-400 hover:text-blue-300">VIEW ALL</button>
                            </div>
                            <div className="flex-1 overflow-hidden">
                                {myRecentRequests.length === 0 ? (
                                    <p className="text-slate-500 text-sm text-center py-10">No recent requests found.</p>
                                ) : (
                                    <div className="divide-y divide-slate-800/50">
                                        {myRecentRequests.map((req, idx) => (
                                            <div key={idx} className="p-4 flex justify-between items-center hover:bg-slate-800/30 transition-colors">
                                                <div>
                                                    <div className="flex items-center gap-2 mb-1">
                                                        <span className={`text-xs font-bold px-2 py-0.5 rounded-md ${req.type === 'Leave' ? 'bg-pink-500/10 text-pink-400' : 'bg-purple-500/10 text-purple-400'}`}>{req.type}</span>
                                                        <span className="text-sm font-semibold text-slate-200">{req.type === 'Leave' ? `${req.numberOfDays} Day(s)` : `${req.numberOfOTDays} Day(s)`}</span>
                                                    </div>
                                                    <p className="text-xs text-slate-500">Submitted: {Utils.formatRequestDate(req.requestDate || req.submissionDate)}</p>
                                                </div>
                                                <div>
                                                    <span className={`px-3 py-1 text-xs font-bold rounded-full border ${
                                                        req.status === 'Approved' ? 'bg-green-500/10 text-green-400 border-green-500/20' :
                                                        req.status === 'Rejected' ? 'bg-red-500/10 text-red-400 border-red-500/20' :
                                                        'bg-yellow-500/10 text-yellow-400 border-yellow-500/20'
                                                    }`}>{req.status}</span>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                )}
                            </div>
                        </div>
                    </div>
                </div>
            );
        }); // FIX: Added closing parenthesis ')' for the memo wrapper
        // --- END DASHBOARD SUMMARY PAGE ---

        // --- START POLICY BOARD PAGE ---
        
        // NEW: Modal for Creating/Editing Policies
        const PolicyModal = ({ isOpen, onClose, onSave, policy }) => {
            const [formData, setFormData] = useState({ title: '', category: 'General', content: '' });
            
            useEffect(() => {
                if (isOpen) {
                    setFormData(policy ? { ...policy } : { title: '', category: 'General', content: '' });
                }
            }, [isOpen, policy]);

            const handleChange = (e) => {
                const { name, value } = e.target;
                setFormData(prev => ({ ...prev, [name]: value }));
            };

            const handleSubmit = (e) => {
                e.preventDefault();
                onSave(formData);
            };

            return (
                <Modal isOpen={isOpen} onClose={onClose} maxWidth="max-w-3xl">
                    <form onSubmit={handleSubmit} className="flex flex-col h-full overflow-hidden">
                        <ModalHeader title={policy ? "Edit Policy" : "New Policy"} onClose={onClose} />
                        <ModalBody>
                            <div className="space-y-4">
                                <div>
                                    <label className="text-sm font-medium text-slate-400">Title</label>
                                    <input name="title" value={formData.title} onChange={handleChange} className="input" required placeholder="e.g., Dress Code Policy" />
                                </div>
                                <div>
                                    <label className="text-sm font-medium text-slate-400">Category</label>
                                    <select name="category" value={formData.category} onChange={handleChange} className="select">
                                        <option>General</option>
                                        <option>HR</option>
                                        <option>IT & Security</option>
                                        <option>Safety</option>
                                        <option>Finance</option>
                                        <option>Operations</option>
                                    </select>
                                </div>
                                <div className="flex-1">
                                    <label className="text-sm font-medium text-slate-400 mb-2 block">Content (HTML Supported)</label>
                                    <textarea 
                                        name="content" 
                                        value={formData.content} 
                                        onChange={handleChange} 
                                        className="input h-64 font-mono text-sm leading-relaxed" 
                                        required
                                        placeholder="<p>Enter policy details here...</p>"
                                    ></textarea>
                                </div>
                            </div>
                        </ModalBody>
                        <ModalFooter>
                            <Button variant="secondary" onClick={onClose}>Cancel</Button>
                            <Button type="submit" variant="primary">Save Policy</Button>
                        </ModalFooter>
                    </form>
                </Modal>
            );
        };

        // NEW: Modal for Reading Policies
        // MODIFIED: Added onRead prop and effect to trigger read status
        const PolicyReadModal = ({ isOpen, onClose, policy, onRead }) => {
            
            useEffect(() => {
                if (isOpen && policy && onRead) {
                    onRead(policy);
                }
            }, [isOpen, policy]);

            if (!policy) return null;
            return (
                <Modal isOpen={isOpen} onClose={onClose} maxWidth="max-w-4xl">
                    <div className="flex flex-col h-[85vh]">
                        <div className="p-6 border-b border-slate-700 bg-slate-800 shrink-0 flex justify-between items-start">
                            <div>
                                <span className="inline-block px-2 py-1 mb-2 text-xs font-bold text-blue-300 bg-blue-900/50 rounded uppercase tracking-wider">
                                    {policy.category || 'General'}
                                </span>
                                <h2 className="text-2xl font-bold text-white leading-tight">{policy.title}</h2>
                            </div>
                            <button onClick={onClose} className="text-slate-400 hover:text-white transition-colors">
                                <i className="fas fa-times text-2xl"></i>
                            </button>
                        </div>
                        <div className="p-8 overflow-y-auto bg-slate-900/50 flex-1">
                            <div 
                                className="policy-content prose prose-invert max-w-none text-slate-300 leading-7"
                                dangerouslySetInnerHTML={{ __html: DOMPurify.sanitize(policy.content) }}
                            />
                        </div>
                        <div className="p-4 bg-slate-800 border-t border-slate-700 shrink-0 text-xs text-slate-500 flex justify-between items-center">
                            <span>Last Updated: {policy.updatedAt?.toDate ? policy.updatedAt.toDate().toLocaleDateString() : 'N/A'}</span>
                            <Button variant="primary" onClick={onClose} className="px-6">Close</Button>
                        </div>
                    </div>
                </Modal>
            );
        };

        // --- NEW COMPONENT: Read Stats Modal (For Notice Board Admin) ---
        const ReadStatsModal = ({ isOpen, onClose, notice }) => {
            const { employees } = useAppData();
            
            const stats = useMemo(() => {
                if (!notice || !employees) return { read: [], unread: [], percent: 0 };

                // 1. Determine Target Audience based on notice.targetShops
                const targetAudience = employees.filter(emp => {
                    if (emp.status !== 'Active') return false;
                    // If no target shops, it's global (all active staff)
                    if (!notice.targetShops || notice.targetShops.length === 0) return true;
                    
                    const empShops = Array.isArray(emp.shop) ? emp.shop : [emp.shop];
                    // Check intersection: Does employee work in ANY of the target shops?
                    return empShops.some(s => notice.targetShops.includes(s));
                });

                // 2. Split into Read vs Unread
                const readIds = new Set(notice.readBy || []);
                const read = [];
                const unread = [];

                targetAudience.forEach(emp => {
                    if (readIds.has(emp.id)) {
                        read.push(emp);
                    } else {
                        unread.push(emp);
                    }
                });

                const percent = targetAudience.length > 0 ? Math.round((read.length / targetAudience.length) * 100) : 0;

                return { read, unread, percent, total: targetAudience.length };
            }, [notice, employees]);

            if (!isOpen || !notice) return null;

            return (
                <Modal isOpen={isOpen} onClose={onClose} maxWidth="max-w-3xl">
                    <ModalHeader title="Engagement Statistics" onClose={onClose} />
                    <ModalBody>
                        <div className="mb-6 p-4 bg-slate-700/30 rounded-xl border border-slate-600/50">
                            <h3 className="text-lg font-bold text-white mb-2">{notice.title}</h3>
                            <div className="flex justify-between items-end mb-2">
                                <p className="text-xs text-slate-400 uppercase font-bold tracking-wider">Read Completion</p>
                                <span className="text-xl font-bold text-white">{stats.percent}% <span className="text-sm text-slate-500 font-normal">({stats.read.length}/{stats.total})</span></span>
                            </div>
                            <div className="w-full bg-slate-700 rounded-full h-3 overflow-hidden">
                                <div className="bg-gradient-to-r from-green-500 to-emerald-400 h-full transition-all duration-1000 ease-out" style={{ width: `${stats.percent}%` }}></div>
                            </div>
                        </div>

                        <div className="grid grid-cols-1 sm:grid-cols-2 gap-4 h-[400px]">
                            {/* Read Column */}
                            <div className="bg-slate-900/50 rounded-xl border border-green-900/30 flex flex-col overflow-hidden">
                                <div className="p-3 bg-green-900/20 border-b border-green-900/30 flex justify-between items-center">
                                    <span className="text-green-400 font-bold text-xs uppercase"><i className="fas fa-check-circle mr-2"></i>Read ({stats.read.length})</span>
                                </div>
                                <div className="p-2 overflow-y-auto custom-scrollbar flex-1 space-y-1">
                                    {stats.read.map(emp => (
                                        <div key={emp.id} className="flex items-center gap-3 p-2 rounded hover:bg-slate-800/50 transition-colors">
                                            <div className="w-8 h-8 rounded-full bg-green-500/20 text-green-400 flex items-center justify-center text-xs font-bold border border-green-500/30">
                                                {emp.name.charAt(0)}
                                            </div>
                                            <div>
                                                <p className="text-xs text-slate-200 font-bold">{emp.name}</p>
                                                <p className="text-[10px] text-slate-500">{Array.isArray(emp.shop) ? emp.shop[0] : emp.shop}</p>
                                            </div>
                                        </div>
                                    ))}
                                    {stats.read.length === 0 && <p className="text-center text-xs text-slate-600 py-10 italic">No one has read this yet.</p>}
                                </div>
                            </div>

                            {/* Unread Column */}
                            <div className="bg-slate-900/50 rounded-xl border border-red-900/30 flex flex-col overflow-hidden">
                                <div className="p-3 bg-red-900/20 border-b border-red-900/30 flex justify-between items-center">
                                    <span className="text-red-400 font-bold text-xs uppercase"><i className="fas fa-times-circle mr-2"></i>Pending ({stats.unread.length})</span>
                                </div>
                                <div className="p-2 overflow-y-auto custom-scrollbar flex-1 space-y-1">
                                    {stats.unread.map(emp => (
                                        <div key={emp.id} className="flex items-center gap-3 p-2 rounded hover:bg-slate-800/50 transition-colors">
                                            <div className="w-8 h-8 rounded-full bg-red-500/20 text-red-400 flex items-center justify-center text-xs font-bold border border-red-500/30">
                                                {emp.name.charAt(0)}
                                            </div>
                                            <div>
                                                <p className="text-xs text-slate-200 font-bold">{emp.name}</p>
                                                <p className="text-[10px] text-slate-500">{Array.isArray(emp.shop) ? emp.shop[0] : emp.shop}</p>
                                            </div>
                                        </div>
                                    ))}
                                    {stats.unread.length === 0 && <p className="text-center text-xs text-slate-600 py-10 italic">All caught up!</p>}
                                </div>
                            </div>
                        </div>
                    </ModalBody>
                    <ModalFooter>
                        <Button variant="secondary" onClick={onClose}>Close</Button>
                    </ModalFooter>
                </Modal>
            );
        };

        // REDESIGNED: Policy Board Tab (Renamed from Page)
        const PolicyBoardTab = ({ userProfile }) => {
            const { db } = useFirebase();
            const { data: policies, loading } = useCollection('policies');
            // MODIFIED: Imported needed functions
            const { doc, updateDoc, arrayUnion } = window.firebaseSDK;
            
            const [searchTerm, setSearchTerm] = useState('');
            const [isModalOpen, setModalOpen] = useState(false);
            const [editingPolicy, setEditingPolicy] = useState(null);
            const [policyToDelete, setPolicyToDelete] = useState(null);
            const [policyToRead, setPolicyToRead] = useState(null); 
            // MODIFIED: Added state for stats modal
            const [statsPolicy, setStatsPolicy] = useState(null);

            const isAdmin = userProfile?.role === 'Admin' || userProfile?.role === 'CEO';

            const categorizedPolicies = useMemo(() => {
                const filtered = policies.filter(p =>
                    (p.title?.toLowerCase() || '').includes(searchTerm.toLowerCase()) ||
                    (p.content?.toLowerCase() || '').includes(searchTerm.toLowerCase())
                );

                const grouped = filtered.reduce((acc, policy) => {
                    const category = policy.category || 'General';
                    if (!acc[category]) {
                        acc[category] = [];
                    }
                    acc[category].push(policy);
                    return acc;
                }, {});

                for (const category in grouped) {
                    grouped[category].sort((a, b) => a.title.localeCompare(b.title));
                }
                return grouped;
            }, [policies, searchTerm]);

            const sortedCategories = useMemo(() => Object.keys(categorizedPolicies).sort(), [categorizedPolicies]);

            const handleOpenModal = useCallback((policy = null) => { setEditingPolicy(policy); setModalOpen(true); }, []);
            const handleCloseModal = useCallback(() => { setEditingPolicy(null); setModalOpen(false); }, []);
            
            const handleReadPolicy = useCallback((policy) => { setPolicyToRead(policy); }, []);
            const handleCloseReadModal = useCallback(() => { setPolicyToRead(null); }, []);

            // NEW: Function to mark policy as read in Firestore
            const handleMarkAsRead = useCallback(async (policy) => {
                if (!userProfile?.id || !policy?.id) return;
                // Optimization: Don't write if already in the list
                if (policy.readBy && policy.readBy.includes(userProfile.id)) return;

                try {
                    const policyRef = doc(db, 'policies', policy.id);
                    await updateDoc(policyRef, {
                        readBy: arrayUnion(userProfile.id)
                    });
                } catch (error) {
                    console.error("Error marking policy as read:", error);
                }
            }, [db, userProfile]);

            const handleSavePolicy = useCallback(async (policyData) => {
                const { addDoc, updateDoc, doc, collection, serverTimestamp } = window.firebaseSDK;
                const dataToSave = { ...policyData };
                try {
                    if (dataToSave.id) {
                        const { id, ...data } = dataToSave;
                        await updateDoc(doc(db, 'policies', id), { ...data, updatedAt: serverTimestamp() });
                    } else {
                        await addDoc(collection(db, 'policies'), { ...dataToSave, createdAt: serverTimestamp(), updatedAt: serverTimestamp(), readBy: [] }); // Initialize readBy
                    }
                    handleCloseModal();
                } catch (error) {
                    console.error("Error saving policy:", error);
                }
            }, [db, handleCloseModal]);

            const handleDeleteConfirm = useCallback(async () => {
                if (!policyToDelete) return;
                try {
                    await window.firebaseSDK.deleteDoc(window.firebaseSDK.doc(db, 'policies', policyToDelete.id));
                } catch (error) {
                    console.error("Error deleting policy:", error);
                } finally {
                    setPolicyToDelete(null);
                }
            }, [db, policyToDelete]);

            return (
                <div className="space-y-8 animate-fade-in pb-12">
                    {/* Hero Section */}
                    <div className="relative overflow-hidden rounded-3xl bg-gradient-to-r from-slate-800 to-slate-900 border border-slate-700 p-8 flex flex-col md:flex-row items-center justify-between shadow-2xl">
                        <div className="z-10 max-w-2xl relative">
                            <div className="inline-flex items-center gap-2 px-3 py-1 rounded-full bg-blue-500/10 border border-blue-500/20 text-blue-300 text-xs font-bold uppercase tracking-wider mb-3">
                                <i className="fas fa-book"></i> Knowledge Base
                            </div>
                            <h1 className="text-3xl md:text-4xl font-bold text-white mb-2 tracking-tight">Policy Reading Center</h1>
                            <p className="text-slate-400 text-lg leading-relaxed">Stay informed about our company guidelines, protocols, and employee handbooks.</p>
                        </div>
                        <div className="mt-6 md:mt-0 z-10 flex gap-3 w-full md:w-auto items-center">
                                <div className="relative w-full md:w-64">
                                <i className="fas fa-search absolute left-4 top-3.5 text-slate-500"></i>
                                <input 
                                    type="text" 
                                    placeholder="Search policies..." 
                                    value={searchTerm} 
                                    onChange={e => setSearchTerm(e.target.value)} 
                                    className="w-full bg-slate-950/50 border border-slate-700 text-slate-200 text-sm rounded-xl focus:ring-blue-500 focus:border-blue-500 block pl-10 p-3 shadow-inner transition-all placeholder-slate-500" 
                                />
                            </div>
                            {isAdmin && (
                                <button onClick={() => handleOpenModal()} className="bg-blue-600 hover:bg-blue-500 text-white w-11 h-11 rounded-xl shadow-lg transition-transform active:scale-95 flex items-center justify-center shrink-0 border border-blue-500/50" title="Add New Policy">
                                    <i className="fas fa-plus text-lg"></i>
                                </button>
                            )}
                        </div>
                        {/* Decor */}
                        <div className="absolute top-0 right-0 -mr-16 -mt-16 w-64 h-64 bg-blue-500/10 rounded-full blur-3xl"></div>
                        <div className="absolute bottom-0 left-0 -ml-16 -mb-16 w-48 h-48 bg-purple-500/10 rounded-full blur-3xl"></div>
                    </div>

                    {loading ? (
                        <div className="text-center py-20"><i className="fas fa-spinner fa-spin text-4xl text-blue-500"></i><p className="mt-4 text-slate-500">Loading Library...</p></div>
                    ) : (
                        <div className="space-y-12">
                            {sortedCategories.length > 0 ? sortedCategories.map(category => (
                                <div key={category} className="animate-fade-in">
                                    <div className="flex items-center gap-4 mb-6">
                                        <div className="w-1 h-6 bg-blue-500 rounded-full"></div>
                                        <h3 className="text-xl font-bold text-slate-200 uppercase tracking-widest">{category}</h3>
                                        <div className="h-px flex-1 bg-slate-800"></div>
                                    </div>
                                    
                                    <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                                        {categorizedPolicies[category].map(policy => {
                                            // Check read status
                                            const isRead = (policy.readBy || []).includes(userProfile.id);

                                            return (
                                            <div 
                                                    key={policy.id} 
                                                    onClick={() => handleReadPolicy(policy)}
                                                    className="group relative bg-slate-800/60 rounded-2xl p-6 border border-slate-700/50 hover:border-blue-500/30 hover:bg-slate-800 transition-all duration-300 cursor-pointer shadow-lg hover:shadow-blue-900/10 hover:-translate-y-1 flex flex-col h-full overflow-hidden"
                                            >
                                                    {/* Top Decoration Line */}
                                                    <div className="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-blue-500/0 via-blue-500/50 to-blue-500/0 opacity-0 group-hover:opacity-100 transition-opacity"></div>

                                                    {/* Icon / Actions Header */}
                                                    <div className="flex items-start justify-between mb-5">
                                                        <div className="w-12 h-12 rounded-xl bg-slate-700/50 group-hover:bg-blue-600/10 border border-white/5 group-hover:border-blue-500/20 flex items-center justify-center transition-all duration-300">
                                                            <i className={`fas ${isRead ? 'fa-check text-green-400' : 'fa-book-open text-slate-400'} text-xl group-hover:text-blue-400 transition-colors`}></i>
                                                        </div>
                                                        {isAdmin && (
                                                            <div className="flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity duration-200 bg-slate-900/80 rounded-lg p-1 border border-slate-700" onClick={e => e.stopPropagation()}>
                                                                    {/* NEW: Stats Button */}
                                                                    <button onClick={() => setStatsPolicy(policy)} className="w-8 h-8 flex items-center justify-center rounded-md text-slate-400 hover:text-green-400 hover:bg-slate-800 transition-colors" title="View Read Stats"><i className="fas fa-chart-pie text-xs"></i></button>
                                                                    
                                                                    <button onClick={() => handleOpenModal(policy)} className="w-8 h-8 flex items-center justify-center rounded-md text-slate-400 hover:text-blue-400 hover:bg-slate-800 transition-colors"><i className="fas fa-pen text-xs"></i></button>
                                                                    <button onClick={() => setPolicyToDelete(policy)} className="w-8 h-8 flex items-center justify-center rounded-md text-slate-400 hover:text-red-400 hover:bg-slate-800 transition-colors"><i className="fas fa-trash text-xs"></i></button>
                                                            </div>
                                                        )}
                                                    </div>
                                                    
                                                    {/* Content Snippet */}
                                                    <div className="flex-1">
                                                        <h4 className="text-lg font-bold text-slate-100 mb-2 line-clamp-2 leading-snug group-hover:text-blue-300 transition-colors">
                                                                {policy.title}
                                                        </h4>
                                                        <p className="text-sm text-slate-400 line-clamp-3 leading-relaxed mb-4 font-light">
                                                                {/* Strip HTML tags for clean preview text */}
                                                                {policy.content.replace(/<[^>]+>/g, '').substring(0, 120)}...
                                                        </p>
                                                    </div>

                                                    {/* Footer Meta */}
                                                    <div className="pt-4 border-t border-slate-700/50 flex justify-between items-center text-[11px] text-slate-500 font-medium uppercase tracking-wide">
                                                        <span>{new Date(policy.updatedAt?.toDate() || Date.now()).toLocaleDateString(undefined, {month: 'short', day: 'numeric'})}</span>
                                                        <span className={`group-hover:translate-x-1 transition-transform flex items-center gap-1 ${isRead ? 'text-green-500' : 'text-blue-500/80 group-hover:text-blue-400'}`}>
                                                                {isRead ? 'Read ' : <>Read <i className="fas fa-arrow-right text-[10px]"></i></>}
                                                        </span>
                                                    </div>
                                            </div>
                                        );
                                        })}
                                    </div>
                                </div>
                            )) : (
                                <div className="text-center py-32 opacity-50">
                                    <div className="inline-flex items-center justify-center w-24 h-24 rounded-full bg-slate-800 mb-6">
                                        <i className="fas fa-search text-4xl text-slate-600"></i>
                                    </div>
                                    <h3 className="text-2xl font-bold text-slate-300 mb-2">No policies found</h3>
                                    <p className="text-slate-500">Try adjusting your search terms or category.</p>
                                </div>
                            )}
                        </div>
                    )}
                    <PolicyModal isOpen={isModalOpen} onClose={handleCloseModal} onSave={handleSavePolicy} policy={editingPolicy} />
                    <ConfirmationModal isOpen={!!policyToDelete} onClose={() => setPolicyToDelete(null)} onConfirm={handleDeleteConfirm} title="Delete Policy" message={`Are you sure you want to delete the policy "${policyToDelete?.title}"? This action cannot be undone.`} />
                    {/* MODIFIED: Pass handleMarkAsRead to the read modal */}
                    <PolicyReadModal isOpen={!!policyToRead} onClose={handleCloseReadModal} policy={policyToRead} onRead={handleMarkAsRead} />
                    
                    {/* NEW: Stats Modal for Policies */}
                    <ReadStatsModal 
                        isOpen={!!statsPolicy} 
                        onClose={() => setStatsPolicy(null)} 
                        notice={statsPolicy} 
                    />
                </div>
            );
        };
        // --- END POLICY BOARD PAGE ---

        // --- START NOTICE BOARD PAGE (PHASE 1) (Renamed to Tab) ---
        
        // NEW: Component for Individual Notice Card with Like/Comment Support
        // OPTIMIZATION: Wrapped in memo to prevent unnecessary re-renders when parent state changes
        const NoticeCard = memo(({ notice, userProfile, canManage, onEdit, onDelete, onMarkRead, onViewStats, employees }) => {
            const { db } = useFirebase();
            // MODIFIED: Added 'limit' to destructuring
            const { doc, updateDoc, arrayUnion, arrayRemove, collection, addDoc, serverTimestamp, query, orderBy, onSnapshot, deleteDoc, increment, limit } = window.firebaseSDK;
            
            const [showComments, setShowComments] = useState(false);
            const [comments, setComments] = useState([]);
            const [newComment, setNewComment] = useState('');
            const [isSubmittingComment, setIsSubmittingComment] = useState(false);
            const [showLikesModal, setShowLikesModal] = useState(false);
            
            // NEW: State for "See More" truncation
            const [isExpanded, setIsExpanded] = useState(false);
            
            // NEW: State for Editing Comments
            const [editingCommentId, setEditingCommentId] = useState(null);
            const [editText, setEditText] = useState('');

            // NEW: State for Latest Comment Preview
            const [latestComment, setLatestComment] = useState(null);

            const isLiked = (notice.likes || []).includes(userProfile.id);
            const likeCount = (notice.likes || []).length;
            const isRead = (notice.readBy || []).includes(userProfile.id);

            // Resolve Author Info
            const author = employees ? employees.find(e => e.id === notice.authorId) : null;
            const authorPhoto = author ? author.photo : null;
            const authorName = notice.authorName || 'System Admin';
            const authorRole = author ? author.position : 'Admin';

            // Helper: Time Ago
            const timeAgo = (date) => {
                if (!date) return 'Just now';
                const d = date.toDate ? date.toDate() : new Date(date);
                const seconds = Math.floor((new Date() - d) / 1000);
                let interval = seconds / 31536000;
                if (interval > 1) return Math.floor(interval) + "y";
                interval = seconds / 2592000;
                if (interval > 1) return Math.floor(interval) + "mo";
                interval = seconds / 86400;
                if (interval > 1) return Math.floor(interval) + "d";
                interval = seconds / 3600;
                if (interval > 1) return Math.floor(interval) + "h";
                interval = seconds / 60;
                if (interval > 1) return Math.floor(interval) + "m";
                return "Just now";
            };

            // NEW: Fetch Latest Comment Always (For Preview)
            useEffect(() => {
                if (!db || !notice.id) return;
                // Query for the single latest comment
                const q = query(collection(db, 'memoAlerts', notice.id, 'comments'), orderBy('createdAt', 'desc'), limit(1));
                const unsubscribe = onSnapshot(q, (snapshot) => {
                    if (!snapshot.empty) {
                        setLatestComment({ id: snapshot.docs[0].id, ...snapshot.docs[0].data() });
                    } else {
                        setLatestComment(null);
                    }
                });
                return () => unsubscribe();
            }, [notice.id, db]);

            // Fetch comments real-time ONLY when section is open
            useEffect(() => {
                if (!showComments || !notice.id) return;
                
                const q = query(collection(db, 'memoAlerts', notice.id, 'comments'), orderBy('createdAt', 'asc'));
                const unsubscribe = onSnapshot(q, (snapshot) => {
                    setComments(snapshot.docs.map(d => ({ id: d.id, ...d.data() })));
                });
                
                return () => unsubscribe();
            }, [showComments, notice.id, db]);

            const likers = useMemo(() => {
                if (!notice.likes || !employees) return [];
                return notice.likes.map(id => {
                    const emp = employees.find(e => e.id === id);
                    return emp ? { name: emp.name, photo: emp.photo } : { name: 'Unknown User', photo: null };
                });
            }, [notice.likes, employees]);

            const handleToggleLike = async () => {
                try {
                    const ref = doc(db, 'memoAlerts', notice.id);
                    if (isLiked) {
                        await updateDoc(ref, { likes: arrayRemove(userProfile.id) });
                    } else {
                        await updateDoc(ref, { likes: arrayUnion(userProfile.id) });
                    }
                } catch (err) {
                    console.error("Like error:", err);
                }
            };

            const handleAddComment = async (e) => {
                e.preventDefault();
                if (!newComment.trim()) return;
                setIsSubmittingComment(true);
                try {
                    await addDoc(collection(db, 'memoAlerts', notice.id, 'comments'), {
                        text: newComment,
                        userId: userProfile.id,
                        userName: userProfile.name,
                        createdAt: serverTimestamp()
                    });
                    await updateDoc(doc(db, 'memoAlerts', notice.id), { commentCount: increment(1) });
                    setNewComment('');
                } catch (err) {
                    console.error("Comment error:", err);
                } finally {
                    setIsSubmittingComment(false);
                }
            };

            const handleDeleteComment = async (e, commentId) => {
                if (e) { e.preventDefault(); e.stopPropagation(); }
                if (!window.confirm("Are you sure you want to delete this comment?")) return;
                try {
                    await deleteDoc(doc(db, 'memoAlerts', notice.id, 'comments', commentId));
                    try { await updateDoc(doc(db, 'memoAlerts', notice.id), { commentCount: increment(-1) }); } catch (countError) {}
                } catch (err) { console.error("Error deleting comment:", err); }
            };

            const handleStartEdit = (comment, e) => {
                if (e) { e.preventDefault(); e.stopPropagation(); }
                setEditingCommentId(comment.id);
                setEditText(comment.text);
            };

            const handleSaveEdit = async (commentId) => {
                if (!editText.trim()) return;
                try {
                    await updateDoc(doc(db, 'memoAlerts', notice.id, 'comments', commentId), { text: editText, updatedAt: serverTimestamp() });
                    setEditingCommentId(null);
                    setEditText('');
                } catch (err) { console.error("Error updating comment:", err); }
            };
            
            const formatCommentTime = (timestamp) => {
                if (!timestamp) return 'Just now';
                const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
                const now = new Date();
                const diffMs = now - date;
                const diffMins = Math.floor(diffMs / 60000);
                if (diffMins < 1) return 'Just now';
                if (diffMins < 60) return `${diffMins}m`;
                const diffHours = Math.floor(diffMins / 60);
                if (diffHours < 24) return `${diffHours}h`;
                return date.toLocaleDateString();
            };

            // Truncation Logic
            const contentLimit = 280;
            const isLongContent = notice.content && notice.content.length > contentLimit;
            const displayContent = isExpanded || !isLongContent ? notice.content : `${notice.content.slice(0, contentLimit)}...`;

            return (
                <div className={`
                    relative group transition-all duration-300 mb-6
                    bg-[#1E293B] border border-slate-700/60 shadow-lg 
                    rounded-2xl overflow-hidden
                    ${!isRead && !canManage ? 'ring-1 ring-yellow-500/50 shadow-yellow-500/10' : 'hover:border-slate-600'}
                `}>
                    {/* NEW: Unread Dot Indicator (Cleaner than a big badge) */}
                    {!isRead && !canManage && (
                        <div className="absolute top-4 right-4 w-2.5 h-2.5 bg-yellow-500 rounded-full animate-pulse z-10 shadow-sm shadow-yellow-500/50"></div>
                    )}

                    {/* --- CARD HEADER --- */}
                    <div className="p-4 flex justify-between items-start">
                        <div className="flex gap-3 items-center">
                            {/* Avatar */}
                            <div className="w-10 h-10 rounded-full bg-slate-700 border border-slate-600 flex items-center justify-center overflow-hidden shrink-0 shadow-inner">
                                {authorPhoto ? (
                                    <img src={authorPhoto} alt={authorName} className="w-full h-full object-cover" />
                                ) : (
                                    <span className="text-sm font-bold text-slate-400">{authorName.charAt(0)}</span>
                                )}
                            </div>
                            
                            {/* Meta Info */}
                            <div className="flex flex-col min-w-0">
                                <h4 className="font-bold text-white text-sm leading-tight truncate pr-4">{authorName}</h4>
                                <div className="flex items-center gap-1.5 text-[11px] text-slate-400 mt-0.5">
                                    <span className="text-slate-500">{authorRole}</span>
                                    <span className="text-slate-600"></span>
                                    <span>{timeAgo(notice.createdAt)}</span>
                                    <span className="text-slate-600"></span>
                                    {notice.targetShops && notice.targetShops.length > 0 ? (
                                        <div className="flex items-center gap-1 bg-blue-500/10 text-blue-400 px-1.5 py-0.5 rounded text-[10px] font-medium">
                                            <i className="fas fa-store"></i> 
                                            <span className="truncate max-w-[80px]">{notice.targetShops.length > 1 ? 'Multiple' : notice.targetShops[0]}</span>
                                        </div>
                                    ) : (
                                        <div className="flex items-center gap-1 bg-slate-700/50 text-slate-400 px-1.5 py-0.5 rounded text-[10px] font-medium">
                                            <i className="fas fa-globe"></i> Global
                                        </div>
                                    )}
                                </div>
                            </div>
                        </div>
                        
                        {/* Admin Actions Dropdown */}
                        {canManage && (
                            <div className="relative group/menu ml-auto">
                                <button className="w-8 h-8 rounded-full hover:bg-slate-700/50 flex items-center justify-center text-slate-400 hover:text-white transition-colors">
                                    <i className="fas fa-ellipsis-h"></i>
                                </button>
                                <div className="absolute right-0 mt-1 w-32 bg-slate-800 border border-slate-700 rounded-xl shadow-xl py-1 hidden group-hover/menu:block z-20 animate-fade-in origin-top-right">
                                    <button onClick={() => onViewStats(notice)} className="w-full text-left px-3 py-2 text-xs font-medium text-slate-300 hover:bg-slate-700 hover:text-white flex items-center gap-2">
                                        <i className="fas fa-chart-pie text-blue-400 w-4 text-center"></i> Analytics
                                    </button>
                                    <button onClick={() => onEdit(notice)} className="w-full text-left px-3 py-2 text-xs font-medium text-slate-300 hover:bg-slate-700 hover:text-white flex items-center gap-2">
                                        <i className="fas fa-edit text-yellow-400 w-4 text-center"></i> Edit
                                    </button>
                                    <div className="h-px bg-slate-700/50 my-1"></div>
                                    <button onClick={() => onDelete(notice)} className="w-full text-left px-3 py-2 text-xs font-medium text-red-400 hover:bg-red-900/20 flex items-center gap-2">
                                        <i className="fas fa-trash w-4 text-center"></i> Delete
                                    </button>
                                </div>
                            </div>
                        )}
                    </div>

                    {/* --- CARD CONTENT --- */}
                    <div className="px-4 pb-2">
                        {notice.title && <h3 className="text-base font-bold text-white mb-2 leading-snug tracking-tight">{notice.title}</h3>}
                        <div className="text-sm text-slate-300 whitespace-pre-wrap leading-relaxed break-words font-light">
                            {displayContent}
                        </div>
                        {isLongContent && (
                            <button 
                                onClick={() => setIsExpanded(!isExpanded)}
                                className="text-xs font-bold text-blue-400 hover:text-blue-300 mt-1 focus:outline-none"
                            >
                                {isExpanded ? 'Show less' : 'Read more'}
                            </button>
                        )}
                    </div>

                    {/* --- STATS & DIVIDER --- */}
                    <div className="px-4 pt-3 mt-1">
                        <div className="flex justify-between items-center text-[11px] text-slate-500 border-b border-slate-700/50 pb-3">
                            <div className="flex items-center gap-1 cursor-pointer hover:text-blue-400 transition-colors" onClick={() => likeCount > 0 && setShowLikesModal(true)}>
                                {likeCount > 0 && (
                                    <>
                                        <div className="w-4 h-4 rounded-full bg-blue-500 text-white flex items-center justify-center text-[8px] shadow-sm">
                                            <i className="fas fa-thumbs-up"></i>
                                        </div>
                                        <span>{likeCount}</span>
                                    </>
                                )}
                            </div>
                            <div className="flex gap-3">
                                <span>{notice.commentCount || 0} Comments</span>
                                {canManage && <span>{(notice.readBy || []).length} Reads</span>}
                            </div>
                        </div>
                    </div>

                    {/* --- ACTION BAR (Grid Layout for Mobile) --- */}
                    <div className="grid grid-cols-3 gap-px bg-slate-700/30">
                        {/* Like Button */}
                        <button 
                            onClick={handleToggleLike}
                            className={`
                                py-3 text-xs sm:text-sm font-medium transition-colors flex items-center justify-center gap-2 hover:bg-slate-700/50
                                ${isLiked ? 'text-blue-400' : 'text-slate-400 hover:text-slate-200'}
                            `}
                        >
                            <i className={`${isLiked ? 'fas' : 'far'} fa-thumbs-up ${isLiked ? 'animate-bounce-short' : ''} text-lg`}></i>
                            Like
                        </button>
                        
                        {/* Comment Button */}
                        <button 
                            onClick={() => setShowComments(!showComments)}
                            className={`
                                py-3 text-xs sm:text-sm font-medium transition-colors flex items-center justify-center gap-2 hover:bg-slate-700/50
                                ${showComments ? 'text-blue-400 bg-slate-700/50' : 'text-slate-400 hover:text-slate-200'}
                            `}
                        >
                            <i className="far fa-comment-alt text-lg"></i>
                            Comment
                        </button>

                        {/* Read/Status Button */}
                        {!canManage ? (
                            <button 
                                onClick={() => !isRead && onMarkRead(notice)}
                                disabled={isRead}
                                className={`
                                    py-3 text-xs sm:text-sm font-medium transition-colors flex items-center justify-center gap-2 hover:bg-slate-700/50
                                    ${isRead ? 'text-green-500 cursor-default' : 'text-slate-400 hover:text-slate-200'}
                                `}
                            >
                                <i className={`fas ${isRead ? 'fa-check-double' : 'fa-check'} text-lg`}></i>
                                {isRead ? 'Seen' : 'Mark Read'}
                            </button>
                        ) : (
                            <div className="flex items-center justify-center text-slate-500 text-xs cursor-default">
                                Admin View
                            </div>
                        )}
                    </div>

                    {/* --- NEW: LATEST COMMENT PREVIEW (When Collapsed) --- */}
                    {!showComments && latestComment && (
                        <div 
                            className="bg-black/10 px-4 py-3 border-t border-slate-700/30 cursor-pointer hover:bg-slate-800/50 transition-colors group/preview"
                            onClick={() => setShowComments(true)}
                        >
                            <div className="flex gap-2.5 items-start">
                                {/* Preview Avatar */}
                                <div className="w-6 h-6 rounded-full bg-slate-700 flex-shrink-0 overflow-hidden border border-slate-600 mt-0.5">
                                    {(() => {
                                        const prevAuth = employees ? employees.find(e => e.id === latestComment.userId) : null;
                                        return prevAuth && prevAuth.photo ? (
                                            <img src={prevAuth.photo} alt={prevAuth.name} className="w-full h-full object-cover" />
                                        ) : (
                                            <div className="w-full h-full flex items-center justify-center text-[8px] text-slate-300 font-bold">{(latestComment.userName || '?').charAt(0)}</div>
                                        );
                                    })()}
                                </div>
                                
                                <div className="flex-1 min-w-0">
                                    <div className="flex items-baseline gap-2">
                                        <span className="text-xs font-bold text-slate-300">
                                            {(() => {
                                                const prevAuth = employees ? employees.find(e => e.id === latestComment.userId) : null;
                                                return prevAuth ? prevAuth.name : latestComment.userName;
                                            })()}
                                        </span>
                                        <span className="text-[10px] text-slate-500">{formatCommentTime(latestComment.createdAt)}</span>
                                    </div>
                                    <p className="text-xs text-slate-400 line-clamp-1 group-hover/preview:text-slate-300 transition-colors">
                                        {latestComment.text}
                                    </p>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* --- COMMENTS SECTION --- */}
                    {showComments && (
                        <div className="bg-black/20 p-4 border-t border-slate-700/50 animate-fade-in">
                            {/* List */}
                            <div className="space-y-4 mb-4 max-h-[300px] overflow-y-auto custom-scrollbar pr-1">
                                {comments.length === 0 && (
                                    <div className="text-center py-6">
                                        <p className="text-xs text-slate-500 italic">No comments yet. Be the first!</p>
                                    </div>
                                )}
                                {comments.map(comment => {
                                    const commenter = employees ? employees.find(e => e.id === comment.userId) : null;
                                    const displayName = commenter ? commenter.name : comment.userName;
                                    const displayPhoto = commenter ? commenter.photo : null;
                                    const isMyComment = comment.userId === userProfile.id;

                                    return (
                                        <div key={comment.id} className="flex gap-3 group">
                                            <div className="w-8 h-8 rounded-full bg-slate-700 flex-shrink-0 overflow-hidden border border-slate-600 shadow-sm mt-0.5">
                                                {displayPhoto ? (
                                                    <img src={displayPhoto} alt={displayName} className="w-full h-full object-cover" />
                                                ) : (
                                                    <div className="w-full h-full flex items-center justify-center text-[10px] text-slate-300 font-bold">{displayName ? displayName.charAt(0) : '?'}</div>
                                                )}
                                            </div>
                                            
                                            <div className="flex-1 min-w-0">
                                                {/* Bubble */}
                                                <div className={`rounded-2xl px-3.5 py-2.5 relative border ${isMyComment ? 'bg-blue-900/20 border-blue-500/20 rounded-tr-none' : 'bg-slate-700/40 border-slate-600/50 rounded-tl-none'}`}>
                                                    {editingCommentId === comment.id ? (
                                                        <div className="flex flex-col gap-2">
                                                            <input 
                                                                type="text" 
                                                                value={editText} 
                                                                onChange={(e) => setEditText(e.target.value)} 
                                                                className="input text-xs py-1.5 bg-slate-900 border-slate-600 rounded-lg"
                                                                autoFocus
                                                            />
                                                            <div className="flex gap-2 justify-end">
                                                                <button onClick={() => setEditingCommentId(null)} className="text-[10px] font-bold text-slate-400 hover:text-white uppercase">Cancel</button>
                                                                <button onClick={() => handleSaveEdit(comment.id)} className="text-[10px] font-bold text-blue-400 hover:text-blue-300 uppercase">Save</button>
                                                            </div>
                                                        </div>
                                                    ) : (
                                                        <>
                                                            <div className="flex justify-between items-baseline mb-0.5">
                                                                <span className={`text-xs font-bold ${isMyComment ? 'text-blue-300' : 'text-slate-200'}`}>{displayName}</span>
                                                            </div>
                                                            <p className="text-sm text-slate-300 leading-snug break-words whitespace-pre-wrap">{comment.text}</p>
                                                            
                                                            {/* Context Actions (Hover Only on Desktop / Visible for Owner) */}
                                                            {isMyComment && (
                                                                <div className="absolute top-1 right-1 opacity-0 group-hover:opacity-100 transition-opacity flex bg-slate-800 rounded-lg shadow-sm border border-slate-700">
                                                                    <button onClick={(e) => handleStartEdit(comment, e)} className="text-slate-400 hover:text-blue-400 p-1.5" title="Edit"><i className="fas fa-pencil-alt text-[10px]"></i></button>
                                                                    <button onClick={(e) => handleDeleteComment(e, comment.id)} className="text-slate-400 hover:text-red-400 p-1.5" title="Delete"><i className="fas fa-trash text-[10px]"></i></button>
                                                                </div>
                                                            )}
                                                        </>
                                                    )}
                                                </div>
                                                <div className="ml-2 mt-1 text-[10px] text-slate-500 font-medium">{formatCommentTime(comment.createdAt)}</div>
                                            </div>
                                        </div>
                                    );
                                })}
                            </div>
                            
                            {/* Input Area */}
                            <form onSubmit={handleAddComment} className="flex items-end gap-2">
                                <div className="w-8 h-8 rounded-full bg-slate-700 flex-shrink-0 overflow-hidden border border-slate-600 hidden sm:block shadow-sm">
                                    {userProfile.photo ? (
                                        <img src={userProfile.photo} alt="Me" className="w-full h-full object-cover" />
                                    ) : (
                                        <div className="w-full h-full flex items-center justify-center text-xs text-slate-300 font-bold">{userProfile.name.charAt(0)}</div>
                                    )}
                                </div>
                                <div className="flex-1 relative">
                                    <textarea 
                                        value={newComment}
                                        onChange={(e) => setNewComment(e.target.value)}
                                        className="w-full bg-slate-800 border border-slate-700 rounded-2xl py-2.5 pl-4 pr-10 text-sm text-white focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500 placeholder-slate-500 transition-all resize-none overflow-hidden min-h-[42px]"
                                        placeholder="Write a comment..." 
                                        rows="1"
                                        onInput={(e) => { e.target.style.height = 'auto'; e.target.style.height = e.target.scrollHeight + 'px'; }}
                                        disabled={isSubmittingComment}
                                    />
                                    <button 
                                        type="submit" 
                                        disabled={!newComment.trim() || isSubmittingComment}
                                        className="absolute right-2 bottom-2 w-8 h-8 flex items-center justify-center rounded-full text-blue-500 hover:bg-blue-500/10 transition-all disabled:opacity-30 disabled:hover:bg-transparent"
                                    >
                                        <i className={`fas ${isSubmittingComment ? 'fa-spinner fa-spin' : 'fa-paper-plane'}`}></i>
                                    </button>
                                </div>
                            </form>
                        </div>
                    )}

                    {/* Likes Modal */}
                    {showLikesModal && (
                        <Modal isOpen={showLikesModal} onClose={() => setShowLikesModal(false)} maxWidth="max-w-sm">
                            <ModalHeader title="People who liked this" onClose={() => setShowLikesModal(false)} />
                            <ModalBody>
                                <div className="flex flex-col gap-2 max-h-60 overflow-y-auto custom-scrollbar">
                                    {likers.length > 0 ? (
                                        likers.map((person, idx) => (
                                            <div key={idx} className="flex items-center gap-3 p-2 hover:bg-slate-700/30 rounded-lg transition-colors">
                                                <div className="w-10 h-10 rounded-full bg-slate-700 flex items-center justify-center text-xs font-bold text-slate-300 overflow-hidden border border-slate-600">
                                                    {person.photo ? (
                                                        <img src={person.photo} alt={person.name} className="w-full h-full object-cover" />
                                                    ) : (
                                                        person.name.charAt(0)
                                                    )}
                                                </div>
                                                <span className="text-sm font-semibold text-slate-200">{person.name}</span>
                                            </div>
                                        ))
                                    ) : (
                                        <p className="text-slate-500 text-sm text-center py-4">No likes yet.</p>
                                    )}
                                </div>
                            </ModalBody>
                            <ModalFooter>
                                <Button variant="secondary" onClick={() => setShowLikesModal(false)}>Close</Button>
                            </ModalFooter>
                        </Modal>
                    )}
                </div>
            );
        });

        // UPDATED: Added Memo Management (Create/Edit/Delete) directly here
        const NoticeBoardTab = ({ userProfile, pageParams }) => { // Added pageParams
            const { db } = useFirebase();
            const { collection, addDoc, updateDoc, doc, deleteDoc, serverTimestamp, orderBy, query, onSnapshot, arrayUnion } = window.firebaseSDK; 
            const { employees } = useAppData(); 
            
            const [allNotices, setAllNotices] = useState([]);
            const [loading, setLoading] = useState(true);
            
            // Stats Modal State
            const [statsNotice, setStatsNotice] = useState(null);
            
            // Management States
            const [isCreateModalOpen, setIsCreateModalOpen] = useState(false);
            const [editingMemo, setEditingMemo] = useState(null);
            const [memoToDelete, setMemoToDelete] = useState(null);

            // Fetch Data
            useEffect(() => {
                if (!db) return;
                setLoading(true);

                const q = query(collection(db, 'memoAlerts'), orderBy('createdAt', 'desc'));
                
                const unsubscribe = onSnapshot(q, (snapshot) => {
                    const fetchedNotices = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    setAllNotices(fetchedNotices);
                    setLoading(false);
                }, (error) => {
                    console.error("Error fetching notices:", error);
                    setLoading(false);
                });

                return () => unsubscribe();
            }, [db]);

            // Filter notices
            const visibleNotices = useMemo(() => {
                if (!userProfile) return [];
                
                return allNotices.filter(n => {
                    if (userProfile.role !== 'Staff') return true;
                    if (n.status !== 'Active') return false;
                    if (!n.targetShops || n.targetShops.length === 0) return true;
                    
                    const userShops = Array.isArray(userProfile.shop) ? userProfile.shop : [userProfile.shop];
                    return userShops.some(s => n.targetShops.includes(s));
                });
            }, [allNotices, userProfile]);

            // Handlers (Mark Read, Save, Delete) - Kept same as before
            const handleMarkAsRead = useCallback(async (notice) => {
                if (!userProfile?.id) return;
                try {
                    const noticeRef = doc(db, 'memoAlerts', notice.id);
                    await updateDoc(noticeRef, { readBy: arrayUnion(userProfile.id) });
                } catch (error) { console.error("Error marking read:", error); }
            }, [db, userProfile?.id]);

            const handleSaveMemo = async (formData) => {
                const { id, ...dataToSave } = formData;
                if (!id) {
                    dataToSave.authorId = userProfile.id;
                    dataToSave.authorName = userProfile.name;
                    dataToSave.readBy = [];
                    dataToSave.likes = [];
                    dataToSave.commentCount = 0; // Initialize comment count
                }

                try {
                    if (id) await updateDoc(doc(db, 'memoAlerts', id), { ...dataToSave, updatedAt: serverTimestamp() });
                    else await addDoc(collection(db, 'memoAlerts'), { ...dataToSave, createdAt: serverTimestamp() });
                    setIsCreateModalOpen(false);
                    setEditingMemo(null);
                } catch (error) { console.error("Error saving memo:", error); alert("Failed to save memo."); }
            };

            const handleDeleteMemo = async () => {
                if (!memoToDelete) return;
                try {
                    await deleteDoc(doc(db, 'memoAlerts', memoToDelete.id));
                    setMemoToDelete(null);
                } catch (error) { console.error("Error deleting memo:", error); alert("Failed to delete memo."); }
            };

            const canManage = userProfile.role === 'Admin' || userProfile.role === 'CEO' || userProfile.role === 'Shop Manager';

            // OPTIMIZED LAYOUT: Responsive Width (max-w-2xl) and Sticky Header
            return (
                <div className="animate-fade-in pb-24 w-full max-w-2xl mx-auto px-0 sm:px-4">
                    {/* MODIFIED: Header Area - Static (Scrolls with content instead of sticky) */}
                    <div className="flex items-center justify-between py-3 sm:py-4 px-3 sm:px-0 mb-4">
                        <div className="flex items-center gap-3">
                            <div className="p-2 bg-gradient-to-br from-blue-500/20 to-purple-500/20 rounded-lg border border-white/5 shadow-sm">
                                <i className="fas fa-bullhorn text-blue-400"></i>
                            </div>
                            <h2 className="text-lg sm:text-xl font-bold text-white tracking-tight">Notice Feed</h2>
                        </div>
                        {canManage && (
                            <Button 
                                onClick={() => { setEditingMemo(null); setIsCreateModalOpen(true); }}
                                variant="primary"
                                className="shadow-lg shadow-blue-500/20 text-xs sm:text-sm py-2 px-4 rounded-xl font-bold tracking-wide transform active:scale-95 transition-transform"
                            >
                                <i className="fas fa-plus mr-1.5"></i> Post
                            </Button>
                        )}
                    </div>

                    {/* OPTIMIZED: Create Post Prompt */}
                    {canManage && (
                        <div 
                            onClick={() => { setEditingMemo(null); setIsCreateModalOpen(true); }}
                            className="bg-slate-800 rounded-2xl p-4 flex gap-3 items-center cursor-pointer border border-slate-700 hover:border-slate-600 hover:bg-slate-750 transition-all shadow-md active:scale-[0.99] group mx-3 sm:mx-0 mb-6"
                        >
                            <div className="w-10 h-10 rounded-full bg-slate-700 overflow-hidden border-2 border-slate-600 group-hover:border-slate-500 transition-colors">
                                {userProfile.photo ? (
                                    <img src={userProfile.photo} alt={userProfile.name} className="w-full h-full object-cover" />
                                ) : (
                                    <div className="w-full h-full flex items-center justify-center font-bold text-slate-400">{userProfile.name.charAt(0)}</div>
                                )}
                            </div>
                            <div className="flex-1 bg-slate-900/60 rounded-full px-5 py-2.5 text-sm text-slate-500 hover:bg-slate-900 transition-colors border border-transparent hover:border-slate-700 truncate">
                                What's on your mind, {userProfile.name}?
                            </div>
                        </div>
                    )}

                    {loading ? (
                        <div className="text-center py-20"><i className="fas fa-spinner fa-spin text-3xl text-blue-500"></i></div>
                    ) : (
                        <div className="space-y-4 px-2 sm:px-0">
                            {visibleNotices.length === 0 ? (
                                <div className="text-center py-20 opacity-60 bg-slate-800/30 rounded-2xl border border-slate-700 border-dashed mx-4 sm:mx-0">
                                    <div className="w-16 h-16 bg-slate-800 rounded-full flex items-center justify-center mx-auto mb-4 shadow-inner">
                                        <i className="fas fa-newspaper text-3xl text-slate-600"></i>
                                    </div>
                                    <p className="text-lg font-medium text-slate-300">No updates yet.</p>
                                    <p className="text-sm text-slate-500 mt-1">Check back later for company news.</p>
                                </div>
                            ) : (
                                visibleNotices.map(notice => (
                                    <NoticeCard 
                                        key={notice.id}
                                        notice={notice}
                                        userProfile={userProfile}
                                        employees={employees} 
                                        canManage={canManage}
                                        onEdit={() => { setEditingMemo(notice); setIsCreateModalOpen(true); }}
                                        onDelete={() => setMemoToDelete(notice)}
                                        onMarkRead={() => handleMarkAsRead(notice)}
                                        onViewStats={() => setStatsNotice(notice)}
                                    />
                                ))
                            )}
                        </div>
                    )}
                    
                    {/* Modals */}
                    <ReadStatsModal isOpen={!!statsNotice} onClose={() => setStatsNotice(null)} notice={statsNotice} />
                    <MemoAlertModal isOpen={isCreateModalOpen} onClose={() => { setIsCreateModalOpen(false); setEditingMemo(null); }} onSave={handleSaveMemo} memo={editingMemo} />
                    <ConfirmationModal isOpen={!!memoToDelete} onClose={() => setMemoToDelete(null)} onConfirm={handleDeleteMemo} title="Delete Post" message="Are you sure you want to delete this post?" />
                </div>
            );
        };
        
        // --- NEW: MERGED PAGE (CompanyHubPage) ---
        // FIX: Added pageParams to props
        const CompanyHubPage = ({ userProfile, pageParams }) => {
            // NEW: Get module config
            const { moduleConfig = {} } = useAppData();
            const [activeTab, setActiveTab] = useState('');

            // MODIFIED: Filter tabs based on configuration
            const tabs = useMemo(() => {
                const available = {};
                const isEnabled = (key) => moduleConfig?.[key] !== false;

                if (isEnabled('companyHub:notices')) {
                    available.notices = <span><i className="fas fa-bullhorn mr-2 text-yellow-500"></i>Notices</span>;
                }
                if (isEnabled('companyHub:policies')) {
                    available.policies = <span><i className="fas fa-scale-balanced mr-2 text-blue-400"></i>Policies</span>;
                }
                return available;
            }, [moduleConfig]);

            // Ensure we have a valid active tab
            useEffect(() => {
                const keys = Object.keys(tabs);
                if (keys.length > 0 && !tabs[activeTab]) {
                    setActiveTab(keys[0]);
                }
            }, [tabs, activeTab]);

            return (
                <TabbedPage tabs={tabs} activeTab={activeTab} setActiveTab={setActiveTab}>
                    {/* FIX: Pass pageParams down to NoticeBoardTab */}
                    {tabs.notices && (
                        <div id="notices"><NoticeBoardTab userProfile={userProfile} pageParams={pageParams} /></div>
                    )}
                    {tabs.policies && (
                        <div id="policies"><PolicyBoardTab userProfile={userProfile} /></div>
                    )}
                </TabbedPage>
            );
        };
        // --- END NOTICE BOARD PAGE ---

        // --- START USER ACTIVITY PAGE ---
        
        // REFACTORED: Moved existing UserActivityPage logic to SystemLogsTab
        // OPTIMIZATION: Wrapped in memo to prevent re-renders from global clock
        const SystemLogsTab = memo(() => {
            const { db } = useFirebase();
            const { employees } = useAppData();
            const [logs, setLogs] = useState([]);
            const [limitCount, setLimitCount] = useState(50);
            const [loading, setLoading] = useState(true);

            // OPTIMIZATION: Use getDocs (Fetch Once) instead of onSnapshot (Real-time).
            // Logs are high-frequency data. Real-time listeners here cause performance degradation.
            const fetchLogs = useCallback(async () => {
                if (!db) return;
                setLoading(true);
                try {
                    const { collection, query, orderBy, limit, getDocs } = window.firebaseSDK;
                    const q = query(collection(db, 'userLogs'), orderBy('timestamp', 'desc'), limit(limitCount));
                    
                    const snapshot = await getDocs(q);
                    const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    setLogs(data);
                } catch (error) {
                    console.error("Error fetching user logs:", error);
                } finally {
                    setLoading(false);
                }
            }, [db, limitCount]);

            useEffect(() => {
                fetchLogs();
            }, [fetchLogs]);

            const getEmployeeName = (uid) => {
                if (!uid) return 'System';
                const emp = employees.find(e => e.uid === uid);
                return emp ? emp.name : 'Unknown User';
            };

            const formatLogTime = (timestamp) => {
                if (!timestamp || !timestamp.toDate) return '-';
                return timestamp.toDate().toLocaleString('en-GB');
            };

            // OPTIMIZATION: Expensive function logic remains, but now runs far less often thanks to memo
            const getChangeDetails = (log) => {
                if (log.action === 'Delete Task' || log.action.includes('Delete')) {
                    return <span className="text-red-400">Item Deleted</span>;
                }
                if (!log.originalData && log.updatedData) {
                    return <span className="text-green-400">New Record Created</span>;
                }
                if (log.originalData && log.updatedData) {
                    const changes = [];
                    Object.keys(log.updatedData).forEach(key => {
                        if (['id', 'uid', 'createdAt', 'updatedAt', 'lastUpdated'].includes(key)) return;
                        const originalVal = log.originalData[key];
                        const newVal = log.updatedData[key];
                        // Simple comparison to avoid heavy deep diffing on render
                        if (JSON.stringify(originalVal) !== JSON.stringify(newVal)) {
                            const fmt = (v) => Array.isArray(v) ? v.join(', ') : (v === undefined || v === null || v === '' ? '(empty)' : String(v));
                            changes.push(
                                <div key={key} className="text-xs">
                                    <span className="font-semibold text-slate-400 capitalize">{key}:</span>{' '}
                                    <span className="text-red-300 line-through">{fmt(originalVal)}</span>{' '}
                                    <i className="fas fa-arrow-right text-slate-500 mx-1"></i>{' '}
                                    <span className="text-green-300">{fmt(newVal)}</span>
                                </div>
                            );
                        }
                    });
                    if (changes.length === 0) return <span className="text-slate-500">No changes detected</span>;
                    return <div className="flex flex-col gap-1">{changes}</div>;
                }
                return <span className="text-slate-500">-</span>;
            };

            return (
                <Card>
                    <div className="flex flex-wrap justify-between items-center mb-6 gap-4">
                        <h3 className="text-xl font-semibold text-slate-100">System Activity Logs</h3>
                        <div className="flex items-center gap-2">
                            {/* NEW: Manual Refresh Button */}
                            <Button variant="secondary" icon="fa-sync" onClick={fetchLogs} disabled={loading} className="text-xs py-1 h-8">
                                Refresh
                            </Button>

                            <label className="text-sm text-slate-400 ml-2">Show:</label>
                            <select value={limitCount} onChange={(e) => setLimitCount(Number(e.target.value))} className="select w-auto py-1 px-2 text-sm">
                                <option value={50}>50</option>
                                <option value={100}>100</option>
                                <option value={200}>200</option>
                            </select>
                        </div>
                    </div>
                    {loading ? (
                        <div className="text-center py-10"><i className="fas fa-spinner fa-spin text-3xl text-blue-500"></i></div>
                    ) : (
                        <div className="overflow-x-auto">
                            <table className="min-w-full divide-y divide-slate-700">
                                <thead className="bg-slate-900/50">
                                    <tr>
                                        <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Time</th>
                                        <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">User</th>
                                        <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Action</th>
                                        <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Target</th>
                                        <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Changes Log</th>
                                    </tr>
                                </thead>
                                <tbody className="divide-y divide-slate-700">
                                    {logs.map(log => (
                                        <tr key={log.id} className="hover:bg-slate-700/50 transition-colors">
                                            <td className="px-4 py-3 text-sm text-slate-300 whitespace-nowrap font-mono align-top">{formatLogTime(log.timestamp)}</td>
                                            <td className="px-4 py-3 text-sm text-slate-200 font-medium align-top">{getEmployeeName(log.userId)}</td>
                                            <td className="px-4 py-3 text-sm text-blue-400 font-medium align-top">{log.action}</td>
                                            <td className="px-4 py-3 text-sm text-slate-300 align-top">{log.targetName || log.targetId || '-'}</td>
                                            <td className="px-4 py-3 text-sm text-slate-300 align-top">{getChangeDetails(log)}</td>
                                        </tr>
                                    ))}
                                    {logs.length === 0 && <tr><td colSpan="5" className="px-4 py-8 text-center text-slate-500">No activity recorded found.</td></tr>}
                                </tbody>
                            </table>
                        </div>
                    )}
                </Card>
            );
        });

        // NEW: Device Audit Tab (Tracks Staff Phone Usage)
        const DeviceAuditTab = ({ userProfile }) => {
            const { db } = useFirebase();
            const { employees, shops } = useAppData(); // Use global data for name lookup
            const [deviceStats, setDeviceStats] = useState([]);
            const [loading, setLoading] = useState(true);
            const [scanLimit, setScanLimit] = useState(500); // Default to last 500 records
            const [selectedShop, setSelectedShop] = useState('');
            const [searchTerm, setSearchTerm] = useState('');

            // Set initial shop for managers
            useEffect(() => {
                if (userProfile && userProfile.role !== 'Admin' && userProfile.role !== 'CEO') {
                    setSelectedShop(Array.isArray(userProfile.shop) ? '' : userProfile.shop || '');
                }
            }, [userProfile]);

            // Helper to get allowed shops
            const allowedShops = useAllowedShops(userProfile, shops);

            useEffect(() => {
                if (!db) return;
                
                const fetchDeviceHistory = async () => {
                    setLoading(true);
                    const { collection, query, orderBy, limit, getDocs, where } = window.firebaseSDK;
                    
                    try {
                        // 1. Base Query: Get recent attendance
                        let q = query(collection(db, 'attendance'), orderBy('timestamp', 'desc'), limit(scanLimit));
                        
                        // Apply shop filter if selected (Optimization: Filter at DB level if possible)
                        // Note: Can't easily combine orderBy timestamp + where shop without custom index.
                        // We'll stick to client-side filtering for simplicity unless volume is huge.
                        
                        const snapshot = await getDocs(q);
                        const records = snapshot.docs.map(doc => doc.data());

                        // 2. Process Records into Unique (Staff + Device) entries
                        const deviceMap = new Map(); // Key: "StaffId_DeviceModel"

                        records.forEach(rec => {
                            // Filter logic
                            if (selectedShop && rec.shop !== selectedShop) return;
                            
                            // Role-based filtering
                            if (userProfile.role === 'Shop Manager') {
                                const myShops = Array.isArray(userProfile.shop) ? userProfile.shop : [userProfile.shop];
                                if (!myShops.includes(rec.shop)) return;
                            } else if (userProfile.role === 'Staff') {
                                if (rec.employeeId !== userProfile.id) return;
                            }

                            // Extract Info
                            const model = rec.deviceInfo?.model || 'Unknown';
                            const platform = rec.deviceInfo?.platform || 'Unknown';
                            
                            // Skip "Unknown" if desired, or keep to show missing data
                            
                            const key = `${rec.employeeId}_${model}`;
                            const ts = rec.timestamp?.toDate ? rec.timestamp.toDate() : new Date(rec.timestamp);

                            if (!deviceMap.has(key)) {
                                const emp = employees.find(e => e.id === rec.employeeId);
                                deviceMap.set(key, {
                                    key,
                                    employeeId: rec.employeeId,
                                    employeeName: emp ? emp.name : rec.employeeName,
                                    photo: emp ? emp.photo : null,
                                    shop: rec.shop,
                                    deviceModel: model,
                                    platform: platform,
                                    firstSeen: ts,
                                    lastSeen: ts,
                                    count: 1
                                });
                            } else {
                                const entry = deviceMap.get(key);
                                entry.count += 1;
                                // Update timestamps
                                if (ts > entry.lastSeen) entry.lastSeen = ts;
                                if (ts < entry.firstSeen) entry.firstSeen = ts;
                            }
                        });

                        // 3. Convert to Array and Sort
                        // Sort by "First Seen" DESCENDING -> Shows newly introduced devices at the top
                        const sortedStats = Array.from(deviceMap.values()).sort((a, b) => b.firstSeen - a.firstSeen);
                        
                        setDeviceStats(sortedStats);

                    } catch (error) {
                        console.error("Error fetching device audit:", error);
                    } finally {
                        setLoading(false);
                    }
                };

                fetchDeviceHistory();
            }, [db, scanLimit, selectedShop, userProfile, employees]); // Re-run when dependencies change

            // Final Display Filter (Search)
            const filteredStats = useMemo(() => {
                if (!searchTerm) return deviceStats;
                return deviceStats.filter(item => 
                    item.employeeName.toLowerCase().includes(searchTerm.toLowerCase()) ||
                    item.deviceModel.toLowerCase().includes(searchTerm.toLowerCase())
                );
            }, [deviceStats, searchTerm]);

            const handleExportExcel = () => {
                const data = filteredStats.map(d => ({
                    'Staff Name': d.employeeName,
                    'Shop': d.shop,
                    'Device Model': d.deviceModel,
                    'Platform': d.platform,
                    'First Seen': Utils.formatRequestDate({ toDate: () => d.firstSeen }),
                    'Last Seen': Utils.formatRequestDate({ toDate: () => d.lastSeen }),
                    'Check-In Count': d.count
                }));
                Utils.exportToExcel(data, "Device Audit", "Staff_Device_History.xlsx");
            };

            return (
                <Card>
                    <PageHeader title="Staff Device Audit Log">
                        <div className="flex flex-wrap gap-4 items-center">
                            <SearchInput value={searchTerm} onChange={e => setSearchTerm(e.target.value)} placeholder="Search staff or phone model..." />
                            
                            <ShopFilterSelect 
                                userProfile={userProfile}
                                shops={shops}
                                selectedShop={selectedShop}
                                onChange={e => setSelectedShop(e.target.value)}
                            />

                            <select value={scanLimit} onChange={e => setScanLimit(Number(e.target.value))} className="select w-auto text-sm">
                                <option value={100}>Last 100 Checks</option>
                                <option value={500}>Last 500 Checks</option>
                                <option value={1000}>Last 1000 Checks</option>
                            </select>

                            <Button variant="success" icon="fa-file-excel" onClick={handleExportExcel}>Excel</Button>
                        </div>
                    </PageHeader>

                    {loading ? (
                        <div className="text-center py-10"><i className="fas fa-spinner fa-spin text-3xl text-orange-500"></i></div>
                    ) : (
                        <div className="overflow-x-auto">
                            <table className="min-w-full divide-y divide-slate-700">
                                <thead className="bg-slate-900/50">
                                    <tr>
                                        <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Staff Name</th>
                                        <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Device Model</th>
                                        <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Platform</th>
                                        <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">First Detected</th>
                                        <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Last Used</th>
                                        <th className="px-4 py-3 text-center text-xs font-semibold text-slate-400 uppercase">Total Usage</th>
                                    </tr>
                                </thead>
                                <tbody className="divide-y divide-slate-700">
                                    {filteredStats.map((item, idx) => {
                                        // Highlight logic: If first seen is within last 24 hours, mark as NEW
                                        const isNew = (new Date() - item.firstSeen) < (24 * 60 * 60 * 1000);
                                        
                                        return (
                                            <tr key={item.key} className={`hover:bg-slate-700/50 transition-colors ${isNew ? 'bg-orange-900/10' : ''}`}>
                                                <td className="px-4 py-4 whitespace-nowrap">
                                                    <div className="flex items-center gap-3">
                                                        <div className="w-8 h-8 rounded-full bg-slate-700 flex items-center justify-center text-xs font-bold text-slate-300 border border-slate-600 overflow-hidden">
                                                            {item.photo ? <img src={item.photo} className="w-full h-full object-cover"/> : item.employeeName.charAt(0)}
                                                        </div>
                                                        <div>
                                                            <div className="text-sm font-bold text-slate-200">{item.employeeName}</div>
                                                            <div className="text-[10px] text-slate-500">{item.shop}</div>
                                                        </div>
                                                    </div>
                                                </td>
                                                <td className="px-4 py-4 text-sm text-blue-300 font-mono">
                                                    {item.deviceModel}
                                                    {isNew && <span className="ml-2 bg-orange-500 text-white text-[9px] px-1.5 py-0.5 rounded font-bold uppercase animate-pulse">New</span>}
                                                </td>
                                                <td className="px-4 py-4 text-sm text-slate-400">
                                                    {item.platform === 'iOS' && <i className="fab fa-apple mr-2 text-slate-200"></i>}
                                                    {item.platform === 'Android' && <i className="fab fa-android mr-2 text-green-500"></i>}
                                                    {item.platform === 'Windows' && <i className="fab fa-windows mr-2 text-blue-400"></i>}
                                                    {item.platform}
                                                </td>
                                                <td className="px-4 py-4 text-sm text-slate-300">
                                                    {item.firstSeen.toLocaleString('en-GB', { day: 'numeric', month: 'short', hour: '2-digit', minute:'2-digit' })}
                                                </td>
                                                <td className="px-4 py-4 text-sm text-slate-400">
                                                    {item.lastSeen.toLocaleString('en-GB', { day: 'numeric', month: 'short', hour: '2-digit', minute:'2-digit' })}
                                                </td>
                                                <td className="px-4 py-4 text-center">
                                                    <span className="bg-slate-800 text-slate-300 px-2 py-1 rounded text-xs border border-slate-700">
                                                        {item.count}
                                                    </span>
                                                </td>
                                            </tr>
                                        );
                                    })}
                                    {filteredStats.length === 0 && (
                                        <tr><td colSpan="6" className="px-4 py-8 text-center text-slate-500">No device history found.</td></tr>
                                    )}
                                </tbody>
                            </table>
                        </div>
                    )}
                </Card>
            );
        };

        const UserActivityPage = ({ userProfile }) => {
            const { moduleConfig = {} } = useAppData();
            const [activeTab, setActiveTab] = useState('');

            const tabs = useMemo(() => {
                const available = {};
                // Check if enabled (default true)
                if (moduleConfig['userActivity:logs'] !== false) available.logs = <span><i className="fas fa-file-signature mr-2 text-teal-400"></i>System Logs</span>;
                if (moduleConfig['userActivity:devices'] !== false) available.devices = <span><i className="fas fa-mobile-screen-button mr-2 text-orange-400"></i>Device Audit</span>;
                return available;
            }, [moduleConfig]);

            useEffect(() => {
                const keys = Object.keys(tabs);
                if (keys.length > 0 && !tabs[activeTab]) setActiveTab(keys[0]);
            }, [tabs, activeTab]);

            return (
                <TabbedPage tabs={tabs} activeTab={activeTab} setActiveTab={setActiveTab}>
                    {tabs.logs && <div id="logs"><SystemLogsTab /></div>}
                    {tabs.devices && <div id="devices"><DeviceAuditTab userProfile={userProfile} /></div>}
                </TabbedPage>
            );
        };
        // --- END USER ACTIVITY PAGE ---

        // --- NEW: PWA Install Prompt Component ---
        const PWAInstallPrompt = () => {
            const [deferredPrompt, setDeferredPrompt] = useState(null);
            const [showPrompt, setShowPrompt] = useState(false);
            const [isIOS, setIsIOS] = useState(false);

            useEffect(() => {
                // 1. Check if already installed (Standalone Mode)
                const isInStandaloneMode = window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone === true;
                if (isInStandaloneMode) return;

                // 2. Detect iOS
                const userAgent = window.navigator.userAgent.toLowerCase();
                const isIosDevice = /iphone|ipad|ipod/.test(userAgent);

                if (isIosDevice) {
                    setIsIOS(true);
                    // On iOS, we can't detect "beforeinstallprompt", so we show instructions immediately 
                    // if not in standalone mode. You might want to use localStorage to show this only once per session.
                    const hasSeenPrompt = sessionStorage.getItem('iosInstallPromptSeen');
                    if (!hasSeenPrompt) {
                        setShowPrompt(true);
                        sessionStorage.setItem('iosInstallPromptSeen', 'true');
                    }
                } else {
                    // 3. Android/Desktop: Listen for the prompt event
                    const handler = (e) => {
                        e.preventDefault(); // Prevent chrome's mini-infobar
                        setDeferredPrompt(e);
                        setShowPrompt(true);
                    };

                    window.addEventListener('beforeinstallprompt', handler);
                    return () => window.removeEventListener('beforeinstallprompt', handler);
                }
            }, []);

            const handleInstallClick = async () => {
                if (!deferredPrompt) return;
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                if (outcome === 'accepted') {
                    setDeferredPrompt(null);
                    setShowPrompt(false);
                }
            };

            if (!showPrompt) return null;

            return (
                <div className="fixed bottom-4 left-4 right-4 z-[100] p-4 bg-slate-800 border border-slate-600 rounded-xl shadow-2xl animate-fade-in">
                    <div className="flex flex-col gap-3">
                         <div className="flex items-start gap-4">
                            <div className="w-12 h-12 bg-gradient-to-br from-blue-600 to-indigo-600 rounded-xl flex items-center justify-center shadow-lg shrink-0">
                                {isIOS ? <i className="fas fa-share-from-square text-white text-xl"></i> : <i className="fas fa-download text-white text-xl"></i>}
                            </div>
                            <div>
                                <h4 className="text-white font-bold">Install Application</h4>
                                <p className="text-slate-400 text-xs mt-1">
                                    {isIOS 
                                        ? <span>Tap the <strong className="text-white">Share</strong> button in your browser toolbar, then select <strong className="text-white">"Add to Home Screen"</strong>.</span>
                                        : "Add this app to your Home Screen for faster access and a better experience."}
                                </p>
                            </div>
                        </div>
                        {isIOS ? (
                            <div className="flex justify-end pt-2">
                                 <Button variant="secondary" onClick={() => setShowPrompt(false)} className="text-xs py-1 px-4 h-8">Got it</Button>
                            </div>
                        ) : (
                            <div className="flex gap-3 w-full pt-1">
                                <Button variant="secondary" onClick={() => setShowPrompt(false)} className="flex-1 py-2 text-xs h-9">Later</Button>
                                <Button variant="primary" onClick={handleInstallClick} className="flex-1 bg-blue-600 py-2 text-xs h-9">Install Now</Button>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        // --- START LAYOUT & MAIN APP COMPONENTS ---
        
        // NEW: System Launch Pad Component (Redesigned to match "JLW Manager" Image)
        const SystemLaunchPad = ({ isOpen, onClose, activePage, onNavigate, userProfile, currentTime, pendingLeaves, pendingOTs, pendingEngagements = [], onNotificationClick, auth, setInitialCheckInMeTab, allowedLinkKeys, companyHubUnreadCount }) => {
            const { db } = useFirebase();
            // PHASE 3.1 UPDATE: Get moduleConfig to filter icons
            const { employees, kpis, moduleConfig = {} } = useAppData(); 
            const [isEmployeeModalOpen, setIsEmployeeModalOpen] = useState(false);
            const [isTaskModalOpen, setIsTaskModalOpen] = useState(false);
            const [isProfileOpen, setIsProfileOpen] = useState(false);
            const [isCheckingUpdate, setIsCheckingUpdate] = useState(false); // NEW: Update loading state
            const profileRef = useRef(null);

            useEffect(() => {
                const handleClickOutside = (event) => {
                    if (profileRef.current && !profileRef.current.contains(event.target)) {
                        setIsProfileOpen(false);
                    }
                };
                if (isProfileOpen) {
                    document.addEventListener("mousedown", handleClickOutside);
                }
                return () => {
                    document.removeEventListener("mousedown", handleClickOutside);
                };
            }, [isProfileOpen]);

            // --- NEW: Smoother & Robust Update Check Handler ---
            const handleCheckUpdates = async () => {
                setIsCheckingUpdate(true);
                // Short UX Delay
                await new Promise(r => setTimeout(r, 500));

                const performCheck = async () => {
                    if (!('serviceWorker' in navigator)) {
                        alert("You are using the latest update.");
                        return;
                    }
                    
                    // If page isn't controlled (first load or hard refresh), just reload
                    if (!navigator.serviceWorker.controller) {
                        alert("You are using the latest update.");
                        return;
                    }

                    // Use getRegistration to avoid hanging on .ready
                    const registration = await navigator.serviceWorker.getRegistration();
                    if (!registration) {
                        alert("You are using the latest update.");
                        return;
                    }

                    await registration.update();
                    
                    if (registration.installing || registration.waiting) {
                         if(confirm("New update available! Refresh now to apply?")) {
                             if (registration.waiting) {
                                registration.waiting.postMessage({ type: 'SKIP_WAITING' });
                             }
                             window.location.reload();
                         }
                    } else {
                        alert("You are using the latest update.");
                    }
                };

                // 5 second timeout safety valve
                const timeout = new Promise((_, reject) => setTimeout(() => reject("Timeout"), 5000));

                try {
                    await Promise.race([performCheck(), timeout]);
                } catch (error) {
                    console.warn("Update check timeout/error:", error);
                    if(confirm("Check timed out. Force reload to ensure latest version?")) {
                        window.location.reload();
                    }
                } finally {
                    setIsCheckingUpdate(false);
                    setIsProfileOpen(false); // Close menu
                }
            };

            if (!isOpen) return null;

            const activeBasePage = activePage.split(':')[0];

            const handleQuickAction = (action) => {
                switch(action) {
                    case 'checkInOut':
                        onNavigate('checkinme');
                        setInitialCheckInMeTab('checkInOut');
                        onClose();
                        break;
                    case 'leaveRequest':
                        onNavigate('checkinme');
                        setInitialCheckInMeTab(`leaveRequest:new:${Date.now()}`);
                        onClose();
                        break;
                    case 'otRequest':
                        onNavigate('checkinme');
                        setInitialCheckInMeTab(`otRequest:new:${Date.now()}`);
                        onClose();
                        break;
                    case 'addTask':
                        setIsTaskModalOpen(true);
                        break;
                    case 'addStaff':
                        setIsEmployeeModalOpen(true);
                        break;
                    default:
                        break;
                }
            };

            const handleSaveTask = async (formData) => {
                const { addDoc, collection, serverTimestamp } = window.firebaseSDK;
                try {
                    await addDoc(collection(db, 'tasks'), {
                        ...formData,
                        status: 'todo', 
                        taskTimestamp: formData.taskTimestamp || serverTimestamp(), 
                        creatorUid: userProfile.id
                    });
                    
                    Utils.logUserActivity(db, auth, 'Create Task (Quick Action)', { task: formData.text });
                    setIsTaskModalOpen(false);
                    alert("Task created successfully!");
                } catch (error) {
                    console.error("Error saving task:", error);
                    alert("Failed to save task.");
                }
            };

            const handleSaveEmployee = async (formData) => {
                const { addDoc, updateDoc, doc, collection, setDoc, serverTimestamp } = window.firebaseSDK;
                const { id, enrollInSavings, ...dataToSave } = formData;
                
                try {
                    const newDocRef = await addDoc(collection(db, 'employees'), dataToSave);
                    const savedEmployeeId = newDocRef.id;
                    const shopName = Array.isArray(dataToSave.shop) ? (dataToSave.shop[0] || '') : (dataToSave.shop || '');

                    // --- NEW: AUTO-CREATE WELCOME NOTICE (KHMER CONTENT - QUICK ACTION) ---
                    try {
                        const displayJoinedDate = Utils.formatISOToDisplay(dataToSave.joinedDate);
                        await addDoc(collection(db, 'memoAlerts'), {
                            title: `  ${dataToSave.name}!`,
                            // REVISED: Content in Khmer as specifically requested
                            content: ` **${dataToSave.name}**   **${shopName}**  **${dataToSave.position}**  **${displayJoinedDate}**!`,
                            startTime: '08:00',
                            endTime: '18:00',
                            targetShops: shopName ? [shopName] : [],
                            status: 'Active',
                            authorName: 'System',
                            authorId: 'system',
                            createdAt: serverTimestamp(),
                            readBy: [],
                            likes: []
                        });
                        console.log(`Welcome notice created for ${dataToSave.name}`);
                    } catch (noticeError) {
                        console.error("Failed to create welcome notice:", noticeError);
                    }
                    // --- END WELCOME NOTICE ---

                    if (enrollInSavings !== false) {
                        try {
                            const today = new Date();
                            const savingsDefaults = {
                                employeeId: savedEmployeeId,
                                employeeName: dataToSave.name,
                                shop: shopName,
                                savingsProgramStatus: 'Active',
                                savingsPercentage: 5, 
                                savingsJoinDate: today.toISOString().slice(0, 10),
                                savingsEffectiveMonth: today.toISOString().slice(0, 7), 
                                currentBalance: 0,
                                mySavingCredit: 0,
                                mySavingWithdrawalTotal: 0,
                                lastUpdated: serverTimestamp()
                            };
                            await setDoc(doc(db, 'savingprogram', savedEmployeeId), savingsDefaults);
                        } catch (savingsError) {
                            console.error("Failed to auto-enroll:", savingsError);
                        }
                    }

                    Utils.logUserActivity(db, auth, 'Add Employee (Quick Action)', {
                        id: savedEmployeeId,
                        name: dataToSave.name,
                        updatedData: dataToSave
                    });
                    alert("New staff member added successfully!");
                    setIsEmployeeModalOpen(false);
                } catch (error) {
                    console.error("Error saving employee:", error);
                    alert("Failed to add employee.");
                }
            };

            const canAddStaff = userProfile?.role === 'Admin' || userProfile?.role === 'CEO' || userProfile?.role === 'Shop Manager';

            // PHASE 3.1: Check if specific Quick Actions are disabled in Config
            const isCheckInEnabled = moduleConfig['checkinme'] !== false;
            const isTaskEnabled = moduleConfig['tasks'] !== false;
            const isEmployeesEnabled = moduleConfig['employees'] !== false;

            return (
                <div className="fixed inset-0 z-50 flex flex-col animate-fade-in bg-[#0f172a]">
                    <header className="px-6 py-5 flex justify-between items-center z-30 relative shrink-0">
                        <div className="flex items-center gap-3">
                            <div className="w-10 h-10 rounded-xl bg-gradient-to-br from-blue-600 to-indigo-600 flex items-center justify-center shadow-lg shadow-blue-500/30">
                                <i className="fas fa-layer-group text-white text-lg"></i>
                            </div>
                            <div>
                                <h1 className="text-xl font-bold text-white tracking-tight leading-none">HR System</h1>
                                <p className="text-[10px] text-slate-400 font-medium tracking-wide mt-0.5 uppercase">{userProfile?.role || 'Manager'}</p>
                            </div>
                        </div>

                        <div className="flex items-center gap-4">
                            <div className="flex flex-col items-end">
                                <span className="text-xs font-bold text-slate-200 font-mono leading-none">
                                    {currentTime?.toLocaleTimeString([], { hour12: false, hour: '2-digit', minute: '2-digit' })}
                                </span>
                                <span className="text-[9px] text-slate-400 font-medium uppercase tracking-wide leading-none mt-0.5">
                                    {currentTime.toLocaleDateString(undefined, { month: 'short', day: 'numeric' })}
                                </span>
                            </div>
                            
                            <div className="relative" ref={profileRef}>
                                <button 
                                    onClick={() => setIsProfileOpen(!isProfileOpen)}
                                    className="w-10 h-10 rounded-full bg-slate-800 border border-slate-700 flex items-center justify-center text-slate-300 hover:text-white hover:border-slate-500 transition-all shadow-md focus:outline-none focus:ring-2 focus:ring-slate-600 overflow-hidden"
                                >
                                    {userProfile?.photo ? (
                                        <img src={userProfile.photo} alt={userProfile.name} className="w-full h-full object-cover" />
                                    ) : (
                                        userProfile?.name?.charAt(0)
                                    )}
                                </button>
                                {isProfileOpen && (
                                    <div className="absolute right-0 mt-2 w-48 bg-slate-800 rounded-xl shadow-xl py-1 border border-slate-700 z-50 animate-fade-in">
                                        <div className="px-4 py-2 border-b border-slate-700 mb-1">
                                            <p className="text-xs text-slate-400">Signed in as</p>
                                            <p className="text-sm font-bold text-white truncate">{userProfile?.name}</p>
                                        </div>
                                        
                                        {/* NEW: Check for Updates Button */}
                                        <button 
                                            onClick={(e) => { e.preventDefault(); handleCheckUpdates(); }} 
                                            disabled={isCheckingUpdate}
                                            className="block w-full text-left px-4 py-2 text-sm text-blue-400 hover:bg-slate-700 hover:text-blue-300 border-b border-slate-700/50 disabled:opacity-50"
                                        >
                                            <i className={`fas ${isCheckingUpdate ? 'fa-spinner fa-spin' : 'fa-sync-alt'} mr-2`}></i> 
                                            {isCheckingUpdate ? "Checking..." : "Check for Updates"}
                                        </button>

                                        <a 
                                            href="#" 
                                            onClick={(e) => { 
                                                e.preventDefault(); 
                                                window.firebaseSDK.signOut(auth); 
                                                setIsProfileOpen(false); 
                                            }} 
                                            className="block px-4 py-3 text-sm text-red-400 hover:bg-slate-700/50 font-medium rounded-b-xl"
                                        >
                                            <i className="fas fa-sign-out-alt mr-2"></i> Sign out
                                        </a>
                                    </div>
                                )}
                            </div>
                        </div>
                    </header>
                    
                    <div className="flex-1 overflow-y-auto px-6 pb-20">
                        <div className="max-w-md mx-auto sm:max-w-5xl">
                            <div className="grid grid-cols-3 sm:grid-cols-4 md:grid-cols-5 lg:grid-cols-6 gap-4 mb-8">
                                {APP_MODULES.map(module => {
                                    // PHASE 3.1: Enforcement - Hide module if disabled in config
                                    // Default to true (visible) if config entry is missing
                                    if (moduleConfig[module.key] === false) return null;

                                    const isActive = activeBasePage === module.key;
                                    const isLocked = allowedLinkKeys && !allowedLinkKeys.has(module.key);
                                    
                                    let checkInMePendingCount = 0;
                                    if (module.key === 'checkinme') {
                                        const canManage = userProfile?.role === 'Admin' || userProfile?.role === 'CEO' || userProfile?.role === 'Shop Manager';
                                        if (canManage) {
                                            checkInMePendingCount = (pendingLeaves?.length || 0) + (pendingOTs?.length || 0) + (pendingEngagements?.length || 0);
                                        }
                                    }

                                    return (
                                        <button 
                                            key={module.key}
                                            onClick={() => { 
                                                if (isLocked) return; 
                                                onNavigate(module.key); 
                                                if (module.key === 'checkinme') {
                                                    setInitialCheckInMeTab('checkInOut');
                                                }
                                                onClose(); 
                                            }}
                                            className={`group flex flex-col items-center justify-center gap-3 aspect-[4/5] w-full relative ${isLocked ? 'cursor-not-allowed' : 'cursor-pointer'}`}
                                        >
                                            <div className={`
                                                w-full aspect-square rounded-[28px] flex items-center justify-center relative
                                                bg-[#1E293B] border border-slate-700/50
                                                shadow-lg transition-all duration-300
                                                ${!isLocked ? 'group-active:scale-95 group-hover:bg-[#253045]' : 'opacity-90'} 
                                            `}>
                                                <i className={`fas ${module.icon} text-3xl sm:text-4xl ${module.color} drop-shadow-md`}></i>

                                                {module.key === 'companyHub' && companyHubUnreadCount > 0 && (
                                                    <div className="absolute -top-1 -right-1 w-6 h-6 bg-red-500 rounded-full flex items-center justify-center border-2 border-[#0f172a] shadow-sm z-20 animate-bounce-short">
                                                        <span className="text-[10px] font-bold text-white leading-none">
                                                            {companyHubUnreadCount > 99 ? '99+' : companyHubUnreadCount}
                                                        </span>
                                                    </div>
                                                )}

                                                {module.key === 'checkinme' && checkInMePendingCount > 0 && (
                                                    <div className="absolute -top-1 -right-1 w-6 h-6 bg-red-500 rounded-full flex items-center justify-center border-2 border-[#0f172a] shadow-sm z-20 animate-bounce-short">
                                                        <span className="text-[10px] font-bold text-white leading-none">
                                                            {checkInMePendingCount > 99 ? '99+' : checkInMePendingCount}
                                                        </span>
                                                    </div>
                                                )}

                                                {isLocked && (
                                                    <div className="absolute top-2 right-2 w-6 h-6 bg-slate-900/90 border border-slate-700 rounded-full flex items-center justify-center shadow-md z-10">
                                                        <i className="fas fa-lock text-[10px] text-slate-400"></i>
                                                    </div>
                                                )}
                                            </div>
                                            
                                            <span className={`
                                                text-[11px] font-semibold tracking-wide text-center leading-tight
                                                ${isActive ? 'text-white' : 'text-slate-400 group-hover:text-slate-200'}
                                                ${isLocked ? 'text-slate-500' : ''}
                                            `}>
                                                {module.label.replace(' Report', '').replace('Revise', '').replace('Management', '')} 
                                            </span>
                                        </button>
                                    );
                                })}
                            </div>

                            <div className="mb-4 mt-2">
                                <h3 className="text-xs font-bold text-slate-500 uppercase tracking-widest pl-1">Quick Actions</h3>
                            </div>

                            <div className="space-y-4">
                                {/* Row 1: Check In & Add Task - PHASE 3.1 Controlled */}
                                <div className="grid grid-cols-2 gap-4">
                                    {isCheckInEnabled && (
                                        <button onClick={() => handleQuickAction('checkInOut')} className="relative overflow-hidden rounded-[24px] bg-gradient-to-br from-orange-500 to-amber-500 p-5 flex flex-col justify-between h-36 shadow-lg shadow-orange-500/20 group active:scale-[0.98] transition-transform">
                                            <div className="flex justify-between items-start w-full z-10">
                                                <div className="w-10 h-10 rounded-full bg-white/20 backdrop-blur-sm flex items-center justify-center">
                                                    <i className="fas fa-user-clock text-white text-xl"></i>
                                                </div>
                                                <div className="w-8 h-8 rounded-full bg-white/10 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity">
                                                    <i className="fas fa-arrow-right text-white text-xs"></i>
                                                </div>
                                            </div>
                                            <div className="text-left z-10">
                                                <h3 className="text-lg font-bold text-white leading-tight">Check In / Out</h3>
                                                <p className="text-orange-100 text-[10px] font-medium mt-1">Attendance Log</p>
                                            </div>
                                            <div className="absolute -right-4 -bottom-4 w-24 h-24 bg-white/10 rounded-full blur-xl"></div>
                                        </button>
                                    )}

                                    {isTaskEnabled && (
                                        <button onClick={() => handleQuickAction('addTask')} className="relative overflow-hidden rounded-[24px] bg-gradient-to-br from-lime-600 to-green-600 p-5 flex flex-col justify-between h-36 shadow-lg shadow-lime-500/20 group active:scale-[0.98] transition-transform">
                                            <div className="flex justify-between items-start w-full z-10">
                                                <div className="w-10 h-10 rounded-full bg-white/20 backdrop-blur-sm flex items-center justify-center">
                                                    <i className="fas fa-list-check text-white text-xl"></i>
                                                </div>
                                                <div className="w-8 h-8 rounded-full bg-white/10 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity">
                                                    <i className="fas fa-plus text-white text-xs"></i>
                                                </div>
                                            </div>
                                            <div className="text-left z-10">
                                                <h3 className="text-lg font-bold text-white leading-tight">Add New Task</h3>
                                                <p className="text-lime-100 text-[10px] font-medium mt-1">Create To-Do</p>
                                            </div>
                                            <div className="absolute -right-4 -bottom-4 w-24 h-24 bg-white/10 rounded-full blur-xl"></div>
                                        </button>
                                    )}
                                </div>

                                {/* Row 2: Leave & OT Requests - PHASE 3.1 Controlled */}
                                {isCheckInEnabled && (
                                    <div className="grid grid-cols-2 gap-4">
                                        <button onClick={() => handleQuickAction('leaveRequest')} className="relative overflow-hidden rounded-[24px] bg-gradient-to-br from-pink-600 to-rose-500 p-5 flex flex-col justify-between h-32 shadow-lg shadow-pink-500/20 group active:scale-[0.98] transition-transform">
                                            <div className="w-10 h-10 rounded-full bg-white/20 flex items-center justify-center mb-2">
                                                <i className="fas fa-calendar-minus text-white"></i>
                                            </div>
                                            <div className="text-left">
                                                <h3 className="text-md font-bold text-white leading-tight">Request<br/>Leave</h3>
                                            </div>
                                        </button>

                                        <button onClick={() => handleQuickAction('otRequest')} className="relative overflow-hidden rounded-[24px] bg-gradient-to-br from-violet-600 to-purple-600 p-5 flex flex-col justify-between h-32 shadow-lg shadow-purple-500/20 group active:scale-[0.98] transition-transform">
                                            <div className="w-10 h-10 rounded-full bg-white/20 flex items-center justify-center mb-2">
                                                <i className="fas fa-clock text-white"></i>
                                            </div>
                                            <div className="text-left">
                                                <h3 className="text-md font-bold text-white leading-tight">Request<br/>Overtime</h3>
                                            </div>
                                        </button>
                                    </div>
                                )}

                                {canAddStaff && isEmployeesEnabled && (
                                    <button onClick={() => handleQuickAction('addStaff')} className="w-full relative overflow-hidden rounded-[24px] bg-[#1E293B] border border-slate-700/50 p-5 flex justify-between items-center shadow-lg group active:scale-[0.98] transition-transform">
                                        <div className="flex items-center gap-4">
                                            <div className="w-12 h-12 rounded-2xl bg-emerald-500/10 text-emerald-500 flex items-center justify-center">
                                                <i className="fas fa-user-plus text-xl"></i>
                                            </div>
                                            <div className="text-left">
                                                <h3 className="text-md font-bold text-white">Add New Staff</h3>
                                                <p className="text-slate-400 text-xs font-medium">Register employee</p>
                                            </div>
                                        </div>
                                        <i className="fas fa-chevron-right text-slate-600"></i>
                                    </button>
                                )}
                            </div>
                        </div>
                    </div>

                    <EmployeeModal
                        isOpen={isEmployeeModalOpen}
                        onClose={() => setIsEmployeeModalOpen(false)}
                        onSave={handleSaveEmployee}
                        userProfile={userProfile}
                        isViewOnly={false}
                        allEmployees={employees}
                    />

                    <TaskModal 
                        isOpen={isTaskModalOpen} 
                        onClose={() => setIsTaskModalOpen(false)} 
                        onSave={handleSaveTask} 
                        task={null} 
                        userProfile={userProfile} 
                        kpis={kpis} 
                        employees={employees} 
                    />
                </div>
            );
        };

        // --- NEW COMPONENT: Priority Notice Modal (Auto-Popup) ---
        const PriorityNoticeModal = ({ isOpen, notice, onAcknowledge, onRemindLater }) => {
            if (!isOpen || !notice) return null;

            return (
                <Modal isOpen={isOpen} onClose={onRemindLater} maxWidth="max-w-lg">
                    <div className="flex flex-col h-full border-2 border-yellow-500 rounded-lg overflow-hidden relative">
                        <div className="bg-yellow-500 p-4 flex items-center gap-3 shadow-md">
                            <div className="p-2 bg-white rounded-full text-yellow-600 shadow-sm animate-bounce">
                                <i className="fas fa-bullhorn text-xl"></i>
                            </div>
                            <div className="flex-1">
                                {/* MODIFIED: Translated to Khmer */}
                                <h3 className="text-xl font-bold text-slate-900 leading-none"></h3>
                                <p className="text-yellow-900 text-xs font-bold uppercase tracking-wider mt-1"> (Action Required)</p>
                            </div>
                        </div>

                        <div className="p-6 bg-slate-800">
                            <h4 className="text-lg font-bold text-white mb-2">{notice.title}</h4>
                            <div className="text-xs text-slate-400 mb-4 flex items-center gap-2">
                                <span><i className="fas fa-clock mr-1"></i> {notice.startTime} - {notice.endTime}</span>
                                <span></span>
                                <span>From: {notice.authorName || 'Management'}</span>
                            </div>
                            
                            <div className="bg-slate-700/50 p-4 rounded-lg border border-slate-600 mb-6">
                                <p className="text-slate-200 text-sm whitespace-pre-line leading-relaxed">
                                    {notice.content}
                                </p>
                            </div>

                            <div className="flex flex-col gap-3">
                                {/* MODIFIED: Translated Button to Khmer */}
                                <Button 
                                    variant="primary" 
                                    onClick={() => onAcknowledge(notice)}
                                    className="w-full py-3 text-base bg-yellow-500 hover:bg-yellow-400 text-slate-900 font-bold shadow-lg shadow-yellow-900/20"
                                >
                                    <i className="fas fa-check-circle"></i>  
                                </Button>
                                {/* MODIFIED: Translated Link to Khmer */}
                                <button 
                                    onClick={onRemindLater}
                                    className="text-xs text-slate-500 hover:text-slate-300 underline text-center"
                                >
                                     (Remind me later)
                                </button>
                            </div>
                        </div>
                    </div>
                </Modal>
            );
        };

        // --- START MAIN APP COMPONENT ---
        const AppContent = () => {
            const { userProfile, loading, auth, db } = useFirebase();
            const [activePage, setActivePage] = useState('dashboard');
            
            // FIX: Ensure SDK is ready or handle gracefully. 
            // In a real app, we might wait, but here we assume provider handles loading.
            const { where, collection, query, onSnapshot, orderBy } = window.firebaseSDK || {}; 
            
            const { employees, shops, kpis, moduleConfig = {} } = useAppData(); 

            // --- HOOKS MOVED TO TOP (Fixes Error #310) ---
            
            // 1. Swipe Logic State
            const [touchStart, setTouchStart] = useState(null);
            const [touchEnd, setTouchEnd] = useState(null);

            // 2. Global Search State
            const [globalSearchTerm, setGlobalSearchTerm] = useState('');
            const [searchResults, setSearchResults] = useState({ pages: [], staff: [] });
            const searchContainerRef = useRef(null);

            // 3. Notification & Badge State
            const [popupNotice, setPopupNotice] = useState(null);
            const [dismissedNoticeIds, setDismissedNoticeIds] = useState(new Set());
            const [pendingMeetingInvites, setPendingMeetingInvites] = useState([]);
            const [isMeetingAlertOpen, setIsMeetingAlertOpen] = useState(false);
            const [isBirthdayPopupOpen, setIsBirthdayPopupOpen] = useState(false);
            const [birthdayNotifications, setBirthdayNotifications] = useState([]);

            // 4. UI State
            const [isLaunchPadOpen, setIsLaunchPadOpen] = useState(true);
            const [isHeaderProfileOpen, setIsHeaderProfileOpen] = useState(false);
            const [initialCheckInMeTab, setInitialCheckInMeTab] = useState('checkInOut');
            const [currentTime, setCurrentTime] = useState(new Date());
            const headerProfileRef = useRef(null);
            
            // 5. Modal State for Quick Actions
            const [isEmployeeModalOpen, setIsEmployeeModalOpen] = useState(false);
            const [isTaskModalOpen, setIsTaskModalOpen] = useState(false);
            const [isProfileOpen, setIsProfileOpen] = useState(false);
            const profileRef = useRef(null);

            // 6. Connectivity
            const { isOnline } = useConnectivity();

            // 7. Data Fetching Hooks (Must be unconditional)
            const { data: allNotices } = useCollection('memoAlerts');
            const { data: allPolicies } = useCollection('policies');

            // Access Control Logic
            const allowedLinkKeys = useMemo(() => {
                if (!userProfile) return new Set();
                if (userProfile.role === 'Admin' || userProfile.role === 'CEO') return null; 
                const base = new Set(['dashboard', 'companyHub', 'tasks']); 
                if (userProfile.permissions) { userProfile.permissions.forEach(p => base.add(p)); }
                return base;
            }, [userProfile]);

            // Notification Constraints
            const notificationConstraints = useMemo(() => {
                if (!userProfile || !window.firebaseSDK) return { leave: [], ot: [], state: [] };
                const { role, shop } = userProfile;
                const { where } = window.firebaseSDK;
                const pendingStatus = where("status", "==", "Pending");

                if (role === 'Admin' || role === 'CEO') {
                    return { leave: [pendingStatus], ot: [pendingStatus], state: [pendingStatus] };
                }
                if (role === 'Shop Manager') {
                    const shopsArr = Array.isArray(shop) ? shop : [shop];
                    if (shopsArr.length === 0) return { leave: [where("status", "==", "impossible")], ot: [where("status", "==", "impossible")], state: [where("status", "==", "impossible")] };
                    const shopFilter = where("shop", "in", shopsArr);
                    return { leave: [pendingStatus, shopFilter], ot: [pendingStatus, shopFilter], state: [pendingStatus, shopFilter] };
                }
                return { leave: [where("status", "==", "impossible")], ot: [where("status", "==", "impossible")], state: [where("status", "==", "impossible")] };
            }, [userProfile]);

            const { data: pendingLeaves } = useCollection('leaveRequests', notificationConstraints.leave);
            const { data: pendingOTs } = useCollection('otRequests', notificationConstraints.ot);
            const { data: pendingStates } = useCollection('employeeStates', notificationConstraints.state);

            // --- EFFECTS ---

            // Splash Screen Removal
            useEffect(() => {
                if (!loading) {
                    const splash = document.getElementById('splash-screen');
                    if (splash) {
                        setTimeout(() => {
                            splash.style.opacity = '0';
                            setTimeout(() => splash.remove(), 500);
                        }, 300);
                    }
                }
            }, [loading]);

            // Search Click Outside
            useEffect(() => {
                const handleClickOutside = (event) => {
                    if (searchContainerRef.current && !searchContainerRef.current.contains(event.target)) {
                        setGlobalSearchTerm('');
                    }
                };
                document.addEventListener("mousedown", handleClickOutside);
                return () => document.removeEventListener("mousedown", handleClickOutside);
            }, [searchContainerRef]);

            // Perform Search
            useEffect(() => {
                if (!globalSearchTerm.trim()) {
                    setSearchResults({ pages: [], staff: [] });
                    return;
                }
                const term = globalSearchTerm.toLowerCase();
                const pages = APP_MODULES.filter(m => 
                    (allowedLinkKeys === null || allowedLinkKeys.has(m.key)) && 
                    moduleConfig[m.key] !== false && 
                    m.label.toLowerCase().includes(term)
                );
                const staff = (employees || []).filter(e => 
                    e.name.toLowerCase().includes(term) || 
                    (e.position && e.position.toLowerCase().includes(term))
                ).slice(0, 5);
                setSearchResults({ pages, staff });
            }, [globalSearchTerm, employees, allowedLinkKeys, moduleConfig]);

            // Notice Logic
            useEffect(() => {
                if (!allNotices || !userProfile || !currentTime) return;
                const currentHHMM = currentTime.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' });
                const activeUrgentNotice = allNotices.find(n => {
                    if (n.status !== 'Active') return false;
                    if ((n.readBy || []).includes(userProfile.id)) return false;
                    if (dismissedNoticeIds.has(n.id)) return false;
                    if (n.targetShops && n.targetShops.length > 0) {
                        const userShops = Array.isArray(userProfile.shop) ? userProfile.shop : [userProfile.shop];
                        const hasAccess = userProfile.role === 'Admin' || userProfile.role === 'CEO' || userShops.some(s => n.targetShops.includes(s));
                        if (!hasAccess) return false;
                    }
                    if (n.startTime && n.endTime) {
                        if (n.startTime <= n.endTime) { if (currentHHMM < n.startTime || currentHHMM > n.endTime) return false; } 
                        else { if (currentHHMM < n.startTime && currentHHMM > n.endTime) return false; }
                    }
                    return true;
                });
                setPopupNotice(activeUrgentNotice || null);
            }, [allNotices, userProfile, currentTime, dismissedNoticeIds]);

            // Meeting Alerts
            useEffect(() => {
                if (!db || !userProfile) return;
                const { collection, query, where, orderBy, onSnapshot } = window.firebaseSDK;
                const now = new Date().toISOString().slice(0, 10);
                const q = query(collection(db, 'meetings'), where('date', '>=', now), orderBy('date', 'asc'));
                const unsubscribe = onSnapshot(q, (snapshot) => {
                    const meetings = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    const pending = meetings.filter(m => {
                        const isInvited = (m.invitedStaffIds || []).includes(userProfile.id);
                        const myResponse = (m.responses || {})[userProfile.id];
                        return isInvited && (!myResponse || myResponse.status === 'pending') && m.status !== 'Completed';
                    });
                    if (pending.length > 0) {
                        setPendingMeetingInvites(pending);
                        if (!sessionStorage.getItem('meetingAlertShown')) { setIsMeetingAlertOpen(true); sessionStorage.setItem('meetingAlertShown', 'true'); }
                    }
                });
                return () => unsubscribe();
            }, [db, userProfile]);

            // Birthday Logic
            useEffect(() => {
                if (!employees || !shops || !userProfile) return;
                const socialEmployees = employees.filter(e => {
                    if (userProfile.role === 'Admin' || userProfile.role === 'CEO') return true;
                    const myShops = Array.isArray(userProfile.shop) ? userProfile.shop : [userProfile.shop];
                    const eShops = Array.isArray(e.shop) ? e.shop : [e.shop];
                    return eShops.some(s => myShops.includes(s));
                });
                const todayBirthdays = socialEmployees.filter(emp => {
                    if (emp.status !== 'Active' || !emp.dob) return false;
                    const empShopName = Array.isArray(emp.shop) ? emp.shop[0] : emp.shop;
                    const shop = shops.find(s => s.name === empShopName);
                    const { localDate: todayStr } = Utils.formatDateInTimezone({ toDate: () => new Date() }, shop?.timezone);
                    const [tYear, tMonth, tDay] = todayStr.split('-').map(Number);
                    const [y, m, d] = emp.dob.split('-').map(Number);
                    return m === tMonth && d === tDay;
                });
                if (todayBirthdays.length > 0) {
                    setBirthdayNotifications(todayBirthdays);
                    const lastSeen = localStorage.getItem('lastBirthdayPopup');
                    const todayKey = new Date().toDateString();
                    if (lastSeen !== todayKey) { setIsBirthdayPopupOpen(true); localStorage.setItem('lastBirthdayPopup', todayKey); }
                }
            }, [employees, shops, userProfile]);

            // Profile Dropdown Outside Click
            useEffect(() => { 
                const handleClickOutside = (event) => { 
                    if (profileRef.current && !profileRef.current.contains(event.target)) {
                        setIsProfileOpen(false);
                    }
                };
                if (isProfileOpen) document.addEventListener("mousedown", handleClickOutside); 
                return () => document.removeEventListener("mousedown", handleClickOutside); 
            }, [isProfileOpen]);

            // Header Profile Outside Click
            useEffect(() => { 
                const handleClickOutside = (event) => { 
                    if (headerProfileRef.current && !headerProfileRef.current.contains(event.target)) 
                        setIsHeaderProfileOpen(false); 
                }; 
                if (isHeaderProfileOpen) document.addEventListener("mousedown", handleClickOutside); 
                return () => document.removeEventListener("mousedown", handleClickOutside); 
            }, [isHeaderProfileOpen]);

            // NEW: Robust Update Handler for Header
            const [isCheckingUpdate, setIsCheckingUpdate] = useState(false);

            const handleCheckUpdates = async () => {
                setIsCheckingUpdate(true);
                await new Promise(r => setTimeout(r, 500));

                const performCheck = async () => {
                    if (!('serviceWorker' in navigator)) {
                        alert("You are using the latest update.");
                        return;
                    }
                    
                    if (!navigator.serviceWorker.controller) {
                        alert("You are using the latest update.");
                        return;
                    }

                    const registration = await navigator.serviceWorker.getRegistration();
                    if (!registration) {
                        alert("You are using the latest update.");
                        return;
                    }

                    await registration.update();
                    
                    if (registration.installing || registration.waiting) {
                         if(confirm("New update available! Refresh now to apply?")) {
                             if (registration.waiting) registration.waiting.postMessage({ type: 'SKIP_WAITING' });
                             window.location.reload();
                         }
                    } else {
                        alert("You are using the latest update.");
                    }
                };

                const timeout = new Promise((_, reject) => setTimeout(() => reject("Timeout"), 5000));

                try {
                    await Promise.race([performCheck(), timeout]);
                } catch (error) {
                    console.warn("Update check timeout:", error);
                    if(confirm("Check timed out. Force reload?")) {
                        window.location.reload();
                    }
                } finally {
                    setIsCheckingUpdate(false);
                    setIsHeaderProfileOpen(false);
                }
            };

            // Clock
            useEffect(() => { const timer = setInterval(() => setCurrentTime(new Date()), 1000); return () => clearInterval(timer); }, []);

            // --- COMPUTED VALUES ---

            const companyHubUnreadCount = useMemo(() => {
                if (!userProfile) return 0;
                const unreadNoticesCount = (allNotices || []).filter(n => {
                    if (userProfile.role === 'Staff' && n.status !== 'Active') return false;
                    if (n.targetShops && n.targetShops.length > 0) {
                        const userShops = Array.isArray(userProfile.shop) ? userProfile.shop : [userProfile.shop];
                        if (userProfile.role !== 'Admin' && userProfile.role !== 'CEO' && !userShops.some(s => n.targetShops.includes(s))) return false;
                    }
                    return !(n.readBy || []).includes(userProfile.id);
                }).length;
                const unreadPoliciesCount = (allPolicies || []).filter(p => { return !(p.readBy || []).includes(userProfile.id); }).length;
                return unreadNoticesCount + unreadPoliciesCount;
            }, [allNotices, allPolicies, userProfile]);


            // --- HANDLERS ---
            
            // FIX: Memoize this handler to prevent DashboardSummaryPage re-rendering
            const handleNotificationClick = useCallback((target) => {
                setActivePage('checkinme');
                setInitialCheckInMeTab(target);
                setIsLaunchPadOpen(false);
            }, []);

            const handleAcknowledgeNotice = async (notice) => {
                if (!notice || !userProfile?.id) return;
                const { doc, updateDoc, arrayUnion } = window.firebaseSDK;
                try {
                    const noticeRef = doc(db, 'memoAlerts', notice.id);
                    await updateDoc(noticeRef, { readBy: arrayUnion(userProfile.id) });
                    setPopupNotice(null);
                } catch (error) { console.error("Error acknowledging notice:", error); }
            };

            const handleRemindLater = () => { if (popupNotice) { setDismissedNoticeIds(prev => new Set(prev).add(popupNotice.id)); setPopupNotice(null); } };
            const handleCloseAlert = () => setIsMeetingAlertOpen(false);
            
            const handleAlertRespond = (meeting, type, reason) => {
                const { doc, updateDoc } = window.firebaseSDK;
                const meetingRef = doc(db, 'meetings', meeting.id);
                const fieldPath = `responses.${userProfile.id}`;
                updateDoc(meetingRef, { [fieldPath]: { status: type, reason: reason || '', timestamp: new Date().toISOString() } }).catch(console.error);
                setPendingMeetingInvites(prev => prev.filter(m => m.id !== meeting.id));
                if (pendingMeetingInvites.length <= 1) setIsMeetingAlertOpen(false);
            };

            // Swipe Logic Handlers
            const minSwipeDistance = 50; 
            const onTouchStart = (e) => {
                setTouchEnd(null); 
                setTouchStart({ x: e.targetTouches[0].clientX, y: e.targetTouches[0].clientY });
            };
            const onTouchMove = (e) => {
                setTouchEnd({ x: e.targetTouches[0].clientX, y: e.targetTouches[0].clientY });
            };
            const onTouchEnd = () => {
                if (!touchStart || !touchEnd) return;
                
                // FIX: Edge Swipe Only
                // Only allow navigation if the swipe started from the far left edge (0-30px).
                // This prevents accidental triggers when scrolling tables or kanban boards in the middle of the screen.
                if (touchStart.x > 30) return;

                const distanceX = touchStart.x - touchEnd.x;
                const distanceY = touchStart.y - touchEnd.y;
                const isHorizontal = Math.abs(distanceX) > Math.abs(distanceY);
                
                if (isHorizontal) {
                    // Negative distanceX means Left-to-Right Swipe
                    const isRightSwipe = distanceX < -minSwipeDistance;
                    if (isRightSwipe && !isLaunchPadOpen) {
                         setIsLaunchPadOpen(true);
                    }
                }
            };
            
            // --- EARLY RETURNS (Now Safe because hooks are above) ---
            if (loading) return <div className="flex items-center justify-center min-h-screen bg-slate-900 text-white"><i className="fas fa-spinner fa-spin text-4xl mr-3"></i> Loading System...</div>;
            if (!userProfile) return <LoginPage />;

            const activePageKey = activePage.split(':')[0];
            const activePageParams = activePage.split(':')[1] ? activePage.split(':').slice(1).join(':') : null;
            
            const renderActivePage = () => {
                if (moduleConfig && moduleConfig[activePageKey] === false) {
                    return (
                        <div className="flex flex-col items-center justify-center h-full text-slate-500 animate-fade-in">
                            <div className="w-20 h-20 bg-slate-800 rounded-full flex items-center justify-center mb-6 shadow-inner border border-slate-700">
                                <i className="fas fa-ban text-3xl text-red-500/80"></i>
                            </div>
                            <h2 className="text-2xl font-bold text-slate-200 mb-2">Module Disabled</h2>
                            <p className="max-w-md text-center text-slate-400 leading-relaxed">
                                The <strong>{activePageKey}</strong> module is currently disabled by the system administrator.
                            </p>
                            <button onClick={() => setActivePage('dashboard')} className="mt-8 px-6 py-2 bg-blue-600 hover:bg-blue-500 text-white rounded-lg transition-colors text-sm font-bold shadow-lg shadow-blue-900/20">
                                Return to Dashboard
                            </button>
                        </div>
                    );
                }

                const hasPermission = (userProfile?.role === 'Admin') || 
                                      (userProfile?.role === 'CEO' && activePageKey !== 'sysConfig' && activePageKey !== 'settings') || 
                                      userProfile?.permissions?.includes(activePageKey) || 
                                      activePageKey === 'companyHub' || 
                                      activePageKey === 'dashboard' || 
                                      activePageKey === 'tasks';
                
                if (!activePageKey) return null;
                if (!hasPermission) return <Card><CardTitle>Access Denied</CardTitle><p>You do not have permission to view this page.</p></Card>;
                
                switch(activePageKey) {
                    case 'dashboard': return <DashboardSummaryPage userProfile={userProfile} setActivePage={setActivePage} onNavigateWithTab={handleNotificationClick} pendingLeaves={pendingLeaves} pendingOTs={pendingOTs} />;
                    case 'companyHub': return <CompanyHubPage userProfile={userProfile} pageParams={activePageParams} />;
                    case 'employees': return <EmployeesPage userProfile={userProfile} pageParams={activePageParams} />;
                    case 'checkinme': return <CheckInMePage userProfile={userProfile} initialTab={initialCheckInMeTab} pendingLeaves={pendingLeaves} pendingOTs={pendingOTs} />;
                    case 'attendanceReport': return <AttendanceReportPage userProfile={userProfile} />;
                    case 'payroll': return <PayrollPage userProfile={userProfile} />;
                    case 'hrBanking': return <HRBankingPage userProfile={userProfile} />;
                    case 'expenseReport': return <ExpenseReportPage userProfile={userProfile} />;
                    case 'assets': return <AssetManagerPage userProfile={userProfile} />;
                    {/* MODIFIED: Pass activePageParams to TaskBoardPage */}
                    case 'tasks': return <TaskBoardPage userProfile={userProfile} pageParams={activePageParams} />;
                    {/* FIX: Passed userProfile to UserActivityPage to resolve "reading 'role' of undefined" error in DeviceAuditTab */}
                    case 'userActivity': return <UserActivityPage userProfile={userProfile} />;
                    case 'settings': return <SettingsPage />;
                    default: return <UnderConstructionPage title="Page Not Found" />;
                }
            };

            return (
                <div className="flex h-screen bg-[#0f172a] text-slate-300 font-sans overflow-hidden">
                    <PWAInstallPrompt />
                    <PriorityNoticeModal isOpen={!!popupNotice} notice={popupNotice} onAcknowledge={handleAcknowledgeNotice} onRemindLater={handleRemindLater} />

                    <SystemLaunchPad 
                        isOpen={isLaunchPadOpen} 
                        onClose={() => setIsLaunchPadOpen(false)} 
                        activePage={activePage}
                        onNavigate={setActivePage}
                        userProfile={userProfile}
                        currentTime={currentTime}
                        pendingLeaves={pendingLeaves}
                        pendingOTs={pendingOTs}
                        pendingEngagements={pendingStates}
                        onNotificationClick={handleNotificationClick}
                        auth={auth}
                        setInitialCheckInMeTab={setInitialCheckInMeTab}
                        allowedLinkKeys={allowedLinkKeys}
                        companyHubUnreadCount={companyHubUnreadCount}
                    />

                    <div 
                        className="flex-1 flex flex-col min-w-0 overflow-hidden relative"
                        onTouchStart={onTouchStart}
                        onTouchMove={onTouchMove}
                        onTouchEnd={onTouchEnd}
                    >
                        <OfflineBanner />
                        
                        <header className="px-6 py-4 flex justify-between items-center bg-slate-900/80 border-b border-slate-800 shrink-0 z-40 backdrop-blur-md">
                            <div className="flex items-center gap-4">
                                <button onClick={() => setIsLaunchPadOpen(true)} className="p-2 rounded-lg text-slate-400 hover:text-white hover:bg-slate-800 transition-colors">
                                    <i className="fas fa-bars text-xl"></i>
                                </button>
                                
                                <div className="hidden md:flex relative" ref={searchContainerRef}>
                                    <div className="flex items-center bg-slate-800 rounded-lg px-3 py-1.5 border border-slate-700 w-64 focus-within:border-blue-500 focus-within:ring-1 focus-within:ring-blue-500 transition-all">
                                        <i className="fas fa-search text-slate-500 mr-2 text-xs"></i>
                                        <input type="text" placeholder="Quick Search (Page or Staff)..." className="bg-transparent border-none outline-none text-xs text-slate-300 w-full placeholder-slate-500" value={globalSearchTerm} onChange={(e) => setGlobalSearchTerm(e.target.value)} />
                                        {globalSearchTerm && <button onClick={() => setGlobalSearchTerm('')} className="text-slate-500 hover:text-white ml-2"><i className="fas fa-times text-xs"></i></button>}
                                    </div>
                                    {globalSearchTerm && (searchResults.pages.length > 0 || searchResults.staff.length > 0) && (
                                        <div className="absolute top-full left-0 right-0 mt-2 bg-slate-800 border border-slate-700 rounded-lg shadow-xl overflow-hidden z-50 animate-fade-in">
                                            {searchResults.pages.length > 0 && (
                                                <div className="p-2 border-b border-slate-700/50">
                                                    <p className="text-[10px] text-slate-500 uppercase font-bold px-2 mb-1 tracking-wider">Navigate</p>
                                                    {searchResults.pages.map(p => (
                                                        <div key={p.key} onClick={() => { setActivePage(p.key); setGlobalSearchTerm(''); }} className="px-2 py-2 hover:bg-slate-700 rounded cursor-pointer flex items-center gap-2 group transition-colors">
                                                            <div className={`w-6 h-6 rounded flex items-center justify-center ${p.bg}`}><i className={`fas ${p.icon} ${p.color} text-xs`}></i></div>
                                                            <span className="text-xs text-slate-300 group-hover:text-white font-medium">{p.label}</span>
                                                        </div>
                                                    ))}
                                                </div>
                                            )}
                                            {searchResults.staff.length > 0 && (
                                                <div className="p-2">
                                                    <p className="text-[10px] text-slate-500 uppercase font-bold px-2 mb-1 tracking-wider">Staff</p>
                                                    {searchResults.staff.map(s => (
                                                        <div key={s.id} onClick={() => { setActivePage(`employees:view:${s.id}`); setGlobalSearchTerm(''); }} className="px-2 py-2 hover:bg-slate-700 rounded cursor-pointer flex items-center gap-2 group transition-colors">
                                                            <div className="w-8 h-8 rounded-full bg-slate-600 flex items-center justify-center text-[10px] text-white overflow-hidden border border-slate-500 group-hover:border-blue-400 transition-colors">
                                                                {s.photo ? <img src={s.photo} className="w-full h-full object-cover"/> : s.name.charAt(0)}
                                                            </div>
                                                            <div className="flex-1 min-w-0">
                                                                <p className="text-xs text-slate-200 truncate font-bold group-hover:text-blue-300">{s.name}</p>
                                                                <p className="text-[9px] text-slate-500 truncate">{s.position}  {Array.isArray(s.shop) ? s.shop[0] : s.shop}</p>
                                                            </div>
                                                        </div>
                                                    ))}
                                                </div>
                                            )}
                                        </div>
                                    )}
                                </div>
                            </div>

                            <div className="flex items-center gap-3">
                                <div className="flex flex-col items-end mr-1">
                                    <span className="text-xs font-bold text-slate-200 font-mono leading-none">{currentTime.toLocaleTimeString([], { hour12: false, hour: '2-digit', minute: '2-digit' })}</span>
                                    <span className="text-[9px] text-slate-400 font-medium uppercase tracking-wide leading-none mt-0.5">{currentTime.toLocaleDateString(undefined, { month: 'short', day: 'numeric' })}</span>
                                </div>
                                <NotificationBell pendingLeaves={pendingLeaves} pendingOTs={pendingOTs} birthdayNotifications={birthdayNotifications} onNotificationClick={handleNotificationClick} />
                                <div className="relative" ref={headerProfileRef}>
                                    <button onClick={() => setIsHeaderProfileOpen(!isHeaderProfileOpen)} className="flex items-center text-sm font-medium text-slate-300 hover:text-white focus:outline-none">
                                        {userProfile?.photo ? (<img src={userProfile.photo} alt={userProfile.name} className="w-8 h-8 rounded-full object-cover shadow-md border border-blue-400" />) : (<div className="w-8 h-8 rounded-full bg-blue-500 flex items-center justify-center text-white font-bold shadow-md border border-blue-400">{userProfile.name.charAt(0)}</div>)}
                                    </button>
                                    {isHeaderProfileOpen && (
                                        <div className="absolute right-0 mt-2 w-48 bg-slate-800 rounded-md shadow-lg py-1 border border-slate-700 z-50 animate-fade-in">
                                            <div className="px-4 py-2 border-b border-slate-700 mb-1">
                                                <p className="text-xs text-slate-400">Signed in as</p>
                                                <p className="text-sm font-bold text-white truncate">{userProfile?.name}</p>
                                            </div>
                                            {/* NEW: Check for Updates Button in Header */}
                                            <button 
                                                onClick={() => handleCheckUpdates()}
                                                disabled={isCheckingUpdate}
                                                className="block w-full text-left px-4 py-2 text-sm text-blue-400 hover:bg-slate-700 border-b border-slate-700 disabled:opacity-50"
                                            >
                                                <i className={`fas ${isCheckingUpdate ? 'fa-spinner fa-spin' : 'fa-sync-alt'} mr-2`}></i> 
                                                {isCheckingUpdate ? "Checking..." : "Check Updates"}
                                            </button>
                                            <a href="#" onClick={(e) => { e.preventDefault(); window.firebaseSDK.signOut(auth); setIsHeaderProfileOpen(false); }} className="block px-4 py-2 text-sm text-red-400 hover:bg-slate-700"><i className="fas fa-sign-out-alt mr-2"></i> Sign out</a>
                                        </div>
                                    )}
                                </div>
                            </div>
                        </header>

                        <main className="flex-1 overflow-y-auto p-4 sm:p-6 pb-24 relative scroll-smooth w-full max-w-7xl mx-auto">
                            {renderActivePage()}
                        </main>

                        <PendingMeetingsModal isOpen={isMeetingAlertOpen} onClose={handleCloseAlert} meetings={pendingMeetingInvites} onRespond={handleAlertRespond} />
                        
                        <BirthdayCelebrationModal 
                            isOpen={isBirthdayPopupOpen} A
                            onClose={() => setIsBirthdayPopupOpen(false)} 
                            celebrants={birthdayNotifications}
                            onJoin={() => { setIsBirthdayPopupOpen(false); setActivePage('companyHub:celebrate'); }} 
                        />
                    </div>
                </div>
            );
        };

        const App = () => (
            <ConnectivityProvider>
                <FirebaseProvider>
                    <AppDataProvider>
                        <AppContent />
                    </AppDataProvider>
                </FirebaseProvider>
            </ConnectivityProvider>
        );

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
