import React, { useState, useEffect, useRef } from 'react';
import { initializeApp } from 'firebase/app';
import { 
    getAuth, 
    createUserWithEmailAndPassword, 
    signInWithEmailAndPassword, 
    onAuthStateChanged, 
    signOut 
} from 'firebase/auth';
import { 
    getFirestore, 
    doc, 
    collection, 
    addDoc, 
    updateDoc, 
    deleteDoc, 
    query, 
    onSnapshot, 
    getDoc, 
    setDoc, 
    getDocs 
} from 'firebase/firestore';

// --- Firebase Configuration ---
const firebaseConfig = {
    apiKey: "AIzaSyA4upjtl0UFToWSfRZEiEQvwz9ieFLfqhI",
    authDomain: "cashflow-mgr.firebaseapp.com",
    projectId: "cashflow-mgr",
    storageBucket: "cashflow-mgr.appspot.com",
    messagingSenderId: "873891130920",
    appId: "1:873891130920:web:b6b8f0432943c33a930f1d",
    measurementId: "G-LVLMJ8ZY0B"
};

// --- Initialize Firebase ---
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const appsCollectionRef = collection(db, "apps");
const usersCollectionRef = collection(db, "users");


// --- Helper Components ---
const Icon = ({ name, className = '' }) => {
    const icons = {
        Landmark: <path strokeLinecap="round" strokeLinejoin="round" d="M3.75 21h16.5M4.5 3h15M5.25 3v18m13.5-18v18M9 6.75h6M9 12h6m-6 5.25h6M5.25 3h13.5a.75.75 0 01.75.75v16.5a.75.75 0 01-.75.75H5.25a.75.75 0 01-.75-.75V3.75A.75.75 0 015.25 3z" />,
        Eye: <><path strokeLinecap="round" strokeLinejoin="round" d="M2.036 12.322a1.012 1.012 0 010-.639l4.43-7.599A1.012 1.012 0 017.5 4h9a1.012 1.012 0 01.934.992l4.43 7.599a1.012 1.012 0 010 .639l-4.43 7.599A1.012 1.012 0 0116.5 20h-9a1.012 1.012 0 01-.934-.992l-4.43-7.599z" /><path strokeLinecap="round" strokeLinejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></>,
        EyeOff: <path strokeLinecap="round" strokeLinejoin="round" d="M3.98 8.223A10.477 10.477 0 001.934 12C3.226 16.338 7.244 19.5 12 19.5c.993 0 1.953-.138 2.863-.395M6.228 6.228A10.45 10.45 0 0112 4.5c4.756 0 8.774 3.162 10.065 7.498a10.523 10.523 0 01-4.293 5.774M6.228 6.228L3 3m3.228 3.228l3.65 3.65m7.894 7.894L21 21m-3.228-3.228l-3.65-3.65m0 0a3 3 0 10-4.243-4.243m4.243 4.243l-4.243-4.243" />,
        LoaderCircle: <path d="M21 12a9 9 0 1 1-6.219-8.56" />,
    };
    return <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" className={className}>{icons[name]}</svg>;
};

const useNotification = () => ({ showNotification: (message, type) => alert(`[${type.toUpperCase()}] ${message}`) });

// --- Core Components ---

const LoginPage = () => {
    const { showNotification } = useNotification();
    const [email, setEmail] = useState('');
    const [password, setPassword] = useState('');
    const [isLoading, setIsLoading] = useState(false);
    const [showPassword, setShowPassword] = useState(false);
    const isMounted = useRef(true);

    useEffect(() => {
        isMounted.current = true;
        return () => { isMounted.current = false; };
    }, []);

    const handleAuthAction = async (action) => {
        setIsLoading(true);
        try {
            await action(auth, email, password);
        } catch (err) {
            showNotification(err.message, 'error');
        } finally {
            if (isMounted.current) setIsLoading(false);
        }
    };

    return (
        <div className="flex items-center justify-center min-h-screen bg-gray-100 dark:bg-gray-900 px-4 py-12">
            <div className="w-full max-w-md space-y-8">
                <div>
                    <Icon name="Landmark" className="mx-auto h-12 w-auto text-indigo-600" />
                    <h2 className="mt-6 text-center text-3xl font-bold text-gray-900 dark:text-white">Sign in to your Account</h2>
                    <p className="mt-2 text-center text-sm text-red-600 font-semibold">This application is used for Internal Management ONLY!</p>
                </div>
                <form onSubmit={(e) => e.preventDefault()} className="mt-8 space-y-6">
                    <div className="rounded-md shadow-sm space-y-4">
                        <div>
                            <label htmlFor="email-login" className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1.5">Email address</label>
                            <input id="email-login" name="email" type="email" value={email} onChange={(e) => setEmail(e.target.value)} required className="block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm bg-white dark:bg-gray-800 placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="Email address" />
                        </div>
                        <div>
                            <label htmlFor="password-login" className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1.5">Password</label>
                            <div className="relative">
                                <input id="password-login" name="password" type={showPassword ? 'text' : 'password'} value={password} onChange={(e) => setPassword(e.target.value)} required className="block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm bg-white dark:bg-gray-800 placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="Password" />
                                <button type="button" onClick={() => setShowPassword(!showPassword)} className="absolute inset-y-0 right-0 pr-3 flex items-center text-gray-500 hover:text-gray-700"><Icon name={showPassword ? 'EyeOff' : 'Eye'} className="h-5 w-5" /></button>
                            </div>
                        </div>
                    </div>
                    <div className="flex flex-col sm:flex-row gap-2 mt-6">
                        <button onClick={() => handleAuthAction(signInWithEmailAndPassword)} disabled={isLoading} className="flex-1 justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 disabled:opacity-50 flex items-center">
                            {isLoading && <Icon name="LoaderCircle" className="animate-spin h-5 w-5 mr-3" />} Sign in
                        </button>
                         <button onClick={() => handleAuthAction(createUserWithEmailAndPassword)} disabled={isLoading} className="flex-1 justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 disabled:opacity-50 flex items-center">Register</button>
                    </div>
                </form>
            </div>
        </div>
    );
};

const EditModal = ({ app, onClose, onSave }) => {
    const [appName, setAppName] = useState(app.name);
    const [appUrl, setAppUrl] = useState(app.url);
    const [appDescription, setAppDescription] = useState(app.description);

    const handleSave = () => {
        onSave(app.id, { name: appName, url: appUrl, description: appDescription });
    };

    return (
        <div className="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50 flex items-center justify-center">
            <div className="relative mx-auto p-5 border w-full max-w-lg shadow-lg rounded-md bg-white dark:bg-gray-800">
                <h3 className="text-lg leading-6 font-medium text-gray-900 dark:text-white text-center">Edit Application</h3>
                <div className="mt-4 space-y-4">
                    <input type="text" value={appName} onChange={(e) => setAppName(e.target.value)} placeholder="Application Name" className="w-full p-3 bg-gray-200 dark:bg-gray-700 rounded-md" />
                    <input type="url" value={appUrl} onChange={(e) => setAppUrl(e.target.value)} placeholder="Application URL" className="w-full p-3 bg-gray-200 dark:bg-gray-700 rounded-md" />
                    <textarea value={appDescription} onChange={(e) => setAppDescription(e.target.value)} placeholder="Application Description" rows="5" className="w-full p-3 bg-gray-200 dark:bg-gray-700 rounded-md"></textarea>
                </div>
                <div className="items-center px-4 py-3 text-center mt-4">
                    <button onClick={handleSave} className="px-4 py-2 bg-blue-500 text-white text-base font-medium rounded-md w-auto shadow-sm hover:bg-blue-600">Save Changes</button>
                    <button onClick={onClose} className="px-4 py-2 bg-gray-500 text-white text-base font-medium rounded-md w-auto shadow-sm hover:bg-gray-600 ml-2">Cancel</button>
                </div>
            </div>
        </div>
    );
};

const AdminView = ({ setCurrentView }) => {
    const [apps, setApps] = useState([]);
    const [appName, setAppName] = useState('');
    const [appUrl, setAppUrl] = useState('');
    const [appDescription, setAppDescription] = useState('');
    const [editingApp, setEditingApp] = useState(null);

    useEffect(() => {
        const unsubscribe = onSnapshot(query(appsCollectionRef), (snapshot) => {
            setApps(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
        });
        return unsubscribe;
    }, []);

    const handleAddApp = async () => {
        if (!appName || !appUrl) return;
        await addDoc(appsCollectionRef, { name: appName, url: appUrl, description: appDescription });
        setAppName(''); setAppUrl(''); setAppDescription('');
    };

    const handleUpdateApp = async (id, updatedData) => {
        const appDocRef = doc(db, "apps", id);
        await updateDoc(appDocRef, updatedData);
        setEditingApp(null);
    };
    
    const handleDeleteApp = async (id) => {
        if(window.confirm("Are you sure you want to delete this app?")) {
            await deleteDoc(doc(db, "apps", id));
        }
    }

    return (
        <div className="container mx-auto p-4 sm:p-6 lg:p-8">
            <header className="text-center mb-8">
                <h1 className="text-4xl sm:text-5xl font-bold text-gray-800 dark:text-white">App Hub Back Office</h1>
                <div className="flex justify-center items-center gap-4 mt-4">
                    <button onClick={() => setCurrentView('user')} className="text-blue-500 hover:underline">View User Page</button>
                    <button onClick={() => setCurrentView('userManagement')} className="text-green-500 hover:underline">Manage Users</button>
                    <button onClick={() => signOut(auth)} className="text-red-500 hover:underline">Logout</button>
                </div>
            </header>
            <div className="max-w-3xl mx-auto">
                <div className="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md mb-8">
                    <h2 className="text-2xl font-semibold mb-4 text-gray-900 dark:text-white">Add New Application</h2>
                    <div className="space-y-4">
                        <input type="text" value={appName} onChange={(e) => setAppName(e.target.value)} placeholder="Application Name" className="w-full p-3 bg-gray-200 dark:bg-gray-700 rounded-md" />
                        <input type="url" value={appUrl} onChange={(e) => setAppUrl(e.target.value)} placeholder="Application URL" className="w-full p-3 bg-gray-200 dark:bg-gray-700 rounded-md" />
                        <textarea value={appDescription} onChange={(e) => setAppDescription(e.target.value)} placeholder="Application Description" rows="4" className="w-full p-3 bg-gray-200 dark:bg-gray-700 rounded-md"></textarea>
                    </div>
                    <button onClick={handleAddApp} className="mt-4 w-full bg-blue-600 text-white font-semibold py-3 rounded-md hover:bg-blue-700">Add Application</button>
                </div>
                <div className="space-y-4">
                    {apps.map(app => (
                        <div key={app.id} className="bg-white dark:bg-gray-800 p-4 rounded-lg shadow-md flex items-center justify-between">
                            <div className="flex-grow">
                                <h3 className="text-xl font-bold text-gray-900 dark:text-white">{app.name}</h3>
                                <p className="text-sm mt-1 text-gray-600 dark:text-gray-300 whitespace-pre-wrap">{app.description}</p>
                            </div>
                            <div className="flex-shrink-0 ml-4 space-x-2">
                                <button onClick={() => setEditingApp(app)} className="bg-yellow-500 text-white p-2 rounded-md hover:bg-yellow-600">Edit</button>
                                <button onClick={() => handleDeleteApp(app.id)} className="bg-red-500 text-white p-2 rounded-md hover:bg-red-600">Delete</button>
                            </div>
                        </div>
                    ))}
                </div>
            </div>
            {editingApp && (
                <EditModal 
                    app={editingApp} 
                    onClose={() => setEditingApp(null)}
                    onSave={handleUpdateApp}
                />
            )}
        </div>
    );
};

const UserView = ({ role, setCurrentView }) => {
    const [apps, setApps] = useState([]);
    const [searchTerm, setSearchTerm] = useState('');

    useEffect(() => {
        const unsubscribe = onSnapshot(query(appsCollectionRef), (snapshot) => {
            setApps(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
        });
        return unsubscribe;
    }, []);

    const filteredApps = apps.filter(app => 
        (app.name || '').toLowerCase().includes(searchTerm.toLowerCase()) ||
        (app.description || '').toLowerCase().includes(searchTerm.toLowerCase())
    );

    return (
         <div className="container mx-auto p-4 sm:p-6 lg:p-8">
            <header className="text-center mb-8">
                <h1 className="text-4xl sm:text-5xl font-bold text-gray-800 dark:text-white">My Application Hub</h1>
                <div className="flex justify-center items-center gap-4 mt-4">
                    {role === 'admin' && <button onClick={() => setCurrentView('admin')} className="text-blue-500 hover:underline">Back to Admin</button>}
                    <button onClick={() => signOut(auth)} className="text-red-500 hover:underline">Logout</button>
                </div>
            </header>
            <div className="max-w-6xl mx-auto">
                 <input type="text" value={searchTerm} onChange={(e) => setSearchTerm(e.target.value)} placeholder="Search applications..." className="w-full p-3 mb-8 bg-white dark:bg-gray-800 rounded-lg shadow-md" />
                 <div className="space-y-8">
                    {filteredApps.map(app => (
                        <div key={app.id} className="grid grid-cols-1 md:grid-cols-2 gap-6 p-4 bg-gray-50 dark:bg-gray-800/50 rounded-lg">
                            {/* Card 1: Name and Link */}
                            <div className="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg flex flex-col justify-between">
                                <div>
                                    <h3 className="text-2xl font-bold text-gray-800 dark:text-white">{app.name}</h3>
                                </div>
                                <div className="mt-4">
                                    <a href={app.url} target="_blank" rel="noopener noreferrer" className="inline-block bg-blue-600 text-white font-semibold py-2 px-4 rounded-md hover:bg-blue-700">Open Application</a>
                                </div>
                            </div>
                            {/* Card 2: Description */}
                            <div className="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg">
                                 <h4 className="text-lg font-semibold text-gray-500 dark:text-gray-400 mb-2 border-b pb-2 dark:border-gray-700">Description</h4>
                                <p className="mt-2 text-gray-600 dark:text-gray-300 whitespace-pre-wrap">{app.description || 'No description available.'}</p>
                            </div>
                        </div>
                    ))}
                 </div>
            </div>
        </div>
    );
};

const UserManagementView = ({ setCurrentView }) => {
    const [users, setUsers] = useState([]);

    useEffect(() => {
        const unsubscribe = onSnapshot(query(usersCollectionRef), (snapshot) => {
            setUsers(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
        });
        return unsubscribe;
    }, []);

    const handleRoleChange = async (id, newRole) => {
        await updateDoc(doc(db, "users", id), { role: newRole });
    };

    return (
        <div className="container mx-auto p-4 sm:p-6 lg:p-8">
             <header className="text-center mb-8">
                <h1 className="text-4xl sm:text-5xl font-bold text-gray-800 dark:text-white">User Management</h1>
                <button onClick={() => setCurrentView('admin')} className="text-blue-500 hover:underline mt-4 inline-block">Back to App Management</button>
            </header>
            <div className="max-w-4xl mx-auto bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md">
                <div className="space-y-3">
                    {users.map(user => (
                        <div key={user.id} className="flex items-center justify-between p-3 border-b dark:border-gray-700">
                            <p className="text-gray-800 dark:text-gray-200">{user.email}</p>
                            <select value={user.role} onChange={(e) => handleRoleChange(user.id, e.target.value)} className="role-select bg-gray-200 dark:bg-gray-600 rounded-md p-2">
                                <option value="user">User</option>
                                <option value="admin">Admin</option>
                            </select>
                        </div>
                    ))}
                </div>
            </div>
        </div>
    );
}

// --- Main App Component ---
export default function App() {
    const [currentUser, setCurrentUser] = useState(null);
    const [userRole, setUserRole] = useState(null);
    const [currentView, setCurrentView] = useState('user');
    const [isLoading, setIsLoading] = useState(true);

    useEffect(() => {
        const unsubscribe = onAuthStateChanged(auth, async (user) => {
            setIsLoading(true);
            if (user) {
                const userDocRef = doc(db, "users", user.uid);
                const userDoc = await getDoc(userDocRef);
                
                if (userDoc.exists()) {
                    const role = userDoc.data().role;
                    setUserRole(role);
                    setCurrentView(role === 'admin' ? 'admin' : 'user');
                } else {
                    const usersSnapshot = await getDocs(usersCollectionRef);
                    const role = usersSnapshot.empty ? 'admin' : 'user';
                    await setDoc(userDocRef, { email: user.email, role: role });
                    setUserRole(role);
                    setCurrentView(role === 'admin' ? 'admin' : 'user');
                }
                setCurrentUser(user);
            } else {
                setCurrentUser(null);
                setUserRole(null);
            }
            setIsLoading(false);
        });
        return () => unsubscribe();
    }, []);

    if (isLoading) {
        return (
            <div className="flex items-center justify-center min-h-screen bg-gray-100 dark:bg-gray-900">
                <Icon name="LoaderCircle" className="animate-spin h-12 w-12 text-indigo-600" />
            </div>
        );
    }

    if (!currentUser) {
        return <LoginPage />;
    }

    switch (currentView) {
        case 'admin':
            return <AdminView setCurrentView={setCurrentView} />;
        case 'userManagement':
            return <UserManagementView setCurrentView={setCurrentView} />;
        case 'user':
        default:
            return <UserView role={userRole} setCurrentView={setCurrentView} />;
    }
}
